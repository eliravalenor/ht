<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EVE Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Nunito:wght@400;500;600;700&family=Montserrat:wght@400;500;600&family=Inter:wght@400;500;600&family=Roboto:wght@400;500&family=Raleway:wght@400;500;600&family=Lato:wght@400;700&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=20250805-duration-spacing">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- ğŸ”¥ã€æ–°å¢ã€‘çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ -->
    <style>
        /* è§’è‰²åˆ—è¡¨çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .contact-status-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }

        /* å·²æ‹‰é»‘çŠ¶æ€ - çº¢è‰² */
        .contact-status-indicator.blocked {
            background-color: #ff4444;
            color: white;
        }

        /* è¢«æ‹‰é»‘çŠ¶æ€ - æ·±æ©™è‰² */
        .contact-status-indicator.blocked-by {
            background-color: #ff8800;
            color: white;
        }

        /* å·²å±è”½ç¾¤èŠçŠ¶æ€ - æ©™è‰² */
        .contact-status-indicator.muted {
            background-color: #ff9500;
            color: white;
        }

        /* ç¡®ä¿è§’è‰²é¡¹æœ‰ç›¸å¯¹å®šä½ */
        .contact-item {
            position: relative;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘è¶³è¿¹æ–°å¢é«˜äº®æ ·å¼ */
        .footprint-item.new-footprint {
            animation: slideInFromTop 0.5s ease-out;
        }

        .footprint-item.highlight-new {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .footprint-mood {
            color: #e91e63;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘æ¶ˆæ¯åˆ—è¡¨çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .message-avatar-container {
            position: relative;
            display: inline-block;
        }

        .message-status-indicator {
            position: absolute;
            right: 2px;
            bottom: 1px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            z-index: 10;
        }

        /* å·²æ‹‰é»‘çŠ¶æ€ - çº¢è‰² */
        .message-status-indicator.blocked {
            background-color: #ff4444;
            color: white;
        }

        /* è¢«æ‹‰é»‘çŠ¶æ€ - æ·±æ©™è‰² */
        .message-status-indicator.blocked-by {
            background-color: #ff8800;
            color: white;
        }

        /* å·²å±è”½ç¾¤èŠçŠ¶æ€ - æ©™è‰² */
        .message-status-indicator.muted {
            background-color: #ff9500;
            color: white;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘æœªè¯»æ¶ˆæ¯æç¤ºæ ·å¼ */
        .unread-badge {
            position: absolute;
            right: -2px;
            top: -2px;
            min-width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
            padding: 0 4px;
            box-sizing: border-box;
        }

        /* å½“æ•°å­—è¶…è¿‡99æ—¶ï¼Œæ˜¾ç¤º99+ */
        .unread-badge.large-count {
            font-size: 8px;
            min-width: 20px;
            border-radius: 10px;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘å±é™©æ“ä½œæ ·å¼ */
        .danger-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .danger-item:hover {
            background-color: rgba(255, 59, 48, 0.05);
        }

        .danger-color {
            color: #ff3b30 !important;
        }

        .danger-section-title {
            color: #ff3b30 !important;
        }

        .danger-section-icon {
            color: #ff3b30 !important;
        }

        /* ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘æ¶ˆæ¯åˆ—è¡¨å¤šé€‰æ¨¡å¼æŒ‰é’® - æ”¾åœ¨app-headerä¸­ */
        .chat-header-multiselect-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }





        /* ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘ç½®é¡¶å¯¹è¯çš„è§†è§‰æ ‡è¯† - ä¸»é¢˜åŒ–é¢œè‰² */
        .message-item.pinned {
            background: rgba(74, 132, 193, 0.08);
            border-left: 3px solid rgba(74, 132, 193, 0.3);
        }

        /* å¯çˆ±ä¸»é¢˜ä¸‹çš„ç½®é¡¶å¯¹è¯æ ·å¼ */
        body[data-theme="cute"] .message-item.pinned {
            background: rgba(255, 182, 193, 0.08);
            border-left: 3px solid rgba(255, 182, 193, 0.3);
        }

        .pin-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ffd700;
            font-size: 12px;
            z-index: 5;
        }

        /* ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆé€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ - æ¯›ç»ç’ƒé£æ ¼è«å…°è¿ªè‰²ç³» */
        .game-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 85%;
            max-height: 70vh;
        }

        /* ç­‰å¾…æ¨¡æ€æ¡†æ ·å¼ */
        .waiting-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .waiting-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 40px 30px;
            text-align: center;
            max-width: 300px;
            width: 80%;
        }

        .waiting-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            border-style: dashed;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-text {
            color: #666;
            font-size: 16px;
            margin: 0;
        }

        .game-modal-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .game-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #5a5a5a;
        }

        .game-modal-title i {
            color: #8b9dc3;
        }

        .game-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .game-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #666;
        }

        .game-modal-body {
            padding: 15px 20px 25px 20px;
        }

        .game-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .game-button {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .game-button:active {
            transform: translateY(0);
        }

        /* è«å…°è¿ªè‰²ç³»æ¸¸æˆæŒ‰é’® */
        .game-button.gomoku {
            background: linear-gradient(135deg, rgba(139, 157, 195, 0.3), rgba(139, 157, 195, 0.1));
            color: #4a5568;
        }

        .game-button.turtle-soup {
            background: linear-gradient(135deg, rgba(168, 162, 158, 0.3), rgba(168, 162, 158, 0.1));
            color: #4a5568;
        }

        .game-button.werewolf {
            background: linear-gradient(135deg, rgba(147, 125, 135, 0.3), rgba(147, 125, 135, 0.1));
            color: #4a5568;
        }

        .game-button.monopoly {
            background: linear-gradient(135deg, rgba(162, 152, 140, 0.3), rgba(162, 152, 140, 0.1));
            color: #4a5568;
        }

        .game-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .game-button.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .game-button-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.4);
            color: inherit;
        }

        .game-button-content {
            flex: 1;
        }

        .game-button-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: inherit;
        }

        .game-button-desc {
            font-size: 13px;
            opacity: 0.8;
            color: inherit;
        }

        .game-button-badge {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .game-button-badge.recommended {
            background: rgba(255, 193, 7, 0.8);
            color: #856404;
        }

        .game-button-badge.coming-soon {
            background: rgba(108, 117, 125, 0.8);
            color: white;
        }

        /* ğŸ®ã€åˆ é™¤ã€‘æ¸¸æˆä¿¡æ¯æŒ‰é’®æ ·å¼å·²ç§»é™¤ */

        /* ğŸ”¥ã€æ–°å¢ã€‘çº¦å®šå®ŒæˆæŒ‰é’®æ ·å¼ */
        .appointment-action-btn.appointment-complete-btn.completed {
            background-color: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .appointment-action-btn.appointment-complete-btn.completed:hover {
            background-color: #e0e0e0 !important;
            color: #999 !important;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘çº¦å®šå€’è®¡æ—¶æ ·å¼ */
        .appointment-countdown {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #f0f0f0;
            color: #666;
        }

        .appointment-countdown.pending {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .appointment-countdown.completed {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        .appointment-countdown.overdue {
            background-color: #ffebee;
            color: #f44336;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘çº¦å®šè¯¦æƒ…å¤´éƒ¨æ ·å¼ */
        .appointment-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .appointment-detail-left {
            flex: 1;
        }

        .appointment-detail-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .appointment-detail-time {
            font-size: 14px;
            color: #666;
        }

        .appointment-detail-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appointment-type-tag {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #ff9800;
            color: white;
            white-space: nowrap;
        }

        /* ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©å°ç¥¨æ ·å¼ */
        .order-receipt-container {
            margin: 8px 0;
            display: flex;
            justify-content: flex-end;
        }

        .receipt-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            max-width: 280px;
            width: 100%;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }



        .receipt-header {
            background: #ffffff;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e8e8e8;
        }

        .receipt-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .receipt-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .receipt-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e8e8e8, transparent);
            margin: 0 16px;
        }

        .receipt-info {
            padding: 16px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
            font-size: 12px;
            line-height: 1.2;
        }

        .receipt-row:last-child {
            margin-bottom: 0;
        }

        .receipt-row .label {
            color: #666;
            font-weight: 400;
            font-size: 12px;
        }

        .receipt-row .value {
            color: #333;
            font-weight: 400;
            font-size: 12px;
        }

        .receipt-items {
            padding: 0 16px 16px;
        }

        .items-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e8e8e8;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .receipt-item:last-child {
            margin-bottom: 0;
        }

        .item-name {
            flex: 1;
            color: #333;
            margin-right: 8px;
        }

        .item-quantity {
            color: #666;
            margin-right: 8px;
            min-width: 30px;
            text-align: center;
        }

        .item-price {
            color: #333;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }

        .receipt-total {
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #e8e8e8;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-row:last-child {
            margin-bottom: 0;
        }

        .total-row.final {
            border-top: 1px solid #e8e8e8;
            padding-top: 8px;
            font-size: 16px;
            font-weight: 700;
        }

        .total-label {
            color: #666;
        }

        .total-row.final .total-label {
            color: #333;
        }

        .total-amount {
            color: #ff6b6b;
            font-weight: 700;
        }

        .receipt-footer {
            padding: 12px 16px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e8e8e8;
        }

        .thank-you {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        /* ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©å°ç¥¨åŠ¨ç”»æ•ˆæœ */
        .receipt-card {
            animation: receiptSlideIn 0.3s ease-out;
        }

        @keyframes receiptSlideIn {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
















    </style>

</head>
<body>
     <div id="auth-overlay">
        <div class="auth-box">
            <h1>åº”ç”¨æ¿€æ´»</h1>
            <p>è¯·å°†ä¸‹é¢çš„â€œè¯·æ±‚ç â€å‘é€ç»™ä½œè€…ï¼Œä»¥è·å–ä¸“å±äºæ‚¨çš„æ¿€æ´»ç ã€‚</p>
            <div class="code-display-box"><strong id="request-code">...</strong></div>
            <input type="text" id="license-input" placeholder="åœ¨æ­¤è¾“å…¥è·å–çš„æ¿€æ´»ç ">
            <button id="activate-button">æ¿€æ´»</button>
        </div>
    </div>
    <div id="notification-container"></div>
        <!-- æ¨é€é€šçŸ¥å®¹å™¨ -->
        <div id="notification-container"></div>
   <div id="phone-screen" class="phone-screen">
        <div class="wallpaper" id="wallpaper-element">
            <!-- ä¸»å±å¹•çŠ¶æ€æ  -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div class="status-bar-right">
                    <div id="status-bar-signal" class="signal-icon">
                        <div class="signal-row">
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                        </div>
                    </div>
                    <div id="status-bar-battery" class="battery-container">
                        <div class="battery-icon">
                            <div class="battery-level"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- éŸ³ä¹æ˜¾ç¤ºåŒºåŸŸï¼ˆç±»ä¼¼çµåŠ¨å²›ï¼‰ - ç‹¬ç«‹äºçŠ¶æ€æ  -->
            <div id="music-status-display" class="music-status-display" style="display: none;" onclick="openMusicModal()">
                <i class="fas fa-headphones music-icon"></i>
                <div class="music-lyrics-scroll">
                    <span id="current-lyric">â™ª ç‚¹å‡»å¼€å§‹å¬æ­Œ</span>
                </div>
            </div>

            <!-- æ—¶é’Ÿå®¹å™¨ -->
            <div id="clock-container">
                <div id="main-date">12æœˆ18æ—¥ æ˜ŸæœŸä¸€</div>
                <div id="main-time">14:25</div>
            </div>

            <div id="worldbook-screen" class="app-screen">
                <div class="app-top-container">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('worldbook-screen')">â€¹</button>
                        <div class="app-title">ä¸–ç•Œä¹¦</div>
                        <div class="add-worldbook-btn worldbook-add-btn" onclick="onWorldbookAddClick()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <div class="app-content">
                    <div id="global-worldbooks-content" class="worldbook-content-pane">
                        </div>
                    <div id="local-worldbooks-content" class="worldbook-content-pane" style="display: none;">
                        </div>

                </div>



                <div class="worldbook-tabs">
                    <div class="worldbook-tab active" onclick="switchWorldbookTab('global')">
                        <i class="fas fa-globe-asia"></i>
                        <span>å…¨å±€è®¾å®š</span>
                    </div>
                    <div class="worldbook-tab" onclick="switchWorldbookTab('local')">
                        <i class="fas fa-comment-dots"></i>
                        <span>å±€éƒ¨è®¾å®š</span>
                    </div>

                </div>
            </div>

                <!-- ä¸»å±å¹•å››å—å¸ƒå±€ -->
                <div id="home-grid">
                    <!-- å·¦ä¸Šè§’ï¼šå›¾ç‰‡å°ç»„ä»¶ -->
                    <div class="home-section top-left">
                        <div class="widget photo-widget" onclick="showPhotoWidgetOptions()">
                            <div class="photo-widget-content" id="photo-widget-content">
                                <div class="photo-placeholder" id="photo-placeholder">
                                    <i class="fas fa-image"></i>
                                    <span>ç‚¹å‡»æ·»åŠ å›¾ç‰‡</span>
                                </div>
                                <img class="photo-widget-image" id="photo-widget-image" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¸Šè§’ï¼šä¸¤ä¸ªåº”ç”¨ -->
                    <div class="home-section top-right">
                        <div class="apps-grid-2">
                            <a href="#" class="mini-app" onclick="showApp('chat-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-comment-dots"></i>
                                </div>
                                <span>Chat</span>
                            </a>
                            <a href="#" class="mini-app" onclick="showApp('worldbook-screen'); switchWorldbookTab('global');">
                                <div class="mini-app-icon">
                                    <i class="fas fa-globe-americas"></i>
                                </div>
                                <span>ä¸–ç•Œä¹¦</span>
                            </a>
                        </div>
                    </div>

                    <!-- å·¦ä¸‹è§’ï¼šä¸¤ä¸ªåº”ç”¨ -->
                    <div class="home-section bottom-left">
                        <div class="apps-grid-2">
                            <a href="#" class="mini-app" onclick="showApp('anniversary-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <span>çºªå¿µæ—¥</span>
                            </a>
                            <a href="#" class="mini-app" onclick="showApp('forum-screen')">
                                <div class="mini-app-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <span>è®ºå›</span>
                            </a>
                        </div>
                    </div>

                    <!-- å³ä¸‹è§’ï¼šçºªå¿µæ—¥å°ç»„ä»¶ -->
                    <div class="home-section bottom-right">
                        <div class="widget anniversary-widget">
                            <div class="anniversary-widget-content" id="anniversary-widget-content">
                                <div class="anniversary-placeholder" id="anniversary-placeholder">
                                    <i class="fas fa-heart"></i>
                                    <span>æš‚æ— çºªå¿µæ—¥</span>
                                </div>
                                <div class="anniversary-display" id="anniversary-display" style="display: none;">
                                    <div class="anniversary-name" id="widget-anniversary-name"></div>
                                    <div class="anniversary-countdown" id="widget-anniversary-countdown"></div>
                                    <div class="anniversary-date" id="widget-anniversary-date"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- iPhoneé£æ ¼Dockæ  -->
                <div id="dock-bar">
                    <div class="dock-container">
                        <a href="#" class="dock-app" onclick="showApp('messages-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <span>çŸ­ä¿¡</span>
                        </a>
                        <a href="#" class="dock-app" onclick="showApp('settings-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <span>è®¾ç½®</span>
                        </a>
                        <a href="#" class="dock-app" onclick="showApp('memory-viewer-screen')">
                            <div class="dock-app-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <span>è®°å¿†</span>
                        </a>
                    </div>
                </div>


                <!-- çºªå¿µæ—¥ç•Œé¢ -->
                <div id="anniversary-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('anniversary-screen')">â€¹</button>
                            <div class="app-title">çºªå¿µæ—¥</div>
                        <div class="add-anniversary-btn" onclick="showAnniversaryForm()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <!-- çºªå¿µæ—¥å†…å®¹åŒºåŸŸ -->
                        <div id="anniversary-content" class="anniversary-content-pane">
                            <!-- ç½®é¡¶çºªå¿µæ—¥æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="pinned-anniversary-section" class="pinned-anniversary-section" style="display: none;">
                                <div id="pinned-anniversary-card" class="pinned-anniversary-card">
                                    <!-- ç½®é¡¶çºªå¿µæ—¥å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <div id="anniversary-list" class="anniversary-list">
                                <!-- çºªå¿µæ—¥åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                <div class="anniversary-empty-state">
                                    <i class="fas fa-heart"></i>
                                    <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥</p>
                                    <p>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ é‡è¦çš„æ—¥å­</p>
                                </div>
                            </div>
                        </div>

                        <!-- çº¦å®šå†…å®¹åŒºåŸŸ -->
                        <div id="appointment-content" class="anniversary-content-pane" style="display: none;">
                            <!-- ç½®é¡¶çº¦å®šæ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="pinned-appointment-section" class="pinned-appointment-section" style="display: none;">
                                <div id="pinned-appointment-card" class="pinned-appointment-card">
                                    <!-- ç½®é¡¶çº¦å®šå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <div id="appointment-list" class="appointment-list">
                                <!-- çº¦å®šåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                <div class="appointment-empty-state">
                                    <i class="fas fa-calendar-check"></i>
                                    <p>è¿˜æ²¡æœ‰çº¦å®š</p>
                                    <p>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ æ–°çº¦å®š</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨åˆ†æ  -->
                    <div class="anniversary-tabs">
                        <div class="anniversary-tab active" onclick="switchAnniversaryTab('anniversary')">
                            <i class="fas fa-heart"></i>
                            <span>çºªå¿µæ—¥</span>
                        </div>
                        <div class="anniversary-tab" onclick="switchAnniversaryTab('appointment')">
                            <i class="fas fa-calendar-check"></i>
                            <span>çº¦å®š</span>
                        </div>
                    </div>
                </div>

                <!-- è´­ç‰©ç•Œé¢ -->
                <div id="shopping-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="handleShoppingBack()" id="shopping-back-btn">â€¹</button>
                        <div class="app-title">è´­ç‰©</div>
                        <div class="shopping-header-actions">
                            <div class="shopping-cart-btn" onclick="openShoppingCart()" title="è´­ç‰©è½¦">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-content shopping-content">
                        <!-- æœç´¢æ¡† -->
                        <div class="shopping-search-container">
                            <div class="shopping-search-box">
                                <i class="fas fa-search shopping-search-icon"></i>
                                <input type="text" id="shopping-search-input" class="shopping-search-input" placeholder="æœç´¢å•†å“..." maxlength="100">
                            </div>
                        </div>

                        <!-- åˆ†ç±»åŒºåŸŸ -->
                        <div class="shopping-categories" id="shopping-categories">
                            <!-- å¤–å–åˆ†ç±» -->
                            <div class="category-list" id="takeout-categories">
                                <div class="category-item" onclick="showCategoryProducts('ç¾é£Ÿ')">
                                    <i class="fas fa-utensils"></i>
                                    <span>ç¾é£Ÿ</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('ç”œç‚¹é¥®å“')">
                                    <i class="fas fa-coffee"></i>
                                    <span>ç”œç‚¹é¥®å“</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('è”¬èœæ°´æœ')">
                                    <i class="fas fa-apple-alt"></i>
                                    <span>è”¬èœæ°´æœ</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('çœ‹ç—…ä¹°è¯')">
                                    <i class="fas fa-pills"></i>
                                    <span>çœ‹ç—…ä¹°è¯</span>
                                </div>
                                <div class="category-item custom-item" onclick="addCustomItem()">
                                    <i class="fas fa-plus"></i>
                                    <span>æ·»åŠ è‡ªå®šä¹‰å•†å“</span>
                                </div>
                            </div>

                            <!-- è´­ç‰©åˆ†ç±» -->
                            <div class="category-list" id="shopping-categories-list" style="display: none;">
                                <div class="category-item" onclick="showCategoryProducts('æ•°ç äº§å“')">
                                    <i class="fas fa-laptop"></i>
                                    <span>æ•°ç äº§å“</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('å®¶å±…ç™¾è´§')">
                                    <i class="fas fa-home"></i>
                                    <span>å®¶å±…ç™¾è´§</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('å¥³è£…ç”·è£…')">
                                    <i class="fas fa-tshirt"></i>
                                    <span>å¥³è£…ç”·è£…</span>
                                </div>
                                <div class="category-item" onclick="showCategoryProducts('é¥°å“ç®±åŒ…')">
                                    <i class="fas fa-gem"></i>
                                    <span>é¥°å“ç®±åŒ…</span>
                                </div>
                                <div class="category-item custom-item" onclick="addCustomItem()">
                                    <i class="fas fa-plus"></i>
                                    <span>æ·»åŠ è‡ªå®šä¹‰å•†å“</span>
                                </div>
                            </div>
                        </div>

                        <!-- å•†å“å±•ç¤ºåŒºåŸŸ -->
                        <div class="products-container" id="products-container" style="display: none;">
                            <div class="products-grid" id="products-grid">
                                <!-- å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨å¯¼èˆªæ  -->
                    <div class="shopping-tabs">
                        <div class="shopping-tab active" onclick="switchShoppingTab('takeout')">
                            <i class="fas fa-utensils"></i>
                            <span>å¤–å–</span>
                        </div>
                        <div class="shopping-tab" onclick="switchShoppingTab('shopping')">
                            <i class="fas fa-shopping-cart"></i>
                            <span>è´­ç‰©</span>
                        </div>
                    </div>
                </div>

                <!-- è´­ç‰©è½¦ç•Œé¢ -->
                <div id="shopping-cart-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="handleShoppingCartBack()">â€¹</button>
                        <div class="app-title">è´­ç‰©è½¦</div>
                        <div class="cart-header-actions">
                            <div class="clear-cart-btn" onclick="clearShoppingCart()" title="æ¸…ç©ºè´­ç‰©è½¦">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                    <div class="app-content cart-content">
                        <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
                        <div class="cart-items-container" id="cart-items-container">
                            <!-- è´­ç‰©è½¦å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- è´­ç‰©è½¦ä¸ºç©ºæ—¶çš„æç¤º -->
                        <div class="cart-empty-state" id="cart-empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                            <p>å»æ·»åŠ ä¸€äº›å•†å“å§</p>
                            <button class="go-shopping-btn" onclick="hideApp('shopping-cart-screen'); openShoppingScreen();">
                                å»è´­ç‰©
                            </button>
                        </div>
                    </div>

                    <!-- è´­ç‰©è½¦åº•éƒ¨ç»“ç®—åŒºåŸŸ -->
                    <div class="cart-footer" id="cart-footer" style="display: none;">
                        <div class="cart-summary">
                            <div class="cart-total">
                                <span class="total-label">æ€»è®¡ï¼š</span>
                                <span class="total-price" id="cart-total-price">Â¥0</span>
                            </div>
                            <div class="cart-actions">
                                <button class="pay-for-me-btn" onclick="requestPayment()">
                                    è¯·Taä»£ä»˜
                                </button>
                                <button class="checkout-btn" onclick="proceedToCheckout()">
                                    ç»“ç®— (<span id="cart-items-count">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çŸ­ä¿¡ç•Œé¢ -->
                <div id="messages-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('messages-screen')">â€¹</button>
                            <div class="app-title">çŸ­ä¿¡</div>
                        <div class="messages-header-actions" id="sms-normal-actions">
                            <div class="sms-manage-btn" onclick="showSMSManageOptions()" title="ç®¡ç†çŸ­ä¿¡">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="add-message-btn" onclick="showNewMessageForm()">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                        <!-- ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡åˆ—è¡¨å¤šé€‰æ¨¡å¼æŒ‰é’® -->
                        <div class="messages-multiselect-actions" id="sms-list-multiselect-actions" style="display: none;">
                            <button class="multiselect-btn cancel-btn" onclick="exitSMSListMultiSelectMode()">
                                <span>å–æ¶ˆ</span>
                            </button>
                            <button class="multiselect-btn delete-btn" onclick="deleteSelectedSMSConversations()">
                                <span>åˆ é™¤</span>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="messages-list" class="messages-list">
                            <!-- çŸ­ä¿¡åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            <div class="messages-empty-state">
                                <i class="fas fa-comment-dots"></i>
                                <p>æš‚æ— çŸ­ä¿¡</p>
                                <p>ç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘æŒ‰é’®åˆ›å»ºæ–°ä¿¡æ¯</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çŸ­ä¿¡èŠå¤©ç•Œé¢ -->
                <div id="sms-chat-screen" class="app-screen" style="display: none;">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideSMSChat()">â€¹</button>
                        <div class="sms-chat-header-center">
                            <div class="sms-chat-avatar" id="sms-chat-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="sms-chat-name" id="sms-chat-name"></div>
                        </div>
                        <div class="sms-chat-actions" id="sms-chat-normal-actions">
                            <button class="sms-action-btn" onclick="showSMSChatInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <!-- ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘çŸ­ä¿¡å¤šé€‰æ¨¡å¼æŒ‰é’® - ç®€æ´æ ·å¼ -->
                        <div class="sms-chat-multiselect-actions" id="sms-chat-multiselect-actions" style="display: none;">
                            <button class="multiselect-btn cancel-btn" onclick="exitSMSMultiSelectMode()">
                                <span>å–æ¶ˆ</span>
                            </button>
                            <button class="multiselect-btn delete-btn" onclick="deleteSelectedSMSMessages()">
                                <span>åˆ é™¤</span>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content sms-chat-content">
                        <div id="sms-messages-container" class="sms-messages-container">
                            <!-- çŸ­ä¿¡æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="sms-input-section">
                        <div class="sms-input-container">
                            <button class="sms-attachment-btn" onclick="openSMSImagePicker()">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="sms-input-wrapper">
                                <input type="text" id="sms-message-input" class="sms-message-input" placeholder="çŸ­ä¿¡" onkeydown="handleSMSInputKeydown(event)">
                                <button class="sms-wait-reply-btn" onclick="triggerSMSReply()" id="sms-wait-reply-btn" title="ç­‰å¾…è§’è‰²å›å¤">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                            <button class="sms-send-btn" onclick="sendSMSMessage()" id="sms-send-button" style="display: none;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>



                <!-- ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡å›¾ç‰‡é€‰æ‹©å™¨ -->
                <input type="file" id="sms-image-input" accept="image/*" style="display: none;" onchange="handleSMSImageSelect(event)">

                <!-- ğŸ¨ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸»é¢˜å›¾ç‰‡ä¸Šä¼ è¾“å…¥æ¡† -->
                <input type="file" id="chat-top-bg-input" accept="image/*" style="display: none;" onchange="handleChatTopBgUpload(event)">
                <input type="file" id="chat-bottom-bg-input" accept="image/*" style="display: none;" onchange="handleChatBottomBgUpload(event)">
                <input type="file" id="button-icon-input" accept="image/*" style="display: none;" onchange="handleButtonIconUpload(event)">
                <input type="file" id="global-top-app-bar-input" accept="image/*" style="display: none;" onchange="handleGlobalTopAppBarUpload(event)">
                <input type="file" id="global-bottom-app-bar-input" accept="image/*" style="display: none;" onchange="handleGlobalBottomAppBarUpload(event)">
                <input type="file" id="global-back-button-input" accept="image/*" style="display: none;" onchange="handleGlobalBackButtonUpload(event)">
                <input type="file" id="global-add-button-input" accept="image/*" style="display: none;" onchange="handleGlobalAddButtonUpload(event)">
                <input type="file" id="global-bg-input" accept="image/*" style="display: none;" onchange="handleGlobalBgUpload(event)">

                <!-- ğŸ”¥ã€ä¿®å¤ã€‘çŸ­ä¿¡ç®¡ç†é€‰é¡¹æ¨¡æ€æ¡† -->
                <div id="sms-manage-modal" class="sms-manage-modal" style="display: none;" onclick="hideSMSManageOptions(event)">
                    <div class="sms-manage-modal-content" onclick="event.stopPropagation()">
                        <div class="sms-manage-option" onclick="enterSMSListMultiSelectMode()">
                            <i class="fas fa-trash"></i>
                            <span>å¤šé€‰åˆ é™¤</span>
                        </div>
                        <div class="sms-manage-option" onclick="enterSMSPinMode()">
                            <i class="fas fa-thumbtack"></i>
                            <span>ç½®é¡¶å¯¹è¯</span>
                        </div>
                    </div>
                </div>

                <!-- çŸ­ä¿¡èº«ä»½é€‰æ‹©æ¨¡æ€æ¡† -->
                <div id="sms-persona-selector-modal" class="modal-overlay" style="display: none;" onclick="hideSMSPersonaSelector(event)">
                    <div class="modal-content sms-selector-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>é€‰æ‹©ä½ çš„èº«ä»½</h3>
                            <button class="modal-close-btn" onclick="hideSMSPersonaSelector()">Ã—</button>
                        </div>
                        <div class="modal-body" id="sms-persona-selector-body">
                            <!-- èº«ä»½åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- çŸ­ä¿¡è§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
                <div id="sms-character-selector-modal" class="modal-overlay" style="display: none;" onclick="hideSMSCharacterSelector(event)">
                    <div class="modal-content sms-selector-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>é€‰æ‹©èŠå¤©è§’è‰²</h3>
                            <button class="modal-close-btn" onclick="hideSMSCharacterSelector()">Ã—</button>
                        </div>
                        <div class="modal-body" id="sms-character-selector-body">
                            <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰å•†å“æ·»åŠ æ¨¡æ€æ¡† -->
                <div id="custom-item-modal" class="modal-overlay" style="display: none;" onclick="hideCustomItemModal(event)">
                    <div class="modal-content custom-item-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>æ·»åŠ è‡ªå®šä¹‰å•†å“</h3>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="custom-item-name">å•†å“åç§°</label>
                                <input type="text" id="custom-item-name" class="form-input" placeholder="è¯·è¾“å…¥å•†å“åç§°" maxlength="50" onkeydown="handleCustomItemKeydown(event)">
                            </div>

                            <div class="form-group">
                                <label for="custom-item-description">å•†å“ä»‹ç» <span style="color: #999; font-size: 12px;">(å¯é€‰)</span></label>
                                <input type="text" id="custom-item-description" class="form-input" placeholder="è¯·è¾“å…¥å•†å“ä»‹ç»" maxlength="100" onkeydown="handleCustomItemKeydown(event)">
                            </div>

                            <div class="form-group">
                                <label for="custom-item-price">å•†å“ä»·æ ¼</label>
                                <div class="price-input-container">
                                    <span class="price-symbol">Â¥</span>
                                    <input type="number" id="custom-item-price" class="form-input price-input" placeholder="0.00" min="0" step="0.01" onkeydown="handleCustomItemKeydown(event)">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="hideCustomItemModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="confirmAddCustomItem()">æ·»åŠ åˆ°è´­ç‰©è½¦</button>
                        </div>
                    </div>
                </div>

                <!-- ä»£ä»˜é€‰æ‹©æ¨¡æ€æ¡† -->
                <div id="payment-request-modal" class="modal-overlay" style="display: none;" onclick="hidePaymentRequestModal(event)">
                    <div class="modal-content payment-request-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>è¯·Taä»£ä»˜</h3>
                            <button class="modal-close-btn" onclick="hidePaymentRequestModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-summary">
                                <div class="payment-total">
                                    <span class="total-label">æ€»è®¡ï¼š</span>
                                    <span class="total-price" id="payment-modal-total">Â¥0</span>
                                </div>
                                <div class="payment-items-count">
                                    å…± <span id="payment-modal-items-count">0</span> ä»¶å•†å“
                                </div>
                            </div>

                            <div class="payment-options">
                                <h4>ä¸ºè°ä¸‹å•ï¼Ÿ</h4>
                                <div class="payment-option-buttons">
                                    <button class="payment-option-btn" onclick="processOrder('for_self')">
                                        <i class="fas fa-user"></i>
                                        <span>ä¸ºè‡ªå·±ä¸‹å•</span>
                                    </button>
                                    <button class="payment-option-btn" onclick="processOrder('for_ta')">
                                        <i class="fas fa-gift"></i>
                                        <span>ä¸ºTaä¸‹å•</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çŸ­ä¿¡èŠå¤©è®¾ç½®ç•Œé¢ -->
                <div id="sms-chat-settings-screen" class="app-screen" style="display: none;">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideSMSChatSettings()">â€¹</button>
                            <div class="app-title">èŠå¤©è®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content sms-settings-content">
                        <div class="setting-group">
                            <h4><i class="fas fa-history"></i> å†å²æ¶ˆæ¯</h4>
                            <div class="setting-item">
                                <label>é™„å¸¦å†å²æ¶ˆæ¯å›åˆæ•°</label>
                                <div class="slider-container">
                                    <input type="range" id="sms-history-rounds-slider" min="0" max="500" value="50" onchange="updateSMSHistoryRounds()">
                                    <span id="sms-history-rounds-value">50è½®</span>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4><i class="fas fa-palette"></i> æ°”æ³¡é¢œè‰²</h4>
                            <div class="setting-item">
                                <label>æˆ‘çš„æ¶ˆæ¯æ°”æ³¡é¢œè‰²</label>
                                <div class="bubble-color-selector">
                                    <div class="color-option-text" data-color="blue" onclick="setSMSBubbleColor('blue')">
                                        è“è‰²
                                    </div>
                                    <div class="color-option-text" data-color="green" onclick="setSMSBubbleColor('green')">
                                        ç»¿è‰²
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4><i class="fas fa-trash-alt"></i> æ•°æ®ç®¡ç†</h4>
                            <div class="setting-item" onclick="clearSMSChatHistory()">
                                <label style="white-space: nowrap;">æ¸…ç©ºè®°å½•</label>
                                <div class="setting-desc">åˆ é™¤æ‰€æœ‰çŸ­ä¿¡è®°å½•å’Œç›¸å…³è®°å¿†ï¼Œä¸å¯æ¢å¤</div>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- èŠå¤©ç•Œé¢ -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('chat-screen')">â€¹</button>
                            <div class="app-title">ğŸ’¬</div>
                        <div class="chat-header-actions">
                            <div id="group-manage-btn" class="header-action-btn" onclick="enterGroupManageMode()" title="ç®¡ç†åˆ†ç»„">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="app-content" id="chat-content">
                        <!-- é»˜è®¤æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨ -->
                        <div class="message-list" id="message-list">
                            <!-- æ¶ˆæ¯åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- é€šè®¯å½• -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">

                                <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>

                        </div>

                        <!-- åŠ¨æ€é¡µé¢ -->
                        <div class="moments-page hide moments-page-no-padding" id="moments-page">
                            <div class="moments-header">
                                <div class="moments-cover" onclick="changeCoverImage()">
                                    <div class="cover-image-placeholder" id="cover-placeholder">
                                        <div class="cover-placeholder-text">ç‚¹å‡»æ›´æ¢å°é¢</div>
                                        </div>
                                    <img class="cover-image hide" id="cover-image" src="">
                                    </div>

                                <!-- ç”¨æˆ·åï¼Œç‹¬ç«‹æ”¾ç½®åœ¨å¤´åƒå·¦ä¸Šè§’ -->
                                <div class="moments-username" onclick="changeUsername(event)" id="moments-username">ç”¨æˆ·</div>

                                <!-- ç‹¬ç«‹çš„å¤´åƒï¼Œè·¨è¶ŠèƒŒæ™¯å’ŒåŠ¨æ€åˆ—è¡¨åŒºåŸŸï¼Œæ”¾åœ¨headerå¤–é¢ -->
                                <div class="moments-avatar" onclick="changeAvatarImage(event)" id="moments-avatar">
                                    <i class="fas fa-user moments-avatar-icon"></i>
                                </div>
                            </div>

                            <div class="moments-list" id="moments-list">
                                <!-- åŠ¨æ€åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>


                        </div>


                        <!-- é¢å…·åŒºåŸŸ -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-section">
                                <div class="persona-header" onclick="togglePersonaSection()">
                                    <div class="persona-title">
                                        <h2>æˆ‘çš„é¢å…·</h2>
                                        <p>ç®¡ç†ä½ çš„å¤šé‡èº«ä»½è®¾å®š</p>
                                    </div>
                                    <div class="persona-header-actions">
                                        <button class="add-persona-btn-header" onclick="event.stopPropagation(); showPersonaForm()" title="æ·»åŠ é¢å…·">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <div class="persona-toggle" onclick="event.stopPropagation(); togglePersonaSection()">
                                            <i class="fas fa-chevron-down expanded" id="persona-chevron"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="persona-content" id="persona-content">
                                    <div class="persona-list" id="persona-list">
                                        <!-- é¢å…·åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>

                            <!-- è¡¨æƒ…åŒ…åº“åŒºåŸŸ -->
                            <div class="emoji-library-section">
                                <div class="emoji-library-header" onclick="toggleEmojiLibrarySection()">
                                    <div class="emoji-library-title">
                                        <h3>è§’è‰²è¡¨æƒ…åŒ…åº“</h3>
                                        <p>ç®¡ç†è§’è‰²çš„è¡¨æƒ…åŒ…åˆ†ç±»</p>
                                    </div>
                                    <div class="emoji-library-header-actions">
                                        <button class="create-library-btn-header" onclick="event.stopPropagation(); showCreateLibraryForm()" title="æ–°å»ºè¡¨æƒ…åŒ…åº“">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <div class="emoji-library-toggle" onclick="event.stopPropagation(); toggleEmojiLibrarySection()">
                                            <i class="fas fa-chevron-down" id="emoji-library-chevron"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="emoji-library-content" id="emoji-library-content" style="display: none;">
                                    <div class="emoji-library-list" id="emoji-library-list">
                                        <!-- è¡¨æƒ…åŒ…åº“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="chat-tabs">
                        <div class="chat-tab active" onclick="switchChatTab('message-list')" id="message-tab">
                            <i class="fas fa-comments"></i>
                            <span>æ¶ˆæ¯</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('contact-list')">
                            <i class="fas fa-user-friends"></i>
                            <span>è§’è‰²</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('moments-page')">
                            <i class="fas fa-globe-americas"></i>
                            <span>åŠ¨æ€</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('profile-page')">
                            <i class="fas fa-user-circle"></i>
                            <span>æˆ‘</span>
                        </div>
                    </div>
                </div>

                <!-- å‘å¸ƒåŠ¨æ€ç•Œé¢ -->
                <div id="publish-moment-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePublishMoment()">â€¹</button>
                        <div class="app-title">å‘è¡¨åŠ¨æ€</div>
                        <button class="publish-btn" onclick="publishMoment()">å‘è¡¨</button>
                    </div>
                    <div class="app-content">
                        <div class="publish-moment-form">
                            <!-- æ–‡å­—è¾“å…¥åŒºåŸŸ -->
                            <div class="moment-text-input">
                                <textarea
                                    id="moment-text"
                                    placeholder="æ­¤åˆ»æƒ³æ³•..."
                                    class="moment-textarea"
                                    maxlength="500"
                                    oninput="updateTextCount()"></textarea>
                                <div class="text-count" id="text-count">0/500</div>
                            </div>

                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div class="moment-images-section">
                                <div class="moment-images-grid" id="moment-images-grid">
                                    <!-- åŠ¨æ€æ·»åŠ çš„å›¾ç‰‡é¢„è§ˆ -->
                                </div>
                                <div class="add-image-btn" onclick="addMomentImage()">
                                    <i class="fas fa-plus"></i>
                                    <span>æ·»åŠ å›¾ç‰‡</span>
                                </div>
                            </div>

                            <!-- å‘å¸ƒé€‰é¡¹ -->
                            <div class="publish-options">
                                <div class="option-item" onclick="showLocationModal()">
                                    <i class="fas fa-map-marker-alt location-icon"></i>
                                    <span>æ‰€åœ¨ä½ç½®</span>
                                    <span class="option-value" id="selected-location"></span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item" onclick="showMomentMentionModal()">
                                    <i class="fas fa-at mention-icon"></i>
                                    <span>æé†’è°çœ‹</span>
                                    <div class="selected-mentions" id="selected-mentions">
                                        <!-- å·²é€‰æ‹©çš„è§’è‰²å¤´åƒå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                    </div>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item" onclick="showVisibilityModal()">
                                    <i class="fas fa-eye visibility-icon"></i>
                                    <span>è°å¯ä»¥çœ‹</span>
                                    <span class="option-value" id="selected-visibility">å…¬å¼€</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä½ç½®é€‰æ‹©æ¨¡æ€æ¡† -->
                <div id="location-modal" class="modal-overlay" style="display: none;" onclick="hideLocationModal(event)">
                    <div class="modal-content location-modal-content" onclick="event.stopPropagation()">
                        <div class="location-modal-header">
                            <button class="location-cancel-btn" onclick="hideLocationModal()">å–æ¶ˆ</button>
                            <h3 class="location-modal-title">æ‰€åœ¨ä½ç½®</h3>
                            <button class="location-confirm-btn" onclick="confirmLocation()">å®Œæˆ</button>
                        </div>
                        <div class="location-modal-body">
                            <div class="location-search-section">
                                <div class="location-search-box">
                                    <i class="fas fa-search location-search-icon"></i>
                                    <input type="text" id="location-input" class="location-search-input" placeholder="æœç´¢é™„è¿‘ä½ç½®" maxlength="50">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æé†’è°çœ‹æ¨¡æ€æ¡† -->
                <div id="mention-modal" class="modal-overlay" style="display: none;" onclick="hideMomentMentionModal(event)">
                    <div class="modal-content mention-modal-content" onclick="event.stopPropagation()">
                        <div class="mention-modal-header">
                            <button class="mention-cancel-btn" onclick="hideMomentMentionModal()">å–æ¶ˆ</button>
                            <h3 class="mention-modal-title">æé†’è°çœ‹</h3>
                            <button class="mention-confirm-btn" onclick="confirmMomentMention()">å®Œæˆ</button>
                        </div>
                        <div class="mention-modal-body">
                            <div class="mention-characters-list" id="mention-characters-list">
                                <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è°å¯ä»¥çœ‹æ¨¡æ€æ¡† -->
                <div id="visibility-modal" class="modal-overlay" style="display: none;" onclick="hideVisibilityModal(event)">
                    <div class="modal-content visibility-modal-content" onclick="event.stopPropagation()">
                        <div class="visibility-modal-header">
                            <button class="visibility-cancel-btn" onclick="hideVisibilityModal()">å–æ¶ˆ</button>
                            <h3 class="visibility-modal-title">è°å¯ä»¥çœ‹</h3>
                            <button class="visibility-confirm-btn" onclick="confirmVisibility()">å®Œæˆ</button>
                        </div>
                        <div class="visibility-modal-body">
                            <div class="visibility-options" id="visibility-options">
                                <div class="visibility-option" data-value="public">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">å…¬å¼€</div>
                                        <div class="visibility-option-desc">æ‰€æœ‰äººéƒ½å¯ä»¥çœ‹åˆ°</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="visibility-option" data-value="private">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">ç§å¯†</div>
                                        <div class="visibility-option-desc">åªæœ‰è‡ªå·±å¯ä»¥çœ‹åˆ°</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="visibility-option" data-value="partial">
                                    <div class="visibility-option-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="visibility-option-content">
                                        <div class="visibility-option-title">éƒ¨åˆ†å¯è§</div>
                                        <div class="visibility-option-desc">é€‰æ‹©ç‰¹å®šåˆ†ç»„å¯è§</div>
                                    </div>
                                    <div class="visibility-option-radio">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="visibility-groups-section" id="visibility-groups-section" style="display: none;">
                                <div class="visibility-groups-title">é€‰æ‹©å¯è§åˆ†ç»„</div>
                                <div class="visibility-groups-list" id="visibility-groups-list">
                                    <!-- åˆ†ç»„åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è®ºå›ç•Œé¢ -->
                <div id="forum-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('forum-screen')">â€¹</button>
                            <div class="app-title">è®ºå›</div>
                        <div class="add-forum-btn" onclick="showCreateForumScreen()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="forum-archive-list" class="forum-archive-list">
                            <div class="forum-empty-state">
                                <i class="fas fa-comments"></i>
                                <p>è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•è®ºå›</p>
                                <p>ç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªè®ºå›</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ›å»ºè®ºå›ç•Œé¢ -->
                <div id="create-forum-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('create-forum-screen'); renderForumArchives(); showApp('forum-screen');">â€¹</button>
                        <div class="app-title" id="forum-form-title">åˆ›å»ºæ–°è®ºå›</div>
                    </div>
                    <div class="app-content">
                        <input type="hidden" id="forum-form-id">
                        <div class="form-group">
                            <label class="form-label">è®ºå›åç§°</label>
                            <input type="text" id="forum-name-input" class="form-input" placeholder="ç»™è¿™ä¸ªä¸–ç•Œçº¿èµ·ä¸ªåå­—å§">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©è§’è‰² (å¯å¤šé€‰)</label>
                            <div id="forum-character-selection" class="selection-grid"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©ä½ çš„èº«ä»½</label>
                            <div id="forum-persona-selection" class="selection-grid single-selection"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¡¥å……ä¸–ç•Œè§‚ (å¯é€‰)</label>
                            <textarea id="forum-worldview-input" class="form-textarea" rows="4" placeholder="è¡¥å……ä¸€äº›èƒŒæ™¯æ•…äº‹æˆ–è®¾å®š..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æŒ‚è½½å±€éƒ¨ä¸–ç•Œä¹¦ (å¯é€‰)</label>
                            <div id="forum-worldbook-selection" class="selection-grid"></div>
                        </div>
                        <button class="form-submit" id="forum-form-submit-btn" onclick="handleForumFormSubmit()">è¿›å…¥è®ºå›</button>
                    </div>
                </div>

                <!-- å¸–å­åˆ—è¡¨ç•Œé¢ -->
                <div id="forum-view-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToForumArchives()">â€¹</button>
                            <div class="app-title" id="forum-view-title">è®ºå›</div>
                        <div class="header-actions">
                            <span class="action-btn" onclick="showMakeNewsModal()" title="æä¸ªå¤§æ–°é—»">
                                <i class="fas fa-pencil-alt"></i>
                            </span>
                            <span class="action-btn" onclick="showForumProfile()" title="ä¸ªäººä¸»é¡µ">
                                <i class="fas fa-user"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <div id="forum-posts-list" class="post-list">
                        </div>
                    </div>

                    <!-- æ‚¬æµ®æŒ‰é’®ç»„ -->
                    <div class="floating-action-buttons">
                        <div class="floating-btn refresh-btn" onclick="refreshPosts()" title="åˆ·æ–°å¸–å­">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="floating-btn post-btn" onclick="showCreatePostModal()" title="å‘å¸–">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·å‘å¸–æ¨¡æ€æ¡† -->
                <div id="create-post-modal" class="modal-overlay" style="display: none;" onclick="hideCreatePostModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>å‘å¸ƒæ–°å¸–</h3>
                            <button class="modal-close-btn" onclick="hideCreatePostModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>æ ‡é¢˜</label>
                                <input type="text" id="post-title-input" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜..." maxlength="100">
                            </div>
                            <div class="form-group">
                                <label>å†…å®¹</label>
                                <textarea id="post-content-input" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." rows="6" maxlength="2000"></textarea>
                            </div>
                            <div class="form-group">
                                <label>å›¾ç‰‡ (å¯é€‰)</label>
                                <div id="post-image-preview-container" style="display:none; margin-bottom: 10px; position: relative;">
                                    <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                                    <button id="post-remove-image-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">Ã—</button>
                                </div>
                                <button class="form-upload-btn" id="post-upload-image-btn">
                                    <i class="fas fa-image"></i> é€‰æ‹©å›¾ç‰‡
                                </button>
                                <input type="file" id="post-image-upload" accept="image/*" style="display: none;">
                            </div>
                            <div class="char-count">
                                <span id="title-count">0/100</span> | <span id="content-count">0/2000</span>
                            </div>
                            <div class="form-group" style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="anonymous-post-checkbox" style="margin-right: 8px;">
                                    åŒ¿åå‘å¸–ï¼ˆå…¶ä»–ç”¨æˆ·æ— æ³•è¯†åˆ«ä½ çš„èº«ä»½ï¼‰
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="hideCreatePostModal()">å–æ¶ˆ</button>
                            <button class="btn-primary" onclick="submitUserPost()">å‘å¸ƒ</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘é€šè¯å½¢è±¡è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="video-avatar-modal" class="modal-overlay" style="display: none;" onclick="hideVideoAvatarModal(event)">
                    <div class="modal-content video-avatar-modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>é€šè¯å½¢è±¡è®¾ç½®</h3>
                            <button class="modal-close-btn" onclick="hideVideoAvatarModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="video-avatar-preview">
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview-item">
                                        <div class="avatar-preview-label">è§’è‰²é€šè¯å½¢è±¡</div>
                                        <div class="avatar-preview-image-container">
                                            <img id="character-video-avatar-preview" src="" alt="è§’è‰²é€šè¯å½¢è±¡" class="avatar-preview-image">
                                            <div class="avatar-preview-placeholder" id="character-avatar-placeholder">
                                                <i class="fas fa-user"></i>
                                                <span>ç‚¹å‡»è®¾ç½®</span>
                                            </div>
                                        </div>
                                        <button class="avatar-change-btn" onclick="changeCharacterVideoAvatar()">
                                            <i class="fas fa-camera"></i>
                                            æ›´æ¢å½¢è±¡
                                        </button>
                                    </div>

                                    <div class="avatar-preview-item">
                                        <div class="avatar-preview-label">ç”¨æˆ·é€šè¯å½¢è±¡</div>
                                        <div class="avatar-preview-image-container">
                                            <img id="user-video-avatar-preview" src="" alt="ç”¨æˆ·é€šè¯å½¢è±¡" class="avatar-preview-image">
                                            <div class="avatar-preview-placeholder" id="user-avatar-placeholder">
                                                <i class="fas fa-user"></i>
                                                <span>ç‚¹å‡»è®¾ç½®</span>
                                            </div>
                                        </div>
                                        <button class="avatar-change-btn" onclick="changeUserVideoAvatar()">
                                            <i class="fas fa-camera"></i>
                                            æ›´æ¢å½¢è±¡
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="video-avatar-tips">
                                <div class="tips-title">
                                    <i class="fas fa-lightbulb"></i>
                                    è®¾ç½®è¯´æ˜
                                </div>
                                <div class="tips-content">
                                    â€¢ è§’è‰²é€šè¯å½¢è±¡ï¼šè§†é¢‘é€šè¯æ—¶è§’è‰²æ˜¾ç¤ºçš„å½¢è±¡<br>
                                    â€¢ ç”¨æˆ·é€šè¯å½¢è±¡ï¼šè§†é¢‘é€šè¯æ—¶ä½ æ˜¾ç¤ºçš„å½¢è±¡<br>
                                    â€¢ å¦‚ä¸è®¾ç½®å°†ä½¿ç”¨é»˜è®¤å¤´åƒ
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="hideVideoAvatarModal()">å–æ¶ˆ</button>
                            <button class="btn-primary" onclick="saveVideoAvatarSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
                <div id="export-options-modal" class="modal-overlay" style="display: none;" onclick="hideExportOptions(event)">
                    <div class="modal-content export-options-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>å¯¼å‡ºèŠå¤©è®°å½•</h3>
                            <button class="modal-close-btn" onclick="hideExportOptions()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="export-format-section">
                                <h4>é€‰æ‹©å¯¼å‡ºæ ¼å¼</h4>
                                <div class="export-format-options">
                                    <div class="export-format-option" onclick="selectExportFormat('html')">
                                        <div class="format-icon">
                                            <i class="fas fa-file-code"></i>
                                        </div>
                                        <div class="format-info">
                                            <div class="format-title">HTMLæ ¼å¼</div>
                                            <div class="format-desc">é€‚åˆé˜…è¯»å’Œåˆ†äº«çš„ç½‘é¡µæ ¼å¼</div>
                                        </div>
                                        <div class="format-radio">
                                            <input type="radio" name="exportFormat" value="html" id="format-html" checked>
                                            <label for="format-html"></label>
                                        </div>
                                    </div>
                                    <div class="export-format-option" onclick="selectExportFormat('json')">
                                        <div class="format-icon">
                                            <i class="fas fa-database"></i>
                                        </div>
                                        <div class="format-info">
                                            <div class="format-title">JSONæ ¼å¼</div>
                                            <div class="format-desc">å®Œæ•´æ•°æ®å¤‡ä»½ï¼ŒåŒ…å«èŠå¤©è®°å½•å’Œè®°å¿†ç³»ç»Ÿ</div>
                                        </div>
                                        <div class="format-radio">
                                            <input type="radio" name="exportFormat" value="json" id="format-json">
                                            <label for="format-json"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideExportOptions()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="executeExport()">å¯¼å‡º</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥é€‰é¡¹æ¨¡æ€æ¡† -->
                <div id="import-options-modal" class="modal-overlay" style="display: none;" onclick="hideImportOptions(event)">
                    <div class="modal-content import-options-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>å¯¼å…¥èŠå¤©è®°å½•</h3>
                            <button class="modal-close-btn" onclick="hideImportOptions()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="import-warning">
                                <div class="warning-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="warning-text">
                                    <strong>æ³¨æ„ï¼š</strong>å¯¼å…¥æ“ä½œå°†å®Œå…¨è¦†ç›–å½“å‰è§’è‰²çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
                                    <ul>
                                        <li>èŠå¤©è®°å½•</li>
                                        <li>çŸ­ä¿¡è®°å½•</li>
                                        <li>è®°å¿†ç³»ç»Ÿ</li>
                                    </ul>
                                    æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®ï¼
                                </div>
                            </div>
                            <div class="import-file-section">
                                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFileSelect(event)">
                                <button class="import-file-btn" onclick="document.getElementById('import-file-input').click()">
                                    <i class="fas fa-upload"></i>
                                    é€‰æ‹©JSONæ–‡ä»¶
                                </button>
                                <div class="import-file-info" id="import-file-info" style="display: none;">
                                    <div class="file-name" id="import-file-name"></div>
                                    <div class="file-preview" id="import-file-preview"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideImportOptions()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary modal-danger" onclick="executeImport()" id="import-execute-btn" disabled>å¯¼å…¥å¹¶è¦†ç›–</button>
                        </div>
                    </div>
                </div>

                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                <input type="file" id="character-video-avatar-input" accept="image/*" style="display: none;" onchange="handleCharacterVideoAvatarChange(event)">
                <input type="file" id="user-video-avatar-input" accept="image/*" style="display: none;" onchange="handleUserVideoAvatarChange(event)">

                <!-- å¸–å­è¯¦æƒ…å’Œå›å¤ç•Œé¢ -->
                <div id="post-view-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToForum()">â€¹ </button>
                            <div class="app-title">å¸–å­è¯¦æƒ…</div>
                        <div class="header-actions">
                            <span id="favorite-btn" class="action-btn" onclick="toggleFavoritePost()" title="æ”¶è—">
                                <i class="far fa-star"></i>
                            </span>
                            <span id="share-btn" class="action-btn" onclick="showSharePostModal()" title="åˆ†äº«">
                                <i class="fas fa-share-square"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content" id="post-view-content">
                    </div>
                    <div class="reply-input-area">
                        <button id="anonymous-toggle" class="anonymous-toggle-btn" onclick="toggleAnonymousMode()" title="åŒ¿åå›å¤">
                            <i class="fas fa-user-secret"></i>
                        </button>
                        <input type="text" id="reply-input" placeholder="è¾“å…¥ä½ çš„å›å¤...">
                        <button onclick="sendReply()">å‘é€</button>
                    </div>
                </div>

                <!-- è®ºå›ä¸ªäººä¸»é¡µ/æ”¶è—å¤¹ -->
                <div id="forum-profile-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToCurrentForum()">â€¹</button>
                            <div class="app-title">ä¸ªäººä¸»é¡µ</div>
                        <div class="header-actions">
                            <span class="action-btn multi-select-toggle-btn" onclick="toggleMultiSelectMode()" title="å¤šé€‰åˆ é™¤" id="multi-select-btn">
                                <i class="fas fa-trash"></i>
                            </span>
                            <span class="action-btn" onclick="showVoteHistory()" title="æŠ•ç¥¨å†å²">
                                <i class="fas fa-vote-yea"></i>
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="app-content" style="padding: 0;">
                        <div class="profile-tabs">
                            <div class="profile-tab active" onclick="switchProfileTab('my-posts')">æˆ‘çš„å¸–å­</div>
                            <div class="profile-tab" onclick="switchProfileTab('my-favorites')">æˆ‘çš„æ”¶è—</div>
                        </div>

                        <div id="my-posts-list" class="post-list profile-post-list">
                        </div>
                        <div id="favorite-posts-list" class="post-list profile-post-list" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- ğŸ®ã€æ–°å¢ã€‘äº”å­æ£‹æ¸¸æˆç•Œé¢ -->
                <div id="gomoku-game-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="exitGomokuGame()">â€¹</button>
                        <div class="app-title">äº”å­æ£‹</div>
                        <!-- ğŸ®ã€åˆ é™¤ã€‘æœºå™¨äººæ ‡å¿—å·²ç§»é™¤ -->
                    </div>

                    <!-- ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆå†…å®¹å®¹å™¨ -->
                    <div class="app-content">
                        <!-- æ¸¸æˆåŒºåŸŸ (70%) -->
                        <div class="gomoku-game-area">
                        <div class="gomoku-board-container">
                            <div class="gomoku-board" id="gomoku-board">
                                <!-- æ£‹ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- ğŸ®ã€ä¿®æ”¹ã€‘æ‹†å¼€çš„ç©å®¶ä¿¡æ¯ - AIåœ¨å·¦ä¸‹è§’ -->
                        <div class="gomoku-player-left">
                            <div class="player-avatar" id="ai-player-avatar">
                                <i class="fas fa-robot"></i>
                                <span class="piece-indicator ai-piece"></span>
                            </div>
                            <div class="player-name" id="ai-player-name" style="display: none;">AI</div>
                        </div>

                        <!-- ğŸ®ã€ä¿®æ”¹ã€‘æ‹†å¼€çš„ç©å®¶ä¿¡æ¯ - ç”¨æˆ·åœ¨å³ä¸‹è§’ -->
                        <div class="gomoku-player-right">
                            <div class="player-avatar" id="user-player-avatar">
                                <i class="fas fa-user"></i>
                                <span class="piece-indicator user-piece"></span>
                            </div>
                            <div class="player-name" style="display: none;">ä½ </div>
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ (30%) -->
                    <div class="gomoku-chat-area">
                        <div class="gomoku-chat-header">
                            <div class="chat-header-left">
                                <button class="next-game-main-btn" onclick="startNextGomokuGame()" title="å¼€å§‹ä¸‹ä¸€å±€">
                                    <i class="fas fa-play"></i>
                                    <span>ä¸‹ä¸€å±€</span>
                                </button>
                            </div>
                            <div class="chat-header-center">
                                <!-- AIå¤´åƒåœ¨è®¡æ—¶å™¨å·¦ä¾§ -->
                                <div class="player-avatar" id="ai-player-avatar-header">
                                    <i class="fas fa-robot"></i>
                                    <span class="piece-indicator ai-piece"></span>
                                </div>
                                <div class="game-status" id="gomoku-status">
                                    <div class="current-turn" id="current-turn">ä½ çš„å›åˆ</div>
                                    <div class="game-timer" id="game-timer">00:00</div>
                                </div>
                                <!-- ç”¨æˆ·å¤´åƒåœ¨è®¡æ—¶å™¨å³ä¾§ -->
                                <div class="player-avatar" id="user-player-avatar-header">
                                    <i class="fas fa-user"></i>
                                    <span class="piece-indicator user-piece"></span>
                                </div>
                            </div>
                            <div class="chat-header-right">
                                <div class="chat-actions">
                                    <button class="chat-action-btn undo-btn" onclick="undoGomokuMove()" title="æ‚”æ£‹">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="chat-action-btn surrender-btn" onclick="surrenderGomokuGame()" title="è®¤è¾“">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="gomoku-chat-messages" id="gomoku-chat-messages">
                            <!-- æ¸¸æˆèŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="gomoku-chat-input">
                            <input type="text" id="gomoku-chat-input" placeholder="åœ¨æ¸¸æˆä¸­èŠå¤©..." maxlength="200">
                            <button onclick="sendGameChatMessage()" id="send-game-chat-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <!-- ğŸ®ã€ç»“æŸã€‘æ¸¸æˆå†…å®¹å®¹å™¨ -->
                    </div>
                </div>

                <!-- ğŸ®ã€æ–°å¢ã€‘æµ·é¾Ÿæ±¤æ¸¸æˆç•Œé¢ -->
                <div id="turtle-soup-game-screen" class="app-screen turtle-soup-game-container" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon"><div class="app-battery-level"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="exitTurtleSoupGame()">â€¹</button>
                        <div class="app-title">æµ·é¾Ÿæ±¤</div>
                        <button class="game-settings-button" onclick="showTurtleSoupSettings()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>

                    <!-- æ¸¸æˆåŒºåŸŸ (60%) -->
                    <div class="turtle-soup-game-area">
                        <!-- DMåŒºåŸŸ -->
                        <div class="turtle-soup-dm-section">
                            <div class="turtle-soup-dm-header">
                                <div class="turtle-soup-dm-avatar">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <div>
                                    <div class="turtle-soup-dm-name">æ¸¸æˆä¸»æŒäºº</div>
                                    <div class="turtle-soup-dm-role">(DM)</div>
                                </div>
                            </div>
                            <div class="turtle-soup-dm-message" id="turtle-soup-dm-message">
                                æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆï¼æˆ‘å°†ä¸ºå¤§å®¶ä¸»æŒè¿™åœºæ¨ç†ä¹‹æ—…...
                            </div>
                        </div>

                        <!-- æ±¤é¢å±•ç¤ºåŒºåŸŸ -->
                        <div class="turtle-soup-story-section">
                            <div class="turtle-soup-story-title">ğŸ¢ æ±¤é¢</div>
                            <div class="turtle-soup-story-content" id="turtle-soup-story-content">
                                è¯·ç¨ç­‰ï¼Œæˆ‘æ­£åœ¨ä¸ºä½ å‡†å¤‡ä¸€ä¸ªæœ‰è¶£çš„æ¨ç†æ•…äº‹...
                            </div>
                            <div class="turtle-soup-game-status">
                                <div class="turtle-soup-question-count" id="turtle-soup-question-count">
                                    æé—®æ¬¡æ•°: 0
                                </div>
                                <div class="turtle-soup-game-timer" id="turtle-soup-game-timer">
                                    00:00
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ (40%) -->
                    <div class="turtle-soup-chat-area">
                        <div class="turtle-soup-chat-header">
                            <span class="turtle-soup-chat-title">æ¨ç†è®¨è®º</span>
                            <!-- ğŸ”¥ã€æ–°å¢ã€‘å‘è¨€ç»“æŸæŒ‰é’® -->
                            <button class="finish-speaking-btn" onclick="finishSpeakingAndTriggerDM()" title="å‘è¨€ç»“æŸï¼Œè®©DMå›åº”">
                                <i class="fas fa-check-circle"></i>
                                <span>å‘è¨€ç»“æŸ</span>
                            </button>
                            <div class="turtle-soup-chat-actions">
                                <button class="chat-action-btn hint-btn" onclick="requestTurtleSoupHint()" title="è¯·æ±‚æç¤º">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                                <button class="chat-action-btn give-up-btn" onclick="giveTurtleSoupAnswer()" title="å…¬å¸ƒç­”æ¡ˆ">
                                    <i class="fas fa-flag"></i>
                                </button>
                                <button class="chat-action-btn new-game-btn" onclick="startNewTurtleSoupGame()" title="æ–°æ¸¸æˆ">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="turtle-soup-chat-messages" id="turtle-soup-chat-messages">
                            <!-- æ¨ç†èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="turtle-soup-chat-input">
                            <input type="text" id="turtle-soup-chat-input" placeholder="æå‡ºä½ çš„æ¨ç†é—®é¢˜ï¼ˆåªèƒ½é—®æ˜¯/å¦é—®é¢˜ï¼‰..." maxlength="200">
                            <button onclick="sendTurtleSoupQuestion()" id="send-turtle-soup-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ—¥è®°åŠŸèƒ½ç•Œé¢ - ä»¿çº¿ä¸‹æ¨¡å¼æ ·å¼ -->
                <div id="diary-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥è®°æ¨¡å¼è¦†ç›–å±‚ - ä»¿çº¿ä¸‹æ¨¡å¼ -->
                    <div id="diary-mode-overlay" class="diary-mode-overlay">
                        <div class="diary-mode-header">
                            <button class="back-btn" onclick="backFromDiary()">â€¹</button>
                            <span class="header-title" id="diary-mode-title">ä»Šæ—¥æ—¥è®°</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="switchDiaryTab('past')" id="past-diary-btn" title="è¿‡å¾€æ—¥è®°">
                                    <i class="fas fa-history"></i>
                                </span>
                                <span class="action-btn" onclick="openDiarySettings()" id="diary-settings-btn" title="æ—¥è®°è®¾ç½®">
                                    <i class="fas fa-cog"></i>
                                </span>
                            </div>
                        </div>

                        <div class="diary-mode-content">
                            <!-- ä»Šæ—¥æ—¥è®°å†…å®¹ -->
                            <div id="today-diary-view" class="diary-view active">
                                <div id="today-diary-content" class="diary-paper-background">
                                    <!-- æ—¥è®°å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>

                            <!-- è¿‡å¾€æ—¥è®°åˆ—è¡¨ -->
                            <div id="past-diaries-view" class="diary-view">
                                <div id="past-diaries-list" class="past-diaries-list">
                                    <!-- è¿‡å¾€æ—¥è®°åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>

                            <!-- å•ä¸ªè¿‡å¾€æ—¥è®°å…¨å±æŸ¥çœ‹ -->
                            <div id="single-diary-view" class="diary-view">
                                <div id="single-diary-content" class="diary-paper-background">
                                    <!-- å•ä¸ªæ—¥è®°å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥è®°è®¾ç½®å…¨å±ç•Œé¢ -->
                <div id="diary-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥è®°è®¾ç½®è¦†ç›–å±‚ -->
                    <div id="diary-settings-overlay" class="diary-settings-overlay">
                        <div class="diary-settings-header">
                            <button class="back-btn" onclick="backFromDiarySettings()">â€¹</button>
                            <span class="header-title">æ—¥è®°è®¾ç½®</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="resetDiarySettings()" title="é‡ç½®è®¾ç½®">
                                    <i class="fas fa-undo"></i>
                                </span>
                            </div>
                        </div>

                        <div class="diary-settings-content">
                            <!-- å®æ—¶é¢„è§ˆåŒºåŸŸ -->
                            <div class="settings-preview-section">
                                <h3>é¢„è§ˆæ•ˆæœ</h3>
                                <div class="diary-preview-container">
                                    <div id="diary-preview-content" class="diary-preview-paper">
                                        <div class="preview-text">
                                            2024å¹´8æœˆ2æ—¥ æ˜ŸæœŸäº”ï¼Œå¤©æ°”ï¼šæ™´æœ—

                                            ä»Šå¤©æ˜¯ç¾å¥½çš„ä¸€å¤©ï¼Œé˜³å…‰æ˜åªšã€‚æˆ‘åœ¨è¿™é‡Œå†™ä¸‹æˆ‘çš„å¿ƒæƒ…å’Œæƒ³æ³•ã€‚
                                            <mark>è¿™æ˜¯ä¸€æ®µé‡è¦çš„å†…å®¹</mark>ï¼Œéœ€è¦ç‰¹åˆ«æ ‡è®°ã€‚
                                            <strike>è¿™æ˜¯ä¸€æ®µåæ‚”å†™ä¸‹çš„è¯</strike>ã€‚
                                            å¸Œæœ›æ¯ä¸€å¤©éƒ½èƒ½è®°å½•ä¸‹ç¾å¥½çš„å›å¿†ã€‚
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è®¾ç½®é€‰é¡¹åŒºåŸŸ -->
                            <div class="settings-options-section">
                                <!-- å­—ä½“è®¾ç½® -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-font"></i> å­—ä½“è®¾ç½®</h4>

                                    <!-- ğŸ”¥ã€ç§»é™¤ã€‘å­—ä½“æ—é€‰é¡¹ï¼Œä½¿ç”¨å…¨å±€å­—ä½“è®¾ç½® -->

                                    <div class="setting-item">
                                        <label>å­—ä½“å¤§å°</label>
                                        <div class="slider-container">
                                            <input type="range" id="font-size-slider" min="12" max="24" value="16" onchange="updateDiarySettings()">
                                            <span id="font-size-value">16px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>å­—ä½“ç²—ç»†</label>
                                        <select id="fontWeightSelect" onchange="setFontWeight(this.value)">
                                            <option value="300">ç»†ä½“</option>
                                            <option value="400">æ­£å¸¸</option>
                                            <option value="500" selected>ä¸­ç­‰</option>
                                            <option value="600">åŠç²—</option>
                                            <option value="700">ç²—ä½“</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- æ’ç‰ˆè®¾ç½® -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-align-left"></i> æ’ç‰ˆè®¾ç½®</h4>

                                    <div class="setting-item">
                                        <label>è¡Œè·</label>
                                        <div class="slider-container">
                                            <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.1" value="1.6" onchange="updateDiarySettings()">
                                            <span id="line-height-value">1.6</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>æ®µè½é—´è·</label>
                                        <div class="slider-container">
                                            <input type="range" id="paragraph-spacing-slider" min="0" max="30" value="15" onchange="updateDiarySettings()">
                                            <span id="paragraph-spacing-value">15px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>æ–‡æœ¬å¯¹é½</label>
                                        <select id="textAlignSelect" onchange="setTextAlign(this.value)">
                                            <option value="left" selected>å·¦å¯¹é½</option>
                                            <option value="center">å±…ä¸­</option>
                                            <option value="right">å³å¯¹é½</option>
                                            <option value="justify">ä¸¤ç«¯å¯¹é½</option>
                                        </select>
                                    </div>

                                    <div class="setting-item">
                                        <label>æ–‡æœ¬è£…é¥°</label>
                                        <select id="textDecorationSelect" onchange="setTextDecoration(this.value)">
                                            <option value="none" selected>æ— è£…é¥°</option>
                                            <option value="underline">ä¸‹åˆ’çº¿</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- å†…å®¹å®½åº¦è®¾ç½® -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-arrows-alt-h"></i> å†…å®¹å®½åº¦</h4>

                                    <div class="setting-item">
                                        <label>æ–‡æœ¬å®½åº¦</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-width-slider" min="60" max="100" value="100" onchange="updateDiarySettings()">
                                            <span id="content-width-value">100%</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>å·¦å³è¾¹è·</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-padding-slider" min="10" max="60" value="40" onchange="updateDiarySettings()">
                                            <span id="content-padding-value">40px</span>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label>ä¸Šè¾¹è·</label>
                                        <div class="slider-container">
                                            <input type="range" id="content-top-margin-slider" min="0" max="120" value="20" onchange="updateDiarySettings()">
                                            <span id="content-top-margin-value">20px</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- èƒŒæ™¯çº¸å¼ è®¾ç½® -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-image"></i> èƒŒæ™¯çº¸å¼ </h4>
                                    <div class="paper-options">
                                        <div class="paper-option active" onclick="setDiaryPaper('plain')" data-paper="plain">
                                            <div class="paper-preview plain-paper"></div>
                                            <span>ç™½çº¸</span>
                                        </div>
                                        <div class="paper-option" onclick="setDiaryPaper('vintage')" data-paper="vintage">
                                            <div class="paper-preview vintage-paper"></div>
                                            <span>å¤å¤çº¸</span>
                                        </div>
                                        <div class="paper-option custom-paper" onclick="uploadCustomPaper()">
                                            <div class="paper-preview custom-preview">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <span>è‡ªå®šä¹‰</span>
                                        </div>
                                    </div>
                                    <input type="file" id="paperImageInput" accept="image/*" style="display: none;" onchange="handlePaperUpload(event)">
                                </div>

                                <!-- ç¼–è¾‘åŠŸèƒ½ -->
                                <div class="setting-group">
                                    <h4><i class="fas fa-edit"></i> ç¼–è¾‘åŠŸèƒ½</h4>
                                    <div class="edit-actions">
                                        <button class="btn btn-primary" onclick="editTodayDiary(); backFromDiarySettings();">
                                            <i class="fas fa-pencil-alt"></i> ç¼–è¾‘æ—¥è®°
                                        </button>
                                        <button class="btn btn-secondary" onclick="generateTodayDiary(); backFromDiarySettings();">
                                            <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è®°å¿†è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="memorySettingsModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>è®°å¿†ç³»ç»Ÿè®¾ç½®</h3>
                            <button class="modal-close" onclick="closeMemorySettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-group">
                                <label for="aiExtractInterval">AIè®°å¿†æå–é—´éš”ï¼ˆå›åˆæ•°ï¼‰</label>
                                <input type="number" id="aiExtractInterval" min="10" max="200" step="10" value="30">
                                <small>æ¯å¤šå°‘å›åˆå¯¹è¯è¿›è¡Œä¸€æ¬¡AIè®°å¿†æå–ï¼ˆå»ºè®®20-50å›åˆï¼‰</small>
                            </div>

                            <div class="setting-group">
                                <label for="coreMemoryThreshold">æ ¸å¿ƒè®°å¿†é‡è¦æ€§é˜ˆå€¼</label>
                                <input type="range" id="coreMemoryThreshold" min="0.7" max="1.0" step="0.05" value="0.9">
                                <span id="coreThresholdValue">90%</span>
                                <small>åªæœ‰é‡è¦æ€§è¶…è¿‡æ­¤é˜ˆå€¼çš„è®°å¿†æ‰ä¼šæˆä¸ºæ ¸å¿ƒè®°å¿†</small>
                            </div>

                            <div class="setting-group">
                                <label for="episodicMemoryThreshold">æƒ…æ™¯è®°å¿†é‡è¦æ€§é˜ˆå€¼</label>
                                <input type="range" id="episodicMemoryThreshold" min="0.4" max="0.8" step="0.05" value="0.6">
                                <span id="episodicThresholdValue">60%</span>
                                <small>é‡è¦æ€§åœ¨æ­¤èŒƒå›´å†…çš„è®°å¿†ä¼šæˆä¸ºæƒ…æ™¯è®°å¿†</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeMemorySettings()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveMemorySettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- çº¿ä¸‹é¢„è®¾è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="offline-preset-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>çº¿ä¸‹å‰§æƒ…é¢„è®¾</h3>
                            <button class="modal-close" onclick="closeOfflinePresetSettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- å·²ä¿å­˜çš„é¢„è®¾åˆ—è¡¨ -->
                            <div class="form-group">
                                <label>å·²ä¿å­˜çš„é¢„è®¾</label>
                                <div id="saved-presets-list" class="saved-presets-list">
                                    <!-- é¢„è®¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <!-- æ–°å»º/ç¼–è¾‘é¢„è®¾è¡¨å• -->
                            <div class="form-group">
                                <label for="offline-preset-name">é¢„è®¾åç§°</label>
                                <input type="text" id="offline-preset-name" placeholder="ä¸ºè¿™ä¸ªé¢„è®¾èµ·ä¸ªåå­—..." maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="offline-preset-content">å‰§æƒ…é¢„è®¾å†…å®¹</label>
                                <textarea id="offline-preset-content" rows="6" placeholder="è¯·è¾“å…¥çº¿ä¸‹å‰§æƒ…æ¨¡å¼çš„é¢„è®¾å†…å®¹ï¼Œè¿™å°†å†³å®šAIçš„æ–‡é£ã€å­—æ•°ã€è§†è§’ç­‰...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- ä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°&#10;- æ¯æ¬¡å›å¤200-400å­—&#10;- æ³¨é‡ç¯å¢ƒæå†™å’Œå¿ƒç†æ´»åŠ¨&#10;- è¥é€ æµªæ¼«/æ‚¬ç–‘/å†’é™©ç­‰æ°›å›´"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é¢„è®¾è¯´æ˜</label>
                                <div class="preset-help-text">
                                    <p>â€¢ é¢„è®¾å†…å®¹å°†ä½œä¸ºAIå›å¤çš„é‡è¦æŒ‡å¯¼</p>
                                    <p>â€¢ å¯ä»¥æŒ‡å®šæ–‡é£ã€å­—æ•°ã€è§†è§’ã€æ°›å›´ç­‰</p>
                                    <p>â€¢ æ”¯æŒæƒ…æ™¯æå†™ã€åŠ¨ä½œæå†™ã€å¿ƒç†æå†™</p>
                                    <p>â€¢ é¢„è®¾æƒé‡å¾ˆé«˜ï¼Œä¼šæ˜¾è‘—å½±å“AIçš„å›å¤é£æ ¼</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflinePresetSettings()">å–æ¶ˆ</button>
                            <button class="btn btn-secondary" onclick="clearPresetForm()">æ¸…ç©ºè¡¨å•</button>
                            <button class="btn btn-primary" onclick="saveOfflinePreset()">ä¿å­˜é¢„è®¾</button>
                        </div>
                    </div>
                </div>

                <!-- çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•æ¨¡æ€æ¡† -->
                <div id="offline-history-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•</h3>
                            <button class="modal-close" onclick="closeOfflineHistoryModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="offline-history-list" class="offline-history-list">
                                <!-- èŠå¤©è®°å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflineHistoryModal()">å…³é—­</button>
                            <button class="btn btn-danger" onclick="clearAllOfflineHistory()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
                        </div>
                    </div>
                </div>

                <!-- çºªå¿µæ—¥è¡¨å•æ¨¡æ€æ¡† -->
                <div id="anniversary-form-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="anniversary-form-title">æ·»åŠ çºªå¿µæ—¥</h3>
                            <button class="modal-close" onclick="closeAnniversaryForm()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="anniversary-name">çºªå¿µæ—¥åç§°</label>
                                <input type="text" id="anniversary-name" placeholder="ä¾‹å¦‚ï¼šå°é›ªçš„ç”Ÿæ—¥" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-date">æ—¥æœŸ</label>
                                <input type="date" id="anniversary-date">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-type">ç±»å‹</label>
                                <select id="anniversary-type" onchange="toggleCustomTypeInput('anniversary')">
                                    <option value="birthday">ç”Ÿæ—¥</option>
                                    <option value="relationship">ç¡®å®šå…³ç³»</option>
                                    <option value="anniversary">çºªå¿µæ—¥</option>
                                    <option value="holiday">èŠ‚æ—¥</option>
                                    <option value="family">å®¶äººç”Ÿæ—¥</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group" id="anniversary-custom-type-group" style="display: none;">
                                <label for="anniversary-custom-type">è‡ªå®šä¹‰ç±»å‹</label>
                                <input type="text" id="anniversary-custom-type" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹..." maxlength="20">
                            </div>
                            <div class="form-group">
                                <label for="anniversary-character">ç›¸å…³è§’è‰²</label>
                                <select id="anniversary-character" onchange="toggleCharacterQuoteGroup('anniversary', this.value)">
                                    <option value="">é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea id="anniversary-description" rows="3" placeholder="æ·»åŠ ä¸€äº›å¤‡æ³¨..." maxlength="200"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-user-quote">æˆ‘çš„è¯­å½•</label>
                                <textarea id="anniversary-user-quote" rows="2" placeholder="ä½ å¯¹è¿™ä¸ªçºªå¿µæ—¥çš„æ„Ÿæƒ³..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group" id="anniversary-character-quote-group" style="display: none;">
                                <label for="anniversary-character-quote" id="anniversary-quote-label">è§’è‰²è¯­å½•</label>
                                <textarea id="anniversary-character-quote" rows="2" placeholder="è§’è‰²å¯¹è¿™ä¸ªçºªå¿µæ—¥çš„æ„Ÿæƒ³..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="anniversary-count-type">å¤©æ•°è®¡ç®—æ–¹å¼</label>
                                <select id="anniversary-count-type">
                                    <option value="countdown">å€’æ•°</option>
                                    <option value="countup">æ­£æ•°</option>
                                </select>
                                <small class="form-hint">é€‰æ‹©æ˜¾ç¤º"è¿˜æœ‰Xå¤©"è¿˜æ˜¯"å·²ç»Xå¤©"</small>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-yearly" checked>
                                    æ¯å¹´é‡å¤
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-shared">
                                    ä¸è§’è‰²å…±äº«ï¼ˆè§’è‰²ä¹Ÿèƒ½çœ‹åˆ°è¿™ä¸ªçºªå¿µæ—¥ï¼‰
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="anniversary-pinned">
                                    ç½®é¡¶æ˜¾ç¤ºï¼ˆåœ¨çºªå¿µæ—¥åˆ—è¡¨é¡¶éƒ¨å¤§å¡ç‰‡æ˜¾ç¤ºï¼‰
                                </label>
                            </div>
                            <div class="form-group" id="anniversary-background-group">
                                <label for="anniversary-background-upload">èƒŒæ™¯å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="file" id="anniversary-background-upload" accept="image/*" onchange="handleAnniversaryBackgroundUpload(this)">
                                <small class="form-hint">ç”¨äºç½®é¡¶æ˜¾ç¤ºå’Œä¸»å±å¹•å°ç»„ä»¶èƒŒæ™¯</small>
                                <div id="anniversary-background-preview" class="background-preview" style="display: none;">
                                    <img id="anniversary-background-img" src="" alt="èƒŒæ™¯é¢„è§ˆ">
                                    <button type="button" class="remove-background-btn" onclick="removeAnniversaryBackground()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" id="anniversary-user-avatar-group">
                                <label for="anniversary-user-avatar-upload">ä½ çš„å¤´åƒï¼ˆå¯é€‰ï¼‰</label>
                                <input type="file" id="anniversary-user-avatar-upload" accept="image/*" onchange="handleAnniversaryUserAvatarUpload(this)">
                                <small class="form-hint">ç”¨äºç½®é¡¶æ˜¾ç¤ºæ—¶æ˜¾ç¤ºä½ çš„èº«ä»½</small>
                                <div id="anniversary-user-avatar-preview" class="avatar-preview" style="display: none;">
                                    <img id="anniversary-user-avatar-img" src="" alt="å¤´åƒé¢„è§ˆ">
                                    <button type="button" class="remove-avatar-btn" onclick="removeAnniversaryUserAvatar()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAnniversaryForm()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveAnniversary()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- çº¦å®šè¡¨å•æ¨¡æ€æ¡† -->
                <div id="appointment-form-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="appointment-form-title">æ·»åŠ çº¦å®š</h3>
                            <button class="modal-close" onclick="closeAppointmentForm()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="appointment-name">çº¦å®šåç§°</label>
                                <input type="text" id="appointment-name" placeholder="ä¾‹å¦‚ï¼šå’Œå°é›ªå»çœ‹ç”µå½±" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="appointment-date">æ—¥æœŸ</label>
                                <input type="date" id="appointment-date">
                            </div>
                            <div class="form-group">
                                <label for="appointment-time">æ—¶é—´</label>
                                <input type="time" id="appointment-time">
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-never-expires" onchange="toggleNeverExpires('appointment')">
                                    æ°¸ä¸è¿‡æœŸ
                                </label>
                                <small class="form-hint">å‹¾é€‰åï¼Œæ­¤çº¦å®šå°†ä¸ä¼šæ˜¾ç¤ºå‰©ä½™å¤©æ•°ï¼Œé€‚åˆé•¿æœŸæ‰¿è¯º</small>
                            </div>
                            <div class="form-group">
                                <label for="appointment-type">ç±»å‹</label>
                                <select id="appointment-type" onchange="toggleCustomTypeInput('appointment')">
                                    <option value="date">çº¦ä¼š</option>
                                    <option value="promise">æ‰¿è¯º</option>
                                    <option value="activity">æ´»åŠ¨</option>
                                    <option value="meeting">è§é¢</option>
                                    <option value="task">ä»»åŠ¡</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group" id="appointment-custom-type-group" style="display: none;">
                                <label for="appointment-custom-type">è‡ªå®šä¹‰ç±»å‹</label>
                                <input type="text" id="appointment-custom-type" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹..." maxlength="20">
                            </div>
                            <div class="form-group">
                                <label for="appointment-character">ç›¸å…³è§’è‰²</label>
                                <select id="appointment-character" onchange="toggleCharacterQuoteGroup('appointment', this.value)">
                                    <option value="">é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="appointment-priority">é‡è¦ç¨‹åº¦</label>
                                <select id="appointment-priority">
                                    <option value="low">ä¸€èˆ¬</option>
                                    <option value="medium" selected>é‡è¦</option>
                                    <option value="high">å¾ˆé‡è¦</option>
                                    <option value="urgent">éå¸¸é‡è¦</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="appointment-description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea id="appointment-description" rows="3" placeholder="æ·»åŠ ä¸€äº›å¤‡æ³¨..." maxlength="200"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="appointment-user-quote">æˆ‘çš„è¯­å½•</label>
                                <textarea id="appointment-user-quote" rows="2" placeholder="ä½ å¯¹è¿™ä¸ªçº¦å®šçš„æ„Ÿæƒ³..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group" id="appointment-character-quote-group" style="display: none;">
                                <label for="appointment-character-quote" id="appointment-quote-label">è§’è‰²è¯­å½•</label>
                                <textarea id="appointment-character-quote" rows="2" placeholder="è§’è‰²å¯¹è¿™ä¸ªçº¦å®šçš„æ„Ÿæƒ³..." maxlength="150"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="appointment-count-type">å¤©æ•°è®¡ç®—æ–¹å¼</label>
                                <select id="appointment-count-type">
                                    <option value="countdown">å€’æ•°</option>
                                    <option value="countup">æ­£æ•°</option>
                                </select>
                                <small class="form-hint">é€‰æ‹©æ˜¾ç¤º"è¿˜æœ‰Xå¤©"è¿˜æ˜¯"å·²ç»Xå¤©"</small>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-shared">
                                    ä¸è§’è‰²å…±äº«ï¼ˆè§’è‰²ä¹Ÿèƒ½çœ‹åˆ°è¿™ä¸ªçº¦å®šï¼‰
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="appointment-pinned">
                                    ç½®é¡¶æ˜¾ç¤ºï¼ˆåœ¨çº¦å®šåˆ—è¡¨é¡¶éƒ¨å¤§å¡ç‰‡æ˜¾ç¤ºï¼‰
                                </label>
                            </div>
                            <div class="form-group" id="appointment-background-group">
                                <label for="appointment-background-upload">èƒŒæ™¯å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="file" id="appointment-background-upload" accept="image/*" onchange="handleAppointmentBackgroundUpload(this)">
                                <small class="form-hint">ç”¨äºç½®é¡¶æ˜¾ç¤ºèƒŒæ™¯</small>
                                <div id="appointment-background-preview" class="background-preview" style="display: none;">
                                    <img id="appointment-background-img" src="" alt="èƒŒæ™¯é¢„è§ˆ">
                                    <button type="button" class="remove-background-btn" onclick="removeAppointmentBackground()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" id="appointment-user-avatar-group">
                                <label for="appointment-user-avatar-upload">ä½ çš„å¤´åƒï¼ˆå¯é€‰ï¼‰</label>
                                <input type="file" id="appointment-user-avatar-upload" accept="image/*" onchange="handleAppointmentUserAvatarUpload(this)">
                                <small class="form-hint">ç”¨äºç½®é¡¶æ˜¾ç¤ºæ—¶æ˜¾ç¤ºä½ çš„èº«ä»½</small>
                                <div id="appointment-user-avatar-preview" class="avatar-preview" style="display: none;">
                                    <img id="appointment-user-avatar-img" src="" alt="å¤´åƒé¢„è§ˆ">
                                    <button type="button" class="remove-avatar-btn" onclick="removeAppointmentUserAvatar()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAppointmentForm()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveAppointment()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡å°ç»„ä»¶è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="photo-widget-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>å›¾ç‰‡å°ç»„ä»¶</h3>
                            <button class="modal-close" onclick="closePhotoWidgetModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="widget-photo-upload">é€‰æ‹©å›¾ç‰‡</label>
                                <input type="file" id="widget-photo-upload" accept="image/*" onchange="handlePhotoWidgetUpload(this)">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearPhotoWidget()">æ¸…é™¤å›¾ç‰‡</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closePhotoWidgetModal()">å…³é—­</button>
                        </div>
                    </div>
                </div>

                <!-- çºªå¿µæ—¥å°ç»„ä»¶è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="anniversary-widget-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>çºªå¿µæ—¥å°ç»„ä»¶</h3>
                            <button class="modal-close" onclick="closeAnniversaryWidgetModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="widget-anniversary-select">é€‰æ‹©è¦æ˜¾ç¤ºçš„çºªå¿µæ—¥</label>
                                <select id="widget-anniversary-select" onchange="updateAnniversaryWidget()">
                                    <option value="">è¯·é€‰æ‹©çºªå¿µæ—¥</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearAnniversaryWidget()">æ¸…é™¤æ˜¾ç¤º</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAnniversaryWidgetModal()">å…³é—­</button>
                        </div>
                    </div>
                </div>

                <!-- çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®æ¨¡æ€æ¡† -->
                <div id="offline-ui-settings-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®</h3>
                            <button class="modal-close" onclick="closeOfflineUISettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- æ°”æ³¡é¢œè‰²è®¾ç½® -->
                            <div class="form-group">
                                <label>æ°”æ³¡é¢œè‰²è®¾ç½®</label>
                                <div class="color-setting-group">
                                    <div class="color-picker-container">
                                        <div class="flex-gap-15">
                                            <div class="flex-1">
                                                <label class="label-small">æˆ‘çš„æ°”æ³¡</label>
                                                <input type="color" id="offline-my-bubble-color" class="color-input" value="#007AFF">
                                            </div>
                                            <div class="flex-1">
                                                <label class="label-small">è§’è‰²æ°”æ³¡</label>
                                                <input type="color" id="offline-ai-bubble-color" class="color-input" value="#f0f0f0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- é€æ˜åº¦è®¾ç½® -->
                            <div class="form-group">
                                <label>æ°”æ³¡é€æ˜åº¦</label>
                                <div class="opacity-setting">
                                    <input type="range" id="offline-bubble-opacity" class="theme-range" min="0" max="1" step="0.01" value="0.9">
                                    <span id="offline-opacity-value">90%</span>
                                </div>
                            </div>



                            <!-- ğŸ”¥ã€æ–°å¢ã€‘å­—ä½“å¤§å°è®¾ç½® -->
                            <div class="form-group">
                                <label>å­—ä½“å¤§å°</label>
                                <div class="opacity-setting">
                                    <input type="range" id="offline-font-size" class="theme-range" min="12" max="24" step="1" value="15">
                                    <span id="offline-font-size-value">15px</span>
                                </div>
                            </div>

                            <!-- å£çº¸è®¾ç½® -->
                            <div class="form-group">
                                <label>èƒŒæ™¯å£çº¸</label>
                                <div class="wallpaper-setting">
                                    <input type="file" id="offline-wallpaper-file" accept="image/*" class="form-input" onchange="handleOfflineWallpaperUpload(this)">
                                    <button type="button" class="theme-button theme-button-secondary" onclick="clearOfflineWallpaper()">æ¸…é™¤</button>
                                </div>
                            </div>

                            <!-- å­—ä½“è®¾ç½® -->
                            <div class="form-group">
                                <label>å­—ä½“è®¾ç½®</label>
                                <div class="font-setting">
                                    <select id="offline-font-select" class="form-input" onchange="handleOfflineFontChange()">
                                        <option value="">ç³»ç»Ÿé»˜è®¤å­—ä½“</option>
                                        <option value="custom">è‡ªå®šä¹‰å­—ä½“URL...</option>
                                    </select>
                                    <div id="custom-font-input" style="display: none; margin-top: 10px;">
                                        <input type="url" id="offline-font-url" placeholder="ä¾‹å¦‚ï¼šhttps://fonts.googleapis.com/css2?family=Noto+Sans+SC æˆ–ç›´æ¥å­—ä½“æ–‡ä»¶URL" class="form-input">
                                        <button type="button" class="theme-button theme-button-secondary" onclick="previewOfflineFont()">é¢„è§ˆ</button>
                                    </div>
                                </div>
                            </div>

                            <!-- æ–‡å­—é¢œè‰²è®¾ç½® -->
                            <div class="form-group">
                                <label>æ–‡å­—é¢œè‰²è®¾ç½®</label>
                                <div class="text-color-setting">
                                    <!-- ç”¨æˆ·æ¶ˆæ¯æ–‡å­—é¢œè‰² -->
                                    <div class="color-section">
                                        <label class="section-label">ç”¨æˆ·æ¶ˆæ¯æ–‡å­—é¢œè‰²</label>
                                        <div class="color-picker-container">
                                            <div class="flex-gap-15">
                                                <div class="flex-1">
                                                    <label class="label-small">æ™®é€šæ–‡å­—</label>
                                                    <input type="color" id="offline-user-normal-text-color" class="color-input" value="#ffffff">
                                                    <div class="saved-colors" id="offline-user-normal-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">æ–œä½“æ–‡å­—</label>
                                                    <input type="color" id="offline-user-italic-text-color" class="color-input" value="#f0f0f0">
                                                    <div class="saved-colors" id="offline-user-italic-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">åŠ ç²—æ–‡å­—</label>
                                                    <input type="color" id="offline-user-bold-text-color" class="color-input" value="#ffffff">
                                                    <div class="saved-colors" id="offline-user-bold-saved-colors"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- è§’è‰²æ¶ˆæ¯æ–‡å­—é¢œè‰² -->
                                    <div class="color-section">
                                        <label class="section-label">è§’è‰²æ¶ˆæ¯æ–‡å­—é¢œè‰²</label>
                                        <div class="color-picker-container">
                                            <div class="flex-gap-15">
                                                <div class="flex-1">
                                                    <label class="label-small">æ™®é€šæ–‡å­—</label>
                                                    <input type="color" id="offline-ai-normal-text-color" class="color-input" value="#000000">
                                                    <div class="saved-colors" id="offline-ai-normal-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">æ–œä½“æ–‡å­—</label>
                                                    <input type="color" id="offline-ai-italic-text-color" class="color-input" value="#666666">
                                                    <div class="saved-colors" id="offline-ai-italic-saved-colors"></div>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="label-small">åŠ ç²—æ–‡å­—</label>
                                                    <input type="color" id="offline-ai-bold-text-color" class="color-input" value="#333333">
                                                    <div class="saved-colors" id="offline-ai-bold-saved-colors"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- é¢„å­˜é¢œè‰²åŠŸèƒ½ -->
                            <div class="form-group">
                                <label>é¢œè‰²ç®¡ç†</label>
                                <div class="color-management">
                                    <button type="button" class="theme-button theme-button-secondary" onclick="saveCurrentOfflineColors()">ä¿å­˜å½“å‰é¢œè‰²</button>
                                    <button type="button" class="theme-button theme-button-secondary" onclick="resetOfflineColors()">é‡ç½®ä¸ºé»˜è®¤</button>
                                </div>
                            </div>

                            <!-- å¤´åƒè®¾ç½® -->
                            <div class="form-group">
                                <label>å¤´åƒè®¾ç½®</label>
                                <div class="avatar-setting">
                                    <div class="setting-row">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="offline-show-user-avatar" checked>
                                            æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="offline-show-ai-avatar" checked>
                                            æ˜¾ç¤ºè§’è‰²å¤´åƒ
                                        </label>
                                    </div>
                                    <div class="setting-row">
                                        <label class="radio-label">å¤´åƒä½ç½®ï¼š</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectAvatarPosition('side', this)">
                                                <div class="radio-indicator"></div>
                                                ä¾§è¾¹æ˜¾ç¤º
                                            </div>
                                            <div class="radio-option-button" onclick="selectAvatarPosition('custom', this)">
                                                <div class="radio-indicator"></div>
                                                è‡ªå®šä¹‰CSSæ§åˆ¶
                                            </div>
                                            <input type="radio" name="offline-avatar-position" value="side" checked style="display: none;">
                                            <input type="radio" name="offline-avatar-position" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ°”æ³¡æ ·å¼è®¾ç½® -->
                            <div class="form-group">
                                <label>æ°”æ³¡æ ·å¼è®¾ç½®</label>
                                <div class="bubble-style-setting">
                                    <div class="setting-row">
                                        <label class="radio-label">æ°”æ³¡å®½åº¦ï¼š</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectBubbleWidth('default', this)">
                                                <div class="radio-indicator"></div>
                                                æ™ºèƒ½å®½åº¦
                                            </div>
                                            <div class="radio-option-button" onclick="selectBubbleWidth('custom', this)">
                                                <div class="radio-indicator"></div>
                                                è‡ªå®šä¹‰CSSæ§åˆ¶
                                            </div>
                                            <input type="radio" name="offline-bubble-width" value="default" checked style="display: none;">
                                            <input type="radio" name="offline-bubble-width" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <label class="radio-label">æ°”æ³¡æ ·å¼ï¼š</label>
                                        <div class="radio-options">
                                            <div class="radio-option-button selected" onclick="selectBubbleStyle('default', this)">
                                                <div class="radio-indicator"></div>
                                                é»˜è®¤æ ·å¼
                                            </div>
                                            <div class="radio-option-button" onclick="selectBubbleStyle('custom', this)">
                                                <div class="radio-indicator"></div>
                                                è‡ªå®šä¹‰CSSæ§åˆ¶
                                            </div>
                                            <input type="radio" name="offline-bubble-style" value="default" checked style="display: none;">
                                            <input type="radio" name="offline-bubble-style" value="custom" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è‡ªå®šä¹‰CSSè®¾ç½® -->
                            <div class="form-group">
                                <label>è‡ªå®šä¹‰CSSä»£ç </label>
                                <div class="custom-css-setting">
                                    <textarea id="offline-custom-css" rows="8" class="form-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥è‡ªå®šä¹‰CSSä»£ç æ¥æ§åˆ¶å¤´åƒä½ç½®ã€æ°”æ³¡æ ·å¼ã€æ°”æ³¡å¤§å°ç­‰...&#10;&#10;ç¤ºä¾‹ï¼š&#10;/* è°ƒæ•´æ°”æ³¡å®½åº¦ */&#10;.offline-message-content {&#10;    max-width: 70% !important;&#10;}&#10;&#10;/* è°ƒæ•´å¤´åƒä½ç½® */&#10;.offline-avatar {&#10;    position: absolute;&#10;    top: -10px;&#10;    right: -10px;&#10;}"></textarea>
                                    <div class="css-buttons">
                                        <button type="button" class="theme-button theme-button-secondary" onclick="previewOfflineCSS()">é¢„è§ˆCSS</button>
                                        <button type="button" class="theme-button theme-button-secondary" onclick="clearOfflineCSS()">æ¸…é™¤CSS</button>
                                    </div>
                                </div>
                            </div>

                            <!-- é¢„è§ˆåŒºåŸŸ -->
                            <div class="form-group">
                                <label>æ•ˆæœé¢„è§ˆ</label>
                                <div class="offline-preview-area" id="offline-preview-area">
                                    <div class="offline-preview-message user">
                                        <div class="offline-avatar user-avatar" id="preview-user-avatar">ğŸ‘¤</div>
                                        <div class="offline-preview-content">
                                            è¿™æ˜¯ç”¨æˆ·æ¶ˆæ¯çš„é¢„è§ˆæ•ˆæœï¼ŒåŒ…å«<em>æ–œä½“æ–‡å­—</em>å’Œ<strong>åŠ ç²—æ–‡å­—</strong>
                                        </div>
                                    </div>
                                    <div class="offline-preview-message ai">
                                        <div class="offline-avatar ai-avatar" id="preview-ai-avatar">ğŸ¤–</div>
                                        <div class="offline-preview-content">
                                            è¿™æ˜¯è§’è‰²å›å¤çš„é¢„è§ˆæ•ˆæœï¼ŒåŒ…å«<em>æ–œä½“æ–‡å­—</em>å’Œ<strong>åŠ ç²—æ–‡å­—</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeOfflineUISettings()">å–æ¶ˆ</button>
                            <button class="btn btn-secondary" onclick="resetOfflineUISettings()">é‡ç½®</button>
                            <button class="btn btn-primary" onclick="saveOfflineUISettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>





                <!-- è®°å¿†æŸ¥çœ‹å™¨ç•Œé¢ -->
                <div id="memory-viewer-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('memory-viewer-screen')">â€¹</button>

                            <div class="app-title">è®°å¿†æŸ¥çœ‹å™¨</div>
                        <div class="header-actions">
                            <!-- å³ä¾§æ”¾3ä¸ªæŒ‰é’®ï¼šè®¾ç½®ã€åˆ·æ–°ã€æ¸…ç†é”™è¯¯è®°å½• -->
                            <button class="header-action-btn" onclick="showMemorySettings()" title="è®°å¿†è®¾ç½®">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="header-action-btn" onclick="refreshMemoryData()" title="åˆ·æ–°">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="header-action-btn" onclick="cleanupIncorrectRecords()" title="æ¸…ç†é”™è¯¯è®°å½•">
                                <i class="fas fa-tools"></i>
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="app-content">
                        <!-- è§’è‰²é€‰æ‹©å™¨ -->
                        <div class="memory-character-selector">
                            <label for="memory-character-select">é€‰æ‹©è§’è‰²ï¼š</label>
                            <select id="memory-character-select" onchange="loadCharacterMemories()">
                                <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                            </select>
                        </div>

                        <!-- æœç´¢å’Œè¿‡æ»¤ -->
                        <div class="memory-search-section">
                            <div class="memory-search-bar">
                                <input type="text" id="memory-search-input" placeholder="æœç´¢è®°å¿†å†…å®¹..." oninput="filterMemories()">
                                <button class="search-btn" onclick="filterMemories()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="memory-filter-tabs">
                                <button class="memory-filter-tab active" data-type="all" onclick="switchMemoryFilter('all')">å…¨éƒ¨</button>
                                <button class="memory-filter-tab" data-type="core" onclick="switchMemoryFilter('core')">æ ¸å¿ƒè®°å¿†</button>
                                <button class="memory-filter-tab" data-type="episodic" onclick="switchMemoryFilter('episodic')">æƒ…æ™¯è®°å¿†</button>
                                <button class="memory-filter-tab" data-type="storyline" onclick="switchMemoryFilter('storyline')">å‰§æƒ…æ€»ç»“</button>
                                <button class="memory-filter-tab" data-type="timeline" onclick="switchMemoryFilter('timeline')">æ—¶é—´çº¿</button>
                            </div>
                        </div>

                        <!-- è®°å¿†å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="memory-content-area">
                            <div id="memory-list" class="memory-list">
                                <div class="memory-empty-state">
                                    <i class="fas fa-brain"></i>
                                    <p>è¯·é€‰æ‹©è§’è‰²æŸ¥çœ‹è®°å¿†</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸–ç•Œä¹¦ç¼–è¾‘è¡¨å• -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">â€¹</button>
                        <div class="app-title" id="worldbook-form-title">æ–°å»ºä¸–ç•Œä¹¦</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">ä¿å­˜</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">æ ‡é¢˜</label>
                                <input type="text" id="worldbook-title" class="form-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦æ ‡é¢˜">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å†…å®¹</label>
                                <textarea id="worldbook-content" class="form-textarea textarea-large" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦å†…å®¹ï¼Œè¿™é‡Œå¯ä»¥æè¿°è§’è‰²èƒŒæ™¯ã€ä¸–ç•Œè§‚è®¾å®šç­‰..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- èŠå¤©è®¾ç½®ç•Œé¢ -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">â€¹</button>
                        <div class="app-title">èŠå¤©è®¾ç½®</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">

                            <!-- ç¾¤èŠä¸“ç”¨è®¾ç½® - ä»¿QQ/å¾®ä¿¡ç¾¤èŠç•Œé¢ -->
                            <div class="settings-section" id="group-chat-settings" style="display: none;">
                                <!-- ç¾¤èŠä¿¡æ¯å¡ç‰‡ -->
                                <div class="group-info-card">
                                    <div class="group-avatar-section" onclick="changeGroupAvatar()">
                                        <img id="group-avatar-preview" src="" class="group-avatar-large" alt="ç¾¤å¤´åƒ">
                                        <div class="group-avatar-edit-hint">ç‚¹å‡»ä¿®æ”¹</div>
                                    </div>
                                    <div class="group-basic-info">
                                        <div class="group-name" onclick="changeGroupName()" id="group-name-display">ç¾¤èŠåç§°</div>
                                        <div class="group-member-count" id="group-member-count-display">0åæˆå‘˜</div>
                                        <div class="group-description" onclick="editGroupDescription()" id="group-description-display">ç¾¤å…¬å‘Šï¼šç‚¹å‡»è®¾ç½®ç¾¤å…¬å‘Š</div>
                                    </div>
                                </div>

                                <!-- ç¾¤æˆå‘˜å±•ç¤ºåŒºåŸŸ -->
                                <div class="group-members-section">
                                    <div class="section-title">ç¾¤æˆå‘˜</div>
                                    <div class="group-members-grid" id="group-members-grid">
                                        <!-- ç¾¤æˆå‘˜å¤´åƒå°†åŠ¨æ€ç”Ÿæˆ -->
                                        <div class="member-item add-member" onclick="addGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <div class="member-name">é‚€è¯·</div>
                                        </div>
                                        <div class="member-item remove-member" onclick="removeGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-minus"></i>
                                            </div>
                                            <div class="member-name">ç§»é™¤</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç¾¤åŠŸèƒ½è®¾ç½® -->
                                <div class="setting-card">
                                    <div class="setting-item" onclick="changeMyGroupNickname()">
                                        <div class="setting-left">
                                            <div class="setting-label">æˆ‘åœ¨æœ¬ç¾¤çš„æ˜µç§°</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-my-group-nickname">æœªé€‰æ‹©</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showGroupNotice()">
                                        <div class="setting-left">
                                            <div class="setting-label">ç¾¤å…¬å‘Š</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value">æŸ¥çœ‹è¯¦æƒ…</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>


                            </div>

                            <!-- èŠå¤©çª—å£è®¾ç½® -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">èŠå¤©çª—å£è®¾ç½®</span>
                                </div>
                                <div class="setting-card">
                                    <!-- èº«ä»½é€‰æ‹©åŠŸèƒ½å·²ç§»é™¤ï¼Œèº«ä»½åœ¨åˆ›å»ºå¯¹è¯æ—¶é€‰æ‹© -->
                                    <!-- å•èŠæ—¶æ˜¾ç¤ºåŒæ–¹è®¾ç½®ï¼Œç¾¤èŠæ—¶éšè— -->
                                    <div class="setting-item single-chat-only" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">åŒæ–¹å¤´åƒè®¾ç½®</div>
                                            <div class="setting-desc">è®¾ç½®åœ¨æ­¤èŠå¤©çª—å£ä¸­æ˜¾ç¤ºçš„å¤´åƒ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">åŒæ–¹å¤‡æ³¨è®¾ç½®</div>
                                            <div class="setting-desc">è®¾ç½®åœ¨æ­¤èŠå¤©çª—å£ä¸­æ˜¾ç¤ºçš„æ˜µç§°</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">èŠå¤©èƒŒæ™¯è®¾ç½®</div>
                                            <div class="setting-desc">è‡ªå®šä¹‰èŠå¤©ç•Œé¢çš„èƒŒæ™¯å›¾ç‰‡</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">æ°”æ³¡æ ·å¼è®¾ç½®</div>
                                            <div class="setting-desc">é€‰æ‹©æ°”æ³¡å¤–è§‚æ ·å¼å’Œé¢œè‰²</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">é»˜è®¤æ ·å¼</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only">
                                        <div class="setting-left">
                                            <div class="setting-label">æ˜¾ç¤ºè§’è‰²çŠ¶æ€</div>
                                            <div class="setting-desc">åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºè§’è‰²çš„åœ¨çº¿çŠ¶æ€å’Œæ´»åŠ¨</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="character-status-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- ğŸ”¥ã€æ–°å¢ã€‘çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½® -->
                                    <div class="setting-item single-chat-only" id="status-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                            <div class="setting-label">çŠ¶æ€æ›´æ–°é¢‘ç‡</div>
                                            <div class="setting-desc">æ§åˆ¶è§’è‰²çŠ¶æ€çš„æ£€æŸ¥å’Œæ›´æ–°é¢‘ç‡</div>
                                        </div>
                                        <div class="setting-right">
                                            <select class="setting-select" id="status-update-frequency">
                                                <option value="high">é«˜é¢‘ (30ç§’)</option>
                                                <option value="medium-high">ä¸­é«˜é¢‘ (1åˆ†é’Ÿ)</option>
                                                <option value="medium">ä¸­é¢‘ (3åˆ†é’Ÿ)</option>
                                                <option value="medium-low">ä¸­ä½é¢‘ (5åˆ†é’Ÿ)</option>
                                                <option value="low">ä½é¢‘ (10åˆ†é’Ÿ)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æˆ³ä¸€æˆ³åŠŸèƒ½è®¾ç½® - å•èŠç‰¹æœ‰ -->
                            <div class="settings-section" id="poke-settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">æˆ³ä¸€æˆ³åŠŸèƒ½</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">æˆ³ä¸€æˆ³åç¼€è®¾ç½®</div>
                                            <div class="setting-desc">è‡ªå®šä¹‰åŒæ–¹çš„æˆ³ä¸€æˆ³åŠ¨ä½œåç¼€</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è®°å¿†è®¾ç½® -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">è®°å¿†è®¾ç½®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">é™„å¸¦å†å²æ¶ˆæ¯æ•°</div>
                                            <div class="setting-desc">è‡ªå®šä¹‰è§’è‰²å›å¤æ—¶å‚è€ƒçš„å†å²å¯¹è¯æ•°é‡</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5å›åˆ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                    <div class="setting-item" onclick="showGlobalMemorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">å…¨å±€è®°å¿†ç³»ç»Ÿ</div>
                                            <div class="setting-desc">æ™ºèƒ½è®°å¿†ç®¡ç†ï¼Œè®©è§’è‰²è®°ä½é‡è¦çš„èŠå¤©å†…å®¹</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="global-memory-status">7å¤©è®°å¿†</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showMemoryShareSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ä¸ç¾¤èŠå…±äº«è®°å¿†</div>
                                            <div class="setting-desc">è®©è§’è‰²åœ¨å•èŠä¸­è®°ä½ç¾¤èŠçš„å†…å®¹</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="memory-share-status">å·²å…³é—­</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">æŒ‚è½½ä¸–ç•Œä¹¦</div>
                                            <div class="setting-desc">è®©è§’è‰²å‚è€ƒé€‰å®šçš„ä¸–ç•Œä¹¦å†…å®¹ä½œä¸ºèƒŒæ™¯çŸ¥è¯†</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">æœªæŒ‚è½½</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showEmojiLibraryMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">æŒ‚è½½è¡¨æƒ…åŒ…åº“</div>
                                            <div class="setting-desc">é€‰æ‹©åœ¨æ­¤èŠå¤©ä¸­å¯ä½¿ç”¨çš„è¡¨æƒ…åŒ…åº“</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-emoji-library-mount">æœªæŒ‚è½½</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ—¶é—´æ„ŸçŸ¥è®¾ç½® -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">æ—¶é—´æ„ŸçŸ¥</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">æ—¶é—´æ„ŸçŸ¥å¼€å…³</div>
                                            <div class="setting-desc">è§’è‰²ä¼šæ„ŸçŸ¥å½“å‰æ—¶é—´å¹¶è°ƒæ•´å›å¤</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- é€šè¯è®¾ç½® - ä»…åœ¨å•èŠæ—¶æ˜¾ç¤º -->
                            <div class="settings-section single-chat-only">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">é€šè¯è®¾ç½®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">è§’è‰²ä¸»åŠ¨æ‹¨æ‰“ç”µè¯</div>
                                            <div class="setting-desc">å…è®¸è§’è‰²æ ¹æ®å¯¹è¯å†…å®¹ä¸»åŠ¨å‘èµ·é€šè¯</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled" class="ai-call-enabled-checkbox">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <!-- ğŸ”¥ã€æ–°å¢ã€‘é€šè¯å½¢è±¡è®¾ç½® - ä»…åœ¨å•èŠæ—¶æ˜¾ç¤º -->
                                    <div class="setting-item single-chat-only" id="video-avatar-setting" style="display: none;" onclick="showVideoAvatarModal()">
                                        <div class="setting-left">
                                            <div class="setting-label">é€šè¯å½¢è±¡è®¾ç½®</div>
                                            <div class="setting-desc">è®¾ç½®åŒæ–¹è§†é¢‘é€šè¯æ—¶ä½¿ç”¨çš„å½¢è±¡</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AIå¿ƒç‡ç›‘æµ‹ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">è§’è‰²å¿ƒç‡ç›‘æµ‹</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">å¿ƒç‡ç›‘æµ‹æ˜¾ç¤º</div>
                                            <div class="setting-desc">åœ¨çŠ¶æ€æ æ˜¾ç¤ºè§’è‰²çš„æƒ…æ„Ÿå¿ƒç‡</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>





                            <!-- åå°äº’åŠ¨è®¾ç½® -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">åå°äº’åŠ¨</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">åå°äº’åŠ¨å¼€å…³</div>
                                            <div class="setting-desc">è§’è‰²å¯åœ¨åå°ä¸»åŠ¨æ´»åŠ¨å¹¶å‘é€æ¨é€</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">ä¸»åŠ¨èŠå¤©</div>
                                                <div class="setting-desc">è§’è‰²åœ¨ä½ 10åˆ†é’Ÿæœªå›å¤æ—¶ä¸»åŠ¨å‘æ¶ˆæ¯</div>
                                        </div>
                                        <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-chat-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="chat-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                                <div class="setting-label">ä¸»åŠ¨èŠå¤©é¢‘ç‡</div>
                                                <div class="setting-desc">è§’è‰²ä¸»åŠ¨å‘èµ·å¯¹è¯çš„é¢‘ç‡</div>
                                        </div>
                                        <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">ä½ (1-2å°æ—¶/æ¬¡)</option>
                                                    <option value="medium">ä¸­ (30-60åˆ†é’Ÿ/æ¬¡)</option>
                                                    <option value="high">é«˜ (10-30åˆ†é’Ÿ/æ¬¡)</option>
                                                </select>
                                </div>
                            </div>

                                    <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">ä¸»åŠ¨å‘åŠ¨æ€</div>
                                                <div class="setting-desc">è§’è‰²æ ¹æ®äººè®¾ä¸»åŠ¨å‘å¸ƒåŠ¨æ€</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                    <input type="checkbox" id="background-moments-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="moments-frequency-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">ä¸»åŠ¨å‘åŠ¨æ€é¢‘ç‡</div>
                                                <div class="setting-desc">è§’è‰²ä¸»åŠ¨å‘å¸ƒç¤¾äº¤åŠ¨æ€çš„é¢‘ç‡</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important;">
                                                <select id="background-moments-frequency" class="setting-select">
                                                    <option value="low">ä½ (4-8å°æ—¶/æ¬¡)</option>
                                                    <option value="medium">ä¸­ (2-4å°æ—¶/æ¬¡)</option>
                                                    <option value="high">é«˜ (1-2å°æ—¶/æ¬¡)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="scheduled-moments-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">å®šæ—¶å‘å¸ƒåŠ¨æ€</div>
                                                <div class="setting-desc">è®¾ç½®å›ºå®šæ—¶é—´ç‚¹è‡ªåŠ¨å‘å¸ƒåŠ¨æ€</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <button onclick="showScheduleTimesModal()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    <span id="schedule-times-display">æœªè®¾ç½®</span>
                                                </button>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="scheduled-moments-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="test-publish-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">æµ‹è¯•å‘å¸ƒ</div>
                                                <div class="setting-desc">è®©è§’è‰²ç«‹å³å‘å¸ƒä¸€æ¡æµ‹è¯•åŠ¨æ€</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important; gap: 8px;">
                                                <button onclick="testPublishMoment()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    å‘å¸ƒ
                                                </button>
                                                <button onclick="fixAvatarData()" style="background-color: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ä¿®å¤å¤´åƒ
                                                </button>
                                            </div>
                                        </div>

                                        <!-- ğŸ”¥ã€æ–°å¢ã€‘åå°å†™æ—¥è®°è®¾ç½® -->
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">åå°å†™æ—¥è®°</div>
                                                <div class="setting-desc">è§’è‰²å¯åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨å†™æ—¥è®°</div>
                                            </div>
                                            <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-diary-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="setting-item" id="diary-time-setting" style="display: none; justify-content: space-between !important; align-items: flex-start !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">å†™æ—¥è®°æ—¶é—´</div>
                                                <div class="setting-desc">è®¾ç½®è§’è‰²æ¯å¤©å†™æ—¥è®°çš„æ—¶é—´ç‚¹ï¼ˆæ”¯æŒÂ±5åˆ†é’Ÿæ³¢åŠ¨ï¼‰</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; flex-direction: column !important; align-items: flex-end !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <input type="time" id="diary-time-input" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px;">
                                                <button onclick="saveDiaryTime()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ä¿å­˜æ—¶é—´
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- å…¶ä»–è®¾ç½® -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">å…¶ä»–è®¾ç½®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">æ˜¾ç¤ºæ—¶é—´æˆ³</div>
                                            <div class="setting-desc">åœ¨èŠå¤©æ¶ˆæ¯ä¸­æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">æ—¶é—´æˆ³è®¾ç½®</div>
                                            <div class="setting-desc">è®¾ç½®æ—¶é—´æˆ³æ˜¾ç¤ºä½ç½®å’Œæ ¼å¼</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">æŸ¥æ‰¾èŠå¤©å†…å®¹</div>
                                            <div class="setting-desc">æœç´¢å†å²æ¶ˆæ¯ä¸­çš„å…³é”®è¯</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showExportOptions()">
                                        <div class="setting-left">
                                            <div class="setting-label">å¯¼å‡ºèŠå¤©è®°å½•</div>
                                            <div class="setting-desc">å¯¼å‡ºå½“å‰è§’è‰²çš„å®Œæ•´æ•°æ®</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showImportOptions()">
                                        <div class="setting-left">
                                            <div class="setting-label">å¯¼å…¥èŠå¤©è®°å½•</div>
                                            <div class="setting-desc">å¯¼å…¥è§’è‰²çš„å®Œæ•´æ•°æ®</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½® -->
                            <div class="settings-section" id="character-sound-settings" style="display: none;">
                                <div class="section-header">
                                    <i class="fas fa-volume-up section-icon"></i>
                                    <span class="section-title">ä¸“å±éŸ³æ•ˆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">å¯ç”¨ä¸“å±éŸ³æ•ˆ</div>
                                            <div class="setting-desc">ä¸ºè¯¥è§’è‰²è®¾ç½®ç‹¬ç‰¹çš„éŸ³æ•ˆ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="character-sound-enabled" onchange="toggleCharacterSounds()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div id="character-sound-list" style="display: none;">
                                        <!-- æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆ -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆ</h4>
                                                <p>è¯¥è§’è‰²å‘æ¶ˆæ¯æ—¶æ’­æ”¾çš„éŸ³æ•ˆ</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-messageReceived-url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥">
                                                <input type="file" id="character-messageReceived-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'messageReceived')">
                                                <button onclick="document.getElementById('character-messageReceived-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                                </button>
                                                <button onclick="testCharacterSound('messageReceived')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> è¯•å¬
                                                </button>
                                                <button onclick="clearCharacterSound('messageReceived')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> æ¸…é™¤
                                                </button>
                                            </div>
                                        </div>

                                        <!-- æ¥ç”µéŸ³æ•ˆ -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>æ¥ç”µéŸ³æ•ˆ</h4>
                                                <p>è¯¥è§’è‰²æ‹¨æ‰“è¯­éŸ³/è§†é¢‘é€šè¯æ—¶æ’­æ”¾çš„éŸ³æ•ˆ</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-incomingCall-url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥">
                                                <input type="file" id="character-incomingCall-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'incomingCall')">
                                                <button onclick="document.getElementById('character-incomingCall-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                                </button>
                                                <button onclick="testCharacterSound('incomingCall')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> è¯•å¬
                                                </button>
                                                <button onclick="clearCharacterSound('incomingCall')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> æ¸…é™¤
                                                </button>
                                            </div>
                                        </div>

                                        <!-- æ¨é€é€šçŸ¥éŸ³æ•ˆ -->
                                        <div class="character-sound-item">
                                            <div class="character-sound-header">
                                                <h4>æ¨é€é€šçŸ¥éŸ³æ•ˆ</h4>
                                                <p>æ”¶åˆ°è¯¥è§’è‰²æ¨é€é€šçŸ¥æ—¶æ’­æ”¾çš„éŸ³æ•ˆ</p>
                                            </div>
                                            <div class="character-sound-controls">
                                                <input type="url" class="sound-url-input" id="character-notification-url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥">
                                                <input type="file" id="character-notification-file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;" onchange="handleCharacterSoundFileUpload(this, 'notification')">
                                                <button onclick="document.getElementById('character-notification-file').click()" class="sound-file-btn">
                                                    <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                                </button>
                                                <button onclick="testCharacterSound('notification')" class="sound-test-btn">
                                                    <i class="fas fa-play"></i> è¯•å¬
                                                </button>
                                                <button onclick="clearCharacterSound('notification')" class="sound-clear-btn">
                                                    <i class="fas fa-trash"></i> æ¸…é™¤
                                                </button>
                                            </div>
                                        </div>

                                        <!-- é™éŸ³é€‰é¡¹ -->
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">é™éŸ³æ¨¡å¼</div>
                                                <div class="setting-desc">è¯¥è§’è‰²çš„æ‰€æœ‰éŸ³æ•ˆéƒ½é™éŸ³</div>
                                            </div>
                                            <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="character-silent-mode" onchange="toggleCharacterSilentMode()">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="character-sound-note">
                                            <p><i class="fas fa-info-circle"></i> <strong>éŸ³æ•ˆä¼˜å…ˆçº§ï¼š</strong>é™éŸ³æ¨¡å¼ > ä¸“å±éŸ³æ•ˆ > å…¨å±€éŸ³æ•ˆ</p>
                                            <p><i class="fas fa-info-circle"></i> æ”¯æŒåœ¨çº¿é“¾æ¥å’Œæœ¬åœ°æ–‡ä»¶ï¼ˆæœ€å¤§3MBï¼‰</p>
                                            <p><i class="fas fa-info-circle"></i> æ”¯æŒå¸¸è§éŸ³é¢‘æ ¼å¼ï¼šMP3ã€WAVã€OGGç­‰</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å±é™©æ“ä½œ -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">å±é™©æ“ä½œ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showBlacklistSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label" id="block-manage-label">æ‹‰é»‘ç®¡ç†</div>
                                            <div class="setting-desc" id="block-manage-desc">æ‹‰é»‘/è§£é™¤æ‹‰é»‘ç®¡ç†</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">æ¸…ç©ºèŠå¤©è®°å½•</div>
                                            <div class="setting-desc">åˆ é™¤æ‰€æœ‰å†å²æ¶ˆæ¯ï¼Œä¸å¯æ¢å¤</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- äººç‰©ç¼–è¾‘è¡¨å• -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">â€¹</button>
                        <div class="app-title" id="character-form-title">æ–°å»ºäººç‰©</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">å¤´åƒ</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <button class="upload-button" onclick="handleAvatarUploadClick()">ä¸Šä¼ å¤´åƒ</button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">å§“å</label>
                                <input type="text" class="form-input" id="character-name" placeholder="è¾“å…¥å§“å">
                            </div>
                            <div class="form-group">
                                <label class="form-label">äººè®¾</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="è¾“å…¥äººç‰©è®¾å®š"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">ä¿å­˜</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å»ºäººç‰©ç•Œé¢æ–‡ä»¶è¾“å…¥æ¡†ã€‘æ”¾åœ¨ç•Œé¢å¤–é¢ï¼Œé¿å…åœ¨æŸäº›è®¾å¤‡ä¸Šæ˜¾ç¤º -->
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <input type="file" id="character-card-upload" accept=".png,.json" style="display: none;">

                <!-- é¢å…·åˆ›å»ºè¡¨å• -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">â€¹</button>
                        <div class="app-title" id="persona-form-title">æ–°å»ºé¢å…·</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">å¤´åƒ</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">æˆ‘</div>
                                </div>
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">ä¸Šä¼ å¤´åƒ</button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">æˆ‘çš„åç§°</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="ä¾‹å¦‚ï¼šuserå°æ˜ã€userå­¦ç”Ÿã€userå·¥ä½œè€…">
                            </div>

                            <div class="form-group">
                                <label class="form-label">æˆ‘çš„æè¿°</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="æè¿°è¿™ä¸ªèº«ä»½çš„ç‰¹ç‚¹ï¼ŒåŒ…æ‹¬æ€§æ ¼ã€è¯´è¯é£æ ¼ã€ä½¿ç”¨åœºåˆç­‰..."></textarea>
                            </div>

                            <button class="form-submit" onclick="savePersona()">ä¿å­˜é¢å…·</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å»ºé¢å…·ç•Œé¢æ–‡ä»¶è¾“å…¥æ¡†ã€‘æ”¾åœ¨ç•Œé¢å¤–é¢ï¼Œé¿å…åœ¨æŸäº›è®¾å¤‡ä¸Šæ˜¾ç¤º -->
                <input type="file" id="persona-avatar-upload" accept="image/*" style="display: none;">

                <!-- è¡¨æƒ…åŒ…åº“ä¸Šä¼ æ–‡ä»¶è¾“å…¥æ¡† -->
                <input type="file" id="emoji-library-upload" accept="image/*" multiple style="display: none;">

                <!-- è¡¨æƒ…åŒ…åº“ç®¡ç†ç•Œé¢ -->
                <div id="emoji-library-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideEmojiLibraryScreen()">â€¹</button>
                        <div class="app-title" id="emoji-library-title">è¡¨æƒ…åŒ…åº“</div>
                        <div class="emoji-library-delete-btn" onclick="startEmojiSelection()" title="æ‰¹é‡åˆ é™¤è¡¨æƒ…åŒ…" id="start-selection-btn">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="emoji-selection-buttons" id="selection-buttons" style="display: none;">
                            <button onclick="selectAllEmojis()" title="å…¨é€‰">å…¨é€‰</button>
                            <button onclick="deleteSelectedEmojis()" title="åˆ é™¤é€‰ä¸­">åˆ é™¤</button>
                            <button onclick="cancelSelection()" title="å–æ¶ˆ">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div class="app-content emoji-library-content-area">
                        <!-- ä¸Šä¼ åŒºåŸŸ -->
                        <div class="emoji-library-upload-area-small" id="emoji-library-upload-area" onclick="triggerEmojiUpload()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 20px; color: #6B9BD2; margin-bottom: 5px;"></i>
                            <p style="margin: 0; font-size: 14px; color: #333;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è¡¨æƒ…åŒ…</p>
                            <p style="margin: 2px 0 0 0; font-size: 11px; color: #666;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</p>
                        </div>

                        <!-- è¡¨æƒ…åŒ…åº“ç»Ÿè®¡ä¿¡æ¯ -->
                        <div class="emoji-library-stats" id="emoji-library-stats" style="display: none;">
                            <div class="stats-item">
                                <span class="stats-label">æ€»æ•°ï¼š</span>
                                <span class="stats-value" id="total-emojis">0</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-label">å·²è®¾ç½®æè¿°ï¼š</span>
                                <span class="stats-value" id="described-emojis">0</span>
                            </div>
                            <div class="stats-item warning" id="undescribed-warning" style="display: none;">
                                <span class="stats-label">âš ï¸ æœªè®¾ç½®æè¿°ï¼š</span>
                                <span class="stats-value" id="undescribed-emojis">0</span>
                            </div>
                        </div>

                        <div class="emoji-library-grid" id="emoji-library-grid">
                            <!-- è¡¨æƒ…åŒ…ç½‘æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div class="emoji-library-empty" id="emoji-library-empty" style="display: none;">
                            <i class="fas fa-smile"></i>
                            <p>è¿™ä¸ªè¡¨æƒ…åŒ…åº“è¿˜æ˜¯ç©ºçš„</p>
                            <p>ç‚¹å‡»ä¸Šæ–¹åŒºåŸŸä¸Šä¼ è¡¨æƒ…åŒ…</p>
                        </div>
                    </div>
                </div>

                <!-- è¡¨æƒ…åŒ…åº“åˆ›å»º/ç¼–è¾‘è¡¨å• -->
                <div id="emoji-library-form-modal" class="modal-overlay" style="display: none;" onclick="hideEmojiLibraryForm(event)">
                    <div class="modal-content emoji-library-form-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3 id="emoji-library-form-title">æ–°å»ºè¡¨æƒ…åŒ…åº“</h3>
                            <button class="modal-close-btn" onclick="hideEmojiLibraryForm()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">åº“åç§°</label>
                                <input type="text" class="form-input" id="emoji-library-name-input" placeholder="ä¾‹å¦‚ï¼šå¯çˆ±åŠ¨ç‰©ã€æç¬‘è¡¨æƒ…ã€æ—¥å¸¸èŠå¤©">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea class="form-textarea" id="emoji-library-description-input" placeholder="æè¿°è¿™ä¸ªè¡¨æƒ…åŒ…åº“çš„ç”¨é€”å’Œç‰¹ç‚¹..." rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn cancel-btn" onclick="hideEmojiLibraryForm()">å–æ¶ˆ</button>
                            <button class="modal-btn confirm-btn" onclick="saveEmojiLibrary()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- APIèŠå¤©ç•Œé¢ -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div id="ai-heartrate-display" style="display: none;">â™¥ï¸ 72 bpm</div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="header">
                        <div class="default-controls">
                            <button class="back-btn" onclick="backToChatApp().catch(e => console.error('è¿”å›èŠå¤©åº”ç”¨å¤±è´¥:', e))">â€¹</button>
                            <span class="header-title" id="api-chat-title">è§’è‰²èŠå¤©</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="toggleOfflineMode()" id="offline-mode-btn" title="åˆ‡æ¢çº¿ä¸‹å‰§æƒ…æ¨¡å¼">
                                    <i class="fas fa-door-open" id="offline-mode-icon"></i>
                                </span>
                                <span class="action-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                                </span>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">å–æ¶ˆ</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">åˆ é™¤</span>
                        </div>
                        <span id="selection-forward-btn" onclick="showForwardTargetModal()" title="è½¬å‘">
                            <i class="fas fa-share"></i>
                        </span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>


                            <div class="chat-input-area">
                                <!-- å±•å¼€çš„å·¥å…·é¢æ¿ -->
                                <div class="tools-panel" id="tools-panel" style="display: none;">
                                    <div class="tools-grid">
                                        <div class="tool-item" id="regenerate-tool-item" onclick="regenerateLastResponse(); hideToolsPanel();" style="display: none;">
                                            <div class="tool-icon">
                                        <i class="fas fa-redo-alt"></i>
                                            </div>
                                            <span class="tool-label">é‡å›</span>
                                        </div>
                                        <div class="tool-item" onclick="handleVoiceRecording(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-microphone"></i>
                                            </div>
                                            <span class="tool-label">è¯­éŸ³</span>
                                        </div>
                                        <div class="tool-item" onclick="showCustomEmojiPanel(); hideToolsPanel();">
                                            <div class="tool-icon">
                                                <i class="fas fa-smile"></i>
                                            </div>
                                            <span class="tool-label">è¡¨æƒ…</span>
                                        </div>
                                        <div class="tool-item" onclick="openCamera(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-camera"></i>
                                            </div>
                                            <span class="tool-label">æ‹ç…§</span>
                                        </div>
                                        <div class="tool-item" onclick="uploadImage(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-image"></i>
                                            </div>
                                            <span class="tool-label">å›¾ç‰‡</span>
                                        </div>
                                        <div class="tool-item" onclick="openTransfer(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-exchange-alt"></i>
                                            </div>
                                            <span class="tool-label">è½¬è´¦</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="makeCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-phone"></i>
                                            </div>
                                            <span class="tool-label">ç”µè¯</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="openVideoCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-video"></i>
                                            </div>
                                            <span class="tool-label">è§†é¢‘</span>
                                        </div>
                                        <div class="tool-item" onclick="shareLocation(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            <span class="tool-label">ä½ç½®</span>
                                        </div>
                                        <div class="tool-item diary-tool" onclick="showDiaryMenu(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-book"></i>
                                            </div>
                                            <span class="tool-label">æ—¥è®°</span>
                                        </div>
                                        <div class="tool-item game-tool single-chat-only" onclick="showGameMenu(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-gamepad"></i>
                                            </div>
                                            <span class="tool-label">æ¸¸æˆ</span>
                                        </div>
                                        <div class="tool-item" onclick="openMusicPlayer(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-headphones"></i>
                                            </div>
                                            <span class="tool-label">å¬æ­Œ</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="openShoppingScreen(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                            </div>
                                            <span class="tool-label">è´­ç‰©</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="showCharacterFootprints(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-map-marked-alt"></i>
                                            </div>
                                            <span class="tool-label">è¶³è¿¹</span>
                                        </div>
                                        <div class="tool-item single-chat-only" onclick="showCharacterPhone(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                            </div>
                                            <span class="tool-label">æŸ¥çœ‹</span>
                                        </div>

                                    </div>
                                </div>

                                <!-- è¾“å…¥åŒºåŸŸ -->
                                <div class="input-controls">
                                <button class="chat-action-btn toggle-tools-btn" onclick="toggleToolsPanel()" title="åŠŸèƒ½èœå•" id="toggle-tools-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div style="position: relative; flex: 1; min-width: 0;">
                                    <textarea class="chat-input" id="api-chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                                    <!-- @ç¾¤æˆå‘˜ä¸‹æ‹‰é€‰æ‹©æ¡† -->
                                    <div class="mention-dropdown" id="mention-dropdown">
                                        <!-- åŠ¨æ€ç”Ÿæˆç¾¤æˆå‘˜åˆ—è¡¨ -->
                                    </div>
                                </div>
                                    <button class="chat-action-btn" onclick="triggerSmartReply()" title="è·å–AIå›å¤">
                                        <i class="fas fa-comment-dots"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    å‘é€
                                </button>
                                </div>
                            </div>
                        </div>

                        <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…é¢æ¿ -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">æœ€è¿‘</div>
                                <div class="emoji-tab" data-tab="custom">å…¨éƒ¨</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- è¡¨æƒ…åŒ…ç½‘æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- çº¿ä¸‹å‰§æƒ…æ¨¡å¼è¦†ç›–å±‚ -->
                    <div id="offline-mode-overlay" class="offline-mode-overlay" style="display: none;">
                        <div class="offline-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="offline-mode-header">
                            <button class="back-btn" onclick="exitOfflineMode()">â€¹</button>
                            <span class="header-title" id="offline-mode-title">çº¿ä¸‹å‰§æƒ…æ¨¡å¼</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="showOfflineHistoryModal()" title="æŸ¥çœ‹èŠå¤©è®°å½•">
                                    <i class="fas fa-history"></i>
                                </span>
                                <span class="action-btn" onclick="showOfflineUISettings()" title="ç•Œé¢è®¾ç½®">
                                    <i class="fas fa-cog"></i>
                                </span>
                                <span class="action-btn" onclick="showOfflinePresetSettings()" title="æ·»åŠ é¢„è®¾">
                                    <i class="fas fa-plus"></i>
                                </span>
                            </div>
                        </div>

                        <div class="offline-mode-content">
                            <div class="offline-chat-messages" id="offline-chat-messages">
                                <!-- çº¿ä¸‹æ¨¡å¼çš„èŠå¤©æ¶ˆæ¯ -->
                            </div>

                            <div class="offline-input-area">
                                <div class="offline-input-container">
                                    <textarea id="offline-input" placeholder="åœ¨çº¿ä¸‹å‰§æƒ…æ¨¡å¼ä¸­è¾“å…¥..." rows="3"></textarea>
                                    <div class="offline-button-group">
                                        <button class="offline-regenerate-btn" onclick="regenerateLastOfflineMessage()" title="é‡æ–°ç”ŸæˆAIå›å¤">
                                            <i class="fas fa-redo-alt"></i>
                                        </button>
                                        <button class="offline-send-btn" onclick="sendOfflineMessage()">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€èŠå¤©ç•Œé¢æ–‡ä»¶è¾“å…¥æ¡†ã€‘æ”¾åœ¨ç•Œé¢å¤–é¢ï¼Œé¿å…åœ¨æŸäº›è®¾å¤‡ä¸Šæ˜¾ç¤º -->
                <input type="file" id="image-upload" accept="image/*" style="display: none;">
                <input type="file" id="emoji-upload" accept="image/*" style="display: none;" multiple>

                <!-- ä¸ªäººè¡¨æƒ…åŒ…æè¿°æ·»åŠ æ¨¡æ€æ¡† -->
                <div id="personal-emoji-description-modal" class="modal-overlay" style="display: none;" onclick="hidePersonalEmojiDescriptionModal(event)">
                    <div class="modal-content personal-emoji-description-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>æ·»åŠ è¡¨æƒ…åŒ…æè¿°</h3>
                            <button class="modal-close-btn" onclick="hidePersonalEmojiDescriptionModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="emoji-preview-container">
                                <img id="personal-emoji-preview-image" src="" alt="è¡¨æƒ…åŒ…é¢„è§ˆ" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 15px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¡¨æƒ…åŒ…æè¿°</label>
                                <textarea class="form-textarea" id="personal-emoji-description-input" placeholder="è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…åŒ…æ·»åŠ æè¿°ï¼Œå¸®åŠ©AIæ›´å¥½åœ°ç†è§£è¡¨æƒ…åŒ…å†…å®¹" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn cancel-btn" onclick="hidePersonalEmojiDescriptionModal()">å–æ¶ˆ</button>
                            <button class="modal-btn confirm-btn" onclick="confirmPersonalEmojiDescription()">ç¡®å®š</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²è¶³è¿¹æ¨¡æ€æ¡† -->
                <div id="character-footprints-modal" class="modal-overlay" style="display: none;" onclick="hideCharacterFootprints(event)">
                    <div class="modal-content footprints-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div class="footprints-header-info">
                                <div class="footprints-character-avatar" id="footprints-character-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="footprints-character-info">
                                    <h3 id="footprints-character-name">è§’è‰²è¶³è¿¹</h3>
                                    <p class="footprints-subtitle">æŸ¥çœ‹Taçš„è¡Œä¸ºè½¨è¿¹</p>
                                </div>
                            </div>
                            <div class="footprints-header-actions">
                                <button class="footprints-refresh-btn" onclick="refreshCharacterFootprints()" title="åˆ·æ–°è¶³è¿¹">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="modal-close-btn" onclick="hideCharacterFootprints()">Ã—</button>
                            </div>
                        </div>
                        <div class="modal-body footprints-body">
                            <div class="footprints-settings">
                                <div class="footprints-setting-item">
                                    <label>è‡ªåŠ¨æ›´æ–°é¢‘ç‡</label>
                                    <select id="footprints-update-frequency" onchange="updateFootprintsFrequency()">
                                        <option value="manual" selected>æ‰‹åŠ¨åˆ·æ–°</option>
                                        <option value="30">æ¯30åˆ†é’Ÿ</option>
                                        <option value="60">æ¯å°æ—¶</option>
                                        <option value="120">æ¯2å°æ—¶</option>
                                        <option value="180">æ¯3å°æ—¶</option>
                                    </select>
                                </div>
                            </div>
                            <div class="footprints-timeline" id="footprints-timeline">
                                <!-- è¶³è¿¹æ—¶é—´çº¿å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                <div class="footprints-empty-state">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <p>æš‚æ— è¶³è¿¹è®°å½•</p>
                                    <p>ç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–æœ€æ–°è¶³è¿¹</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æµè§ˆå™¨ç•Œé¢ -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">â€¹</button>
                        <div class="app-title">æµè§ˆå™¨</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="è¾“å…¥ç½‘å€">
                            <button onclick="loadUrl()">å‰å¾€</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>



                <!-- è®¾ç½®åº”ç”¨ -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="hideApp('settings-screen')">â€¹</button>
                            <div class="app-title">è®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>APIè®¾ç½®</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>ä¸»é¢˜è®¾ç½®</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>å£çº¸è®¾ç½®</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('appearance-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>å¤–è§‚è®¾ç½®</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('display-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div>å­—ä½“ä¸å­—å·</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('sound-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon sound">
                                    <i class="fas fa-volume-up"></i>
                                </div>
                                <div>éŸ³æ•ˆè®¾ç½®</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('data-management-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon data-management">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div>æ•°æ®ç®¡ç†</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('emergency-recovery-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon" style="background: #ff4444; color: white;">
                                    <i class="fas fa-life-ring"></i>
                                </div>
                                <div>ç´§æ€¥æ¢å¤</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>å…è´£å£°æ˜</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>



                <!-- æ•°æ®ç®¡ç† -->
                <div id="data-management-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('data-management-screen')">â€¹</button>
                            <div class="app-title">æ•°æ®ç®¡ç†</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <!-- å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ -->
                        <div class="data-section">
                            <div class="data-section-title">å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ</div>
                            <div class="storage-usage" id="storage-usage">
                                <div class="storage-item">
                                    <div class="storage-label">èŠå¤©è®°å½•</div>
                                    <div class="storage-size" id="chat-storage-size">è®¡ç®—ä¸­...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">è§’è‰²æ•°æ®</div>
                                    <div class="storage-size" id="character-storage-size">è®¡ç®—ä¸­...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">èŠå¤©è®¾ç½®</div>
                                    <div class="storage-size" id="settings-storage-size">è®¡ç®—ä¸­...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">è¡¨æƒ…åŒ…</div>
                                    <div class="storage-size" id="emoji-storage-size">è®¡ç®—ä¸­...</div>
                                </div>
                                <div class="storage-total">
                                    <div class="storage-label">æ€»è®¡</div>
                                    <div class="storage-size" id="total-storage-size">è®¡ç®—ä¸­...</div>
                                </div>
                            </div>
                        </div>

                        <!-- æ•°æ®å¯¼å…¥å¯¼å‡º -->
                        <div class="data-section">
                            <div class="data-section-title">æ•°æ®å¤‡ä»½ä¸æ¢å¤</div>
                            <div class="settings-item" onclick="exportAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">å¯¼å‡ºæ‰€æœ‰æ•°æ®</div>
                                        <div class="setting-desc">å¯¼å‡ºæ‰€æœ‰è®°å½•ä¸ºJSONæ–‡ä»¶</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="exportLightweightData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-file-export"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">è½»é‡çº§å¯¼å‡º</div>
                                        <div class="setting-desc">å¯¼å‡ºæ ¸å¿ƒæ•°æ®ï¼Œé€‚åˆå¤§æ•°æ®é‡æ—¶ä½¿ç”¨</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="importDataFromFile()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">å¯¼å…¥æ•°æ®</div>
                                        <div class="setting-desc">ä»JSONæ–‡ä»¶æ¢å¤èŠå¤©è®°å½•å’Œè®¾ç½®</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- æ•°æ®æ£€æŸ¥ä¸ä¿®å¤ -->
                        <div class="data-section">
                            <div class="data-section-title">æ•°æ®æ£€æŸ¥ä¸ä¿®å¤</div>
                            <div class="settings-item" onclick="checkAndFixChatHistory()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">æ£€æŸ¥èŠå¤©å†å²</div>
                                        <div class="setting-desc">æ£€æŸ¥å¹¶ä¿®å¤èŠå¤©è®°å½•æ•°æ®ï¼Œæ¢å¤ä¸¢å¤±çš„æ¶ˆæ¯</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugChatMessagesFormat()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-bug"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">è°ƒè¯•èŠå¤©è®°å½•æ ¼å¼</div>
                                        <div class="setting-desc">åˆ†æèŠå¤©è®°å½•çš„æ•°æ®æ ¼å¼ï¼Œå¸®åŠ©è¯Šæ–­å¯¼å…¥é—®é¢˜</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugGroupChatData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">è°ƒè¯•ç¾¤èŠæ•°æ®</div>
                                        <div class="setting-desc">æ£€æŸ¥ç¾¤èŠæ•°æ®çš„å­˜å‚¨çŠ¶æ€ï¼Œè¯Šæ–­ç¾¤èŠæ˜¾ç¤ºé—®é¢˜</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="debugImportFunction()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-code"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">è°ƒè¯•å¯¼å…¥å‡½æ•°</div>
                                        <div class="setting-desc">æ£€æŸ¥å½“å‰ä½¿ç”¨çš„å¯¼å…¥å‡½æ•°ç‰ˆæœ¬ï¼Œè¯Šæ–­æ•°æ®ä¸¢å¤±é—®é¢˜</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="runDataIntegrityDiagnosis()">
                                <div class="settings-item-left">
                                    <div class="settings-icon debug">
                                        <i class="fas fa-stethoscope"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ğŸ” æ•°æ®å®Œæ•´æ€§è¯Šæ–­</div>
                                        <div class="setting-desc">æ£€æŸ¥è§’è‰²è®°å¿†æ˜¯å¦é”™ä¹±ï¼Œè¯Šæ–­æ•°æ®éš”ç¦»é—®é¢˜</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="fixDataSyncIssues()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ğŸ”§ ä¿®å¤æ•°æ®åŒæ­¥é—®é¢˜</div>
                                        <div class="setting-desc">ä¿®å¤æ•°æ®åº“ä¸å†…å­˜ä¸ä¸€è‡´ï¼Œè§£å†³è§’è‰²è®°å¿†é”™ä¹±</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- é€‰æ‹©æ€§æ¸…ç† -->
                        <div class="data-section">
                            <div class="data-section-title">å­˜å‚¨æ¸…ç†</div>
                            <div class="settings-item" onclick="cleanupOrphanedContacts()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">æ¸…ç†å­¤ç«‹æ•°æ®</div>
                                        <div class="setting-desc">æ¸…ç†ä¸å­˜åœ¨çš„è§’è‰²æ•°æ®å’Œç›¸å…³è®°å½•</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="showCleanupOptions()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-broom"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">é€‰æ‹©æ€§æ¸…ç†</div>
                                        <div class="setting-desc">æ¸…ç†ç‰¹å®šç±»å‹çš„æ•°æ®ä»¥é‡Šæ”¾ç©ºé—´</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="compressAllImages()">
                                <div class="settings-item-left">
                                    <div class="settings-icon compress">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">å‹ç¼©å›¾ç‰‡</div>
                                        <div class="setting-desc">å‹ç¼©æ‰€æœ‰å¤´åƒå’ŒèƒŒæ™¯å›¾ç‰‡ä»¥èŠ‚çœç©ºé—´</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- å±é™©æ“ä½œ -->
                        <div class="data-section danger-section">
                            <div class="data-section-title">å±é™©æ“ä½œ</div>
                            <div class="settings-item danger-item" onclick="clearAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">æ¸…ç©ºæ‰€æœ‰æ•°æ®</div>
                                        <div class="setting-desc">åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸš¨ ç´§æ€¥æ¢å¤ç•Œé¢ -->
                <div class="app-screen" id="emergency-recovery-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('emergency-recovery-screen')">â€¹</button>
                            <div class="app-title" style="color: #ff4444;">ğŸš¨ ç´§æ€¥æ¢å¤</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div style="padding: 20px; color: #333;">
                            <!-- è­¦å‘Šå¡ç‰‡ - æ¯›ç»ç’ƒé£æ ¼ -->
                            <div style="background: linear-gradient(135deg, rgba(255, 68, 68, 0.15) 0%, rgba(255, 68, 68, 0.08) 100%); border: 2px solid rgba(255, 68, 68, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 25px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(255, 68, 68, 0.1);">
                                <h3 style="color: #ff4444; margin: 0 0 12px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>âš ï¸</span> æ•°æ®ä¸¢å¤±æ£€æµ‹
                                </h3>
                                <p style="margin: 0; font-size: 15px; color: #666; line-height: 1.5;">å¦‚æœæ‚¨çš„è§’è‰²çªç„¶æ¶ˆå¤±ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½æ¢å¤æ•°æ®ã€‚</p>
                            </div>

                            <!-- ç¬¬ä¸€æ­¥ -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ”</span> ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ•°æ®çŠ¶æ€
                                </h4>
                                <button onclick="checkDataStatus()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease; margin-bottom: 15px;">
                                    æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€
                                </button>
                                <div id="data-status-result" style="background: rgba(248, 249, 250, 0.9); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                    <pre id="data-status-text" style="font-size: 12px; margin: 0; white-space: pre-wrap; color: #333; font-family: 'SF Mono', Monaco, monospace;"></pre>
                                </div>
                            </div>

                            <!-- ç¬¬äºŒæ­¥ -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ”</span> ç¬¬äºŒæ­¥ï¼šæ·±åº¦æ•°æ®æŒ–æ˜
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">æœç´¢æµè§ˆå™¨ä¸­å¯èƒ½æ®‹ç•™çš„è§’è‰²æ•°æ®ï¼š</p>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="deepDataSearch()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        ğŸ” æ·±åº¦æœç´¢æ®‹ç•™æ•°æ®
                                    </button>
                                    <button onclick="searchChatHistory()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        ğŸ’¬ ä»èŠå¤©è®°å½•æ¨æ–­è§’è‰²
                                    </button>
                                </div>
                                <div id="deep-search-result" style="background: rgba(248, 249, 250, 0.9); border-radius: 12px; padding: 15px; margin-top: 15px; display: none; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                    <pre id="deep-search-text" style="font-size: 12px; margin: 0; white-space: pre-wrap; color: #333; font-family: 'SF Mono', Monaco, monospace;"></pre>
                                </div>
                            </div>

                            <!-- ç¬¬ä¸‰æ­¥ -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ“¥</span> ç¬¬ä¸‰æ­¥ï¼šæ–‡ä»¶å¯¼å…¥æ¢å¤
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">å¦‚æœæ‚¨æœ‰å¤‡ä»½æ–‡ä»¶ï¼š</p>
                                <input type="file" id="recovery-file-input" accept=".json" style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.08); border-radius: 12px; font-size: 16px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); transition: all 0.3s ease; color: #333; box-sizing: border-box; margin-bottom: 15px;">
                                <button onclick="recoverFromFile()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                    ä»æ–‡ä»¶æ¢å¤æ•°æ®
                                </button>
                            </div>

                            <!-- ç¬¬å››æ­¥ -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ”§</span> ç¬¬å››æ­¥ï¼šé‡å»ºè§’è‰²å¡
                                </h4>
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5;">ä»èŠå¤©è®°å½•é‡å»ºä¸¢å¤±çš„è§’è‰²ï¼š</p>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="rebuildCharactersFromChat()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        ğŸ”§ è‡ªåŠ¨é‡å»ºæ‰€æœ‰è§’è‰²
                                    </button>
                                    <button onclick="showManualRebuild()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        âœï¸ æ‰‹åŠ¨é‡å»ºè§’è‰²
                                    </button>
                                </div>
                            </div>

                            <!-- è°ƒè¯•å·¥å…· -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ”</span> è°ƒè¯•ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="debugCurrentState()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        ğŸ” æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€
                                    </button>
                                    <button onclick="forceRefreshAll()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">
                                        ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢
                                    </button>
                                </div>
                            </div>

                            <!-- ç¬¬äº”æ­¥ -->
                            <div class="recovery-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ§¹</span> ç¬¬äº”æ­¥ï¼šæ¸…ç†å¼‚å¸¸æ•°æ®
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <button onclick="cleanupBadData()" style="width: 100%; padding: 14px 20px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                        æ¸…é™¤å¼ ä¸‰æå››ç­‰å¼‚å¸¸è§’è‰²
                                    </button>
                                    <button onclick="forceReload()" style="width: 100%; padding: 14px 20px; background: #FF3B30; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3); transition: all 0.3s ease;">
                                        å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
                                    </button>
                                </div>
                            </div>

                            <!-- æ¢å¤æ—¥å¿— -->
                            <div id="recovery-log" style="background: rgba(248, 249, 250, 0.9); border-radius: 16px; padding: 20px; margin-top: 20px; max-height: 200px; overflow-y: auto; display: none; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);">
                                <h5 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ“‹</span> æ¢å¤æ—¥å¿—ï¼š
                                </h5>
                                <div id="recovery-log-content" style="font-size: 13px; font-family: 'SF Mono', Monaco, monospace; color: #555; line-height: 1.4;"></div>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- å…³äºæˆ‘ä»¬ -->
                <div id="about-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('about-screen')">â€¹</button>
                            <div class="app-title">å…è´£å£°æ˜</div>
                        </div>
                    </div>
                    <div class="app-content" style="padding: 20px; text-align: left; color: #333; line-height: 1.8;">
                        <h2 style="text-align: center; margin-bottom: 20px;">å…è´£å£°æ˜</h2>
                        <p style="margin-bottom: 15px;">æœ¬åº”ç”¨ï¼ˆâ€œEVE Chatâ€ï¼‰ä»…ä¾›å¨±ä¹å’Œä¿¡æ¯åˆ†äº«ï¼Œä¸æ„æˆä»»ä½•ä¸“ä¸šå»ºè®®ï¼ˆå¦‚åŒ»ç–—ã€æ³•å¾‹ã€é‡‘èç­‰ï¼‰ã€‚</p>
                        <p style="margin-bottom: 15px;">æœ¬åº”ç”¨ä¸­çš„è™šæ‹Ÿè§’è‰²å’Œå¯¹è¯å†…å®¹å‡ä¸ºAIç”Ÿæˆï¼Œä¸ä»£è¡¨ä»»ä½•çœŸå®äººç‰©ã€å®ä½“æˆ–ç»„ç»‡çš„è§‚ç‚¹ã€‚</p>
                        <p style="margin-bottom: 15px;">ç”¨æˆ·ç”Ÿæˆå’Œä½¿ç”¨çš„æ‰€æœ‰Alè§’è‰²è®¾å®šã€å¯¹è¯ã€å›¾ç‰‡ç­‰å†…å®¹çš„è´£ä»»ç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…ã€‚</p>
                        <p style="margin-bottom: 15px;">ç”¨æˆ·åœ¨ä¸å…¶ä»–ç”¨æˆ·äº’åŠ¨æ—¶ï¼Œåº”è‡ªè¡Œæ‰¿æ‹…é£é™©ã€‚å¼€å‘è€…ä¸å¯¹ç”¨æˆ·ä¹‹é—´çš„ä»»ä½•è¡Œä¸ºè´Ÿè´£ã€‚</p>
                        <p style="margin-bottom: 15px;">ç”¨æˆ·ä½¿ç”¨æœŸé—´äº§ç”Ÿçš„æ•°æ®çš†ä¸ºæœ¬åœ°å­˜å‚¨ã€‚</p>
                        <p style="margin-bottom: 15px;">è¯·å‹¿å°†æœ¬ç½‘é¡µç”¨äºä»»ä½•éæ³•æˆ–ä¾µçŠ¯ä»–äººæƒç›Šçš„ç”¨é€”ã€‚å¼€å‘è€…ä¸å¯¹å› ä½¿ç”¨æœ¬åº”ç”¨è€Œäº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœè´Ÿè´£ã€‚</p>
                        <p style="margin-bottom: 25px; font-weight: bold;">ç»§ç»­ä½¿ç”¨æœ¬åº”ç”¨å³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æœ¬å…è´£å£°æ˜ã€‚</p>
                        <div class="disclaimer-footer" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; color: #888; font-size: 14px;">
                            <p><strong>ä½œè€…ï¼š</strong>EVE</p>
                            <p><strong>ç½‘é¡µåï¼š</strong>EVE Chat</p>
                            <p>ç¦æ­¢ä»»ä½•äºŒä¼ äºŒæ”¹</p>
                            <p><strong>å”¯ä¸€è·å–é€”å¾„QQç¾¤ï¼š963263414</strong></p>
                            <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
                            <p>ç‰ˆæœ¬ï¼š1.0.0</p>
                            <p>æœ€åæ›´æ–°ï¼š2025å¹´8æœˆ23æ—¥</p>
                        </div>
                    </div>
                </div>

                <!-- ç”µè¯é€šè¯ç•Œé¢ -->
                <div id="phone-call-screen" class="app-screen">
                    <div class="call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="call-content">
                        <div class="call-header">
                            <div class="call-avatar">
                                <img id="call-avatar-img" src="" alt="é€šè¯å¤´åƒ">
                            </div>
                            <div class="call-name" id="call-name">è§’è‰²åç§°</div>
                            <div class="call-status" id="call-status">æ­£åœ¨é€šè¯ä¸­...</div>
                            <div class="call-time" id="call-timer">00:00</div>
                        </div>

                        <div class="call-message-container" id="call-message-container">
                            <!-- é€šè¯ä¸­çš„æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>

                        <div class="call-input-area">
                            <input type="text" id="call-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="call-text-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendCallMessage(); }">
                            <button class="call-send-btn" onclick="sendCallMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <div class="call-controls">
                            <button class="call-control-btn end-call-btn" onclick="endCall()">
                                <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ¥ç”µæ˜¾ç¤ºç•Œé¢ -->
                <div id="incoming-call-screen" class="app-screen">
                    <div class="call-background incoming"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="incoming-call-content">
                        <div class="call-header">
                            <div class="call-avatar large-avatar">
                                <img id="incoming-call-avatar" src="" alt="æ¥ç”µå¤´åƒ">
                            </div>
                            <div class="call-name" id="incoming-call-name">è§’è‰²åç§°</div>
                            <div class="call-status">æ¥ç”µ</div>
                            <div class="call-text" id="incoming-call-text">æƒ³å’Œä½ é€šè¯...</div>
                        </div>

                        <div class="incoming-call-controls">
                            <button class="incoming-call-btn reject-btn" onclick="rejectCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                                </div>
                                <div class="call-btn-text">æ‹’ç»</div>
                            </button>
                            <button class="incoming-call-btn accept-btn" onclick="acceptCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone"></i>
                                </div>
                                <div class="call-btn-text">æ¥å¬</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘æ¥ç”µæ˜¾ç¤ºç•Œé¢ -->
                <div id="incoming-video-call-screen" class="app-screen">
                    <div class="video-call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="incoming-call-content">
                        <div class="call-header">
                            <div class="call-avatar large-avatar">
                                <img id="incoming-video-call-avatar" src="" alt="è§†é¢‘æ¥ç”µå¤´åƒ">
                            </div>
                            <div class="call-name" id="incoming-video-call-name">è§’è‰²åç§°</div>
                            <div class="call-status">è§†é¢‘æ¥ç”µ</div>
                            <div class="call-text" id="incoming-video-call-text">æƒ³å’Œä½ è§†é¢‘èŠèŠ...</div>
                        </div>

                        <div class="incoming-call-controls">
                            <button class="incoming-call-btn reject-btn" onclick="rejectVideoCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                                </div>
                                <div class="call-btn-text">æ‹’ç»</div>
                            </button>
                            <button class="incoming-call-btn accept-btn" onclick="acceptVideoCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="call-btn-text">æ¥å¬</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘é€šè¯ç•Œé¢ -->
                <div id="video-call-screen" class="app-screen">
                    <div class="video-call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸»ç”»é¢ï¼šè§’è‰²é€šè¯å½¢è±¡ -->
                    <div class="video-call-main-view">
                        <img id="video-call-character-avatar" src="" alt="è§’è‰²é€šè¯å½¢è±¡" class="character-video-avatar">

                        <!-- å³ä¸Šè§’å°çª—å£ï¼šç”¨æˆ·é€šè¯å½¢è±¡ -->
                        <div class="video-call-user-window">
                            <img id="video-call-user-avatar" src="" alt="ç”¨æˆ·é€šè¯å½¢è±¡" class="user-video-avatar">
                        </div>

                        <!-- é€šè¯ä¿¡æ¯è¦†ç›–å±‚ -->
                        <div class="video-call-overlay">
                            <div class="video-call-info">
                                <div class="video-call-name" id="video-call-name">è§’è‰²åç§°</div>
                                <div class="video-call-status" id="video-call-status">è§†é¢‘é€šè¯ä¸­...</div>
                                <div class="video-call-time" id="video-call-timer">00:00</div>
                            </div>
                        </div>


                    </div>

                    <!-- æ¶ˆæ¯æµ®ç°åŒºåŸŸ -->
                    <div class="video-call-floating-messages" id="video-call-floating-messages">
                        <!-- è§†é¢‘é€šè¯ä¸­çš„æ¶ˆæ¯å°†ä»¥æµ®ç°æ°”æ³¡å½¢å¼åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>

                    <!-- è¾“å…¥å’Œæ§åˆ¶åŒºåŸŸ -->
                    <div class="video-call-bottom-area">
                        <div class="video-call-input-area">
                            <input type="text" id="video-call-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="video-call-text-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendVideoCallMessage(); }">
                            <button class="video-call-send-btn" onclick="sendVideoCallMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <div class="video-call-controls">
                            <button class="video-call-control-btn mute-btn" onclick="toggleVideoMute()" id="video-mute-btn">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="video-call-control-btn end-call-btn" onclick="endVideoCall()">
                                <i class="fas fa-phone" style="transform: rotate(135deg);"></i>
                            </button>
                            <button class="video-call-control-btn camera-btn" onclick="toggleVideoCamera()" id="video-camera-btn">
                                <i class="fas fa-video"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å­—ä½“ä¸å­—å·è®¾ç½® -->
                <div id="display-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('display-screen')">â€¹</button>
                            <div class="app-title">å­—ä½“ä¸å­—å·</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="font-size-preview">
                            <div class="font-size-preview-text" id="font-size-preview">
                                è¿™æ˜¯ä¸€æ®µç¤ºä¾‹æ–‡å­—ï¼Œç”¨äºé¢„è§ˆå­—ä½“å¤§å°æ•ˆæœã€‚è°ƒèŠ‚ä¸‹æ–¹æ»‘å—å¯ä»¥æ”¹å˜å­—ä½“å¤§å°ã€‚
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">å­—ä½“ä¸å­—å·</div>
                                    <div class="setting-desc">é€‰æ‹©å­—ä½“æ–‡ä»¶å¹¶è°ƒèŠ‚å…¨å±€å­—ä½“å¤§å°</div>
                                </div>
                            </div>
                        </div>

                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>å°</span>
                                <span>æ ‡å‡†</span>
                                <span>å¤§</span>
                            </div>
                            <input type="range" class="font-size-slider" id="font-size-slider"
                                   min="12" max="20" step="1" value="15"
                                   onchange="changeFontSize(this.value)">
                            <div class="font-size-value">
                                å½“å‰å­—å·ï¼š<span id="font-size-value">15px</span>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">å­—è·è®¾ç½®</div>
                                    <div class="setting-desc">è°ƒèŠ‚æ–‡å­—ä¹‹é—´çš„é—´è·</div>
                                </div>
                            </div>
                        </div>

                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>ç´§å‡‘</span>
                                <span>æ ‡å‡†</span>
                                <span>å®½æ¾</span>
                            </div>
                            <input type="range" class="font-size-slider" id="letter-spacing-slider"
                                   min="-0.5" max="2" step="0.1" value="0"
                                   onchange="changeLetterSpacing(this.value)">
                            <div class="font-size-value">
                                å½“å‰å­—è·ï¼š<span id="letter-spacing-value">æ ‡å‡†</span>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">è‡ªåŠ¨ç¼©æ”¾</div>
                                    <div class="setting-desc">æ ¹æ®å±å¹•å°ºå¯¸è‡ªåŠ¨è°ƒæ•´å­—ä½“å¤§å°</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="auto-scale-toggle" onchange="toggleAutoScale()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>

                        <!-- ğŸ”¥ã€æ–°å¢ã€‘è‡ªå®šä¹‰å­—ä½“è®¾ç½® -->
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">è‡ªå®šä¹‰å­—ä½“</div>
                                    <div class="setting-desc">ä½¿ç”¨åœ¨çº¿å­—ä½“é“¾æ¥è‡ªå®šä¹‰å…¨å±€å­—ä½“</div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-font-container">
                            <div class="form-group">
                                <label>å­—ä½“é“¾æ¥</label>
                                <input type="url" id="global-font-url" placeholder="æ”¯æŒCSSé“¾æ¥æˆ–TTF/OTF/WOFFå­—ä½“æ–‡ä»¶é“¾æ¥" class="form-input">
                                <div class="font-url-hint">
                                    <div>æ”¯æŒæ ¼å¼ï¼š</div>
                                    <div>â€¢ CSSé“¾æ¥ï¼šhttps://fontsapi.zeoseven.com/5/main/result.css</div>
                                    <div>â€¢ å­—ä½“æ–‡ä»¶ï¼šhttps://files.catbox.moe/fp15b6.ttf</div>
                                </div>
                            </div>

                            <div class="font-action-buttons">
                                <button type="button" class="font-button font-button-preview" onclick="previewGlobalFont()">
                                    <i class="fas fa-eye"></i> é¢„è§ˆå­—ä½“
                                </button>
                                <button type="button" class="font-button font-button-apply" onclick="applyGlobalFont()">
                                    <i class="fas fa-check"></i> åº”ç”¨å­—ä½“
                                </button>
                                <button type="button" class="font-button font-button-reset" onclick="resetGlobalFont()">
                                    <i class="fas fa-undo"></i> é‡ç½®å­—ä½“
                                </button>
                            </div>

                            <div id="global-font-status" class="font-status" style="display: none;">
                                <div class="font-status-text"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å±å¹•å°ºå¯¸è®¾ç½® -->
                <div id="screen-size-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('screen-size-screen')">â€¹</button>
                        <div class="app-title">å±å¹•å°ºå¯¸</div>
                    </div>
                    <div class="app-content">
                        <div class="size-option" onclick="changeScreenSize(350, 740, 'é€‚ä¸­å°ºå¯¸')" id="size-350-740">
                            <div class="size-option-left">
                                <div class="size-name">é€‚ä¸­å°ºå¯¸</div>
                                <div class="size-desc">350Ã—740 (æ¨è)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-s"></div>
                            </div>
                            <i class="fas fa-check check-icon"></i>
                        </div>

                        <div class="size-option" onclick="changeScreenSize(425, 860, 'iPhone 15')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15</div>
                                <div class="size-desc">425Ã—860 (é€‚é…æ‰‹æœº)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-l"></div>
                            </div>
                        </div>

                        <div class="size-option" onclick="changeScreenSize(450, 950, 'iPhone 15 Plus')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15 Plus</div>
                                <div class="size-desc">450Ã—950 (å¤§å±)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¤–è§‚è®¾ç½® -->
                <div id="appearance-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('appearance-screen')">â€¹</button>
                            <div class="app-title">å¤–è§‚è®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">å…¨å±æ˜¾ç¤º</div>
                                    <div class="setting-desc">è‡ªåŠ¨é€‚åº”æµè§ˆå™¨å±å¹•ï¼Œæ— è¾¹æ¡†å…¨å±æ•ˆæœ</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="phone-border-toggle" onchange="togglePhoneBorder()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="showScreenSizeOptions()">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">å±å¹•å°ºå¯¸</div>
                                    <div class="setting-desc" id="current-screen-size">å½“å‰ï¼š350Ã—740 (é€‚ä¸­å°ºå¯¸)</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <!-- ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸»å±å¹•å­—ä½“è®¾ç½® - æ”¹ä¸ºä¸‹æ‹‰èœå• -->
                        <div class="settings-item" style="position: relative;">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">ä¸»å±å¹•å­—ä½“</div>
                                    <div class="setting-desc">è®¾ç½®ä¸»å±å¹•å­—ä½“åŠç”µæ± çš„é¢œè‰²</div>
                                </div>
                            </div>
                            <div class="home-font-selector" onclick="toggleHomeFontDropdown()">
                                <span id="current-home-font-text">é»‘è‰²</span>
                                <i class="fas fa-chevron-down" id="home-font-arrow"></i>
                            </div>

                            <!-- ğŸ”¥ã€æ–°å¢ã€‘ä¸»å±å¹•å­—ä½“ä¸‹æ‹‰é€‰æ‹©èœå• -->
                            <div id="home-font-dropdown" class="home-font-dropdown" style="display: none;">
                                <div class="home-font-option selected" onclick="selectHomeFont('black')">
                                    <i class="fas fa-check"></i>
                                    <span>é»‘è‰²</span>
                                    <small>é€‚åˆæµ…è‰²å£çº¸</small>
                                </div>
                                <div class="home-font-option" onclick="selectHomeFont('white')">
                                    <i class="fas fa-check"></i>
                                    <span>ç™½è‰²</span>
                                    <small>é€‚åˆæ·±è‰²å£çº¸</small>
                                </div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">çŠ¶æ€æ å›¾æ ‡</div>
                                    <div class="setting-desc">è‡ªå®šä¹‰æ—¶é—´å³ä¾§æ˜¾ç¤ºçš„å›¾æ ‡æˆ–æ–‡å­—</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="status-icon-input" placeholder="è¾“å…¥" maxlength="5"
                                       style="width: 50px; padding: 6px 8px; border: 1px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
                                              border-radius: var(--theme-input-radius, 15px); background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
                                              font-size: 14px; text-align: center;"
                                       onchange="updateStatusIcon()">
                                <button onclick="resetStatusIcon()"
                                        style="padding: 6px 10px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8));
                                               border: 1px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1));
                                               border-radius: var(--theme-input-radius, 15px); color: var(--theme-button-secondary-color, #555);
                                               font-size: 12px; cursor: pointer; flex-shrink: 0;">
                                    é‡ç½®
                                </button>
                            </div>
                        </div>

                        <!-- ğŸ”¥ã€æ–°å¢ã€‘æ—¶é—´æ—¥æœŸæ ·å¼è®¾ç½® -->
                        <div class="settings-item" style="position: relative;">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">æ—¶é—´æ—¥æœŸæ ·å¼</div>
                                    <div class="setting-desc">é€‰æ‹©ä¸»å±å¹•æ—¶é—´æ—¥æœŸçš„æ˜¾ç¤ºé£æ ¼</div>
                                </div>
                            </div>
                            <div class="clock-style-selector" onclick="toggleClockStyleDropdown()">
                                <span id="current-clock-style-text">é»˜è®¤</span>
                                <i class="fas fa-chevron-down" id="clock-style-arrow"></i>
                            </div>

                            <!-- ğŸ”¥ã€æ–°å¢ã€‘ä¸‹æ‹‰é€‰æ‹©èœå• -->
                            <div id="clock-style-dropdown" class="clock-style-dropdown" style="display: none;">
                                <div class="clock-style-option selected" onclick="selectClockStyle('default')">
                                    <i class="fas fa-check"></i>
                                    <span>é»˜è®¤æ ·å¼</span>
                                    <small>ç»å…¸ç®€æ´çš„æ—¶é—´æ˜¾ç¤º</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('bold')">
                                    <i class="fas fa-check"></i>
                                    <span>ç²—ä½“æ ·å¼</span>
                                    <small>ç±»ä¼¼iPhoneé”å±çš„ç²—ä½“æ˜¾ç¤º</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('compact')">
                                    <i class="fas fa-check"></i>
                                    <span>ç´§å‡‘æ ·å¼</span>
                                    <small>ç±»ä¼¼Androidçš„ç®€æ´æ˜¾ç¤º</small>
                                </div>
                                <div class="clock-style-option" onclick="selectClockStyle('modern')">
                                    <i class="fas fa-check"></i>
                                    <span>ç°ä»£æ ·å¼</span>
                                    <small>ç±»ä¼¼å°ç±³MIUIçš„ç°ä»£è®¾è®¡</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- éŸ³æ•ˆè®¾ç½®ç•Œé¢ -->
                <div id="sound-settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('sound-settings-screen')">â€¹</button>
                            <div class="app-title">éŸ³æ•ˆè®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="form-container">
                            <!-- éŸ³æ•ˆå¼€å…³ -->
                            <div class="form-group">
                                <label class="switch-label">
                                    <span>å¯ç”¨éŸ³æ•ˆ</span>
                                    <input type="checkbox" id="sound-enabled" checked onchange="toggleSoundSystem()">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>

                            <!-- éŸ³æ•ˆè®¾ç½®åˆ—è¡¨ -->
                            <div id="sound-settings-list">
                                <!-- æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆ -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆ</h3>
                                        <p>è§’è‰²å‘æ¶ˆæ¯æ—¶æ’­æ”¾</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥" id="sound-messageReceived-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-messageReceived-file" style="display: none;" onchange="handleSoundFileUpload(this, 'messageReceived')">
                                        <button onclick="document.getElementById('sound-messageReceived-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                        </button>
                                        <button onclick="testSound('messageReceived')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> è¯•å¬
                                        </button>
                                        <button onclick="clearSound('messageReceived')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> æ¸…é™¤
                                        </button>
                                    </div>
                                </div>

                                <!-- å‘é€æ¶ˆæ¯éŸ³æ•ˆ -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>å‘é€æ¶ˆæ¯éŸ³æ•ˆ</h3>
                                        <p>ç”¨æˆ·å‘æ¶ˆæ¯æ—¶æ’­æ”¾</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥" id="sound-messageSent-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-messageSent-file" style="display: none;" onchange="handleSoundFileUpload(this, 'messageSent')">
                                        <button onclick="document.getElementById('sound-messageSent-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                        </button>
                                        <button onclick="testSound('messageSent')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> è¯•å¬
                                        </button>
                                        <button onclick="clearSound('messageSent')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> æ¸…é™¤
                                        </button>
                                    </div>
                                </div>

                                <!-- æ¶ˆæ¯æ¨é€éŸ³æ•ˆ -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>æ¶ˆæ¯æ¨é€éŸ³æ•ˆ</h3>
                                        <p>æ”¶åˆ°æ¨é€é€šçŸ¥æ—¶æ’­æ”¾</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥" id="sound-notification-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-notification-file" style="display: none;" onchange="handleSoundFileUpload(this, 'notification')">
                                        <button onclick="document.getElementById('sound-notification-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                        </button>
                                        <button onclick="testSound('notification')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> è¯•å¬
                                        </button>
                                        <button onclick="clearSound('notification')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> æ¸…é™¤
                                        </button>
                                    </div>
                                </div>

                                <!-- æ‹¨å‡ºé€šè¯éŸ³æ•ˆ -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>æ‹¨å‡ºé€šè¯éŸ³æ•ˆ</h3>
                                        <p>ç”¨æˆ·æ‹¨æ‰“è¯­éŸ³/è§†é¢‘é€šè¯æ—¶æ’­æ”¾</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥" id="sound-outgoingCall-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-outgoingCall-file" style="display: none;" onchange="handleSoundFileUpload(this, 'outgoingCall')">
                                        <button onclick="document.getElementById('sound-outgoingCall-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                        </button>
                                        <button onclick="testSound('outgoingCall')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> è¯•å¬
                                        </button>
                                        <button onclick="clearSound('outgoingCall')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> æ¸…é™¤
                                        </button>
                                    </div>
                                </div>

                                <!-- æ¥ç”µéŸ³æ•ˆ -->
                                <div class="sound-setting-item">
                                    <div class="sound-setting-header">
                                        <h3>æ¥ç”µéŸ³æ•ˆ</h3>
                                        <p>è§’è‰²æ‹¨æ‰“è¯­éŸ³/è§†é¢‘é€šè¯æ—¶æ’­æ”¾</p>
                                    </div>
                                    <div class="sound-setting-controls">
                                        <input type="url" placeholder="è¾“å…¥éŸ³æ•ˆé“¾æ¥" id="sound-incomingCall-url" class="sound-url-input">
                                        <input type="file" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" id="sound-incomingCall-file" style="display: none;" onchange="handleSoundFileUpload(this, 'incomingCall')">
                                        <button onclick="document.getElementById('sound-incomingCall-file').click()" class="sound-file-btn">
                                            <i class="fas fa-upload"></i> æœ¬åœ°æ–‡ä»¶
                                        </button>
                                        <button onclick="testSound('incomingCall')" class="sound-test-btn">
                                            <i class="fas fa-play"></i> è¯•å¬
                                        </button>
                                        <button onclick="clearSound('incomingCall')" class="sound-clear-btn">
                                            <i class="fas fa-trash"></i> æ¸…é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- è¯´æ˜æ–‡å­— -->
                            <div class="sound-settings-note">
                                <p><i class="fas fa-info-circle"></i> æ”¯æŒåœ¨çº¿é“¾æ¥å’Œæœ¬åœ°æ–‡ä»¶ï¼ˆæœ€å¤§3MBï¼‰</p>
                                <p><i class="fas fa-info-circle"></i> æ”¯æŒå¸¸è§éŸ³é¢‘æ ¼å¼ï¼šMP3ã€WAVã€OGGç­‰</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸»é¢˜è®¾ç½®ç•Œé¢ -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                    <div class="app-battery-icon">
                                        <div class="app-battery-level"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('theme-screen')">â€¹</button>
                            <div class="app-title">ä¸»é¢˜è®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default').catch(e => console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', e))">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ç®€çº¦é£æ ¼</div>
                                <div class="theme-description">æ¸…æ–°ç®€æ´çš„é»˜è®¤ä¸»é¢˜</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="changeTheme('cute').catch(e => console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', e))">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">å¯çˆ±é£æ ¼</div>
                                <div class="theme-description">æ¸©é¦¨å¯çˆ±çš„ç²‰è‰²ä¸»é¢˜</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="changeTheme('dark').catch(e => console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', e))">
                            <div class="theme-preview theme-preview-dark">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">å¤œé—´æ¨¡å¼</div>
                                <div class="theme-description">æŠ¤çœ¼çš„æ·±è‰²ä¸»é¢˜</div>
                            </div>
                        </div>

                        <div class="theme-option" onclick="showApp('custom-theme-screen')">
                            <div class="theme-preview theme-preview-custom">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <i class="fas fa-paint-brush"></i>
                                </div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">è‡ªå®šä¹‰ä¸»é¢˜</div>
                                <div class="theme-description">æ‰“é€ ä¸“å±çš„ä¸ªæ€§åŒ–ç•Œé¢</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰ä¸»é¢˜ç•Œé¢ -->
                <div id="custom-theme-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('custom-theme-screen')">â€¹</button>
                            <div class="app-title">è‡ªå®šä¹‰ä¸»é¢˜</div>
                        </div>
                    </div>
                    <div class="app-content custom-theme-content">
                        <!-- ä¸»é¢˜åˆ†ç±»é€‰é¡¹å¡ -->
                        <div class="custom-theme-tabs">
                            <div class="custom-theme-tab active" onclick="switchCustomThemeTab('chat')">
                                <i class="fas fa-comment-dots"></i>
                                <span>èŠå¤©ç•Œé¢</span>
                            </div>
                            <div class="custom-theme-tab" onclick="switchCustomThemeTab('global')">
                                <i class="fas fa-mobile-alt"></i>
                                <span>å…¨å±€ç•Œé¢</span>
                            </div>
                        </div>

                        <!-- èŠå¤©ç•Œé¢è‡ªå®šä¹‰ -->
                        <div id="chat-theme-content" class="custom-theme-content-pane">
                            <!-- èŠå¤©ç•Œé¢èƒŒæ™¯è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-image"></i>
                                    <span>ç•Œé¢èƒŒæ™¯</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadChatTopBackground()" id="chat-top-bg-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-maximize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯</div>
                                            <div class="theme-item-desc">åŒ…å«çŠ¶æ€æ å’Œæ ‡é¢˜æ </div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="chat-top-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="chat-top-bg-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadChatBottomBackground()" id="chat-bottom-bg-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-keyboard"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">åº•éƒ¨è¾“å…¥æ èƒŒæ™¯</div>
                                            <div class="theme-item-desc">è¾“å…¥æ¡†å’ŒæŒ‰é’®åŒºåŸŸ</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="chat-bottom-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="chat-bottom-bg-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- æŒ‰é’®è‡ªå®šä¹‰è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-mouse-pointer"></i>
                                    <span>æŒ‰é’®æ ·å¼</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('back')" id="back-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-arrow-left"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">è¿”å›æŒ‰é’®</div>
                                            <div class="theme-item-desc">èŠå¤©ç•Œé¢å·¦ä¸Šè§’è¿”å›æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="back-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="back-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('offline')" id="offline-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-door-open"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">çº¿ä¸‹æ¨¡å¼æŒ‰é’®</div>
                                            <div class="theme-item-desc">èŠå¤©ç•Œé¢çº¿ä¸‹æ¨¡å¼åˆ‡æ¢</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="offline-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="offline-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('settings')" id="settings-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-cog"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">èŠå¤©è®¾ç½®æŒ‰é’®</div>
                                            <div class="theme-item-desc">èŠå¤©ç•Œé¢å³ä¸Šè§’è®¾ç½®æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="settings-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="settings-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('expand')" id="expand-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">åŠŸèƒ½åŒºå±•å¼€æŒ‰é’®</div>
                                            <div class="theme-item-desc">åº•éƒ¨è¾“å…¥æ å·¦ä¾§å±•å¼€æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="expand-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="expand-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('continue')" id="continue-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-comment-dots"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">ç»­å†™æŒ‰é’®</div>
                                            <div class="theme-item-desc">è·å–AIå›å¤æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="continue-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="continue-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadButtonIcon('send')" id="send-btn-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">å‘é€æ¶ˆæ¯æŒ‰é’®</div>
                                            <div class="theme-item-desc">åº•éƒ¨è¾“å…¥æ å‘é€æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="send-btn-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="send-btn-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- åº”ç”¨èŒƒå›´è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-layer-group"></i>
                                    <span>åº”ç”¨èŒƒå›´</span>
                                </div>

                                <div class="theme-scope-options">
                                    <div class="theme-scope-option active" data-scope="selected">
                                        <i class="fas fa-users"></i>
                                        <span>é€‰æ‹©èŠå¤©çª—å£</span>
                                    </div>
                                    <div class="theme-scope-option" data-scope="all">
                                        <i class="fas fa-globe"></i>
                                        <span>æ‰€æœ‰èŠå¤©çª—å£</span>
                                    </div>
                                </div>

                                <!-- é€‰æ‹©èŠå¤©çª—å£åˆ—è¡¨ï¼ˆå½“é€‰æ‹©"é€‰æ‹©èŠå¤©çª—å£"æ—¶æ˜¾ç¤ºï¼‰ -->
                                <div id="chat-selection-list" class="chat-selection-list">
                                    <!-- èŠå¤©çª—å£åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>

                        <!-- å…¨å±€ç•Œé¢è‡ªå®šä¹‰ -->
                        <div id="global-theme-content" class="custom-theme-content-pane" style="display: none;">
                            <!-- å…¨å±€åº”ç”¨æ è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-window-maximize"></i>
                                    <span>åº”ç”¨æ æ ·å¼ï¼ˆæ’é™¤èŠå¤©ç•Œé¢ï¼‰</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalTopAppBar()" id="global-top-app-bar-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-maximize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">é¡¶éƒ¨åº”ç”¨æ </div>
                                            <div class="theme-item-desc">åº”ç”¨åˆ°é™¤APIèŠå¤©å’ŒçŸ­ä¿¡èŠå¤©ä»¥å¤–çš„æ‰€æœ‰åº”ç”¨é¡µé¡¶éƒ¨</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-top-app-bar-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-top-app-bar-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBottomAppBar()" id="global-bottom-app-bar-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-window-minimize"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">åº•éƒ¨åº”ç”¨æ </div>
                                            <div class="theme-item-desc">åº”ç”¨åˆ°é™¤APIèŠå¤©å’ŒçŸ­ä¿¡èŠå¤©ä»¥å¤–çš„æ‰€æœ‰åº”ç”¨é¡µåº•éƒ¨</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-bottom-app-bar-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-bottom-app-bar-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- æ ‡é¢˜æ æŒ‰é’®è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-mouse-pointer"></i>
                                    <span>æ ‡é¢˜æ æŒ‰é’®ï¼ˆæ’é™¤èŠå¤©ç•Œé¢ï¼‰</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBackButton()" id="global-back-button-item">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-arrow-left"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">è¿”å›æŒ‰é’®</div>
                                            <div class="theme-item-desc">åº”ç”¨åˆ°é™¤APIèŠå¤©å’ŒçŸ­ä¿¡èŠå¤©ä»¥å¤–çš„è¿”å›æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-back-button-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="theme-item-status" id="global-back-button-status" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalAddButton()">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">æ·»åŠ æŒ‰é’®</div>
                                            <div class="theme-item-desc">åº”ç”¨åˆ°é™¤APIèŠå¤©å’ŒçŸ­ä¿¡èŠå¤©ä»¥å¤–çš„æ·»åŠ æŒ‰é’®</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-add-button-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- å…¨å±€èƒŒæ™¯è®¾ç½® -->
                            <div class="custom-theme-section">
                                <div class="section-title">
                                    <i class="fas fa-image"></i>
                                    <span>åº”ç”¨èƒŒæ™¯ï¼ˆæ’é™¤èŠå¤©ç•Œé¢ï¼‰</span>
                                </div>

                                <div class="custom-theme-item" onclick="uploadGlobalBackground()">
                                    <div class="theme-item-left">
                                        <div class="theme-item-icon">
                                            <i class="fas fa-desktop"></i>
                                        </div>
                                        <div class="theme-item-info">
                                            <div class="theme-item-title">å…¨å±€åº”ç”¨èƒŒæ™¯</div>
                                            <div class="theme-item-desc">åº”ç”¨åˆ°é™¤APIèŠå¤©å’ŒçŸ­ä¿¡èŠå¤©ä»¥å¤–çš„æ‰€æœ‰åº”ç”¨ç•Œé¢</div>
                                        </div>
                                    </div>
                                    <div class="theme-item-preview" id="global-bg-preview">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </div>
                            </div>


                        </div>

                        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
                        <div class="custom-theme-actions">
                            <button class="theme-action-btn manage-btn" onclick="showThemeManagement().catch(e => console.error('æ˜¾ç¤ºä¸»é¢˜ç®¡ç†å¤±è´¥:', e))">
                                <i class="fas fa-cog"></i>
                                <span>ç®¡ç†</span>
                            </button>
                            <button class="theme-action-btn reset-btn" onclick="resetCustomTheme().catch(e => console.error('é‡ç½®ä¸»é¢˜å¤±è´¥:', e))">
                                <i class="fas fa-undo"></i>
                                <span>é‡ç½®</span>
                            </button>
                            <button class="theme-action-btn preview-btn" onclick="previewCustomTheme()">
                                <i class="fas fa-eye"></i>
                                <span>é¢„è§ˆ</span>
                            </button>
                            <button class="theme-action-btn apply-btn" onclick="applyCustomTheme().catch(e => console.error('åº”ç”¨ä¸»é¢˜å¤±è´¥:', e))">
                                <i class="fas fa-check"></i>
                                <span>åº”ç”¨</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å£çº¸è®¾ç½® -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('wallpaper-screen')">â€¹</button>
                            <div class="app-title">å£çº¸</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>é€‰æ‹©æ–°å£çº¸</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>æ›´æ”¹åº”ç”¨å›¾æ ‡</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>

                <!-- æ— çº¿å±€åŸŸç½‘è®¾ç½® -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">â€¹</button>
                        <div class="app-title">æ— çº¿å±€åŸŸç½‘</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>æ— çº¿å±€åŸŸç½‘</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>

                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>

                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>APIè®¾ç½®</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APIè®¾ç½®ç•Œé¢ -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-top-container">
                        <div class="app-status-bar">
                            <div class="app-status-time"></div>
                            <div class="app-status-right">
                                <div class="app-signal-icon signal-icon">
                                    <div class="signal-row">
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                        <div class="signal-bar"></div>
                                    </div>
                                </div>
                                <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="app-header">
                            <button class="back-button" onclick="backToSettings('api-settings-screen')">â€¹</button>
                            <div class="app-title">APIè®¾ç½®</div>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="form-container" style="color: #000000;">



                            <!-- å¿«é€Ÿè®¾ç½®å¡ç‰‡ -->
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="color: #333; margin-bottom: 15px; display: block; font-size: 16px; font-weight: 600;">ğŸš€ å¿«é€Ÿè®¾ç½®</label>

                                <!-- Geminiç›´è¿å¡ç‰‡ -->
                                <div style="margin-bottom: 12px; padding: 18px; background: linear-gradient(135deg, rgba(74, 132, 193, 0.1) 0%, rgba(74, 132, 193, 0.05) 100%); border: 2px solid rgba(74, 132, 193, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setGeminiDirect()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--theme-button-bg, #4a84c1);">ğŸŒŸ Gemini ç›´è¿</div>
                                            <div style="font-size: 13px; color: #666;">è‡ªåŠ¨é…ç½®Googleå®˜æ–¹APIï¼Œæ”¯æŒæœ€æ–°æ¨¡å‹</div>
                                        </div>
                                        <div style="background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);">ç‚¹å‡»é…ç½®</div>
                                    </div>
                            </div>

                                <!-- HuggingFaceåä»£å¡ç‰‡ -->
                                <div style="margin-bottom: 15px; padding: 18px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); border: 2px solid rgba(255, 193, 7, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setHuggingFaceProxy()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #f39c12;">ğŸ¤— HuggingFace åä»£</div>
                                            <div style="font-size: 13px; color: #666;">å¤šç§å¤§æ¨¡å‹ï¼Œæ”¯æŒClaudeç­‰</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);">ç‚¹å‡»é…ç½®</div>
                                    </div>
                            </div>

                                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                                    âš ï¸ ä½¿ç”¨å‰è¯·ç¡®ä¿æœ‰å¯¹åº”çš„APIå¯†é’¥
                                </div>
                            </div>

                            <!-- APIé…ç½®è¡¨å• - ç¾åŒ–ç‰ˆ -->
                            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">

                                <!-- APIåœ°å€ -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIåœ°å€</label>
                                    <input type="text" id="api-base" placeholder="ä¾‹å¦‚: https://api.openai.com æˆ– @https://xxx-xxx.hf.space/v1" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒæ ‡å‡†APIå’ŒHuggingFaceåä»£ï¼ˆæ ¼å¼ï¼š@https://xxx.hf.space/v1ï¼‰</div>
                            </div>

                                <!-- APIå¯†é’¥ -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIå¯†é’¥</label>
                                    <input type="password" id="api-key" placeholder="sk-... æˆ– Google AI Studio API Key" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                </div>

                                <!-- æ¨¡å‹é€‰æ‹© -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">æ¨¡å‹</label>
                                    <div style="display: flex; gap: 10px; align-items: center; width: 100%; overflow: hidden;">
                                        <select id="model-select" style="flex: 1; min-width: 0; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); max-height: 200px; overflow-y: auto;">
                                            <!-- æ¨¡å‹é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                                    </select>
                                        <button id="fetch-models-btn" onclick="fetchModels()" style="padding: 10px 16px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.3s ease; white-space: nowrap;">æ‹‰å–æ¨¡å‹</button>
                                </div>
                            </div>

                                <!-- æ¸©åº¦å‚æ•° -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">æ¸©åº¦å‚æ•° (<span id="temperature-value" style="color: var(--theme-button-bg, #4a84c1); font-weight: 700;">0.75</span>)</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" oninput="document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, rgba(74, 132, 193, 0.2) 0%, rgba(74, 132, 193, 0.4) 100%); outline: none; -webkit-appearance: none; appearance: none;">
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
                                            <span>0.00 (ä¿å®ˆ)</span>
                                            <span>1.00 (å¹³è¡¡)</span>
                                            <span>2.00 (åˆ›æ–°)</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">æ¸©åº¦è¶Šä½ï¼Œå›ç­”è¶Šä¿å®ˆç¨³å®šï¼›æ¸©åº¦è¶Šé«˜ï¼Œå›ç­”è¶Šæœ‰åˆ›æ„å¤šæ ·</div>
                                    </div>
                            </div>

                                <!-- è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½® -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">è¡¨æƒ…åŒ…è¯†åˆ«</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" id="emoji-recognition-enabled" style="width: 18px; height: 18px; accent-color: var(--theme-button-bg, #4a84c1);">
                                            <span style="font-size: 14px; color: var(--theme-text-primary, #333);">å¯ç”¨AIè¯†åˆ«è¡¨æƒ…åŒ…å›¾ç‰‡</span>
                                        </label>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; line-height: 1.4;">
                                            å…³é—­åï¼ŒAIå°†æ— æ³•è¯†åˆ«è¡¨æƒ…åŒ…å›¾ç‰‡å†…å®¹ï¼Œä½†ä»å¯è¯†åˆ«æ™®é€šå›¾ç‰‡ã€‚è¿™å¯ä»¥èŠ‚çœtokenæ¶ˆè€—ã€‚
                                        </div>
                                    </div>
                                </div>

                                <!-- æ“ä½œæŒ‰é’® -->
                                <div style="display: flex; gap: 12px; margin-top: 25px;">
                                    <button id="test-api-connection-btn" onclick="testApiConnection()" style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3); transition: all 0.3s ease;">æµ‹è¯•è¿æ¥</button>
                                    <button id="save-api-settings-btn" onclick="saveApiSettings()" style="flex: 1; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">ä¿å­˜è®¾ç½®</button>
                                </div>
                            </div>

                            <!-- APIé…ç½®ç®¡ç† -->
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eaeaea;">
                            <div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ’¾</span> APIé…ç½®ç®¡ç†
                                </h4>
                                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢ä¸åŒçš„APIæœåŠ¡</p>

                                <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                        <input type="text" id="config-name-input" placeholder="è¾“å…¥é…ç½®åç§° (å¦‚: OpenAIã€Geminiã€Claudeç­‰)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
                                        <button id="save-current-config-btn" onclick="saveCurrentConfig()" style="padding: 8px 16px; background: #e8ebf7; color: #5a6acf; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;">ä¿å­˜</button>
                        </div>
                                    <div style="font-size: 12px; color: #888;">å½“å‰é…ç½®å°†ä¿å­˜ä¸º: <span style="color: #333; font-weight: 500;">URL + æ¨¡å‹ + æ¸©åº¦è®¾ç½®</span></div>
                                </div>

                                <div class="saved-configs-section">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <label style="font-size: 14px; font-weight: 500; color: #333;">å·²ä¿å­˜çš„é…ç½®</label>
                                        <button id="clear-all-configs-btn" onclick="clearAllConfigs()" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
                                    </div>
                                    <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                                        <!-- ä¿å­˜çš„é…ç½®å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                    <div id="no-configs-message" style="text-align: center; color: #999; padding: 30px 20px; font-size: 14px; display: none;">
                                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“</div>
                                        <div>è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•é…ç½®</div>
                                        <div style="font-size: 12px; margin-top: 4px;">åœ¨ä¸Šæ–¹è¾“å…¥é…ç½®åç§°å¹¶ç‚¹å‡»"ä¿å­˜é…ç½®"</div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>

                <!-- è§’è‰²æ‰‹æœºç•Œé¢ -->
                <div id="character-phone-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-screen'); showApp('api-chat-screen');">â€¹</button>
                        <div class="app-title" id="character-phone-title">è§’è‰²æ‰‹æœº</div>
                    </div>

                    <div class="app-content character-phone-content">
                        <!-- æ‰‹æœºå†…å®¹åŒºåŸŸ -->
                        <div class="phone-content-area">
                            <!-- æ¶ˆæ¯å†…å®¹ -->
                            <div class="phone-tab-content" id="phone-messages-content">
                                <div class="phone-messages-list">
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">å°çº¢</div>
                                            <div class="phone-message-preview">ä»Šå¤©å¤©æ°”çœŸå¥½å‘¢~</div>
                                            <div class="phone-message-time">10:30</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">å°æ˜</div>
                                            <div class="phone-message-preview">å‘¨æœ«ä¸€èµ·å‡ºå»ç©å§</div>
                                            <div class="phone-message-time">æ˜¨å¤©</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-item">
                                        <div class="phone-message-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="phone-message-info">
                                            <div class="phone-message-name">å¦ˆå¦ˆ</div>
                                            <div class="phone-message-preview">è®°å¾—æŒ‰æ—¶åƒé¥­å“¦</div>
                                            <div class="phone-message-time">æ˜¨å¤©</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¤‡å¿˜å½•å†…å®¹ -->
                            <div class="phone-tab-content" id="phone-notes-content" style="display: none;">
                                <div class="phone-notes-list">
                                    <div class="phone-note-item" onclick="openPhoneNote('è´­ç‰©æ¸…å•')">
                                        <div class="phone-note-title">è´­ç‰©æ¸…å•</div>
                                        <div class="phone-note-preview">ç‰›å¥¶ã€é¢åŒ…ã€é¸¡è›‹...</div>
                                        <div class="phone-note-time">ä»Šå¤© 14:20</div>
                                    </div>
                                    <div class="phone-note-item" onclick="openPhoneNote('å·¥ä½œè®¡åˆ’')">
                                        <div class="phone-note-title">å·¥ä½œè®¡åˆ’</div>
                                        <div class="phone-note-preview">å®Œæˆé¡¹ç›®æŠ¥å‘Šï¼Œå‡†å¤‡ä¼šè®®...</div>
                                        <div class="phone-note-time">æ˜¨å¤© 16:45</div>
                                    </div>
                                    <div class="phone-note-item" onclick="openPhoneNote('è¯»ä¹¦ç¬”è®°')">
                                        <div class="phone-note-title">è¯»ä¹¦ç¬”è®°</div>
                                        <div class="phone-note-preview">ä»Šå¤©è¯»äº†ä¸€æœ¬å¾ˆæœ‰è¶£çš„ä¹¦...</div>
                                        <div class="phone-note-time">2å¤©å‰</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç›¸å†Œå†…å®¹ -->
                            <div class="phone-tab-content" id="phone-photos-content" style="display: none;">
                                <div class="phone-photos-grid">
                                    <div class="phone-photo-item" onclick="openPhonePhoto('æ˜¥æ—¥æ¨±èŠ±')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('å’–å•¡æ—¶å…‰')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('å¤•é˜³è¥¿ä¸‹')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('åŸå¸‚å¤œæ™¯')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('ç¾é£Ÿè®°å½•')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="phone-photo-item" onclick="openPhonePhoto('æ—…è¡Œå›å¿†')">
                                        <div class="phone-photo-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åº•éƒ¨æ ‡ç­¾é¡µ -->
                        <div class="phone-tabs">
                            <div class="phone-tab active" onclick="switchPhoneTab('messages')">
                                <i class="fas fa-comment"></i>
                                <span>æ¶ˆæ¯</span>
                            </div>
                            <div class="phone-tab" onclick="switchPhoneTab('notes')">
                                <i class="fas fa-sticky-note"></i>
                                <span>å¤‡å¿˜å½•</span>
                            </div>
                            <div class="phone-tab" onclick="switchPhoneTab('photos')">
                                <i class="fas fa-images"></i>
                                <span>ç›¸å†Œ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²æ‰‹æœºå¯¹è¯è¯¦æƒ…ç•Œé¢ -->
                <div id="character-phone-chat-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-chat-screen'); showApp('character-phone-screen');">â€¹</button>
                        <div class="app-title" id="phone-chat-contact-name">è”ç³»äºº</div>
                    </div>

                    <div class="app-content phone-chat-content">
                        <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
                        <div class="phone-chat-messages" id="phone-chat-messages">
                            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="phone-chat-input-area">
                            <div class="phone-chat-input-container">
                                <input type="text" class="phone-chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." readonly>
                                <button class="phone-chat-send-btn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²æ‰‹æœºå¤‡å¿˜å½•è¯¦æƒ…ç•Œé¢ -->
                <div id="character-phone-note-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-note-screen'); showApp('character-phone-screen');">â€¹</button>
                        <div class="app-title" id="phone-note-title">å¤‡å¿˜å½•</div>
                    </div>

                    <div class="app-content phone-note-detail-content">
                        <div class="phone-note-detail">
                            <div class="phone-note-detail-header">
                                <h2 id="phone-note-detail-title">å¤‡å¿˜å½•æ ‡é¢˜</h2>
                                <div class="phone-note-detail-time" id="phone-note-detail-time">æ—¶é—´</div>
                            </div>
                            <div class="phone-note-detail-body" id="phone-note-detail-body">
                                å¤‡å¿˜å½•å†…å®¹...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²æ‰‹æœºç…§ç‰‡è¯¦æƒ…ç•Œé¢ -->
                <div id="character-phone-photo-screen" class="app-screen" style="display: none;">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-status-right">
                            <div class="app-signal-icon signal-icon">
                                <div class="signal-row">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                            <div class="app-battery-container">
                                <div class="app-battery-icon">
                                    <div class="app-battery-level"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('character-phone-photo-screen'); showApp('character-phone-screen');">â€¹</button>
                        <div class="app-title">ç…§ç‰‡</div>
                    </div>

                    <div class="app-content phone-photo-detail-content">
                        <div class="phone-photo-detail">
                            <div class="phone-photo-detail-image" id="phone-photo-detail-image">
                                <div class="phone-photo-placeholder-large">
                                    <i class="fas fa-image"></i>
                                    <p>ç…§ç‰‡é¢„è§ˆ</p>
                                </div>
                            </div>
                            <div class="phone-photo-detail-info">
                                <div class="phone-photo-detail-title" id="phone-photo-detail-title">ç…§ç‰‡æ ‡é¢˜</div>
                                <div class="phone-photo-detail-time" id="phone-photo-detail-time">æ‹æ‘„æ—¶é—´</div>
                                <div class="phone-photo-detail-description" id="phone-photo-detail-description">ç…§ç‰‡æè¿°</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é¢œè‰²é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">é€‰æ‹©é¢œè‰²</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">é€æ˜åº¦</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">åº”ç”¨</button>
                        </div>
                    </div>
                </div>

                <!-- å£çº¸é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">é€‰æ‹©å£çº¸</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-preview-container" id="wallpaper-preview-container">
                                <div class="wallpaper-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <div>é€‰æ‹©æœ¬åœ°å›¾ç‰‡åå¯åœ¨æ­¤é¢„è§ˆ</div>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>ä»ç›¸å†Œé€‰æ‹©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">åº”ç”¨</button>
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡ä¸Šä¼ é€‰æ‹©æ¨¡æ€æ¡† -->
                <div class="modal" id="image-upload-choice-modal">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <div class="modal-title" id="image-upload-choice-title">é€‰æ‹©å›¾ç‰‡æ¥æº</div>
                            <button class="modal-close" onclick="hideModal('image-upload-choice-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="upload-choice-container">
                                <div class="upload-choice-option" onclick="chooseLocalUpload()">
                                    <div class="upload-choice-icon">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div class="upload-choice-text">
                                        <div class="upload-choice-title">æœ¬åœ°ä¸Šä¼ </div>
                                        <div class="upload-choice-desc">ä»è®¾å¤‡é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                                    </div>
                                </div>
                                <div class="upload-choice-option" onclick="chooseUrlUpload()">
                                    <div class="upload-choice-icon">
                                        <i class="fas fa-link"></i>
                                    </div>
                                    <div class="upload-choice-text">
                                        <div class="upload-choice-title">åœ¨çº¿å›¾åºŠ</div>
                                        <div class="upload-choice-desc">è¾“å…¥å›¾ç‰‡URLåœ°å€</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URLè¾“å…¥æ¨¡æ€æ¡† -->
                <div class="modal" id="url-input-modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title" id="url-input-title">è¾“å…¥å›¾ç‰‡URL</div>
                            <button class="modal-close" onclick="hideModal('url-input-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="url-input-container">
                                <label for="image-url-input">å›¾ç‰‡URLåœ°å€ï¼š</label>
                                <input type="url" id="image-url-input" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                                <div class="url-tips">
                                    <p><strong>æ”¯æŒçš„å›¾åºŠï¼š</strong></p>
                                    <ul>
                                        <li>PostImg: https://i.postimg.cc/...</li>
                                        <li>Catbox: https://files.catbox.moe/...</li>
                                        <li>ImgBB: https://i.ibb.co/...</li>
                                        <li>Imgur: https://i.imgur.com/...</li>
                                        <li>å…¶ä»–æ”¯æŒç›´é“¾çš„å›¾åºŠ</li>
                                    </ul>
                                </div>
                                <div class="url-preview" id="url-preview" style="display: none;">
                                    <img id="url-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('url-input-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="confirmUrlUpload()">ç¡®è®¤</button>
                        </div>
                    </div>
                </div>

                <!-- å›¾æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">æ›´æ”¹åº”ç”¨å›¾æ ‡</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- åº”ç”¨åˆ—è¡¨ -->
                            <div class="app-list-section">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">é€‰æ‹©è¦ä¿®æ”¹çš„åº”ç”¨</h4>
                                <div id="app-list-container" class="app-list-grid">
                                    <!-- åŠ¨æ€ç”Ÿæˆåº”ç”¨åˆ—è¡¨ -->
                                </div>
                            </div>

                            <!-- å›¾æ ‡ä¸Šä¼ åŒºåŸŸ -->
                            <div class="icon-upload-section" id="icon-upload-section" style="display: none;">
                                <h4 style="margin: 20px 0 15px 0; color: #333; font-size: 16px;">ä¸Šä¼ æ–°å›¾æ ‡</h4>
                                <div class="upload-area" onclick="triggerIconUpload()">
                                    <div class="upload-placeholder" id="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #999; margin-bottom: 10px;"></i>
                                        <div style="color: #666;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                                        <div style="color: #999; font-size: 12px; margin-top: 5px;">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                                    </div>
                                    <img id="icon-preview-img" class="icon-preview-img" style="display: none;">
                                </div>
                                <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" id="apply-icon-btn" onclick="applyIconChange()" style="display: none;">åº”ç”¨</button>
                        </div>
                    </div>
                </div>

                <!-- ç…§ç‰‡æ‹æ‘„æ¨¡æ€æ¡† -->






                <!-- èŠå¤©é€‰é¡¹æ¨¡æ€æ¡† -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">é€‰æ‹©èŠå¤©ç±»å‹</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">å•èŠ</div>
                                    <div class="chat-option-desc">ä¸å•ä¸ªè§’è‰²è¿›è¡Œå¯¹è¯</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">ç¾¤èŠ</div>
                                    <div class="chat-option-desc">ä¸å¤šä¸ªè§’è‰²åŒæ—¶èŠå¤©</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å•èŠè§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">é€‰æ‹©èŠå¤©è§’è‰²</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ç¾¤èŠè§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">åˆ›å»ºç¾¤èŠ</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ç¾¤èŠåç§°</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="ä¾‹å¦‚ï¼šåŠ¨æ€åˆ†äº«ã€å·¥ä½œç¾¤">
                            </div>
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©æˆå‘˜ (è‡³å°‘2äººï¼Œæœ€å¤š20äºº)</label>
                                <div id="group-chat-members">
                                    <!-- ç¾¤èŠæˆå‘˜é€‰æ‹©å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">åˆ›å»ºç¾¤èŠ</button>
                        </div>
                    </div>
                </div>

                <!-- å†å²æ¶ˆæ¯è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">å†å²æ¶ˆæ¯è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div class="setting-card" style="margin-bottom: 20px;">
                                <div class="setting-item" style="margin-bottom: 15px;">
                                    <div class="setting-left">
                                        <div class="setting-label" style="font-size: 16px; margin-bottom: 8px;">é™„å¸¦å†å²æ¶ˆæ¯æ•° (å›åˆæ•°)</div>
                                        <div class="setting-desc" style="font-size: 14px; line-height: 1.4;">AIå›å¤æ—¶å‚è€ƒçš„å†å²å¯¹è¯å›åˆæ•°</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display" style="font-size: 16px; font-weight: 600;">5å›åˆ</span>
                                    </div>
                                </div>
                                <div class="setting-range-container" style="margin-bottom: 15px;">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0å›åˆ</span>
                                        <span>100å›åˆ</span>
                                    </div>
                                </div>
                                <div class="custom-input-container" style="margin-bottom: 15px;">
                                    <span class="input-label">è‡ªå®šä¹‰æ•°å€¼ï¼š</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5" style="width: 80px; margin: 0 8px;">
                                    <span class="input-unit">å›åˆ (æœ€å¤§500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>è¯´æ˜ï¼š</strong><br>
                                        â€¢ ä¸€å›åˆ = ä½ çš„ä¸€æ¡æ¶ˆæ¯ + AIçš„ä¸€æ¡å›å¤<br>
                                        â€¢ è®¾ç½®ä¸º5è¡¨ç¤ºAIå›å¤æ—¶ä¼šå‚è€ƒæœ€è¿‘5å›åˆå¯¹è¯<br>
                                        â€¢ æ³¨æ„ï¼šæ•°å€¼è¿‡å¤§å¯èƒ½å½±å“APIå“åº”é€Ÿåº¦
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')" style="margin: 0; padding: 12px 20px;">å–æ¶ˆ</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()" style="margin: 0; padding: 12px 20px;">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- è®°å¿†æŒ‚è½½è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">è®°å¿†æŒ‚è½½è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    å¯ç”¨è®°å¿†æŒ‚è½½
                                </label>
                                <p class="small-text margin-top-5">
                                    å¼€å¯åï¼ŒAIä¼šå‚è€ƒå…¶ä»–èŠå¤©çª—å£çš„å¯¹è¯å†…å®¹ä½œä¸ºèƒŒæ™¯è®°å¿†
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">æ¯ä¸ªèŠå¤©æŒ‚è½½æ¡æ•°</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1æ¡</span>
                                    <span id="memory-mount-display">3æ¡</span>
                                    <span>20æ¡</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">é€‰æ‹©è¦æŒ‚è½½çš„èŠå¤©</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- èŠå¤©åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                <p class="small-text margin-top-8">
                                    é€‰æ‹©çš„èŠå¤©è®°å½•ä¼šä½œä¸ºèƒŒæ™¯ä¿¡æ¯æä¾›ç»™AIå‚è€ƒ
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- å¤´åƒè®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">åŒæ–¹å¤´åƒè®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">æˆ‘çš„å¤´åƒ (ä»…åœ¨æ­¤èŠå¤©çª—å£ç”Ÿæ•ˆ)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">ä¸Šä¼ å¤´åƒ</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">å¯¹æ–¹å¤´åƒ (ä»…åœ¨æ­¤èŠå¤©çª—å£ç”Ÿæ•ˆ)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">ä¸Šä¼ å¤´åƒ</button>
                                    <button class="upload-button clear-avatar-btn" onclick="clearAiChatAvatar()">æ¸…é™¤èŠå¤©å¤´åƒ</button>
                                </div>
                                <p class="small-text margin-top-5">
                                    æ³¨æ„ï¼šå¦‚æœè§’è‰²åœ¨èŠå¤©ä¸­æ›´æ¢äº†å¤´åƒï¼Œä¼šè¦†ç›–æ­¤è®¾ç½®ï¼Œç‚¹å‡»"æ¸…é™¤èŠå¤©å¤´åƒ"å¯é‡ç½®ä¸ºè§’è‰²å¡é»˜è®¤å¤´åƒ
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">å¤´åƒå½¢çŠ¶</label>
                                <div class="avatar-shape-options">
                                    <label class="shape-radio-option">
                                        <input type="radio" name="avatar-shape" value="circle" checked>
                                        <span class="shape-radio-text">åœ†å½¢</span>
                                    </label>
                                    <label class="shape-radio-option">
                                        <input type="radio" name="avatar-shape" value="rounded-square">
                                        <span class="shape-radio-text">æ–¹å½¢</span>
                                    </label>
                                </div>
                                <p class="small-text margin-top-5">
                                    é€‰æ‹©å¤´åƒåœ¨èŠå¤©ä¸­çš„æ˜¾ç¤ºå½¢çŠ¶
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    éšè—åŒæ–¹å¤´åƒ
                                </label>
                                <p class="small-text margin-top-5">
                                    å¼€å¯åï¼ŒèŠå¤©ç•Œé¢å°†ä¸æ˜¾ç¤ºä»»ä½•å¤´åƒ
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                æ³¨æ„ï¼šæ­¤è®¾ç½®ä»…å½±å“å½“å‰èŠå¤©çª—å£æ˜¾ç¤ºï¼Œä¸ä¼šåŒæ­¥ä¿®æ”¹è§’è‰²å¡æˆ–é¢å…·è®¾ç½®
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- æ˜µç§°è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">åŒæ–¹å¤‡æ³¨è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">æˆ‘çš„æ˜µç§° (ä»…åœ¨æ­¤èŠå¤©ä¸­æ˜¾ç¤º)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="è¾“å…¥ä½ åœ¨æ­¤èŠå¤©ä¸­çš„æ˜µç§°">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¯¹æ–¹æ˜µç§° (ä»…åœ¨æ­¤èŠå¤©ä¸­æ˜¾ç¤º)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="è¾“å…¥å¯¹æ–¹åœ¨æ­¤èŠå¤©ä¸­çš„æ˜µç§°">
                            </div>
                            <p class="small-text margin-top-10">
                                æ³¨æ„ï¼šæ­¤è®¾ç½®ä»…å½±å“å½“å‰èŠå¤©çª—å£æ˜¾ç¤ºï¼Œä¸ä¼šåŒæ­¥ä¿®æ”¹è§’è‰²å¡æˆ–é¢å…·è®¾ç½®ã€‚è§’è‰²ä¹Ÿå¯èƒ½æ ¹æ®å¿ƒæƒ…å’ŒèŠå¤©å†…å®¹è‡ªä¸»ä¿®æ”¹è‡ªå·±çš„æ˜µç§°ã€‚
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- æˆ³ä¸€æˆ³åç¼€è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">æˆ³ä¸€æˆ³åç¼€è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">æˆ‘çš„æˆ³ä¸€æˆ³åç¼€</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="ç•™ç©ºä¸ºæ— åç¼€ï¼ˆä¾‹å¦‚ï¼šçš„å°è„¸è›‹ï¼‰">
                                <p class="tiny-text margin-top-5">æ˜¾ç¤ºä¸ºï¼š[è§’è‰²å]æˆ³äº†æˆ³ä½ [åç¼€]ï¼Œç•™ç©ºåˆ™æ˜¾ç¤ºï¼š[è§’è‰²å]æˆ³äº†æˆ³ä½ </p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¯¹æ–¹æˆ³ä¸€æˆ³åç¼€</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="ç•™ç©ºä¸ºæ— åç¼€ï¼ˆä¾‹å¦‚ï¼šçš„å°æ‰‹ï¼‰">
                                <p class="tiny-text margin-top-5">æ˜¾ç¤ºä¸ºï¼šä½ æˆ³äº†æˆ³[è§’è‰²å][åç¼€]ï¼Œç•™ç©ºåˆ™æ˜¾ç¤ºï¼šä½ æˆ³äº†æˆ³[è§’è‰²å]</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©èƒŒæ™¯è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">èŠå¤©èƒŒæ™¯è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">èƒŒæ™¯é¢„è§ˆ</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">ç§»é™¤èƒŒæ™¯</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”¥ã€æ–°å¢ã€‘ç¾¤æˆå‘˜æ°”æ³¡é¢œè‰²è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="group-member-colors-modal" style="z-index: 10001;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ç¾¤æˆå‘˜æ°”æ³¡é¢œè‰²è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('group-member-colors-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-explanation">
                                <div class="explanation-text">ä¸ºæ¯ä¸ªç¾¤æˆå‘˜è®¾ç½®ç‹¬ç‰¹çš„æ°”æ³¡é¢œè‰²ï¼Œè®©ç¾¤èŠæ›´åŠ ç”ŸåŠ¨æœ‰è¶£ã€‚</div>
                            </div>
                            <div id="group-member-colors-list">
                                <!-- åŠ¨æ€ç”Ÿæˆç¾¤æˆå‘˜é¢œè‰²è®¾ç½®é¡¹ -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-member-colors-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveGroupMemberColors()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- æ°”æ³¡æ ·å¼è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">æ°”æ³¡æ ·å¼è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">é€‰æ‹©æ°”æ³¡æ ·å¼</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">é»˜è®¤æ ·å¼</div>
                                            <div class="preview-bubble received-preview">ç»å…¸åœ†è§’</div>
                                        </div>
                                        <div class="style-name">é»˜è®¤æ ·å¼</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">ç»å…¸é˜´å½±</div>
                                            <div class="preview-bubble received-preview">ç«‹ä½“æ„Ÿ</div>
                                        </div>
                                        <div class="style-name">ç»å…¸é˜´å½±</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">å¸¦å°–è§’</div>
                                            <div class="preview-bubble received-preview">æ°”æ³¡æˆ³</div>
                                        </div>
                                        <div class="style-name">ç»å…¸æ°”æ³¡</div>
                                    </div>

                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">çº¸å¼ å¡ç‰‡</div>
                                            <div class="preview-bubble received-preview">è´¨æ„Ÿ</div>
                                        </div>
                                        <div class="style-name">çº¸å¼ æ ·å¼</div>
                                    </div>
                                </div>
                            </div>

                            <div class="color-setting-group">
                                <label class="form-label">è‡ªå®šä¹‰é¢œè‰²</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">æˆ‘çš„æ°”æ³¡</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">å¯¹æ–¹æ°”æ³¡</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                            <!-- ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠè§’è‰²å•ç‹¬è®¾ç½®æŒ‰é’® -->
                                            <div id="group-member-colors-btn" style="display: none; margin-top: 8px;">
                                                <button type="button" class="theme-button theme-button-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="showGroupMemberColorSettings()">
                                                    ä¸ºç¾¤æˆå‘˜å•ç‹¬è®¾ç½®
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">æˆ‘çš„æ°”æ³¡é€æ˜åº¦ï¼š<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">å¯¹æ–¹æ°”æ³¡é€æ˜åº¦ï¼š<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>

                                <div class="padding-setting">
                                    <label class="form-label">æ°”æ³¡å¤§å°è°ƒèŠ‚</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">å†…è¾¹è·ï¼š<span id="bubble-padding-value">ä¸­ç­‰</span></label>
                                            <input type="range" id="bubble-padding" min="4" max="16" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        è°ƒæ•´æ°”æ³¡å†…æ–‡å­—ä¸è¾¹ç¼˜çš„è·ç¦»ï¼Œæ•°å€¼è¶Šå¤§æ°”æ³¡è¶Šå¤§
                                    </p>
                                </div>
                            </div>

                            <!-- è‡ªå®šä¹‰CSS -->
                            <div class="custom-css-section">
                                <label class="form-label">è‡ªå®šä¹‰CSSæ ·å¼</label>
                                <textarea id="custom-bubble-css" placeholder="è¾“å…¥è‡ªå®šä¹‰CSSä»£ç ...

ç¤ºä¾‹ï¼ˆä½¿ç”¨æ ‡å‡†é€‰æ‹©å™¨ï¼‰ï¼š
/* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ */
.message-container.sent .message-bubble {
    background: linear-gradient(45deg, #007AFF, #5AC8FA) !important;
    border-radius: 20px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

/* AIæ¶ˆæ¯æ°”æ³¡ */
.message-container.received .message-bubble {
    background: #f0f0f0 !important;
    border-radius: 20px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* æ¶ˆæ¯å®¹å™¨ */
.message-container {
    margin-bottom: 10px !important;
}" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;" oninput="updatePreview()"></textarea>
                            </div>

                            <!-- å®æ—¶é¢„è§ˆ -->
                            <div class="preview-section">
                                <label class="form-label">å®æ—¶é¢„è§ˆ</label>
                                <div class="preview-container" id="bubble-preview">
                                    <div class="preview-chat">
                                        <!-- AIæ¶ˆæ¯ - ä½¿ç”¨ä¸å®é™…èŠå¤©ç•Œé¢ä¸€è‡´çš„ç»“æ„ -->
                                        <div class="message-container received">
                                            <div class="message-avatar">AI</div>
                                            <div class="message-bubble" id="preview-ai">
                                                è¿™æ˜¯è§’è‰²å‘é€çš„æ¶ˆæ¯é¢„è§ˆ
                                            </div>
                                        </div>
                                        <!-- ç”¨æˆ·æ¶ˆæ¯ - ä½¿ç”¨ä¸å®é™…èŠå¤©ç•Œé¢ä¸€è‡´çš„ç»“æ„ -->
                                        <div class="message-container sent">
                                            <div class="message-bubble" id="preview-user">
                                                è¿™æ˜¯ç”¨æˆ·å‘é€çš„æ¶ˆæ¯é¢„è§ˆ
                                            </div>
                                            <div class="message-avatar">æˆ‘</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- å®šæ—¶å‘å¸ƒè®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">å®šæ—¶å‘å¸ƒè®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    å¯ç”¨å®šæ—¶å‘å¸ƒ
                                </label>
                                <p class="small-text margin-top-5">
                                    å¼€å¯åï¼Œè§’è‰²ä¼šåœ¨æŒ‡å®šæ—¶é—´ç‚¹è‡ªåŠ¨å‘å¸ƒç¤¾äº¤åŠ¨æ€
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">å‘å¸ƒæ—¶é—´ç‚¹</label>
                                <div id="schedule-times-container">
                                    <!-- æ—¶é—´ç‚¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ æ·»åŠ æ—¶é—´ç‚¹</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- èº«ä»½é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
                <!-- èº«ä»½é€‰æ‹©æ¨¡æ€æ¡†å·²ç§»é™¤ï¼Œèº«ä»½åœ¨åˆ›å»ºå¯¹è¯æ—¶é€‰æ‹© -->

                <!-- ä¸–ç•Œä¹¦æŒ‚è½½è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ä¸–ç•Œä¹¦æŒ‚è½½è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    å¯ç”¨ä¸–ç•Œä¹¦æŒ‚è½½
                                </label>
                                <p class="small-text margin-top-5">
                                    å¼€å¯åï¼ŒAIä¼šå‚è€ƒé€‰å®šçš„ä¸–ç•Œä¹¦å†…å®¹ä½œä¸ºèƒŒæ™¯çŸ¥è¯†è¿›è¡Œå¯¹è¯
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">é€‰æ‹©è¦æŒ‚è½½çš„ä¸–ç•Œä¹¦</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- ä¸–ç•Œä¹¦åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                <p class="small-text margin-top-8">
                                    é€‰æ‹©çš„ä¸–ç•Œä¹¦å†…å®¹ä¼šä½œä¸ºèƒŒæ™¯çŸ¥è¯†æä¾›ç»™AIå‚è€ƒï¼Œå¸®åŠ©AIæ›´å¥½åœ°ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
                                    â€¢ <strong>ä¸–ç•Œä¹¦æŒ‚è½½ï¼š</strong>å°†é€‰å®šçš„ä¸–ç•Œä¹¦å†…å®¹ä½œä¸ºAIçš„èƒŒæ™¯çŸ¥è¯†<br>
                                    â€¢ <strong>å¤šé€‰æ”¯æŒï¼š</strong>å¯ä»¥åŒæ—¶æŒ‚è½½å¤šä¸ªä¸–ç•Œä¹¦ï¼Œå†…å®¹ä¼šåˆå¹¶ä½¿ç”¨<br>
                                    â€¢ <strong>æ™ºèƒ½åº”ç”¨ï¼š</strong>AIä¼šæ ¹æ®å¯¹è¯å†…å®¹æ™ºèƒ½å¼•ç”¨ç›¸å…³çš„ä¸–ç•Œä¹¦çŸ¥è¯†<br>
                                    â€¢ <strong>ä¼˜å…ˆçº§ï¼š</strong>ä¸–ç•Œä¹¦çŸ¥è¯†ä¼˜å…ˆçº§ä½äºè§’è‰²è®¾å®šå’Œå†å²å¯¹è¯
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')" style="margin: 0; padding: 12px 20px;">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()" style="margin: 0; padding: 12px 20px;">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- è¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="emoji-library-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">è¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('emoji-library-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="emoji-library-mount-enabled" class="checkbox-with-margin" onchange="toggleEmojiLibraryMountDetails()">
                                    å¯ç”¨è¡¨æƒ…åŒ…åº“æŒ‚è½½
                                </label>
                                <p class="small-text margin-top-5">
                                    å¼€å¯åï¼ŒèŠå¤©ä¸­çš„è¡¨æƒ…åŒ…é¢æ¿åªæ˜¾ç¤ºé€‰å®šåº“ä¸­çš„è¡¨æƒ…åŒ…
                                </p>
                            </div>
                            <div id="emoji-library-mount-details" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">é€‰æ‹©è¡¨æƒ…åŒ…åº“</label>
                                    <div id="emoji-library-mount-list" class="checkbox-list">
                                        <!-- è¡¨æƒ…åŒ…åº“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                    <p class="small-text margin-top-5">
                                        å¯ä»¥é€‰æ‹©å¤šä¸ªè¡¨æƒ…åŒ…åº“ï¼Œå®ƒä»¬çš„è¡¨æƒ…åŒ…ä¼šåˆå¹¶æ˜¾ç¤º
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 20px; gap: 0;">
                            <button class="modal-button modal-secondary" onclick="hideModal('emoji-library-mount-modal')" style="margin: 0; padding: 12px 20px;">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveEmojiLibraryMountSettings()" style="margin: 0; padding: 12px 20px;">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <!-- æœç´¢èŠå¤©å†…å®¹æ¨¡æ€æ¡† -->
                <div class="modal" id="search-chat-modal">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <div class="modal-title">æŸ¥æ‰¾èŠå¤©å†…å®¹</div>
                            <button class="modal-close" onclick="hideModal('search-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">æœç´¢å…³é”®è¯</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="search-keyword-input" placeholder="è¾“å…¥è¦æœç´¢çš„å…³é”®è¯..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <button onclick="performChatSearch()" style="padding: 8px 16px; background: #4a84c1; color: white; border: none; border-radius: 6px; cursor: pointer;">æœç´¢</button>
                                </div>
                            </div>

                            <div id="search-results-summary" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                                <div id="search-stats"></div>
                            </div>

                            <div id="search-results-container" style="border: 1px solid #eee; border-radius: 6px; display: none;">
                                <div id="search-results-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¶ˆæ¯ä¸Šä¸‹æ–‡æ¨¡æ€æ¡† -->
                <div class="modal" id="message-context-modal">
                    <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                        <div class="modal-header">
                            <div class="modal-title">æ¶ˆæ¯ä¸Šä¸‹æ–‡</div>
                            <button class="modal-close" onclick="hideModal('message-context-modal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div id="message-context-container" style="border: 1px solid #eee; border-radius: 6px; padding: 15px;">
                                <!-- ä¸Šä¸‹æ–‡æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ—¶é—´æˆ³è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">æ—¶é—´æˆ³è®¾ç½®</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    æ˜¾ç¤ºæ—¶é—´æˆ³
                                </label>
                                <p class="small-text margin-top-5">
                                    åœ¨èŠå¤©æ¶ˆæ¯ä¸­æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
                                </p>
                            </div>

                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">æ—¶é—´æˆ³ä½ç½®</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">å±…ä¸­æ˜¾ç¤º</div>
                                            <div class="option-desc">æ—¶é—´æˆ³æ˜¾ç¤ºåœ¨èŠå¤©ä¸­é—´ï¼Œæ¯5åˆ†é’Ÿå‡ºç°ä¸€æ¬¡</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">æ°”æ³¡å¤–ä¾§</div>
                                            <div class="option-desc">æ—¶é—´æˆ³æ˜¾ç¤ºåœ¨æ¯æ¡æ¶ˆæ¯æ°”æ³¡çš„å¤–ä¾§</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">å¤´åƒä¸‹æ–¹</div>
                                            <div class="option-desc">æ—¶é—´æˆ³æ˜¾ç¤ºåœ¨å¤´åƒæ­£ä¸‹æ–¹ä½ç½®</div>
                                        </div>
                                    </label>

                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">æ°”æ³¡å†…</div>
                                            <div class="option-desc">æ—¶é—´æˆ³æ˜¾ç¤ºåœ¨æ°”æ³¡å†…å³ä¸‹è§’ï¼Œä¸æ–‡å­—é½å¹³</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>ä½ç½®è¯´æ˜ï¼š</strong><br>
                                    â€¢ <strong>å±…ä¸­æ˜¾ç¤ºï¼š</strong>æ—¶é—´æˆ³æ°´å¹³å±…ä¸­ï¼Œä»…åœ¨è¶…è¿‡5åˆ†é’Ÿé—´éš”æ—¶æ˜¾ç¤º<br>
                                    â€¢ <strong>æ°”æ³¡å¤–ä¾§ï¼š</strong>æ¯æ¡æ¶ˆæ¯éƒ½æ˜¾ç¤ºæ—¶é—´ï¼Œç”¨æˆ·æ¶ˆæ¯åœ¨å·¦ä¸‹è§’ï¼Œè§’è‰²æ¶ˆæ¯åœ¨å³ä¸‹è§’<br>
                                    â€¢ <strong>å¤´åƒä¸‹æ–¹ï¼š</strong>æ—¶é—´æˆ³æ˜¾ç¤ºåœ¨å¯¹åº”å¤´åƒçš„æ­£ä¸‹æ–¹ä½ç½®<br>
                                    â€¢ æ‰€æœ‰æ—¶é—´æˆ³å‡ä½¿ç”¨ç°è‰²å°å­—æ˜¾ç¤ºï¼Œä¸å½±å“èŠå¤©ä½“éªŒ
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- è½¬è´¦åŠŸèƒ½ç›¸å…³æ¨¡æ€æ¡† -->
    <div id="transfer-modal">
        <div class="transfer-content">
                            <div class="transfer-header">å‘èµ·è½¬è´¦</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                                    <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                                    <input type="text" id="transfer-note" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">æ”¶åˆ°ä¸€ç¬”è½¬è´¦</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">Â¥ 0.00</div>
                <div class="transfer-confirm-note">å¤‡æ³¨ï¼š</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">é€€å›</button>
                <button id="transfer-accept-btn">ç¡®è®¤æ”¶æ¬¾</button>
                </div>
            </div>
        </div>



    <!-- æ’­æ”¾åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="playlist-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>æ’­æ”¾åˆ—è¡¨</h3>
                <button class="close-btn" onclick="closePlaylistModal()">&times;</button>
            </div>

            <div class="playlist-content">
                <!-- æ·»åŠ æ­Œæ›²åŒºåŸŸ -->
                <div class="add-song-section">
                    <h4>æ·»åŠ æ–°æ­Œæ›²</h4>
                    <div class="input-row">
                        <input type="text" id="song-title-input" placeholder="æ­Œæ›²æ ‡é¢˜" class="song-input half-width">
                        <input type="text" id="song-artist-input" placeholder="è‰ºæœ¯å®¶" class="song-input half-width">
                    </div>
                    <div class="input-row">
                        <input type="text" id="song-url-input" placeholder="æ­Œæ›²URLæˆ–é€‰æ‹©æœ¬åœ°æ–‡ä»¶" class="song-input half-width">
                        <div class="file-input-wrapper half-width">
                            <button onclick="document.getElementById('local-music-input').click()" class="upload-btn" style="width: 100%; padding: 8px;">
                                <i class="fas fa-file-audio"></i> æœ¬åœ°éŸ³ä¹
                            </button>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="file-input-wrapper half-width">
                            <input type="file" id="song-cover-input" accept="image/*,.jpg,.jpeg,.png,.gif,.webp" class="file-input" title="é€‰æ‹©å°é¢å›¾ç‰‡">
                            <span class="file-input-text">æœªé€‰å°é¢</span>
                        </div>
                        <div class="file-input-wrapper half-width">
                            <button onclick="document.getElementById('lyrics-file-input').click()" class="upload-btn" style="width: 100%; padding: 8px;">
                                <i class="fas fa-file-text"></i> æ­Œè¯æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                    <div class="lyrics-input-section">
                        <div id="lyrics-file-status" style="display: none; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background-color: #f8f9fa; color: #007AFF; font-size: 14px; text-align: center;">
                            <!-- é€‰æ‹©æ­Œè¯æ–‡ä»¶åæ˜¾ç¤ºçŠ¶æ€ -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; font-size: 11px; color: #666;">
                            <span>æ”¯æŒæ ¼å¼ï¼šLRCã€TXTã€binç­‰æ­Œè¯æ–‡ä»¶ï¼ˆiPhoneç”¨æˆ·å¯é€‰æ‹©ä»»æ„æ–‡ä»¶ï¼‰</span>
                        </div>
                        <div style="margin-top: 6px; font-size: 11px; color: #666;">
                            <span>ğŸ’¡ æ¨èä½¿ç”¨åœ¨çº¿URLï¼Œå¯¼å…¥æœ¬åœ°æ­Œæ›²å¯èƒ½ä¼šå¸¦æ¥å†…å­˜è´Ÿæ‹…</span>
                        </div>
                    </div>
                    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                    <input type="file" id="local-music-input" accept="audio/*,.mp3,.m4a,.wav,.aac,.ogg,.flac" style="display: none;">
                    <input type="file" id="lyrics-file-input" style="display: none;">
                    <button onclick="addCustomSong()" class="add-song-btn">
                        æ·»åŠ æ­Œæ›²
                    </button>
                </div>

                <!-- å½“å‰æ’­æ”¾åˆ—è¡¨ -->
                <div class="current-playlist">
                    <h4>å½“å‰æ’­æ”¾åˆ—è¡¨</h4>
                    <div id="playlist-items" class="playlist-items">
                        <!-- æ’­æ”¾åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- éŸ³ä¹æ’­æ”¾æ¨¡æ€æ¡† -->
    <div id="music-modal" class="music-modal" style="display: none;">
        <div class="music-modal-content">
            <div class="music-modal-header">
                <button class="music-modal-close" onclick="closeMusicModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="music-header-title">æ­£åœ¨æ’­æ”¾</div>
                <button class="music-view-toggle" onclick="toggleMusicView()" id="view-toggle-btn">
                    <i class="fas fa-list"></i>
                </button>
            </div>

            <div class="music-modal-body">
                <!-- å”±ç‰‡æœºæ¨¡å¼ -->
                <div id="vinyl-mode" class="music-view-mode">
                    <div class="vinyl-player">
                        <div class="vinyl-container">
                            <div class="vinyl-disc" id="vinyl-disc">
                                <div class="vinyl-grooves"></div>
                                <div class="vinyl-center"></div>
                                <div class="vinyl-label">
                                    <img id="album-cover" class="album-cover-display" style="display: none;" />
                                    <!-- åªæ˜¾ç¤ºå°é¢ï¼Œä¸æ”¯æŒç‚¹å‡»ä¸Šä¼  -->
                                </div>
                            </div>
                            <div class="tonearm" id="tonearm"></div>
                        </div>

                        <div class="song-info">
                            <div class="song-title" id="vinyl-song-title">é€‰æ‹©æ­Œæ›²</div>
                            <div class="song-artist" id="vinyl-artist-name">æœªçŸ¥è‰ºæœ¯å®¶</div>
                        </div>

                        <div class="vinyl-lyrics">
                            <div class="lyrics-container">
                                <div class="lyric-line active" id="lyric-current">ç‚¹å‡»æ’­æ”¾å¼€å§‹å¬æ­Œ</div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- å®Œæ•´æ­Œè¯æ¨¡å¼ -->
                <div id="lyrics-mode" class="music-view-mode" style="display: none;">
                    <div class="lyrics-mode">
                        <div class="lyrics-header">
                            <div class="song-title" id="lyrics-song-title">é€‰æ‹©æ­Œæ›²</div>
                            <div class="song-artist" id="lyrics-artist-name">æœªçŸ¥è‰ºæœ¯å®¶</div>
                        </div>
                        <div class="full-lyrics-container">
                            <div class="full-lyrics" id="full-lyrics-display">
                                <div class="lyric-line active">â™ª ç‚¹å‡»æ’­æ”¾å¼€å§‹å¬æ­Œ</div>
                                <div class="lyric-line">é€‰æ‹©ä½ å–œæ¬¢çš„æ­Œæ›²</div>
                                <div class="lyric-line">å’Œè§’è‰²ä¸€èµ·äº«å—éŸ³ä¹æ—¶å…‰</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="music-modal-controls">
                <!-- å½“å‰æ­Œè¯æ˜¾ç¤º -->
                <div class="current-lyric-display">
                    <div class="current-lyric-text" id="current-lyric-text">â™ª ç‚¹å‡»æ’­æ”¾å¼€å§‹å¬æ­Œ</div>
                </div>

                <div class="music-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="modal-progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="modal-current-time">0:00</span>
                        <span id="modal-total-time">0:00</span>
                    </div>
                </div>

                <div class="music-control-buttons">
                    <button class="control-btn shuffle" id="play-mode-btn" onclick="togglePlayMode()" title="é¡ºåºæ’­æ”¾">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    <button class="control-btn" onclick="previousTrack()" title="ä¸Šä¸€é¦–">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause-btn" id="modal-play-btn" onclick="togglePlayback()" title="æ’­æ”¾/æš‚åœ">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" onclick="nextTrack()" title="ä¸‹ä¸€é¦–">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn playlist" id="playlist-btn" onclick="openPlaylistModal()" title="æ’­æ”¾åˆ—è¡¨">
                        <i class="fas fa-music"></i>
                    </button>
                </div>

                <div class="listening-time">
                    <i class="fas fa-clock"></i>
                    <span id="listening-duration">å·²ä¸€èµ·å¬ 0 åˆ†é’Ÿ</span>
                </div>
            </div>

            <!-- å…³é—­æŒ‰é’® - å…³æœºæŒ‰é’®æ ·å¼ -->
            <button class="music-close-btn" onclick="closeMusicPlayer()" title="ç»“æŸå¬æ­Œ">
                <i class="fas fa-power-off"></i>
            </button>


        </div>
    </div>

<script>
    // ===============================================================
    // ğŸ”¥ å‘å¸ƒå‰å¼€å…³ï¼šå°†ä¸‹æ–¹ true æ”¹ä¸º false å³å¯å±è”½æ‰€æœ‰è°ƒè¯•ä¿¡æ¯
    // ===============================================================
    const isProduction = false; 

    if (isProduction) {
        console.log = function() {};    // å±è”½ console.log
        console.info = function() {};   // å±è”½ console.info
        console.warn = function() {};   // å±è”½ console.warn
        // æ³¨æ„ï¼šæˆ‘ä»¬é€šå¸¸ä¿ç•™ console.error ä»¥ä¾¿è¿½è¸ªé‡è¦é”™è¯¯
    }
</script>

    <script>
        // ğŸ”¥ã€æ–°å¢ä¿®å¤ã€‘å®šä¹‰ä¸€ä¸ªPromiseæ¥ç¡®ä¿æ•°æ®å®Œå…¨åŠ è½½åå†æ‰§è¡Œåç»­æ“ä½œ
        let dataLoadedPromise;
        let resolveDataLoaded;

        function initializeDataLoadPromise() {
            dataLoadedPromise = new Promise(resolve => {
                resolveDataLoaded = resolve;
            });
        }

        // ğŸ”¥ã€å®Œå…¨ä¿®å¤ã€‘åˆå§‹åŒ–Dexieæ•°æ®åº“ - è§£å†³ç‰ˆæœ¬å‡çº§æ­»å¾ªç¯é—®é¢˜
        window.db = new Dexie('PhoneChatDB');
        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åˆ›å»ºå…¨å±€åˆ«åï¼Œç¡®ä¿æ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ•°æ®åº“
        var db = window.db;
        window.activeGlobalWorldbooks = []; // ç”¨äºå­˜å‚¨å½“å‰æ¿€æ´»çš„å…¨å±€ä¸–ç•Œä¹¦ID

        // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®åº“é‡ç½®åŠŸèƒ½
        async function resetDatabase() {
            try {
                console.log('ğŸ”„ å¼€å§‹é‡ç½®æ•°æ®åº“...');

                // å…³é—­æ•°æ®åº“è¿æ¥
                if (db.isOpen()) {
                    db.close();
                }

                // åˆ é™¤æ•°æ®åº“
                await db.delete();
                console.log('âœ… æ•°æ®åº“å·²åˆ é™¤');

                // é‡æ–°æ‰“å¼€æ•°æ®åº“ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ï¼‰
                await db.open();
                console.log('âœ… æ•°æ®åº“å·²é‡æ–°åˆ›å»º');

                return true;
            } catch (error) {
                console.error('âŒ é‡ç½®æ•°æ®åº“å¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
        async function checkDatabaseHealth() {
            try {
                await db.open();

                // æµ‹è¯•åŸºæœ¬è¡¨è®¿é—®
                const testTables = ['characters', 'chatMessages', 'apiSettings'];
                for (const tableName of testTables) {
                    await db[tableName].count();
                }

                console.log('âœ… æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡');
                return true;
            } catch (error) {
                console.error('âŒ æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        // å…¨å±€å˜é‡
        let characters = [];
        let contacts = [];
        let currentChatCharacter = null;
        let chatMessages = {};
        let selectedMessageId = null;
        let pinnedConversations = []; // ğŸ”¥ã€æ–°å¢ã€‘ç½®é¡¶å¯¹è¯åˆ—è¡¨
        let personas = []; // ç”¨æˆ·é¢å…·åˆ—è¡¨
        let editingPersona = null; // æ­£åœ¨ç¼–è¾‘çš„é¢å…·
        let isMultiSelectMode = false; // å¤šé€‰æ¨¡å¼çŠ¶æ€
        let selectedCharacters = []; // é€‰ä¸­çš„è§’è‰²IDåˆ—è¡¨
        let currentEditingCharacterId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„è§’è‰²ID
        let groupChats = []; // ç¾¤èŠåˆ—è¡¨

        // ğŸ”¥ã€æ–°å¢ã€‘éŸ³æ•ˆç®¡ç†ç³»ç»Ÿ
        const SoundManager = {
            sounds: {},
            characterSounds: {}, // è§’è‰²ä¸“å±éŸ³æ•ˆç¼“å­˜
            enabled: true,
            currentlyPlaying: {}, // ğŸ”¥ã€æ–°å¢ã€‘è·Ÿè¸ªå½“å‰æ’­æ”¾çš„éŸ³æ•ˆ
            isUnlocked: false, // ğŸ”¥ã€æ–°å¢ã€‘éŸ³é¢‘ä¸Šä¸‹æ–‡è§£é”çŠ¶æ€

            // éŸ³æ•ˆç±»å‹å®šä¹‰
            TYPES: {
                MESSAGE_RECEIVED: 'messageReceived',
                MESSAGE_SENT: 'messageSent',
                NOTIFICATION: 'notification',
                OUTGOING_CALL: 'outgoingCall',
                INCOMING_CALL: 'incomingCall'
            },

            // åˆå§‹åŒ–éŸ³æ•ˆç®¡ç†å™¨
            async init() {
                try {
                    // ä»localStorageåŠ è½½éŸ³æ•ˆå¼€å…³çŠ¶æ€
                    const soundEnabled = localStorage.getItem('soundEnabled');
                    if (soundEnabled !== null) {
                        this.enabled = soundEnabled === 'true';
                    } else {
                        // é»˜è®¤å¯ç”¨éŸ³æ•ˆ
                        this.enabled = true;
                        localStorage.setItem('soundEnabled', 'true');
                    }

                    await this.loadSettings();
                    console.log('ğŸ”Š éŸ³æ•ˆç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼ŒçŠ¶æ€:', this.enabled);
                } catch (error) {
                    console.error('âŒ éŸ³æ•ˆç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                }
            },

            // ä»æ•°æ®åº“åŠ è½½éŸ³æ•ˆè®¾ç½®
            async loadSettings() {
                try {
                    // åŠ è½½å…¨å±€éŸ³æ•ˆè®¾ç½®
                    const settings = await db.soundSettings.toArray();
                    for (const setting of settings) {
                        if (setting.enabled && setting.sourceUrl) {
                            await this.loadSound(setting.soundType, setting.sourceUrl, setting.sourceType);
                        }
                    }

                    // åŠ è½½è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®
                    const characterSettings = await db.characterSounds.toArray();
                    for (const setting of characterSettings) {
                        if (setting.enabled && setting.sourceUrl) {
                            await this.loadCharacterSound(setting.characterId, setting.soundType, setting.sourceUrl, setting.sourceType);
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½éŸ³æ•ˆè®¾ç½®å¤±è´¥:', error);
                }
            },

            // åŠ è½½å•ä¸ªéŸ³æ•ˆ
            async loadSound(soundType, sourceUrl, sourceType = 'url') {
                try {
                    if (!sourceUrl) return false;

                    const audio = new Audio();
                    audio.preload = 'auto';
                    audio.src = sourceUrl;

                    // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
                    await new Promise((resolve, reject) => {
                        audio.addEventListener('canplaythrough', resolve, { once: true });
                        audio.addEventListener('error', reject, { once: true });
                        audio.load();
                    });

                    this.sounds[soundType] = audio;
                    console.log(`âœ… éŸ³æ•ˆåŠ è½½æˆåŠŸ: ${soundType}`);
                    return true;
                } catch (error) {
                    console.error(`âŒ éŸ³æ•ˆåŠ è½½å¤±è´¥ (${soundType}):`, error);
                    return false;
                }
            },

            // æ’­æ”¾éŸ³æ•ˆï¼ˆæ”¯æŒè§’è‰²ä¸“å±éŸ³æ•ˆå’Œé™éŸ³æ¨¡å¼ï¼‰
            play(soundType, characterId = null) {
                if (!this.enabled) return;

                try {
                    // ğŸ”¥ã€æ–°å¢ã€‘æœ€é«˜ä¼˜å…ˆçº§ï¼šæ£€æŸ¥è§’è‰²é™éŸ³æ¨¡å¼
                    if (characterId && this.characterSounds[characterId] && this.characterSounds[characterId]['silent']) {
                        console.log(`ğŸ”‡ è§’è‰²é™éŸ³æ¨¡å¼: ${characterId} - ${soundType} (å·²é™éŸ³)`);
                        return; // é™éŸ³æ¨¡å¼ï¼Œç›´æ¥è¿”å›ä¸æ’­æ”¾ä»»ä½•éŸ³æ•ˆ
                    }

                    let audio = null;

                    // ä¼˜å…ˆä½¿ç”¨è§’è‰²ä¸“å±éŸ³æ•ˆ
                    if (characterId && this.characterSounds[characterId] && this.characterSounds[characterId][soundType]) {
                        audio = this.characterSounds[characterId][soundType].cloneNode();
                        console.log(`ğŸµ æ’­æ”¾è§’è‰²ä¸“å±éŸ³æ•ˆ: ${characterId} - ${soundType}`);
                    }
                    // å›é€€åˆ°å…¨å±€éŸ³æ•ˆ
                    else if (this.sounds[soundType]) {
                        audio = this.sounds[soundType].cloneNode();
                        console.log(`ğŸµ æ’­æ”¾å…¨å±€éŸ³æ•ˆ: ${soundType}`);
                    }

                    if (audio) {
                        audio.volume = 0.7;

                        // ğŸ”¥ã€æ–°å¢ã€‘è·Ÿè¸ªå½“å‰æ’­æ”¾çš„éŸ³æ•ˆ
                        this.currentlyPlaying[soundType] = audio;

                        // ğŸ”¥ã€æ–°å¢ã€‘éŸ³æ•ˆç»“æŸæ—¶æ¸…ç†è·Ÿè¸ª
                        audio.addEventListener('ended', () => {
                            delete this.currentlyPlaying[soundType];
                        });

                        // ğŸ”¥ã€æ‰‹æœºä¿®å¤ã€‘æ·»åŠ ç”¨æˆ·äº¤äº’æ£€æŸ¥
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.warn(`éŸ³æ•ˆæ’­æ”¾å¤±è´¥ (${soundType}):`, error);
                                delete this.currentlyPlaying[soundType];

                                // ğŸ”¥ã€å…³é”®ã€‘å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œåœ¨ä¸‹æ¬¡ç”¨æˆ·äº¤äº’æ—¶é‡è¯•
                                if (error.name === 'NotAllowedError') {
                                    this.scheduleRetryOnUserInteraction(soundType, characterId);
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error(`éŸ³æ•ˆæ’­æ”¾é”™è¯¯ (${soundType}):`, error);
                }
            },

            // ğŸ”¥ã€ä¿®å¤ã€‘åªåœ¨é¦–æ¬¡æƒé™é—®é¢˜æ—¶é‡è¯•ï¼Œé¿å…æ¯æ¬¡éƒ½éœ€è¦äº¤äº’
            scheduleRetryOnUserInteraction(soundType, characterId) {
                // å¦‚æœå·²ç»è§£é”è¿‡ï¼Œå°±ä¸å†é‡è¯•
                if (this.isUnlocked) return;

                const retryPlay = () => {
                    console.log(`ğŸ”„ ç”¨æˆ·äº¤äº’åé‡è¯•æ’­æ”¾éŸ³æ•ˆ: ${soundType}`);
                    this.isUnlocked = true; // æ ‡è®°ä¸ºå·²è§£é”
                    this.play(soundType, characterId);
                    // ç§»é™¤ç›‘å¬å™¨
                    ['touchstart', 'mousedown', 'keydown', 'click'].forEach(event => {
                        document.removeEventListener(event, retryPlay);
                    });
                };

                // ç›‘å¬ä¸‹æ¬¡ç”¨æˆ·äº¤äº’
                ['touchstart', 'mousedown', 'keydown', 'click'].forEach(event => {
                    document.addEventListener(event, retryPlay, { once: true, passive: true });
                });
            },

            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æŒ‡å®šç±»å‹çš„éŸ³æ•ˆ
            stopSound(soundType) {
                try {
                    if (this.currentlyPlaying[soundType]) {
                        this.currentlyPlaying[soundType].pause();
                        this.currentlyPlaying[soundType].currentTime = 0;
                        delete this.currentlyPlaying[soundType];
                        console.log(`ğŸ”‡ å·²åœæ­¢éŸ³æ•ˆ: ${soundType}`);
                    }
                } catch (error) {
                    console.error(`åœæ­¢éŸ³æ•ˆå¤±è´¥ (${soundType}):`, error);
                }
            },

            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
            stopAllSounds() {
                try {
                    Object.keys(this.currentlyPlaying).forEach(soundType => {
                        this.stopSound(soundType);
                    });
                    console.log('ğŸ”‡ å·²åœæ­¢æ‰€æœ‰éŸ³æ•ˆ');
                } catch (error) {
                    console.error('åœæ­¢æ‰€æœ‰éŸ³æ•ˆå¤±è´¥:', error);
                }
            },

            // è¯•å¬éŸ³æ•ˆï¼ˆé™åˆ¶5ç§’ï¼‰
            test(soundType) {
                if (!this.enabled || !this.sounds[soundType]) return;

                try {
                    const audio = this.sounds[soundType].cloneNode();
                    audio.volume = 0.7;

                    // 5ç§’åè‡ªåŠ¨åœæ­¢
                    const stopTimer = setTimeout(() => {
                        audio.pause();
                        audio.currentTime = 0;
                    }, 5000);

                    // å¦‚æœéŸ³é¢‘è‡ªç„¶ç»“æŸï¼Œæ¸…é™¤å®šæ—¶å™¨
                    audio.addEventListener('ended', () => {
                        clearTimeout(stopTimer);
                    });

                    audio.play().catch(error => {
                        console.warn(`éŸ³æ•ˆè¯•å¬å¤±è´¥ (${soundType}):`, error);
                        clearTimeout(stopTimer);
                    });
                } catch (error) {
                    console.error(`éŸ³æ•ˆè¯•å¬é”™è¯¯ (${soundType}):`, error);
                }
            },

            // è®¾ç½®éŸ³æ•ˆ
            async setSound(soundType, sourceUrl, sourceType = 'url') {
                try {
                    // æ¸…ç†æ—§éŸ³æ•ˆ
                    if (this.sounds[soundType]) {
                        this.sounds[soundType] = null;
                    }

                    if (!sourceUrl) {
                        // æ¸…é™¤éŸ³æ•ˆè®¾ç½®
                        await db.soundSettings.delete(soundType);
                        return true;
                    }

                    // åŠ è½½æ–°éŸ³æ•ˆ
                    const success = await this.loadSound(soundType, sourceUrl, sourceType);
                    if (success) {
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        await db.soundSettings.put({
                            id: soundType,
                            soundType: soundType,
                            sourceType: sourceType,
                            sourceUrl: sourceUrl,
                            enabled: true,
                            timestamp: Date.now()
                        });
                    }
                    return success;
                } catch (error) {
                    console.error(`è®¾ç½®éŸ³æ•ˆå¤±è´¥ (${soundType}):`, error);
                    return false;
                }
            },



            // æ¸…é™¤éŸ³æ•ˆ
            async clearSound(soundType) {
                try {
                    if (this.sounds[soundType]) {
                        this.sounds[soundType] = null;
                    }
                    await db.soundSettings.delete(soundType);
                    console.log(`âœ… éŸ³æ•ˆå·²æ¸…é™¤: ${soundType}`);
                    return true;
                } catch (error) {
                    console.error(`æ¸…é™¤éŸ³æ•ˆå¤±è´¥ (${soundType}):`, error);
                    return false;
                }
            },

            // å¯ç”¨/ç¦ç”¨éŸ³æ•ˆç³»ç»Ÿ
            setEnabled(enabled) {
                this.enabled = enabled;
                localStorage.setItem('soundEnabled', enabled.toString());
            },

            // è·å–éŸ³æ•ˆè®¾ç½®
            async getSetting(soundType) {
                try {
                    return await db.soundSettings.get(soundType);
                } catch (error) {
                    console.error(`è·å–éŸ³æ•ˆè®¾ç½®å¤±è´¥ (${soundType}):`, error);
                    return null;
                }
            },

            // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸“å±éŸ³æ•ˆç®¡ç†æ–¹æ³•

            // åŠ è½½è§’è‰²ä¸“å±éŸ³æ•ˆ
            async loadCharacterSound(characterId, soundType, sourceUrl, sourceType = 'url') {
                try {
                    if (!sourceUrl) return false;

                    // ğŸ”¥ã€æ–°å¢ã€‘ç‰¹æ®Šå¤„ç†é™éŸ³æ¨¡å¼
                    if (soundType === 'silent' && sourceUrl === 'silent') {
                        // åˆå§‹åŒ–è§’è‰²éŸ³æ•ˆç¼“å­˜
                        if (!this.characterSounds[characterId]) {
                            this.characterSounds[characterId] = {};
                        }

                        this.characterSounds[characterId]['silent'] = true; // é™éŸ³æ ‡è®°
                        console.log(`âœ… è§’è‰²é™éŸ³æ¨¡å¼è®¾ç½®æˆåŠŸ: ${characterId}`);
                        return true;
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘ç‰¹æ®Šå¤„ç†å¼€å…³çŠ¶æ€æ ‡è®°
                    if (soundType === 'enabled' && sourceUrl === 'enabled') {
                        // åˆå§‹åŒ–è§’è‰²éŸ³æ•ˆç¼“å­˜
                        if (!this.characterSounds[characterId]) {
                            this.characterSounds[characterId] = {};
                        }

                        this.characterSounds[characterId]['enabled'] = true; // å¼€å…³çŠ¶æ€æ ‡è®°
                        console.log(`âœ… è§’è‰²ä¸“å±éŸ³æ•ˆå¼€å…³çŠ¶æ€ä¿å­˜æˆåŠŸ: ${characterId}`);
                        return true;
                    }

                    const audio = new Audio();
                    audio.preload = 'auto';
                    audio.src = sourceUrl;

                    await new Promise((resolve, reject) => {
                        audio.addEventListener('canplaythrough', resolve, { once: true });
                        audio.addEventListener('error', reject, { once: true });
                        audio.load();
                    });

                    // åˆå§‹åŒ–è§’è‰²éŸ³æ•ˆç¼“å­˜
                    if (!this.characterSounds[characterId]) {
                        this.characterSounds[characterId] = {};
                    }

                    this.characterSounds[characterId][soundType] = audio;
                    console.log(`âœ… è§’è‰²ä¸“å±éŸ³æ•ˆåŠ è½½æˆåŠŸ: ${characterId} - ${soundType}`);
                    return true;
                } catch (error) {
                    console.error(`âŒ è§’è‰²ä¸“å±éŸ³æ•ˆåŠ è½½å¤±è´¥ (${characterId} - ${soundType}):`, error);
                    return false;
                }
            },

            // è®¾ç½®è§’è‰²ä¸“å±éŸ³æ•ˆ
            async setCharacterSound(characterId, soundType, sourceUrl, sourceType = 'url') {
                try {
                    // æ¸…ç†æ—§éŸ³æ•ˆ
                    if (this.characterSounds[characterId] && this.characterSounds[characterId][soundType]) {
                        this.characterSounds[characterId][soundType] = null;
                    }

                    if (!sourceUrl) {
                        // æ¸…é™¤éŸ³æ•ˆè®¾ç½®
                        await db.characterSounds.where({characterId: characterId, soundType: soundType}).delete();
                        return true;
                    }

                    // åŠ è½½æ–°éŸ³æ•ˆ
                    const success = await this.loadCharacterSound(characterId, soundType, sourceUrl, sourceType);
                    if (success) {
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        await db.characterSounds.put({
                            characterId: characterId,
                            soundType: soundType,
                            sourceType: sourceType,
                            sourceUrl: sourceUrl,
                            enabled: true,
                            timestamp: Date.now()
                        });
                    }
                    return success;
                } catch (error) {
                    console.error(`è®¾ç½®è§’è‰²ä¸“å±éŸ³æ•ˆå¤±è´¥ (${characterId} - ${soundType}):`, error);
                    return false;
                }
            },

            // æ¸…é™¤è§’è‰²ä¸“å±éŸ³æ•ˆ
            async clearCharacterSound(characterId, soundType) {
                try {
                    if (this.characterSounds[characterId] && this.characterSounds[characterId][soundType]) {
                        // ğŸ”¥ã€æ–°å¢ã€‘ç‰¹æ®Šå¤„ç†é™éŸ³æ¨¡å¼å’Œå¼€å…³çŠ¶æ€æ¸…é™¤
                        if (soundType === 'silent' || soundType === 'enabled') {
                            delete this.characterSounds[characterId][soundType];
                        } else {
                            this.characterSounds[characterId][soundType] = null;
                        }
                    }
                    await db.characterSounds.where({characterId: characterId, soundType: soundType}).delete();
                    console.log(`âœ… è§’è‰²ä¸“å±éŸ³æ•ˆå·²æ¸…é™¤: ${characterId} - ${soundType}`);
                    return true;
                } catch (error) {
                    console.error(`æ¸…é™¤è§’è‰²ä¸“å±éŸ³æ•ˆå¤±è´¥ (${characterId} - ${soundType}):`, error);
                    return false;
                }
            },

            // è·å–è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®
            async getCharacterSetting(characterId, soundType) {
                try {
                    return await db.characterSounds.where({characterId: characterId, soundType: soundType}).first();
                } catch (error) {
                    console.error(`è·å–è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®å¤±è´¥ (${characterId} - ${soundType}):`, error);
                    return null;
                }
            },

            // æ¸…é™¤è§’è‰²çš„æ‰€æœ‰ä¸“å±éŸ³æ•ˆ
            async clearAllCharacterSounds(characterId) {
                try {
                    if (this.characterSounds[characterId]) {
                        this.characterSounds[characterId] = {};
                    }
                    await db.characterSounds.where('characterId').equals(characterId).delete();
                    console.log(`âœ… è§’è‰²æ‰€æœ‰ä¸“å±éŸ³æ•ˆå·²æ¸…é™¤: ${characterId}`);
                    return true;
                } catch (error) {
                    console.error(`æ¸…é™¤è§’è‰²æ‰€æœ‰ä¸“å±éŸ³æ•ˆå¤±è´¥ (${characterId}):`, error);
                    return false;
                }
            }
        };

        // ğŸ”¥ã€æ–°å¢ã€‘éŸ³æ•ˆè®¾ç½®ç•Œé¢ç›¸å…³å‡½æ•°

        // åˆ‡æ¢éŸ³æ•ˆç³»ç»Ÿå¼€å…³
        function toggleSoundSystem() {
            const checkbox = document.getElementById('sound-enabled');
            if (!checkbox) {
                console.error('âŒ æ‰¾ä¸åˆ°éŸ³æ•ˆå¼€å…³å…ƒç´ ');
                return;
            }

            const enabled = checkbox.checked;
            console.log('ğŸ”Š éŸ³æ•ˆå¼€å…³çŠ¶æ€:', enabled);

            SoundManager.setEnabled(enabled);

            // æ›´æ–°ç•Œé¢çŠ¶æ€
            const soundList = document.getElementById('sound-settings-list');
            if (soundList) {
                soundList.style.opacity = enabled ? '1' : '0.5';
                soundList.style.pointerEvents = enabled ? 'auto' : 'none';
            }

            showToast(enabled ? 'éŸ³æ•ˆå·²å¯ç”¨' : 'éŸ³æ•ˆå·²ç¦ç”¨', 'success');
        }

        // å¤„ç†éŸ³æ•ˆæ–‡ä»¶ä¸Šä¼ 
        function handleSoundFileUpload(fileInput, soundType) {
            const file = fileInput.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ3MBé™åˆ¶ï¼‰
            if (file.size > 3 * 1024 * 1024) {
                showToast('éŸ³æ•ˆæ–‡ä»¶ä¸èƒ½è¶…è¿‡3MB', 'error');
                fileInput.value = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('audio/')) {
                showToast('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const success = await SoundManager.setSound(soundType, e.target.result, 'file');
                if (success) {
                    showToast('éŸ³æ•ˆè®¾ç½®æˆåŠŸ', 'success');
                    // æ›´æ–°URLè¾“å…¥æ¡†æ˜¾ç¤º
                    const urlInput = document.getElementById(`sound-${soundType}-url`);
                    if (urlInput) {
                        urlInput.value = file.name;
                        urlInput.disabled = true;
                    }
                } else {
                    showToast('éŸ³æ•ˆè®¾ç½®å¤±è´¥', 'error');
                }
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        // æµ‹è¯•æ’­æ”¾éŸ³æ•ˆ
        function testSound(soundType) {
            SoundManager.test(soundType);
        }

        // æ¸…é™¤éŸ³æ•ˆ
        async function clearSound(soundType) {
            const success = await SoundManager.clearSound(soundType);
            if (success) {
                showToast('éŸ³æ•ˆå·²æ¸…é™¤', 'success');
                // æ¸…ç©ºURLè¾“å…¥æ¡†
                const urlInput = document.getElementById(`sound-${soundType}-url`);
                if (urlInput) {
                    urlInput.value = '';
                    urlInput.disabled = false;
                }
            } else {
                showToast('æ¸…é™¤éŸ³æ•ˆå¤±è´¥', 'error');
            }
        }

        // è®¾ç½®åœ¨çº¿éŸ³æ•ˆé“¾æ¥
        async function setSoundFromUrl(soundType) {
            const urlInput = document.getElementById(`sound-${soundType}-url`);
            if (!urlInput) return;

            const url = urlInput.value.trim();
            if (!url) {
                showToast('è¯·è¾“å…¥éŸ³æ•ˆé“¾æ¥', 'error');
                return;
            }

            const success = await SoundManager.setSound(soundType, url, 'url');
            if (success) {
                showToast('éŸ³æ•ˆè®¾ç½®æˆåŠŸ', 'success');
            } else {
                showToast('éŸ³æ•ˆè®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ', 'error');
            }
        }

        // åˆå§‹åŒ–éŸ³æ•ˆè®¾ç½®ç•Œé¢
        async function initSoundSettings() {
            try {
                // è®¾ç½®éŸ³æ•ˆå¼€å…³çŠ¶æ€
                const soundEnabled = document.getElementById('sound-enabled');
                if (soundEnabled) {
                    soundEnabled.checked = SoundManager.enabled;
                    console.log('ğŸ”Š éŸ³æ•ˆå¼€å…³çŠ¶æ€:', SoundManager.enabled);
                }

                // åŠ è½½å·²ä¿å­˜çš„éŸ³æ•ˆè®¾ç½®
                const soundTypes = ['messageReceived', 'messageSent', 'notification', 'outgoingCall', 'incomingCall'];

                for (const soundType of soundTypes) {
                    const setting = await SoundManager.getSetting(soundType);
                    const urlInput = document.getElementById(`sound-${soundType}-url`);

                    if (setting && urlInput) {
                        if (setting.sourceType === 'file') {
                            urlInput.value = 'å·²è®¾ç½®æœ¬åœ°æ–‡ä»¶';
                            urlInput.disabled = true;
                        } else {
                            urlInput.value = setting.sourceUrl || '';
                            urlInput.disabled = false;
                        }
                    }
                }

                // æ‰‹åŠ¨æ›´æ–°ç•Œé¢çŠ¶æ€ï¼ˆä¸è°ƒç”¨toggleSoundSystemé¿å…é‡å¤toastï¼‰
                const soundList = document.getElementById('sound-settings-list');
                if (soundList) {
                    soundList.style.opacity = SoundManager.enabled ? '1' : '0.5';
                    soundList.style.pointerEvents = SoundManager.enabled ? 'auto' : 'none';
                }

                console.log('âœ… éŸ³æ•ˆè®¾ç½®ç•Œé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ éŸ³æ•ˆè®¾ç½®ç•Œé¢åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸ºURLè¾“å…¥æ¡†æ·»åŠ å›è½¦é”®ç›‘å¬ - é¿å…é‡å¤ç»‘å®š
        let soundEventListenersInitialized = false;

        function initSoundEventListeners() {
            if (soundEventListenersInitialized) return;

            const soundTypes = ['messageReceived', 'messageSent', 'notification', 'outgoingCall', 'incomingCall'];

            soundTypes.forEach(soundType => {
                // å…¨å±€éŸ³æ•ˆè¾“å…¥æ¡†
                const urlInput = document.getElementById(`sound-${soundType}-url`);
                if (urlInput) {
                    urlInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            setSoundFromUrl(soundType);
                        }
                    });

                    urlInput.addEventListener('blur', function() {
                        if (this.value.trim()) {
                            setSoundFromUrl(soundType);
                        }
                    });
                }

                // è§’è‰²ä¸“å±éŸ³æ•ˆè¾“å…¥æ¡†
                const characterUrlInput = document.getElementById(`character-${soundType}-url`);
                if (characterUrlInput) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿æ­£ç¡®çš„ä½œç”¨åŸŸ
                    characterUrlInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            setCharacterSoundFromUrl(soundType);
                        }
                    });

                    characterUrlInput.addEventListener('blur', (e) => {
                        if (e.target.value.trim()) {
                            setCharacterSoundFromUrl(soundType);
                        }
                    });
                }
            });

            soundEventListenersInitialized = true;
            console.log('ğŸµ éŸ³æ•ˆäº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // ä¸ºURLè¾“å…¥æ¡†æ·»åŠ å›è½¦é”®ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            initSoundEventListeners();
        });

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸“å±éŸ³æ•ˆç®¡ç†å‡½æ•°

        // åˆ‡æ¢è§’è‰²ä¸“å±éŸ³æ•ˆå¼€å…³
        async function toggleCharacterSounds() {
            const enabled = document.getElementById('character-sound-enabled').checked;
            const soundList = document.getElementById('character-sound-list');

            if (soundList) {
                soundList.style.display = enabled ? 'block' : 'none';
            }

            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            try {
                if (enabled) {
                    // ä¿å­˜å¼€å…³çŠ¶æ€åˆ°æ•°æ®åº“
                    await SoundManager.setCharacterSound(currentChatCharacter.id, 'enabled', 'enabled', 'enabled');
                    showToast('è§’è‰²ä¸“å±éŸ³æ•ˆå·²å¯ç”¨', 'success');
                } else {
                    // æ¸…é™¤è¯¥è§’è‰²çš„æ‰€æœ‰ä¸“å±éŸ³æ•ˆå’Œå¼€å…³çŠ¶æ€
                    await SoundManager.clearAllCharacterSounds(currentChatCharacter.id);
                    showToast('è§’è‰²ä¸“å±éŸ³æ•ˆå·²ç¦ç”¨', 'success');
                }
            } catch (error) {
                console.error('ä¿å­˜ä¸“å±éŸ³æ•ˆå¼€å…³çŠ¶æ€å¤±è´¥:', error);
                showToast('ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // å¤„ç†è§’è‰²ä¸“å±éŸ³æ•ˆæ–‡ä»¶ä¸Šä¼ 
        function handleCharacterSoundFileUpload(fileInput, soundType) {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            const file = fileInput.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ3MBé™åˆ¶ï¼‰
            if (file.size > 3 * 1024 * 1024) {
                showToast('éŸ³æ•ˆæ–‡ä»¶ä¸èƒ½è¶…è¿‡3MB', 'error');
                fileInput.value = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('audio/')) {
                showToast('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const success = await SoundManager.setCharacterSound(currentChatCharacter.id, soundType, e.target.result, 'file');
                if (success) {
                    showToast('è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®æˆåŠŸ', 'success');
                    // æ›´æ–°URLè¾“å…¥æ¡†æ˜¾ç¤º
                    const urlInput = document.getElementById(`character-${soundType}-url`);
                    if (urlInput) {
                        urlInput.value = file.name;
                        urlInput.disabled = true;
                    }
                } else {
                    showToast('è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®å¤±è´¥', 'error');
                }
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        // æµ‹è¯•æ’­æ”¾è§’è‰²ä¸“å±éŸ³æ•ˆ
        function testCharacterSound(soundType) {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            // ä½¿ç”¨SoundManagerçš„testæ–¹æ³•ï¼Œä½†æŒ‡å®šè§’è‰²ID
            if (SoundManager.characterSounds[currentChatCharacter.id] && SoundManager.characterSounds[currentChatCharacter.id][soundType]) {
                // æ‰‹åŠ¨æ’­æ”¾è§’è‰²ä¸“å±éŸ³æ•ˆ
                const audio = SoundManager.characterSounds[currentChatCharacter.id][soundType].cloneNode();
                audio.volume = 0.7;

                // 5ç§’åè‡ªåŠ¨åœæ­¢
                const stopTimer = setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }, 5000);

                audio.addEventListener('ended', () => {
                    clearTimeout(stopTimer);
                });

                audio.play().catch(error => {
                    console.warn(`è§’è‰²ä¸“å±éŸ³æ•ˆè¯•å¬å¤±è´¥:`, error);
                    clearTimeout(stopTimer);
                });
            } else {
                showToast('è¯·å…ˆè®¾ç½®è¯¥éŸ³æ•ˆ', 'error');
            }
        }

        // æ¸…é™¤è§’è‰²ä¸“å±éŸ³æ•ˆ
        async function clearCharacterSound(soundType) {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            const success = await SoundManager.clearCharacterSound(currentChatCharacter.id, soundType);
            if (success) {
                showToast('è§’è‰²ä¸“å±éŸ³æ•ˆå·²æ¸…é™¤', 'success');
                // æ¸…ç©ºURLè¾“å…¥æ¡†
                const urlInput = document.getElementById(`character-${soundType}-url`);
                if (urlInput) {
                    urlInput.value = '';
                    urlInput.disabled = false;
                }
            } else {
                showToast('æ¸…é™¤è§’è‰²ä¸“å±éŸ³æ•ˆå¤±è´¥', 'error');
            }
        }

        // è®¾ç½®è§’è‰²ä¸“å±åœ¨çº¿éŸ³æ•ˆé“¾æ¥
        async function setCharacterSoundFromUrl(soundType) {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            const urlInput = document.getElementById(`character-${soundType}-url`);
            if (!urlInput) return;

            const url = urlInput.value.trim();
            if (!url) {
                showToast('è¯·è¾“å…¥éŸ³æ•ˆé“¾æ¥', 'error');
                return;
            }

            const success = await SoundManager.setCharacterSound(currentChatCharacter.id, soundType, url, 'url');
            if (success) {
                showToast('è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®æˆåŠŸ', 'success');
            } else {
                showToast('è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ', 'error');
            }
        }

        // åˆ‡æ¢è§’è‰²é™éŸ³æ¨¡å¼
        async function toggleCharacterSilentMode() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            const silentCheckbox = document.getElementById('character-silent-mode');
            const isSilent = silentCheckbox.checked;

            try {
                if (isSilent) {
                    // è®¾ç½®é™éŸ³æ¨¡å¼
                    const success = await SoundManager.setCharacterSound(currentChatCharacter.id, 'silent', 'silent', 'silent');
                    if (success) {
                        showToast(`${currentChatCharacter.name} å·²è®¾ä¸ºé™éŸ³è§’è‰²`, 'success');
                    } else {
                        showToast('è®¾ç½®é™éŸ³æ¨¡å¼å¤±è´¥', 'error');
                        silentCheckbox.checked = false; // å›æ»šå¼€å…³çŠ¶æ€
                    }
                } else {
                    // å–æ¶ˆé™éŸ³æ¨¡å¼
                    const success = await SoundManager.clearCharacterSound(currentChatCharacter.id, 'silent');
                    if (success) {
                        showToast(`${currentChatCharacter.name} å·²å–æ¶ˆé™éŸ³`, 'success');
                    } else {
                        showToast('å–æ¶ˆé™éŸ³æ¨¡å¼å¤±è´¥', 'error');
                        silentCheckbox.checked = true; // å›æ»šå¼€å…³çŠ¶æ€
                    }
                }
            } catch (error) {
                console.error('åˆ‡æ¢é™éŸ³æ¨¡å¼å¤±è´¥:', error);
                showToast('åˆ‡æ¢é™éŸ³æ¨¡å¼å¤±è´¥', 'error');
                silentCheckbox.checked = !isSilent; // å›æ»šå¼€å…³çŠ¶æ€
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®ç•Œé¢
        function clearCharacterSoundSettingsUI() {
            const soundTypes = ['messageReceived', 'incomingCall', 'notification'];

            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
            soundTypes.forEach(soundType => {
                const urlInput = document.getElementById(`character-${soundType}-url`);
                if (urlInput) {
                    urlInput.value = '';
                    urlInput.disabled = false;
                }
            });

            // é‡ç½®å¼€å…³çŠ¶æ€
            const soundEnabled = document.getElementById('character-sound-enabled');
            if (soundEnabled) {
                soundEnabled.checked = false;
            }

            const soundList = document.getElementById('character-sound-list');
            if (soundList) {
                soundList.style.display = 'none';
            }

            // é‡ç½®é™éŸ³å¼€å…³
            const silentCheckbox = document.getElementById('character-silent-mode');
            if (silentCheckbox) {
                silentCheckbox.checked = false;
            }

            console.log('ğŸ§¹ è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®ç•Œé¢å·²æ¸…ç†');
        }

        // åˆå§‹åŒ–è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®ç•Œé¢
        async function initCharacterSoundSettings() {
            if (!currentChatCharacter) return;

            // ğŸ”¥ã€æ–°å¢ã€‘ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨å·²åˆå§‹åŒ–
            initSoundEventListeners();

            // ğŸ”¥ã€æ–°å¢ã€‘å…ˆæ¸…ç†ç•Œé¢ï¼Œé¿å…æ˜¾ç¤ºå…¶ä»–è§’è‰²çš„è®¾ç½®
            clearCharacterSoundSettingsUI();

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä¸“å±éŸ³æ•ˆè®¾ç½®
                const soundTypes = ['messageReceived', 'incomingCall', 'notification'];
                let hasAnySetting = false;

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ä¸“å±éŸ³æ•ˆå¼€å…³çŠ¶æ€
                const enabledSetting = await SoundManager.getCharacterSetting(currentChatCharacter.id, 'enabled');
                const isEnabled = !!enabledSetting;

                // æ£€æŸ¥é™éŸ³æ¨¡å¼
                const silentSetting = await SoundManager.getCharacterSetting(currentChatCharacter.id, 'silent');
                const isSilent = !!silentSetting;

                // è®¾ç½®é™éŸ³å¼€å…³çŠ¶æ€
                const silentCheckbox = document.getElementById('character-silent-mode');
                if (silentCheckbox) {
                    silentCheckbox.checked = isSilent;
                }

                for (const soundType of soundTypes) {
                    const setting = await SoundManager.getCharacterSetting(currentChatCharacter.id, soundType);
                    const urlInput = document.getElementById(`character-${soundType}-url`);

                    if (urlInput) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼Œé¿å…æ˜¾ç¤ºå…¶ä»–è§’è‰²çš„è®¾ç½®
                        urlInput.value = '';
                        urlInput.disabled = false;

                        // å¦‚æœå½“å‰è§’è‰²æœ‰è®¾ç½®ï¼Œåˆ™æ˜¾ç¤º
                        if (setting) {
                            hasAnySetting = true;
                            if (setting.sourceType === 'file') {
                                urlInput.value = 'å·²è®¾ç½®æœ¬åœ°æ–‡ä»¶';
                                urlInput.disabled = true;
                            } else {
                                urlInput.value = setting.sourceUrl || '';
                                urlInput.disabled = false;
                            }
                        }
                    }
                }

                // ğŸ”¥ã€ä¿®æ”¹ã€‘å¼€å…³çŠ¶æ€ä¼˜å…ˆçº§ï¼šæ˜ç¡®å¼€å¯ > æœ‰å®é™…è®¾ç½® > é™éŸ³æ¨¡å¼
                let shouldShowEnabled = false;
                if (isEnabled) {
                    shouldShowEnabled = true; // ç”¨æˆ·æ˜ç¡®å¼€å¯äº†å¼€å…³
                } else if (hasAnySetting || isSilent) {
                    shouldShowEnabled = true; // æœ‰å®é™…è®¾ç½®æˆ–é™éŸ³æ¨¡å¼
                }

                // è®¾ç½®å¼€å…³çŠ¶æ€
                const soundEnabled = document.getElementById('character-sound-enabled');
                const soundList = document.getElementById('character-sound-list');

                if (soundEnabled) {
                    soundEnabled.checked = shouldShowEnabled;
                }

                if (soundList) {
                    soundList.style.display = shouldShowEnabled ? 'block' : 'none';
                }

                console.log(`âœ… è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®ç•Œé¢åˆå§‹åŒ–å®Œæˆ: ${currentChatCharacter.name} (å¼€å…³: ${shouldShowEnabled}, é™éŸ³: ${isSilent})`);
            } catch (error) {
                console.error('âŒ è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®ç•Œé¢åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€ç‰ˆæœ¬ 40ã€‘è‡ªå®šä¹‰ä¸»é¢˜ç³»ç»Ÿè¿ç§»åˆ°Dexie
        db.version(40).stores({
            // --- å®Œæ•´å¤åˆ¶ç‰ˆæœ¬39çš„æ‰€æœ‰å†…å®¹ ---
            // åŸºç¡€æ•°æ®è¡¨
            characters: '&id, name, groupId',
            contacts: '++id, characterId',
            chatMessages: '&id, characterId, timestamp',

            // ç”¨æˆ·é¢å…·ç³»ç»Ÿ
            personas: '&id, name',

            // è¡¨æƒ…åŒ…ç³»ç»Ÿ - æ·»åŠ isPersonalå­—æ®µåŒºåˆ†ä¸ªäººè¡¨æƒ…åŒ…å’Œåº“è¡¨æƒ…åŒ…
            customEmojis: '&id, name, category, isPersonal',
            recentEmojis: '&id, lastUsed',

            // ä¸–ç•Œä¹¦ç³»ç»Ÿ
            worldbooks: '&id, name, isGlobal',
            worldbookEntries: '&id, worldbookId, keyword',

            // ç¾¤èŠç³»ç»Ÿ
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            groupChatMessages: '&id, groupId, timestamp',
            groupChatMembers: '&id, groupId, characterId',

            // åŠ¨æ€ç³»ç»Ÿ
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',

            // è®°å¿†ç³»ç»Ÿ
            workingMemory: '&id, characterId, timestamp, content, context',
            episodicMemory: '&id, characterId, date, summary, timestamp, context',
            episodicMemories: '&id, characterId, fact, importance, timestamp, category, contextId',
            memorySummaries: '&id, characterId, date, summary, timestamp, context',
            memoryEvents: '&id, characterIds, eventType, timestamp, context, eventData, importance',
            coreMemory: '&id, characterId, category, content, timestamp',
            coreMemories: '&id, characterId, fact, importance, timestamp, type, category, contextId',
            crossAppTimeline: '&id, characterId, appType, action, timestamp, context, messageId',

            // æ‹‰é»‘å’Œå¥½å‹ç³»ç»Ÿ
            blacklist: '&id, blockerId, blockedId, timestamp, reason',
            blockedCharacters: '&id, characterId, blockedBy, timestamp',
            friendRequests: '&id, fromId, toId, timestamp, status, type, message',
            characterStatus: '&id, characterId, status, activity, location, lastUpdate',

            // æ—¥è®°ç³»ç»Ÿ
            characterDiaries: '&id, characterId, date, content, timestamp, weather',

            // çº¿ä¸‹æ¨¡å¼ç³»ç»Ÿ
            offlineHistoryRecords: '&id, characterId, timestamp, summary, messages',
            offlineUISettings: '&id, characterId, settings, timestamp',
            offlinePresets: '&id, name, content, timestamp',

            // éŸ³ä¹æ’­æ”¾å™¨ç³»ç»Ÿ
            musicPlaylist: '&id, title, artist, album, duration, url, coverImage, lyrics, addedTime, isLocalFile',
            musicCovers: '&id, songId, imageData, timestamp',

            // è®¾ç½®å’Œé…ç½®
            apiSettings: '&id',
            globalSettings: '&id',
            wallpapers: '&id, name',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',

            // å¿ƒå£°ç³»ç»Ÿ
            innerThoughts: '&id, messageId, characterId, content, timestamp',

            // è®ºå›åŠŸèƒ½ç›¸å…³è¡¨
            forums: '++id, name',
            forumPosts: '++id, forumId, timestamp, isUserPost',
            forumReplies: '++id, postId, timestamp',
            forumFavorites: '++id, [userId+postId], userId, postId',

            // è¯„è®ºç‚¹èµè¡¨
            replyLikes: '++id, [userId+replyId], userId, replyId, timestamp',

            // è®ºå›æ‰©å±•è¡¨
            forumPostImages: '++id, postId, imageUrl',
            forumMountedWorldbooks: '++id, &[forumId+worldbookId], forumId',

            // çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®è¡¨
            smsContacts: '++id, characterId, personaId, createdAt',

            // çŸ­ä¿¡æ¶ˆæ¯è¡¨
            smsMessages: '&id, characterId, timestamp, content, isUser, isImage, imageUrl, fileName',

            // çºªå¿µæ—¥å’Œçº¦å®šç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ userQuoteå­—æ®µæ”¯æŒç”¨æˆ·è¯­å½•
            anniversaries: '&id, name, date, type, yearly, characterId, createdBy, characterQuote, userQuote, isShared, isPinned, backgroundImage, userAvatar, countType',
            appointments: '&id, name, date, time, type, description, completed, priority, reminder, characterId, createdBy, characterQuote, userQuote, isShared, isPinned, backgroundImage, userAvatar, countType',

            // åŠ¨æ€å¯è§æ€§ã€ä½ç½®ä¿¡æ¯å’Œæé†’åŠŸèƒ½
            momentVisibility: '++id, momentId, visibility, visibleGroups, timestamp',
            momentLocations: '++id, momentId, locationName, latitude, longitude, timestamp',
            momentMentions: '++id, momentId, mentionedCharacterId, timestamp, isRead',

            // è¶³è¿¹åŠŸèƒ½
            characterFootprints: '&id, characterId, date, data, timestamp, lastUpdateTime, isComplete',
            footprintActivities: '++id, footprintId, time, activity, location, type, mood, timestamp',

            // è¡¨æƒ…åŒ…åº“åŠŸèƒ½
            emojiLibraries: '&id, name, description, createdAt, updatedAt',
            emojiLibraryItems: '++id, &[libraryId+emojiId], libraryId, emojiId, addedAt',

            // ğŸ”¥ã€æ–°å¢ã€‘æ—¥è®°è®¾ç½®è¡¨ - å°†localStorageçš„æ—¥è®°è®¾ç½®è¿ç§»åˆ°Dexie
            diarySettings: '&id, characterId, settingName, settingValue, timestamp',

            // ğŸ”¥ã€æ–°å¢ã€‘éŸ³æ•ˆç³»ç»Ÿè¡¨
            soundSettings: '&id, soundType, sourceType, sourceUrl, enabled, timestamp',

            // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸“å±éŸ³æ•ˆè¡¨
            characterSounds: '++id, characterId, soundType, sourceType, sourceUrl, enabled, timestamp',

            // --- ç„¶åï¼Œåœ¨æœ«å°¾è¿½åŠ æ–°è¡¨ ---
            // ğŸ”¥ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸»é¢˜ç³»ç»Ÿè¡¨
            globalThemes: '&id, themeType, themeData, timestamp',
            chatThemes: '++id, chatId, themeData, timestamp',
            themeSettings: '&id, settingName, settingValue, timestamp'
        }).upgrade(async trans => {
            // ğŸ”¥ã€æ–°å¢ã€‘è¿ç§»localStorageçš„è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®åˆ°Dexie
            try {
                console.log('ğŸ¨ å¼€å§‹è¿ç§»è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®åˆ°Dexieæ•°æ®åº“...');

                // 1. è¿ç§»å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®
                const globalCustomTheme = localStorage.getItem('globalCustomTheme');
                if (globalCustomTheme) {
                    try {
                        const globalThemeData = JSON.parse(globalCustomTheme);
                        await trans.globalThemes.add({
                            id: 'global',
                            themeType: 'global',
                            themeData: globalThemeData,
                            timestamp: Date.now()
                        });
                        console.log('âœ… å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®å·²è¿ç§»');
                        // è¿ç§»ååˆ é™¤localStorageæ•°æ®
                        localStorage.removeItem('globalCustomTheme');
                    } catch (parseError) {
                        console.warn('å…¨å±€ä¸»é¢˜æ•°æ®è§£æå¤±è´¥:', parseError);
                    }
                }

                // 2. è¿ç§»èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®
                let migratedChatThemes = 0;
                const allCharacters = await trans.characters.toArray();
                const allGroupChats = await trans.groupChats.toArray();

                // è¿ç§»è§’è‰²èŠå¤©ä¸»é¢˜
                for (const character of allCharacters) {
                    const themeKey = `customTheme_${character.id}`;
                    const themeData = localStorage.getItem(themeKey);
                    if (themeData) {
                        try {
                            const parsedThemeData = JSON.parse(themeData);
                            await trans.chatThemes.add({
                                chatId: character.id,
                                themeData: parsedThemeData,
                                timestamp: Date.now()
                            });
                            migratedChatThemes++;
                            // è¿ç§»ååˆ é™¤localStorageæ•°æ®
                            localStorage.removeItem(themeKey);
                        } catch (parseError) {
                            console.warn(`è§’è‰²ä¸»é¢˜æ•°æ®è§£æå¤±è´¥ (${character.id}):`, parseError);
                        }
                    }
                }

                // è¿ç§»ç¾¤èŠä¸»é¢˜
                for (const group of allGroupChats) {
                    const themeKey = `customTheme_${group.id}`;
                    const themeData = localStorage.getItem(themeKey);
                    if (themeData) {
                        try {
                            const parsedThemeData = JSON.parse(themeData);
                            await trans.chatThemes.add({
                                chatId: group.id,
                                themeData: parsedThemeData,
                                timestamp: Date.now()
                            });
                            migratedChatThemes++;
                            // è¿ç§»ååˆ é™¤localStorageæ•°æ®
                            localStorage.removeItem(themeKey);
                        } catch (parseError) {
                            console.warn(`ç¾¤èŠä¸»é¢˜æ•°æ®è§£æå¤±è´¥ (${group.id}):`, parseError);
                        }
                    }
                }

                if (migratedChatThemes > 0) {
                    console.log(`âœ… å·²è¿ç§» ${migratedChatThemes} ä¸ªèŠå¤©è‡ªå®šä¹‰ä¸»é¢˜`);
                }

                // 3. è¿ç§»ä¸»é¢˜è®¾ç½®
                const selectedTheme = localStorage.getItem('selectedTheme');
                if (selectedTheme) {
                    await trans.themeSettings.add({
                        id: 'selectedTheme',
                        settingName: 'selectedTheme',
                        settingValue: selectedTheme,
                        timestamp: Date.now()
                    });
                    console.log(`âœ… ä¸»é¢˜è®¾ç½®å·²è¿ç§»: ${selectedTheme}`);
                    // è¿ç§»ååˆ é™¤localStorageæ•°æ®
                    localStorage.removeItem('selectedTheme');
                }

                // 4. æ¸…ç†æ—§çš„ä¸»é¢˜æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldCustomThemeData = localStorage.getItem('customThemeData');
                if (oldCustomThemeData) {
                    console.log('ğŸ§¹ æ¸…ç†æ—§çš„ä¸»é¢˜æ•°æ®');
                    localStorage.removeItem('customThemeData');
                }

                console.log('âœ… è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®è¿ç§»å®Œæˆ');
            } catch (error) {
                console.error('âŒ è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®è¿ç§»å¤±è´¥:', error);
            }
        });

        // ğŸ”¥ã€ç‰ˆæœ¬ 41ã€‘çª—å£éš”ç¦»èŠå¤©è®¾ç½®ç³»ç»Ÿ
        db.version(41).stores({
            // --- å®Œæ•´å¤åˆ¶ç‰ˆæœ¬40çš„æ‰€æœ‰å†…å®¹ ---
            // åŸºç¡€æ•°æ®è¡¨
            characters: '&id, name, groupId',
            contacts: '++id, characterId',
            chatMessages: '&id, characterId, timestamp',

            // ç”¨æˆ·é¢å…·ç³»ç»Ÿ
            personas: '&id, name',

            // è¡¨æƒ…åŒ…ç³»ç»Ÿ - æ·»åŠ isPersonalå­—æ®µåŒºåˆ†ä¸ªäººè¡¨æƒ…åŒ…å’Œåº“è¡¨æƒ…åŒ…
            customEmojis: '&id, name, category, isPersonal',
            recentEmojis: '&id, lastUsed',

            // ä¸–ç•Œä¹¦ç³»ç»Ÿ
            worldbooks: '&id, name, isGlobal',
            worldbookEntries: '&id, worldbookId, keyword',

            // ç¾¤èŠç³»ç»Ÿ
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            groupChatMessages: '&id, groupId, timestamp',
            groupChatMembers: '&id, groupId, characterId',

            // åŠ¨æ€ç³»ç»Ÿ
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',

            // è®°å¿†ç³»ç»Ÿ
            workingMemory: '&id, characterId, timestamp, content, context',
            episodicMemory: '&id, characterId, date, summary, timestamp, context',
            episodicMemories: '&id, characterId, fact, importance, timestamp, category, contextId',
            memorySummaries: '&id, characterId, date, summary, timestamp, context',
            memoryEvents: '&id, characterIds, eventType, timestamp, context, eventData, importance',
            coreMemory: '&id, characterId, category, content, timestamp',
            coreMemories: '&id, characterId, fact, importance, timestamp, type, category, contextId',
            crossAppTimeline: '&id, characterId, appType, action, timestamp, context, messageId',

            // æ‹‰é»‘å’Œå¥½å‹ç³»ç»Ÿ
            blacklist: '&id, blockerId, blockedId, timestamp, reason',
            blockedCharacters: '&id, characterId, blockedBy, timestamp',
            friendRequests: '&id, fromId, toId, timestamp, status, type, message',
            characterStatus: '&id, characterId, status, activity, location, lastUpdate',

            // æ—¥è®°ç³»ç»Ÿ
            characterDiaries: '&id, characterId, date, content, timestamp, weather',

            // çº¿ä¸‹æ¨¡å¼ç³»ç»Ÿ
            offlineHistoryRecords: '&id, characterId, timestamp, summary, messages',
            offlineUISettings: '&id, characterId, settings, timestamp',
            offlinePresets: '&id, name, content, timestamp',

            // éŸ³ä¹æ’­æ”¾å™¨ç³»ç»Ÿ
            musicPlaylist: '&id, title, artist, album, duration, url, coverImage, lyrics, addedTime, isLocalFile',
            musicCovers: '&id, songId, imageData, timestamp',

            // è®¾ç½®å’Œé…ç½®
            apiSettings: '&id',
            globalSettings: '&id',
            wallpapers: '&id, name',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',

            // å¿ƒå£°ç³»ç»Ÿ
            innerThoughts: '&id, messageId, characterId, content, timestamp',

            // è®ºå›åŠŸèƒ½ç›¸å…³è¡¨
            forums: '++id, name',
            forumPosts: '++id, forumId, timestamp, isUserPost',
            forumReplies: '++id, postId, timestamp',
            forumFavorites: '++id, [userId+postId], userId, postId',

            // è¯„è®ºç‚¹èµè¡¨
            replyLikes: '++id, [userId+replyId], userId, replyId, timestamp',

            // è®ºå›æ‰©å±•è¡¨
            forumPostImages: '++id, postId, imageUrl',
            forumMountedWorldbooks: '++id, &[forumId+worldbookId], forumId',

            // çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®è¡¨
            smsContacts: '++id, characterId, personaId, createdAt',

            // çŸ­ä¿¡æ¶ˆæ¯è¡¨
            smsMessages: '&id, characterId, timestamp, content, isUser, isImage, imageUrl, fileName',

            // çºªå¿µæ—¥å’Œçº¦å®šç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ userQuoteå­—æ®µæ”¯æŒç”¨æˆ·è¯­å½•
            anniversaries: '&id, name, date, type, yearly, characterId, createdBy, characterQuote, userQuote, isShared, isPinned, backgroundImage, userAvatar, countType',
            appointments: '&id, name, date, time, type, description, completed, priority, reminder, characterId, createdBy, characterQuote, userQuote, isShared, isPinned, backgroundImage, userAvatar, countType',

            // åŠ¨æ€å¯è§æ€§ã€ä½ç½®ä¿¡æ¯å’Œæé†’åŠŸèƒ½
            momentVisibility: '++id, momentId, visibility, visibleGroups, timestamp',
            momentLocations: '++id, momentId, locationName, latitude, longitude, timestamp',
            momentMentions: '++id, momentId, mentionedCharacterId, timestamp, isRead',

            // è¶³è¿¹åŠŸèƒ½
            characterFootprints: '&id, characterId, date, data, timestamp, lastUpdateTime, isComplete',
            footprintActivities: '++id, footprintId, time, activity, location, type, mood, timestamp',

            // è¡¨æƒ…åŒ…åº“åŠŸèƒ½
            emojiLibraries: '&id, name, description, createdAt, updatedAt',
            emojiLibraryItems: '++id, &[libraryId+emojiId], libraryId, emojiId, addedAt',

            // ğŸ”¥ã€æ–°å¢ã€‘æ—¥è®°è®¾ç½®è¡¨ - å°†localStorageçš„æ—¥è®°è®¾ç½®è¿ç§»åˆ°Dexie
            diarySettings: '&id, characterId, settingName, settingValue, timestamp',

            // ğŸ”¥ã€æ–°å¢ã€‘éŸ³æ•ˆç³»ç»Ÿè¡¨
            soundSettings: '&id, soundType, sourceType, sourceUrl, enabled, timestamp',

            // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸“å±éŸ³æ•ˆè¡¨
            characterSounds: '++id, characterId, soundType, sourceType, sourceUrl, enabled, timestamp',

            // ğŸ”¥ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸»é¢˜ç³»ç»Ÿè¡¨
            globalThemes: '&id, themeType, themeData, timestamp',
            chatThemes: '++id, chatId, themeData, timestamp',
            themeSettings: '&id, settingName, settingValue, timestamp',

            // --- ç„¶åï¼Œåœ¨æœ«å°¾è¿½åŠ æ–°è¡¨ ---
            // ğŸ”¥ã€æ–°å¢ã€‘çª—å£éš”ç¦»èŠå¤©è®¾ç½®è¡¨
            windowChatSettings: '++id, &[chatId+windowId], chatId, windowId, settings, timestamp'
        });

        let selectedGroupMembers = []; // ç¾¤èŠæˆå‘˜é€‰æ‹©
        let currentWorldbookTab = 'global';


        // è§’è‰²åˆ†ç»„ç›¸å…³å˜é‡
        let characterGroups = []; // è§’è‰²åˆ†ç»„åˆ—è¡¨
        let isGroupManageMode = false; // åˆ†ç»„ç®¡ç†æ¨¡å¼
        let selectedGroupId = null; // å½“å‰é€‰ä¸­çš„åˆ†ç»„ID

        // è‡ªå®šä¹‰è¡¨æƒ…åŒ…ç›¸å…³å˜é‡
        let customEmojis = []; // ç”¨æˆ·ç›´æ¥ä¸Šä¼ çš„ä¸ªäººè¡¨æƒ…åŒ…ï¼ˆæ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ï¼‰
        let recentEmojis = []; // æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…åŒ…
        let currentEmojiTab = 'recent'; // å½“å‰è¡¨æƒ…åŒ…æ ‡ç­¾é¡µ
        let pendingPersonalEmojiData = null; // å¾…å¤„ç†çš„ä¸ªäººè¡¨æƒ…åŒ…æ•°æ®ï¼ˆç”¨äºæè¿°æ¨¡æ€æ¡†ï¼‰

        // é¢å…·åŒºåŸŸç›¸å…³å˜é‡
        let isPersonaExpanded = true; // é¢å…·åŒºåŸŸæ˜¯å¦å±•å¼€ï¼Œé»˜è®¤å±•å¼€

        // è¡¨æƒ…åŒ…åº“ç›¸å…³å˜é‡
        let emojiLibraries = []; // è¡¨æƒ…åŒ…åº“åˆ—è¡¨
        let currentEmojiLibrary = null; // å½“å‰æ­£åœ¨ç®¡ç†çš„è¡¨æƒ…åŒ…åº“
        let isEmojiLibraryExpanded = false; // è¡¨æƒ…åŒ…åº“åŒºåŸŸæ˜¯å¦å±•å¼€

        // æ¶ˆæ¯å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
        let isMessageSelectionMode = false; // æ¶ˆæ¯é€‰æ‹©æ¨¡å¼
        let selectedMessages = new Set(); // é€‰ä¸­çš„æ¶ˆæ¯IDé›†åˆ

        // æ¶ˆæ¯åˆ—è¡¨å¤šé€‰ç›¸å…³å˜é‡
        let isMessageListMultiSelectMode = false; // æ¶ˆæ¯åˆ—è¡¨å¤šé€‰æ¨¡å¼çŠ¶æ€
        let selectedConversations = []; // é€‰ä¸­çš„å¯¹è¯æ¡†IDåˆ—è¡¨

        // åŠ¨æ€è¯„è®ºå¯¹è¯å›åˆæ¬¡è¿½è¸ª
        let commentConversationRounds = new Map(); // æ ¼å¼: "momentId-characterId" => å›åˆæ¬¡æ•°

        // ğŸ”¥ã€æ–°å¢ã€‘æ‹‰é»‘ç³»ç»Ÿç›¸å…³å˜é‡å·²åœ¨åé¢å£°æ˜

        // ğŸ”¥ã€çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®ç®¡ç†ã€‘
        let smsContacts = []; // çŸ­ä¿¡åº”ç”¨çš„ç‹¬ç«‹è”ç³»äººåˆ—è¡¨
        let smsMessages = {}; // çŸ­ä¿¡åº”ç”¨çš„ç‹¬ç«‹æ¶ˆæ¯è®°å½• {characterId: [messages]}
        let pendingSMSMessages = []; // å¾…å›å¤æ¶ˆæ¯åˆ—è¡¨



        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
        let isSMSMultiSelectMode = false; // çŸ­ä¿¡å¤šé€‰æ¨¡å¼çŠ¶æ€
        let selectedSMSMessages = new Set(); // é€‰ä¸­çš„çŸ­ä¿¡æ¶ˆæ¯IDé›†åˆ

        let apiSettings = {
            type: 'openai',
            base: 'https://api.openai.com/v1',
            endpoint: '/chat/completions',
            key: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.70
        };

        // æ³¨æ„ï¼šè®°å¿†è®¾ç½®ç°åœ¨å·²æ”¹ä¸ºæ¯ä¸ªèŠå¤©çª—å£ç‹¬ç«‹çš„è®¾ç½®ï¼Œå­˜å‚¨åœ¨å„è‡ªçš„èŠå¤©è®¾ç½®ä¸­

        let chatSettings = {
            themeColor: '#007AFF',
            theirBubbleColor: '#f0f0f0',
            myBubbleColor: '#007AFF',
            bubbleOpacity: 1,
            timestampEnabled: true,
            timestampPosition: 'center'
        };


        let selectedAppIcon = null;
        let selectedWallpaper = null;
        let colorPickerContext = null;
        let customIconImage = null;

        // åŠ è½½å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®
        async function loadGlobalWorldbookSettings() {
            try {
                const globalSettings = await db.globalSettings.get('main');
                if (globalSettings && globalSettings.activeGlobalWorldbooks) {
                    // ç¡®ä¿ä½¿ç”¨window.activeGlobalWorldbooksä»¥åœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨
                    window.activeGlobalWorldbooks = globalSettings.activeGlobalWorldbooks;
                } else {
                    window.activeGlobalWorldbooks = [];
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¾ç½®ï¼Œåˆ›å»ºä¸€ä¸ªåˆå§‹è®¾ç½®
                    await db.globalSettings.put({
                        id: 'main',
                        activeGlobalWorldbooks: []
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®å¤±è´¥:', error);
                window.activeGlobalWorldbooks = [];
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async function() {
            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘é¦–å…ˆæ‰“å¼€æ•°æ®åº“
            try {
                await window.db.open();
                console.log('âœ… æ•°æ®åº“å·²æˆåŠŸæ‰“å¼€');
            } catch (error) {
                console.error('âŒ æ•°æ®åº“æ‰“å¼€å¤±è´¥:', error);
                // å¦‚æœæ•°æ®åº“æ‰“å¼€å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ›å»º
                try {
                    await window.db.delete();
                    window.db = new Dexie('PhoneChatDB');
                    // ğŸ”¥ã€å…³é”®ã€‘é‡æ–°åˆ›å»ºå…¨å±€åˆ«å
                    db = window.db;
                    // é‡æ–°å®šä¹‰æ•°æ®åº“ç»“æ„ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
                    window.db.version(41).stores({
                        characters: '&id, name, groupId',
                        contacts: '++id, characterId',
                        chatMessages: '&id, characterId, timestamp',
                        personas: '&id, name',
                        customEmojis: '&id, name, category, isPersonal',
                        recentEmojis: '&id, lastUsed'
                    });
                    await window.db.open();
                    console.log('âœ… æ•°æ®åº“é‡æ–°åˆ›å»ºå¹¶æ‰“å¼€æˆåŠŸ');
                } catch (recreateError) {
                    console.error('âŒ æ•°æ®åº“é‡æ–°åˆ›å»ºå¤±è´¥:', recreateError);
                }
            }

            initializeDataLoadPromise(); // ğŸ”¥ã€æ–°å¢ä¿®å¤ã€‘åˆå§‹åŒ–æ•°æ®åŠ è½½Promise
            updateTime();

            // ğŸ”¥ã€æ‰‹æœºä¿®å¤ã€‘éŸ³é¢‘ä¸Šä¸‹æ–‡è§£é”
            const unlockAudio = () => {
                console.log('ğŸ”“ ç”¨æˆ·äº¤äº’ï¼Œè§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡');
                SoundManager.isUnlocked = true; // æ ‡è®°éŸ³é¢‘å·²è§£é”
                // ç§»é™¤ç›‘å¬å™¨
                ['touchstart', 'mousedown', 'keydown', 'click'].forEach(event => {
                    document.removeEventListener(event, unlockAudio);
                });
            };

            // ç›‘å¬ç”¨æˆ·çš„ç¬¬ä¸€æ¬¡äº¤äº’
            ['touchstart', 'mousedown', 'keydown', 'click'].forEach(event => {
                document.addEventListener(event, unlockAudio, { once: true, passive: true });
            });

            // ğŸ”¥ã€æ–°å¢ã€‘æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥å’Œè¯Šæ–­
            console.log('ğŸ” å¼€å§‹æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥...');
            const isChrome = navigator.userAgent.includes('Chrome');
            const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
            const isFirefox = navigator.userAgent.includes('Firefox');

            console.log('æµè§ˆå™¨ç±»å‹:', { isChrome, isSafari, isFirefox });

            // ğŸ”¥ã€Chromeå…¼å®¹æ€§ä¿®å¤ã€‘ä¸ºChromeæ·»åŠ é¢å¤–çš„æ•°æ®åŠ è½½éªŒè¯
            if (isChrome) {
                console.log('ğŸ”§ æ£€æµ‹åˆ°Chromeæµè§ˆå™¨ï¼Œå¯ç”¨å…¼å®¹æ€§å¢å¼ºæ¨¡å¼');
                // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
                window.addEventListener('error', function(e) {
                    if (e.message.includes('contacts') || e.message.includes('characters')) {
                        console.warn('ğŸ”§ æ£€æµ‹åˆ°æ•°æ®ç›¸å…³é”™è¯¯ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤:', e.message);
                        setTimeout(() => {
                            if (typeof forceFixDataConsistency === 'function') {
                                forceFixDataConsistency();
                            }
                        }, 1000);
                    }
                });
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ”¹è¿›Safarié•¿æŒ‰å¤„ç† - åªç¦ç”¨ç³»ç»Ÿèœå•ï¼Œä¿ç•™è‡ªå®šä¹‰é•¿æŒ‰åŠŸèƒ½
            if (navigator.userAgent.includes('Safari') && navigator.userAgent.includes('Mobile')) {
                // åªç¦ç”¨Safariçš„ç³»ç»Ÿä¸Šä¸‹æ–‡èœå•ï¼Œä½†ä¿ç•™è‡ªå®šä¹‰é•¿æŒ‰åŠŸèƒ½
                document.addEventListener('contextmenu', function(e) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥e.targetæ˜¯å¦å­˜åœ¨ä¸”æœ‰closestæ–¹æ³•
                    if (e.target && typeof e.target.closest === 'function') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰é•¿æŒ‰è§¦å‘çš„èœå•
                        if (e.target.closest('.message-menu, .sms-message-menu, .offline-message-menu')) {
                            return; // å…è®¸æˆ‘ä»¬çš„è‡ªå®šä¹‰èœå•æ˜¾ç¤º
                        }
                        // åªåœ¨æ¶ˆæ¯ç›¸å…³å…ƒç´ ä¸Šç¦ç”¨ç³»ç»Ÿèœå•
                        if (e.target.closest('.message-bubble, .offline-message-content, .message-item, .contact-item, .sms-message-bubble')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                }, { passive: false });

                // ğŸ”¥ã€ä¿®å¤ã€‘å‡å°‘å¯¹selectstartçš„å¹²æ‰°ï¼Œåªåœ¨çœŸæ­£éœ€è¦æ—¶ç¦ç”¨
                document.addEventListener('selectstart', function(e) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥e.targetæ˜¯å¦å­˜åœ¨ä¸”æœ‰closestæ–¹æ³•
                    if (e.target && typeof e.target.closest === 'function') {
                        // åªåœ¨éè¾“å…¥å…ƒç´ ä¸Šç¦ç”¨é€‰æ‹©
                        if (e.target.closest('.message-bubble, .offline-message-content') &&
                            !e.target.closest('input, textarea, [contenteditable]')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                }, { passive: false });

                // ğŸ”¥ã€ä¿®å¤ã€‘å‡å°‘å¯¹dragstartçš„å¹²æ‰°
                document.addEventListener('dragstart', function(e) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥e.targetæ˜¯å¦å­˜åœ¨ä¸”æœ‰closestæ–¹æ³•
                    if (e.target && typeof e.target.closest === 'function') {
                        if (e.target.closest('.message-bubble, .offline-message-content') &&
                            !e.target.closest('img, [draggable="true"]')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                }, { passive: false });

                console.log('âœ… Safarié•¿æŒ‰å¤„ç†å·²ä¼˜åŒ–');
            }

            // ğŸ”¥ã€æ–°å¢ã€‘ç§»åŠ¨ç«¯é•¿æŒ‰è°ƒè¯•åŠŸèƒ½
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                console.log('ğŸ“± æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œå¯ç”¨é•¿æŒ‰è°ƒè¯•æ¨¡å¼');

                // æ·»åŠ å…¨å±€è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨ç”¨äºè°ƒè¯•
                let debugTouchStart = null;
                document.addEventListener('touchstart', function(e) {
                    debugTouchStart = Date.now();
                    console.log('ğŸ” è§¦æ‘¸å¼€å§‹:', e.target.className);
                }, { passive: true });

                document.addEventListener('touchend', function(e) {
                    if (debugTouchStart) {
                        const duration = Date.now() - debugTouchStart;
                        if (duration > 500) {
                            console.log('ğŸ” é•¿æŒ‰æ£€æµ‹:', duration + 'ms', e.target.className);
                        }
                        debugTouchStart = null;
                    }
                }, { passive: true });
            }

            try {

            // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–çª—å£IDï¼Œç¡®ä¿çº¿ä¸‹æ¨¡å¼æ•°æ®éš”ç¦»
            initializeWindowId();

            // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®åº“å¥åº·æ£€æŸ¥
            console.log('ğŸ” å¼€å§‹æ•°æ®åº“å¥åº·æ£€æŸ¥...');
            const isHealthy = await checkDatabaseHealth();
            if (!isHealthy) {
                console.warn('âš ï¸ æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•é‡ç½®...');
                const resetSuccess = await resetDatabase();
                if (!resetSuccess) {
                    throw new Error('æ•°æ®åº“é‡ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨æ•°æ®');
                }
                console.log('âœ… æ•°æ®åº“å·²é‡ç½®ï¼Œç»§ç»­åˆå§‹åŒ–...');
            } else {
                console.log('âœ… æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡');
            }

            // ğŸ”¥ã€å·²ç§»é™¤ã€‘è¿ç§»æ—§çš„çº¿ä¸‹é¢„è®¾æ•°æ® - ç°åœ¨ç”±æ•°æ®åº“ç‰ˆæœ¬15è‡ªåŠ¨å¤„ç†

            // ğŸ”¥ã€æ¶æ„ä¿®å¤ã€‘æŒ‰æ­£ç¡®é¡ºåºåŠ è½½æ•°æ®
            console.log('ğŸ”„ å¼€å§‹æŒ‰é¡ºåºåŠ è½½æ•°æ®...');

            // ç¬¬ä¸€æ­¥ï¼šåŠ è½½åŸºç¡€æ•°æ®
            await Promise.all([
                loadCharacterGroups(), // å…ˆåŠ è½½åˆ†ç»„
                loadCharacters(), // åŠ è½½è§’è‰²
                loadChatMessages(),
                loadMemoryConfig(), // åŠ è½½è®°å¿†é…ç½®
                loadChatSettings(),
                loadApiSettings(),
                loadCustomEmojis(),
                loadEmojiLibraries(), // åŠ è½½è¡¨æƒ…åŒ…åº“
                loadGlobalWorldbookSettings(), // ç¡®ä¿åŠ è½½å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®
                initGlobalMemoryDB(), // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–å…¨å±€è®°å¿†æ•°æ®åº“
                loadCustomAppIcons(), // åŠ è½½è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡
                migrateFootprintsFromLocalStorage(), // ğŸ”¥ã€æ–°å¢ã€‘è¿ç§»è¶³è¿¹æ•°æ®ä»localStorageåˆ°Dexie
                cleanupFootprintsCache() // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†è¿‡æœŸçš„è¶³è¿¹ç¼“å­˜
            ]);

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†å·²ä¿å­˜çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
            console.log('ğŸ§¹ æ¸…ç†æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯...');
            cleanupBlockedSystemMessages();

            // ğŸ”¥ã€æ–°å¢ã€‘è‡ªåŠ¨ä¿®å¤æŸåçš„æ¶ˆæ¯å†…å®¹
            console.log('ğŸ”§ è‡ªåŠ¨ä¿®å¤æŸåçš„æ¶ˆæ¯...');
            const fixedCount = await autoFixCorruptedMessages();
            if (fixedCount > 0) {
                console.log(`âœ… è‡ªåŠ¨ä¿®å¤äº† ${fixedCount} æ¡æŸåçš„æ¶ˆæ¯`);
            }

            // ç¬¬äºŒæ­¥ï¼šåŠ è½½è”ç³»äººæ•°æ®ï¼ˆå¿…é¡»åœ¨è§’è‰²åŠ è½½å®Œæˆåï¼‰
            console.log('ğŸ”„ åŠ è½½è”ç³»äººæ•°æ®...');
            await loadContacts();

            // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½çŸ­ä¿¡åº”ç”¨çš„ç‹¬ç«‹æ•°æ®
            console.log('ğŸ”„ åŠ è½½çŸ­ä¿¡åº”ç”¨æ•°æ®...');
            await loadSMSContacts();
            await loadSMSMessages();
            loadPinnedSMSConversations();

            // è”ç³»äººæ•°æ®å·²æ­£å¸¸åŠ è½½ï¼Œæ— éœ€é¢å¤–å¤„ç†

            // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½ç½®é¡¶æ•°æ®
            loadPinnedConversations();

            // åŠ è½½å¤–è§‚è®¾ç½®
            loadPhoneBorderSetting();
            loadScreenSize();
            loadFontSizeSettings();
            loadGlobalFontSettings(); // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½å…¨å±€å­—ä½“è®¾ç½®
            loadStatusIconSetting();
            loadHomeFontColorSetting();
            loadClockStyleSetting(); // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½æ—¶é’Ÿæ ·å¼è®¾ç½®

            // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°å…¨å±€è®°å¿†çŠ¶æ€æ˜¾ç¤º
            updateGlobalMemoryStatusDisplay();

            // åŠ è½½åŠ¨æ€å›¾ç‰‡è®¾ç½®
            await loadMomentsImages();

            // åŠ è½½å…¶ä»–è®¾ç½®ï¼ˆåŒ…æ‹¬éœ€è¦æ•°æ®åº“çš„å£çº¸è®¾ç½®ï¼‰
            await loadWallpaper();
            await loadAppIcons();
            await loadSavedTheme();
            await loadWorldbooks();

            await loadPersonas();
            await loadGroupChats();

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥localStorageä½¿ç”¨æƒ…å†µ
            checkLocalStorageUsage();

            // åˆå§‹åŒ–è®°å¿†æŸ¥çœ‹å™¨
            await initMemoryViewer();

            // åˆå§‹åŒ–çºªå¿µæ—¥ç³»ç»Ÿ
            await loadAnniversaryList();
            await loadAppointmentList();

            // åˆå§‹åŒ–å°ç»„ä»¶
            initializeWidgets();

            // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–è®ºå›åº”ç”¨
            initializeForumApp();

            // ğŸ”¥ã€æ–°å¢ã€‘é¢„åŠ è½½çº¿ä¸‹æ¨¡å¼è®¾ç½®ï¼Œç¡®ä¿åˆ·æ–°åä¸ä¸¢å¤±
            await preloadOfflineUISettings();

            // ğŸ”¥ã€æµè§ˆå™¨å…¼å®¹æ€§ä¿®å¤ã€‘æ¸²æŸ“ç•Œé¢ - å¢å¼ºæ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
            try {
                console.log('ğŸ” æ¸²æŸ“å‰æ•°æ®çŠ¶æ€æ£€æŸ¥:', {
                    charactersCount: characters ? characters.length : 'undefined',
                    contactsCount: contacts ? contacts.length : 'undefined',
                    chatMessagesType: typeof chatMessages,
                    chatMessagesKeys: chatMessages ? Object.keys(chatMessages).length : 'undefined'
                });

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿åŸºç¡€æ•°æ®ç»“æ„å­˜åœ¨
                if (!characters) characters = [];
                if (!contacts) contacts = [];
                if (!chatMessages) chatMessages = {};

                // ğŸ”¥ã€ä¿®å¤ã€‘æ™ºèƒ½æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤è”ç³»äºº
                if (characters.length > 0 && contacts.length === 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰èŠå¤©è®°å½•ï¼Œå¦‚æœæœ‰åˆ™å¯èƒ½éœ€è¦æ¢å¤è”ç³»äºº
                    const hasAnyMessages = Object.keys(chatMessages).length > 0;
                    if (hasAnyMessages) {
                        console.warn('âš ï¸ æ£€æµ‹åˆ°æœ‰è§’è‰²å’ŒèŠå¤©è®°å½•ä½†æ— è”ç³»äººï¼Œå¯èƒ½éœ€è¦æ¢å¤');
                        const chatCharacterIds = Object.keys(chatMessages).filter(id =>
                            characters.some(char => char.id === id)
                        );
                        if (chatCharacterIds.length > 0) {
                            contacts = chatCharacterIds;
                            saveContacts().catch(err => console.error('ä¿å­˜è”ç³»äººå¤±è´¥:', err));
                            console.log(`ğŸ”§ ä»èŠå¤©è®°å½•æ¢å¤äº† ${contacts.length} ä¸ªè”ç³»äºº`);
                        }
                    } else {
                        console.log('âœ… æ— èŠå¤©è®°å½•ï¼Œè”ç³»äººä¸ºç©ºæ˜¯æ­£å¸¸çŠ¶æ€');
                    }
                }

                // æ¸²æŸ“ç•Œé¢
                renderMessageList();
                renderContactList();
                renderCharacterList();
                renderPersonaList();

                // ğŸ”¥ã€æ–°å¢ã€‘æ¸²æŸ“åéªŒè¯
                setTimeout(() => {
                    const messageItems = document.querySelectorAll('.message-item');
                    console.log(`âœ… æ¸²æŸ“éªŒè¯: æ˜¾ç¤ºäº† ${messageItems.length} ä¸ªå¯¹è¯`);

                    if (messageItems.length === 0 && characters.length > 0) {
                        console.warn('âš ï¸ æ¸²æŸ“å¼‚å¸¸æ£€æµ‹ï¼Œæ‰§è¡Œè¯Šæ–­...');
                        diagnoseBrowserCompatibility();

                        // å°è¯•ä¿®å¤
                        setTimeout(() => {
                            forceFixDataConsistency();
                        }, 1000);
                    }
                }, 500);

            } catch (renderError) {
                console.error('âŒ ç•Œé¢æ¸²æŸ“å¤±è´¥:', renderError);

                // ğŸ”¥ã€æµè§ˆå™¨å…¼å®¹æ€§ä¿®å¤ã€‘é™çº§å¤„ç†
                console.log('ğŸ”§ æ‰§è¡Œé™çº§æ¸²æŸ“å¤„ç†...');

                // ç¡®ä¿åŸºç¡€æ•°æ®ç»“æ„
                if (!chatMessages) chatMessages = {};
                if (!contacts) contacts = [];
                if (!characters) characters = [];

                // å°è¯•é‡æ–°æ¸²æŸ“
                try {
                    renderMessageList();
                    renderContactList();
                    renderCharacterList();
                } catch (secondError) {
                    console.error('âŒ é™çº§æ¸²æŸ“ä¹Ÿå¤±è´¥:', secondError);
                    // æœ€åçš„å…œåº•å¤„ç†
                    setTimeout(() => {
                        if (typeof forceFixDataConsistency === 'function') {
                            forceFixDataConsistency();
                        }
                    }, 2000);
                }
            }

            // åˆå§‹åŒ–æ—¶è®¾ç½®æ­£ç¡®çš„æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ - å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMåŠ è½½å®Œæˆ
            setTimeout(async () => {
                switchChatTab('message-list');
                // ç¡®ä¿appæ ‡é¢˜æœ‰chat-modeç±»å’Œæ­£ç¡®å†…å®¹
                const appTitle = document.querySelector('#chat-screen .app-title');
                if (appTitle) {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'ğŸ’¬';
                }

                // åˆå§‹åŒ–UIäº‹ä»¶ä¸ä¾èµ–äºcurrentChatCharacter
                initChatSettingsUIEvents();

                // ğŸ”¥ã€ä¿®å¤ã€‘å¼ºåˆ¶åº”ç”¨æ°”æ³¡æ ·å¼ï¼Œå³ä½¿æ²¡æœ‰å½“å‰èŠå¤©è§’è‰²
                applyBubbleStyle();

                // ğŸ”¥ã€æ–°å¢ã€‘åº”ç”¨è‡ªå®šä¹‰CSS
                applyCustomBubbleCSS();

                // å¦‚æœå·²ç»æœ‰èŠå¤©è§’è‰²ï¼Œæ‰åˆå§‹åŒ–è®¾ç½®å’Œä¸–ç•Œä¹¦
                if (currentChatCharacter) {
                initializeChatSettings(); // åˆå§‹åŒ–èŠå¤©è®¾ç½®ç•Œé¢
                updateWorldbookMountDisplay(); // æ›´æ–°ä¸–ç•Œä¹¦æŒ‚è½½æ˜¾ç¤º
                } else {
                    // åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…é€‰æ‹©èŠå¤©è§’è‰²
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å¯åŠ¨å…¨å±€åå°äº’åŠ¨ç³»ç»Ÿ
                await initGlobalBackgroundInteractionSystem();

                // åˆå§‹åŒ–è¡¨æƒ…åŒ…åº“ä¸Šä¼ åŠŸèƒ½
                initEmojiLibraryUpload();

            // ğŸ”¥ã€æ–°å¢ã€‘å¯åŠ¨è¶³è¿¹ç¼“å­˜çš„åˆå¤œè‡ªåŠ¨æ¸…ç†
            setupMidnightCacheCleanup();

                // ğŸ”¥ã€æ–°å¢ã€‘å¯åŠ¨çºªå¿µæ—¥å’Œçº¦å®šæé†’ç³»ç»Ÿ
                initAnniversaryReminderSystem();

                // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–éŸ³æ•ˆç®¡ç†å™¨
                await SoundManager.init();

                // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–è¶³è¿¹è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ
                initializeFootprintsAutoUpdate();
            }, 100);

            // æ¸©åº¦æ»‘å—æ˜¾ç¤º
            const temperatureSlider = document.getElementById('temperature-slider');
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);
            });
            }

            // åˆå§‹åŒ–APIè®¾ç½®ç•Œé¢
            initializeApiSettings();

            // é€æ˜åº¦æ»‘å—æ˜¾ç¤º
            document.getElementById('opacity-slider').addEventListener('input', function() {
                document.getElementById('opacity-value').textContent = Math.round(this.value * 100) + '%';
            });

            // æ–‡ä»¶é€‰æ‹©æ¡†äº‹ä»¶ç›‘å¬
            const songCoverInput = document.getElementById('song-cover-input');
            const fileInputText = document.querySelector('.file-input-text');
            if (songCoverInput && fileInputText) {
                songCoverInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        fileInputText.textContent = e.target.files[0].name;
                    } else {
                        fileInputText.textContent = 'æœªé€‰å°é¢';
                    }
                });
            }

            // æŒ‰Enteré”®å‘é€æ¶ˆæ¯
            document.getElementById('api-chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // é˜²æ­¢æ¢è¡Œ
                    sendApiMessage();
                }
            });

            // @ç¾¤æˆå‘˜åŠŸèƒ½ç›¸å…³å˜é‡
            let mentionDropdownVisible = false;
            let mentionStartPos = -1;
            let selectedMentionIndex = -1;
            let currentMentionQuery = '';

            // ç›‘å¬è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼Œå¤„ç†@ç¾¤æˆå‘˜åŠŸèƒ½
            document.getElementById('api-chat-input').addEventListener('input', function(e) {
                handleMentionInput(e);
            });

            // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œå¤„ç†@ç¾¤æˆå‘˜é€‰æ‹©
            document.getElementById('api-chat-input').addEventListener('keydown', function(e) {
                if (mentionDropdownVisible) {
                    handleMentionKeydown(e);
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—@ç¾¤æˆå‘˜ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('mention-dropdown');
                const input = document.getElementById('api-chat-input');
                if (mentionDropdownVisible && !dropdown.contains(e.target) && e.target !== input) {
                    hideMentionDropdown();
                }
            });



            // åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
            initializeAvatarUpload();

            // åˆå§‹åŒ–è¡¨æƒ…åŒ…ä¸Šä¼ åŠŸèƒ½
            initializeEmojiUpload();

            // åˆå§‹åŒ–åº”ç”¨å›¾æ ‡ä¸Šä¼ åŠŸèƒ½
            initializeIconUpload();

            // ç¡®ä¿å·¥å…·é¢æ¿åˆå§‹éšè—
            const toolsPanel = document.getElementById('tools-panel');
            if (toolsPanel) {
                toolsPanel.style.display = 'none';
            }

            // åˆå§‹åŒ–æ¶ˆæ¯é€‰æ‹©æ¨¡å¼çŠ¶æ€
            isMessageSelectionMode = false;
            selectedMessages.clear();

            // å›¾ç‰‡ä¸Šä¼ 
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];

                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ŒGIFæ ¼å¼ä¸è¢«Gemini APIæ”¯æŒ
                    if (file.type === 'image/gif') {
                        alert('æŠ±æ­‰ï¼ŒGemini API ä¸æ”¯æŒ GIF æ ¼å¼çš„å›¾ç‰‡ã€‚\n\nè¯·é€‰æ‹©å…¶ä»–æ ¼å¼çš„å›¾ç‰‡ï¼Œå¦‚ï¼š\nâ€¢ JPEG\nâ€¢ PNG\nâ€¢ WEBP');
                        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                        e.target.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ç›´æ¥å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼Œå°±åƒæ­£å¸¸çš„å›¾ç‰‡å‘é€ä¸€æ ·
                        sendImageMessage(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                e.target.value = '';
            });

            // è‡ªå®šä¹‰å£çº¸ä¸Šä¼ 
            document.getElementById('custom-wallpaper-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedWallpaper = event.target.result;

                        // æ›´æ–°é¢„è§ˆå®¹å™¨
                        const previewContainer = document.getElementById('wallpaper-preview-container');
                        if (previewContainer) {
                            previewContainer.innerHTML = `<img src="${selectedWallpaper}" class="wallpaper-preview-image" alt="å£çº¸é¢„è§ˆ">`;
                        }

                        // ä¸åœ¨è¿™é‡Œç«‹å³åº”ç”¨åˆ°ä¸»ç•Œé¢ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»åº”ç”¨æ—¶å†åº”ç”¨
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // è‡ªå®šä¹‰å›¾æ ‡ä¸Šä¼ 
            document.getElementById('custom-icon-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        customIconImage = event.target.result;
                        // æ›´æ–°é¢„è§ˆ
                        const previews = document.querySelectorAll('.icon-preview');
                        previews.forEach(preview => {
                            preview.style.backgroundImage = `url(${customIconImage})`;
                            preview.innerHTML = ''; // ç§»é™¤å›¾æ ‡
                        });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            setInterval(updateTime, 1000);
            initBatteryManager();

            // ğŸ”¥ã€æ–°å¢ä¿®å¤ã€‘åœ¨æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆåï¼Œå‘é€"ç»¿ç¯"ä¿¡å·
            resolveDataLoaded();
            console.log('âœ… æ‰€æœ‰åˆå§‹æ•°æ®åŠ è½½å®Œæˆï¼Œä¿¡å·å·²å‘é€ã€‚');

            // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿ
            setTimeout(async () => {
                try {
                    await initGlobalMomentsSystem();
                    console.log('âœ… å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }, 3000); // å»¶è¿Ÿ3ç§’ç¡®ä¿æ•°æ®å®Œå…¨åŠ è½½

            // ğŸ”¥ã€æ–°å¢ä¿®å¤ã€‘åœ¨æ‰€æœ‰æ•°æ®åŠ è½½åï¼Œå°è¯•æ¢å¤ä¸Šæ¬¡æ‰“å¼€çš„èŠå¤©
            const lastChatId = sessionStorage.getItem('currentChatCharacterId');
            if (lastChatId) {
                console.log('ğŸ”„ æ­£åœ¨æ¢å¤ä¸Šæ¬¡æ‰“å¼€çš„èŠå¤©:', lastChatId);
                // ç­‰å¾…æ•°æ®åŠ è½½çš„"ç»¿ç¯"ä¿¡å·
                dataLoadedPromise.then(() => {
                    const character = characters.find(c => c.id === lastChatId);
                    const group = groupChats.find(g => g.id === lastChatId);
                    const chatEntity = character || group;

                    if (chatEntity) {
                        // ä½¿ç”¨å¾®å°çš„å»¶è¿Ÿç¡®ä¿UIæ¸²æŸ“å®Œæˆ
                        setTimeout(() => {
                            startChat(chatEntity);
                        }, 100);
                    } else {
                        console.warn('æ— æ³•æ‰¾åˆ°ä¸Šæ¬¡èŠå¤©çš„è§’è‰²/ç¾¤ç»„:', lastChatId);
                        sessionStorage.removeItem('currentChatCharacterId');
                    }
                });
            }

            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);

                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                const errorMsg = `åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}\n\nå¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š\n1. åˆ·æ–°é¡µé¢é‡è¯•\n2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n3. è¿›å…¥è®¾ç½®â†’ç´§æ€¥æ¢å¤\n\né”™è¯¯ç±»å‹: ${error.name}`;

                // å¦‚æœæ˜¯æ•°æ®åº“é”™è¯¯ï¼Œå°è¯•é‡ç½®
                if (error.name === 'DataError' || error.name === 'InvalidStateError' || error.name === 'DexieError') {
                    console.log('æ£€æµ‹åˆ°æ•°æ®åº“é”™è¯¯ï¼Œå°è¯•é‡ç½®æ•°æ®åº“...');
                    if (confirm('æ£€æµ‹åˆ°æ•°æ®åº“é”™è¯¯ï¼Œæ˜¯å¦é‡ç½®æ•°æ®åº“ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                        try {
                            await resetDatabase();
                            location.reload(); // é‡ç½®ååˆ·æ–°é¡µé¢
                        } catch (resetError) {
                            console.error('é‡ç½®æ•°æ®åº“å¤±è´¥:', resetError);
                            alert('é‡ç½®æ•°æ®åº“å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨æ•°æ®åé‡è¯•ã€‚');
                        }
                    }
                } else {
                    alert(errorMsg);

                    // å°è¯•æ˜¾ç¤ºç´§æ€¥æ¢å¤ç•Œé¢
                    try {
                        // ç¡®ä¿åŸºæœ¬çš„DOMç»“æ„å­˜åœ¨
                        if (!characters) characters = [];
                        if (!contacts) contacts = [];
                        if (!chatMessages) chatMessages = {};

                        // å°è¯•æ˜¾ç¤ºè®¾ç½®é¡µé¢
                        showApp('settings-screen');

                        // å»¶è¿Ÿæ˜¾ç¤ºæ¢å¤æ¨¡æ€æ¡†
                        setTimeout(() => {
                            try {
                                const recoveryBtn = document.querySelector('[onclick="showRecoveryModal()"]');
                                if (recoveryBtn) {
                                    recoveryBtn.click();
                                }
                            } catch (e) {
                                console.error('æ— æ³•è‡ªåŠ¨æ‰“å¼€æ¢å¤ç•Œé¢:', e);
                            }
                        }, 1000);
                    } catch (e) {
                        console.error('æ— æ³•æ˜¾ç¤ºç´§æ€¥æ¢å¤ç•Œé¢:', e);
                    }
                }
            }
        });

        // æ˜¾ç¤º/éšè—åº”ç”¨
        function showApp(appId) {
            if (event) event.preventDefault();

            // éšè—æ‰€æœ‰appç•Œé¢
            const allApps = document.querySelectorAll('.app-screen');
            allApps.forEach(app => {
                app.style.display = 'none';
            });

            // éšè—ä¸»å±å¹•ç»„ä»¶
            const clockContainer = document.getElementById('clock-container');
            const homeGrid = document.getElementById('home-grid');
            const dockBar = document.getElementById('dock-bar');
            const mainStatusBar = document.getElementById('status-bar');
            if (clockContainer) clockContainer.style.display = 'none';
            if (homeGrid) homeGrid.style.display = 'none';
            if (dockBar) dockBar.style.display = 'none';

            // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨æ‰€æœ‰åº”ç”¨ç•Œé¢ä¸­éšè—ä¸»å±å¹•çŠ¶æ€æ ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            if (mainStatusBar) {
                mainStatusBar.style.display = 'none';
            }

            // æ˜¾ç¤ºç›®æ ‡ç•Œé¢
            const targetApp = document.getElementById(appId);
            if (!targetApp) {
                console.error(`åº”ç”¨ç•Œé¢ä¸å­˜åœ¨: ${appId}`);
                showToast(`ç•Œé¢ ${appId} ä¸å­˜åœ¨`, 'error');
                return;
            }
            targetApp.style.display = 'flex';

            // å¦‚æœæ˜¯èŠå¤©ç•Œé¢ï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
            if (appId === 'chat-screen') {
                renderMessageList();
            }

            // å¦‚æœæ˜¯çŸ­ä¿¡ç•Œé¢ï¼Œåˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨
            if (appId === 'messages-screen') {
                renderSMSMessageList();
            }

            // å¦‚æœæ˜¯çºªå¿µæ—¥ç•Œé¢ï¼ŒåŠ è½½çºªå¿µæ—¥åˆ—è¡¨
            if (appId === 'anniversary-screen') {
                loadAnniversaryList();
                loadAppointmentList();
            }

            // å¦‚æœæ˜¯APIè®¾ç½®ç•Œé¢ï¼Œåˆå§‹åŒ–è®¾ç½®
            if (appId === 'api-settings-screen') {
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    initializeApiSettings();
                }, 100);
            }

            // å¦‚æœæ˜¯éŸ³æ•ˆè®¾ç½®ç•Œé¢ï¼Œåˆå§‹åŒ–è®¾ç½®
            if (appId === 'sound-settings-screen') {
                setTimeout(() => {
                    initSoundSettings();
                }, 100);
            }

            // ğŸ¨ã€ä¿®æ”¹ã€‘å¦‚æœæ˜¯è‡ªå®šä¹‰ä¸»é¢˜ç•Œé¢ï¼Œåˆå§‹åŒ–ç•Œé¢ - æ”¯æŒasync
            if (appId === 'custom-theme-screen') {
                setTimeout(async () => {
                    await initCustomThemeScreen();
                }, 100);
            }
        }



        // éšè—è§’è‰²åˆ›å»ºè¡¨å•ï¼Œè¿”å›åˆ°chatç•Œé¢çš„é€šè®¯å½•
        function hideCharacterForm() {
            // åœ¨éšè—è¡¨å•æ—¶æ¸…ç©ºè¡¨å•æ•°æ®
            clearCharacterForm();

            hideApp('character-form-screen');
            showApp('chat-screen');
            switchChatTab('contact-list');
            // æ‰‹åŠ¨è§¦å‘æ ‡ç­¾åˆ‡æ¢çš„æ ·å¼
            const chatTabs = document.querySelectorAll('.chat-tab');
            chatTabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            // å®‰å…¨åœ°æ·»åŠ activeç±»åˆ°ç¬¬äºŒä¸ªæ ‡ç­¾ï¼ˆé€šè®¯å½•ï¼‰
            if (chatTabs.length > 1 && chatTabs[1] && chatTabs[1].classList) {
                chatTabs[1].classList.add('active');
            }
        }

        function hideApp(appId) {
            document.getElementById(appId).style.display = 'none';

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åº”ç”¨éƒ½å·²éšè—ï¼Œå¦‚æœæ˜¯ï¼Œæ˜¾ç¤ºä¸»å±å¹•ç»„ä»¶
            const allApps = document.querySelectorAll('.app-screen');
            const hasVisibleApp = Array.from(allApps).some(app =>
                app.style.display === 'flex' || app.style.display === 'block'
            );

            if (!hasVisibleApp) {
                // æ˜¾ç¤ºä¸»å±å¹•ç»„ä»¶
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                const dockBar = document.getElementById('dock-bar');
                const mainStatusBar = document.getElementById('status-bar');
                if (clockContainer) clockContainer.style.display = 'block';
                if (homeGrid) homeGrid.style.display = 'grid';
                if (dockBar) dockBar.style.display = 'block';
                // ğŸ”¥ã€ä¿®å¤ã€‘æ¢å¤ä¸»å±å¹•çŠ¶æ€æ æ˜¾ç¤º
                if (mainStatusBar) mainStatusBar.style.display = 'flex';
            } else {
                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœè¿˜æœ‰å…¶ä»–åº”ç”¨æ˜¾ç¤ºï¼Œéšè—ä¸»å±å¹•çŠ¶æ€æ é¿å…é‡å¤
                const mainStatusBar = document.getElementById('status-bar');
                if (mainStatusBar) {
                    mainStatusBar.style.display = 'none';
                }
            }
        }

        // æ˜¾ç¤º/éšè—æ¨¡æ€æ¡†
        function showModal(modalId) {
            console.log('showModal called with:', modalId);
            const modal = document.getElementById(modalId);
            console.log('Modal element:', modal);
            if (modal) {
                modal.style.display = 'flex';
                console.log('Modal display set to flex');
            } else {
                console.log('Modal element not found!');
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // çºªå¿µæ—¥åŠŸèƒ½
        let anniversaries = [];
        let editingAnniversaryId = null;

        // çº¦å®šåŠŸèƒ½
        let appointments = [];
        let editingAppointmentId = null;

        // çºªå¿µæ—¥åˆ†æ åˆ‡æ¢åŠŸèƒ½
        function switchAnniversaryTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.anniversary-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.anniversary-tab[onclick*="${tabName}"]`).classList.add('active');

            // åˆ‡æ¢å†…å®¹åŒºåŸŸ
            document.getElementById('anniversary-content').style.display = tabName === 'anniversary' ? 'block' : 'none';
            document.getElementById('appointment-content').style.display = tabName === 'appointment' ? 'block' : 'none';

            // æ›´æ–°å¤´éƒ¨æŒ‰é’®åŠŸèƒ½
            const addBtn = document.querySelector('#anniversary-screen .add-anniversary-btn');
            if (tabName === 'anniversary') {
                addBtn.onclick = showAnniversaryForm;
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.title = 'æ·»åŠ çºªå¿µæ—¥';
            } else {
                addBtn.onclick = () => showAppointmentForm();
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.title = 'æ·»åŠ çº¦å®š';
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©ç•Œé¢åˆ†æ åˆ‡æ¢åŠŸèƒ½
        function switchShoppingTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.shopping-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.shopping-tab[onclick*="${tabName}"]`).classList.add('active');

            // ğŸ”¥ã€ä¿®å¤ã€‘éšè—å•†å“å±•ç¤ºåŒºåŸŸï¼Œæ˜¾ç¤ºåˆ†ç±»é€‰æ‹©
            const categoriesDiv = document.getElementById('shopping-categories');
            const productsDiv = document.getElementById('products-container');
            const searchContainer = document.querySelector('.shopping-search-container');
            const appTitle = document.querySelector('#shopping-screen .app-title');
            const shoppingContent = document.querySelector('.shopping-content');

            // é‡ç½®åˆ°åˆ†ç±»é€‰æ‹©çŠ¶æ€
            categoriesDiv.style.display = 'block';
            searchContainer.style.display = 'block';
            productsDiv.style.display = 'none';
            shoppingContent.classList.remove('showing-products');

            // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®æ ‡ç­¾é¡µåŠ¨æ€è®¾ç½®æ ‡é¢˜
            if (tabName === 'takeout') {
                appTitle.textContent = 'å¤–å–';
            } else if (tabName === 'shopping') {
                appTitle.textContent = 'è´­ç‰©';
            }

            // ğŸ”¥ã€æ–°å¢ã€‘ç¡®ä¿æœç´¢æ¡†ä½ç½®ç¨³å®š
            searchContainer.style.position = 'relative';
            searchContainer.style.left = '0';
            searchContainer.style.transform = 'none';

            // åˆ‡æ¢åˆ†ç±»æ˜¾ç¤º
            const takeoutCategories = document.getElementById('takeout-categories');
            const shoppingCategoriesList = document.getElementById('shopping-categories-list');

            if (tabName === 'takeout') {
                takeoutCategories.style.display = 'flex';
                shoppingCategoriesList.style.display = 'none';
            } else if (tabName === 'shopping') {
                takeoutCategories.style.display = 'none';
                shoppingCategoriesList.style.display = 'flex';
            }

            console.log('åˆ‡æ¢åˆ°è´­ç‰©æ ‡ç­¾é¡µ:', tabName);
        }

        // ğŸ›’ã€æ–°å¢ã€‘å•†å“æ•°æ®
        const productsData = {
            'ç¾é£Ÿ': [
                {name: 'éº»è¾£é¦™é”…', brand: 'æµ·åº•æ', price: 45.8, options: {size: ['å°ä»½', 'ä¸­ä»½', 'å¤§ä»½'], spicy: ['ä¸è¾£', 'å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£']}, prices: {size: {'å°ä»½': 38, 'ä¸­ä»½': 46, 'å¤§ä»½': 58}}},
                {name: 'å®«ä¿é¸¡ä¸', brand: 'çœŸåŠŸå¤«', price: 28.5, options: {size: ['å°ä»½', 'å¤§ä»½'], spicy: ['ä¸è¾£', 'å¾®è¾£', 'ä¸­è¾£']}, prices: {size: {'å°ä»½': 24, 'å¤§ä»½': 36}}},
                {name: 'çº¢çƒ§è‚‰', brand: 'è€ä¹¡é¸¡', price: 32.0, options: {size: ['å°ä»½', 'å¤§ä»½']}, prices: {size: {'å°ä»½': 26, 'å¤§ä»½': 42}}},
                {name: 'é…¸èœé±¼', brand: 'å¤ªäºŒ', price: 68.0, options: {size: ['1-2äººä»½', '3-4äººä»½'], spicy: ['å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£']}, prices: {size: {'1-2äººä»½': 68, '3-4äººä»½': 93}}},
                {name: 'å…°å·æ‹‰é¢', brand: 'é©¬å­ç¦„', price: 18.0, options: {noodle: ['ç»†é¢', 'å®½é¢'], soup: ['æ¸…æ±¤', 'çº¢æ±¤']}, prices: {soup: {'æ¸…æ±¤': 18, 'çº¢æ±¤': 20}}},
                {name: 'å°ç¬¼åŒ…', brand: 'é¼æ³°ä¸°', price: 35.0, options: {count: ['6ä¸ª', '8ä¸ª', '12ä¸ª']}, prices: {count: {'6ä¸ª': 35, '8ä¸ª': 43, '12ä¸ª': 53}}},
                {name: 'çƒ¤é¸­', brand: 'å…¨èšå¾·', price: 128.0, options: {size: ['åŠåª', 'æ•´åª']}, prices: {size: {'åŠåª': 128, 'æ•´åª': 188}}},
                {name: 'éº»å©†è±†è…', brand: 'é™ˆéº»å©†', price: 22.0, options: {spicy: ['å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£']}},
                {name: 'ç³–é†‹é‡Œè„Š', brand: 'å¤–å©†å®¶', price: 38.0, options: {size: ['å°ä»½', 'å¤§ä»½']}},
                {name: 'æ°´ç…®é±¼', brand: 'å·´å¥´', price: 58.0, options: {size: ['1-2äººä»½', '3-4äººä»½'], spicy: ['ä¸­è¾£', 'ç‰¹è¾£', 'å˜æ€è¾£']}},
                {name: 'å›é”…è‚‰', brand: 'å·è¥¿åå­', price: 42.0, options: {spicy: ['å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£']}},
                {name: 'è’¸è›‹ç¾¹', brand: 'è€å¨˜èˆ…', price: 15.0, options: {flavor: ['åŸå‘³', 'è‚‰æœ«', 'è™¾ä»']}, prices: {flavor: {'åŸå‘³': 15, 'è‚‰æœ«': 18, 'è™¾ä»': 20}}},
                {name: 'çº¢çƒ§æ’éª¨', brand: 'å‘³åƒæ‹‰é¢', price: 48.0, options: {size: ['å°ä»½', 'å¤§ä»½']}, prices: {size: {'å°ä»½': 38, 'å¤§ä»½': 63}}},
                {name: 'é±¼é¦™è‚‰ä¸', brand: 'çœ‰å·ä¸œå¡', price: 35.0, options: {spicy: ['å¾®è¾£', 'ä¸­è¾£']}},
                {name: 'ç™½åˆ‡é¸¡', brand: 'å¹¿å·é…’å®¶', price: 45.0, options: {size: ['åŠåª', 'æ•´åª']}, prices: {size: {'åŠåª': 45, 'æ•´åª': 80}}},
                {name: 'è›‹ç‚’é¥­', brand: 'æ‰¬å·ç‚’é¥­', price: 25.0, options: {ingredients: ['æ™®é€š', 'è™¾ä»', 'å‰çƒ§', 'æµ·é²œ']}, prices: {ingredients: {'æ™®é€š': 25, 'è™¾ä»': 33, 'å‰çƒ§': 31, 'æµ·é²œ': 37}}},
                {name: 'æ‹…æ‹…é¢', brand: 'æˆéƒ½å°åƒ', price: 20.0, options: {spicy: ['å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£'], noodle: ['ç»†é¢', 'å®½é¢']}},
                {name: 'å£æ°´é¸¡', brand: 'å»–è®°æ£’æ£’é¸¡', price: 32.0, options: {spicy: ['å¾®è¾£', 'ä¸­è¾£', 'ç‰¹è¾£']}},
                {name: 'çº¢çƒ§èŒ„å­', brand: 'å†œå®¶å°ç‚’', price: 18.0, options: {size: ['å°ä»½', 'å¤§ä»½']}, prices: {size: {'å°ä»½': 15, 'å¤§ä»½': 23}}},
                {name: 'æ¸…è’¸é²ˆé±¼', brand: 'æ¸”å®¶å‚²', price: 68.0, options: {weight: ['1æ–¤', '1.5æ–¤', '2æ–¤']}, prices: {weight: {'1æ–¤': 68, '1.5æ–¤': 88, '2æ–¤': 108}}}
            ],
            'ç”œç‚¹é¥®å“': [
                {name: 'çç å¥¶èŒ¶', brand: 'å–œèŒ¶', price: 25.0, options: {sugar: ['æ— ç³–', 'ä¸‰åˆ†ç³–', 'äº”åˆ†ç³–', 'ä¸ƒåˆ†ç³–', 'å…¨ç³–'], ice: ['å¤šå†°', 'å°‘å†°', 'å¸¸æ¸©', 'çƒ­'], size: ['å°æ¯', 'ä¸­æ¯', 'å¤§æ¯']}, prices: {size: {'å°æ¯': 22, 'ä¸­æ¯': 25, 'å¤§æ¯': 30}}},
                {name: 'èŠå£«è›‹ç³•', brand: 'æ˜Ÿå·´å…‹', price: 38.0, options: {flavor: ['åŸå‘³', 'è‰è“', 'è“è“', 'å·§å…‹åŠ›']}},
                {name: 'ææ‹‰ç±³è‹', brand: '85åº¦C', price: 32.0, options: {size: ['å°ä»½', 'å¤§ä»½']}, prices: {size: {'å°ä»½': 27, 'å¤§ä»½': 40}}},
                {name: 'æŠ¹èŒ¶æ‹¿é“', brand: 'ç‘å¹¸å’–å•¡', price: 28.0, options: {sugar: ['æ— ç³–', 'åŠç³–', 'å…¨ç³–'], ice: ['å¤šå†°', 'å°‘å†°', 'å¸¸æ¸©', 'çƒ­'], size: ['å°æ¯', 'ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'çº¢è±†æ²™å†°', brand: 'æ»¡è®°ç”œå“', price: 22.0, options: {ice: ['å¤šå†°', 'å°‘å†°'], size: ['å°æ¯', 'å¤§æ¯']}},
                {name: 'èŠ’æœç­æˆŸ', brand: 'è®¸ç•™å±±', price: 35.0, options: {count: ['1ä¸ª', '2ä¸ª', '4ä¸ª']}, prices: {count: {'1ä¸ª': 35, '2ä¸ª': 50, '4ä¸ª': 70}}},
                {name: 'åŒçš®å¥¶', brand: 'å—ä¿¡ç‰›å¥¶ç”œå“', price: 18.0, options: {flavor: ['åŸå‘³', 'çº¢è±†', 'èŠ’æœ']}},
                {name: 'æŸ æª¬èŒ¶', brand: 'èŒ¶é¢œæ‚¦è‰²', price: 20.0, options: {sugar: ['æ— ç³–', 'ä¸‰åˆ†ç³–', 'äº”åˆ†ç³–', 'ä¸ƒåˆ†ç³–'], ice: ['å¤šå†°', 'å°‘å†°', 'å¸¸æ¸©'], size: ['ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'é©¬å¡é¾™', brand: 'LadurÃ©e', price: 45.0, options: {flavor: ['é¦™è‰', 'å·§å…‹åŠ›', 'è‰è“', 'æŸ æª¬'], count: ['3ä¸ª', '6ä¸ª', '12ä¸ª']}},
                {name: 'å¸ƒä¸', brand: 'ä¼˜æ ¼', price: 15.0, options: {flavor: ['åŸå‘³', 'ç„¦ç³–', 'èŠ’æœ', 'è‰è“']}},
                {name: 'çƒ§ä»™è‰', brand: 'ä¹¦äº¦çƒ§ä»™è‰', price: 18.0, options: {sugar: ['ä¸‰åˆ†ç³–', 'äº”åˆ†ç³–', 'ä¸ƒåˆ†ç³–'], ice: ['å¤šå†°', 'å°‘å†°', 'å¸¸æ¸©'], size: ['ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'èŠ‹åœ†', brand: 'é²œèŠ‹ä»™', price: 22.0, options: {ice: ['å¤šå†°', 'å°‘å†°'], toppings: ['çº¢è±†', 'ç»¿è±†', 'èŠ±ç”Ÿ', 'æ¤°æœ']}},
                {name: 'å†°æ·‡æ·‹', brand: 'å“ˆæ ¹è¾¾æ–¯', price: 58.0, options: {flavor: ['é¦™è‰', 'å·§å…‹åŠ›', 'è‰è“', 'æŠ¹èŒ¶'], size: ['å°æ¯', 'å¤§æ¯']}},
                {name: 'å¸åº·é¥¼', brand: 'é¢åŒ…æ–°è¯­', price: 25.0, options: {flavor: ['åŸå‘³', 'è“è“', 'å·§å…‹åŠ›']}},
                {name: 'æ³¡èŠ™', brand: 'åŸéº¦å±±ä¸˜', price: 28.0, options: {flavor: ['å¥¶æ²¹', 'å·§å…‹åŠ›', 'æŠ¹èŒ¶'], count: ['3ä¸ª', '6ä¸ª']}},
                {name: 'æœæ±', brand: 'é²œæœæ—¶é—´', price: 20.0, options: {flavor: ['æ©™æ±', 'è‹¹æœæ±', 'è‘¡è„æ±', 'è¥¿ç“œæ±'], size: ['ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'å’–å•¡', brand: 'ç‘å¹¸å’–å•¡', price: 24.0, options: {type: ['ç¾å¼', 'æ‹¿é“', 'å¡å¸ƒå¥‡è¯º'], sugar: ['æ— ç³–', 'åŠç³–', 'å…¨ç³–'], size: ['å°æ¯', 'ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'å¥¶æ˜”', brand: 'DQ', price: 32.0, options: {flavor: ['é¦™è‰', 'å·§å…‹åŠ›', 'è‰è“', 'èŠ’æœ'], size: ['å°æ¯', 'ä¸­æ¯', 'å¤§æ¯']}},
                {name: 'è›‹æŒ', brand: 'KFC', price: 8.0, options: {count: ['1ä¸ª', '6ä¸ª', '12ä¸ª']}},
                {name: 'èˆ’èŠ™è•¾', brand: 'å¹¸ç¦è¥¿é¥¼', price: 42.0, options: {flavor: ['åŸå‘³', 'å·§å…‹åŠ›', 'æŠ¹èŒ¶']}}
            ],
            'è”¬èœæ°´æœ': [
                {name: 'æœ‰æœºè‹¹æœ', brand: 'ä½³æ²›', price: 12.8, options: {weight: ['500g', '1kg', '2kg'], type: ['çº¢å¯Œå£«', 'é’è‹¹æœ']}},
                {name: 'è¿›å£é¦™è•‰', brand: 'éƒ½ä¹', price: 8.5, options: {weight: ['500g', '1kg']}},
                {name: 'æ–°é²œè‰è“', brand: 'ä¸¹ä¸œè‰è“', price: 25.0, options: {weight: ['250g', '500g', '1kg']}},
                {name: 'æœ‰æœºè¥¿çº¢æŸ¿', brand: 'å¯¿å…‰è”¬èœ', price: 6.8, options: {weight: ['500g', '1kg'], type: ['å°ç•ªèŒ„', 'å¤§ç•ªèŒ„']}},
                {name: 'æ–°é²œé»„ç“œ', brand: 'å±±ä¸œè”¬èœ', price: 4.5, options: {weight: ['500g', '1kg']}},
                {name: 'æœ‰æœºèƒ¡èåœ', brand: 'ç»¿è‰²å†œåœº', price: 5.2, options: {weight: ['500g', '1kg']}},
                {name: 'æ–°é²œè èœ', brand: 'æœ¬åœ°å†œåœº', price: 3.8, options: {weight: ['250g', '500g']}},
                {name: 'è¿›å£ç‰›æ²¹æœ', brand: 'å¢¨è¥¿å“¥', price: 18.0, options: {count: ['2ä¸ª', '4ä¸ª', '6ä¸ª'], ripeness: ['ç”Ÿ', 'åŠç†Ÿ', 'ç†Ÿ']}},
                {name: 'æœ‰æœºç™½èœ', brand: 'ä¸œåŒ—å†œåœº', price: 3.2, options: {weight: ['500g', '1kg', '2kg']}},
                {name: 'æ–°é²œèŠ¹èœ', brand: 'æœ¬åœ°è”¬èœ', price: 4.0, options: {weight: ['250g', '500g']}},
                {name: 'è¿›å£æ©™å­', brand: 'æ–°å¥‡å£«', price: 15.8, options: {weight: ['1kg', '2kg'], type: ['è„æ©™', 'è¡€æ©™']}},
                {name: 'æœ‰æœºåœŸè±†', brand: 'å†…è’™å¤', price: 4.8, options: {weight: ['1kg', '2kg', '5kg']}},
                {name: 'æ–°é²œéŸ­èœ', brand: 'æœ¬åœ°å†œåœº', price: 6.0, options: {weight: ['250g', '500g']}},
                {name: 'è¿›å£çŒ•çŒ´æ¡ƒ', brand: 'ä½³æ²›', price: 28.0, options: {count: ['6ä¸ª', '12ä¸ª'], type: ['ç»¿å¿ƒ', 'é»„å¿ƒ', 'çº¢å¿ƒ']}},
                {name: 'æœ‰æœºèŒ„å­', brand: 'å±±ä¸œè”¬èœ', price: 7.5, options: {weight: ['500g', '1kg'], type: ['é•¿èŒ„å­', 'åœ†èŒ„å­']}},
                {name: 'æ–°é²œè‘¡è„', brand: 'æ–°ç–†è‘¡è„', price: 22.0, options: {weight: ['500g', '1kg'], type: ['çº¢æ', 'é’æ', 'å·¨å³°']}},
                {name: 'æœ‰æœºå¤§è’œ', brand: 'å±±ä¸œå¤§è’œ', price: 12.0, options: {weight: ['250g', '500g']}},
                {name: 'æ–°é²œæŸ æª¬', brand: 'å››å·æŸ æª¬', price: 8.8, options: {count: ['3ä¸ª', '6ä¸ª', '10ä¸ª']}},
                {name: 'è¿›å£è“è“', brand: 'æ™ºåˆ©è“è“', price: 35.0, options: {weight: ['125g', '250g']}},
                {name: 'æœ‰æœºç”Ÿèœ', brand: 'æœ¬åœ°å†œåœº', price: 5.5, options: {weight: ['250g', '500g'], type: ['çƒç”Ÿèœ', 'æ•£å¶ç”Ÿèœ']}}
            ],
            'çœ‹ç—…ä¹°è¯': [
                {name: 'æ„Ÿå†’çµé¢—ç²’', brand: '999', price: 18.5, options: {package: ['6è¢‹è£…', '12è¢‹è£…', '24è¢‹è£…']}},
                {name: 'æ¿è“æ ¹é¢—ç²’', brand: 'ç™½äº‘å±±', price: 15.0, options: {package: ['10è¢‹è£…', '20è¢‹è£…']}},
                {name: 'ç»´ç”Ÿç´ C', brand: 'æ±¤è‡£å€å¥', price: 68.0, options: {count: ['60ç‰‡', '100ç‰‡'], type: ['å’€åš¼ç‰‡', 'æ³¡è…¾ç‰‡']}},
                {name: 'åˆ›å¯è´´', brand: 'é‚¦è¿ª', price: 12.0, options: {size: ['æ ‡å‡†å‹', 'å¤§å·', 'é˜²æ°´å‹'], count: ['10ç‰‡', '20ç‰‡']}},
                {name: 'ä½“æ¸©è®¡', brand: 'æ¬§å§†é¾™', price: 85.0, options: {type: ['ç”µå­ä½“æ¸©è®¡', 'çº¢å¤–ä½“æ¸©è®¡']}},
                {name: 'ç¢˜ä¼', brand: 'åˆ©åº·', price: 8.5, options: {volume: ['30ml', '60ml', '100ml']}},
                {name: 'æ­¢ç—›ç‰‡', brand: 'èŠ¬å¿…å¾—', price: 25.0, options: {count: ['12ç‰‡', '24ç‰‡']}},
                {name: 'èƒƒè¯', brand: 'è¾¾å–œ', price: 32.0, options: {count: ['20ç‰‡', '40ç‰‡']}},
                {name: 'çœ¼è¯æ°´', brand: 'çè§†æ˜', price: 18.0, options: {volume: ['10ml', '15ml'], type: ['ç¼“è§£ç–²åŠ³', 'æŠ—èŒæ¶ˆç‚']}},
                {name: 'å£ç½©', brand: '3M', price: 45.0, options: {type: ['åŒ»ç”¨å¤–ç§‘', 'N95'], count: ['10ä¸ª', '50ä¸ª']}},
                {name: 'è¡€å‹è®¡', brand: 'æ¬§å§†é¾™', price: 298.0, options: {type: ['ä¸Šè‡‚å¼', 'æ‰‹è…•å¼']}},
                {name: 'é’™ç‰‡', brand: 'é’™å°”å¥‡', price: 88.0, options: {count: ['60ç‰‡', '100ç‰‡'], type: ['ç¢³é…¸é’™', 'æŸ æª¬é…¸é’™']}},
                {name: 'æ¶ˆæ¯’æ¶²', brand: 'æ»´éœ²', price: 22.0, options: {volume: ['500ml', '1L'], type: ['è¡£ç‰©æ¶ˆæ¯’', 'åœ°é¢æ¶ˆæ¯’']}},
                {name: 'çº±å¸ƒ', brand: 'æŒ¯å¾·', price: 15.0, options: {size: ['5cmÃ—5m', '10cmÃ—5m'], type: ['æ— èŒ', 'æ™®é€š']}},
                {name: 'é€€çƒ§è¯', brand: 'ç¾æ—', price: 28.0, options: {type: ['å„¿ç«¥è£…', 'æˆäººè£…'], volume: ['100ml', '200ml']}},
                {name: 'æŠ¤è‚ç‰‡', brand: 'è‘µèŠ±', price: 45.0, options: {count: ['36ç‰‡', '72ç‰‡']}},
                {name: 'æ­¢å’³ç³–æµ†', brand: 'æ€¥æ”¯ç³–æµ†', price: 24.0, options: {volume: ['100ml', '200ml']}},
                {name: 'èƒ°å²›ç´ ç¬”', brand: 'è¯ºå’Œè¯ºå¾·', price: 180.0, options: {type: ['é€Ÿæ•ˆ', 'é•¿æ•ˆ']}},
                {name: 'è¡€ç³–è¯•çº¸', brand: 'å¼ºç”Ÿ', price: 120.0, options: {count: ['25ç‰‡', '50ç‰‡']}},
                {name: 'ç»´ç”Ÿç´ D', brand: 'è‡ªç„¶ä¹‹å®', price: 78.0, options: {count: ['60ç²’', '100ç²’'], strength: ['400IU', '1000IU']}}
            ],
            'æ•°ç äº§å“': [
                {name: 'iPhone 15', brand: 'Apple', price: 5999.0, options: {storage: ['128GB', '256GB', '512GB'], color: ['é»‘è‰²', 'ç™½è‰²', 'è“è‰²', 'ç²‰è‰²']}},
                {name: 'å°ç±³13', brand: 'å°ç±³', price: 3999.0, options: {storage: ['128GB', '256GB'], color: ['é»‘è‰²', 'ç™½è‰²', 'ç»¿è‰²']}},
                {name: 'MacBook Air', brand: 'Apple', price: 8999.0, options: {chip: ['M2', 'M3'], storage: ['256GB', '512GB', '1TB'], color: ['é“¶è‰²', 'æ·±ç©ºç°', 'æ˜Ÿå…‰è‰²']}},
                {name: 'åä¸ºP60', brand: 'åä¸º', price: 4488.0, options: {storage: ['128GB', '256GB', '512GB'], color: ['é»‘è‰²', 'ç™½è‰²', 'ç´«è‰²']}},
                {name: 'iPad Pro', brand: 'Apple', price: 6799.0, options: {size: ['11è‹±å¯¸', '12.9è‹±å¯¸'], storage: ['128GB', '256GB', '512GB', '1TB']}},
                {name: 'AirPods Pro', brand: 'Apple', price: 1899.0, options: {generation: ['ç¬¬äºŒä»£', 'ç¬¬ä¸‰ä»£']}},
                {name: 'æˆ´å°”XPS13', brand: 'Dell', price: 7999.0, options: {processor: ['i5', 'i7'], ram: ['8GB', '16GB', '32GB'], storage: ['256GB', '512GB', '1TB']}},
                {name: 'ç´¢å°¼WH-1000XM5', brand: 'Sony', price: 2399.0, options: {color: ['é»‘è‰²', 'é“¶è‰²']}},
                {name: 'Switchæ¸¸æˆæœº', brand: 'ä»»å¤©å ‚', price: 2099.0, options: {type: ['æ ‡å‡†ç‰ˆ', 'OLEDç‰ˆ'], color: ['çº¢è“', 'ç°è‰²', 'ç™½è‰²']}},
                {name: 'å°ç±³æ‰‹ç¯8', brand: 'å°ç±³', price: 299.0, options: {color: ['é»‘è‰²', 'è“è‰²', 'ç²‰è‰²'], strap: ['è¿åŠ¨è¡¨å¸¦', 'çš®è´¨è¡¨å¸¦']}},
                {name: 'Kindle', brand: 'Amazon', price: 899.0, options: {storage: ['8GB', '32GB'], type: ['æ ‡å‡†ç‰ˆ', 'Paperwhite', 'Oasis']}},
                {name: 'ç½—æŠ€é¼ æ ‡', brand: 'ç½—æŠ€', price: 299.0, options: {type: ['æœ‰çº¿', 'æ— çº¿'], dpi: ['1000DPI', '2000DPI', '4000DPI']}},
                {name: 'æœºæ¢°é”®ç›˜', brand: 'é›·è›‡', price: 899.0, options: {switch: ['é’è½´', 'çº¢è½´', 'èŒ¶è½´'], backlight: ['æ— èƒŒå…‰', 'RGBèƒŒå…‰']}},
                {name: 'ç§»åŠ¨ç¡¬ç›˜', brand: 'è¥¿éƒ¨æ•°æ®', price: 599.0, options: {capacity: ['1TB', '2TB', '4TB'], type: ['USB3.0', 'Type-C']}},
                {name: 'å……ç”µå®', brand: 'å°ç±³', price: 149.0, options: {capacity: ['10000mAh', '20000mAh'], type: ['æ™®é€šç‰ˆ', 'å¿«å……ç‰ˆ']}},
                {name: 'è“ç‰™éŸ³ç®±', brand: 'JBL', price: 699.0, options: {size: ['ä¾¿æºç‰ˆ', 'æ ‡å‡†ç‰ˆ'], color: ['é»‘è‰²', 'è“è‰²', 'çº¢è‰²']}},
                {name: 'æ™ºèƒ½æ‰‹è¡¨', brand: 'Apple Watch', price: 2999.0, options: {size: ['41mm', '45mm'], band: ['è¿åŠ¨è¡¨å¸¦', 'çš®è´¨è¡¨å¸¦', 'ä¸é”ˆé’¢è¡¨å¸¦']}},
                {name: 'æ— çº¿å……ç”µå™¨', brand: 'è´å°”é‡‘', price: 299.0, options: {power: ['5W', '10W', '15W'], type: ['ç«‹å¼', 'å¹³æ”¾å¼']}},
                {name: 'æ‘„åƒå¤´', brand: 'ç½—æŠ€', price: 599.0, options: {resolution: ['1080P', '4K'], type: ['æ™®é€šç‰ˆ', 'å¹¿è§’ç‰ˆ']}},
                {name: 'è·¯ç”±å™¨', brand: 'åç¡•', price: 899.0, options: {speed: ['AC1200', 'AC1900', 'AX3000'], antenna: ['2å¤©çº¿', '4å¤©çº¿', '6å¤©çº¿']}}
            ],
            'å®¶å±…ç™¾è´§': [
                {name: 'ä¹³èƒ¶æ•', brand: 'é‚“ç¦„æ™®', price: 299.0, options: {height: ['ä½æ•', 'ä¸­æ•', 'é«˜æ•'], hardness: ['è½¯', 'ä¸­ç­‰', 'ç¡¬']}},
                {name: 'å››ä»¶å¥—', brand: 'æ°´æ˜Ÿå®¶çºº', price: 399.0, options: {size: ['1.5måºŠ', '1.8måºŠ', '2.0måºŠ'], material: ['çº¯æ£‰', 'å¤©ä¸', 'çœŸä¸']}},
                {name: 'ç”µé¥­ç…²', brand: 'ç¾çš„', price: 599.0, options: {capacity: ['3L', '4L', '5L'], type: ['æ™®é€šç‰ˆ', 'æ™ºèƒ½ç‰ˆ']}},
                {name: 'å¸å°˜å™¨', brand: 'æˆ´æ£®', price: 2999.0, options: {type: ['æ‰‹æŒå¼', 'ç«‹å¼', 'æ‰«åœ°æœºå™¨äºº'], power: ['æ ‡å‡†ç‰ˆ', 'å¼ºåŠ›ç‰ˆ']}},
                {name: 'ç©ºæ°”å‡€åŒ–å™¨', brand: 'å°ç±³', price: 1299.0, options: {coverage: ['30ã¡', '50ã¡', '80ã¡'], filter: ['æ ‡å‡†æ»¤ç½‘', 'HEPAæ»¤ç½‘']}},
                {name: 'å°ç¯', brand: 'é£åˆ©æµ¦', price: 299.0, options: {type: ['æŠ¤çœ¼ç¯', 'LEDç¯'], brightness: ['ä¸‰æ¡£è°ƒå…‰', 'æ— çº§è°ƒå…‰']}},
                {name: 'ä¿æ¸©æ¯', brand: 'è†³é­”å¸ˆ', price: 199.0, options: {capacity: ['350ml', '500ml', '750ml'], color: ['é»‘è‰²', 'ç™½è‰²', 'è“è‰²', 'ç²‰è‰²']}},
                {name: 'æ¯›å·¾', brand: 'æ´ä¸½é›…', price: 39.0, options: {size: ['é¢å·¾', 'æµ´å·¾'], material: ['çº¯æ£‰', 'ç«¹çº¤ç»´'], color: ['ç™½è‰²', 'è“è‰²', 'ç²‰è‰²']}},
                {name: 'åƒåœ¾æ¡¶', brand: 'æ‹“ç‰Œ', price: 89.0, options: {capacity: ['8L', '12L', '20L'], type: ['è„šè¸å¼', 'æ„Ÿåº”å¼']}},
                {name: 'æ”¶çº³ç›’', brand: 'çˆ±ä¸½æ€', price: 59.0, options: {size: ['å°å·', 'ä¸­å·', 'å¤§å·'], material: ['å¡‘æ–™', 'å¸ƒè‰º'], color: ['é€æ˜', 'ç™½è‰²', 'ç°è‰²']}},
                {name: 'æ‹–é‹', brand: 'å—æäºº', price: 29.0, options: {size: ['36-37', '38-39', '40-41', '42-43'], type: ['å±…å®¶æ‹–é‹', 'æµ´å®¤æ‹–é‹']}},
                {name: 'è¡£æ¶', brand: 'å¤ªåŠ›', price: 25.0, options: {material: ['å¡‘æ–™', 'ä¸é”ˆé’¢'], type: ['æ™®é€šè¡£æ¶', 'é˜²æ»‘è¡£æ¶'], count: ['10ä¸ª', '20ä¸ª', '50ä¸ª']}},
                {name: 'æ´—è¡£æ¶²', brand: 'è“æœˆäº®', price: 45.0, options: {volume: ['1kg', '2kg', '3kg'], type: ['æ·±å±‚æ´å‡€', 'æŠ¤è‰²', 'å©´å„¿ä¸“ç”¨']}},
                {name: 'çº¸å·¾', brand: 'ç»´è¾¾', price: 35.0, options: {type: ['æŠ½çº¸', 'å·çº¸'], layers: ['3å±‚', '4å±‚'], count: ['12åŒ…', '24åŒ…']}},
                {name: 'æ´—æ´ç²¾', brand: 'ç«‹ç™½', price: 18.0, options: {volume: ['500ml', '1L', '2L'], type: ['æ™®é€š', 'æŸ æª¬é¦™', 'èŠ¦èŸ']}},
                {name: 'åºŠå«', brand: 'æ…•æ€', price: 2999.0, options: {size: ['1.5m', '1.8m', '2.0m'], type: ['å¼¹ç°§åºŠå«', 'ä¹³èƒ¶åºŠå«', 'è®°å¿†æ£‰åºŠå«']}},
                {name: 'çª—å¸˜', brand: 'æ‘©åŠ›å…‹', price: 299.0, options: {size: ['1.5må®½', '2.0må®½', '2.5må®½'], material: ['æ£‰éº»', 'é›ªå°¼å°”', 'é®å…‰å¸ƒ']}},
                {name: 'åœ°æ¯¯', brand: 'å±±èŠ±', price: 199.0, options: {size: ['60Ã—90cm', '120Ã—160cm', '160Ã—230cm'], material: ['åŒ–çº¤', 'ç¾Šæ¯›']}},
                {name: 'èŠ±æ´’', brand: 'ä¹ç‰§', price: 399.0, options: {type: ['æ‰‹æŒèŠ±æ´’', 'é¡¶å–·èŠ±æ´’'], function: ['æ™®é€š', 'æŒ‰æ‘©', 'èŠ‚æ°´']}},
                {name: 'é©¬æ¡¶åˆ·', brand: 'å¥½äºº', price: 25.0, options: {type: ['æ™®é€šåˆ·', 'ä¸€æ¬¡æ€§åˆ·å¤´'], handle: ['é•¿æŸ„', 'çŸ­æŸ„']}}
            ],
            'å¥³è£…ç”·è£…': [
                {name: 'è¿è¡£è£™', brand: 'ZARA', price: 299.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'ç™½è‰²', 'è“è‰²', 'çº¢è‰²'], style: ['Aå­—è£™', 'ç›´ç­’è£™']}},
                {name: 'ç‰›ä»”è£¤', brand: 'Levi\'s', price: 599.0, options: {size: ['28', '29', '30', '31', '32', '33', '34'], color: ['æ·±è“', 'æµ…è“', 'é»‘è‰²'], fit: ['ä¿®èº«', 'ç›´ç­’', 'å®½æ¾']}},
                {name: 'Tæ¤', brand: 'Uniqlo', price: 99.0, options: {size: ['S', 'M', 'L', 'XL', 'XXL'], color: ['ç™½è‰²', 'é»‘è‰²', 'ç°è‰²', 'è“è‰²', 'çº¢è‰²'], sleeve: ['çŸ­è¢–', 'é•¿è¢–']}},
                {name: 'è¥¿è£…', brand: 'Hugo Boss', price: 2999.0, options: {size: ['46', '48', '50', '52', '54'], color: ['é»‘è‰²', 'æ·±è“', 'ç°è‰²'], style: ['ä¿®èº«', 'ç»å…¸']}},
                {name: 'ç¾½ç»’æœ', brand: 'Canada Goose', price: 4999.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'å†›ç»¿', 'æµ·å†›è“'], length: ['çŸ­æ¬¾', 'ä¸­é•¿æ¬¾', 'é•¿æ¬¾']}},
                {name: 'æ¯›è¡£', brand: 'H&M', price: 199.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['ç±³è‰²', 'ç°è‰²', 'é»‘è‰²', 'çº¢è‰²'], material: ['ç¾Šæ¯›', 'æ£‰è´¨', 'æ··çºº']}},
                {name: 'è¡¬è¡«', brand: 'CK', price: 399.0, options: {size: ['S', 'M', 'L', 'XL', 'XXL'], color: ['ç™½è‰²', 'è“è‰²', 'ç²‰è‰²'], collar: ['å°–é¢†', 'åœ†é¢†'], sleeve: ['é•¿è¢–', 'çŸ­è¢–']}},
                {name: 'çŸ­è£¤', brand: 'Nike', price: 299.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'ç°è‰²', 'è“è‰²'], length: ['5åˆ†', '7åˆ†'], type: ['è¿åŠ¨', 'ä¼‘é—²']}},
                {name: 'è£™å­', brand: 'Only', price: 259.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'ç™½è‰²', 'èŠ±è‰²'], length: ['çŸ­è£™', 'ä¸­è£™', 'é•¿è£™']}},
                {name: 'å¤–å¥—', brand: 'Adidas', price: 699.0, options: {size: ['S', 'M', 'L', 'XL', 'XXL'], color: ['é»‘è‰²', 'ç™½è‰²', 'è“è‰²'], type: ['å¤¹å…‹', 'å«è¡£', 'é£è¡£']}},
                {name: 'å†…è¡£', brand: 'é»›å®‰èŠ¬', price: 199.0, options: {size: ['70A', '70B', '75A', '75B', '80A', '80B'], color: ['é»‘è‰²', 'ç™½è‰²', 'è‚‰è‰²'], type: ['æ— é’¢åœˆ', 'æœ‰é’¢åœˆ']}},
                {name: 'å†…è£¤', brand: 'CK', price: 89.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'ç™½è‰²', 'ç°è‰²'], type: ['ä¸‰è§’', 'å¹³è§’'], count: ['1æ¡', '3æ¡è£…']}},
                {name: 'è¢œå­', brand: 'æµªè', price: 25.0, options: {size: ['å‡ç '], color: ['é»‘è‰²', 'ç™½è‰²', 'ç°è‰²', 'è‚‰è‰²'], type: ['çŸ­è¢œ', 'ä¸­ç­’è¢œ', 'é•¿ç­’è¢œ'], count: ['1åŒ', '5åŒè£…']}},
                {name: 'ç¡è¡£', brand: 'å®‰ä¹‹ä¼´', price: 159.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['ç²‰è‰²', 'è“è‰²', 'ç™½è‰²'], material: ['çº¯æ£‰', 'ä¸ç»¸', 'è«ä»£å°”'], style: ['å¥—è£…', 'è¿ä½“']}},
                {name: 'è¿åŠ¨æœ', brand: 'Under Armour', price: 599.0, options: {size: ['S', 'M', 'L', 'XL', 'XXL'], color: ['é»‘è‰²', 'ç°è‰²', 'è“è‰²'], type: ['å¥—è£…', 'å•ä»¶'], function: ['é€Ÿå¹²', 'ä¿æš–']}},
                {name: 'æ³³è¡£', brand: 'Speedo', price: 299.0, options: {size: ['S', 'M', 'L', 'XL'], color: ['é»‘è‰²', 'è“è‰²', 'çº¢è‰²'], type: ['è¿ä½“', 'åˆ†ä½“'], style: ['è¿åŠ¨', 'ä¼‘é—²']}},
                {name: 'å›´å·¾', brand: 'Burberry', price: 1299.0, options: {material: ['ç¾Šæ¯›', 'ç¾Šç»’', 'ä¸ç»¸'], color: ['ç»å…¸æ ¼çº¹', 'çº¯è‰²'], size: ['æ ‡å‡†', 'åŠ é•¿']}},
                {name: 'å¸½å­', brand: 'New Era', price: 199.0, options: {type: ['æ£’çƒå¸½', 'é’ˆç»‡å¸½', 'æ¸”å¤«å¸½'], color: ['é»‘è‰²', 'ç™½è‰²', 'è“è‰²', 'çº¢è‰²'], size: ['å‡ç ', 'å¯è°ƒèŠ‚']}},
                {name: 'æ‰‹å¥—', brand: 'The North Face', price: 199.0, options: {size: ['S', 'M', 'L'], color: ['é»‘è‰²', 'ç°è‰²', 'è“è‰²'], type: ['ä¿æš–æ‰‹å¥—', 'è§¦å±æ‰‹å¥—'], material: ['ç¾Šæ¯›', 'æŠ“ç»’']}},
                {name: 'è…°å¸¦', brand: 'Gucci', price: 2999.0, options: {size: ['90cm', '95cm', '100cm', '105cm', '110cm'], color: ['é»‘è‰²', 'æ£•è‰²'], material: ['çœŸçš®', 'å¸†å¸ƒ'], buckle: ['é‡‘æ‰£', 'é“¶æ‰£']}}
            ],
            'é¥°å“ç®±åŒ…': [
                {name: 'æ‰‹æåŒ…', brand: 'LV', price: 15999.0, options: {size: ['å°å·', 'ä¸­å·', 'å¤§å·'], color: ['ç»å…¸æ£•', 'é»‘è‰²', 'ç™½è‰²'], material: ['å¸†å¸ƒ', 'çœŸçš®']}},
                {name: 'åŒè‚©åŒ…', brand: 'Herschel', price: 699.0, options: {size: ['15L', '20L', '25L'], color: ['é»‘è‰²', 'ç°è‰²', 'è“è‰²', 'çº¢è‰²'], material: ['å¸†å¸ƒ', 'å°¼é¾™']}},
                {name: 'é’±åŒ…', brand: 'Coach', price: 1299.0, options: {type: ['é•¿æ¬¾', 'çŸ­æ¬¾'], color: ['é»‘è‰²', 'æ£•è‰²', 'çº¢è‰²'], material: ['çœŸçš®', 'å¸†å¸ƒ']}},
                {name: 'æ‰‹è¡¨', brand: 'Rolex', price: 89999.0, options: {type: ['æœºæ¢°è¡¨', 'çŸ³è‹±è¡¨'], material: ['ä¸é”ˆé’¢', 'é»„é‡‘', 'ç«ç‘°é‡‘'], size: ['36mm', '40mm']}},
                {name: 'é¡¹é“¾', brand: 'Tiffany', price: 3999.0, options: {material: ['é“¶', 'é‡‘', 'é“‚é‡‘'], length: ['40cm', '45cm', '50cm'], style: ['ç®€çº¦', 'é•¶é’»']}},
                {name: 'è€³ç¯', brand: 'Pandora', price: 599.0, options: {type: ['è€³é’‰', 'è€³ç¯', 'è€³å¤¹'], material: ['é“¶', 'é‡‘'], style: ['ç®€çº¦', 'é•¶é’»', 'çç ']}},
                {name: 'æˆ’æŒ‡', brand: 'Cartier', price: 8999.0, options: {size: ['6å·', '7å·', '8å·', '9å·', '10å·'], material: ['é“¶', 'é‡‘', 'é“‚é‡‘'], style: ['ç®€çº¦', 'é•¶é’»']}},
                {name: 'æ‰‹é•¯', brand: 'å‘¨å¤§ç¦', price: 2999.0, options: {material: ['é“¶', 'é‡‘', 'ç‰'], style: ['ç®€çº¦', 'é›•èŠ±', 'é•¶é’»'], size: ['æ ‡å‡†', 'åŠ å¤§']}},
                {name: 'å¤ªé˜³é•œ', brand: 'Ray-Ban', price: 1299.0, options: {style: ['é£è¡Œå‘˜', 'æ–¹æ¡†', 'åœ†æ¡†'], color: ['é»‘è‰²', 'æ£•è‰²', 'è“è‰²'], lens: ['åå…‰', 'æ™®é€š']}},
                {name: 'ä¸å·¾', brand: 'HermÃ¨s', price: 2999.0, options: {size: ['90cmÃ—90cm', '140cmÃ—140cm'], color: ['ç»å…¸æ©™', 'è“è‰²', 'ç²‰è‰²'], material: ['çœŸä¸', 'ç¾Šç»’']}},
                {name: 'å‘å¤¹', brand: 'æ–½åæ´›ä¸–å¥‡', price: 299.0, options: {type: ['å‘å¡', 'å‘ç®', 'å‘ç»³'], color: ['é‡‘è‰²', 'é“¶è‰²', 'ç«ç‘°é‡‘'], style: ['ç®€çº¦', 'é•¶é’»']}},
                {name: 'èƒ¸é’ˆ', brand: 'Chanel', price: 4999.0, options: {material: ['é‡‘å±', 'çç '], style: ['ç»å…¸CC', 'èŠ±æœµ', 'åŠ¨ç‰©'], color: ['é‡‘è‰²', 'é“¶è‰²']}},
                {name: 'è¡Œæç®±', brand: 'Samsonite', price: 1999.0, options: {size: ['20å¯¸', '24å¯¸', '28å¯¸'], color: ['é»‘è‰²', 'é“¶è‰²', 'è“è‰²'], type: ['ç¡¬å£³', 'è½¯å£³'], wheels: ['ä¸‡å‘è½®', 'å®šå‘è½®']}},
                {name: 'åŒ–å¦†åŒ…', brand: 'Marc Jacobs', price: 899.0, options: {size: ['å°å·', 'ä¸­å·', 'å¤§å·'], color: ['é»‘è‰²', 'ç²‰è‰²', 'ç™½è‰²'], material: ['çš®è´¨', 'å¸†å¸ƒ']}},
                {name: 'é’¥åŒ™æ‰£', brand: 'Prada', price: 599.0, options: {material: ['é‡‘å±', 'çš®è´¨'], color: ['é»‘è‰²', 'é“¶è‰²', 'é‡‘è‰²'], style: ['ç®€çº¦', 'å“ç‰Œlogo']}},
                {name: 'æ‰‹æœºå£³', brand: 'Apple', price: 399.0, options: {model: ['iPhone 14', 'iPhone 15'], color: ['é€æ˜', 'é»‘è‰²', 'ç™½è‰²', 'è“è‰²'], material: ['ç¡…èƒ¶', 'çš®è´¨', 'é€æ˜']}},
                {name: 'ç å®ç›’', brand: 'å‘¨ç”Ÿç”Ÿ', price: 299.0, options: {size: ['å°å·', 'ä¸­å·', 'å¤§å·'], color: ['çº¢è‰²', 'é»‘è‰²', 'ç™½è‰²'], material: ['ç»’å¸ƒ', 'çš®è´¨']}},
                {name: 'é¦™æ°´', brand: 'Chanel No.5', price: 899.0, options: {volume: ['30ml', '50ml', '100ml'], type: ['æ·¡é¦™æ°´', 'é¦™æ°´'], packaging: ['æ™®é€šè£…', 'ç¤¼ç›’è£…']}},
                {name: 'å£çº¢', brand: 'YSL', price: 299.0, options: {color: ['æ­£çº¢', 'ç«çº¢', 'æ©˜çº¢', 'è±†æ²™è‰²'], finish: ['å“‘å…‰', 'ä¸ç»’', 'æ°´æ¶¦'], series: ['æ–¹ç®¡', 'åœ†ç®¡']}},
                {name: 'æŒ‡ç”²æ²¹', brand: 'OPI', price: 89.0, options: {color: ['çº¢è‰²', 'ç²‰è‰²', 'è“è‰²', 'é»‘è‰²', 'é€æ˜'], finish: ['æ™®é€š', 'ç å…‰', 'å“‘å…‰'], volume: ['15ml', '30ml']}}
            ]
        };

        // ğŸ›’ã€æ–°å¢ã€‘æ˜¾ç¤ºåˆ†ç±»å•†å“
        function showCategoryProducts(categoryName) {
            const categoriesDiv = document.getElementById('shopping-categories');
            const productsDiv = document.getElementById('products-container');
            const searchContainer = document.querySelector('.shopping-search-container');
            const appTitle = document.querySelector('#shopping-screen .app-title');
            const gridElement = document.getElementById('products-grid');
            const shoppingContent = document.querySelector('.shopping-content');

            // éšè—åˆ†ç±»å’Œæœç´¢æ¡†ï¼Œæ˜¾ç¤ºå•†å“
            categoriesDiv.style.display = 'none';
            searchContainer.style.display = 'none';
            productsDiv.style.display = 'block';

            // ğŸ›’ã€ä¿®å¤ã€‘æ·»åŠ showing-productsç±»æ¥ç§»é™¤é¡¶éƒ¨padding
            shoppingContent.classList.add('showing-products');

            // æ›´æ–°é¡¶éƒ¨åº”ç”¨æ æ ‡é¢˜
            appTitle.textContent = categoryName;

            // æ¸…ç©ºå•†å“ç½‘æ ¼
            gridElement.innerHTML = '';

            // è·å–è¯¥åˆ†ç±»çš„å•†å“
            const products = productsData[categoryName] || [];

            // ç”Ÿæˆå•†å“HTML
            products.forEach((product, index) => {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»·æ ¼å˜åŒ–é€‰é¡¹
                const hasVariablePrice = product.prices && Object.keys(product.prices).length > 0;
                const priceDisplay = hasVariablePrice ? `Â¥${product.price}èµ·` : `Â¥${product.price}`;

                const productHTML = `
                    <div class="product-item">
                        <div class="product-name">${product.name}</div>
                        <div class="product-brand">${product.brand}</div>
                        <div class="product-price">${priceDisplay}</div>
                        <button class="add-to-cart-btn" onclick="addToCart('${categoryName}', ${index})">
                            åŠ å…¥è´­ç‰©è½¦
                        </button>
                    </div>
                `;
                gridElement.innerHTML += productHTML;
            });
        }

        // ğŸ›’ã€æ–°å¢ã€‘è¿”å›åˆ†ç±»é¡µé¢
        function backToCategories() {
            const categoriesDiv = document.getElementById('shopping-categories');
            const productsDiv = document.getElementById('products-container');
            const searchContainer = document.querySelector('.shopping-search-container');
            const appTitle = document.querySelector('#shopping-screen .app-title');
            const shoppingContent = document.querySelector('.shopping-content');

            // æ˜¾ç¤ºåˆ†ç±»å’Œæœç´¢æ¡†ï¼Œéšè—å•†å“
            categoriesDiv.style.display = 'block';
            searchContainer.style.display = 'flex';
            productsDiv.style.display = 'none';

            // ğŸ›’ã€ä¿®å¤ã€‘ç§»é™¤showing-productsç±»æ¥æ¢å¤é¡¶éƒ¨padding
            shoppingContent.classList.remove('showing-products');

            // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®å½“å‰æ´»è·ƒçš„æ ‡ç­¾é¡µè®¾ç½®æ ‡é¢˜
            const activeTab = document.querySelector('.shopping-tab.active');
            if (activeTab && activeTab.textContent.trim() === 'å¤–å–') {
                appTitle.textContent = 'å¤–å–';
            } else {
                appTitle.textContent = 'è´­ç‰©';
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†è´­ç‰©ç•Œé¢è¿”å›æŒ‰é’®
        function handleShoppingBack() {
            const productsDiv = document.getElementById('products-container');

            // å¦‚æœå½“å‰åœ¨å•†å“é¡µé¢ï¼Œè¿”å›åˆ†ç±»é¡µé¢
            if (productsDiv.style.display === 'block') {
                backToCategories();
            } else {
                // å¦‚æœåœ¨åˆ†ç±»é¡µé¢ï¼Œè¿”å›åˆ°è¿›å…¥è´­ç‰©å‰çš„ç•Œé¢
                hideApp('shopping-screen');
                showApp(previousScreenBeforeShopping);
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©è½¦æ•°æ®
        let shoppingCart = [];

        // ğŸ›’ã€æ–°å¢ã€‘æ·»åŠ åˆ°è´­ç‰©è½¦
        function addToCart(categoryName, productIndex) {
            const product = productsData[categoryName][productIndex];
            if (!product) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰é¡¹éœ€è¦é€‰æ‹©
            if (product.options && Object.keys(product.options).length > 0) {
                showProductOptions(categoryName, productIndex);
            } else {
                // ç›´æ¥æ·»åŠ åˆ°è´­ç‰©è½¦
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å•†å“
                const existingItemIndex = shoppingCart.findIndex(item =>
                    item.name === product.name &&
                    item.brand === product.brand &&
                    Object.keys(item.selectedOptions || {}).length === 0
                );

                if (existingItemIndex !== -1) {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œå¢åŠ æ•°é‡
                    shoppingCart[existingItemIndex].quantity += 1;
                } else {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°å•†å“
                    const finalPrice = getProductPrice(product, {});
                    const cartItem = {
                        name: product.name,
                        brand: product.brand,
                        price: finalPrice,
                        category: categoryName,
                        selectedOptions: {},
                        quantity: 1
                    };
                    shoppingCart.push(cartItem);
                }

                updateCartBadge(getTotalCartItems());
                showCustomToast(`${product.name} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ˜¾ç¤ºå•†å“é€‰é¡¹
        function showProductOptions(categoryName, productIndex) {
            const product = productsData[categoryName][productIndex];
            let optionsHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;" onclick="closeProductOptions(event)">
                    <div style="background: white; border-radius: 15px; padding: 20px; max-width: 350px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 15px 0; color: #333;">${product.name}</h3>
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${product.brand}</p>
                        <p style="margin: 0 0 15px 0; color: #ff6600; font-size: 18px; font-weight: 600;" id="current-price">Â¥${product.price}</p>
                        <div id="product-options-form">
            `;

            // ç”Ÿæˆé€‰é¡¹è¡¨å•
            for (const [optionKey, optionValues] of Object.entries(product.options)) {
                const optionLabel = getOptionLabel(optionKey);
                optionsHTML += `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">${optionLabel}:</label>
                        <select id="option-${optionKey}" onchange="updateProductPrice('${categoryName}', ${productIndex})" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                `;
                optionValues.forEach(value => {
                    optionsHTML += `<option value="${value}">${value}</option>`;
                });
                optionsHTML += `</select></div>`;
            }

            optionsHTML += `
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="closeProductOptions()" style="flex: 1; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; color: #666; font-weight: 600;">å–æ¶ˆ</button>
                            <button onclick="confirmAddToCart('${categoryName}', ${productIndex})" style="flex: 1; padding: 12px; background: #5a92c5; border: none; border-radius: 8px; color: white; font-weight: 600;">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', optionsHTML);
        }

        // ğŸ›’ã€æ–°å¢ã€‘è·å–é€‰é¡¹æ ‡ç­¾
        function getOptionLabel(optionKey) {
            const labels = {
                'size': 'å°ºå¯¸',
                'color': 'é¢œè‰²',
                'sugar': 'ç³–åº¦',
                'ice': 'å†°åº¦',
                'spicy': 'è¾£åº¦',
                'flavor': 'å£å‘³',
                'count': 'æ•°é‡',
                'weight': 'é‡é‡',
                'type': 'ç±»å‹',
                'storage': 'å­˜å‚¨',
                'material': 'æè´¨',
                'style': 'æ¬¾å¼',
                'volume': 'å®¹é‡',
                'package': 'åŒ…è£…',
                'capacity': 'å®¹é‡',
                'strength': 'å¼ºåº¦',
                'noodle': 'é¢æ¡',
                'soup': 'æ±¤åº•',
                'ingredients': 'é…æ–™',
                'ripeness': 'æˆç†Ÿåº¦',
                'toppings': 'é…èœ',
                'finish': 'è´¨åœ°',
                'series': 'ç³»åˆ—',
                'model': 'å‹å·',
                'chip': 'èŠ¯ç‰‡',
                'processor': 'å¤„ç†å™¨',
                'ram': 'å†…å­˜',
                'generation': 'ä»£æ•°',
                'switch': 'è½´ä½“',
                'backlight': 'èƒŒå…‰',
                'dpi': 'DPI',
                'power': 'åŠŸç‡',
                'resolution': 'åˆ†è¾¨ç‡',
                'antenna': 'å¤©çº¿',
                'speed': 'é€Ÿåº¦',
                'hardness': 'è½¯ç¡¬åº¦',
                'layers': 'å±‚æ•°',
                'function': 'åŠŸèƒ½',
                'coverage': 'è¦†ç›–é¢ç§¯',
                'filter': 'æ»¤ç½‘',
                'brightness': 'äº®åº¦',
                'fit': 'ç‰ˆå‹',
                'sleeve': 'è¢–é•¿',
                'collar': 'é¢†å‹',
                'length': 'é•¿åº¦',
                'buckle': 'æ‰£å­',
                'lens': 'é•œç‰‡',
                'wheels': 'è½®å­',
                'packaging': 'åŒ…è£…',
                'handle': 'æ‰‹æŸ„'
            };
            return labels[optionKey] || optionKey;
        }

        // ğŸ›’ã€æ–°å¢ã€‘ç¡®è®¤æ·»åŠ åˆ°è´­ç‰©è½¦
        function confirmAddToCart(categoryName, productIndex) {
            const product = productsData[categoryName][productIndex];
            const selectedOptions = {};

            // æ”¶é›†é€‰æ‹©çš„é€‰é¡¹
            for (const optionKey of Object.keys(product.options)) {
                const selectElement = document.getElementById(`option-${optionKey}`);
                if (selectElement) {
                    selectedOptions[optionKey] = selectElement.value;
                }
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å•†å“ï¼ˆåŒ…æ‹¬é€‰é¡¹ï¼‰
            const existingItemIndex = shoppingCart.findIndex(item =>
                item.name === product.name &&
                item.brand === product.brand &&
                JSON.stringify(item.selectedOptions) === JSON.stringify(selectedOptions)
            );

            if (existingItemIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œå¢åŠ æ•°é‡
                shoppingCart[existingItemIndex].quantity += 1;
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°å•†å“
                const finalPrice = getProductPrice(product, selectedOptions);
                const cartItem = {
                    name: product.name,
                    brand: product.brand,
                    price: finalPrice,
                    category: categoryName,
                    selectedOptions: selectedOptions,
                    quantity: 1
                };
                shoppingCart.push(cartItem);
            }

            updateCartBadge(getTotalCartItems());
            closeProductOptions();

            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸä¿¡æ¯
            const optionsText = Object.entries(selectedOptions).map(([key, value]) => `${getOptionLabel(key)}: ${value}`).join(', ');
            const optionsDisplay = optionsText ? ` (${optionsText})` : '';
            showCustomToast(`${product.name}${optionsDisplay} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');
        }

        // ğŸ›’ã€æ–°å¢ã€‘å…³é—­å•†å“é€‰é¡¹
        function closeProductOptions(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.querySelector('[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ·»åŠ è‡ªå®šä¹‰å•†å“åŠŸèƒ½
        function addCustomItem() {
            showCustomItemModal();
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ˜¾ç¤ºè‡ªå®šä¹‰å•†å“æ¨¡æ€æ¡†
        function showCustomItemModal() {
            const modal = document.getElementById('custom-item-modal');
            const nameInput = document.getElementById('custom-item-name');
            const descriptionInput = document.getElementById('custom-item-description');
            const priceInput = document.getElementById('custom-item-price');

            // æ¸…ç©ºè¾“å…¥æ¡†
            nameInput.value = '';
            descriptionInput.value = '';
            priceInput.value = '';

            modal.style.display = 'flex';

            // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                nameInput.focus();
            }, 100);
        }

        // ğŸ›’ã€æ–°å¢ã€‘éšè—è‡ªå®šä¹‰å•†å“æ¨¡æ€æ¡†
        function hideCustomItemModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const modal = document.getElementById('custom-item-modal');
            modal.style.display = 'none';
        }

        // ğŸ›’ã€æ–°å¢ã€‘ç¡®è®¤æ·»åŠ è‡ªå®šä¹‰å•†å“
        function confirmAddCustomItem() {
            const nameInput = document.getElementById('custom-item-name');
            const descriptionInput = document.getElementById('custom-item-description');
            const priceInput = document.getElementById('custom-item-price');

            const itemName = nameInput.value.trim();
            const itemDescription = descriptionInput.value.trim();
            const itemPrice = priceInput.value.trim();

            // éªŒè¯è¾“å…¥
            if (!itemName) {
                showCustomToast('è¯·è¾“å…¥å•†å“åç§°', 'error');
                nameInput.focus();
                return;
            }

            if (!itemPrice || isNaN(itemPrice) || parseFloat(itemPrice) <= 0) {
                showCustomToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼', 'error');
                priceInput.focus();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è‡ªå®šä¹‰å•†å“ï¼ˆä»…æ ¹æ®åç§°åˆ¤æ–­ï¼‰
            const existingItemIndex = shoppingCart.findIndex(item =>
                item.name === itemName &&
                item.brand === 'è‡ªå®šä¹‰'
            );

            if (existingItemIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œå¢åŠ æ•°é‡
                shoppingCart[existingItemIndex].quantity += 1;
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°å•†å“
                const cartItem = {
                    name: itemName,
                    brand: 'è‡ªå®šä¹‰',
                    description: itemDescription || '', // å•†å“ä»‹ç»ï¼Œå¯é€‰
                    unit: '', // ä¸æ˜¾ç¤ºå•ä½
                    price: parseFloat(itemPrice),
                    category: 'è‡ªå®šä¹‰',
                    selectedOptions: {},
                    quantity: 1
                };
                shoppingCart.push(cartItem);
            }

            updateCartBadge(getTotalCartItems());
            showCustomToast(`${itemName} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');

            // éšè—æ¨¡æ€æ¡†
            hideCustomItemModal();
        }

        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†è‡ªå®šä¹‰å•†å“è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
        function handleCustomItemKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                confirmAddCustomItem();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                hideCustomItemModal();
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘è®°å½•è´­ç‰©è½¦å‰çš„ç•Œé¢
        let previousScreenBeforeCart = 'shopping-screen'; // é»˜è®¤è¿”å›è´­ç‰©ç•Œé¢

        // ğŸ›’ã€æ–°å¢ã€‘è®°å½•è´­ç‰©ç•Œé¢å‰çš„ç•Œé¢
        let previousScreenBeforeShopping = 'chat-screen'; // é»˜è®¤è¿”å›èŠå¤©ç•Œé¢

        // ğŸ›’ã€æ–°å¢ã€‘è®°å½•ç”¨æˆ·é€‰æ‹©çš„ä»˜æ¬¾æ–¹å¼
        let selectedPaymentMethod = 'self_pay'; // 'self_pay' æˆ– 'request_pay'

        // ğŸ›’ã€æ–°å¢ã€‘æ‰“å¼€è´­ç‰©ç•Œé¢
        function openShoppingScreen() {
            // è®°å½•å½“å‰æ˜¾ç¤ºçš„ç•Œé¢
            const currentScreen = document.querySelector('.app-screen:not([style*="display: none"])');
            if (currentScreen) {
                previousScreenBeforeShopping = currentScreen.id;
            }

            showApp('shopping-screen');

            // ğŸ”¥ã€æ–°å¢ã€‘é»˜è®¤åˆ‡æ¢åˆ°å¤–å–æ ‡ç­¾é¡µ
            switchShoppingTab('takeout');
        }

        // ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©è½¦åŠŸèƒ½
        function openShoppingCart() {
            // è®°å½•å½“å‰æ˜¾ç¤ºçš„ç•Œé¢
            const currentScreen = document.querySelector('.app-screen:not([style*="display: none"])');
            if (currentScreen) {
                previousScreenBeforeCart = currentScreen.id;
            }

            showApp('shopping-cart-screen');
            renderShoppingCart();
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ¸²æŸ“è´­ç‰©è½¦å†…å®¹
        function renderShoppingCart() {
            const cartContainer = document.getElementById('cart-items-container');
            const emptyState = document.getElementById('cart-empty-state');
            const cartFooter = document.getElementById('cart-footer');
            const totalPrice = document.getElementById('cart-total-price');
            const itemsCount = document.getElementById('cart-items-count');

            if (shoppingCart.length === 0) {
                cartContainer.style.display = 'none';
                emptyState.style.display = 'flex';
                cartFooter.style.display = 'none';
                return;
            }

            cartContainer.style.display = 'block';
            emptyState.style.display = 'none';
            cartFooter.style.display = 'block';

            // æ¸…ç©ºå®¹å™¨
            cartContainer.innerHTML = '';

            let total = 0;
            let totalItems = 0;

            // æ¸²æŸ“æ¯ä¸ªè´­ç‰©è½¦é¡¹ç›®
            shoppingCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                totalItems += item.quantity;

                const optionsText = Object.entries(item.selectedOptions || {})
                    .map(([key, value]) => `${getOptionLabel(key)}: ${value}`)
                    .join(', ');

                // æ„å»ºå“ç‰Œæ˜¾ç¤ºæ–‡æœ¬
                let brandText = item.brand;
                // å¯¹äºè‡ªå®šä¹‰å•†å“ï¼Œä¸æ˜¾ç¤ºå•ä½
                if (item.brand !== 'è‡ªå®šä¹‰' && item.unit) {
                    brandText += ` Â· ${item.unit}`;
                }

                const cartItemHTML = `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-brand">${brandText}</div>
                                ${item.description ? `<div class="cart-item-description">${item.description}</div>` : ''}
                                ${optionsText ? `<div class="cart-item-options">${optionsText}</div>` : ''}
                            </div>
                            <button class="cart-item-remove" onclick="removeFromCart(${index})" title="ç§»é™¤å•†å“">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="cart-item-footer">
                            <div class="cart-item-price">Â¥${itemTotal.toFixed(2)}</div>
                            <div class="cart-item-quantity">
                                <button class="quantity-btn" onclick="updateCartItemQuantity(${index}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity-number">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateCartItemQuantity(${index}, ${item.quantity + 1})">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cartContainer.innerHTML += cartItemHTML;
            });

            // æ›´æ–°æ€»ä»·å’Œæ•°é‡
            totalPrice.textContent = `Â¥${total.toFixed(2)}`;
            itemsCount.textContent = totalItems;
        }

        // ğŸ›’ã€æ–°å¢ã€‘ä»è´­ç‰©è½¦ç§»é™¤å•†å“
        function removeFromCart(index) {
            const item = shoppingCart[index];
            const itemName = item ? item.name : 'å•†å“';

            showCustomConfirm(
                'ç§»é™¤å•†å“',
                `ç¡®å®šè¦ç§»é™¤ "${itemName}" å—ï¼Ÿ`,
                () => {
                    // ç¡®è®¤ç§»é™¤
                    shoppingCart.splice(index, 1);
                    renderShoppingCart();
                    updateCartBadge(getTotalCartItems());
                    showCustomToast('å•†å“å·²ç§»é™¤', 'success');
                }
            );
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡
        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }

            shoppingCart[index].quantity = newQuantity;
            renderShoppingCart();
            updateCartBadge(getTotalCartItems());
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ¸…ç©ºè´­ç‰©è½¦
        function clearShoppingCart() {
            if (shoppingCart.length === 0) return;

            const itemCount = getTotalCartItems();
            showCustomConfirm(
                'æ¸…ç©ºè´­ç‰©è½¦',
                `ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦ä¸­çš„ ${itemCount} ä»¶å•†å“å—ï¼Ÿ`,
                () => {
                    // ç¡®è®¤æ¸…ç©º
                    shoppingCart = [];
                    renderShoppingCart();
                    updateCartBadge(0);
                    showCustomToast('è´­ç‰©è½¦å·²æ¸…ç©º', 'success');
                }
            );
        }

        // ğŸ›’ã€æ–°å¢ã€‘è·å–è´­ç‰©è½¦æ€»å•†å“æ•°é‡
        function getTotalCartItems() {
            return shoppingCart.reduce((total, item) => total + item.quantity, 0);
        }

        // ğŸ›’ã€ä¿®æ”¹ã€‘è¯·Taä»£ä»˜åŠŸèƒ½
        function requestPayment() {
            showRecipientModal('request_pay');
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ˜¾ç¤ºæ”¶è´§äººé€‰æ‹©æ¨¡æ€æ¡†
        function showRecipientModal(paymentMethod) {
            if (shoppingCart.length === 0) {
                showCustomToast('è´­ç‰©è½¦æ˜¯ç©ºçš„', 'error');
                return;
            }

            if (!currentChatCharacter) {
                showCustomToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡', 'error');
                return;
            }

            // è®°å½•ç”¨æˆ·é€‰æ‹©çš„ä»˜æ¬¾æ–¹å¼
            selectedPaymentMethod = paymentMethod;

            const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemsCount = getTotalCartItems();

            // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„é‡‘é¢å’Œå•†å“æ•°é‡
            document.getElementById('payment-modal-total').textContent = `Â¥${total.toFixed(2)}`;
            document.getElementById('payment-modal-items-count').textContent = itemsCount;

            // æ˜¾ç¤ºæ”¶è´§äººé€‰æ‹©æ¨¡æ€æ¡†
            document.getElementById('payment-request-modal').style.display = 'flex';
        }

        // ğŸ›’ã€ä¿®æ”¹ã€‘ç»“ç®—åŠŸèƒ½
        function proceedToCheckout() {
            showRecipientModal('self_pay');
        }

        // ğŸ›’ã€æ–°å¢ã€‘è´­ç‰©è½¦è¿”å›å¤„ç†
        function handleShoppingCartBack() {
            // éšè—è´­ç‰©è½¦ç•Œé¢
            hideApp('shopping-cart-screen');
            // è¿”å›åˆ°è¿›å…¥è´­ç‰©è½¦å‰çš„ç•Œé¢
            showApp(previousScreenBeforeCart);
        }

        // ğŸ›’ã€æ–°å¢ã€‘éšè—ä»£ä»˜é€‰æ‹©æ¨¡æ€æ¡†
        function hidePaymentRequestModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('payment-request-modal').style.display = 'none';
        }

        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†è®¢å•ï¼ˆæ ¹æ®æ”¶è´§äººå’Œä»˜æ¬¾æ–¹å¼ï¼‰
        function processOrder(recipient) {
            const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemsCount = getTotalCartItems();

            // ç”Ÿæˆè®¢å•è¯¦æƒ…
            const orderDetails = generateOrderDetails();

            // éšè—æ¨¡æ€æ¡†
            hidePaymentRequestModal();

            // æ ¹æ®æ”¶è´§äººå’Œä»˜æ¬¾æ–¹å¼å¤„ç†è®¢å•
            if (recipient === 'for_self') {
                // ä¸ºè‡ªå·±ä¸‹å•
                if (selectedPaymentMethod === 'self_pay') {
                    // è‡ªå·±ä»˜æ¬¾
                    showCustomToast('æ­£åœ¨å¤„ç†æ”¯ä»˜...', 'info', 1000);
                    setTimeout(() => {
                        sendOrderMessage(orderDetails, 'self_pay_self');
                        clearShoppingCart();
                        showCustomToast(`æ”¯ä»˜æˆåŠŸï¼æ€»è®¡ Â¥${total.toFixed(2)}`, 'success');
                        setTimeout(() => handleShoppingCartBack(), 1000);
                    }, 1500);
                } else {
                    // è¯·Taä»£ä»˜
                    sendPaymentRequestMessage(orderDetails, 'request_pay_self');
                    showCustomToast(`å·²å‘é€ä»£ä»˜è¯·æ±‚ç»™ ${currentChatCharacter.name}`, 'success');
                    clearShoppingCart();
                    setTimeout(() => handleShoppingCartBack(), 1000);
                }
            } else {
                // ä¸ºTaä¸‹å•
                if (selectedPaymentMethod === 'self_pay') {
                    // è‡ªå·±ä»˜æ¬¾
                    showCustomToast(`æ­£åœ¨ä¸º ${currentChatCharacter.name} ä¸‹å•...`, 'info');
                    setTimeout(() => {
                        sendOrderMessage(orderDetails, 'self_pay_ta');
                        clearShoppingCart();
                        showCustomToast(`å·²æˆåŠŸä¸º ${currentChatCharacter.name} ä¸‹å•ï¼`, 'success');
                        setTimeout(() => handleShoppingCartBack(), 1000);
                    }, 1500);
                } else {
                    // è¯·Taä»£ä»˜
                    sendPaymentRequestMessage(orderDetails, 'request_pay_ta');
                    showCustomToast(`å·²å‘é€ä»£ä»˜è¯·æ±‚ç»™ ${currentChatCharacter.name}`, 'success');
                    clearShoppingCart();
                    setTimeout(() => handleShoppingCartBack(), 1000);
                }
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘ç”Ÿæˆè®¢å•è¯¦æƒ…
        function generateOrderDetails() {
            const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemsCount = getTotalCartItems();
            const orderNumber = 'SP' + Date.now().toString().slice(-8);

            return {
                orderNumber: orderNumber,
                items: [...shoppingCart],
                total: total,
                itemsCount: itemsCount,
                timestamp: Date.now()
            };
        }

        // ğŸ›’ã€ä¿®æ”¹ã€‘å‘é€ä»£ä»˜è¯·æ±‚æ¶ˆæ¯
        function sendPaymentRequestMessage(orderDetails, orderType) {
            if (!currentChatCharacter) return;

            const itemsHtml = orderDetails.items.map(item => `
                <div class="payment-item-row">
                    <span>${item.name}</span>
                    <span>Â¥${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            const recipientName = orderType === 'request_pay_self' ? 'æˆ‘è‡ªå·±' : currentChatCharacter.name;
            const requestNote = orderType === 'request_pay_self' ? 'è¯·å¸®æˆ‘æ”¯ä»˜è¿™ä¸ªè®¢å•ï¼Œè°¢è°¢ï¼' : 'è¯·å¸®å¿™æ”¯ä»˜è¿™ä¸ªè®¢å•ï¼Œè°¢è°¢ï¼';

            // ç¡®å®šå‘èµ·äººå’Œä»˜æ¬¾æ–¹
            const requesterName = orderType.endsWith('_self') ? 'æˆ‘' : currentChatCharacter?.name || 'ç”¨æˆ·';
            const payerName = orderType.endsWith('_self') ? currentChatCharacter?.name || 'äº²çˆ±çš„å°å‹' : 'æˆ‘';
            const isUserRequested = orderType.endsWith('_self');

            let messageContent;

            if (isUserRequested) {
                // ç”¨æˆ·å‘èµ·ä»£ä»˜ - é»„è‰²å¡ç‰‡æ ·å¼ï¼Œæ”¯æŒçŠ¶æ€æ˜¾ç¤º
                messageContent = `
                    <div class="payment-request-user-card" data-order-id="${orderDetails.orderNumber}">
                        <div class="payment-request-user-title">å‘èµ·è®¢å•ä»£ä»˜è¯·æ±‚</div>
                        <div class="payment-request-user-content">
                            <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                            <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                            <div class="payment-request-countdown">
                                å‰©ä½™æ”¯ä»˜æ—¶é—´ <span class="payment-request-countdown-time" id="countdown-${orderDetails.orderNumber}">15:00</span>
                            </div>
                            <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderDetails.orderNumber}')">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `;

                // å¯åŠ¨15åˆ†é’Ÿå€’è®¡æ—¶ - å»¶è¿Ÿå¯åŠ¨ç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    startPaymentCountdown(orderDetails.orderNumber);
                }, 100);
            }

            // å‘é€æ¶ˆæ¯åˆ°èŠå¤©
            const message = {
                id: Date.now(),
                content: messageContent,
                sender: 'sent',
                timestamp: Date.now(),
                type: 'payment_request',
                orderDetails: orderDetails,
                orderType: orderType,
                paymentStatus: null, // null=æœªå¤„ç†, 'paid'=å·²æ”¯ä»˜, 'rejected'=å·²æ‹’ç»
                paidBy: null,        // æ”¯ä»˜è€…åç§°
                rejectedBy: null     // æ‹’ç»è€…åç§°
            };

            addMessageToChat(message);

            // è®¢å•ä¿¡æ¯ç›´æ¥åµŒå…¥åˆ°æ¶ˆæ¯ä¸­ï¼Œä¸éœ€è¦é¢å¤–å­˜å‚¨

            // å­˜å‚¨å€’è®¡æ—¶å™¨
            window.paymentCountdowns = window.paymentCountdowns || {};
        }

        // ğŸ›’ã€æ–°å¢ã€‘å¯åŠ¨ä»£ä»˜å€’è®¡æ—¶ - ç®€åŒ–ç‰ˆæœ¬
        function startPaymentCountdown(orderNumber) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å€’è®¡æ—¶åœ¨è¿è¡Œ
            if (window.paymentCountdowns && window.paymentCountdowns[orderNumber]) {
                clearInterval(window.paymentCountdowns[orderNumber]);
            }

            let timeLeft = 15 * 60; // 15åˆ†é’Ÿ = 900ç§’
            const countdownElement = document.getElementById(`countdown-${orderNumber}`);
            if (!countdownElement) return;

            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                countdownElement.textContent = timeString;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = 'å·²è¶…æ—¶';
                    countdownElement.style.background = '#ff4444';

                    // ç¦ç”¨è¯¦æƒ…æŒ‰é’®
                    const detailsBtn = countdownElement.closest('.payment-request-user-card').querySelector('.payment-request-details-btn');
                    if (detailsBtn) {
                        detailsBtn.disabled = true;
                        detailsBtn.textContent = 'æ”¯ä»˜è¶…æ—¶';
                        detailsBtn.style.opacity = '0.5';
                    }

                    // æ¸…é™¤è®¡æ—¶å™¨
                    delete window.paymentCountdowns[orderNumber];
                }

                timeLeft--;
            }, 1000);

            // å­˜å‚¨è®¡æ—¶å™¨ä»¥ä¾¿åç»­æ¸…é™¤
            window.paymentCountdowns = window.paymentCountdowns || {};
            window.paymentCountdowns[orderNumber] = timer;
        }

        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†AIå¯¹ä»£ä»˜è¯·æ±‚çš„å›å¤
        async function processPaymentRequestResponse(paymentMessage, aiMessages, characterId) {
            console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] å¼€å§‹å¤„ç†AIå¯¹ä»£ä»˜è¯·æ±‚çš„å›å¤:', {
                paymentMessage,
                aiMessages,
                characterId
            });

            // åˆå¹¶æ‰€æœ‰AIå›å¤æ–‡æœ¬è¿›è¡Œåˆ†æ
            let fullAiResponse = '';
            for (const msgData of aiMessages) {
                if (typeof msgData === 'string') {
                    fullAiResponse += msgData + ' ';
                } else if (typeof msgData === 'object' && msgData.content) {
                    fullAiResponse += msgData.content + ' ';
                }
            }
            fullAiResponse = fullAiResponse.trim();
            console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] AIå®Œæ•´å›å¤å†…å®¹:', fullAiResponse);

            // æ£€æµ‹AIæ˜¯å¦åŒæ„ä»£ä»˜
            const acceptKeywords = [
                'æˆ‘æ¥ä»˜', 'æˆ‘ä»˜', 'æˆ‘ä¹°å•', 'æˆ‘å¸®ä½ ä»˜', 'æˆ‘å¸®ä½ ä¹°', 'æˆ‘ç»™ä½ ä¹°',
                'æˆ‘è¯·å®¢', 'æˆ‘è¯·ä½ ', 'æˆ‘æ¥ä¹°', 'æˆ‘æ¥æ”¯ä»˜', 'æˆ‘æ”¯ä»˜', 'æˆ‘æ¥ç»“è´¦',
                'æˆ‘å¸®ä½ ç»“è´¦', 'æˆ‘æ¥ç»“ç®—', 'æˆ‘ä¹°ç»™ä½ ', 'æˆ‘ç»™ä½ ä»˜æ¬¾', 'æˆ‘ä»˜æ¬¾',
                'æˆ‘æ¥ä»˜æ¬¾', 'æˆ‘å¸®ä½ ä»˜æ¬¾', 'æˆ‘æ›¿ä½ ä»˜', 'æˆ‘æ›¿ä½ ä¹°', 'æˆ‘ä¸ºä½ ä»˜',
                'æˆ‘ä¸ºä½ ä¹°', 'æˆ‘å‡ºé’±', 'æˆ‘æ¥å‡ºé’±', 'æˆ‘ä»˜é’±', 'æˆ‘ç»™é’±',
                'æˆ‘æ¥ç»™é’±', 'æˆ‘ä¹°ä¸‹', 'æˆ‘æ¥ä¹°ä¸‹', 'æˆ‘è´­ä¹°', 'æˆ‘æ¥è´­ä¹°',
                'æˆ‘ä¸‹å•', 'æˆ‘æ¥ä¸‹å•', 'æˆ‘ç»“è´¦', 'æˆ‘æ¥ç»“è´¦', 'æˆ‘ä»˜è´¦',
                'æˆ‘æ¥ä»˜è´¦', 'æˆ‘ä¹°å•äº†', 'æˆ‘ä»˜äº†', 'æˆ‘å·²ç»ä»˜', 'æˆ‘å·²ä»˜',
                'æˆ‘å¸®ä½ ä¹°å•', 'æˆ‘æ¥ä¹°å•', 'æˆ‘æ›¿ä½ ä¹°å•', 'æˆ‘ä¸ºä½ ä¹°å•',
                'æˆ‘ç»™ä½ ä¹°å•', 'æˆ‘å¸®ä½ ä¸‹å•', 'æˆ‘æ¥ä¸‹å•', 'æˆ‘æ›¿ä½ ä¸‹å•',
                'æˆ‘ä¸ºä½ ä¸‹å•', 'æˆ‘ç»™ä½ ä¸‹å•', 'æˆ‘å¸®ä½ è´­ä¹°', 'æˆ‘æ¥è´­ä¹°',
                'æˆ‘æ›¿ä½ è´­ä¹°', 'æˆ‘ä¸ºä½ è´­ä¹°', 'æˆ‘ç»™ä½ è´­ä¹°'
            ];

            // æ£€æµ‹AIæ˜¯å¦æ‹’ç»ä»£ä»˜
            const rejectKeywords = [
                'ä¸ä»˜', 'ä¸ä¹°', 'ä¸å¸®ä½ ä»˜', 'ä¸å¸®ä½ ä¹°', 'ä¸ç»™ä½ ä¹°', 'ä¸è¯·å®¢',
                'ä¸æ”¯ä»˜', 'ä¸ä»˜æ¬¾', 'ä¸å‡ºé’±', 'ä¸ç»™é’±', 'ä¸ä¹°å•', 'ä¸ç»“è´¦',
                'ä¸ä¸‹å•', 'ä¸è´­ä¹°', 'æ‹’ç»ä»˜', 'æ‹’ç»ä¹°', 'æ‹’ç»æ”¯ä»˜', 'æ‹’ç»ä»˜æ¬¾',
                'æ‹’ç»å‡ºé’±', 'æ‹’ç»ç»™é’±', 'æ‹’ç»ä¹°å•', 'æ‹’ç»ç»“è´¦', 'æ‹’ç»ä¸‹å•',
                'æ‹’ç»è´­ä¹°', 'ä¸æ„¿æ„ä»˜', 'ä¸æ„¿æ„ä¹°', 'ä¸æ„¿æ„æ”¯ä»˜', 'ä¸æ„¿æ„ä»˜æ¬¾',
                'ä¸æ„¿æ„å‡ºé’±', 'ä¸æ„¿æ„ç»™é’±', 'ä¸æ„¿æ„ä¹°å•', 'ä¸æ„¿æ„ç»“è´¦',
                'ä¸æ„¿æ„ä¸‹å•', 'ä¸æ„¿æ„è´­ä¹°', 'ä¸æƒ³ä»˜', 'ä¸æƒ³ä¹°', 'ä¸æƒ³æ”¯ä»˜',
                'ä¸æƒ³ä»˜æ¬¾', 'ä¸æƒ³å‡ºé’±', 'ä¸æƒ³ç»™é’±', 'ä¸æƒ³ä¹°å•', 'ä¸æƒ³ç»“è´¦',
                'ä¸æƒ³ä¸‹å•', 'ä¸æƒ³è´­ä¹°', 'æ²¡é’±', 'æ²¡æœ‰é’±', 'é’±ä¸å¤Ÿ', 'ä½™é¢ä¸è¶³',
                'ä¹°ä¸èµ·', 'ä»˜ä¸èµ·', 'å¤ªè´µ', 'å¤ªè´µäº†', 'æ‰¿æ‹…ä¸èµ·', 'è´Ÿæ‹…ä¸èµ·'
            ];

            const isAccepted = acceptKeywords.some(keyword => fullAiResponse.includes(keyword));
            const isRejected = rejectKeywords.some(keyword => fullAiResponse.includes(keyword));

            console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] å…³é”®è¯æ£€æµ‹ç»“æœ:', {
                isAccepted,
                isRejected,
                fullAiResponse: fullAiResponse.substring(0, 100) + '...'
            });

            // æ›´æ–°ä»£ä»˜è¯·æ±‚çŠ¶æ€
            if (isAccepted) {
                // AIåŒæ„ä»£ä»˜
                paymentMessage.paymentStatus = 'paid';
                paymentMessage.paidBy = currentChatCharacter?.name || 'è§’è‰²';
                console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] AIåŒæ„ä»£ä»˜ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå·²æ”¯ä»˜');

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updatePaymentRequestDisplay(paymentMessage.orderDetails.orderNumber, 'paid');

            } else if (isRejected) {
                // AIæ‹’ç»ä»£ä»˜
                paymentMessage.paymentStatus = 'rejected';
                paymentMessage.rejectedBy = currentChatCharacter?.name || 'è§’è‰²';
                console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] AIæ‹’ç»ä»£ä»˜ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå·²æ‹’ç»');

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updatePaymentRequestDisplay(paymentMessage.orderDetails.orderNumber, 'rejected');
            }

            // ä¿å­˜æ›´æ–°åçš„æ¶ˆæ¯
            if (isAccepted || isRejected) {
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] ä»£ä»˜çŠ¶æ€å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('ğŸ›’ [ä»£ä»˜å“åº”å¤„ç†] ä¿å­˜ä»£ä»˜çŠ¶æ€å¤±è´¥:', error);
                }
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ ¹æ®æ¶ˆæ¯çŠ¶æ€åŠ¨æ€ç”Ÿæˆä»£ä»˜è¯·æ±‚å†…å®¹
        function generatePaymentRequestContent(message) {
            const orderDetails = message.orderDetails;
            const paymentStatus = message.paymentStatus;

            if (!orderDetails) {
                return message.content; // å›é€€åˆ°åŸå§‹å†…å®¹
            }

            // æ ¹æ®çŠ¶æ€ç”Ÿæˆä¸åŒçš„å†…å®¹åŒºåŸŸ
            let contentArea = '';
            if (paymentStatus === 'paid') {
                // æ”¯ä»˜æˆåŠŸçŠ¶æ€ - å®Œå…¨ä¸åŒçš„å¸ƒå±€
                contentArea = `
                    <div class="payment-request-user-content">
                        <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                        <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                        <div class="payment-request-success-message">
                            æˆ‘å·²ä¸ºä½ ä¹°å•ï¼Œå°½æƒ…äº«ç”¨å§~<br>
                            <span class="payment-success-text">æ”¯ä»˜æˆåŠŸ</span>
                        </div>
                        <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderDetails.orderNumber}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            } else if (paymentStatus === 'rejected') {
                // æ‹’ç»çŠ¶æ€
                contentArea = `
                    <div class="payment-request-user-content">
                        <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                        <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                        <div class="payment-request-rejected-message">
                            æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚
                        </div>
                        <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderDetails.orderNumber}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            } else {
                // å¾…å¤„ç†çŠ¶æ€ - åŸæ¥çš„å€’è®¡æ—¶å¸ƒå±€
                contentArea = `
                    <div class="payment-request-user-content">
                        <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                        <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                        <div class="payment-request-countdown">
                            å‰©ä½™æ”¯ä»˜æ—¶é—´ <span class="payment-request-countdown-time" id="countdown-${orderDetails.orderNumber}">15:00</span>
                        </div>
                        <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderDetails.orderNumber}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            }

            // ç”ŸæˆHTMLå†…å®¹
            const content = `
                <div class="payment-request-user-card" data-order-id="${orderDetails.orderNumber}">
                    <div class="payment-request-user-title">å‘èµ·è®¢å•ä»£ä»˜è¯·æ±‚</div>
                    ${contentArea}
                </div>
            `;

            // å¦‚æœæ˜¯æœªå¤„ç†çŠ¶æ€ï¼Œéœ€è¦å¯åŠ¨å€’è®¡æ—¶
            if (!paymentStatus) {
                setTimeout(() => {
                    startPaymentCountdown(orderDetails.orderNumber);
                }, 100);
            }

            return content;
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ›´æ–°ä»£ä»˜è¯·æ±‚çš„ç•Œé¢æ˜¾ç¤º
        function updatePaymentRequestDisplay(orderNumber, status) {
            console.log('ğŸ›’ [ç•Œé¢æ›´æ–°] æ›´æ–°ä»£ä»˜è¯·æ±‚æ˜¾ç¤º:', { orderNumber, status });

            // æŸ¥æ‰¾å¯¹åº”çš„ä»£ä»˜å¡ç‰‡
            const paymentCard = document.querySelector(`[data-order-id="${orderNumber}"]`);
            if (!paymentCard) {
                console.log('ğŸ›’ [ç•Œé¢æ›´æ–°] æœªæ‰¾åˆ°ä»£ä»˜å¡ç‰‡:', orderNumber);
                return;
            }

            // åœæ­¢å€’è®¡æ—¶
            if (window.paymentCountdowns && window.paymentCountdowns[orderNumber]) {
                clearInterval(window.paymentCountdowns[orderNumber]);
                delete window.paymentCountdowns[orderNumber];
            }

            // è·å–è®¢å•ä¿¡æ¯ï¼ˆä»æ¶ˆæ¯æ•°æ®ä¸­ï¼‰
            const currentMessages = chatMessages[currentChatCharacter?.id] || [];
            let orderDetails = null;
            for (const message of currentMessages) {
                if (message.type === 'payment_request' &&
                    message.orderDetails &&
                    message.orderDetails.orderNumber === orderNumber) {
                    orderDetails = message.orderDetails;
                    break;
                }
            }

            if (!orderDetails) {
                console.log('ğŸ›’ [ç•Œé¢æ›´æ–°] æœªæ‰¾åˆ°è®¢å•è¯¦æƒ…');
                return;
            }

            // é‡æ–°ç”Ÿæˆæ•´ä¸ªå†…å®¹åŒºåŸŸ
            let newContentArea = '';
            if (status === 'paid') {
                newContentArea = `
                    <div class="payment-request-user-content">
                        <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                        <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                        <div class="payment-request-success-message">
                            æˆ‘å·²ä¸ºä½ ä¹°å•ï¼Œå°½æƒ…äº«ç”¨å§~<br>
                            <span class="payment-success-text">æ”¯ä»˜æˆåŠŸ</span>
                        </div>
                        <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderNumber}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            } else if (status === 'rejected') {
                newContentArea = `
                    <div class="payment-request-user-content">
                        <div class="payment-request-amount-label">éœ€ä»˜æ¬¾</div>
                        <div class="payment-request-amount-value">Â¥${orderDetails.total.toFixed(2)}</div>
                        <div class="payment-request-rejected-message">
                            æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚
                        </div>
                        <button class="payment-request-details-btn" onclick="showPaymentDetails('${orderNumber}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            }

            // æ›´æ–°å¡ç‰‡å†…å®¹
            paymentCard.innerHTML = `
                <div class="payment-request-user-title">å‘èµ·è®¢å•ä»£ä»˜è¯·æ±‚</div>
                ${newContentArea}
            `;

            console.log('ğŸ›’ [ç•Œé¢æ›´æ–°] ä»£ä»˜è¯·æ±‚æ˜¾ç¤ºå·²æ›´æ–°');
        }

        // ğŸ›’ã€æ–°å¢ã€‘æ˜¾ç¤ºä»£ä»˜è¯¦æƒ…æ¨¡æ€æ¡†
        function showPaymentDetails(orderNumber) {
            // ä»å½“å‰èŠå¤©è®°å½•ä¸­æŸ¥æ‰¾è®¢å•ä¿¡æ¯
            let orderDetails = null;
            const currentMessages = chatMessages[currentChatCharacter?.id] || [];

            for (const message of currentMessages) {
                if (message.type === 'payment_request' &&
                    message.orderDetails &&
                    message.orderDetails.orderNumber === orderNumber) {
                    orderDetails = message.orderDetails;
                    break;
                }
            }

            if (!orderDetails) {
                alert('è®¢å•ä¿¡æ¯ä¸å­˜åœ¨');
                return;
            }

            const itemsHtml = orderDetails.items.map(item => {
                // ğŸ”¥ã€ä¿®å¤ã€‘ç”ŸæˆåŒ…å«é€‰é¡¹ä¿¡æ¯çš„å•†å“åç§°
                let itemNameWithOptions = `${item.name} x${item.quantity}`;
                if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                    const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                        `${getOptionLabel(key)}: ${value}`
                    ).join(', ');
                    itemNameWithOptions += `<br><small style="color: #666; font-size: 12px;">${optionsText}</small>`;
                }

                return `
                    <div class="payment-details-item">
                        <span class="payment-details-item-name">${itemNameWithOptions}</span>
                        <span class="payment-details-item-price">Â¥${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            }).join('');

            // åˆ›å»ºå…³é—­å‡½æ•°
            window.closePaymentModal = function() {
                const modal = document.getElementById('paymentDetailsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            };

            const modalContent = `
                <div class="modal-header">
                    <h3>è®¢å•è¯¦æƒ…</h3>
                    <button class="modal-close-btn" onclick="window.closePaymentModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="payment-details-item">
                        <span class="payment-details-item-name">è®¢å•å·</span>
                        <span class="payment-details-item-price">${orderDetails.orderNumber}</span>
                    </div>
                    ${itemsHtml}
                    <div class="payment-details-item">
                        <span class="payment-details-item-name">æ€»è®¡</span>
                        <span class="payment-details-item-price">Â¥${orderDetails.total.toFixed(2)}</span>
                    </div>
                </div>
            `;

            // åˆ›å»ºæˆ–æ›´æ–°æ¨¡æ€æ¡†
            let modal = document.getElementById('paymentDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'paymentDetailsModal';
                modal.className = 'modal payment-details-modal';
                document.body.appendChild(modal);
            }

            // æ›´æ–°å†…å®¹
            modal.innerHTML = `
                <div class="modal-content">
                    ${modalContent}
                </div>
            `;

            // é‡æ–°ç»‘å®šèƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
            modal.onclick = function(e) {
                if (e.target === modal) {
                    window.closePaymentModal();
                }
            };

            modal.style.display = 'flex';
        }





        // ğŸ›’ã€ä¿®æ”¹ã€‘å‘é€è®¢å•ç¡®è®¤æ¶ˆæ¯
        function sendOrderMessage(orderDetails, orderType) {
            if (!currentChatCharacter) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘ç”ŸæˆåŒ…å«é€‰é¡¹ä¿¡æ¯çš„å•†å“åˆ—è¡¨
            const itemsList = orderDetails.items.map(item => {
                let itemText = `${item.name} x${item.quantity}`;

                // æ·»åŠ é€‰é¡¹ä¿¡æ¯
                if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                    const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                        `${getOptionLabel(key)}: ${value}`
                    ).join(', ');
                    itemText += ` (${optionsText})`;
                }

                return itemText;
            }).join('ã€');

            // è®¢å•ç¡®è®¤æ¶ˆæ¯å°†ç”±æ¸²æŸ“å‡½æ•°ç”ŸæˆHTMLæ ¼å¼ï¼Œè¿™é‡Œåªéœ€è¦åŸºæœ¬ä¿¡æ¯
            let messageContent = 'è®¢å•ç¡®è®¤';

            // å‘é€æ¶ˆæ¯åˆ°èŠå¤©
            const message = {
                id: Date.now(),
                content: messageContent,
                sender: 'sent',
                timestamp: Date.now(),
                type: 'order_confirmation',
                orderDetails: orderDetails,
                orderType: orderType
            };

            addMessageToChat(message);
        }

        // ğŸ›’ã€æ–°å¢ã€‘è‡ªå®šä¹‰æç¤ºå‡½æ•°
        function showCustomToast(message, type = 'default', duration = 1500) {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºæ–°çš„æç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.textContent = message;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.add('fade-out');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }



        // ğŸ›’ã€æ–°å¢ã€‘ç”ŸæˆAIçš„è®¢å•ç¡®è®¤å†…å®¹
        function generateAIOrderConfirmationContent(message) {
            const orderDetails = message.orderDetails;
            const orderType = message.orderType;

            if (!orderDetails) {
                return `<div class="message-bubble">${message.content}</div>`; // å›é€€åˆ°åŸå§‹å†…å®¹
            }

            // ç”Ÿæˆå•†å“åˆ—è¡¨
            const itemsList = orderDetails.items.map(item => {
                let itemText = `${item.name} x${item.quantity}`;
                if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                    const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                        `${getOptionLabel(key)}: ${value}`
                    ).join(', ');
                    itemText += ` (${optionsText})`;
                }
                return `<div class="receipt-item">${itemText} <span class="receipt-item-price">Â¥${item.price}</span></div>`;
            }).join('');

            let receiptTitle = '';
            let receiptIcon = '';

            if (orderType === 'ai_order') {
                receiptTitle = 'æˆ‘çš„è®¢å•';
                receiptIcon = 'ğŸ›ï¸';
            } else {
                receiptTitle = 'è®¢å•ç¡®è®¤';
                receiptIcon = 'ğŸ“‹';
            }

            return `
                <div class="order-confirmation-container ai-order">
                    <div class="receipt-card">
                        <div class="receipt-header">
                            <div class="receipt-title">${receiptIcon} ${receiptTitle}</div>
                            <div class="receipt-subtitle">è®¢å•æ”¯ä»˜æˆåŠŸ</div>
                        </div>
                        <div class="receipt-content">
                            <div class="receipt-order-number">è®¢å•å·ï¼š${orderDetails.orderNumber}</div>
                            <div class="receipt-items">${itemsList}</div>
                            <div class="receipt-divider"></div>
                            <div class="receipt-total">æ€»è®¡ï¼šÂ¥${orderDetails.total.toFixed(2)}</div>
                            <div class="receipt-time">ä¸‹å•æ—¶é—´ï¼š${new Date(orderDetails.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="receipt-footer">
                            <div class="thank-you">æ„Ÿè°¢è´­ä¹°ï¼</div>
                        </div>
                    </div>
                </div>
            `;
        }









        // ğŸ›’ã€æ–°å¢ã€‘æ ¹æ®é€‰é¡¹è®¡ç®—å•†å“ä»·æ ¼
        function getProductPrice(product, selectedOptions = {}) {
            if (!product.prices) {
                return product.price;
            }

            // æŸ¥æ‰¾æœ‰ä»·æ ¼å®šä¹‰çš„é€‰é¡¹
            for (const [optionKey, optionValue] of Object.entries(selectedOptions)) {
                if (product.prices[optionKey] && product.prices[optionKey][optionValue] !== undefined) {
                    return product.prices[optionKey][optionValue];
                }
            }

            return product.price;
        }

        // ğŸ›’ã€æ–°å¢ã€‘å®æ—¶æ›´æ–°å•†å“ä»·æ ¼æ˜¾ç¤º
        function updateProductPrice(categoryName, productIndex) {
            const product = productsData[categoryName][productIndex];
            const selectedOptions = {};

            // è·å–å½“å‰é€‰æ‹©çš„æ‰€æœ‰é€‰é¡¹
            for (const optionKey of Object.keys(product.options)) {
                const selectElement = document.getElementById(`option-${optionKey}`);
                if (selectElement) {
                    selectedOptions[optionKey] = selectElement.value;
                }
            }

            // è®¡ç®—æ–°ä»·æ ¼
            const newPrice = getProductPrice(product, selectedOptions);

            // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
            const priceElement = document.getElementById('current-price');
            if (priceElement) {
                priceElement.textContent = `Â¥${newPrice}`;
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showCustomConfirm(title, message, onConfirm, onCancel) {
            // ç§»é™¤å·²å­˜åœ¨çš„ç¡®è®¤æ¡†
            const existingConfirm = document.querySelector('.custom-confirm');
            if (existingConfirm) {
                existingConfirm.remove();
            }

            // åˆ›å»ºç¡®è®¤æ¡†å…ƒç´ 
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'custom-confirm';
            confirmDialog.innerHTML = `
                <div class="custom-confirm-dialog">
                    <div class="custom-confirm-title">${title}</div>
                    <div class="custom-confirm-message">${message}</div>
                    <div class="custom-confirm-buttons">
                        <button class="custom-confirm-btn cancel" onclick="closeCustomConfirm()">å–æ¶ˆ</button>
                        <button class="custom-confirm-btn confirm" onclick="confirmCustomAction()">ç¡®å®š</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(confirmDialog);

            // å­˜å‚¨å›è°ƒå‡½æ•°
            window.customConfirmCallbacks = {
                onConfirm: onConfirm || (() => {}),
                onCancel: onCancel || (() => {})
            };

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    closeCustomConfirm();
                }
            });
        }

        // ğŸ›’ã€æ–°å¢ã€‘å…³é—­è‡ªå®šä¹‰ç¡®è®¤æ¡†
        function closeCustomConfirm() {
            const confirmDialog = document.querySelector('.custom-confirm');
            if (confirmDialog) {
                confirmDialog.remove();
            }
            if (window.customConfirmCallbacks && window.customConfirmCallbacks.onCancel) {
                window.customConfirmCallbacks.onCancel();
            }
        }

        // ğŸ›’ã€æ–°å¢ã€‘ç¡®è®¤è‡ªå®šä¹‰æ“ä½œ
        function confirmCustomAction() {
            const confirmDialog = document.querySelector('.custom-confirm');
            if (confirmDialog) {
                confirmDialog.remove();
            }
            if (window.customConfirmCallbacks && window.customConfirmCallbacks.onConfirm) {
                window.customConfirmCallbacks.onConfirm();
            }
        }

        // æ›´æ–°è´­ç‰©è½¦å¾½ç« æ•°é‡
        function updateCartBadge(count) {
            const badge = document.getElementById('cart-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // çº¦å®šè¡¨å•åŠŸèƒ½
        function showAppointmentForm(appointmentId = null) {
            editingAppointmentId = appointmentId;
            const modal = document.getElementById('appointment-form-modal');
            const title = document.getElementById('appointment-form-title');

            // å¡«å……è§’è‰²é€‰æ‹©åˆ—è¡¨
            populateCharacterSelect('appointment-character');

            if (appointmentId) {
                // ç¼–è¾‘æ¨¡å¼
                title.textContent = 'ç¼–è¾‘çº¦å®š';
                const appointment = appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    document.getElementById('appointment-name').value = appointment.name;
                    document.getElementById('appointment-date').value = appointment.date;
                    document.getElementById('appointment-time').value = appointment.time || '';

                    // å¤„ç†ç±»å‹å’Œè‡ªå®šä¹‰ç±»å‹
                    if (appointment.customType) {
                        document.getElementById('appointment-type').value = 'other';
                        document.getElementById('appointment-custom-type').value = appointment.customType;
                        toggleCustomTypeInput('appointment');
                    } else {
                        document.getElementById('appointment-type').value = appointment.type;
                    }

                    document.getElementById('appointment-character').value = appointment.characterId || '';
                    document.getElementById('appointment-priority').value = appointment.priority || 'medium';
                    document.getElementById('appointment-description').value = appointment.description || '';
                    document.getElementById('appointment-user-quote').value = appointment.userQuote || '';
                    document.getElementById('appointment-character-quote').value = appointment.characterQuote || '';
                    document.getElementById('appointment-shared').checked = appointment.isShared === true;
                    document.getElementById('appointment-pinned').checked = appointment.isPinned === true;
                    document.getElementById('appointment-count-type').value = appointment.countType || 'countdown';
                    document.getElementById('appointment-never-expires').checked = appointment.neverExpires === true;

                    // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ˜¯æ°¸ä¸è¿‡æœŸï¼Œè§¦å‘ç›¸åº”çš„UIæ›´æ–°
                    if (appointment.neverExpires) {
                        toggleNeverExpires('appointment');
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ˜¾ç¤ºèƒŒæ™¯å›¾é¢„è§ˆ
                    if (appointment.backgroundImage) {
                        document.getElementById('appointment-background-img').src = appointment.backgroundImage;
                        document.getElementById('appointment-background-preview').style.display = 'block';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ˜¾ç¤ºç”¨æˆ·å¤´åƒé¢„è§ˆ
                    if (appointment.userAvatar) {
                        document.getElementById('appointment-user-avatar-img').src = appointment.userAvatar;
                        document.getElementById('appointment-user-avatar-preview').style.display = 'block';
                    }

                    // æ˜¾ç¤ºæˆ–éšè—è§’è‰²è¯­å½•åŒºåŸŸ
                    toggleCharacterQuoteGroup('appointment', appointment.characterId);
                }
            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = 'æ·»åŠ çº¦å®š';
                clearAppointmentForm();
            }

            modal.style.display = 'flex';
        }

        function closeAppointmentForm() {
            document.getElementById('appointment-form-modal').style.display = 'none';
            clearAppointmentForm();
            editingAppointmentId = null;
        }

        function clearAppointmentForm() {
            document.getElementById('appointment-name').value = '';
            document.getElementById('appointment-date').value = '';
            document.getElementById('appointment-time').value = '';
            document.getElementById('appointment-type').value = 'date';
            document.getElementById('appointment-custom-type').value = '';
            document.getElementById('appointment-character').value = '';
            document.getElementById('appointment-priority').value = 'medium';
            document.getElementById('appointment-description').value = '';
            document.getElementById('appointment-user-quote').value = '';
            document.getElementById('appointment-character-quote').value = '';
            document.getElementById('appointment-shared').checked = false;
            document.getElementById('appointment-pinned').checked = false;
            document.getElementById('appointment-count-type').value = 'countdown';
            document.getElementById('appointment-never-expires').checked = false;

            // ğŸ”¥ã€æ–°å¢ã€‘é‡ç½®æ°¸ä¸è¿‡æœŸç›¸å…³çš„UIçŠ¶æ€
            const dateInput = document.getElementById('appointment-date');
            const timeInput = document.getElementById('appointment-time');
            dateInput.disabled = false;
            timeInput.disabled = false;
            dateInput.style.opacity = '1';
            timeInput.style.opacity = '1';

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç©ºæ–‡ä»¶è¾“å…¥å’Œé¢„è§ˆ
            document.getElementById('appointment-background-upload').value = '';
            document.getElementById('appointment-user-avatar-upload').value = '';
            document.getElementById('appointment-background-preview').style.display = 'none';
            document.getElementById('appointment-user-avatar-preview').style.display = 'none';
            document.getElementById('appointment-background-img').src = '';
            document.getElementById('appointment-user-avatar-img').src = '';

            // éšè—è§’è‰²è¯­å½•åŒºåŸŸå’Œè‡ªå®šä¹‰ç±»å‹åŒºåŸŸ
            toggleCharacterQuoteGroup('appointment', '');
            toggleCustomTypeInput('appointment');
        }

        async function saveAppointment(event) {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // ğŸ”¥ã€ä¿®å¤ã€‘å®‰å…¨è·å–æ‰€æœ‰è¡¨å•å€¼ï¼Œç¡®ä¿ä¸ä¼šè·å–åˆ°äº‹ä»¶å¯¹è±¡
            const nameEl = document.getElementById('appointment-name');
            const dateEl = document.getElementById('appointment-date');
            const timeEl = document.getElementById('appointment-time');
            const typeEl = document.getElementById('appointment-type');
            const customTypeEl = document.getElementById('appointment-custom-type');
            const characterIdEl = document.getElementById('appointment-character');
            const priorityEl = document.getElementById('appointment-priority');
            const descriptionEl = document.getElementById('appointment-description');
            const userQuoteEl = document.getElementById('appointment-user-quote');
            const characterQuoteEl = document.getElementById('appointment-character-quote');
            const isSharedEl = document.getElementById('appointment-shared');
            const isPinnedEl = document.getElementById('appointment-pinned');
            const countTypeEl = document.getElementById('appointment-count-type');
            const neverExpiresEl = document.getElementById('appointment-never-expires');

            const name = nameEl ? String(nameEl.value || '').trim() : '';
            const date = dateEl ? String(dateEl.value || '') : '';
            const time = timeEl ? String(timeEl.value || '') : '';
            const type = typeEl ? String(typeEl.value || '') : '';
            const customType = customTypeEl ? String(customTypeEl.value || '').trim() : '';
            const characterId = characterIdEl ? String(characterIdEl.value || '') : '';
            const priority = priorityEl ? String(priorityEl.value || 'medium') : 'medium';
            const description = descriptionEl ? String(descriptionEl.value || '').trim() : '';
            const userQuote = userQuoteEl ? String(userQuoteEl.value || '').trim() : '';
            const characterQuote = characterQuoteEl ? String(characterQuoteEl.value || '').trim() : '';
            const isShared = isSharedEl ? Boolean(isSharedEl.checked) : false;
            const isPinned = isPinnedEl ? Boolean(isPinnedEl.checked) : false;
            const countType = countTypeEl ? String(countTypeEl.value || 'countdown') : 'countdown';
            const neverExpires = neverExpiresEl ? Boolean(neverExpiresEl.checked) : false;

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºæ‰€æœ‰è·å–çš„å€¼
            console.log('è·å–çš„è¡¨å•å€¼:', {
                name, date, time, type, customType, characterId,
                priority, description, userQuote, characterQuote, isShared, isPinned, countType, neverExpires
            });

            // ğŸ”¥ã€ä¿®æ”¹ã€‘éªŒè¯é€»è¾‘ - æ°¸ä¸è¿‡æœŸçš„çº¦å®šä¸éœ€è¦æ—¥æœŸ
            if (!name || (!neverExpires && !date)) {
                showToast(neverExpires ? 'è¯·å¡«å†™çº¦å®šåç§°' : 'è¯·å¡«å†™çº¦å®šåç§°å’Œæ—¥æœŸ', 'error');
                return;
            }

            if (type === 'other' && !customType) {
                showToast('è¯·å¡«å†™è‡ªå®šä¹‰ç±»å‹', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–èƒŒæ™¯å›¾å’Œç”¨æˆ·å¤´åƒ
            const backgroundImg = document.getElementById('appointment-background-img');
            const userAvatarImg = document.getElementById('appointment-user-avatar-img');
            const backgroundImage = backgroundImg && backgroundImg.src && backgroundImg.src !== window.location.href ? backgroundImg.src : null;
            const userAvatar = userAvatarImg && userAvatarImg.src && userAvatarImg.src !== window.location.href ? userAvatarImg.src : null;

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸¥æ ¼æ¸…ç†æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿æ²¡æœ‰äº‹ä»¶å¯¹è±¡æˆ–å…¶ä»–ä¸å¯åºåˆ—åŒ–çš„å†…å®¹
                const appointmentData = {
                    name: String(name || ''),
                    date: neverExpires ? null : String(date || ''),
                    time: neverExpires ? null : String(time || ''),
                    type: String(type === 'other' ? 'other' : type || ''),
                    customType: type === 'other' ? String(customType || '') : null,
                    characterId: characterId ? String(characterId) : null,
                    priority: String(priority || 'medium'),
                    description: String(description || ''),
                    userQuote: userQuote ? String(userQuote) : null,
                    characterQuote: characterQuote ? String(characterQuote) : null,
                    isShared: Boolean(isShared),
                    isPinned: Boolean(isPinned),
                    backgroundImage: backgroundImage ? String(backgroundImage) : null,
                    userAvatar: userAvatar ? String(userAvatar) : null,
                    countType: String(countType || 'countdown'),
                    neverExpires: Boolean(neverExpires),
                    completed: false,
                    createdBy: 'user',
                    timestamp: Date.now()
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœå½“å‰çº¦å®šè¢«è®¾ç½®ä¸ºç½®é¡¶ï¼Œéœ€è¦å…ˆå–æ¶ˆå…¶ä»–çº¦å®šçš„ç½®é¡¶çŠ¶æ€
                if (isPinned) {
                    // æ‰¾åˆ°æ‰€æœ‰å…¶ä»–ç½®é¡¶çš„çº¦å®šå¹¶å–æ¶ˆç½®é¡¶
                    const otherPinnedAppointments = appointments.filter(a =>
                        a.isPinned && a.id !== appointmentData.id
                    );

                    for (const otherAppointment of otherPinnedAppointments) {
                        otherAppointment.isPinned = false;
                        await db.appointments.put(otherAppointment);
                    }

                    if (otherPinnedAppointments.length > 0) {
                        console.log(`å–æ¶ˆäº† ${otherPinnedAppointments.length} ä¸ªçº¦å®šçš„ç½®é¡¶çŠ¶æ€`);
                    }
                }

                if (editingAppointmentId) {
                    // ç¼–è¾‘æ¨¡å¼
                    appointmentData.id = String(editingAppointmentId);

                    // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡
                    console.log('å‡†å¤‡æ›´æ–°çº¦å®šæ•°æ®:', JSON.stringify(appointmentData, null, 2));

                    await db.appointments.put(appointmentData);
                    const index = appointments.findIndex(a => a.id === editingAppointmentId);
                    if (index !== -1) {
                        appointments[index] = appointmentData;
                    }
                    showToast('çº¦å®šå·²æ›´æ–°', 'success');

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°åé‡æ–°åŠ è½½åˆ—è¡¨
                    closeAppointmentForm();
                    loadAppointmentList();

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•çº¦å®šæ›´æ–°åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    if (appointmentData.isShared && appointmentData.characterId) {
                        try {
                            await recordCrossAppEvent(
                                appointmentData.characterId,
                                'appointment',
                                'update',
                                {
                                    id: appointmentData.id,
                                    type: 'appointment_update',
                                    content: `ç”¨æˆ·æ›´æ–°äº†çº¦å®š"${appointmentData.name}"ï¼ˆ${appointmentData.date}${appointmentData.time ? ' ' + appointmentData.time : ''}ï¼‰${appointmentData.description ? 'ï¼š' + appointmentData.description : ''}`,
                                    appointmentName: appointmentData.name,
                                    appointmentDate: appointmentData.date,
                                    appointmentTime: appointmentData.time,
                                    appointmentType: appointmentData.type,
                                    description: appointmentData.description,
                                    priority: appointmentData.priority
                                }
                            );
                            console.log('ğŸ“ [çº¦å®šæ—¶é—´çº¿] å·²è®°å½•çº¦å®šæ›´æ–°äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                        } catch (error) {
                            console.error('âŒ [çº¦å®šæ—¶é—´çº¿] è®°å½•çº¦å®šæ›´æ–°äº‹ä»¶å¤±è´¥:', error);
                        }
                    }
                } else {
                    // æ–°å¢æ¨¡å¼
                    appointmentData.id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);

                    // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡
                    console.log('å‡†å¤‡æ·»åŠ çº¦å®šæ•°æ®:', JSON.stringify(appointmentData, null, 2));

                    await db.appointments.add(appointmentData);
                    appointments.push(appointmentData);
                    showToast('çº¦å®šå·²æ·»åŠ ', 'success');

                    // ğŸ”¥ã€è°ƒè¯•ã€‘éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®
                    const dbAppointments = await db.appointments.toArray();
                    console.log('ğŸ” æ•°æ®åº“ä¸­çš„æ‰€æœ‰çº¦å®š:', dbAppointments.length, dbAppointments);

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•çº¦å®šåˆ›å»ºåˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    if (appointmentData.isShared && appointmentData.characterId) {
                        try {
                            await recordCrossAppEvent(
                                appointmentData.characterId,
                                'appointment',
                                'create',
                                {
                                    id: appointmentData.id,
                                    type: 'appointment_create',
                                    content: `ç”¨æˆ·åˆ›å»ºäº†çº¦å®š"${appointmentData.name}"ï¼ˆ${appointmentData.date}${appointmentData.time ? ' ' + appointmentData.time : ''}ï¼‰${appointmentData.description ? 'ï¼š' + appointmentData.description : ''}`,
                                    appointmentName: appointmentData.name,
                                    appointmentDate: appointmentData.date,
                                    appointmentTime: appointmentData.time,
                                    appointmentType: appointmentData.type,
                                    description: appointmentData.description,
                                    priority: appointmentData.priority
                                },
                                appointmentData.id
                            );
                            console.log('ğŸ“ [çº¦å®šæ—¶é—´çº¿] å·²è®°å½•çº¦å®šåˆ›å»ºäº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                        } catch (error) {
                            console.error('âŒ [çº¦å®šæ—¶é—´çº¿] è®°å½•çº¦å®šåˆ›å»ºäº‹ä»¶å¤±è´¥:', error);
                        }
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ–°å¢çº¦å®šåå…³é—­è¡¨å•å¹¶é‡æ–°åŠ è½½åˆ—è¡¨
                if (!editingAppointmentId) {
                    closeAppointmentForm();
                    loadAppointmentList();
                }
            } catch (error) {
                console.error('ä¿å­˜çº¦å®šå¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }



        // æ˜¾ç¤ºçºªå¿µæ—¥è¡¨å•
        function showAnniversaryForm(anniversaryId = null) {
            editingAnniversaryId = anniversaryId;
            const modal = document.getElementById('anniversary-form-modal');
            const title = document.getElementById('anniversary-form-title');

            // å¡«å……è§’è‰²é€‰æ‹©åˆ—è¡¨
            populateCharacterSelect('anniversary-character');

            if (anniversaryId) {
                // ç¼–è¾‘æ¨¡å¼
                title.textContent = 'ç¼–è¾‘çºªå¿µæ—¥';
                const anniversary = anniversaries.find(a => a.id === anniversaryId);
                if (anniversary) {
                    document.getElementById('anniversary-name').value = anniversary.name;
                    document.getElementById('anniversary-date').value = anniversary.date;

                    // å¤„ç†ç±»å‹å’Œè‡ªå®šä¹‰ç±»å‹
                    if (anniversary.customType) {
                        document.getElementById('anniversary-type').value = 'other';
                        document.getElementById('anniversary-custom-type').value = anniversary.customType;
                        toggleCustomTypeInput('anniversary');
                    } else {
                        document.getElementById('anniversary-type').value = anniversary.type;
                    }

                    document.getElementById('anniversary-character').value = anniversary.characterId || '';
                    document.getElementById('anniversary-description').value = anniversary.description || '';
                    document.getElementById('anniversary-user-quote').value = anniversary.userQuote || '';
                    document.getElementById('anniversary-character-quote').value = anniversary.characterQuote || '';
                    document.getElementById('anniversary-yearly').checked = anniversary.yearly !== false;
                    document.getElementById('anniversary-shared').checked = anniversary.isShared === true;
                    document.getElementById('anniversary-pinned').checked = anniversary.isPinned === true;
                    document.getElementById('anniversary-count-type').value = anniversary.countType || 'countdown';

                    // æ˜¾ç¤ºèƒŒæ™¯å›¾é¢„è§ˆ
                    if (anniversary.backgroundImage) {
                        document.getElementById('anniversary-background-img').src = anniversary.backgroundImage;
                        document.getElementById('anniversary-background-preview').style.display = 'block';
                    }

                    // æ˜¾ç¤ºç”¨æˆ·å¤´åƒé¢„è§ˆ
                    if (anniversary.userAvatar) {
                        document.getElementById('anniversary-user-avatar-img').src = anniversary.userAvatar;
                        document.getElementById('anniversary-user-avatar-preview').style.display = 'block';
                    }

                    // æ˜¾ç¤ºæˆ–éšè—è§’è‰²è¯­å½•åŒºåŸŸ
                    toggleCharacterQuoteGroup('anniversary', anniversary.characterId);
                }
            } else {
                // æ–°å»ºæ¨¡å¼
                title.textContent = 'æ·»åŠ çºªå¿µæ—¥';
                clearAnniversaryForm();
            }

            modal.style.display = 'flex';
        }

        // å…³é—­çºªå¿µæ—¥è¡¨å•
        function closeAnniversaryForm() {
            document.getElementById('anniversary-form-modal').style.display = 'none';
            clearAnniversaryForm();
            editingAnniversaryId = null;
        }

        // æ¸…ç©ºçºªå¿µæ—¥è¡¨å•
        function clearAnniversaryForm() {
            document.getElementById('anniversary-name').value = '';
            document.getElementById('anniversary-date').value = '';
            document.getElementById('anniversary-type').value = 'birthday';
            document.getElementById('anniversary-custom-type').value = '';
            document.getElementById('anniversary-character').value = '';
            document.getElementById('anniversary-description').value = '';
            document.getElementById('anniversary-user-quote').value = '';
            document.getElementById('anniversary-character-quote').value = '';
            document.getElementById('anniversary-yearly').checked = true;
            document.getElementById('anniversary-shared').checked = false;
            document.getElementById('anniversary-pinned').checked = false;
            document.getElementById('anniversary-count-type').value = 'countdown';

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥å’Œé¢„è§ˆ
            document.getElementById('anniversary-background-upload').value = '';
            document.getElementById('anniversary-user-avatar-upload').value = '';
            document.getElementById('anniversary-background-preview').style.display = 'none';
            document.getElementById('anniversary-user-avatar-preview').style.display = 'none';

            // éšè—è§’è‰²è¯­å½•åŒºåŸŸå’Œè‡ªå®šä¹‰ç±»å‹åŒºåŸŸ
            toggleCharacterQuoteGroup('anniversary', '');
            toggleCustomTypeInput('anniversary');
        }

        // å¡«å……è§’è‰²é€‰æ‹©åˆ—è¡¨
        function populateCharacterSelect(selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
            select.innerHTML = '<option value="">é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>';

            // æ·»åŠ æ‰€æœ‰è§’è‰²
            characters.forEach(character => {
                const option = document.createElement('option');
                option.value = character.id;
                option.textContent = character.name;
                select.appendChild(option);
            });

            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘åˆ‡æ¢è§’è‰²è¯­å½•åŒºåŸŸæ˜¾ç¤º - æ”¯æŒç”¨æˆ·å’Œè§’è‰²åŒè¯­å½•
        function toggleCharacterQuoteGroup(type, characterId) {
            const quoteGroup = document.getElementById(`${type}-character-quote-group`);
            const quoteTextarea = document.getElementById(`${type}-character-quote`);
            const quoteLabel = document.getElementById(`${type}-quote-label`);

            if (characterId) {
                // é€‰æ‹©äº†è§’è‰²ï¼Œæ˜¾ç¤ºè§’è‰²è¯­å½•åŒºåŸŸ
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    quoteGroup.style.display = 'block';
                    quoteLabel.textContent = 'è§’è‰²è¯­å½•';
                    quoteTextarea.placeholder = `${character.name}å¯¹è¿™ä¸ª${type === 'anniversary' ? 'çºªå¿µæ—¥' : 'çº¦å®š'}çš„æ„Ÿæƒ³...`;
                }
            } else {
                // æ²¡æœ‰é€‰æ‹©è§’è‰²ï¼Œéšè—è§’è‰²è¯­å½•åŒºåŸŸ
                quoteGroup.style.display = 'none';
                quoteTextarea.value = ''; // æ¸…ç©ºè§’è‰²è¯­å½•å†…å®¹
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰ç±»å‹è¾“å…¥æ¡†æ˜¾ç¤º
        function toggleCustomTypeInput(type) {
            const typeSelect = document.getElementById(`${type}-type`);
            const customTypeGroup = document.getElementById(`${type}-custom-type-group`);
            const customTypeInput = document.getElementById(`${type}-custom-type`);

            if (typeSelect.value === 'other') {
                customTypeGroup.style.display = 'block';
                customTypeInput.focus();
            } else {
                customTypeGroup.style.display = 'none';
                customTypeInput.value = '';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢æ°¸ä¸è¿‡æœŸé€‰é¡¹
        function toggleNeverExpires(type) {
            const neverExpiresCheckbox = document.getElementById(`${type}-never-expires`);
            const dateInput = document.getElementById(`${type}-date`);
            const timeInput = document.getElementById(`${type}-time`);

            if (neverExpiresCheckbox.checked) {
                // å‹¾é€‰æ°¸ä¸è¿‡æœŸæ—¶ï¼Œç¦ç”¨æ—¥æœŸå’Œæ—¶é—´è¾“å…¥
                dateInput.disabled = true;
                timeInput.disabled = true;
                dateInput.style.opacity = '0.5';
                timeInput.style.opacity = '0.5';
                // æ¸…ç©ºæ—¥æœŸå’Œæ—¶é—´å€¼
                dateInput.value = '';
                timeInput.value = '';
            } else {
                // å–æ¶ˆå‹¾é€‰æ—¶ï¼Œæ¢å¤æ—¥æœŸå’Œæ—¶é—´è¾“å…¥
                dateInput.disabled = false;
                timeInput.disabled = false;
                dateInput.style.opacity = '1';
                timeInput.style.opacity = '1';
            }
        }

        // ä¿å­˜çºªå¿µæ—¥
        async function saveAnniversary(event) {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const name = document.getElementById('anniversary-name').value.trim();
            const date = document.getElementById('anniversary-date').value;
            const type = document.getElementById('anniversary-type').value;
            const customType = document.getElementById('anniversary-custom-type').value.trim();
            const characterId = document.getElementById('anniversary-character').value;
            const description = document.getElementById('anniversary-description').value.trim();
            const userQuote = document.getElementById('anniversary-user-quote').value.trim();
            const characterQuote = document.getElementById('anniversary-character-quote').value.trim();
            const yearly = document.getElementById('anniversary-yearly').checked;
            const isShared = document.getElementById('anniversary-shared').checked;
            const isPinned = document.getElementById('anniversary-pinned').checked;
            const countType = document.getElementById('anniversary-count-type').value;

            if (!name || !date) {
                showToast('è¯·å¡«å†™çºªå¿µæ—¥åç§°å’Œæ—¥æœŸ', 'error');
                return;
            }

            if (type === 'other' && !customType) {
                showToast('è¯·å¡«å†™è‡ªå®šä¹‰ç±»å‹', 'error');
                return;
            }

            // è·å–èƒŒæ™¯å›¾å’Œç”¨æˆ·å¤´åƒ
            const backgroundImg = document.getElementById('anniversary-background-img');
            const userAvatarImg = document.getElementById('anniversary-user-avatar-img');
            const backgroundImage = backgroundImg && backgroundImg.src && backgroundImg.src !== window.location.href ? backgroundImg.src : null;
            const userAvatar = userAvatarImg && userAvatarImg.src && userAvatarImg.src !== window.location.href ? userAvatarImg.src : null;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸¥æ ¼æ¸…ç†æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿æ²¡æœ‰äº‹ä»¶å¯¹è±¡æˆ–å…¶ä»–ä¸å¯åºåˆ—åŒ–çš„å†…å®¹
            const anniversaryData = {
                id: String(editingAnniversaryId || Date.now().toString()),
                name: String(name || ''),
                date: String(date || ''),
                type: String(type === 'other' ? 'other' : type || ''),
                customType: type === 'other' ? String(customType || '') : null,
                characterId: characterId ? String(characterId) : null,
                description: String(description || ''),
                userQuote: userQuote ? String(userQuote) : null,
                characterQuote: characterQuote ? String(characterQuote) : null,
                yearly: Boolean(yearly),
                isShared: Boolean(isShared),
                isPinned: Boolean(isPinned),
                backgroundImage: backgroundImage ? String(backgroundImage) : null,
                userAvatar: userAvatar ? String(userAvatar) : null,
                countType: String(countType || 'countdown'),
                createdBy: 'user',
                createdAt: editingAnniversaryId ?
                    (anniversaries.find(a => a.id === editingAnniversaryId)?.createdAt || new Date().toISOString()) :
                    new Date().toISOString()
            };

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœå½“å‰çºªå¿µæ—¥è¢«è®¾ç½®ä¸ºç½®é¡¶ï¼Œéœ€è¦å…ˆå–æ¶ˆå…¶ä»–çºªå¿µæ—¥çš„ç½®é¡¶çŠ¶æ€
                if (isPinned) {
                    // æ‰¾åˆ°æ‰€æœ‰å…¶ä»–ç½®é¡¶çš„çºªå¿µæ—¥å¹¶å–æ¶ˆç½®é¡¶
                    const otherPinnedAnniversaries = anniversaries.filter(a =>
                        a.isPinned && a.id !== anniversaryData.id
                    );

                    for (const otherAnniversary of otherPinnedAnniversaries) {
                        otherAnniversary.isPinned = false;
                        await db.anniversaries.put(otherAnniversary);
                    }

                    if (otherPinnedAnniversaries.length > 0) {
                        console.log(`å–æ¶ˆäº† ${otherPinnedAnniversaries.length} ä¸ªçºªå¿µæ—¥çš„ç½®é¡¶çŠ¶æ€`);
                    }
                }

                if (editingAnniversaryId) {
                    // æ›´æ–°ç°æœ‰çºªå¿µæ—¥
                    await db.anniversaries.put(anniversaryData);
                    const index = anniversaries.findIndex(a => a.id === editingAnniversaryId);
                    if (index !== -1) {
                        anniversaries[index] = anniversaryData;
                    }
                    showToast('çºªå¿µæ—¥å·²æ›´æ–°', 'success');

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•çºªå¿µæ—¥æ›´æ–°åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    if (anniversaryData.isShared && anniversaryData.characterId) {
                        try {
                            await recordCrossAppEvent(
                                anniversaryData.characterId,
                                'anniversary',
                                'update',
                                {
                                    id: anniversaryData.id,
                                    type: 'anniversary_update',
                                    content: `ç”¨æˆ·æ›´æ–°äº†çºªå¿µæ—¥"${anniversaryData.name}"ï¼ˆ${anniversaryData.date}ï¼‰${anniversaryData.description ? 'ï¼š' + anniversaryData.description : ''}`,
                                    anniversaryName: anniversaryData.name,
                                    anniversaryDate: anniversaryData.date,
                                    anniversaryType: anniversaryData.type,
                                    description: anniversaryData.description,
                                    countType: anniversaryData.countType
                                }
                            );
                            console.log('ğŸ“ [çºªå¿µæ—¥æ—¶é—´çº¿] å·²è®°å½•çºªå¿µæ—¥æ›´æ–°äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                        } catch (error) {
                            console.error('âŒ [çºªå¿µæ—¥æ—¶é—´çº¿] è®°å½•çºªå¿µæ—¥æ›´æ–°äº‹ä»¶å¤±è´¥:', error);
                        }
                    }
                } else {
                    // æ·»åŠ æ–°çºªå¿µæ—¥
                    await db.anniversaries.add(anniversaryData);
                    anniversaries.push(anniversaryData);
                    showToast('çºªå¿µæ—¥å·²æ·»åŠ ', 'success');

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•çºªå¿µæ—¥åˆ›å»ºåˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    if (anniversaryData.isShared && anniversaryData.characterId) {
                        try {
                            await recordCrossAppEvent(
                                anniversaryData.characterId,
                                'anniversary',
                                'create',
                                {
                                    id: anniversaryData.id,
                                    type: 'anniversary_create',
                                    content: `ç”¨æˆ·åˆ›å»ºäº†çºªå¿µæ—¥"${anniversaryData.name}"ï¼ˆ${anniversaryData.date}ï¼‰${anniversaryData.description ? 'ï¼š' + anniversaryData.description : ''}`,
                                    anniversaryName: anniversaryData.name,
                                    anniversaryDate: anniversaryData.date,
                                    anniversaryType: anniversaryData.type,
                                    description: anniversaryData.description,
                                    countType: anniversaryData.countType
                                },
                                anniversaryData.id
                            );
                            console.log('ğŸ“ [çºªå¿µæ—¥æ—¶é—´çº¿] å·²è®°å½•çºªå¿µæ—¥åˆ›å»ºäº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                        } catch (error) {
                            console.error('âŒ [çºªå¿µæ—¥æ—¶é—´çº¿] è®°å½•çºªå¿µæ—¥åˆ›å»ºäº‹ä»¶å¤±è´¥:', error);
                        }
                    }
                }

                closeAnniversaryForm();
                loadAnniversaryList();

                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ˜¯ç½®é¡¶çºªå¿µæ—¥ï¼Œç«‹å³æ›´æ–°å°ç»„ä»¶
                if (anniversaryData.isPinned) {
                    setTimeout(() => {
                        localStorage.setItem('anniversaryWidgetSelection', anniversaryData.id);
                        displayAnniversaryWidget(anniversaryData);
                    }, 100);
                }
            } catch (error) {
                console.error('ä¿å­˜çºªå¿µæ—¥å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åŠ è½½çºªå¿µæ—¥åˆ—è¡¨
        async function loadAnniversaryList() {
            try {
                // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
                if (!db || !db.anniversaries) {
                    console.warn('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè·³è¿‡çºªå¿µæ—¥åŠ è½½');
                    anniversaries = [];
                    renderAnniversaryList();
                    return;
                }

                anniversaries = await db.anniversaries.orderBy('date').toArray();
                renderAnniversaryList();
            } catch (error) {
                console.error('åŠ è½½çºªå¿µæ—¥åˆ—è¡¨å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…åˆå§‹åŒ–æ—¶çš„å¹²æ‰°
                anniversaries = [];
                renderAnniversaryList();
            }
        }

        // æ¸²æŸ“çºªå¿µæ—¥åˆ—è¡¨
        function renderAnniversaryList() {
            const container = document.getElementById('anniversary-list');
            const pinnedSection = document.getElementById('pinned-anniversary-section');
            const pinnedCard = document.getElementById('pinned-anniversary-card');

            // åˆ†ç¦»ç½®é¡¶å’Œæ™®é€šçºªå¿µæ—¥
            const pinnedAnniversaries = anniversaries.filter(a => a.isPinned);
            const regularAnniversaries = anniversaries.filter(a => !a.isPinned);

            // å¤„ç†ç½®é¡¶çºªå¿µæ—¥æ˜¾ç¤º
            if (pinnedAnniversaries.length > 0) {
                const pinnedAnniversary = pinnedAnniversaries[0]; // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªç½®é¡¶çš„
                renderPinnedAnniversary(pinnedAnniversary);
                pinnedSection.style.display = 'block';
            } else {
                pinnedSection.style.display = 'none';
            }

            // å¤„ç†æ™®é€šçºªå¿µæ—¥åˆ—è¡¨
            if (regularAnniversaries.length === 0 && pinnedAnniversaries.length === 0) {
                container.innerHTML = `
                    <div class="anniversary-empty-state">
                        <i class="fas fa-heart"></i>
                        <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥</p>
                        <p>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ é‡è¦çš„æ—¥å­</p>
                    </div>
                `;
                return;
            }

            const now = new Date();
            const currentYear = now.getFullYear();

            container.innerHTML = regularAnniversaries.map(anniversary => {
                const anniversaryDate = new Date(anniversary.date);
                const countType = anniversary.countType || 'countdown'; // é»˜è®¤ä¸ºå€’æ•°

                let countText = '';

                if (countType === 'countup') {
                    // æ­£æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼Œç¬¬äºŒå¤©æ˜¾ç¤º"å·²ç»1å¤©"ï¼‰
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const anniversaryDateOnly = new Date(anniversaryDate.getFullYear(), anniversaryDate.getMonth(), anniversaryDate.getDate());
                    const daysPassed = Math.floor((today - anniversaryDateOnly) / (1000 * 60 * 60 * 24));
                    countText = daysPassed === 0 ? 'ä»Šå¤©' :
                               `å·²ç» ${daysPassed} å¤©`;
                } else {
                    // å€’æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼‰
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    let nextDate = new Date(currentYear, anniversaryDate.getMonth(), anniversaryDate.getDate());

                    // å¦‚æœä»Šå¹´çš„æ—¥æœŸå·²è¿‡ï¼Œè®¡ç®—æ˜å¹´çš„æ—¥æœŸ
                    if (nextDate < today) {
                        nextDate.setFullYear(currentYear + 1);
                    }

                    const daysUntil = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                    countText = daysUntil === 0 ? 'ä»Šå¤©' :
                               daysUntil === 1 ? 'æ˜å¤©' :
                               `è¿˜æœ‰ ${daysUntil} å¤©`;
                }

                // è·å–ç›¸å…³è§’è‰²ä¿¡æ¯
                const character = anniversary.characterId ? characters.find(c => c.id === anniversary.characterId) : null;
                const characterInfo = character ? `
                    <div class="anniversary-character-info">
                        <div class="character-avatar">
                            <img src="${character.avatar || character.avatarUrl || createDefaultAvatar(character.name)}" alt="${character.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="character-avatar-fallback" style="display: none;">${character.name.charAt(0)}</div>
                        </div>
                        <span class="character-name">ä¸ ${character.name}</span>
                    </div>
                ` : '';

                const userQuote = anniversary.userQuote ? `
                    <div class="anniversary-user-quote">
                        <i class="fas fa-quote-left"></i>
                        <span>${escapeHtml(anniversary.userQuote)}</span>
                    </div>
                ` : '';

                const characterQuote = anniversary.characterQuote ? `
                    <div class="anniversary-character-quote">
                        <i class="fas fa-quote-left"></i>
                        <span>${escapeHtml(anniversary.characterQuote)}</span>
                    </div>
                ` : '';

                return `
                    <div class="anniversary-item ${anniversary.isShared ? 'shared' : ''}" onclick="toggleAnniversaryItem(event, '${anniversary.id}')" data-anniversary-id="${anniversary.id}">
                        <!-- ç®€æ´æ¡çŠ¶æ˜¾ç¤º -->
                        <div class="anniversary-item-compact">
                            <div class="anniversary-item-compact-left">
                                <div class="anniversary-item-compact-name">${escapeHtml(anniversary.name)}</div>
                            </div>
                            <div class="anniversary-item-compact-countdown">${countText}</div>
                        </div>

                        <!-- è¯¦ç»†ä¿¡æ¯ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                        <div class="anniversary-item-details">
                            <div class="anniversary-item-header">
                                <div>
                                    <div class="anniversary-item-name">${escapeHtml(anniversary.name)}</div>
                                    <div class="anniversary-item-date">${formatDate(anniversary.date)}</div>
                                    ${characterInfo}
                                </div>
                                <div class="anniversary-item-type ${anniversary.type}">${getTypeText(anniversary)}</div>
                            </div>
                            ${anniversary.description ? `<div class="anniversary-item-description">${escapeHtml(anniversary.description)}</div>` : ''}
                            ${userQuote}
                            ${characterQuote}
                            <div class="anniversary-item-actions" onclick="event.stopPropagation()">
                                <button class="anniversary-action-btn anniversary-edit-btn" onclick="showAnniversaryForm('${anniversary.id}')" title="ç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="anniversary-action-btn anniversary-delete-btn" onclick="deleteAnniversary('${anniversary.id}')" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ›´æ–°çºªå¿µæ—¥å°ç»„ä»¶ - æ™ºèƒ½é€‰æ‹©æ˜¾ç¤ºå†…å®¹
            const savedAnniversary = localStorage.getItem('anniversaryWidgetSelection');
            let anniversaryToShow = null;

            if (savedAnniversary) {
                anniversaryToShow = anniversaries.find(a => a.id === savedAnniversary);
            }

            // å¦‚æœä¿å­˜çš„çºªå¿µæ—¥ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç½®é¡¶çš„çºªå¿µæ—¥
            if (!anniversaryToShow && anniversaries.length > 0) {
                const pinnedAnniversary = anniversaries.find(a => a.isPinned);
                if (pinnedAnniversary) {
                    anniversaryToShow = pinnedAnniversary;
                    localStorage.setItem('anniversaryWidgetSelection', pinnedAnniversary.id);
                }
            }

            if (anniversaryToShow) {
                displayAnniversaryWidget(anniversaryToShow);
            } else if (anniversaries.length === 0) {
                // å¦‚æœæ²¡æœ‰ä»»ä½•çºªå¿µæ—¥ï¼Œæ¸…é™¤å°ç»„ä»¶
                clearAnniversaryWidget();
            }


        }



        // åˆ é™¤çºªå¿µæ—¥
        async function deleteAnniversary(anniversaryId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
                try {
                    await db.anniversaries.delete(anniversaryId);
                    anniversaries = anniversaries.filter(a => a.id !== anniversaryId);
                    renderAnniversaryList();

                    // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤ååˆ·æ–°å°ç»„ä»¶
                    setTimeout(() => {
                        refreshAnniversaryWidget();
                    }, 100);

                    showToast('çºªå¿µæ—¥å·²åˆ é™¤', 'success');
                } catch (error) {
                    console.error('åˆ é™¤çºªå¿µæ—¥å¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å–æ¶ˆçºªå¿µæ—¥ç½®é¡¶
        async function unpinAnniversary(anniversaryId) {
            try {
                const anniversary = anniversaries.find(a => a.id === anniversaryId);
                if (anniversary) {
                    anniversary.isPinned = false;
                    await db.anniversaries.put(anniversary);
                    renderAnniversaryList();
                    showToast('å·²å–æ¶ˆç½®é¡¶ï¼Œç°åœ¨å¯ä»¥åˆ é™¤äº†', 'success');
                }
            } catch (error) {
                console.error('å–æ¶ˆç½®é¡¶å¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åˆ‡æ¢çºªå¿µæ—¥æ¡ç›®çš„å±•å¼€/æ”¶ç¼©çŠ¶æ€
        function toggleAnniversaryItem(event, anniversaryId) {
            event.stopPropagation();
            const item = event.currentTarget;
            const isExpanded = item.classList.contains('expanded');

            // æ”¶ç¼©æ‰€æœ‰å…¶ä»–æ¡ç›®
            document.querySelectorAll('.anniversary-item.expanded').forEach(otherItem => {
                if (otherItem !== item) {
                    otherItem.classList.remove('expanded');
                }
            });

            // åˆ‡æ¢å½“å‰æ¡ç›®çŠ¶æ€
            if (isExpanded) {
                item.classList.remove('expanded');
            } else {
                item.classList.add('expanded');
            }
        }

        // åŠ è½½çº¦å®šåˆ—è¡¨
        async function loadAppointmentList() {
            try {
                // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
                if (!db || !db.appointments) {
                    console.warn('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè·³è¿‡çº¦å®šåŠ è½½');
                    appointments = [];
                    renderAppointmentList();
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ä½¿ç”¨orderBy('date')ï¼Œå› ä¸ºæ°¸ä¸è¿‡æœŸçš„çº¦å®šdateä¸ºnull
                appointments = await db.appointments.toArray();
                console.log('âœ… çº¦å®šåˆ—è¡¨å·²ä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼Œæ•°é‡:', appointments.length);
                console.log('ğŸ“‹ çº¦å®šè¯¦æƒ…:', appointments);
                renderAppointmentList();
            } catch (error) {
                console.error('åŠ è½½çº¦å®šåˆ—è¡¨å¤±è´¥:', error);
                appointments = [];
                renderAppointmentList();
            }
        }

        // æ¸²æŸ“çº¦å®šåˆ—è¡¨
        function renderAppointmentList() {
            const container = document.getElementById('appointment-list');

            if (appointments.length === 0) {
                container.innerHTML = `
                    <div class="appointment-empty-state">
                        <i class="fas fa-calendar-check"></i>
                        <p>è¿˜æ²¡æœ‰çº¦å®š</p>
                        <p>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ æ–°çº¦å®š</p>
                    </div>
                `;
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç½®é¡¶çº¦å®š
            const pinnedAppointments = appointments.filter(a => a.isPinned);
            const regularAppointments = appointments.filter(a => !a.isPinned);

            // æ¸²æŸ“ç½®é¡¶çº¦å®š
            if (pinnedAppointments.length > 0) {
                const pinnedAppointment = pinnedAppointments[0]; // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªç½®é¡¶çº¦å®š
                renderPinnedAppointment(pinnedAppointment);
                document.getElementById('pinned-appointment-section').style.display = 'block';
            } else {
                document.getElementById('pinned-appointment-section').style.display = 'none';
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘æŒ‰æ—¥æœŸå’Œå®ŒæˆçŠ¶æ€æ’åºï¼Œå¤„ç†æ°¸ä¸è¿‡æœŸçš„çº¦å®š
            const sortedAppointments = [...regularAppointments].sort((a, b) => {
                // æœªå®Œæˆçš„æ’åœ¨å‰é¢
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ°¸ä¸è¿‡æœŸçš„çº¦å®šæ’åœ¨æœ€å
                if (a.neverExpires !== b.neverExpires) {
                    return a.neverExpires ? 1 : -1;
                }

                // å¦‚æœéƒ½ä¸æ˜¯æ°¸ä¸è¿‡æœŸï¼ŒæŒ‰æ—¥æœŸæ’åº
                if (!a.neverExpires && !b.neverExpires) {
                    return new Date(a.date + ' ' + (a.time || '00:00')) - new Date(b.date + ' ' + (b.time || '00:00'));
                }

                // å¦‚æœéƒ½æ˜¯æ°¸ä¸è¿‡æœŸï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
                return (a.timestamp || 0) - (b.timestamp || 0);
            });

            container.innerHTML = sortedAppointments.map(appointment => {
                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ°¸ä¸è¿‡æœŸçš„çº¦å®š
                let status = 'pending';
                let countdownText = '';
                let isOverdue = false;

                if (appointment.neverExpires) {
                    // æ°¸ä¸è¿‡æœŸçš„çº¦å®š
                    status = appointment.completed ? 'completed' : 'never-expires';
                    countdownText = appointment.completed ? 'å·²å®Œæˆ' : 'æ°¸ä¸è¿‡æœŸ';
                } else {
                    // æœ‰æ—¥æœŸçš„çº¦å®š
                    const appointmentDate = new Date(appointment.date + ' ' + (appointment.time || '00:00'));
                    const now = new Date();
                    isOverdue = appointmentDate < now && !appointment.completed;

                    if (appointment.completed) {
                        status = 'completed';
                        countdownText = 'å·²å®Œæˆ';
                    } else if (isOverdue) {
                        status = 'overdue';
                        const daysPassed = Math.floor((now - appointmentDate) / (1000 * 60 * 60 * 24));
                        countdownText = `å·²è¿‡æœŸ ${daysPassed} å¤©`;
                    } else {
                        const timeDiff = appointmentDate - now;
                        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                        if (daysLeft === 0) {
                            countdownText = 'ä»Šå¤©';
                        } else if (daysLeft === 1) {
                            countdownText = 'æ˜å¤©';
                        } else {
                            countdownText = `è¿˜æœ‰ ${daysLeft} å¤©`;
                        }
                    }
                }

                // è·å–ç›¸å…³è§’è‰²ä¿¡æ¯
                const character = appointment.characterId ? characters.find(c => c.id === appointment.characterId) : null;

                // æ„å»ºç”¨æˆ·è¯­å½•
                const userQuote = appointment.userQuote ? `
                    <div class="appointment-user-quote">
                        <i class="fas fa-quote-left"></i>
                        <span>${escapeHtml(appointment.userQuote)}</span>
                    </div>
                ` : '';

                return `
                    <div class="appointment-item ${appointment.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} ${appointment.isShared ? 'shared' : ''}" onclick="toggleAppointmentExpansion('${appointment.id}')">
                        <div class="appointment-item-compact">
                            <div class="appointment-item-left">
                                <div class="appointment-item-name">${escapeHtml(appointment.name)}</div>
                            </div>
                            <div class="appointment-item-right">
                                <div class="appointment-countdown ${status}">${countdownText}</div>
                            </div>
                        </div>
                        <div class="appointment-item-details">
                            <div class="appointment-detail-header">
                                <div class="appointment-detail-left">
                                    <div class="appointment-detail-name">${escapeHtml(appointment.name)}</div>
                                    <div class="appointment-detail-time">${appointment.neverExpires ? 'é•¿æœŸçº¦å®š' : formatAppointmentDate(appointment.date, appointment.time)}</div>
                                </div>
                                <div class="appointment-detail-right">
                                    <span class="appointment-type-tag">${getAppointmentTypeText(appointment)}</span>
                                    <button class="appointment-edit-btn" onclick="event.stopPropagation(); showAppointmentForm('${appointment.id}')" title="ç¼–è¾‘çº¦å®š">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                            ${appointment.description ? `<p><strong>æè¿°ï¼š</strong>${escapeHtml(appointment.description)}</p>` : ''}
                            ${character ? `<p><strong>ç›¸å…³è§’è‰²ï¼š</strong>${character.name}</p>` : ''}
                            ${appointment.characterQuote ? `
                                <div class="appointment-character-quote">
                                    <i class="fas fa-quote-left"></i>
                                    <span>${escapeHtml(appointment.characterQuote)}</span>
                                </div>
                            ` : ''}
                            <div class="appointment-item-actions">
                                ${!appointment.completed ?
                                    `<button class="appointment-action-btn appointment-complete-btn" onclick="toggleAppointmentComplete('${appointment.id}')">å®Œæˆ</button>` :
                                    `<button class="appointment-action-btn appointment-complete-btn completed" disabled>å·²å®Œæˆ</button>`
                                }
                                <button class="appointment-action-btn appointment-delete-btn" onclick="deleteAppointment('${appointment.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch (status) {
                case 'completed': return 'å·²å®Œæˆ';
                case 'overdue': return 'å·²è¿‡æœŸ';
                case 'pending': return 'å¾…å®Œæˆ';
                default: return 'å¾…å®Œæˆ';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢çº¦å®šå±•å¼€çŠ¶æ€
        function toggleAppointmentExpansion(appointmentId) {
            const item = document.querySelector(`.appointment-item[onclick*="${appointmentId}"]`);
            if (item) {
                item.classList.toggle('expanded');
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸²æŸ“ç½®é¡¶çº¦å®š - å®Œå…¨ç…§æ¬çºªå¿µæ—¥çš„ç»“æ„
        function renderPinnedAppointment(appointment) {
            const pinnedCard = document.getElementById('pinned-appointment-card');
            const now = new Date();
            const currentYear = now.getFullYear();
            const countType = appointment.countType || 'countdown'; // é»˜è®¤ä¸ºå€’æ•°

            let countdownText = '';
            let countdownLabel = '';

            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ°¸ä¸è¿‡æœŸçš„çº¦å®š
            if (appointment.neverExpires) {
                countdownText = 'âˆ';
                countdownLabel = '';
            } else {
                const appointmentDate = new Date(appointment.date + ' ' + (appointment.time || '00:00'));

                if (countType === 'countup') {
                    // æ­£æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼Œç¬¬äºŒå¤©æ˜¾ç¤º1å¤©ï¼‰
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const appointmentDateOnly = new Date(appointmentDate.getFullYear(), appointmentDate.getMonth(), appointmentDate.getDate());
                    const daysPassed = Math.floor((today - appointmentDateOnly) / (1000 * 60 * 60 * 24));
                    countdownText = daysPassed === 0 ? 'ä»Šå¤©' :
                                   `${daysPassed}`;
                    countdownLabel = daysPassed === 0 ? '' : 'å¤©';
                } else {
                    // å€’æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼‰
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const appointmentDateOnly = new Date(appointmentDate.getFullYear(), appointmentDate.getMonth(), appointmentDate.getDate());
                    const daysUntil = Math.floor((appointmentDateOnly - today) / (1000 * 60 * 60 * 24));
                    countdownText = daysUntil === 0 ? 'ä»Šå¤©' :
                                   daysUntil === 1 ? 'æ˜å¤©' :
                                   daysUntil < 0 ? `${Math.abs(daysUntil)}` :
                                   `${daysUntil}`;
                    countdownLabel = daysUntil === 0 ? '' :
                                    daysUntil === 1 ? '' :
                                    daysUntil < 0 ? 'å¤©å‰' :
                                    'å¤©';
                }
            }

            // è·å–ç›¸å…³è§’è‰²ä¿¡æ¯
            const character = appointment.characterId ? characters.find(c => c.id === appointment.characterId) : null;

            // æ„å»ºèƒŒæ™¯å›¾æ ·å¼
            const backgroundStyle = appointment.backgroundImage ?
                `<div class="pinned-card-background" style="background-image: url('${appointment.backgroundImage}')"></div>` : '';

            // æ„å»ºå¤´åƒåŒºåŸŸ
            let avatarsHtml = '';
            if (appointment.userAvatar || character) {
                avatarsHtml = '<div class="pinned-card-avatars">';

                // è§’è‰²å¤´åƒï¼ˆç°åœ¨åœ¨å·¦è¾¹ï¼‰
                if (character) {
                    avatarsHtml += `
                        <div class="pinned-card-avatar">
                            <img src="${character.avatar || character.avatarUrl || createDefaultAvatar(character.name)}" alt="${character.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="pinned-card-avatar-fallback" style="display: none;">${character.name.charAt(0)}</div>
                        </div>
                    `;
                }

                // ç”¨æˆ·å¤´åƒï¼ˆç°åœ¨åœ¨å³è¾¹ï¼‰
                if (appointment.userAvatar) {
                    avatarsHtml += `
                        <div class="pinned-card-avatar">
                            <img src="${appointment.userAvatar}" alt="ä½ " onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="pinned-card-avatar-fallback" style="display: none;">ä½ </div>
                        </div>
                    `;
                }

                avatarsHtml += '</div>';
            }

            // æ„å»ºç±»å‹æ ‡ç­¾
            const typeClass = appointment.type || 'other';
            const typeText = getAppointmentTypeText(appointment);

            // æ„å»ºä¼˜å…ˆçº§æ ‡ç­¾
            const priorityText = getPriorityText(appointment.priority);
            const priorityClass = appointment.priority || 'medium';

            // æ„å»ºç”¨æˆ·è¯­å½•
            const userQuoteHtml = appointment.userQuote ? `
                <div class="pinned-card-user-quote">
                    <i class="fas fa-quote-left"></i>
                    <span class="quote-author">ä½ ï¼š</span>${escapeHtml(appointment.userQuote)}
                </div>
            ` : '';

            // æ„å»ºè§’è‰²è¯­å½•
            const characterQuoteHtml = appointment.characterQuote ? `
                <div class="pinned-card-quote">
                    <i class="fas fa-quote-left"></i>
                    <span class="quote-author">${character ? character.name : 'è§’è‰²'}ï¼š</span>${escapeHtml(appointment.characterQuote)}
                </div>
            ` : '';

            pinnedCard.innerHTML = `
                ${backgroundStyle}
                <div class="pinned-card-content">
                    <div class="pinned-card-header">
                        ${avatarsHtml}
                        <div class="pinned-card-type ${typeClass}">${typeText}</div>
                    </div>
                    <div class="pinned-card-main">
                        <div class="pinned-card-title">${escapeHtml(appointment.name)}</div>
                        <div class="pinned-card-countdown">${countdownText}</div>
                        <div class="pinned-card-countdown-label">${countdownLabel}</div>
                        <div class="pinned-card-date">${appointment.neverExpires ? 'é•¿æœŸçº¦å®š' : (countType === 'countup' ? 'èµ·å§‹æ—¥' : 'ç›®æ ‡æ—¥') + ' ' + formatAppointmentDate(appointment.date, appointment.time)}</div>
                    </div>
                    <div class="pinned-card-footer">
                        ${userQuoteHtml}
                        ${characterQuoteHtml}
                        <div class="pinned-card-actions">
                            <button class="pinned-card-unpin-btn" onclick="event.stopPropagation(); unpinAppointment('${appointment.id}')" title="å–æ¶ˆç½®é¡¶">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="pinned-card-priority-badge ${priorityClass}">${priorityText}</div>
            `;

            // æ·»åŠ dataå±æ€§ç”¨äºé•¿æŒ‰åˆ é™¤
            pinnedCard.dataset.appointmentId = appointment.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            pinnedCard.onclick = function(e) {
                if (!e.target.closest('.pinned-card-actions')) {
                    showAppointmentForm(appointment.id);
                }
            };
        }

        // åˆ‡æ¢çº¦å®šå®ŒæˆçŠ¶æ€
        async function toggleAppointmentComplete(appointmentId) {
            try {
                const appointment = appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    appointment.completed = !appointment.completed;
                    await db.appointments.put(appointment);
                    renderAppointmentList();
                    showToast(appointment.completed ? 'çº¦å®šå·²å®Œæˆ' : 'çº¦å®šå·²æ ‡è®°ä¸ºæœªå®Œæˆ', 'success');
                }
            } catch (error) {
                console.error('æ›´æ–°çº¦å®šçŠ¶æ€å¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åˆ é™¤çº¦å®š
        async function deleteAppointment(appointmentId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ')) {
                try {
                    await db.appointments.delete(appointmentId);
                    appointments = appointments.filter(a => a.id !== appointmentId);
                    renderAppointmentList();
                    showToast('çº¦å®šå·²åˆ é™¤', 'success');
                } catch (error) {
                    console.error('åˆ é™¤çº¦å®šå¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å–æ¶ˆçº¦å®šç½®é¡¶
        async function unpinAppointment(appointmentId) {
            try {
                const appointment = appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    appointment.isPinned = false;
                    await db.appointments.put(appointment);
                    renderAppointmentList();
                    showToast('å·²å–æ¶ˆç½®é¡¶ï¼Œç°åœ¨å¯ä»¥åˆ é™¤äº†', 'success');
                }
            } catch (error) {
                console.error('å–æ¶ˆç½®é¡¶å¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ ¼å¼åŒ–çº¦å®šæ—¥æœŸæ—¶é—´
        function formatAppointmentDate(dateString, timeString) {
            const date = new Date(dateString);
            let result = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

            if (timeString) {
                const [hours, minutes] = timeString.split(':');
                result += ` ${hours}:${minutes}`;
            }

            return result;
        }

        // è·å–ä¼˜å…ˆçº§æ–‡æœ¬
        function getPriorityText(priority) {
            const priorityMap = {
                low: 'ä½',
                medium: 'ä¸­',
                high: 'é«˜',
                urgent: 'ç´§æ€¥'
            };
            return priorityMap[priority] || 'ä¸­';
        }

        // è·å–çº¦å®šç±»å‹æ–‡æœ¬
        function getAppointmentTypeText(appointment) {
            if (appointment.customType) {
                return appointment.customType;
            }

            const typeMap = {
                date: 'çº¦ä¼š',
                promise: 'æ‰¿è¯º',
                activity: 'æ´»åŠ¨',
                meeting: 'è§é¢',
                task: 'ä»»åŠ¡',
                other: 'å…¶ä»–'
            };
            return typeMap[appointment.type] || 'å…¶ä»–';
        }

        // è§’è‰²ä¸»åŠ¨åˆ›å»ºçºªå¿µæ—¥
        async function createAnniversaryByCharacter(characterId, anniversaryData) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) {
                    console.error('è§’è‰²ä¸å­˜åœ¨:', characterId);
                    return false;
                }

                // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è§’è‰²äººè®¾ç”Ÿæˆæ›´ä¸ªæ€§åŒ–çš„è¯­å½•
                let characterQuote = anniversaryData.characterQuote;
                if (!characterQuote) {
                    characterQuote = generatePersonalizedQuote(character, 'anniversary', anniversaryData);
                }

                const newAnniversary = {
                    id: `anniversary_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: anniversaryData.name,
                    date: anniversaryData.date,
                    type: anniversaryData.type || 'other',
                    characterId: characterId,
                    description: anniversaryData.description || '',
                    characterQuote: characterQuote,
                    yearly: anniversaryData.yearly !== false,
                    isShared: true, // è§’è‰²åˆ›å»ºçš„é»˜è®¤å…±äº«
                    createdBy: 'character',
                    timestamp: Date.now()
                };

                await db.anniversaries.add(newAnniversary);
                anniversaries.push(newAnniversary);

                // å¦‚æœå½“å‰åœ¨çºªå¿µæ—¥ç•Œé¢ï¼Œåˆ·æ–°åˆ—è¡¨
                if (document.getElementById('anniversary-screen').style.display !== 'none') {
                    renderAnniversaryList();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç³»ç»Ÿæ¨é€é€šçŸ¥è€Œä¸æ˜¯toast
                createAnniversaryNotification(character, newAnniversary, 'created');

                console.log(`âœ… ${character.name} åˆ›å»ºäº†ä¸€ä¸ªçºªå¿µæ—¥ï¼š${anniversaryData.name}`);
                return true;
            } catch (error) {
                console.error('è§’è‰²åˆ›å»ºçºªå¿µæ—¥å¤±è´¥:', error);
                return false;
            }
        }

        // è§’è‰²ä¸»åŠ¨åˆ›å»ºçº¦å®š
        async function createAppointmentByCharacter(characterId, appointmentData) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) {
                    console.error('è§’è‰²ä¸å­˜åœ¨:', characterId);
                    return false;
                }

                // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è§’è‰²äººè®¾ç”Ÿæˆæ›´ä¸ªæ€§åŒ–çš„è¯­å½•
                let characterQuote = appointmentData.characterQuote;
                if (!characterQuote) {
                    characterQuote = generatePersonalizedQuote(character, 'appointment', appointmentData);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ°¸ä¸è¿‡æœŸé€‰é¡¹
                const neverExpires = appointmentData.neverExpires === true;

                const newAppointment = {
                    id: `appointment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: appointmentData.name,
                    date: neverExpires ? null : appointmentData.date,
                    time: neverExpires ? null : (appointmentData.time || ''),
                    type: appointmentData.type || 'other',
                    characterId: characterId,
                    description: appointmentData.description || '',
                    characterQuote: characterQuote,
                    priority: appointmentData.priority || 'medium',
                    completed: false,
                    isShared: true, // è§’è‰²åˆ›å»ºçš„é»˜è®¤å…±äº«
                    createdBy: 'character',
                    neverExpires: neverExpires,
                    timestamp: Date.now()
                };

                await db.appointments.add(newAppointment);
                appointments.push(newAppointment);

                // å¦‚æœå½“å‰åœ¨çºªå¿µæ—¥ç•Œé¢ï¼Œåˆ·æ–°åˆ—è¡¨
                if (document.getElementById('anniversary-screen').style.display !== 'none') {
                    renderAppointmentList();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç³»ç»Ÿæ¨é€é€šçŸ¥è€Œä¸æ˜¯toast
                createAppointmentNotification(character, newAppointment, 'created');

                console.log(`âœ… ${character.name} åˆ›å»ºäº†ä¸€ä¸ªçº¦å®šï¼š${appointmentData.name}`);
                return true;
            } catch (error) {
                console.error('è§’è‰²åˆ›å»ºçº¦å®šå¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è§’è‰²äººè®¾ç”Ÿæˆä¸ªæ€§åŒ–è¯­å½•
        function generatePersonalizedQuote(character, type, data) {
            const characterName = character.name;

            // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®è§’è‰²æ€§æ ¼ç‰¹å¾è°ƒæ•´è¯­å½•é£æ ¼
            const personality = character.personality || '';
            const isGentle = personality.includes('æ¸©æŸ”') || personality.includes('æ¸©å’Œ') || personality.includes('å–„è‰¯');
            const isPlayful = personality.includes('æ´»æ³¼') || personality.includes('å¼€æœ—') || personality.includes('è°ƒçš®');
            const isCool = personality.includes('å†·é…·') || personality.includes('é«˜å†·') || personality.includes('å‚²å¨‡');
            const isSerious = personality.includes('ä¸¥è‚ƒ') || personality.includes('è®¤çœŸ') || personality.includes('æ­£ç»');

            // åŸºç¡€æ¨¡æ¿
            const templates = {
                anniversary: {
                    birthday: [
                        // æ¸©æŸ”å‹
                        ...(isGentle ? [
                            `${characterName}ï¼š"ç”Ÿæ—¥å¿«ä¹ï½è¿™ä¸€å¤©å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆç‰¹åˆ«å‘¢ã€‚"`,
                            `${characterName}ï¼š"åˆæ˜¯ä¸€å¹´ç”Ÿæ—¥ï¼Œå¸Œæœ›ä½ æ¯å¤©éƒ½å¼€å¿ƒã€‚"`,
                            `${characterName}ï¼š"ç”Ÿæ—¥æ˜¯å€¼å¾—åº†ç¥çš„æ—¥å­ï¼Œæˆ‘ä¼šå¥½å¥½è®°ä½çš„ã€‚"`
                        ] : []),
                        // æ´»æ³¼å‹
                        ...(isPlayful ? [
                            `${characterName}ï¼š"ç”Ÿæ—¥å¿«ä¹ï¼ï¼ï¼è¦å¼€å¿ƒåœ°åº†ç¥å“¦ï½"`,
                            `${characterName}ï¼š"å“‡ï¼åˆæ˜¯ç”Ÿæ—¥äº†ï¼Œæ—¶é—´è¿‡å¾—å¥½å¿«å‘€ï¼"`,
                            `${characterName}ï¼š"ç”Ÿæ—¥è€¶ï¼æˆ‘ä»¬ä¸€å®šè¦å¥½å¥½åº†ç¥ï¼"`
                        ] : []),
                        // å†·é…·å‹
                        ...(isCool ? [
                            `${characterName}ï¼š"ç”Ÿæ—¥...ç®—æ˜¯ä¸ªå€¼å¾—è®°ä½çš„æ—¥å­å§ã€‚"`,
                            `${characterName}ï¼š"åˆé•¿å¤§ä¸€å²äº†å‘¢ã€‚"`,
                            `${characterName}ï¼š"ç”Ÿæ—¥å¿«ä¹ã€‚è¿™ä¸ªæ—¥å­æˆ‘ä¼šè®°ä½çš„ã€‚"`
                        ] : []),
                        // ä¸¥è‚ƒå‹
                        ...(isSerious ? [
                            `${characterName}ï¼š"ç”Ÿæ—¥å¿«ä¹ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„çºªå¿µæ—¥ã€‚"`,
                            `${characterName}ï¼š"åˆæ˜¯ä¸€å¹´ç”Ÿæ—¥ï¼Œæ—¶é—´çš„æµé€è®©äººæ·±æ€ã€‚"`,
                            `${characterName}ï¼š"ç”Ÿæ—¥æ˜¯äººç”Ÿçš„é‡è¦èŠ‚ç‚¹ï¼Œå€¼å¾—é“­è®°ã€‚"`
                        ] : []),
                        // é€šç”¨
                        `${characterName}ï¼š"ç”Ÿæ—¥å¿«ä¹ï¼è¿™ä¸€å¤©å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆç‰¹åˆ«å‘¢ã€‚"`,
                        `${characterName}ï¼š"åˆæ˜¯ä¸€å¹´ç”Ÿæ—¥ï¼Œæ—¶é—´è¿‡å¾—çœŸå¿«å•Šã€‚"`,
                        `${characterName}ï¼š"ç”Ÿæ—¥æ˜¯å€¼å¾—åº†ç¥çš„æ—¥å­ï¼Œæˆ‘ä¼šè®°ä½çš„ã€‚"`
                    ],
                    relationship: [
                        ...(isGentle ? [
                            `${characterName}ï¼š"ä»é‚£å¤©å¼€å§‹ï¼Œæˆ‘ä»¬çš„å…³ç³»å°±å˜å¾—æ›´åŠ çè´µäº†ã€‚"`,
                            `${characterName}ï¼š"é‚£æ˜¯æˆ‘ä»¬ä¹‹é—´æ¸©æš–çš„è½¬æŠ˜ç‚¹ã€‚"`
                        ] : []),
                        ...(isPlayful ? [
                            `${characterName}ï¼š"ä»é‚£å¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°±æ˜¯ç‰¹åˆ«çš„å…³ç³»å•¦ï¼"`,
                            `${characterName}ï¼š"é‚£ä¸€åˆ»è¶…çº§é‡è¦çš„ï¼æˆ‘æ°¸è¿œä¸ä¼šå¿˜è®°ï¼"`
                        ] : []),
                        ...(isCool ? [
                            `${characterName}ï¼š"ä»é‚£å¤©å¼€å§‹...ç®—æ˜¯ä¸ä¸€æ ·äº†å§ã€‚"`,
                            `${characterName}ï¼š"é‚£ä¸ªè½¬æŠ˜ç‚¹ï¼Œæˆ‘è®°å¾—ã€‚"`
                        ] : []),
                        `${characterName}ï¼š"ä»é‚£å¤©å¼€å§‹ï¼Œæˆ‘ä»¬çš„å…³ç³»å°±ä¸ä¸€æ ·äº†ã€‚"`,
                        `${characterName}ï¼š"è¿™æ˜¯æˆ‘ä»¬ä¹‹é—´é‡è¦çš„è½¬æŠ˜ç‚¹ã€‚"`
                    ],
                    anniversary: [
                        `${characterName}ï¼š"è¿™ä¸ªæ—¥å­å¯¹æˆ‘ä»¬æ¥è¯´æ„ä¹‰éå‡¡ã€‚"`,
                        `${characterName}ï¼š"æ¯å¹´çš„è¿™ä¸€å¤©ï¼Œæˆ‘éƒ½ä¼šæƒ³èµ·å½“æ—¶çš„æƒ…æ™¯ã€‚"`,
                        `${characterName}ï¼š"è¿™æ˜¯å€¼å¾—çºªå¿µçš„ç¾å¥½æ—¶å…‰ã€‚"`
                    ],
                    other: [
                        `${characterName}ï¼š"è¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æ—¥å­ã€‚"`,
                        `${characterName}ï¼š"æˆ‘æƒ³æŠŠè¿™ä¸ªæ—¥å­è®°å½•ä¸‹æ¥ã€‚"`,
                        `${characterName}ï¼š"è¿™ä¸€å¤©å€¼å¾—æˆ‘ä»¬é“­è®°ã€‚"`
                    ]
                },
                appointment: {
                    date: [
                        ...(isGentle ? [
                            `${characterName}ï¼š"æˆ‘ä»¬çº¦å¥½äº†ï¼Œæˆ‘ä¼šå‡†æ—¶çš„ã€‚"`,
                            `${characterName}ï¼š"æœŸå¾…å’Œä½ ä¸€èµ·åº¦è¿‡è¿™ä¸ªç¾å¥½æ—¶å…‰ã€‚"`
                        ] : []),
                        ...(isPlayful ? [
                            `${characterName}ï¼š"çº¦ä¼šçº¦ä¼šï¼ä¸è§ä¸æ•£å“¦ï½"`,
                            `${characterName}ï¼š"æˆ‘å·²ç»è¶…çº§æœŸå¾…äº†ï¼"`
                        ] : []),
                        ...(isCool ? [
                            `${characterName}ï¼š"çº¦å®šå°±æ˜¯çº¦å®šï¼Œæˆ‘ä¼šå»çš„ã€‚"`,
                            `${characterName}ï¼š"è¿™ä¸ªæ—¶é—´ï¼Œæˆ‘è®°ä½äº†ã€‚"`
                        ] : []),
                        `${characterName}ï¼š"æˆ‘ä»¬çº¦å¥½äº†ï¼Œä¸è§ä¸æ•£ã€‚"`,
                        `${characterName}ï¼š"æœŸå¾…å’Œä½ ä¸€èµ·åº¦è¿‡è¿™ä¸ªæ—¶å…‰ã€‚"`
                    ],
                    promise: [
                        ...(isSerious ? [
                            `${characterName}ï¼š"æˆ‘ä¼šä¸¥æ ¼éµå®ˆè¿™ä¸ªæ‰¿è¯ºã€‚"`,
                            `${characterName}ï¼š"æ‰¿è¯ºçš„åˆ†é‡ï¼Œæˆ‘æ·±çŸ¥å…¶é‡ã€‚"`
                        ] : []),
                        `${characterName}ï¼š"æˆ‘ä¼šéµå®ˆè¿™ä¸ªæ‰¿è¯ºçš„ã€‚"`,
                        `${characterName}ï¼š"è¯´åˆ°åšåˆ°ï¼Œè¿™æ˜¯æˆ‘çš„åŸåˆ™ã€‚"`
                    ],
                    activity: [
                        `${characterName}ï¼š"ä¸€èµ·åšè¿™ä»¶äº‹ä¸€å®šå¾ˆæœ‰è¶£ã€‚"`,
                        `${characterName}ï¼š"æˆ‘å·²ç»å¼€å§‹æœŸå¾…äº†ã€‚"`
                    ],
                    other: [
                        `${characterName}ï¼š"æˆ‘ä»¬çº¦å®šå¥½äº†ã€‚"`,
                        `${characterName}ï¼š"è¿™ä¸ªçº¦å®šæˆ‘ä¼šè®°åœ¨å¿ƒé‡Œã€‚"`
                    ]
                }
            };

            // æ ¹æ®ç±»å‹å’Œå­ç±»å‹é€‰æ‹©æ¨¡æ¿
            const typeTemplates = templates[type] || {};
            const subTypeTemplates = typeTemplates[data.type] || typeTemplates.other || [];

            if (subTypeTemplates.length === 0) {
                return type === 'anniversary' ?
                    `${characterName}ï¼š"è¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æ—¥å­ã€‚"` :
                    `${characterName}ï¼š"æˆ‘ä»¬çº¦å®šå¥½äº†ã€‚"`;
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
            return subTypeTemplates[Math.floor(Math.random() * subTypeTemplates.length)];
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çºªå¿µæ—¥ç³»ç»Ÿé€šçŸ¥
        function createAnniversaryNotification(character, anniversary, action) {
            let notificationText = '';
            let notificationIcon = '';

            if (action === 'created') {
                notificationIcon = 'ğŸ‰';
                switch (anniversary.type) {
                    case 'birthday':
                        notificationText = `${notificationIcon} ${character.name} è®°å½•äº†ç”Ÿæ—¥ï¼š${anniversary.name}`;
                        break;
                    case 'relationship':
                        notificationText = `${notificationIcon} ${character.name} åˆ›å»ºäº†å…³ç³»çºªå¿µæ—¥ï¼š${anniversary.name}`;
                        break;
                    case 'anniversary':
                        notificationText = `${notificationIcon} ${character.name} åˆ›å»ºäº†çºªå¿µæ—¥ï¼š${anniversary.name}`;
                        break;
                    default:
                        notificationText = `${notificationIcon} ${character.name} åˆ›å»ºäº†ç‰¹åˆ«çš„æ—¥å­ï¼š${anniversary.name}`;
                }
            } else if (action === 'reminder') {
                notificationIcon = 'ğŸ“…';
                const today = new Date();
                const anniversaryDate = new Date(anniversary.date);
                const isToday = anniversaryDate.toDateString() === today.toDateString();

                if (isToday) {
                    notificationText = `${notificationIcon} ä»Šå¤©æ˜¯${anniversary.name}ï¼${character.name}æƒ³å’Œä½ ä¸€èµ·çºªå¿µ`;
                } else {
                    notificationText = `${notificationIcon} ${character.name}æé†’ï¼šæ˜å¤©æ˜¯${anniversary.name}`;
                }
            }

            // ä½¿ç”¨ç°æœ‰çš„æ¨é€é€šçŸ¥ç³»ç»Ÿï¼Œå¢åŠ ä¼˜å…ˆçº§
            createPushNotification(character, notificationText, 150);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çº¦å®šç³»ç»Ÿé€šçŸ¥
        function createAppointmentNotification(character, appointment, action) {
            let notificationText = '';
            let notificationIcon = '';

            if (action === 'created') {
                notificationIcon = 'ğŸ“';
                switch (appointment.type) {
                    case 'date':
                        notificationText = `${notificationIcon} ${character.name} å’Œä½ çº¦å®šäº†çº¦ä¼šï¼š${appointment.name}`;
                        break;
                    case 'promise':
                        notificationText = `${notificationIcon} ${character.name} å’Œä½ è®¸ä¸‹æ‰¿è¯ºï¼š${appointment.name}`;
                        break;
                    case 'meeting':
                        notificationText = `${notificationIcon} ${character.name} çº¦å®šå’Œä½ è§é¢ï¼š${appointment.name}`;
                        break;
                    case 'activity':
                        notificationText = `${notificationIcon} ${character.name} çº¦å®šäº†æ´»åŠ¨ï¼š${appointment.name}`;
                        break;
                    default:
                        notificationText = `${notificationIcon} ${character.name} åˆ›å»ºäº†çº¦å®šï¼š${appointment.name}`;
                }
            } else if (action === 'reminder') {
                notificationIcon = 'â°';
                const today = new Date();
                const appointmentDate = new Date(appointment.date);
                const isToday = appointmentDate.toDateString() === today.toDateString();

                if (isToday) {
                    const timeText = appointment.time ? ` ${appointment.time}` : '';
                    notificationText = `${notificationIcon} ä»Šå¤©${timeText}æ˜¯${appointment.name}ï¼${character.name}åœ¨ç­‰ä½ `;
                } else {
                    notificationText = `${notificationIcon} ${character.name}æé†’ï¼šæ˜å¤©æ˜¯${appointment.name}`;
                }
            }

            // ä½¿ç”¨ç°æœ‰çš„æ¨é€é€šçŸ¥ç³»ç»Ÿï¼Œå¢åŠ ä¼˜å…ˆçº§
            createPushNotification(character, notificationText, 150);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æµ‹AIå›å¤ä¸­çš„çºªå¿µæ—¥åˆ›å»ºæ„å›¾
        async function detectAnniversaryCreationInAIReply(characterId, aiReplyText, userMessageText) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            console.log('ğŸ” æ£€æµ‹AIå›å¤ä¸­çš„çºªå¿µæ—¥åˆ›å»ºæ„å›¾...');
            console.log('AIå›å¤:', aiReplyText);
            console.log('ç”¨æˆ·æ¶ˆæ¯:', userMessageText);

            // æ£€æµ‹AIæ˜¯å¦æ˜ç¡®è¡¨ç¤ºè¦åˆ›å»ºçºªå¿µæ—¥
            const creationPhrases = [
                'åˆ›å»ºçºªå¿µæ—¥', 'å»ºç«‹çºªå¿µæ—¥', 'è®°å½•è¿™ä¸ªæ—¥å­', 'è®¾ç«‹çºªå¿µæ—¥',
                'åˆ›å»ºçº¦å®š', 'å»ºç«‹çº¦å®š', 'è®°å½•çº¦å®š', 'è®¾ç«‹çº¦å®š',
                'æˆ‘æƒ³è®°å½•', 'è®©æˆ‘è®°å½•', 'æˆ‘æ¥è®°å½•', 'æˆ‘è¦è®°å½•'
            ];

            const hasCreationIntent = creationPhrases.some(phrase =>
                aiReplyText.includes(phrase)
            );

            if (hasCreationIntent) {
                console.log('âœ… æ£€æµ‹åˆ°åˆ›å»ºæ„å›¾ï¼Œå°è¯•è§£æå†…å®¹...');

                // å°è¯•ä»AIå›å¤ä¸­æå–çºªå¿µæ—¥ä¿¡æ¯
                let anniversaryName = 'ç‰¹åˆ«çš„æ—¥å­';
                let anniversaryType = 'other';
                let anniversaryDate = new Date().toISOString().split('T')[0];

                // æå–æ—¥æœŸ
                const dateMatch = aiReplyText.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥|(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                if (dateMatch) {
                    if (dateMatch[1] && dateMatch[2] && dateMatch[3]) {
                        // å®Œæ•´æ—¥æœŸ
                        anniversaryDate = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
                    } else if (dateMatch[4] && dateMatch[5]) {
                        // æœˆæ—¥æ ¼å¼ï¼Œä½¿ç”¨å½“å‰å¹´ä»½
                        const currentYear = new Date().getFullYear();
                        anniversaryDate = `${currentYear}-${dateMatch[4].padStart(2, '0')}-${dateMatch[5].padStart(2, '0')}`;
                    }
                }

                // æå–åç§°
                const nameMatch = aiReplyText.match(/çºªå¿µæ—¥.*?[ï¼š:]\s*([^ã€‚ï¼ï¼Ÿ\n]+)|åç§°.*?[ï¼š:]\s*([^ã€‚ï¼ï¼Ÿ\n]+)|å«åš\s*([^ã€‚ï¼ï¼Ÿ\n]+)/);
                if (nameMatch) {
                    anniversaryName = (nameMatch[1] || nameMatch[2] || nameMatch[3]).trim();
                }

                // åˆ¤æ–­ç±»å‹
                if (aiReplyText.includes('ç”Ÿæ—¥') || userMessageText.includes('ç”Ÿæ—¥')) {
                    anniversaryType = 'birthday';
                    if (!nameMatch) anniversaryName = 'ç”Ÿæ—¥';
                } else if (aiReplyText.includes('ç¬¬ä¸€æ¬¡') || userMessageText.includes('ç¬¬ä¸€æ¬¡')) {
                    anniversaryType = 'first_time';
                    if (!nameMatch) anniversaryName = 'æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡';
                } else if (aiReplyText.includes('ç›¸é‡') || aiReplyText.includes('è®¤è¯†')) {
                    anniversaryType = 'meeting';
                    if (!nameMatch) anniversaryName = 'æˆ‘ä»¬ç›¸é‡çš„æ—¥å­';
                }

                console.log('ğŸ“ è§£æå‡ºçš„çºªå¿µæ—¥ä¿¡æ¯:', {
                    name: anniversaryName,
                    date: anniversaryDate,
                    type: anniversaryType
                });

                // åˆ›å»ºçºªå¿µæ—¥
                const anniversaryData = {
                    name: anniversaryName,
                    date: anniversaryDate,
                    type: anniversaryType,
                    description: `ç”±${character.name}åˆ›å»ºçš„çºªå¿µæ—¥`
                };

                const success = await createAnniversaryByCharacter(characterId, anniversaryData);
                if (success) {
                    console.log('âœ… çºªå¿µæ—¥åˆ›å»ºæˆåŠŸï¼');
                } else {
                    console.error('âŒ çºªå¿µæ—¥åˆ›å»ºå¤±è´¥');
                }
            }
        }

        // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ›´åˆç†çš„çºªå¿µæ—¥å’Œçº¦å®šæé†’ç³»ç»Ÿ
        async function checkAnniversaryReminders() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            console.log('ğŸ” æ£€æŸ¥çºªå¿µæ—¥å’Œçº¦å®šæé†’...');

            // æ£€æŸ¥ä»Šå¤©çš„çºªå¿µæ—¥ - åªåœ¨ç‰¹å®šæ—¶é—´æé†’
            const currentHour = today.getHours();
            const shouldRemindToday = currentHour === 8 || currentHour === 20; // æ—©ä¸Š8ç‚¹æˆ–æ™šä¸Š8ç‚¹

            for (const anniversary of anniversaries) {
                if (anniversary.characterId && anniversary.isShared) {
                    const character = characters.find(c => c.id === anniversary.characterId);
                    if (!character) continue;

                    const anniversaryDate = new Date(anniversary.date);
                    const thisYearDate = new Date(today.getFullYear(), anniversaryDate.getMonth(), anniversaryDate.getDate());
                    const thisYearDateStr = thisYearDate.toISOString().split('T')[0];

                    // ä»Šå¤©æ˜¯çºªå¿µæ—¥ä¸”åœ¨åˆé€‚çš„æ—¶é—´
                    if (thisYearDateStr === todayStr && shouldRemindToday) {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æé†’è¿‡ï¼ˆé¿å…é‡å¤ï¼‰
                        const hasRemindedToday = await checkIfAlreadyReminded(character.id, anniversary.id, 'today');
                        if (!hasRemindedToday) {
                            await triggerAnniversaryReminder(character, anniversary, 'today');
                            await markAsReminded(character.id, anniversary.id, 'today');
                        }
                    }
                    // æ˜å¤©æ˜¯çºªå¿µæ—¥ä¸”æ˜¯æ™šä¸Š8ç‚¹ï¼ˆæå‰ä¸€å¤©æé†’ï¼‰
                    else if (thisYearDateStr === tomorrowStr && currentHour === 20) {
                        const hasRemindedTomorrow = await checkIfAlreadyReminded(character.id, anniversary.id, 'tomorrow');
                        if (!hasRemindedTomorrow) {
                            await triggerAnniversaryReminder(character, anniversary, 'tomorrow');
                            await markAsReminded(character.id, anniversary.id, 'tomorrow');
                        }
                    }
                }
            }

            // æ£€æŸ¥ä»Šå¤©çš„çº¦å®š
            for (const appointment of appointments) {
                if (appointment.characterId && appointment.isShared && !appointment.completed && !appointment.neverExpires) {
                    const character = characters.find(c => c.id === appointment.characterId);
                    if (!character) continue;

                    // ä»Šå¤©æ˜¯çº¦å®šæ—¥æœŸ
                    if (appointment.date === todayStr && shouldRemindToday) {
                        const hasRemindedToday = await checkIfAlreadyReminded(character.id, appointment.id, 'today');
                        if (!hasRemindedToday) {
                            await triggerAppointmentReminder(character, appointment, 'today');
                            await markAsReminded(character.id, appointment.id, 'today');
                        }
                    }
                    // æ˜å¤©æ˜¯çº¦å®šæ—¥æœŸ
                    else if (appointment.date === tomorrowStr && currentHour === 20) {
                        const hasRemindedTomorrow = await checkIfAlreadyReminded(character.id, appointment.id, 'tomorrow');
                        if (!hasRemindedTomorrow) {
                            await triggerAppointmentReminder(character, appointment, 'tomorrow');
                            await markAsReminded(character.id, appointment.id, 'tomorrow');
                        }
                    }
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦å·²ç»æé†’è¿‡ï¼ˆé¿å…é‡å¤æé†’ï¼‰
        async function checkIfAlreadyReminded(characterId, itemId, timing) {
            const today = new Date().toISOString().split('T')[0];
            const key = `reminder_${characterId}_${itemId}_${timing}_${today}`;
            return localStorage.getItem(key) !== null;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ‡è®°ä¸ºå·²æé†’
        async function markAsReminded(characterId, itemId, timing) {
            const today = new Date().toISOString().split('T')[0];
            const key = `reminder_${characterId}_${itemId}_${timing}_${today}`;
            localStorage.setItem(key, 'true');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘çºªå¿µæ—¥æé†’
        async function triggerAnniversaryReminder(character, anniversary, timing) {
            const timingText = timing === 'today' ? 'ä»Šå¤©' : 'æ˜å¤©';

            // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è§’è‰²æ€§æ ¼ç”Ÿæˆæ›´è‡ªç„¶çš„æé†’æ¶ˆæ¯
            const personality = character.personality || '';
            const isGentle = personality.includes('æ¸©æŸ”') || personality.includes('æ¸©å’Œ');
            const isPlayful = personality.includes('æ´»æ³¼') || personality.includes('å¼€æœ—');
            const isCool = personality.includes('å†·é…·') || personality.includes('é«˜å†·');

            let messages = [];

            if (isGentle) {
                messages = [
                    `${timingText}æ˜¯${anniversary.name}å‘¢ï¼Œä½ è¿˜è®°å¾—å—ï¼Ÿ`,
                    `${timingText}æ˜¯ä¸ªç‰¹åˆ«çš„æ—¥å­â€”â€”${anniversary.name}ã€‚`,
                    `æƒ³èµ·æ¥${timingText}æ˜¯${anniversary.name}ï¼Œå¿ƒæƒ…æœ‰ç‚¹ç‰¹åˆ«å‘¢ã€‚`
                ];
            } else if (isPlayful) {
                messages = [
                    `å“å‘€ï¼${timingText}æ˜¯${anniversary.name}ï¼ä½ è®°å¾—å—ï¼Ÿ`,
                    `${timingText}æ˜¯${anniversary.name}å‘¢ï½æ—¶é—´è¿‡å¾—å¥½å¿«ï¼`,
                    `${anniversary.name}å°±åœ¨${timingText}ï¼è¦åº†ç¥ä¸€ä¸‹å—ï¼Ÿ`
                ];
            } else if (isCool) {
                messages = [
                    `${timingText}æ˜¯${anniversary.name}...ä½ åº”è¯¥è®°å¾—å§ã€‚`,
                    `${anniversary.name}ï¼Œ${timingText}ã€‚`,
                    `${timingText}...${anniversary.name}å‘¢ã€‚`
                ];
            } else {
                messages = [
                    `${timingText}æ˜¯${anniversary.name}å‘¢ï¼Œä½ è¿˜è®°å¾—å—ï¼Ÿ`,
                    `${timingText}æ˜¯ä¸ªç‰¹åˆ«çš„æ—¥å­â€”â€”${anniversary.name}ã€‚`,
                    `æé†’ä¸€ä¸‹ï¼Œ${timingText}æ˜¯${anniversary.name}å“¦ã€‚`,
                    `${anniversary.name}å°±åœ¨${timingText}ï¼Œæ—¶é—´è¿‡å¾—çœŸå¿«ã€‚`
                ];
            }

            const message = messages[Math.floor(Math.random() * messages.length)];

            // å‘é€æé†’æ¶ˆæ¯åˆ°èŠå¤©
            await sendCharacterReminderMessage(character.id, message);

            // åˆ›å»ºé€šçŸ¥
            createAnniversaryNotification(character, anniversary, 'reminder');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘çº¦å®šæé†’
        async function triggerAppointmentReminder(character, appointment, timing) {
            const timingText = timing === 'today' ? 'ä»Šå¤©' : 'æ˜å¤©';
            const timeText = appointment.time ? ` ${appointment.time}` : '';

            // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è§’è‰²æ€§æ ¼ç”Ÿæˆæ›´è‡ªç„¶çš„æé†’æ¶ˆæ¯
            const personality = character.personality || '';
            const isGentle = personality.includes('æ¸©æŸ”') || personality.includes('æ¸©å’Œ');
            const isPlayful = personality.includes('æ´»æ³¼') || personality.includes('å¼€æœ—');
            const isCool = personality.includes('å†·é…·') || personality.includes('é«˜å†·');

            let messages = [];

            if (isGentle) {
                messages = [
                    `${timingText}${timeText}æˆ‘ä»¬æœ‰çº¦å®šâ€”â€”${appointment.name}ï¼Œè®°å¾—å“¦ã€‚`,
                    `æ¸©é¦¨æé†’ï¼Œ${timingText}${timeText}æ˜¯${appointment.name}çš„æ—¶é—´ã€‚`,
                    `${appointment.name}å°±åœ¨${timingText}${timeText}ï¼Œæˆ‘å¾ˆæœŸå¾…å‘¢ã€‚`
                ];
            } else if (isPlayful) {
                messages = [
                    `${timingText}${timeText}æˆ‘ä»¬æœ‰çº¦å®šâ€”â€”${appointment.name}ï¼Œåˆ«å¿˜äº†å“¦ï¼`,
                    `å“‡ï¼${appointment.name}å°±åœ¨${timingText}${timeText}ï¼Œå‡†å¤‡å¥½äº†å—ï¼Ÿ`,
                    `æˆ‘ä»¬çº¦å¥½çš„${appointment.name}æ˜¯${timingText}${timeText}å‘¢ï½è¶…æœŸå¾…çš„ï¼`
                ];
            } else if (isCool) {
                messages = [
                    `${timingText}${timeText}...${appointment.name}ã€‚`,
                    `${appointment.name}ï¼Œ${timingText}${timeText}ã€‚åˆ«å¿˜äº†ã€‚`,
                    `çº¦å®šçš„æ—¶é—´åˆ°äº†ï¼Œ${timingText}${timeText}ã€‚`
                ];
            } else {
                messages = [
                    `${timingText}${timeText}æˆ‘ä»¬æœ‰çº¦å®šâ€”â€”${appointment.name}ï¼Œåˆ«å¿˜äº†å“¦ã€‚`,
                    `æé†’ä½ ä¸€ä¸‹ï¼Œ${timingText}${timeText}æ˜¯${appointment.name}çš„æ—¶é—´ã€‚`,
                    `${appointment.name}å°±åœ¨${timingText}${timeText}ï¼Œå‡†å¤‡å¥½äº†å—ï¼Ÿ`,
                    `æˆ‘ä»¬çº¦å¥½çš„${appointment.name}æ˜¯${timingText}${timeText}å‘¢ã€‚`
                ];
            }

            const message = messages[Math.floor(Math.random() * messages.length)];

            // å‘é€æé†’æ¶ˆæ¯åˆ°èŠå¤©
            await sendCharacterReminderMessage(character.id, message);

            // åˆ›å»ºé€šçŸ¥
            createAppointmentNotification(character, appointment, 'reminder');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²å‘é€æé†’æ¶ˆæ¯
        async function sendCharacterReminderMessage(characterId, message) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // åˆ›å»ºAIæ¶ˆæ¯å¯¹è±¡
            const aiMessage = {
                id: `reminder-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                content: [{ type: 'text', text: message }],
                text: message,
                timestamp: Date.now(),
                isUser: false,
                isReminder: true, // æ ‡è®°ä¸ºæé†’æ¶ˆæ¯
                sender: 'received' // ğŸ”¥ã€æ–°å¢ã€‘ç¡®ä¿æ¶ˆæ¯æ ¼å¼æ­£ç¡®
            };

            // æ·»åŠ åˆ°èŠå¤©è®°å½•
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            chatMessages[characterId].push(aiMessage);

            // ä¿å­˜åˆ°æ•°æ®åº“
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                const stableId = `${characterId}_reminder_${aiMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: characterId,
                    timestamp: aiMessage.timestamp,
                    messageOrder: chatMessages[characterId].length - 1,
                    originalMessageId: aiMessage.id,
                    messageData: aiMessage
                });
            } catch (error) {
                console.error('ä¿å­˜æé†’æ¶ˆæ¯å¤±è´¥:', error);
            }

            // å¦‚æœç”¨æˆ·å½“å‰åœ¨å’Œè¯¥è§’è‰²èŠå¤©ï¼Œä½¿ç”¨åŠ¨ç”»æ·»åŠ æ¶ˆæ¯
            if (currentChatCharacter && currentChatCharacter.id === characterId) {
                addMessageWithAnimation(aiMessage, characterId);

                // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæé†’æ¶ˆæ¯æ·»åŠ ç‰¹æ®Šæ ·å¼
                setTimeout(() => {
                    const messageContainers = document.querySelectorAll('.message-container.received');
                    const lastContainer = messageContainers[messageContainers.length - 1];
                    if (lastContainer) {
                        const bubble = lastContainer.querySelector('.message-bubble');
                        if (bubble) {
                            bubble.classList.add('reminder-message');
                        }
                    }
                }, 100);
            }

            // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
            renderMessageList();

            // ğŸ”¥ã€å¢å¼ºã€‘åˆ›å»ºæ›´ä¸ªæ€§åŒ–çš„æ¨é€é€šçŸ¥
            const notificationText = `ğŸ’­ ${character.name}: ${message}`;
            createPushNotification(character, notificationText, 180);
        }

        // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ›´åˆç†çš„çºªå¿µæ—¥æé†’ç³»ç»Ÿåˆå§‹åŒ–
        function initAnniversaryReminderSystem() {
            console.log('ğŸ‰ å¯åŠ¨çºªå¿µæ—¥å’Œçº¦å®šæé†’ç³»ç»Ÿ...');

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘åªåœ¨æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹æ£€æŸ¥ï¼Œé¿å…è¿‡åº¦æ‰“æ‰°
            const scheduleReminders = () => {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();

                // åªåœ¨æ—©ä¸Š8:00-8:05å’Œæ™šä¸Š20:00-20:05ä¹‹é—´æ£€æŸ¥
                if ((hour === 8 || hour === 20) && minute < 5) {
                    console.log(`ğŸ”” å®šæ—¶æ£€æŸ¥çºªå¿µæ—¥æé†’ - ${hour}:${minute.toString().padStart(2, '0')}`);
                    checkAnniversaryReminders();
                }
            };

            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡ï¼ˆå¦‚æœå½“å‰æ˜¯åˆé€‚çš„æ—¶é—´ï¼‰
            setTimeout(() => {
                scheduleReminders();
            }, 5000); // å»¶è¿Ÿ5ç§’ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ

            // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦åˆ°äº†æé†’æ—¶é—´
            setInterval(scheduleReminders, 5 * 60 * 1000); // 5åˆ†é’Ÿ

            console.log('âœ… çºªå¿µæ—¥æé†’ç³»ç»Ÿå·²å¯åŠ¨ - åªåœ¨æ—©8ç‚¹å’Œæ™š8ç‚¹æé†’');
        }

        // ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘æä¾›æ‰‹åŠ¨åˆ›å»ºçºªå¿µæ—¥å’Œçº¦å®šçš„æ¥å£
        window.createAnniversaryByCharacterManual = createAnniversaryByCharacter;
        window.createAppointmentByCharacterManual = createAppointmentByCharacter;

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºå¼€å‘è€…æä¾›æµ‹è¯•æ¥å£
        window.testAnniversaryReminder = async function(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) {
                console.error('è§’è‰²ä¸å­˜åœ¨');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•çºªå¿µæ—¥
            const testAnniversary = {
                name: 'æµ‹è¯•çºªå¿µæ—¥',
                date: new Date().toISOString().split('T')[0],
                type: 'other',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çºªå¿µæ—¥'
            };

            await createAnniversaryByCharacter(characterId, testAnniversary);
            console.log('âœ… æµ‹è¯•çºªå¿µæ—¥åˆ›å»ºæˆåŠŸ');
        };

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºå¼€å‘è€…æä¾›æµ‹è¯•çº¦å®šæ¥å£
        window.testAppointmentReminder = async function(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) {
                console.error('è§’è‰²ä¸å­˜åœ¨');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•çº¦å®š
            const testAppointment = {
                name: 'æµ‹è¯•çº¦å®š',
                date: new Date().toISOString().split('T')[0],
                type: 'other',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çº¦å®š'
            };

            await createAppointmentByCharacter(characterId, testAppointment);
            console.log('âœ… æµ‹è¯•çº¦å®šåˆ›å»ºæˆåŠŸ');
        };

        // ğŸ”¥ã€ä¿ç•™ä½†ä¼˜åŒ–ã€‘è‡ªç„¶æåŠç°æœ‰çºªå¿µæ—¥æˆ–çº¦å®š - åªåœ¨ç”¨æˆ·æ˜ç¡®è¯¢é—®æ—¶é—´æ—¶è§¦å‘
        async function checkForNaturalAnniversaryMention(characterId, messageContent) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // ğŸ”¥ã€æ›´ä¸¥æ ¼ã€‘åªåœ¨ç”¨æˆ·æ˜ç¡®è¯¢é—®æ—¶é—´ç›¸å…³é—®é¢˜æ—¶æ‰è§¦å‘
            const directTimeQuestions = [
                'ä»Šå¤©æ˜¯å‡ å·', 'ä»Šå¤©å‡ å·', 'ç°åœ¨å‡ å·', 'ä»€ä¹ˆæ—¶å€™', 'å“ªå¤©',
                'ä»Šå¤©æ˜¯ä»€ä¹ˆæ—¥å­', 'æœ‰ä»€ä¹ˆå®‰æ’', 'æœ€è¿‘æœ‰ä»€ä¹ˆäº‹'
            ];

            const isDirectTimeQuestion = directTimeQuestions.some(question =>
                messageContent.includes(question)
            );

            // åªæœ‰åœ¨ç›´æ¥è¯¢é—®æ—¶é—´æ—¶æ‰æœ‰å¯èƒ½æåŠï¼ˆå¹¶ä¸”æ¦‚ç‡å¾ˆä½ï¼‰
            if (isDirectTimeQuestion && Math.random() < 0.1) { // åªæœ‰10%æ¦‚ç‡
                const today = new Date();

                // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³çš„çºªå¿µæ—¥æˆ–çº¦å®š
                const relevantAnniversaries = anniversaries.filter(a =>
                    a.characterId === characterId && a.isShared
                );
                const relevantAppointments = appointments.filter(a =>
                    a.characterId === characterId && a.isShared && !a.completed
                );

                // ä¼˜å…ˆæåŠå³å°†åˆ°æ¥çš„çºªå¿µæ—¥æˆ–çº¦å®š
                const upcomingItems = [...relevantAnniversaries, ...relevantAppointments]
                    .map(item => {
                        const itemDate = new Date(item.date);
                        const daysDiff = Math.ceil((itemDate - today) / (1000 * 60 * 60 * 24));
                        return { ...item, daysDiff, isAnniversary: !!item.yearly };
                    })
                    .filter(item => item.daysDiff >= 0 && item.daysDiff <= 3) // åªæåŠ3å¤©å†…çš„
                    .sort((a, b) => a.daysDiff - b.daysDiff);

                if (upcomingItems.length > 0) {
                    const item = upcomingItems[0];
                    let reminderMessage = '';

                    if (item.daysDiff === 0) {
                        reminderMessage = `å¯¹äº†ï¼Œä»Šå¤©æ˜¯${item.name}å‘¢ã€‚`;
                    } else if (item.daysDiff === 1) {
                        reminderMessage = `è¯´èµ·æ¥ï¼Œæ˜å¤©æ˜¯${item.name}ã€‚`;
                    } else {
                        reminderMessage = `æƒ³èµ·æ¥ï¼Œ${item.daysDiff}å¤©åæ˜¯${item.name}ã€‚`;
                    }

                    // å‘é€è‡ªç„¶çš„æé†’æ¶ˆæ¯
                    await sendCharacterReminderMessage(characterId, reminderMessage);
                }
            }
        }

        // ğŸ”¥ã€ç®€åŒ–ã€‘æä¾›ç®€å•çš„æ‰‹åŠ¨åˆ›å»ºæ¥å£ä¾›å¼€å‘è€…ä½¿ç”¨
        window.manualCreateAnniversary = async function(characterId, name, date, type = 'other') {
            const anniversaryData = {
                name: name,
                date: date,
                type: type,
                description: `æ‰‹åŠ¨åˆ›å»ºçš„${type === 'birthday' ? 'ç”Ÿæ—¥' : 'çºªå¿µæ—¥'}`
            };
            return await createAnniversaryByCharacter(characterId, anniversaryData);
        };

        window.manualCreateAppointment = async function(characterId, name, date, type = 'other', neverExpires = false) {
            const appointmentData = {
                name: name,
                date: date,
                type: type,
                description: `æ‰‹åŠ¨åˆ›å»ºçš„çº¦å®š`,
                neverExpires: neverExpires
            };
            return await createAppointmentByCharacter(characterId, appointmentData);
        };

        // ğŸ”¥ã€æ–°å¢ã€‘å¼€å‘è€…è°ƒè¯•æ¥å£
        window.anniversaryDebug = {
            // æ‰‹åŠ¨è§¦å‘æé†’æ£€æŸ¥
            checkReminders: () => checkAnniversaryReminders(),

            // ä¸ºæŒ‡å®šè§’è‰²åˆ›å»ºæµ‹è¯•çºªå¿µæ—¥
            createTestAnniversary: async (characterId, name = 'æµ‹è¯•çºªå¿µæ—¥') => {
                const today = new Date().toISOString().split('T')[0];
                return await window.manualCreateAnniversary(characterId, name, today, 'other');
            },

            // ä¸ºæŒ‡å®šè§’è‰²åˆ›å»ºæµ‹è¯•çº¦å®š
            createTestAppointment: async (characterId, name = 'æµ‹è¯•çº¦å®š', neverExpires = false) => {
                const today = new Date().toISOString().split('T')[0];
                return await window.manualCreateAppointment(characterId, name, today, 'other', neverExpires);
            },

            // æŸ¥çœ‹æ‰€æœ‰çºªå¿µæ—¥
            listAnniversaries: () => {
                console.table(anniversaries.map(a => ({
                    id: a.id,
                    name: a.name,
                    date: a.date,
                    character: characters.find(c => c.id === a.characterId)?.name || 'æœªçŸ¥',
                    quote: a.characterQuote
                })));
            },

            // æŸ¥çœ‹æ‰€æœ‰çº¦å®š
            listAppointments: () => {
                console.table(appointments.map(a => ({
                    id: a.id,
                    name: a.name,
                    date: a.date,
                    character: characters.find(c => c.id === a.characterId)?.name || 'æœªçŸ¥',
                    quote: a.characterQuote,
                    completed: a.completed
                })));
            }
        };

        console.log('ğŸ”§ çºªå¿µæ—¥è°ƒè¯•æ¥å£å·²åŠ è½½ï¼Œä½¿ç”¨ anniversaryDebug å¯¹è±¡è¿›è¡Œè°ƒè¯•');

        // ğŸ”¥ã€æ–°å¢ã€‘ç®€å•çš„æµ‹è¯•å‡½æ•°ï¼Œç”¨äºéªŒè¯è§’è‰²åˆ›å»ºåŠŸèƒ½
        window.testCreateAnniversary = async function() {
            // è·å–ç¬¬ä¸€ä¸ªè§’è‰²
            if (characters.length === 0) {
                console.error('âŒ æ²¡æœ‰è§’è‰²å¯ç”¨äºæµ‹è¯•');
                return;
            }

            const testCharacter = characters[0];
            console.log('ğŸ§ª ä½¿ç”¨è§’è‰²è¿›è¡Œæµ‹è¯•:', testCharacter.name);

            const testData = {
                name: 'æµ‹è¯•çºªå¿µæ—¥',
                date: new Date().toISOString().split('T')[0],
                type: 'other',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çºªå¿µæ—¥'
            };

            console.log('ğŸ“ åˆ›å»ºçºªå¿µæ—¥æ•°æ®:', testData);

            try {
                const result = await createAnniversaryByCharacter(testCharacter.id, testData);
                console.log('âœ… åˆ›å»ºç»“æœ:', result);

                // æ£€æŸ¥æ˜¯å¦çœŸçš„æ·»åŠ åˆ°äº†æ•°ç»„ä¸­
                console.log('ğŸ“Š å½“å‰çºªå¿µæ—¥æ•°é‡:', anniversaries.length);
                console.log('ğŸ“‹ æœ€æ–°çš„çºªå¿µæ—¥:', anniversaries[anniversaries.length - 1]);

                return result;
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        };

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•çº¦å®šåˆ›å»ºåŠŸèƒ½
        window.testCreateAppointment = async function() {
            // è·å–ç¬¬ä¸€ä¸ªè§’è‰²
            if (characters.length === 0) {
                console.error('âŒ æ²¡æœ‰è§’è‰²å¯ç”¨äºæµ‹è¯•');
                return;
            }

            const testCharacter = characters[0];
            console.log('ğŸ§ª ä½¿ç”¨è§’è‰²è¿›è¡Œæµ‹è¯•:', testCharacter.name);

            const testData = {
                name: 'æµ‹è¯•çº¦å®š',
                date: new Date().toISOString().split('T')[0],
                type: 'other',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çº¦å®š'
            };

            console.log('ğŸ“ åˆ›å»ºçº¦å®šæ•°æ®:', testData);

            try {
                const result = await createAppointmentByCharacter(testCharacter.id, testData);
                console.log('âœ… åˆ›å»ºç»“æœ:', result);

                // æ£€æŸ¥æ˜¯å¦çœŸçš„æ·»åŠ åˆ°äº†æ•°ç»„ä¸­
                console.log('ğŸ“Š å½“å‰çº¦å®šæ•°é‡:', appointments.length);
                console.log('ğŸ“‹ æœ€æ–°çš„çº¦å®š:', appointments[appointments.length - 1]);

                return result;
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        };



        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${year}-${month}-${day} ${weekday}`;
        }

        // è·å–ç±»å‹æ–‡æœ¬
        function getTypeText(anniversary) {
            if (anniversary.customType) {
                return anniversary.customType;
            }

            const typeMap = {
                birthday: 'ç”Ÿæ—¥',
                relationship: 'ç¡®å®šå…³ç³»',
                anniversary: 'çºªå¿µæ—¥',
                holiday: 'èŠ‚æ—¥',
                family: 'å®¶äººç”Ÿæ—¥',
                other: 'å…¶ä»–'
            };
            return typeMap[anniversary.type] || 'å…¶ä»–';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–çº¦å®šç±»å‹æ–‡æœ¬
        function getAppointmentTypeText(appointment) {
            if (appointment.customType) {
                return appointment.customType;
            }

            const typeMap = {
                date: 'çº¦ä¼š',
                meeting: 'ä¼šé¢',
                travel: 'æ—…è¡Œ',
                event: 'æ´»åŠ¨',
                work: 'å·¥ä½œ',
                study: 'å­¦ä¹ ',
                health: 'å¥åº·',
                other: 'å…¶ä»–'
            };
            return typeMap[appointment.type] || 'å…¶ä»–';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†çºªå¿µæ—¥èƒŒæ™¯å›¾ä¸Šä¼ 
        function handleAnniversaryBackgroundUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    document.getElementById('anniversary-background-img').src = e.target.result;
                    document.getElementById('anniversary-background-preview').style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†çºªå¿µæ—¥ç”¨æˆ·å¤´åƒä¸Šä¼ 
        function handleAnniversaryUserAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    document.getElementById('anniversary-user-avatar-img').src = e.target.result;
                    document.getElementById('anniversary-user-avatar-preview').style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤çºªå¿µæ—¥èƒŒæ™¯å›¾
        function removeAnniversaryBackground() {
            document.getElementById('anniversary-background-upload').value = '';
            document.getElementById('anniversary-background-preview').style.display = 'none';
            document.getElementById('anniversary-background-img').src = '';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤çºªå¿µæ—¥ç”¨æˆ·å¤´åƒ
        function removeAnniversaryUserAvatar() {
            document.getElementById('anniversary-user-avatar-upload').value = '';
            document.getElementById('anniversary-user-avatar-preview').style.display = 'none';
            document.getElementById('anniversary-user-avatar-img').src = '';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†çº¦å®šèƒŒæ™¯å›¾ä¸Šä¼ 
        function handleAppointmentBackgroundUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    document.getElementById('appointment-background-img').src = e.target.result;
                    document.getElementById('appointment-background-preview').style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†çº¦å®šç”¨æˆ·å¤´åƒä¸Šä¼ 
        function handleAppointmentUserAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    document.getElementById('appointment-user-avatar-img').src = e.target.result;
                    document.getElementById('appointment-user-avatar-preview').style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤çº¦å®šèƒŒæ™¯å›¾
        function removeAppointmentBackground() {
            document.getElementById('appointment-background-upload').value = '';
            document.getElementById('appointment-background-preview').style.display = 'none';
            document.getElementById('appointment-background-img').src = '';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤çº¦å®šç”¨æˆ·å¤´åƒ
        function removeAppointmentUserAvatar() {
            document.getElementById('appointment-user-avatar-upload').value = '';
            document.getElementById('appointment-user-avatar-preview').style.display = 'none';
            document.getElementById('appointment-user-avatar-img').src = '';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸²æŸ“ç½®é¡¶çºªå¿µæ—¥
        function renderPinnedAnniversary(anniversary) {
            const pinnedCard = document.getElementById('pinned-anniversary-card');
            const now = new Date();
            const currentYear = now.getFullYear();

            const anniversaryDate = new Date(anniversary.date);
            const countType = anniversary.countType || 'countdown'; // é»˜è®¤ä¸ºå€’æ•°

            let countdownText = '';
            let countdownLabel = '';

            if (countType === 'countup') {
                // æ­£æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼Œç¬¬äºŒå¤©æ˜¾ç¤º1å¤©ï¼‰
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const anniversaryDateOnly = new Date(anniversaryDate.getFullYear(), anniversaryDate.getMonth(), anniversaryDate.getDate());
                const daysPassed = Math.floor((today - anniversaryDateOnly) / (1000 * 60 * 60 * 24));
                countdownText = daysPassed === 0 ? 'ä»Šå¤©' :
                               `${daysPassed}`;
                countdownLabel = daysPassed === 0 ? '' : 'å¤©';
            } else {
                // å€’æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼‰
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                let nextDate = new Date(currentYear, anniversaryDate.getMonth(), anniversaryDate.getDate());

                // å¦‚æœä»Šå¹´çš„æ—¥æœŸå·²è¿‡ï¼Œè®¡ç®—æ˜å¹´çš„æ—¥æœŸ
                if (nextDate < today) {
                    nextDate.setFullYear(currentYear + 1);
                }

                const daysUntil = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                countdownText = daysUntil === 0 ? 'ä»Šå¤©' :
                               daysUntil === 1 ? 'æ˜å¤©' :
                               `${daysUntil}`;
                countdownLabel = daysUntil === 0 ? '' :
                                daysUntil === 1 ? '' :
                                'å¤©';
            }

            // è·å–ç›¸å…³è§’è‰²ä¿¡æ¯
            const character = anniversary.characterId ? characters.find(c => c.id === anniversary.characterId) : null;

            // æ„å»ºèƒŒæ™¯å›¾æ ·å¼
            const backgroundStyle = anniversary.backgroundImage ?
                `<div class="pinned-card-background" style="background-image: url('${anniversary.backgroundImage}')"></div>` : '';

            // æ„å»ºå¤´åƒåŒºåŸŸ
            let avatarsHtml = '';
            if (anniversary.userAvatar || character) {
                avatarsHtml = '<div class="pinned-card-avatars">';

                // è§’è‰²å¤´åƒï¼ˆç°åœ¨åœ¨å·¦è¾¹ï¼‰
                if (character) {
                    avatarsHtml += `
                        <div class="pinned-card-avatar">
                            <img src="${character.avatar || character.avatarUrl || createDefaultAvatar(character.name)}" alt="${character.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="pinned-card-avatar-fallback" style="display: none;">${character.name.charAt(0)}</div>
                        </div>
                    `;
                }

                // ç”¨æˆ·å¤´åƒï¼ˆç°åœ¨åœ¨å³è¾¹ï¼‰
                if (anniversary.userAvatar) {
                    avatarsHtml += `
                        <div class="pinned-card-avatar">
                            <img src="${anniversary.userAvatar}" alt="ä½ " onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="pinned-card-avatar-fallback" style="display: none;">ä½ </div>
                        </div>
                    `;
                }

                avatarsHtml += '</div>';
            }

            // æ„å»ºç±»å‹æ ‡ç­¾
            const typeClass = anniversary.type || 'other';
            const typeText = getTypeText(anniversary);

            // æ„å»ºç”¨æˆ·è¯­å½•
            const userQuoteHtml = anniversary.userQuote ? `
                <div class="pinned-card-user-quote">
                    <i class="fas fa-quote-left"></i>
                    <span class="quote-author">ä½ ï¼š</span>${escapeHtml(anniversary.userQuote)}
                </div>
            ` : '';

            // æ„å»ºè§’è‰²è¯­å½•
            const characterQuoteHtml = anniversary.characterQuote ? `
                <div class="pinned-card-quote">
                    <i class="fas fa-quote-left"></i>
                    <span class="quote-author">${character ? character.name : 'è§’è‰²'}ï¼š</span>${escapeHtml(anniversary.characterQuote)}
                </div>
            ` : '';

            pinnedCard.innerHTML = `
                ${backgroundStyle}
                <div class="pinned-card-content">
                    <div class="pinned-card-header">
                        ${avatarsHtml}
                        <div class="pinned-card-type ${typeClass}">${typeText}</div>
                    </div>
                    <div class="pinned-card-main">
                        <div class="pinned-card-title">${escapeHtml(anniversary.name)}</div>
                        <div class="pinned-card-countdown">${countdownText}</div>
                        <div class="pinned-card-countdown-label">${countdownLabel}</div>
                        <div class="pinned-card-date">${countType === 'countup' ? 'èµ·å§‹æ—¥' : 'ç›®æ ‡æ—¥'} ${formatDate(anniversary.date)}</div>
                    </div>
                    <div class="pinned-card-footer">
                        ${userQuoteHtml}
                        ${characterQuoteHtml}
                        <div class="pinned-card-actions">
                            <button class="pinned-card-unpin-btn" onclick="event.stopPropagation(); unpinAnniversary('${anniversary.id}')" title="å–æ¶ˆç½®é¡¶">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ dataå±æ€§ç”¨äºé•¿æŒ‰åˆ é™¤
            pinnedCard.dataset.anniversaryId = anniversary.id;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            pinnedCard.onclick = function(e) {
                if (!e.target.closest('.pinned-card-actions')) {
                    showAnniversaryForm(anniversary.id);
                }
            };
        }



        // æ˜¾ç¤ºæ–°çŸ­ä¿¡è¡¨å• - æ”¹ä¸ºå’Œchatappä¸€æ ·çš„æµç¨‹
        function showNewMessageForm() {
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            window.selectedPersonaForSMS = null;
            window.selectedCharacterForSMS = null;

            // æ˜¾ç¤ºèº«ä»½é€‰æ‹©æ¨¡æ€æ¡†
            showSMSPersonaSelector();
        }

        // æ˜¾ç¤ºçŸ­ä¿¡èº«ä»½é€‰æ‹©æ¨¡æ€æ¡†
        function showSMSPersonaSelector() {
            renderSMSPersonaSelector();
            document.getElementById('sms-persona-selector-modal').style.display = 'flex';
        }

        // éšè—çŸ­ä¿¡èº«ä»½é€‰æ‹©æ¨¡æ€æ¡†
        function hideSMSPersonaSelector(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('sms-persona-selector-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºçŸ­ä¿¡è§’è‰²é€‰æ‹©æ¨¡æ€æ¡†
        function showSMSCharacterSelector() {
            renderSMSCharacterSelector();
            document.getElementById('sms-character-selector-modal').style.display = 'flex';
        }

        // éšè—çŸ­ä¿¡è§’è‰²é€‰æ‹©æ¨¡æ€æ¡†
        function hideSMSCharacterSelector(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('sms-character-selector-modal').style.display = 'none';
        }

        // æ¸²æŸ“çŸ­ä¿¡èº«ä»½é€‰æ‹©å™¨
        function renderSMSPersonaSelector() {
            const container = document.getElementById('sms-persona-selector-body');
            if (!container) return;

            // åªæ˜¾ç¤ºèº«ä»½é¢å…·ï¼Œä¸åŒ…å«é»˜è®¤èº«ä»½
            if (!personas || personas.length === 0) {
                container.innerHTML = '<div class="sms-empty-state">æš‚æ— èº«ä»½é¢å…·</div>';
                return;
            }

            const personaHTML = personas.map(persona => `
                <div class="sms-persona-item" onclick="selectSMSPersona('${persona.id}')">
                    <div class="sms-item-avatar">
                        ${persona.avatarUrl ?
                            `<img src="${persona.avatarUrl}" alt="${persona.name}">` :
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class="sms-item-info">
                        <div class="sms-item-name">${persona.name}</div>
                        <div class="sms-item-desc">${persona.description ? persona.description.substring(0, 50) + '...' : 'èº«ä»½é¢å…·'}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = personaHTML;
        }

        // æ¸²æŸ“çŸ­ä¿¡è§’è‰²é€‰æ‹©å™¨
        function renderSMSCharacterSelector() {
            const container = document.getElementById('sms-character-selector-body');
            if (!container) return;

            if (!characters || characters.length === 0) {
                container.innerHTML = '<div class="sms-empty-state">æš‚æ— è§’è‰²</div>';
                return;
            }

            container.innerHTML = characters.map(character => `
                <div class="sms-character-item" onclick="selectSMSCharacter('${character.id}')">
                    <div class="sms-item-avatar">
                        ${character.avatarUrl ?
                            `<img src="${character.avatarUrl}" alt="${character.name}">` :
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class="sms-item-info">
                        <div class="sms-item-name">${character.name}</div>
                        <div class="sms-item-desc">${character.bio ? character.bio.substring(0, 50) + '...' : 'æš‚æ— äººè®¾æè¿°'}</div>
                    </div>
                </div>
            `).join('');
        }

        // é€‰æ‹©çŸ­ä¿¡èº«ä»½
        function selectSMSPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) {
                showToast('èº«ä»½é¢å…·ä¸å­˜åœ¨', 'error');
                return;
            }

            window.selectedPersonaForSMS = persona;

            // éšè—èº«ä»½é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºè§’è‰²é€‰æ‹©å™¨
            hideSMSPersonaSelector();
            showSMSCharacterSelector();
        }

        // é€‰æ‹©çŸ­ä¿¡è§’è‰²
        function selectSMSCharacter(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            window.selectedCharacterForSMS = character;

            // éšè—è§’è‰²é€‰æ‹©å™¨
            hideSMSCharacterSelector();

            // åˆ›å»ºçŸ­ä¿¡èŠå¤©
            createSMSChatWithPersona(character, window.selectedPersonaForSMS);
        }

        // åˆ›å»ºçŸ­ä¿¡èŠå¤©ï¼ˆå¸¦èº«ä»½ï¼‰
        async function createSMSChatWithPersona(character, persona) {
            try {
                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†èº«ä»½é¢å…·
                if (!persona) {
                    showToast('è¯·å…ˆé€‰æ‹©èº«ä»½é¢å…·', 'error');
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥è¯¥è§’è‰²æ˜¯å¦å·²å­˜åœ¨çŸ­ä¿¡å¯¹è¯ï¼ˆä½¿ç”¨ç‹¬ç«‹çš„smsContactsï¼‰
                if (smsContacts.includes(character.id)) {
                    // è§’è‰²å·²å­˜åœ¨çŸ­ä¿¡å¯¹è¯ï¼Œç›´æ¥è¿›å…¥çŸ­ä¿¡èŠå¤©
                    startSMSChat(character);
                    showToast(`å·²è¿›å…¥ä¸ ${character.name} çš„çŸ­ä¿¡èŠå¤©`, 'success');
                    return;
                }

                // ä¿å­˜èº«ä»½è®¾ç½®åˆ°èŠå¤©è®¾ç½®ä¸­ï¼ˆçŸ­ä¿¡åº”ç”¨ä¹Ÿä½¿ç”¨ç›¸åŒçš„è®¾ç½®ç³»ç»Ÿï¼‰
                const chatSettingsKey = character.id;
                if (!chatSettings[chatSettingsKey]) {
                    chatSettings[chatSettingsKey] = {};
                }
                chatSettings[chatSettingsKey].selectedIdentityId = persona.id;

                // ä¿å­˜åˆ°æ•°æ®åº“
                await saveChatSettings(character.id, chatSettings[chatSettingsKey]);

                console.log('çŸ­ä¿¡èŠå¤©ä½¿ç”¨èº«ä»½é¢å…·:', persona.name);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ åˆ°çŸ­ä¿¡åº”ç”¨çš„ç‹¬ç«‹è”ç³»äººåˆ—è¡¨
                if (!smsContacts.includes(character.id)) {
                    smsContacts.push(character.id);
                    await saveSMSContacts();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆå§‹åŒ–è¯¥è§’è‰²çš„çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                if (!smsMessages[character.id]) {
                    smsMessages[character.id] = [];
                }

                // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨
                renderSMSMessageList();

                // è¿›å…¥çŸ­ä¿¡èŠå¤©ç•Œé¢
                startSMSChat(character);

                showToast(`å·²åˆ›å»ºä¸ ${character.name} çš„çŸ­ä¿¡èŠå¤©ï¼ˆèº«ä»½ï¼š${persona.name}ï¼‰`, 'success');

            } catch (error) {
                console.error('åˆ›å»ºçŸ­ä¿¡èŠå¤©å¤±è´¥:', error);
                showToast('åˆ›å»ºçŸ­ä¿¡èŠå¤©å¤±è´¥', 'error');
            }
        }

        // å¼€å§‹çŸ­ä¿¡èŠå¤©
        function startSMSChat(character) {
            // è®¾ç½®å½“å‰çŸ­ä¿¡èŠå¤©è§’è‰²
            window.currentSMSCharacter = character;

            // æ›´æ–°çŸ­ä¿¡èŠå¤©ç•Œé¢ä¿¡æ¯
            updateSMSChatHeader(character);

            // æ¸²æŸ“çŸ­ä¿¡æ¶ˆæ¯
            renderSMSMessages(character.id);

            // æ˜¾ç¤ºçŸ­ä¿¡èŠå¤©ç•Œé¢
            document.getElementById('messages-screen').style.display = 'none';
            document.getElementById('sms-chat-screen').style.display = 'block';

            // åˆå§‹åŒ–è¾“å…¥æ¡†
            initSMSInput();
        }

        // æ›´æ–°çŸ­ä¿¡èŠå¤©å¤´éƒ¨ä¿¡æ¯
        function updateSMSChatHeader(character) {
            const nameEl = document.getElementById('sms-chat-name');
            const avatarEl = document.getElementById('sms-chat-avatar');

            // è®¾ç½®è§’è‰²åç§°
            nameEl.textContent = character.name;

            // è®¾ç½®è§’è‰²å¤´åƒ
            if (character.avatarUrl) {
                avatarEl.style.backgroundImage = `url(${character.avatarUrl})`;
                avatarEl.innerHTML = ''; // æ¸…ç©ºå›¾æ ‡
            } else {
                avatarEl.style.backgroundImage = '';
                avatarEl.innerHTML = '<i class="fas fa-user"></i>'; // æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
            }
        }



        // æ˜¾ç¤ºçŸ­ä¿¡æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function showSMSTypingIndicator() {
            const container = document.getElementById('sms-messages-container');
            if (!container) return;

            // ç§»é™¤å·²å­˜åœ¨çš„æŒ‡ç¤ºå™¨
            hideSMSTypingIndicator();

            // åˆ›å»ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'sms-typing-indicator';
            typingIndicator.id = 'sms-typing-indicator';
            typingIndicator.innerHTML = `
                <div class="sms-typing-bubble">
                    <div class="sms-typing-dots">
                        <div class="sms-typing-dot"></div>
                        <div class="sms-typing-dot"></div>
                        <div class="sms-typing-dot"></div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            container.appendChild(typingIndicator);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // éšè—çŸ­ä¿¡æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function hideSMSTypingIndicator() {
            const indicator = document.getElementById('sms-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ğŸ”¥ã€å·²ç§»é™¤ã€‘æ—§çš„é•¿æŒ‰å¤„ç†å‡½æ•°ï¼Œç°åœ¨ä½¿ç”¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ç³»ç»Ÿ

        // ğŸ”¥ã€æ–°å¢ã€‘è¿›å…¥çŸ­ä¿¡å¤šé€‰æ¨¡å¼
        function enterSMSMultiSelectMode(messageId) {
            console.log('è§¦å‘çŸ­ä¿¡é•¿æŒ‰å¤šé€‰æ¨¡å¼ï¼Œæ¶ˆæ¯ID:', messageId);
            isSMSMultiSelectMode = true;
            selectedSMSMessages = new Set([messageId]); // å°†è§¦å‘é•¿æŒ‰çš„æ¶ˆæ¯æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨

            // åˆ‡æ¢å¤´éƒ¨æŒ‰é’®æ˜¾ç¤º
            const normalActions = document.getElementById('sms-chat-normal-actions');
            const multiselectActions = document.getElementById('sms-chat-multiselect-actions');
            if (normalActions) normalActions.style.display = 'none';
            if (multiselectActions) multiselectActions.style.display = 'flex';

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
            const characterId = window.currentSMSCharacter?.id;
            if (characterId) {
                renderSMSMessages(characterId);
            }


        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€€å‡ºçŸ­ä¿¡å¤šé€‰æ¨¡å¼
        function exitSMSMultiSelectMode() {
            isSMSMultiSelectMode = false;
            selectedSMSMessages.clear();

            // åˆ‡æ¢å¤´éƒ¨æŒ‰é’®æ˜¾ç¤º
            const normalActions = document.getElementById('sms-chat-normal-actions');
            const multiselectActions = document.getElementById('sms-chat-multiselect-actions');
            if (normalActions) normalActions.style.display = 'flex';
            if (multiselectActions) multiselectActions.style.display = 'none';

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨æ¢å¤æ­£å¸¸çŠ¶æ€
            const characterId = window.currentSMSCharacter?.id;
            if (characterId) {
                renderSMSMessages(characterId);
            }
        }



        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢çŸ­ä¿¡æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
        function toggleSMSMessageSelection(messageId) {
            if (selectedSMSMessages.has(messageId)) {
                selectedSMSMessages.delete(messageId);
            } else {
                selectedSMSMessages.add(messageId);
            }

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ›´æ–°é€‰æ‹©çŠ¶æ€
            const characterId = window.currentSMSCharacter?.id;
            if (characterId) {
                renderSMSMessages(characterId);
            }

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯ï¼Œé€€å‡ºå¤šé€‰æ¨¡å¼
            if (selectedSMSMessages.size === 0) {
                exitSMSMultiSelectMode();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤é€‰ä¸­çš„çŸ­ä¿¡æ¶ˆæ¯
        async function deleteSelectedSMSMessages() {
            if (selectedSMSMessages.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯', 'error');
                return;
            }

            const count = selectedSMSMessages.size;
            const confirmText = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} æ¡çŸ­ä¿¡å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†ã€‚`;

            if (confirm(confirmText)) {
                try {
                    const characterId = window.currentSMSCharacter?.id;
                    if (!characterId) return;

                    // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
                    for (const messageId of selectedSMSMessages) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆè·å–è¦åˆ é™¤çš„æ¶ˆæ¯ä¿¡æ¯ï¼Œç”¨äºåˆ é™¤ç›¸å…³æ—¶é—´çº¿è®°å½•
                        let messageToDelete = null;
                        if (smsMessages[characterId]) {
                            const messageIndex = smsMessages[characterId].findIndex(msg => msg.id === messageId);
                            if (messageIndex > -1) {
                                messageToDelete = smsMessages[characterId][messageIndex];
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å½•
                        if (messageToDelete) {
                            try {
                                await deleteSMSRelatedTimelineEvents(messageToDelete, characterId);
                                console.log('âœ… å·²æ¸…ç†çŸ­ä¿¡ç›¸å…³çš„æ—¶é—´çº¿è®°å½•');
                            } catch (error) {
                                console.error('åˆ é™¤çŸ­ä¿¡æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
                            }
                        }

                        // ä»å†…å­˜ä¸­åˆ é™¤æ¶ˆæ¯
                        if (smsMessages[characterId]) {
                            const messageIndex = smsMessages[characterId].findIndex(msg => msg.id === messageId);
                            if (messageIndex > -1) {
                                smsMessages[characterId].splice(messageIndex, 1);
                            }
                        }

                        // ğŸ”¥ã€é‡è¦ã€‘ä»æ•°æ®åº“ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œä¸è§¦å‘å¼ºåˆ¶åŒæ­¥
                        await db.smsMessages.where('id').equals(messageId).delete();
                    }

                    // é€€å‡ºå¤šé€‰æ¨¡å¼
                    exitSMSMultiSelectMode();

                    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                    renderSMSMessages(characterId);

                    // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼‰
                    renderSMSMessageList();

                    showToast(`âœ… å·²åˆ é™¤ ${count} æ¡çŸ­ä¿¡æ¶ˆæ¯`, 'success');

                } catch (error) {
                    console.error('æ‰¹é‡åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯å¤±è´¥:', error);
                    showToast('åˆ é™¤æ¶ˆæ¯å¤±è´¥', 'error');
                }
            }
        }

        // åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯ï¼ˆä¿ç•™åŸæœ‰çš„å•æ¡åˆ é™¤åŠŸèƒ½ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
        async function deleteSMSMessage(messageId, characterId) {
            try {

                // ç¡®è®¤åˆ é™¤
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡çŸ­ä¿¡å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†ã€‚')) {
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆè·å–è¦åˆ é™¤çš„æ¶ˆæ¯ä¿¡æ¯ï¼Œç”¨äºåˆ é™¤ç›¸å…³æ—¶é—´çº¿è®°å½•
                let messageToDelete = null;
                if (smsMessages[characterId]) {
                    const messageIndex = smsMessages[characterId].findIndex(msg => msg.id === messageId);
                    if (messageIndex > -1) {
                        messageToDelete = smsMessages[characterId][messageIndex];
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å½•
                if (messageToDelete) {
                    try {
                        await deleteSMSRelatedTimelineEvents(messageToDelete, characterId);
                        console.log('âœ… å·²æ¸…ç†çŸ­ä¿¡ç›¸å…³çš„æ—¶é—´çº¿è®°å½•');
                    } catch (error) {
                        console.error('åˆ é™¤çŸ­ä¿¡æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
                    }
                }

                // ä»å†…å­˜ä¸­åˆ é™¤æ¶ˆæ¯
                if (smsMessages[characterId]) {
                    const messageIndex = smsMessages[characterId].findIndex(msg => msg.id === messageId);
                    if (messageIndex > -1) {
                        smsMessages[characterId].splice(messageIndex, 1);
                    }
                }

                // ğŸ”¥ã€é‡è¦ã€‘ä»æ•°æ®åº“ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œä¸è§¦å‘å¼ºåˆ¶åŒæ­¥
                await db.smsMessages.where('id').equals(messageId).delete();

                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
                renderSMSMessages(characterId);

                // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼‰
                renderSMSMessageList();

                console.log(`âœ… å·²åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯: ${messageId}`);

            } catch (error) {
                console.error('åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯å¤±è´¥:', error);
                showToast('åˆ é™¤æ¶ˆæ¯å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“çŸ­ä¿¡æ¶ˆæ¯
        function renderSMSMessages(characterId) {
            const container = document.getElementById('sms-messages-container');
            if (!container) return;

            // è·å–æ°”æ³¡é¢œè‰²è®¾ç½®
            const bubbleColor = getSMSChatSetting('bubbleColor', 'blue');

            // ç§»é™¤ç°æœ‰çš„é¢œè‰²ç±»
            container.classList.remove('green-bubble');

            // æ·»åŠ æ–°çš„é¢œè‰²ç±»
            if (bubbleColor === 'green') {
                container.classList.add('green-bubble');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–è¯¥è§’è‰²çš„çŸ­ä¿¡æ¶ˆæ¯è®°å½•
            const messages = smsMessages[characterId] || [];

            if (messages.length === 0) {
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                container.innerHTML = `
                    <div class="sms-empty-chat">
                        <p style="text-align: center; color: #999; font-size: 14px; margin-top: 50px;">
                            è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼
                        </p>
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ - iPhoneé£æ ¼çš„æ—¶é—´æ˜¾ç¤º
            let messagesHTML = '';
            let lastTimestamp = null;

            messages.forEach((message, index) => {
                const messageClass = message.isUser ? 'user-message' : 'character-message';
                const currentTime = new Date(message.timestamp);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ”¹è¿›æ—¶é—´æˆ³æ˜¾ç¤ºé€»è¾‘ï¼Œæ”¯æŒè·¨å¤©æ˜¾ç¤º - è‹¹æœçŸ­ä¿¡é£æ ¼
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                const dayBeforeYesterday = new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000);
                const messageDate = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate());

                // è®¡ç®—æ—¶é—´å·®ï¼ˆå¤©æ•°ï¼‰
                const diffTime = today.getTime() - messageDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                let timestamp = '';
                const timeString = currentTime.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (messageDate.getTime() === today.getTime()) {
                    // ä»Šå¤©çš„æ¶ˆæ¯åªæ˜¾ç¤ºæ—¶é—´
                    timestamp = timeString;
                } else if (messageDate.getTime() === yesterday.getTime()) {
                    // æ˜¨å¤©çš„æ¶ˆæ¯æ˜¾ç¤º"æ˜¨å¤© xx:xx"
                    timestamp = `æ˜¨å¤© ${timeString}`;
                } else if (messageDate.getTime() === dayBeforeYesterday.getTime()) {
                    // å‰å¤©çš„æ¶ˆæ¯æ˜¾ç¤º"å‰å¤© xx:xx"
                    timestamp = `å‰å¤© ${timeString}`;
                } else if (diffDays < 7) {
                    // æœ¬å‘¨å†…çš„æ¶ˆæ¯æ˜¾ç¤º"æ˜ŸæœŸx xx:xx"
                    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                    const weekday = weekdays[currentTime.getDay()];
                    timestamp = `${weekday} ${timeString}`;
                } else {
                    // æ›´æ—©çš„æ¶ˆæ¯æ˜¾ç¤º"æœˆ/æ—¥ xx:xx"
                    const dateString = currentTime.toLocaleDateString('zh-CN', {
                        month: 'numeric',
                        day: 'numeric'
                    });
                    timestamp = `${dateString} ${timeString}`;
                }

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³ï¼ˆæ¯5åˆ†é’Ÿæˆ–ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
                const shouldShowTime = !lastTimestamp ||
                    (currentTime - lastTimestamp) > 5 * 60 * 1000 ||
                    index === 0;

                if (shouldShowTime) {
                    messagesHTML += `<div class="sms-timestamp">${timestamp}</div>`;
                    lastTimestamp = currentTime;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å›¾ç‰‡æ¶ˆæ¯å’Œæ–‡æœ¬æ¶ˆæ¯ï¼Œæ”¯æŒå¤šæ¨¡æ€æ ¼å¼
                let messageContent = '';

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä»å¤šæ¨¡æ€æ ¼å¼ä¸­æå–æ–‡æœ¬å†…å®¹
                let textContent = '';
                if (Array.isArray(message.content)) {
                    // æ–°çš„å¤šæ¨¡æ€æ ¼å¼
                    const textPart = message.content.find(part => part.type === 'text');
                    textContent = textPart ? textPart.text : '';
                } else if (message.text) {
                    // å…¼å®¹æ—§æ ¼å¼
                    textContent = message.text;
                }

                if (message.isImage && message.imageUrl) {
                    // å›¾ç‰‡æ¶ˆæ¯ - ä¸ä½¿ç”¨æ°”æ³¡åŒ…è£¹ï¼Œç›´æ¥æ˜¾ç¤ºå›¾ç‰‡
                    const imageClickHandler = isSMSMultiSelectMode ? '' : `onclick="showImagePreview('${message.imageUrl}', '${message.fileName || 'å›¾ç‰‡'}')"`;
                    messageContent = `
                        <div class="sms-image-container">
                            <img src="${message.imageUrl}" alt="${message.fileName || 'å›¾ç‰‡'}" class="sms-image" ${imageClickHandler}>
                        </div>
                    `;
                } else {
                    // æ–‡æœ¬æ¶ˆæ¯ - ä½¿ç”¨æ°”æ³¡åŒ…è£¹
                    const escapedText = textContent
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');

                    messageContent = `
                        <div class="sms-message-bubble">
                            ${escapedText}
                        </div>
                    `;
                }

                // ğŸ”¥ã€æ–°è®¾è®¡ã€‘ç®€åŒ–æ¶ˆæ¯ç»“æ„ - é€‰ä¸­çŠ¶æ€é€šè¿‡CSSä¼ªå…ƒç´ æ˜¾ç¤ºå‹¾é€‰æ ‡è®°
                messagesHTML += `
                    <div class="sms-message ${messageClass} ${selectedSMSMessages.has(message.id) ? 'selected' : ''}" data-message-id="${message.id}" data-character-id="${characterId}">
                        ${messageContent}
                    </div>
                `;
            });

            container.innerHTML = messagesHTML;

            // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ¶ˆæ¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addSMSMessageEventListeners(characterId);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºå•ä¸ªçŸ­ä¿¡æ¶ˆæ¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addSingleSMSMessageEventListener(messageElement, characterId) {
            const messageId = messageElement.dataset.messageId;
            if (!messageId) return;

            if (isSMSMultiSelectMode) {
                // å¤šé€‰æ¨¡å¼ï¼šç‚¹å‡»åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                messageElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSMSMessageSelection(messageId);
                });
            } else {
                // æ™®é€šæ¨¡å¼ï¼šé•¿æŒ‰è¿›å…¥å¤šé€‰æ¨¡å¼
                let pressTimer = null;
                let startPos = { x: 0, y: 0 };

                // è§¦æ‘¸å¼€å§‹
                messageElement.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    startPos.x = touch.clientX;
                    startPos.y = touch.clientY;

                    pressTimer = setTimeout(() => {
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        enterSMSMultiSelectMode(messageId);
                    }, 800);
                });

                // è§¦æ‘¸ç»“æŸ
                messageElement.addEventListener('touchend', (e) => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });

                // è§¦æ‘¸ç§»åŠ¨
                messageElement.addEventListener('touchmove', (e) => {
                    if (pressTimer) {
                        const touch = e.touches[0];
                        const moveX = Math.abs(touch.clientX - startPos.x);
                        const moveY = Math.abs(touch.clientY - startPos.y);

                        if (moveX > 10 || moveY > 10) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    }
                });

                // æ¡Œé¢ç«¯é¼ æ ‡äº‹ä»¶
                messageElement.addEventListener('mousedown', (e) => {
                    if (e.button === 0) { // å·¦é”®
                        pressTimer = setTimeout(() => {
                            enterSMSMultiSelectMode(messageId);
                        }, 800);
                    }
                });

                messageElement.addEventListener('mouseup', (e) => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });

                messageElement.addEventListener('mouseleave', (e) => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
            }
        }

        // ğŸ”¥ã€ä¿ç•™ã€‘ä¸ºæ‰€æœ‰çŸ­ä¿¡æ¶ˆæ¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆç”¨äºå®Œæ•´é‡æ–°æ¸²æŸ“æ—¶ï¼‰
        function addSMSMessageEventListeners(characterId) {
            const messages = document.querySelectorAll('.sms-message');
            messages.forEach(messageElement => {
                const messageId = messageElement.dataset.messageId;
                if (!messageId) return;

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸å†ä½¿ç”¨replaceWithï¼Œç›´æ¥ä¸ºç°æœ‰å…ƒç´ æ·»åŠ ç›‘å¬å™¨
                addSingleSMSMessageEventListener(messageElement, characterId);
            });
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ å•ä¸ªçŸ­ä¿¡æ¶ˆæ¯å¹¶åº”ç”¨åŠ¨ç”»æ•ˆæœ
        function addSMSMessageWithAnimation(message, characterId) {
            const container = document.getElementById('sms-messages-container');
            if (!container || !window.currentSMSCharacter || characterId !== window.currentSMSCharacter.id) return;

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆï¼ˆä»…å¯¹AIæ¶ˆæ¯ï¼‰
            if (!message.isUser) {
                SoundManager.play(SoundManager.TYPES.MESSAGE_RECEIVED, characterId);
            }

            // è·å–æ°”æ³¡é¢œè‰²è®¾ç½®
            const bubbleColor = getSMSChatSetting('bubbleColor', 'blue');

            // ç§»é™¤ç°æœ‰çš„é¢œè‰²ç±»
            container.classList.remove('green-bubble');

            // æ·»åŠ æ–°çš„é¢œè‰²ç±»
            if (bubbleColor === 'green') {
                container.classList.add('green-bubble');
            }

            const messageClass = message.isUser ? 'user-message' : 'character-message';
            const currentTime = new Date(message.timestamp);
            const timestamp = currentTime.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³
            const existingMessages = container.querySelectorAll('.sms-message');
            let shouldShowTime = false;

            if (existingMessages.length === 0) {
                shouldShowTime = true;
            } else {
                const lastMessage = existingMessages[existingMessages.length - 1];
                const lastTimestamp = lastMessage.dataset.timestamp;
                if (!lastTimestamp || (currentTime - new Date(parseInt(lastTimestamp))) > 5 * 60 * 1000) {
                    shouldShowTime = true;
                }
            }

            // åˆ›å»ºæ—¶é—´æˆ³å…ƒç´ ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (shouldShowTime) {
                const timestampElement = document.createElement('div');
                timestampElement.className = 'sms-timestamp';
                timestampElement.textContent = timestamp;
                container.appendChild(timestampElement);
            }

            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `sms-message ${messageClass}`;
            messageElement.dataset.messageId = message.id;
            messageElement.dataset.characterId = characterId;
            messageElement.dataset.timestamp = message.timestamp;

            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å›¾ç‰‡æ¶ˆæ¯å’Œæ–‡æœ¬æ¶ˆæ¯ï¼Œæ”¯æŒå¤šæ¨¡æ€æ ¼å¼
            let messageContent = '';

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä»å¤šæ¨¡æ€æ ¼å¼ä¸­æå–æ–‡æœ¬å†…å®¹
            let textContent = '';
            if (Array.isArray(message.content)) {
                // æ–°çš„å¤šæ¨¡æ€æ ¼å¼
                const textPart = message.content.find(part => part.type === 'text');
                textContent = textPart ? textPart.text : '';
            } else if (message.text) {
                // å…¼å®¹æ—§æ ¼å¼
                textContent = message.text;
            }

            if (message.isImage && message.imageUrl) {
                // å›¾ç‰‡æ¶ˆæ¯ - ä¸ä½¿ç”¨æ°”æ³¡åŒ…è£¹ï¼Œç›´æ¥æ˜¾ç¤ºå›¾ç‰‡
                const imageClickHandler = isSMSMultiSelectMode ? '' : `onclick="showImagePreview('${message.imageUrl}', '${message.fileName || 'å›¾ç‰‡'}')"`;
                messageContent = `
                    <div class="sms-image-container">
                        <img src="${message.imageUrl}" alt="${message.fileName || 'å›¾ç‰‡'}" class="sms-image" ${imageClickHandler}>
                    </div>
                `;
            } else {
                // æ–‡æœ¬æ¶ˆæ¯ - ä½¿ç”¨æ°”æ³¡åŒ…è£¹
                const escapedText = textContent
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                messageContent = `
                    <div class="sms-message-bubble">
                        ${escapedText}
                    </div>
                `;
            }

            // ğŸ”¥ã€æ–°è®¾è®¡ã€‘ç®€åŒ–æ¶ˆæ¯å†…å®¹ï¼Œé€‰ä¸­çŠ¶æ€é€šè¿‡CSSä¼ªå…ƒç´ æ˜¾ç¤º
            messageElement.innerHTML = messageContent;

            // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ é€‰ä¸­æ ·å¼ç±»
            if (selectedSMSMessages.has(message.id)) {
                messageElement.classList.add('selected');
            } else {
                messageElement.classList.remove('selected');
            }

            // è®¾ç½®åˆå§‹åŠ¨ç”»çŠ¶æ€
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';

            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(messageElement);

            // ğŸ”¥ã€ä¿®å¤ã€‘åªä¸ºæ–°æ·»åŠ çš„æ¶ˆæ¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œè€Œä¸æ˜¯é‡æ–°ç»‘å®šæ‰€æœ‰æ¶ˆæ¯
            addSingleSMSMessageEventListener(messageElement, characterId);

            // è§¦å‘æ»‘å…¥åŠ¨ç”»
            requestAnimationFrame(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
                messageElement.style.transition = 'all 0.3s ease-out';
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // éšè—çŸ­ä¿¡èŠå¤©ç•Œé¢
        function hideSMSChat() {
            // ğŸ”¥ã€æ–°å¢ã€‘é€€å‡ºå¤šé€‰æ¨¡å¼
            if (isSMSMultiSelectMode) {
                exitSMSMultiSelectMode();
            }

            document.getElementById('sms-chat-screen').style.display = 'none';
            document.getElementById('messages-screen').style.display = 'block';
            window.currentSMSCharacter = null;
        }

        // åˆå§‹åŒ–çŸ­ä¿¡è¾“å…¥æ¡†
        function initSMSInput() {
            const input = document.getElementById('sms-message-input');
            if (!input) return;

            input.addEventListener('input', function() {
                const sendBtn = document.getElementById('sms-send-button');

                if (this.value.trim()) {
                    sendBtn.style.display = 'flex';
                } else {
                    sendBtn.style.display = 'none';
                }
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰“å¼€çŸ­ä¿¡å›¾ç‰‡é€‰æ‹©å™¨
        function openSMSImagePicker() {
            const imageInput = document.getElementById('sms-image-input');
            if (imageInput) {
                imageInput.click();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†çŸ­ä¿¡å›¾ç‰‡é€‰æ‹©
        function handleSMSImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡', 'warning');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰èŠå¤©è§’è‰²
            if (!window.currentSMSCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // è¯»å–å›¾ç‰‡å¹¶å‘é€
            const reader = new FileReader();
            reader.onload = function(e) {
                sendSMSImage(e.target.result, file.name);
            };
            reader.readAsDataURL(file);

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å‘é€çŸ­ä¿¡å›¾ç‰‡
        async function sendSMSImage(imageDataUrl, fileName) {
            if (!window.currentSMSCharacter) {
                showToast('èŠå¤©è§’è‰²ä¸å­˜åœ¨', 'error');
                return;
            }

            const characterId = window.currentSMSCharacter.id;

            try {
                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åƒchatappä¸€æ ·è¯»å–è¾“å…¥æ¡†å†…å®¹
                const smsInput = document.getElementById('sms-message-input');
                const textContent = smsInput ? smsInput.value.trim() : '';

                console.log('ğŸ” [sendSMSImage] æ–‡æœ¬å†…å®¹:', textContent);
                console.log('ğŸ” [sendSMSImage] å›¾ç‰‡URLé•¿åº¦:', imageDataUrl ? imageDataUrl.length : 0);

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åˆ›å»ºä¸chatappå®Œå…¨ä¸€è‡´çš„å¤šæ¨¡æ€æ¶ˆæ¯å¯¹è±¡
                const messageContent = [
                    { type: 'text', text: textContent }
                ];

                if (imageDataUrl) {
                    messageContent.push({
                        type: 'image_url',
                        image_url: { url: imageDataUrl }
                    });
                }

                console.log('ğŸ” [sendSMSImage] åˆ›å»ºçš„æ¶ˆæ¯å†…å®¹:', messageContent);
                console.log('ğŸ” [sendSMSImage] æ¶ˆæ¯å†…å®¹æ•°ç»„é•¿åº¦:', messageContent.length);

                const imageMessage = {
                    id: `sms-img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    content: messageContent, // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ä¸chatappç›¸åŒçš„å¤šæ¨¡æ€æ•°ç»„æ ¼å¼
                    text: textContent, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                    timestamp: Date.now(),
                    isUser: true,
                    isImage: true, // ä¿ç•™æ ‡è®°ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢è¯†åˆ«
                    imageUrl: imageDataUrl, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                    fileName: fileName
                };

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ¸…ç©ºè¾“å…¥æ¡†ï¼Œåƒchatappä¸€æ ·
                if (smsInput) {
                    smsInput.value = '';
                    // è§¦å‘è¾“å…¥äº‹ä»¶ï¼Œæ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
                    smsInput.dispatchEvent(new Event('input'));
                }

                // ğŸ”¥ã€æ·»åŠ åˆ°çŸ­ä¿¡æ¶ˆæ¯è®°å½•ã€‘
                if (!smsMessages[characterId]) {
                    smsMessages[characterId] = [];
                }
                smsMessages[characterId].push(imageMessage);

                // ğŸ”¥ã€ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“ã€‘
                await saveSingleSMSMessage(characterId, imageMessage);

                // ğŸ”¥ã€è®°å½•ç”¨æˆ·å‘é€å›¾ç‰‡åˆ°è·¨åº”ç”¨æ—¶é—´çº¿ã€‘
                try {
                    await recordCrossAppEvent(
                        characterId,
                        'sms',
                        'user_image',
                        {
                            id: characterId,
                            type: 'sms_image',
                            fileName: fileName,
                            fileSize: imageDataUrl.length,
                            chatId: characterId,
                            sender: 'user'
                        },
                        imageMessage.id
                    );
                    console.log('ğŸ“ [çŸ­ä¿¡æ—¶é—´çº¿] å·²è®°å½•ç”¨æˆ·å‘é€å›¾ç‰‡äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                } catch (error) {
                    console.error('âŒ [çŸ­ä¿¡æ—¶é—´çº¿] è®°å½•ç”¨æˆ·å‘é€å›¾ç‰‡äº‹ä»¶å¤±è´¥:', error);
                }

                // ğŸ”¥ã€ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ·»åŠ å›¾ç‰‡æ¶ˆæ¯åˆ°ç•Œé¢ã€‘
                addSMSMessageWithAnimation(imageMessage, characterId);

                // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼‰
                renderSMSMessageList();

                console.log('ğŸ”¥ [çŸ­ä¿¡å›¾ç‰‡] ç”¨æˆ·å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ');

            } catch (error) {
                console.error('å‘é€çŸ­ä¿¡å›¾ç‰‡å¤±è´¥:', error);
                showToast('å‘é€å›¾ç‰‡å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºçŸ­ä¿¡å›¾ç‰‡é¢„è§ˆ
        function showImagePreview(imageUrl, fileName) {
            // å¤ç”¨ç°æœ‰çš„å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            showImage(imageUrl);
        }

        // å¤„ç†çŸ­ä¿¡è¾“å…¥æ¡†æŒ‰é”®äº‹ä»¶
        function handleSMSInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendSMSMessage();
            }
        }

        // å‘é€çŸ­ä¿¡æ¶ˆæ¯
        async function sendSMSMessage() {
            const input = document.getElementById('sms-message-input');
            const messageText = input.value.trim();

            if (!messageText) {
                showToast('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                return;
            }

            if (!window.currentSMSCharacter) {
                showToast('èŠå¤©è§’è‰²ä¸å­˜åœ¨', 'error');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾å‘é€æ¶ˆæ¯éŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.MESSAGE_SENT, window.currentSMSCharacter?.id);

            const characterId = window.currentSMSCharacter.id;

            // ğŸ”¥ã€ä¿®å¤ã€‘åˆ›å»ºä¸chatappä¸€è‡´çš„å¤šæ¨¡æ€ç”¨æˆ·æ¶ˆæ¯å¯¹è±¡
            const userMessage = {
                id: `sms-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                content: [
                    { type: 'text', text: messageText }
                ], // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ä¸chatappç›¸åŒçš„å¤šæ¨¡æ€æ•°ç»„æ ¼å¼
                text: messageText, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                timestamp: Date.now(),
                isUser: true
            };

            // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ åˆ°çŸ­ä¿¡æ¶ˆæ¯è®°å½•
            if (!smsMessages[characterId]) {
                smsMessages[characterId] = [];
            }
            smsMessages[characterId].push(userMessage);

            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘åªä¿å­˜æ–°å¢çš„å•æ¡æ¶ˆæ¯
            await saveSingleSMSMessage(characterId, userMessage);

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•ç”¨æˆ·å‘é€çŸ­ä¿¡åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
            try {
                await recordCrossAppEvent(
                    characterId,
                    'sms',
                    'user_message',
                    {
                        id: characterId, // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDï¼Œç¡®ä¿è®°å¿†å…±äº«æ­£å¸¸å·¥ä½œ
                        type: 'sms_message',
                        content: messageText.substring(0, 100), // è®°å½•å‰100å­—ç¬¦
                        messageLength: messageText.length,
                        chatId: characterId, // çŸ­ä¿¡çš„èŠå¤©IDå°±æ˜¯è§’è‰²ID
                        sender: 'user'
                    },
                    userMessage.id
                );
                console.log('ğŸ“ [çŸ­ä¿¡æ—¶é—´çº¿] å·²è®°å½•ç”¨æˆ·å‘é€çŸ­ä¿¡äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
            } catch (error) {
                console.error('âŒ [çŸ­ä¿¡æ—¶é—´çº¿] è®°å½•ç”¨æˆ·å‘é€çŸ­ä¿¡äº‹ä»¶å¤±è´¥:', error);
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            document.getElementById('sms-send-button').style.display = 'none';

            // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addSMSMessageWithAnimation(userMessage, characterId);

            // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼‰
            renderSMSMessageList();
        }

        // è§¦å‘çŸ­ä¿¡å›å¤
        async function triggerSMSReply() {
            if (!window.currentSMSCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            const characterId = window.currentSMSCharacter.id;
            const smsMessagesList = smsMessages[characterId] || [];

            if (smsMessagesList.length === 0) {
                showToast('è¯·å…ˆå‘é€æ¶ˆæ¯', 'info');
                return;
            }

            // æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„
            const lastMessage = smsMessagesList[smsMessagesList.length - 1];
            if (!lastMessage || !lastMessage.isUser) {
                showToast('è¯·å…ˆå‘é€æ¶ˆæ¯', 'info');
                return;
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ”¶é›†ç”¨æˆ·åœ¨è¿™ä¸€è½®å‘é€çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œä¿æŒå¤šæ¨¡æ€æ ¼å¼
            const userMessages = [];
            for (let i = smsMessagesList.length - 1; i >= 0; i--) {
                const msg = smsMessagesList[i];
                if (msg.isUser) {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¼ é€’å®Œæ•´çš„å¤šæ¨¡æ€æ¶ˆæ¯å¯¹è±¡ï¼Œè€Œä¸æ˜¯åªä¼ é€’æ–‡æœ¬
                    userMessages.unshift(msg); // æ·»åŠ åˆ°å¼€å¤´ï¼Œä¿æŒæ—¶é—´é¡ºåº
                } else {
                    break; // é‡åˆ°AIæ¶ˆæ¯å°±åœæ­¢ï¼Œè¯´æ˜è¿™è½®ç”¨æˆ·æ¶ˆæ¯ç»“æŸäº†
                }
            }

            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸æ˜¾ç¤ºtoastï¼Œæ”¹ç”¨æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                // showToast('è§’è‰²æ­£åœ¨å›å¤ä¸­...', 'info');

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¼ é€’ç”¨æˆ·è¿™ä¸€è½®çš„æ‰€æœ‰æ¶ˆæ¯
                await generateSMSReply(window.currentSMSCharacter, userMessages);

            } catch (error) {
                console.error('çŸ­ä¿¡AIå›å¤å¤±è´¥:', error);
                showToast('AIå›å¤å¤±è´¥: ' + error.message, 'error');
            }
        }



        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡ä¸“ç”¨AIæç¤ºè¯æ„å»ºå‡½æ•°ï¼Œé›†æˆå…¨å±€è®°å¿†ç³»ç»Ÿ
        async function buildSMSPrompt(character, userMessages) {
            console.log('ğŸ”¥ [çŸ­ä¿¡æç¤ºè¯] å¼€å§‹æ„å»ºï¼Œè§’è‰²:', character.name);

            // ğŸ”¥ã€æ ¸å¿ƒã€‘è·å–çŸ­ä¿¡èŠå¤©è®¾ç½®ï¼ŒåŒ…æ‹¬å†å²æ¶ˆæ¯å›åˆæ•°
            const historyRounds = getSMSChatSetting('historyRounds', 50);
            console.log('ğŸ”¥ [çŸ­ä¿¡æç¤ºè¯] å†å²æ¶ˆæ¯å›åˆæ•°:', historyRounds);

            // ğŸ”¥ã€æ ¸å¿ƒã€‘è·å–çŸ­ä¿¡å†å²æ¶ˆæ¯
            const characterId = character.id;
            const smsMessagesList = smsMessages[characterId] || [];
            const recentSMSMessages = smsMessagesList.slice(-historyRounds);
            console.log('ğŸ”¥ [çŸ­ä¿¡æç¤ºè¯] çŸ­ä¿¡å†å²æ¶ˆæ¯æ•°é‡:', recentSMSMessages.length);

            // ğŸ”¥ã€æ ¸å¿ƒã€‘è·å–ç”¨æˆ·åœ¨çŸ­ä¿¡èŠå¤©ä¸­è®¾ç½®çš„èº«ä»½é¢å…·
            const chatSettingsKey = character.id;
            const smsChatSettings = chatSettings[chatSettingsKey] || {};
            const selectedPersona = smsChatSettings.selectedIdentityId ?
                personas.find(p => p.id === smsChatSettings.selectedIdentityId) : null;

            console.log('ğŸ”¥ [çŸ­ä¿¡æç¤ºè¯] ç”¨æˆ·èº«ä»½é¢å…·:', selectedPersona?.name || 'é»˜è®¤èº«ä»½');

            // ğŸ”¥ã€æ ¸å¿ƒã€‘æ£€æŸ¥è§’è‰²æ˜¯å¦è¢«æ‹‰é»‘ï¼ŒçŸ­ä¿¡appä½œä¸ºèŠå¤©è¾…åŠ©å·¥å…·çš„ç‰¹æ®Šé€»è¾‘
            const isUserBlocked = isBlocked('user', character.id);
            const isCharacterBlocked = isBlocked(character.id, 'user');

            // ğŸ”¥ã€æ ¸å¿ƒã€‘è·å–æ—¶é—´ä¿¡æ¯ï¼ˆä¸ChatAppä¿æŒä¸€è‡´ï¼‰
            const now = new Date();
            const currentTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });

            // è·å–å­£èŠ‚å’Œæ—¶é—´æ®µä¿¡æ¯
            const month = now.getMonth() + 1;
            let season = '';
            if (month >= 3 && month <= 5) season = 'æ˜¥å­£';
            else if (month >= 6 && month <= 8) season = 'å¤å­£';
            else if (month >= 9 && month <= 11) season = 'ç§‹å­£';
            else season = 'å†¬å­£';

            const hour = now.getHours();
            let timeOfDay = '';
            if (hour >= 5 && hour < 8) timeOfDay = 'æ¸…æ™¨';
            else if (hour >= 8 && hour < 11) timeOfDay = 'ä¸Šåˆ';
            else if (hour >= 11 && hour < 14) timeOfDay = 'ä¸­åˆ';
            else if (hour >= 14 && hour < 17) timeOfDay = 'ä¸‹åˆ';
            else if (hour >= 17 && hour < 19) timeOfDay = 'å‚æ™š';
            else if (hour >= 19 && hour < 22) timeOfDay = 'æ™šä¸Š';
            else if (hour >= 22 || hour < 2) timeOfDay = 'æ·±å¤œ';
            else timeOfDay = 'å‡Œæ™¨';

            const timeInfo = `- **å½“å‰æ—¶é—´:** ${currentTime}\n- **å­£èŠ‚:** ${season}ï¼Œ${timeOfDay}æ—¶åˆ†`;

            // ğŸ”¥ã€æ ¸å¿ƒã€‘æ„å»ºçŸ­ä¿¡ä¸“ç”¨çš„è§’è‰²æç¤ºè¯
            let smsPrompt = `# **çŸ­ä¿¡èŠå¤©æ¨¡å¼ - ${character.name}**

## **è¾“å‡ºæ ¼å¼è¦æ±‚**
ä½ çš„å›å¤å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œä½†çŸ­ä¿¡é€šå¸¸æ¯”è¾ƒç®€æ´ï¼š
- **å•æ¡çŸ­ä¿¡:** \`["ä½ å¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"]\`
- **å¤šæ¡çŸ­ä¿¡:** \`["ä½ å¥½ï¼", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹å—ï¼Ÿ"]\`
- **åªèƒ½åŒ…å«çº¯æ–‡æœ¬å­—ç¬¦ä¸²:** æ•°ç»„ä¸­åªèƒ½æœ‰å­—ç¬¦ä¸²ï¼Œä¸èƒ½æœ‰ä»»ä½•å¯¹è±¡
- **ç»å¯¹ç¦æ­¢:** ä¸è¦è¾“å‡ºä»£ç å—ã€ä¸è¦æœ‰\`\`\`jsonæ ‡è®°
- **ç»å¯¹ç¦æ­¢:** ä¸è¦ä½¿ç”¨ {"type": "reply_to"} ç­‰å¯¹è±¡æ ¼å¼

## **ä½ çš„è§’è‰²ä¸ä»»åŠ¡**
ä½ ç°åœ¨æ‰®æ¼”åä¸º"${character.name}"çš„è§’è‰²ï¼Œé€šè¿‡çŸ­ä¿¡ä¸ç”¨æˆ·è¿›è¡Œå¯¹è¯ã€‚

## **è§’è‰²è®¾å®š:**
${character.bio || character.prompt || 'æš‚æ— è¯¦ç»†äººè®¾'}

## **å½“å‰æƒ…æ™¯:**
${timeInfo}

## **çŸ­ä¿¡èŠå¤©ç‰¹ç‚¹:**
- **æ¶ˆæ¯ç®€æ´**: æ¯æ¡çŸ­ä¿¡1-2å¥è¯ï¼Œå¯ä»¥å‘é€1-3æ¡
- **è¯­æ°”è‡ªç„¶**: ç¬¦åˆçŸ­ä¿¡èŠå¤©çš„è½»æ¾èŠ‚å¥
- **çº¯æ–‡æœ¬äº¤æµ**: åªèƒ½å‘é€æ™®é€šæ–‡å­—æ¶ˆæ¯
- **æ”¯æŒåŠŸèƒ½**: å¯ä»¥å‘é€æ–‡å­—å½¢å¼çš„ç…§ç‰‡æè¿°ï¼Œå¦‚"[ç…§ç‰‡ï¼šæˆ‘åˆšæ‹çš„çª—å¤–é£æ™¯]"
- **ä¸æ”¯æŒåŠŸèƒ½**:
  * ä¸æ”¯æŒå¼•ç”¨å›å¤ (reply_to)
  * ä¸æ”¯æŒè¡¨æƒ…åŒ…ã€è¯­éŸ³ã€è§†é¢‘
  * ä¸æ”¯æŒè½¬è´¦ã€å®šä½ç­‰å¤æ‚åŠŸèƒ½
  * ä¸æ”¯æŒä»»ä½•å¯¹è±¡æ ¼å¼çš„æ¶ˆæ¯
- **è®°å¿†è¿è´¯**: ä¸ChatAppå…±äº«è®°å¿†ï¼Œä¿æŒè§’è‰²ä¸€è‡´æ€§`;

            // ğŸ”¥ã€æ ¸å¿ƒã€‘æ·»åŠ æ‹‰é»‘çŠ¶æ€çš„ç‰¹æ®Šæç¤º
            if (isUserBlocked) {
                smsPrompt += `\n\n## ç‰¹æ®Šæƒ…å†µè¯´æ˜
ç”¨æˆ·åœ¨èŠå¤©åº”ç”¨ä¸­æ‹‰é»‘äº†ä½ ï¼Œä½†ä½ ç°åœ¨é€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·ã€‚ä½ å¯èƒ½ä¼šï¼š
- è¡¨è¾¾æƒ³è¦å’Œè§£çš„æ„æ„¿
- è§£é‡Šä¹‹å‰çš„è¯¯ä¼š
- è¯·æ±‚ç”¨æˆ·ç»™ä½ ä¸€ä¸ªæœºä¼š
- è¡¨ç°å‡ºçœŸè¯šçš„æ€åº¦
è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œä¹‹å‰çš„äº’åŠ¨å†å²æ¥å›åº”ã€‚`;
            } else if (isCharacterBlocked) {
                smsPrompt += `\n\n## ç‰¹æ®Šæƒ…å†µè¯´æ˜
ä½ åœ¨èŠå¤©åº”ç”¨ä¸­æ‹‰é»‘äº†ç”¨æˆ·ï¼Œä½†ç”¨æˆ·ç°åœ¨é€šè¿‡çŸ­ä¿¡è”ç³»ä½ ã€‚ä½ å¯èƒ½ä¼šï¼š
- ä¿æŒä¹‹å‰çš„æ€åº¦æˆ–æœ‰æ‰€è½¯åŒ–
- æ ¹æ®ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹å†³å®šæ˜¯å¦å›åº”
- è¡¨ç°å‡ºç¬¦åˆä½ æ€§æ ¼çš„ååº”
è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œæ‹‰é»‘çš„åŸå› æ¥å›åº”ã€‚`;
            }

            // ğŸ”¥ã€æ ¸å¿ƒã€‘æ·»åŠ ç”¨æˆ·èº«ä»½ä¿¡æ¯
            if (selectedPersona) {
                smsPrompt += `\n\n## å¯¹è¯è€…èº«ä»½
ç”¨æˆ·åœ¨è¿™ä¸ªçŸ­ä¿¡èŠå¤©ä¸­çš„èº«ä»½æ˜¯ï¼š${selectedPersona.name}
èº«ä»½æè¿°ï¼š${selectedPersona.description || 'æ— è¯¦ç»†æè¿°'}
è¯·æ ¹æ®ç”¨æˆ·çš„è¿™ä¸ªèº«ä»½æ¥è¿›è¡ŒçŸ­ä¿¡å¯¹è¯ã€‚`;
            }

            // ğŸ”¥ã€æ ¸å¿ƒã€‘é›†æˆä¸–ç•Œä¹¦ç³»ç»Ÿï¼ˆä¸ChatAppä¿æŒä¸€è‡´ï¼‰
            const localBookIds = smsChatSettings.selectedWorldbooks || [];
            const globalBooks = window.activeGlobalWorldbooks || [];
            const allBookIds = [...new Set([...globalBooks, ...localBookIds])];

            if (allBookIds.length > 0) {
                smsPrompt += `\n\n## èƒŒæ™¯çŸ¥è¯†/ä¸–ç•Œè§‚
ä»¥ä¸‹æ˜¯ç›¸å…³çš„è®¾å®šä¿¡æ¯ï¼Œè¯·åœ¨çŸ­ä¿¡å¯¹è¯ä¸­è‡ªç„¶åœ°è¿ç”¨ï¼š\n`;
                allBookIds.forEach(bookId => {
                    const worldbook = worldbooks.find(w => w.id === bookId);
                    if (worldbook) {
                        smsPrompt += `\n--- ${worldbook.title} ---\n${worldbook.content}\n`;
                    }
                });
            }

            // ğŸ”¥ã€æ ¸å¿ƒã€‘é›†æˆåŠ¨æ€è®°å¿†ç³»ç»Ÿå ä½ç¬¦
            if (smsChatSettings.enableDynamicMemory !== false) {
                smsPrompt += `\n\n<!-- DYNAMIC_MEMORY_PLACEHOLDER -->`;
            }

            return smsPrompt;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡ä¸“ç”¨APIè°ƒç”¨å‡½æ•°
        async function callSMSAPI(userMessage, character) {
            try {
                console.log('ğŸ”¥ [çŸ­ä¿¡API] å¼€å§‹è°ƒç”¨ï¼Œè§’è‰²:', character.name);

                // è·å–çŸ­ä¿¡å†å²æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
                const characterId = character.id;
                const smsMessagesList = smsMessages[characterId] || [];
                const historyRounds = getSMSChatSetting('historyRounds', 50);
                const recentSMSMessages = smsMessagesList.slice(-historyRounds);

                // æ„å»ºæ¶ˆæ¯å†å²
                let conversationHistory = '';
                if (recentSMSMessages.length > 0) {
                    conversationHistory = '\n\n## çŸ­ä¿¡å¯¹è¯å†å²\n';
                    recentSMSMessages.forEach(msg => {
                        const sender = msg.isUser ? 'ç”¨æˆ·' : character.name;
                        conversationHistory += `${sender}: ${msg.text}\n`;
                    });
                }

                let fullPrompt = '';

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ¤æ–­æ˜¯å›å¤ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯ä¸»åŠ¨å‘èµ·å¯¹è¯
                if (userMessage.includes('ä½ è¢«ç”¨æˆ·åœ¨èŠå¤©åº”ç”¨ä¸­æ‹‰é»‘äº†') ||
                    userMessage.includes('ç”¨æˆ·æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·') ||
                    userMessage.includes('ä½ æƒ³ä¸»åŠ¨é€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·')) {
                    // è¿™æ˜¯ä¸»åŠ¨è”ç³»çš„åœºæ™¯
                    const smsPrompt = await buildSMSPrompt(character, '');
                    fullPrompt = smsPrompt + conversationHistory + `\n\n## ä¸»åŠ¨è”ç³»åœºæ™¯\n${userMessage}\n\n## å›å¤è¦æ±‚\nè¯·ä»¥${character.name}çš„èº«ä»½å‘é€çŸ­ä¿¡æ¶ˆæ¯ã€‚è¦æ±‚ï¼š\n- ä½“ç°çŸ­ä¿¡èŠå¤©çš„ç®€æ´ç‰¹ç‚¹ï¼Œé€šå¸¸1-3æ¡æ¶ˆæ¯\n- ä¿æŒä¸ChatAppä¸­ç›¸åŒçš„è§’è‰²æ€§æ ¼å’Œè®°å¿†è¿è´¯æ€§\n- å¯ä»¥å»¶ç»­ä¹‹å‰åœ¨ChatAppä¸­çš„è¯é¢˜æˆ–æƒ…æ„ŸçŠ¶æ€\n- ã€é‡è¦ã€‘å¿…é¡»ä½¿ç”¨JSONæ•°ç»„æ ¼å¼å›å¤\n- ä½“ç°"çœŸäººå¯¹è¯"çš„è‡ªç„¶æ„Ÿ\n- å¦‚æœéœ€è¦å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œè¯·åˆ†åˆ«æ”¾åœ¨æ•°ç»„ä¸­\n\nè¯·å›å¤JSONæ ¼å¼çš„çŸ­ä¿¡å†…å®¹ï¼š`;
                } else {
                    // è¿™æ˜¯å›å¤ç”¨æˆ·æ¶ˆæ¯çš„åœºæ™¯
                    const smsPrompt = await buildSMSPrompt(character, userMessage);
                    fullPrompt = smsPrompt + conversationHistory + `\n\n## å½“å‰ç”¨æˆ·æ¶ˆæ¯\nç”¨æˆ·: ${userMessage}\n\n## å›å¤è¦æ±‚\nè¯·ä»¥${character.name}çš„èº«ä»½å›å¤è¿™æ¡çŸ­ä¿¡ã€‚è¦æ±‚ï¼š\n- ä½“ç°çŸ­ä¿¡èŠå¤©çš„ç®€æ´ç‰¹ç‚¹ï¼Œé€šå¸¸1-3æ¡æ¶ˆæ¯\n- ä¿æŒä¸ChatAppä¸­ç›¸åŒçš„è§’è‰²æ€§æ ¼å’Œè®°å¿†è¿è´¯æ€§\n- å¯ä»¥å»¶ç»­ä¹‹å‰åœ¨ChatAppä¸­çš„è¯é¢˜æˆ–æƒ…æ„ŸçŠ¶æ€\n- ã€é‡è¦ã€‘å¿…é¡»ä½¿ç”¨JSONæ•°ç»„æ ¼å¼å›å¤\n- ä½“ç°"çœŸäººå¯¹è¯"çš„è‡ªç„¶æ„Ÿ\n- å¦‚æœéœ€è¦å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œè¯·åˆ†åˆ«æ”¾åœ¨æ•°ç»„ä¸­\n\nè¯·å›å¤JSONæ ¼å¼çš„çŸ­ä¿¡å†…å®¹ï¼š`;
                }

                // ğŸ”¥ã€æ ¸å¿ƒã€‘é›†æˆåŠ¨æ€è®°å¿†ç³»ç»Ÿåˆ°çŸ­ä¿¡æç¤ºè¯
                if (fullPrompt.includes('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->')) {
                    try {
                        let memoryReplacement = '';

                        // è·å–æ ¸å¿ƒè®°å¿†
                        const coreMemories = await db.coreMemories
                            .where('characterId')
                            .equals(character.id)
                            .toArray();

                        if (coreMemories.length > 0) {
                            const sortedCoreMemories = coreMemories.sort((a, b) => b.importance - a.importance);
                            memoryReplacement += '\n\nã€æ ¸å¿ƒè®°å¿†ã€‘ä»¥ä¸‹æ˜¯é‡è¦çš„è®°å¿†ï¼š\n';
                            sortedCoreMemories.forEach((memory, index) => {
                                memoryReplacement += `${index + 1}. ${memory.fact}\n`;
                            });
                        }

                        // è·å–æƒ…æ™¯è®°å¿†
                        const episodicMemories = await db.episodicMemories
                            .where('characterId')
                            .equals(character.id)
                            .toArray();

                        const recentEpisodicMemories = episodicMemories
                            .sort((a, b) => b.timestamp - a.timestamp)
                            .slice(0, 5); // çŸ­ä¿¡ä¸­æ˜¾ç¤ºè¾ƒå°‘çš„è®°å¿†

                        if (recentEpisodicMemories.length > 0) {
                            memoryReplacement += '\n\nã€æƒ…æ™¯è®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„é‡è¦ç»å†ï¼š\n';
                            recentEpisodicMemories.forEach((memory, index) => {
                                memoryReplacement += `${index + 1}. ${memory.fact}\n`;
                            });
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–åŠ¨æ€è®°å¿†ï¼ˆåŒ…å«è¯„è®ºåŒºï¼‰
                        const recentMoments = await getVisibleMomentsForCharacter(character.id, 3); // çŸ­ä¿¡ä¸­æ˜¾ç¤ºè¾ƒå°‘çš„åŠ¨æ€
                        if (recentMoments.length > 0) {
                            memoryReplacement += '\n\nã€åŠ¨æ€è®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„åŠ¨æ€å’Œè®¨è®ºï¼š\n';
                            recentMoments.forEach((moment, index) => {
                                const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                                // æ·»åŠ æ—¶é—´ä¿¡æ¯
                                let timeInfo = '';
                                if (moment.timestamp) {
                                    const now = Date.now();
                                    const timeDiff = now - moment.timestamp;
                                    const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                                    if (days > 0) {
                                        timeInfo = ` (${days}å¤©å‰)`;
                                    } else if (hours > 0) {
                                        timeInfo = ` (${hours}å°æ—¶å‰)`;
                                    } else {
                                        timeInfo = ' (æœ€è¿‘)';
                                    }
                                }

                                // åŒ…å«è¯„è®ºåŒºå†…å®¹
                                const momentContent = `${index + 1}. ${authorName}: ${moment.text}${timeInfo}${moment.commentsText || ''}`;
                                memoryReplacement += momentContent;
                            });
                        }

                        // è·å–è·¨åº”ç”¨æ—¶é—´çº¿
                        const timeline = await getCrossAppTimeline(character.id, 5); // çŸ­ä¿¡ä¸­æ˜¾ç¤ºè¾ƒå°‘çš„æ—¶é—´çº¿
                        if (timeline.length > 0) {
                            memoryReplacement += '\n\nã€æœ€è¿‘æ´»åŠ¨ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„è·¨åº”ç”¨æ´»åŠ¨ï¼š\n';
                            timeline.forEach((event, index) => {
                                const timeStr = new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                                let description = '';

                                switch (event.appType) {
                                    case 'music':
                                        description = `åœ¨éŸ³ä¹åº”ç”¨ä¸­${event.context.action === 'listen_together' ? 'ä¸€èµ·å¬æ­Œ' : 'å‘è¡¨è¯„è®º'}`;
                                        break;
                                    case 'game':
                                        description = `åœ¨æ¸¸æˆåº”ç”¨ä¸­${event.context.action === 'play_together' ? 'ä¸€èµ·æ¸¸æˆ' : 'äº’åŠ¨'}`;
                                        break;
                                    case 'chat':
                                        description = event.action === 'message' ? 'ç”¨æˆ·å‘é€æ¶ˆæ¯' : 'AIå›å¤æ¶ˆæ¯';
                                        break;
                                    case 'sms':
                                        if (event.action === 'user_message') {
                                            description = 'ç”¨æˆ·å‘é€çŸ­ä¿¡';
                                        } else if (event.action === 'ai_reply') {
                                            description = 'AIå›å¤çŸ­ä¿¡';
                                        } else if (event.action === 'character_initiate') {
                                            description = 'AIä¸»åŠ¨å‘é€çŸ­ä¿¡';
                                        } else {
                                            description = 'çŸ­ä¿¡äº’åŠ¨';
                                        }
                                        break;
                                    default:
                                        description = `åœ¨${event.appType}ä¸­è¿›è¡Œ${event.action}`;
                                }

                                memoryReplacement += `${timeStr} - ${description}\n`;
                            });
                        }

                        // æ›¿æ¢å ä½ç¬¦
                        if (memoryReplacement) {
                            fullPrompt = fullPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', memoryReplacement);
                        } else {
                            fullPrompt = fullPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', '');
                        }

                    } catch (error) {
                        console.error('ğŸ”¥ [çŸ­ä¿¡API] è·å–è®°å¿†æ•°æ®å¤±è´¥:', error);
                        fullPrompt = fullPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', '');
                    }
                }

                console.log('ğŸ”¥ [çŸ­ä¿¡API] æ„å»ºçš„å®Œæ•´æç¤ºè¯:', fullPrompt);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æµ‹æ˜¯å¦æ˜¯Gemini APIå¹¶ä½¿ç”¨ç›¸åº”æ ¼å¼
                const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
                let response, data, aiReply;

                if (isGemini) {
                    // Gemini API æ ¼å¼
                    const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                role: 'user',
                                parts: [{ text: fullPrompt }]
                            }],
                            generationConfig: {
                                temperature: 0.8
                                // ä¸æ·»åŠ maxOutputTokensï¼ŒGeminiä¸æ”¯æŒè¿™ä¸ªå‚æ•°
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Gemini APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }

                    data = await response.json();
                    aiReply = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!aiReply) {
                        console.log('ğŸ”¥ [çŸ­ä¿¡API] Geminiå“åº”æ•°æ®:', data);
                        throw new Error('Gemini APIè¿”å›äº†ç©ºå†…å®¹');
                    }
                } else {
                    // OpenAI æ ¼å¼ - ğŸ”¥ã€ä¿®å¤ã€‘æ™ºèƒ½å¤„ç†URLæ‹¼æ¥ï¼Œæ”¯æŒæŠ±è„¸è½®è¯¢
                    let apiUrl;
                    if (apiSettings.base.endsWith('/v1')) {
                        apiUrl = `${apiSettings.base}/chat/completions`;
                    } else if (apiSettings.base.includes('/v1/')) {
                        // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                        apiUrl = `${apiSettings.base}/chat/completions`;
                    } else {
                        apiUrl = `${apiSettings.base}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiSettings.key}`
                        },
                        body: JSON.stringify({
                            model: apiSettings.model,
                            messages: [
                                {
                                    role: 'user',
                                    content: fullPrompt
                                }
                            ],
                            temperature: 0.8,
                            max_tokens: 200, // çŸ­ä¿¡å›å¤ä¸éœ€è¦å¤ªé•¿
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }

                    data = await response.json();
                    aiReply = data.choices?.[0]?.message?.content;

                    if (!aiReply) {
                        console.log('ğŸ”¥ [çŸ­ä¿¡API] OpenAIå“åº”æ•°æ®:', data);
                        throw new Error('APIè¿”å›äº†ç©ºå†…å®¹');
                    }
                }

                aiReply = aiReply.trim();
                console.log('ğŸ”¥ [çŸ­ä¿¡API] AIåŸå§‹å›å¤:', aiReply);

                return aiReply;

            } catch (error) {
                console.error('çŸ­ä¿¡APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡ä¸“ç”¨AIå›å¤ç”Ÿæˆå‡½æ•°
        async function generateSMSReply(character, userMessages) {
            try {
                console.log('ğŸ”¥ [çŸ­ä¿¡AIå›å¤] å¼€å§‹ç”Ÿæˆå›å¤ï¼Œè§’è‰²:', character.name, 'ç”¨æˆ·æ¶ˆæ¯:', userMessages);

                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                showSMSTypingIndicator();

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ¶ˆæ¯ï¼Œå†³å®šä½¿ç”¨å“ªç§AIè°ƒç”¨æ–¹å¼
                console.log('ğŸ” [generateSMSReply] æ”¶åˆ°çš„ç”¨æˆ·æ¶ˆæ¯:', userMessages);

                let hasImageMessage = false;
                let combinedContent = [];

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡
                if (Array.isArray(userMessages)) {
                    userMessages.forEach(msg => {
                        if (Array.isArray(msg.content)) {
                            // å¤šæ¨¡æ€æ¶ˆæ¯
                            combinedContent.push(...msg.content);
                            const hasImage = msg.content.some(item => item.type === 'image_url');
                            if (hasImage) {
                                hasImageMessage = true;
                                console.log('ğŸ” [generateSMSReply] æ£€æµ‹åˆ°å›¾ç‰‡æ¶ˆæ¯');
                            }
                        } else {
                            // å…¼å®¹æ—§æ ¼å¼æ–‡æœ¬æ¶ˆæ¯
                            combinedContent.push({ type: 'text', text: msg.text || msg });
                        }
                    });
                } else {
                    // å•ä¸ªæ¶ˆæ¯
                    if (Array.isArray(userMessages.content)) {
                        combinedContent = userMessages.content;
                        hasImageMessage = userMessages.content.some(item => item.type === 'image_url');
                    } else {
                        combinedContent = [{ type: 'text', text: userMessages.text || userMessages }];
                    }
                }

                console.log('ğŸ” [generateSMSReply] åˆå¹¶åçš„å†…å®¹:', combinedContent);
                console.log('ğŸ” [generateSMSReply] æ˜¯å¦åŒ…å«å›¾ç‰‡:', hasImageMessage);

                let response;

                if (hasImageMessage) {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæœ‰å›¾ç‰‡ï¼Œéœ€è¦æ„å»ºåŒ…å«JSONæ ¼å¼è¦æ±‚çš„æç¤ºè¯
                    console.log('ğŸ” [generateSMSReply] ä½¿ç”¨å¤šæ¨¡æ€APIè°ƒç”¨');

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¸ºå¤šæ¨¡æ€æ¶ˆæ¯æ„å»ºçŸ­ä¿¡æ ¼å¼çš„æç¤ºè¯
                    const smsPrompt = await buildSMSPrompt(character, userMessages);

                    // æ„å»ºåŒ…å«å›¾ç‰‡çš„å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œä½†æ·»åŠ çŸ­ä¿¡æ ¼å¼è¦æ±‚
                    const textContent = combinedContent.find(item => item.type === 'text')?.text || '';
                    const imageContent = combinedContent.find(item => item.type === 'image_url');

                    // æ„å»ºå¤šæ¨¡æ€æ¶ˆæ¯æ•°ç»„ï¼ŒåŒ…å«çŸ­ä¿¡ç‰¹æ®Šæ ¼å¼è¦æ±‚
                    const multimodalMessage = [
                        {
                            type: 'text',
                            text: `${smsPrompt}\n\n## å½“å‰ç”¨æˆ·æ¶ˆæ¯\nç”¨æˆ·å‘é€äº†å›¾ç‰‡${textContent ? `å¹¶è¯´: ${textContent}` : ''}\n\n## å›å¤è¦æ±‚\nè¯·ä»¥${character.name}çš„èº«ä»½å›å¤è¿™æ¡çŸ­ä¿¡ï¼š\n- å‘é€1-3æ¡ç®€æ´çš„çŸ­ä¿¡\n- ä¿æŒè§’è‰²æ€§æ ¼å’Œè®°å¿†è¿è´¯æ€§\n- ä»”ç»†è§‚å¯Ÿå›¾ç‰‡å†…å®¹å¹¶ç»™å‡ºç›¸åº”å›å¤\n- ã€é‡è¦ã€‘å¿…é¡»è¾“å‡ºçº¯å­—ç¬¦ä¸²JSONæ•°ç»„ï¼Œä¸è¦ä»£ç å—æ ‡è®°\n- ã€é‡è¦ã€‘åªèƒ½åŒ…å«çº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¸èƒ½æœ‰ä»»ä½•å¯¹è±¡\n- ã€ç¦æ­¢ã€‘ä¸è¦ä½¿ç”¨ {"type": "reply_to"} ç­‰å¯¹è±¡æ ¼å¼\n- æ­£ç¡®æ ¼å¼ï¼š["å›å¤å†…å®¹1", "å›å¤å†…å®¹2"]\n- é”™è¯¯æ ¼å¼ï¼š[{"type": "reply_to", "content": "..."}]\n\nè¯·å›å¤ï¼š`
                        }
                    ];

                    if (imageContent) {
                        multimodalMessage.push(imageContent);
                    }

                    response = await callChatAPI(multimodalMessage, character);
                } else {
                    // ğŸ”¥ã€ä¿æŒåŸæœ‰é€»è¾‘ã€‘å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œä½¿ç”¨åŸæœ‰çš„çŸ­ä¿¡ä¸“ç”¨é€»è¾‘ï¼ˆä¿æŒè®°å¿†åŠŸèƒ½ï¼‰
                    console.log('ğŸ” [generateSMSReply] ä½¿ç”¨çŸ­ä¿¡ä¸“ç”¨APIè°ƒç”¨');
                    const smsPrompt = await buildSMSPrompt(character, userMessages);

                    // æ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼ŒåŒ…æ‹¬å†å²æ¶ˆæ¯
                    const characterId = character.id;
                    const smsMessagesList = smsMessages[characterId] || [];
                    const historyRounds = getSMSChatSetting('historyRounds', 50);
                    const recentSMSMessages = smsMessagesList.slice(-historyRounds);

                    let conversationHistory = '';
                    if (recentSMSMessages.length > 0) {
                        conversationHistory = '\n\n## çŸ­ä¿¡å¯¹è¯å†å²\n';
                        recentSMSMessages.forEach(msg => {
                            const sender = msg.isUser ? 'ç”¨æˆ·' : character.name;
                            const msgText = Array.isArray(msg.content) ?
                                (msg.content.find(p => p.type === 'text')?.text || '[å¤šåª’ä½“æ¶ˆæ¯]') :
                                (msg.text || '[æ¶ˆæ¯]');
                            conversationHistory += `${sender}: ${msgText}\n`;
                        });
                    }

                    // æ„å»ºå½“å‰ç”¨æˆ·æ¶ˆæ¯éƒ¨åˆ†
                    let currentUserMessages = '\n\n## å½“å‰ç”¨æˆ·æ¶ˆæ¯\n';
                    if (Array.isArray(userMessages)) {
                        userMessages.forEach((msg) => {
                            const msgText = Array.isArray(msg.content) ?
                                (msg.content.find(p => p.type === 'text')?.text || '[å¤šåª’ä½“æ¶ˆæ¯]') :
                                (msg.text || msg);
                            currentUserMessages += `ç”¨æˆ·: ${msgText}\n`;
                        });
                    } else {
                        currentUserMessages += `ç”¨æˆ·: ${userMessages}\n`;
                    }

                    const fullPrompt = smsPrompt + conversationHistory + currentUserMessages + `\n## å›å¤è¦æ±‚\nè¯·ä»¥${character.name}çš„èº«ä»½å›å¤è¿™äº›çŸ­ä¿¡ï¼š\n- å‘é€1-3æ¡ç®€æ´çš„çŸ­ä¿¡\n- ä¿æŒè§’è‰²æ€§æ ¼å’Œè®°å¿†è¿è´¯æ€§\n- ç›´æ¥è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦ä»£ç å—æ ‡è®°\n\nè¯·å›å¤ï¼š`;

                    response = await generateAIResponse(fullPrompt, character);
                }

                // ğŸ”¥ã€ç§»é™¤é”™è¯¯çš„è½¬æ¢é€»è¾‘ã€‘
                // AIåº”è¯¥ç›´æ¥è¿”å›JSONæ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–è½¬æ¢
                console.log('ğŸ”¥ [çŸ­ä¿¡AIå›å¤] AIåŸå§‹å›å¤:', response);

                // ğŸ”¥ã€å¢å¼ºã€‘çŸ­ä¿¡å›å¤å¤„ç†ï¼Œæ”¯æŒJSONæ ¼å¼å’Œå¤šæ¡æ¶ˆæ¯
                if (response && response.trim()) {
                    let messages = [];

                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†å¯èƒ½çš„ä»£ç å—æ ‡è®°
                        let cleanResponse = response.trim();

                        // ç§»é™¤å¯èƒ½çš„ä»£ç å—æ ‡è®°
                        cleanResponse = cleanResponse.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                        cleanResponse = cleanResponse.replace(/^```\s*/, '').replace(/\s*```$/, '');

                        // å°è¯•è§£æJSONæ ¼å¼
                        const parsedResponse = JSON.parse(cleanResponse);
                        if (Array.isArray(parsedResponse)) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘åªä¿ç•™çº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè¿‡æ»¤æ‰å¤æ‚å¯¹è±¡ï¼ˆå¼•ç”¨ã€è¡¨æƒ…åŒ…ç­‰ï¼‰
                            messages = parsedResponse.filter(msg => {
                                return msg && typeof msg === 'string' && msg.trim();
                            });
                        } else if (typeof parsedResponse === 'string') {
                            messages = [parsedResponse];
                        } else {
                            // å¦‚æœä¸æ˜¯æ•°ç»„ä¹Ÿä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå½“ä½œå•æ¡æ¶ˆæ¯å¤„ç†
                            messages = [response.trim()];
                        }
                    } catch (error) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•æå–å¼•å·å†…çš„å†…å®¹
                        console.log('ğŸ”¥ [çŸ­ä¿¡AIå›å¤] JSONè§£æå¤±è´¥ï¼Œå°è¯•æå–æ–‡æœ¬:', error);
                        const quotedMatches = response.match(/"([^"]+)"/g);
                        if (quotedMatches) {
                            messages = quotedMatches.map(match => match.slice(1, -1)).filter(msg => msg.trim());
                        } else {
                            // æœ€åå›é€€åˆ°æŒ‰æ¢è¡Œåˆ†éš”
                            messages = response.trim().split('\n').filter(msg => msg.trim());
                        }
                    }

                    // ç¡®ä¿çŸ­ä¿¡æ¶ˆæ¯è®°å½•å­˜åœ¨
                    if (!smsMessages[character.id]) {
                        smsMessages[character.id] = [];
                    }

                    // ğŸ”¥ã€æ ¸å¿ƒã€‘é€æ¡å‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººå‘æ¶ˆæ¯çš„æ•ˆæœ
                    for (let i = 0; i < messages.length; i++) {
                        const messageText = messages[i].trim();
                        if (messageText) {
                            // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ·»åŠ å»¶è¿Ÿå’Œæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                            if (i > 0) {
                                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                                showSMSTypingIndicator();

                                // éšæœºå»¶è¿Ÿ500-1500msï¼Œæ¨¡æ‹ŸçœŸäººæ€è€ƒå’Œæ‰“å­—æ—¶é—´
                                const delay = Math.random() * 1000 + 500;
                                await new Promise(resolve => setTimeout(resolve, delay));

                                // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                                hideSMSTypingIndicator();
                            }

                            const aiReplyMessage = {
                                id: `sms-ai-${Date.now()}-${i}-${Math.random().toString(36).substr(2, 9)}`,
                                content: [
                                    { type: 'text', text: messageText }
                                ], // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ä¸chatappç›¸åŒçš„å¤šæ¨¡æ€æ•°ç»„æ ¼å¼
                                text: messageText, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                                timestamp: Date.now() + i * 100, // ç¡®ä¿æ—¶é—´æˆ³ä¸åŒï¼Œæ¯æ¡æ¶ˆæ¯é—´éš”100ms
                                isUser: false
                            };

                            // æ·»åŠ åˆ°çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                            smsMessages[character.id].push(aiReplyMessage);

                            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ä¿å­˜æ¯æ¡AIå›å¤æ¶ˆæ¯
                            await saveSingleSMSMessage(character.id, aiReplyMessage);

                            // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
                            addSMSMessageWithAnimation(aiReplyMessage, character.id);

                            // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºçŸ­ä¿¡AIå›å¤åˆ›å»ºæ¨é€é€šçŸ¥
                            createSMSPushNotification(character, aiReplyMessage.text, i * 500);

                            // çŸ­æš‚å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯å¼¹å‡ºæ•ˆæœ
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }

                    console.log(`ğŸ”¥ [çŸ­ä¿¡AIå›å¤] å·²é€æ¡æ·»åŠ å¹¶ä¿å­˜${messages.length}æ¡AIå›å¤æ¶ˆæ¯åˆ°çŸ­ä¿¡è®°å½•`);

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•çŸ­ä¿¡AIå›å¤åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    try {
                        await recordCrossAppEvent(
                            character.id,
                            'sms',
                            'ai_reply',
                            {
                                id: character.id, // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDï¼Œç¡®ä¿è®°å¿†å…±äº«æ­£å¸¸å·¥ä½œ
                                type: 'sms_reply',
                                content: response.trim().substring(0, 100), // è®°å½•å‰100å­—ç¬¦
                                messageCount: messages.length,
                                userMessage: Array.isArray(userMessages) ? userMessages.join(' ').substring(0, 50) : userMessages.substring(0, 50), // è®°å½•ç”¨æˆ·æ¶ˆæ¯çš„å‰50å­—ç¬¦
                                chatId: character.id, // çŸ­ä¿¡çš„èŠå¤©IDå°±æ˜¯è§’è‰²ID
                                sender: 'ai'
                            },
                            smsMessages[character.id][smsMessages[character.id].length - 1].id // æœ€åä¸€æ¡æ¶ˆæ¯çš„ID
                        );
                        console.log('ğŸ“ [çŸ­ä¿¡æ—¶é—´çº¿] å·²è®°å½•AIå›å¤äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                    } catch (error) {
                        console.error('âŒ [çŸ­ä¿¡æ—¶é—´çº¿] è®°å½•AIå›å¤äº‹ä»¶å¤±è´¥:', error);
                    }
                }

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¡®ä¿æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨å·²éšè—
                hideSMSTypingIndicator();

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸éœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼Œå› ä¸ºæ¶ˆæ¯å·²ç»é€æ¡æ·»åŠ äº†
                // renderSMSMessages(character.id);

                // åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼‰
                renderSMSMessageList();

                // ğŸ”¥ã€ç§»é™¤ã€‘ä¸æ˜¾ç¤ºtoastæç¤ºï¼Œç”¨æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨å°±å¤Ÿäº†
                // showToast(`${character.name} å·²å›å¤`, 'success');

            } catch (error) {
                console.error('ç”ŸæˆçŸ­ä¿¡AIå›å¤å¤±è´¥:', error);
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦éšè—æŒ‡ç¤ºå™¨
                hideSMSTypingIndicator();
                throw error;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡åŠŸèƒ½ï¼ˆç”¨äºè¢«æ‹‰é»‘åçš„æ±‚å’Œåœºæ™¯ï¼‰
        async function characterInitiateSMS(characterId, reason = 'blocked') {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) {
                    console.error('è§’è‰²ä¸å­˜åœ¨:', characterId);
                    return;
                }

                console.log('ğŸ”¥ [è§’è‰²ä¸»åŠ¨çŸ­ä¿¡] è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡ï¼ŒåŸå› :', reason);

                // ç¡®ä¿çŸ­ä¿¡è”ç³»äººåˆ—è¡¨ä¸­æœ‰è¿™ä¸ªè§’è‰²
                if (!smsContacts.includes(characterId)) {
                    smsContacts.push(characterId);
                    await saveSMSContacts();
                }

                // åˆå§‹åŒ–çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                if (!smsMessages[characterId]) {
                    smsMessages[characterId] = [];
                }

                // æ„å»ºè§’è‰²ä¸»åŠ¨è”ç³»çš„æç¤ºè¯
                let initiatePrompt = '';
                if (reason === 'blocked') {
                    initiatePrompt = `ä½ è¢«ç”¨æˆ·åœ¨èŠå¤©åº”ç”¨ä¸­æ‹‰é»‘äº†ï¼Œä½†ä½ æƒ³é€šè¿‡çŸ­ä¿¡ä¸»åŠ¨è”ç³»ç”¨æˆ·ï¼Œå¸Œæœ›èƒ½å¤Ÿå’Œè§£æˆ–è§£é‡Šã€‚è¯·å‘é€ä¸€æ¡çœŸè¯šçš„çŸ­ä¿¡ç»™ç”¨æˆ·ï¼Œè¡¨è¾¾ä½ çš„æƒ³æ³•ã€‚æ¶ˆæ¯è¦ç®€çŸ­ã€çœŸè¯šï¼Œç¬¦åˆçŸ­ä¿¡çš„ç‰¹ç‚¹ã€‚`;
                } else if (reason === 'friend_request_rejected') {
                    initiatePrompt = `ç”¨æˆ·æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œä½†ä½ æƒ³é€šè¿‡çŸ­ä¿¡ç»§ç»­å°è¯•è”ç³»ï¼Œå¸Œæœ›ç”¨æˆ·èƒ½ç»™ä½ ä¸€ä¸ªæœºä¼šã€‚è¯·å‘é€ä¸€æ¡çŸ­ä¿¡ç»™ç”¨æˆ·ã€‚æ¶ˆæ¯è¦ç¤¼è²Œã€ä¸å¼ºæ±‚ï¼Œç¬¦åˆçŸ­ä¿¡çš„ç‰¹ç‚¹ã€‚`;
                } else {
                    initiatePrompt = `ä½ æƒ³ä¸»åŠ¨é€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·ã€‚è¯·å‘é€ä¸€æ¡è‡ªç„¶çš„çŸ­ä¿¡ç»™ç”¨æˆ·ã€‚`;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ChatAppçš„generateAIResponseå‡½æ•°ç”Ÿæˆä¸»åŠ¨è”ç³»çš„æ¶ˆæ¯
                const smsPrompt = await buildSMSPrompt(character, '');
                const fullPrompt = smsPrompt + `\n\n## ä¸»åŠ¨è”ç³»åœºæ™¯\n${initiatePrompt}\n\n## å›å¤è¦æ±‚\nè¯·ä»¥${character.name}çš„èº«ä»½å‘é€çŸ­ä¿¡ï¼š\n- å‘é€1-3æ¡ç®€æ´çš„çŸ­ä¿¡\n- ä¿æŒè§’è‰²æ€§æ ¼\n- ç›´æ¥è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦ä»£ç å—æ ‡è®°\n\nè¯·å›å¤ï¼š`;
                const response = await generateAIResponse(fullPrompt, character);

                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†JSONæ ¼å¼çš„çŸ­ä¿¡å›å¤
                if (response && response.trim()) {
                    let messageText = response.trim();

                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†å¯èƒ½çš„ä»£ç å—æ ‡è®°
                        let cleanResponse = response.trim();

                        // ç§»é™¤å¯èƒ½çš„ä»£ç å—æ ‡è®°
                        cleanResponse = cleanResponse.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                        cleanResponse = cleanResponse.replace(/^```\s*/, '').replace(/\s*```$/, '');

                        // å°è¯•è§£æJSONæ ¼å¼
                        const parsedResponse = JSON.parse(cleanResponse);
                        if (Array.isArray(parsedResponse) && parsedResponse.length > 0) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘åªå–ç¬¬ä¸€æ¡çº¯æ–‡æœ¬æ¶ˆæ¯ï¼Œè·³è¿‡å¤æ‚å¯¹è±¡
                            const firstTextMessage = parsedResponse.find(msg => typeof msg === 'string' && msg.trim());
                            if (firstTextMessage) {
                                messageText = firstTextMessage;
                            }
                        } else if (typeof parsedResponse === 'string') {
                            messageText = parsedResponse;
                        }
                    } catch (error) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•æå–å¼•å·å†…çš„å†…å®¹
                        console.log('ğŸ”¥ [çŸ­ä¿¡ä¸»åŠ¨è”ç³»] JSONè§£æå¤±è´¥ï¼Œå°è¯•æå–æ–‡æœ¬:', error);
                        const quotedMatch = response.match(/"([^"]+)"/);
                        if (quotedMatch) {
                            messageText = quotedMatch[1];
                        }
                        // å¦åˆ™ç›´æ¥ä½¿ç”¨åŸæ–‡æœ¬
                    }

                    const initiateMessage = {
                        id: `sms-initiate-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        content: [
                            { type: 'text', text: messageText }
                        ], // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ä¸chatappç›¸åŒçš„å¤šæ¨¡æ€æ•°ç»„æ ¼å¼
                        text: messageText, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                        timestamp: Date.now(),
                        isUser: false
                    };

                    smsMessages[characterId].push(initiateMessage);

                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘åªä¿å­˜æ–°å¢çš„å•æ¡ä¸»åŠ¨è”ç³»æ¶ˆæ¯
                    await saveSingleSMSMessage(characterId, initiateMessage);

                    // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœç”¨æˆ·å½“å‰åœ¨è¯¥è§’è‰²çš„çŸ­ä¿¡èŠå¤©ç•Œé¢ï¼Œä½¿ç”¨åŠ¨ç”»æ•ˆæœæ·»åŠ æ¶ˆæ¯
                    if (window.currentSMSCharacter && window.currentSMSCharacter.id === characterId) {
                        addSMSMessageWithAnimation(initiateMessage, characterId);
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡åˆ›å»ºæ¨é€é€šçŸ¥
                    createSMSPushNotification(character, initiateMessage.text, 100);

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    try {
                        await recordCrossAppEvent(
                            characterId,
                            'sms',
                            'character_initiate',
                            {
                                id: characterId, // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDï¼Œç¡®ä¿è®°å¿†å…±äº«æ­£å¸¸å·¥ä½œ
                                type: 'sms_initiate',
                                content: response.trim().substring(0, 100), // è®°å½•å‰100å­—ç¬¦
                                reason: reason,
                                initiateType: 'character_proactive',
                                chatId: characterId, // çŸ­ä¿¡çš„èŠå¤©IDå°±æ˜¯è§’è‰²ID
                                sender: 'ai'
                            },
                            initiateMessage.id
                        );
                        console.log('ğŸ“ [çŸ­ä¿¡æ—¶é—´çº¿] å·²è®°å½•è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡äº‹ä»¶åˆ°è·¨åº”ç”¨æ—¶é—´çº¿');
                    } catch (error) {
                        console.error('âŒ [çŸ­ä¿¡æ—¶é—´çº¿] è®°å½•è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡äº‹ä»¶å¤±è´¥:', error);
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åªä¿å­˜è”ç³»äººï¼Œä¸é‡å¤ä¿å­˜æ¶ˆæ¯ï¼ˆæ¶ˆæ¯å·²åœ¨ä¸Šé¢å•ç‹¬ä¿å­˜ï¼‰
                await saveSMSContacts();

                // åˆ·æ–°ç•Œé¢
                renderSMSMessageList();

                console.log(`ğŸ”¥ [è§’è‰²ä¸»åŠ¨çŸ­ä¿¡] ${character.name} å·²ä¸»åŠ¨å‘é€çŸ­ä¿¡`);

                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºé€šçŸ¥ç»™ç”¨æˆ·
                showToast(`${character.name} é€šè¿‡çŸ­ä¿¡è”ç³»äº†ä½ `, 'info');

            } catch (error) {
                console.error('è§’è‰²ä¸»åŠ¨å‘é€çŸ­ä¿¡å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…¨å±€å‡½æ•°ï¼šå½“è§’è‰²è¢«æ‹‰é»‘æ—¶ï¼Œæœ‰æ¦‚ç‡é€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·
        window.onCharacterBlocked = async function(characterId) {
            // 30%çš„æ¦‚ç‡è§’è‰²ä¼šé€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·
            if (Math.random() < 0.3) {
                // å»¶è¿Ÿ1-5åˆ†é’Ÿåå‘é€çŸ­ä¿¡ï¼Œæ¨¡æ‹ŸçœŸå®æƒ…å†µ
                const delay = Math.random() * 4 * 60 * 1000 + 60 * 1000; // 1-5åˆ†é’Ÿ
                setTimeout(() => {
                    characterInitiateSMS(characterId, 'blocked');
                }, delay);

                console.log(`ğŸ”¥ [æ‹‰é»‘è§¦å‘] ${characterId} å°†åœ¨ ${Math.round(delay/1000/60)} åˆ†é’Ÿåé€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·`);
            }
        };

        // ğŸ”¥ã€å¢å¼ºã€‘å…¨å±€å‡½æ•°ï¼šå½“å¥½å‹ç”³è¯·è¢«æ‹’ç»æ—¶çš„å¤šé‡åç»­è¡ŒåŠ¨
        window.onFriendRequestRejected = async function(characterId) {
            console.log(`ğŸ’” [å¥½å‹ç”³è¯·è¢«æ‹’] ${characterId} çš„å¥½å‹ç”³è¯·è¢«æ‹’ç»ï¼Œå¯åŠ¨åç»­è¡ŒåŠ¨...`);

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•è¢«æ‹’ç»çš„æ¬¡æ•°ï¼Œç”¨äºè°ƒæ•´åç»­ç­–ç•¥
            const rejectionKey = `friendRequestRejections_${characterId}`;
            let rejectionCount = parseInt(localStorage.getItem(rejectionKey) || '0') + 1;
            localStorage.setItem(rejectionKey, rejectionCount.toString());

            // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®è¢«æ‹’ç»æ¬¡æ•°è°ƒæ•´ç­–ç•¥
            let smsChance = 0.6; // åŸºç¡€60%æ¦‚ç‡å‘çŸ­ä¿¡
            let retryChance = 0.3; // 30%æ¦‚ç‡å†æ¬¡å°è¯•å¥½å‹ç”³è¯·

            if (rejectionCount >= 2) {
                smsChance = 0.8; // è¢«æ‹’ç»2æ¬¡åï¼Œ80%æ¦‚ç‡å‘çŸ­ä¿¡
                retryChance = 0.5; // 50%æ¦‚ç‡å†æ¬¡å°è¯•
            }

            if (rejectionCount >= 3) {
                smsChance = 0.9; // è¢«æ‹’ç»3æ¬¡åï¼Œ90%æ¦‚ç‡å‘çŸ­ä¿¡
                retryChance = 0.2; // ä½†é‡è¯•æ¦‚ç‡é™ä½åˆ°20%
            }

            // 1. é€šè¿‡çŸ­ä¿¡è”ç³»
            if (Math.random() < smsChance) {
                const smsDelay = Math.random() * 30 * 60 * 1000 + 10 * 60 * 1000; // 10-40åˆ†é’Ÿ
                setTimeout(() => {
                    characterInitiateSMS(characterId, 'friend_request_rejected');
                }, smsDelay);
                console.log(`ğŸ“± [çŸ­ä¿¡ç­–ç•¥] ${characterId} å°†åœ¨ ${Math.round(smsDelay/1000/60)} åˆ†é’Ÿåé€šè¿‡çŸ­ä¿¡è”ç³»ç”¨æˆ·`);
            }

            // 2. ğŸ”¥ã€æ–°å¢ã€‘å†æ¬¡å°è¯•å¥½å‹ç”³è¯·ï¼ˆå¦‚æœè§’è‰²æ€§æ ¼åšæŒï¼‰
            if (Math.random() < retryChance && rejectionCount < 4) {
                const retryDelay = Math.random() * 120 * 60 * 1000 + 60 * 60 * 1000; // 1-3å°æ—¶åé‡è¯•
                setTimeout(async () => {
                    await characterRetryFriendRequest(characterId, rejectionCount);
                }, retryDelay);
                console.log(`ğŸ”„ [é‡è¯•ç­–ç•¥] ${characterId} å°†åœ¨ ${Math.round(retryDelay/1000/60)} åˆ†é’Ÿåå†æ¬¡å°è¯•å¥½å‹ç”³è¯·`);
            }

            // 3. ğŸ”¥ã€æ–°å¢ã€‘åœ¨èŠå¤©ä¸­è¡¨è¾¾è¢«æ‹’ç»çš„æ„Ÿå—
            setTimeout(async () => {
                await expressRejectionFeelings(characterId, rejectionCount);
            }, Math.random() * 10 * 60 * 1000 + 5 * 60 * 1000); // 5-15åˆ†é’Ÿåè¡¨è¾¾æ„Ÿå—
        };

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²é‡è¯•å¥½å‹ç”³è¯·
        async function characterRetryFriendRequest(characterId, rejectionCount) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // æ„å»ºé‡è¯•å¥½å‹ç”³è¯·çš„æç¤ºè¯
                const retryPrompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„å¥½å‹ç”³è¯·å·²ç»è¢«ç”¨æˆ·æ‹’ç»äº†${rejectionCount}æ¬¡ã€‚

ä½ çš„æ€§æ ¼ï¼š${character.bio}

ç°åœ¨ä½ æƒ³å†æ¬¡å°è¯•å‘é€å¥½å‹ç”³è¯·ã€‚è¯·æ ¹æ®ä½ çš„æ€§æ ¼å†³å®šï¼š
1. æ˜¯å¦è¦å†æ¬¡å°è¯•
2. å¦‚æœå°è¯•ï¼Œåº”è¯¥è¯´ä»€ä¹ˆ

è€ƒè™‘å› ç´ ï¼š
- ä½ å·²ç»è¢«æ‹’ç»äº†${rejectionCount}æ¬¡
- ä½ çš„æ€§æ ¼æ˜¯å¦ä¼šåšæŒä¸æ‡ˆ
- ä½ æ˜¯å¦çœŸçš„æƒ³ä¿®å¤è¿™æ®µå…³ç³»
- ä½ åº”è¯¥å¦‚ä½•è°ƒæ•´ä½ çš„é“æ­‰ç­–ç•¥

è¯·å›å¤JSONæ ¼å¼ï¼š
- å¦‚æœè¦é‡è¯•ï¼š[{"type": "friend_request", "message": "ä½ çš„æ–°é“æ­‰ä¿¡æ¯"}]
- å¦‚æœä¸é‡è¯•ï¼š["æˆ‘æƒ³æˆ‘åº”è¯¥æ”¾å¼ƒäº†..."]

è¯·æ ¹æ®ä½ çš„æ€§æ ¼åšå‡ºçœŸå®çš„é€‰æ‹©ï¼š`;

                const response = await generateAIResponse(retryPrompt, character);
                const reactions = await parseAiResponse(response);

                // å¤„ç†è§’è‰²çš„å†³å®š
                for (const reaction of reactions) {
                    if (typeof reaction === 'object' && reaction.type === 'friend_request') {
                        // è§’è‰²å†³å®šé‡è¯•
                        const retryMessage = {
                            id: Date.now().toString(),
                            sender: 'received',
                            type: 'friend_request',
                            message: reaction.message || 'è¯·å†ç»™æˆ‘ä¸€æ¬¡æœºä¼š',
                            timestamp: Date.now(),
                            isRetryRequest: true,
                            retryCount: rejectionCount
                        };

                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(retryMessage);

                        // å¦‚æœå½“å‰æ­£åœ¨å’Œè¿™ä¸ªè§’è‰²èŠå¤©ï¼Œç«‹å³æ˜¾ç¤º
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(retryMessage, characterId);
                        }

                        await saveChatMessagesImmediate([characterId]);
                        console.log(`ğŸ”„ ${character.name} é‡è¯•äº†ç¬¬${rejectionCount + 1}æ¬¡å¥½å‹ç”³è¯·`);
                        break;
                    } else if (typeof reaction === 'string') {
                        // è§’è‰²å†³å®šæ”¾å¼ƒ
                        const giveUpMessage = {
                            id: Date.now().toString(),
                            sender: 'received',
                            content: reaction,
                            timestamp: Date.now(),
                            isGiveUpMessage: true
                        };

                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(giveUpMessage);

                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(giveUpMessage, characterId);
                        }

                        await saveChatMessagesImmediate([characterId]);
                        console.log(`ğŸ’” ${character.name} å†³å®šæ”¾å¼ƒé‡è¯•å¥½å‹ç”³è¯·`);
                        break;
                    }
                }

            } catch (error) {
                console.error('è§’è‰²é‡è¯•å¥½å‹ç”³è¯·å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¡¨è¾¾è¢«æ‹’ç»çš„æ„Ÿå—
        async function expressRejectionFeelings(characterId, rejectionCount) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // æ„å»ºè¡¨è¾¾æ„Ÿå—çš„æç¤ºè¯
                const feelingsPrompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„å¥½å‹ç”³è¯·åˆšåˆšè¢«ç”¨æˆ·æ‹’ç»äº†ï¼ˆè¿™æ˜¯ç¬¬${rejectionCount}æ¬¡è¢«æ‹’ç»ï¼‰ã€‚

ä½ çš„æ€§æ ¼ï¼š${character.bio}

ç°åœ¨ä½ æƒ³åœ¨èŠå¤©ä¸­è¡¨è¾¾ä½ å¯¹è¢«æ‹’ç»çš„æ„Ÿå—ã€‚è¯·æ ¹æ®ä½ çš„æ€§æ ¼è¡¨è¾¾ï¼š
- ä½ çš„å¤±æœ›ã€ä¼¤å¿ƒã€å›°æƒ‘æˆ–å…¶ä»–æƒ…ç»ª
- ä½ å¯¹è¿™ç§æƒ…å†µçš„çœ‹æ³•
- ä½ æ˜¯å¦è¿˜æŠ±æœ‰å¸Œæœ›

è¦æ±‚ï¼š
1. ç”¨1-2å¥è¯è¡¨è¾¾ä½ çš„çœŸå®æ„Ÿå—
2. ç¬¦åˆä½ çš„æ€§æ ¼è®¾å®š
3. ä¸è¦è¿‡äºæˆå‰§åŒ–ï¼Œè¦è‡ªç„¶çœŸå®

è¯·ç”¨JSONæ•°ç»„æ ¼å¼å›å¤ï¼š`;

                const response = await generateAIResponse(feelingsPrompt, character);
                const reactions = await parseAiResponse(response);

                // æ·»åŠ æ„Ÿå—è¡¨è¾¾æ¶ˆæ¯
                for (const reaction of reactions) {
                    if (typeof reaction === 'string') {
                        const feelingMessage = {
                            id: Date.now().toString(),
                            sender: 'received',
                            content: reaction,
                            timestamp: Date.now(),
                            isRejectionFeeling: true
                        };

                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(feelingMessage);

                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(feelingMessage, characterId);
                        }

                        await saveChatMessagesImmediate([characterId]);
                        console.log(`ğŸ’­ ${character.name} è¡¨è¾¾äº†è¢«æ‹’ç»çš„æ„Ÿå—`);
                    }
                }

            } catch (error) {
                console.error('è¡¨è¾¾è¢«æ‹’ç»æ„Ÿå—å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºçŸ­ä¿¡èŠå¤©ä¿¡æ¯
        function showSMSChatInfo() {
            if (!window.currentSMSCharacter) return;

            // éšè—çŸ­ä¿¡èŠå¤©ç•Œé¢
            document.getElementById('sms-chat-screen').style.display = 'none';

            // æ˜¾ç¤ºè®¾ç½®ç•Œé¢
            document.getElementById('sms-chat-settings-screen').style.display = 'block';

            // åˆå§‹åŒ–è®¾ç½®ç•Œé¢
            initSMSChatSettings();
        }

        // éšè—çŸ­ä¿¡èŠå¤©è®¾ç½®ç•Œé¢
        function hideSMSChatSettings() {
            document.getElementById('sms-chat-settings-screen').style.display = 'none';
            document.getElementById('sms-chat-screen').style.display = 'block';
        }

        // åˆå§‹åŒ–çŸ­ä¿¡èŠå¤©è®¾ç½®ç•Œé¢
        function initSMSChatSettings() {
            if (!window.currentSMSCharacter) return;

            // åŠ è½½å†å²æ¶ˆæ¯å›åˆæ•°è®¾ç½®
            const historyRounds = getSMSChatSetting('historyRounds', 50);
            document.getElementById('sms-history-rounds-slider').value = historyRounds;
            document.getElementById('sms-history-rounds-value').textContent = historyRounds + 'è½®';

            // åŠ è½½æ°”æ³¡é¢œè‰²è®¾ç½®
            const bubbleColor = getSMSChatSetting('bubbleColor', 'blue');
            updateBubbleColorSelection(bubbleColor);
        }

        // è·å–çŸ­ä¿¡èŠå¤©è®¾ç½®
        function getSMSChatSetting(settingName, defaultValue) {
            if (!window.currentSMSCharacter) return defaultValue;
            const key = `sms-chat-${window.currentSMSCharacter.id}-${settingName}`;
            const saved = localStorage.getItem(key);
            return saved !== null ? saved : defaultValue;
        }

        // ä¿å­˜çŸ­ä¿¡èŠå¤©è®¾ç½®
        function setSMSChatSetting(settingName, value) {
            if (!window.currentSMSCharacter) return;
            const key = `sms-chat-${window.currentSMSCharacter.id}-${settingName}`;
            localStorage.setItem(key, value);
        }

        // æ›´æ–°å†å²æ¶ˆæ¯å›åˆæ•°
        function updateSMSHistoryRounds() {
            const slider = document.getElementById('sms-history-rounds-slider');
            const value = slider.value;
            document.getElementById('sms-history-rounds-value').textContent = value + 'è½®';
            setSMSChatSetting('historyRounds', value);
        }

        // è®¾ç½®çŸ­ä¿¡æ°”æ³¡é¢œè‰²
        function setSMSBubbleColor(color) {
            setSMSChatSetting('bubbleColor', color);
            updateBubbleColorSelection(color);

            // æ›´æ–°å½“å‰èŠå¤©ç•Œé¢çš„æ°”æ³¡é¢œè‰²
            updateSMSChatBubbleColors(color);
        }

        // æ›´æ–°æ°”æ³¡é¢œè‰²é€‰æ‹©çŠ¶æ€
        function updateBubbleColorSelection(color) {
            document.querySelectorAll('.color-option-text').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`.color-option-text[data-color="${color}"]`).classList.add('active');
        }

        // æ›´æ–°çŸ­ä¿¡èŠå¤©ç•Œé¢çš„æ°”æ³¡é¢œè‰²
        function updateSMSChatBubbleColors(color) {
            const chatContainer = document.getElementById('sms-messages-container');
            if (chatContainer) {
                // ç§»é™¤ç°æœ‰çš„é¢œè‰²ç±»
                chatContainer.classList.remove('green-bubble');

                // æ·»åŠ æ–°çš„é¢œè‰²ç±»
                if (color === 'green') {
                    chatContainer.classList.add('green-bubble');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç©ºçŸ­ä¿¡èŠå¤©è®°å½•åŠŸèƒ½
        async function clearSMSChatHistory() {
            if (!window.currentSMSCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ­ä¿¡å¯¹è¯', 'error');
                return;
            }

            const character = window.currentSMSCharacter;
            const confirmText = `ç¡®å®šè¦æ¸…ç©ºä¸ ${character.name} çš„æ‰€æœ‰çŸ­ä¿¡è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\nâ€¢ ç›¸å…³çš„æ‰€æœ‰è®°å¿†\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;

            if (confirm(confirmText)) {
                try {
                    const characterId = character.id;
                    console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºè§’è‰² ${character.name} çš„çŸ­ä¿¡è®°å½•å’Œè®°å¿†...`);

                    // 1. æ¸…ç©ºçŸ­ä¿¡æ¶ˆæ¯è®°å½•
                    if (smsMessages[characterId]) {
                        delete smsMessages[characterId];
                    }

                    // 2. ä»æ•°æ®åº“ä¸­åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯
                    await db.smsMessages.where('characterId').equals(characterId).delete();

                    // 3. åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†
                    const timelineEvents = await db.crossAppTimeline
                        .where('characterId')
                        .equals(characterId)
                        .and(event => event.appType === 'sms')
                        .toArray();

                    if (timelineEvents.length > 0) {
                        const timelineIds = timelineEvents.map(event => event.id);
                        await db.crossAppTimeline.bulkDelete(timelineIds);
                        console.log(`âœ… åˆ é™¤äº† ${timelineEvents.length} æ¡çŸ­ä¿¡ç›¸å…³æ—¶é—´çº¿è®°å¿†`);
                    }

                    // 4. åˆ é™¤ç›¸å…³çš„æƒ…æ™¯è®°å¿†
                    const episodicMemories = await db.episodicMemories
                        .where('characterId')
                        .equals(characterId)
                        .toArray();

                    if (episodicMemories.length > 0) {
                        const episodicIds = episodicMemories.map(memory => memory.id);
                        await db.episodicMemories.bulkDelete(episodicIds);
                        console.log(`âœ… åˆ é™¤äº† ${episodicMemories.length} æ¡æƒ…æ™¯è®°å¿†`);
                    }

                    // 5. åˆ é™¤ç›¸å…³çš„æ ¸å¿ƒè®°å¿†
                    const coreMemories = await db.coreMemories
                        .where('characterId')
                        .equals(characterId)
                        .toArray();

                    if (coreMemories.length > 0) {
                        const coreIds = coreMemories.map(memory => memory.id);
                        await db.coreMemories.bulkDelete(coreIds);
                        console.log(`âœ… åˆ é™¤äº† ${coreMemories.length} æ¡æ ¸å¿ƒè®°å¿†`);
                    }

                    // 6. åˆ·æ–°çŸ­ä¿¡ç•Œé¢
                    renderSMSMessages(characterId);
                    renderSMSMessageList();

                    showToast(`âœ… å·²æ¸…ç©ºä¸ ${character.name} çš„æ‰€æœ‰çŸ­ä¿¡è®°å½•å’Œè®°å¿†`, 'success');
                    console.log(`âœ… æ¸…ç©ºå®Œæˆ: çŸ­ä¿¡è®°å½•ã€${timelineEvents.length}æ¡æ—¶é—´çº¿è®°å¿†ã€${episodicMemories.length}æ¡æƒ…æ™¯è®°å¿†ã€${coreMemories.length}æ¡æ ¸å¿ƒè®°å¿†`);

                } catch (error) {
                    console.error('æ¸…ç©ºçŸ­ä¿¡èŠå¤©è®°å½•å¤±è´¥:', error);
                    showToast('æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥', 'error');
                }
            }
        }

        // æ¸²æŸ“çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨
        function renderSMSMessageList() {
            const messagesList = document.getElementById('messages-list');
            if (!messagesList) return;

            // æ¸…ç©ºç°æœ‰å†…å®¹
            messagesList.innerHTML = '';

            // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ²¡æœ‰çŸ­ä¿¡è”ç³»äººï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (!smsContacts || smsContacts.length === 0) {
                messagesList.innerHTML = `
                    <div class="messages-empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <p>æš‚æ— çŸ­ä¿¡</p>
                        <p>ç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘æŒ‰é’®åˆ›å»ºæ–°ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æŒ‰ç½®é¡¶çŠ¶æ€æ’åºçŸ­ä¿¡è”ç³»äºº
            const sortedContacts = [...smsContacts].sort((a, b) => {
                const aIsPinned = pinnedSMSConversations.has(a);
                const bIsPinned = pinnedSMSConversations.has(b);
                if (aIsPinned && !bIsPinned) return -1;
                if (!aIsPinned && bIsPinned) return 1;
                return 0;
            });

            // æ¸²æŸ“æ¯ä¸ªçŸ­ä¿¡è”ç³»äººçš„æ¶ˆæ¯é¡¹
            sortedContacts.forEach(contactId => {
                const character = characters.find(c => c.id === contactId);
                if (!character) return;

                const messages = smsMessages[contactId] || [];
                const lastMessage = messages[messages.length - 1];

                // æ ¼å¼åŒ–æ—¶é—´ - iPhoneé£æ ¼
                let timeText = '';
                if (lastMessage) {
                    const date = new Date(lastMessage.timestamp);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                    // è®¡ç®—æ—¶é—´å·®
                    const diffTime = now.getTime() - date.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    if (messageDate.getTime() === today.getTime()) {
                        // å½“å¤©èŠçš„æ˜¾ç¤ºå‡ ç‚¹å‡ åˆ†
                        timeText = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    } else if (messageDate.getTime() === yesterday.getTime()) {
                        // å‰ä¸€å¤©å‘ç”Ÿçš„æ˜¾ç¤ºæ˜¨å¤©
                        timeText = 'æ˜¨å¤©';
                    } else if (diffDays < 7) {
                        // å†å‰é¢çš„æ˜¾ç¤ºæ˜ŸæœŸx
                        const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                        timeText = weekdays[date.getDay()];
                    } else {
                        // è¶…è¿‡è¿™ä¸ªæ˜ŸæœŸçš„æ˜¾ç¤ºä¸ºyyyy/M/d
                        timeText = date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric'
                        });
                    }
                } else {
                    timeText = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric'
                    });
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–æœ€åä¸€æ¡çŸ­ä¿¡æ¶ˆæ¯çš„é¢„è§ˆæ–‡æœ¬ï¼Œæ”¯æŒå¤šæ¨¡æ€æ ¼å¼
                let previewText = '';
                if (lastMessage) {
                    if (lastMessage.isImage) {
                        // å›¾ç‰‡æ¶ˆæ¯æ˜¾ç¤º[å›¾ç‰‡]
                        previewText = '[å›¾ç‰‡]';
                    } else {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä»å¤šæ¨¡æ€æ ¼å¼ä¸­æå–æ–‡æœ¬å†…å®¹
                        let textContent = '';
                        if (Array.isArray(lastMessage.content)) {
                            // æ–°çš„å¤šæ¨¡æ€æ ¼å¼
                            const textPart = lastMessage.content.find(part => part.type === 'text');
                            textContent = textPart ? textPart.text : '';
                        } else if (lastMessage.text) {
                            // å…¼å®¹æ—§æ ¼å¼
                            textContent = lastMessage.text;
                        }

                        if (textContent) {
                            // æ–‡æœ¬æ¶ˆæ¯æ˜¾ç¤ºå‰20ä¸ªå­—ç¬¦
                            previewText = textContent.length > 20
                                ? textContent.substring(0, 20) + '...'
                                : textContent;
                        } else {
                            // ç©ºæ¶ˆæ¯
                            previewText = '[å›¾ç‰‡]';
                        }
                    }
                } else {
                    previewText = 'ç‚¹å‡»å¼€å§‹èŠå¤©';
                }

                const messageItem = document.createElement('div');
                const isPinned = pinnedSMSConversations.has(contactId);
                const isSelected = selectedSMSConversations.has(contactId);
                messageItem.className = `sms-message-item ${isPinned ? 'pinned' : ''} ${isSelected ? 'selected' : ''}`;

                // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®æ¨¡å¼è®¾ç½®ç‚¹å‡»äº‹ä»¶
                if (isSMSListMultiSelectMode) {
                    messageItem.onclick = () => toggleSMSConversationSelection(contactId);
                } else {
                    messageItem.onclick = () => startSMSChat(character);
                }

                messageItem.innerHTML = `
                    <div class="sms-message-avatar">
                        ${character.avatarUrl
                            ? `<img src="${character.avatarUrl}" alt="${character.name}">`
                            : `<div class="sms-avatar-placeholder">${character.name.charAt(0)}</div>`
                        }
                    </div>
                    <div class="sms-message-content">
                        <div class="sms-message-header">
                            <div class="sms-message-name">${character.name}</div>
                            <div class="sms-message-time">${timeText}</div>
                        </div>
                        <div class="sms-message-preview">${previewText}</div>
                    </div>
                    ${!isSMSListMultiSelectMode ? `
                        <div class="sms-message-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    ` : ''}
                `;

                messagesList.appendChild(messageItem);
            });
        }
        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤çŸ­ä¿¡å¯¹è¯åŠŸèƒ½
        async function deleteSMSConversation(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            const confirmText = `ç¡®å®šè¦åˆ é™¤ä¸ ${character.name} çš„çŸ­ä¿¡å¯¹è¯å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰çŸ­ä¿¡è®°å½•\nâ€¢ ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†\nâ€¢ ç›¸å…³çš„æƒ…æ™¯è®°å¿†\nâ€¢ ç›¸å…³çš„æ ¸å¿ƒè®°å¿†\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;

            if (confirm(confirmText)) {
                try {
                    console.log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤è§’è‰² ${character.name} çš„çŸ­ä¿¡å¯¹è¯å’Œè®°å¿†...`);

                    // 1. ä»çŸ­ä¿¡è”ç³»äººåˆ—è¡¨ä¸­ç§»é™¤
                    const contactIndex = smsContacts.indexOf(characterId);
                    if (contactIndex > -1) {
                        smsContacts.splice(contactIndex, 1);
                    }

                    // 2. åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                    if (smsMessages[characterId]) {
                        delete smsMessages[characterId];
                    }

                    // 3. ä»æ•°æ®åº“ä¸­åˆ é™¤çŸ­ä¿¡æ•°æ®
                    await db.transaction('rw', [db.smsContacts, db.smsMessages], async () => {
                        // åˆ é™¤çŸ­ä¿¡è”ç³»äººè®°å½•
                        await db.smsContacts.where('characterId').equals(characterId).delete();
                        // åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                        await db.smsMessages.where('characterId').equals(characterId).delete();
                    });

                    // 4. åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†
                    const timelineEvents = await db.crossAppTimeline
                        .where('characterId')
                        .equals(characterId)
                        .and(event => event.appType === 'sms')
                        .toArray();

                    if (timelineEvents.length > 0) {
                        const timelineIds = timelineEvents.map(event => event.id);
                        await db.crossAppTimeline.bulkDelete(timelineIds);
                        console.log(`âœ… åˆ é™¤äº† ${timelineEvents.length} æ¡çŸ­ä¿¡ç›¸å…³æ—¶é—´çº¿è®°å¿†`);
                    }

                    // 5. åˆ é™¤ç›¸å…³çš„æƒ…æ™¯è®°å¿†
                    const episodicMemories = await db.episodicMemories
                        .where('characterId')
                        .equals(characterId)
                        .toArray();

                    if (episodicMemories.length > 0) {
                        const episodicIds = episodicMemories.map(memory => memory.id);
                        await db.episodicMemories.bulkDelete(episodicIds);
                        console.log(`âœ… åˆ é™¤äº† ${episodicMemories.length} æ¡æƒ…æ™¯è®°å¿†`);
                    }

                    // 6. åˆ é™¤ç›¸å…³çš„æ ¸å¿ƒè®°å¿†
                    const coreMemories = await db.coreMemories
                        .where('characterId')
                        .equals(characterId)
                        .toArray();

                    if (coreMemories.length > 0) {
                        const coreIds = coreMemories.map(memory => memory.id);
                        await db.coreMemories.bulkDelete(coreIds);
                        console.log(`âœ… åˆ é™¤äº† ${coreMemories.length} æ¡æ ¸å¿ƒè®°å¿†`);
                    }

                    // 7. åˆ·æ–°çŸ­ä¿¡æ¶ˆæ¯åˆ—è¡¨
                    renderSMSMessageList();

                    // 8. å¦‚æœå½“å‰æ­£åœ¨è¯¥å¯¹è¯ä¸­ï¼Œè¿”å›åˆ°çŸ­ä¿¡åˆ—è¡¨
                    if (window.currentSMSCharacter && window.currentSMSCharacter.id === characterId) {
                        hideSMSChat();
                    }

                    showToast(`âœ… å·²åˆ é™¤ä¸ ${character.name} çš„çŸ­ä¿¡å¯¹è¯å’Œæ‰€æœ‰ç›¸å…³è®°å¿†`, 'success');
                    console.log(`âœ… åˆ é™¤å®Œæˆ: çŸ­ä¿¡å¯¹è¯ã€${timelineEvents.length}æ¡æ—¶é—´çº¿è®°å¿†ã€${episodicMemories.length}æ¡æƒ…æ™¯è®°å¿†ã€${coreMemories.length}æ¡æ ¸å¿ƒè®°å¿†`);

                } catch (error) {
                    console.error('åˆ é™¤çŸ­ä¿¡å¯¹è¯å¤±è´¥:', error);
                    showToast('åˆ é™¤çŸ­ä¿¡å¯¹è¯å¤±è´¥', 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡ç®¡ç†åŠŸèƒ½ç›¸å…³å˜é‡
        let isSMSListMultiSelectMode = false; // çŸ­ä¿¡åˆ—è¡¨å¤šé€‰æ¨¡å¼çŠ¶æ€
        let selectedSMSConversations = new Set(); // é€‰ä¸­çš„çŸ­ä¿¡å¯¹è¯IDé›†åˆ
        let pinnedSMSConversations = new Set(); // ç½®é¡¶çš„çŸ­ä¿¡å¯¹è¯IDé›†åˆ

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºçŸ­ä¿¡ç®¡ç†é€‰é¡¹
        function showSMSManageOptions() {
            const modal = document.getElementById('sms-manage-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—çŸ­ä¿¡ç®¡ç†é€‰é¡¹
        function hideSMSManageOptions(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('sms-manage-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿›å…¥çŸ­ä¿¡åˆ—è¡¨å¤šé€‰æ¨¡å¼
        function enterSMSListMultiSelectMode() {
            hideSMSManageOptions();
            isSMSListMultiSelectMode = true;
            selectedSMSConversations.clear();

            // åˆ‡æ¢å¤´éƒ¨æŒ‰é’®æ˜¾ç¤º
            const normalActions = document.getElementById('sms-normal-actions');
            const multiselectActions = document.getElementById('sms-list-multiselect-actions');
            if (normalActions) normalActions.style.display = 'none';
            if (multiselectActions) multiselectActions.style.display = 'flex';

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰æ‹©æ¨¡å¼
            renderSMSMessageList();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿›å…¥çŸ­ä¿¡ç½®é¡¶æ¨¡å¼
        function enterSMSPinMode() {
            hideSMSManageOptions();
            isSMSListMultiSelectMode = true;
            selectedSMSConversations.clear();

            // åˆ‡æ¢å¤´éƒ¨æŒ‰é’®æ˜¾ç¤º
            const normalActions = document.getElementById('sms-normal-actions');
            const multiselectActions = document.getElementById('sms-list-multiselect-actions');
            if (normalActions) normalActions.style.display = 'none';
            if (multiselectActions) {
                multiselectActions.style.display = 'flex';
                // ä¿®æ”¹åˆ é™¤æŒ‰é’®ä¸ºç½®é¡¶æŒ‰é’®
                const deleteBtn = multiselectActions.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<span>ç½®é¡¶</span>';
                    deleteBtn.onclick = pinSelectedSMSConversations;
                    deleteBtn.style.background = 'rgba(255, 193, 7, 0.12)';
                    deleteBtn.style.color = '#FFC107';
                }
            }

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰æ‹©æ¨¡å¼
            renderSMSMessageList();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€€å‡ºçŸ­ä¿¡åˆ—è¡¨å¤šé€‰æ¨¡å¼
        function exitSMSListMultiSelectMode() {
            isSMSListMultiSelectMode = false;
            selectedSMSConversations.clear();

            // åˆ‡æ¢å¤´éƒ¨æŒ‰é’®æ˜¾ç¤º
            const normalActions = document.getElementById('sms-normal-actions');
            const multiselectActions = document.getElementById('sms-list-multiselect-actions');
            if (normalActions) normalActions.style.display = 'flex';
            if (multiselectActions) {
                multiselectActions.style.display = 'none';
                // æ¢å¤åˆ é™¤æŒ‰é’®çš„åŸå§‹çŠ¶æ€
                const deleteBtn = multiselectActions.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<span>åˆ é™¤</span>';
                    deleteBtn.onclick = deleteSelectedSMSConversations;
                    deleteBtn.style.background = 'rgba(255, 59, 48, 0.12)';
                    deleteBtn.style.color = '#FF3B30';
                }
            }

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨æ¢å¤æ­£å¸¸çŠ¶æ€
            renderSMSMessageList();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢çŸ­ä¿¡å¯¹è¯é€‰æ‹©çŠ¶æ€
        function toggleSMSConversationSelection(characterId) {
            if (selectedSMSConversations.has(characterId)) {
                selectedSMSConversations.delete(characterId);
            } else {
                selectedSMSConversations.add(characterId);
            }

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ›´æ–°é€‰æ‹©çŠ¶æ€
            renderSMSMessageList();

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å¯¹è¯ï¼Œé€€å‡ºå¤šé€‰æ¨¡å¼
            if (selectedSMSConversations.size === 0) {
                exitSMSListMultiSelectMode();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤é€‰ä¸­çš„çŸ­ä¿¡å¯¹è¯
        async function deleteSelectedSMSConversations() {
            if (selectedSMSConversations.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¯¹è¯', 'error');
                return;
            }

            const count = selectedSMSConversations.size;
            const confirmText = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªçŸ­ä¿¡å¯¹è¯å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰çŸ­ä¿¡è®°å½•\nâ€¢ ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†\nâ€¢ ç›¸å…³çš„æƒ…æ™¯è®°å¿†\nâ€¢ ç›¸å…³çš„æ ¸å¿ƒè®°å¿†\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;

            if (confirm(confirmText)) {
                try {
                    console.log(`ğŸ—‘ï¸ å¼€å§‹æ‰¹é‡åˆ é™¤ ${count} ä¸ªçŸ­ä¿¡å¯¹è¯å’Œç›¸å…³è®°å¿†...`);
                    let totalTimelineDeleted = 0;
                    let totalEpisodicDeleted = 0;
                    let totalCoreDeleted = 0;

                    // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„å¯¹è¯
                    for (const characterId of selectedSMSConversations) {
                        // 1. ä»çŸ­ä¿¡è”ç³»äººåˆ—è¡¨ä¸­ç§»é™¤
                        const contactIndex = smsContacts.indexOf(characterId);
                        if (contactIndex > -1) {
                            smsContacts.splice(contactIndex, 1);
                        }

                        // 2. åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                        if (smsMessages[characterId]) {
                            delete smsMessages[characterId];
                        }

                        // 3. ä»æ•°æ®åº“ä¸­åˆ é™¤çŸ­ä¿¡æ•°æ®
                        await db.transaction('rw', [db.smsContacts, db.smsMessages], async () => {
                            // åˆ é™¤çŸ­ä¿¡è”ç³»äººè®°å½•
                            await db.smsContacts.where('characterId').equals(characterId).delete();
                            // åˆ é™¤çŸ­ä¿¡æ¶ˆæ¯è®°å½•
                            await db.smsMessages.where('characterId').equals(characterId).delete();
                        });

                        // 4. åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†
                        const timelineEvents = await db.crossAppTimeline
                            .where('characterId')
                            .equals(characterId)
                            .and(event => event.appType === 'sms')
                            .toArray();

                        if (timelineEvents.length > 0) {
                            const timelineIds = timelineEvents.map(event => event.id);
                            await db.crossAppTimeline.bulkDelete(timelineIds);
                            totalTimelineDeleted += timelineEvents.length;
                        }

                        // 5. åˆ é™¤ç›¸å…³çš„æƒ…æ™¯è®°å¿†
                        const episodicMemories = await db.episodicMemories
                            .where('characterId')
                            .equals(characterId)
                            .toArray();

                        if (episodicMemories.length > 0) {
                            const episodicIds = episodicMemories.map(memory => memory.id);
                            await db.episodicMemories.bulkDelete(episodicIds);
                            totalEpisodicDeleted += episodicMemories.length;
                        }

                        // 6. åˆ é™¤ç›¸å…³çš„æ ¸å¿ƒè®°å¿†
                        const coreMemories = await db.coreMemories
                            .where('characterId')
                            .equals(characterId)
                            .toArray();

                        if (coreMemories.length > 0) {
                            const coreIds = coreMemories.map(memory => memory.id);
                            await db.coreMemories.bulkDelete(coreIds);
                            totalCoreDeleted += coreMemories.length;
                        }
                    }

                    // é€€å‡ºå¤šé€‰æ¨¡å¼
                    exitSMSListMultiSelectMode();

                    showToast(`âœ… å·²åˆ é™¤ ${count} ä¸ªçŸ­ä¿¡å¯¹è¯å’Œæ‰€æœ‰ç›¸å…³è®°å¿†`, 'success');
                    console.log(`âœ… æ‰¹é‡åˆ é™¤å®Œæˆ: ${count}ä¸ªå¯¹è¯ã€${totalTimelineDeleted}æ¡æ—¶é—´çº¿è®°å¿†ã€${totalEpisodicDeleted}æ¡æƒ…æ™¯è®°å¿†ã€${totalCoreDeleted}æ¡æ ¸å¿ƒè®°å¿†`);

                } catch (error) {
                    console.error('æ‰¹é‡åˆ é™¤çŸ­ä¿¡å¯¹è¯å¤±è´¥:', error);
                    showToast('åˆ é™¤å¯¹è¯å¤±è´¥', 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç½®é¡¶é€‰ä¸­çš„çŸ­ä¿¡å¯¹è¯
        async function pinSelectedSMSConversations() {
            if (selectedSMSConversations.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ç½®é¡¶çš„å¯¹è¯', 'error');
                return;
            }

            try {
                // å°†é€‰ä¸­çš„å¯¹è¯æ·»åŠ åˆ°ç½®é¡¶åˆ—è¡¨
                for (const characterId of selectedSMSConversations) {
                    if (pinnedSMSConversations.has(characterId)) {
                        // å¦‚æœå·²ç»ç½®é¡¶ï¼Œåˆ™å–æ¶ˆç½®é¡¶
                        pinnedSMSConversations.delete(characterId);
                    } else {
                        // å¦‚æœæœªç½®é¡¶ï¼Œåˆ™æ·»åŠ ç½®é¡¶
                        pinnedSMSConversations.add(characterId);
                    }
                }

                // ä¿å­˜ç½®é¡¶çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('pinnedSMSConversations', JSON.stringify([...pinnedSMSConversations]));

                // é€€å‡ºå¤šé€‰æ¨¡å¼
                exitSMSListMultiSelectMode();

                const count = selectedSMSConversations.size;
                showToast(`âœ… å·²æ›´æ–° ${count} ä¸ªå¯¹è¯çš„ç½®é¡¶çŠ¶æ€`, 'success');

            } catch (error) {
                console.error('ç½®é¡¶çŸ­ä¿¡å¯¹è¯å¤±è´¥:', error);
                showToast('ç½®é¡¶å¯¹è¯å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½ç½®é¡¶çŠ¶æ€
        function loadPinnedSMSConversations() {
            try {
                const saved = localStorage.getItem('pinnedSMSConversations');
                if (saved) {
                    pinnedSMSConversations = new Set(JSON.parse(saved));
                }
            } catch (error) {
                console.error('åŠ è½½ç½®é¡¶çŠ¶æ€å¤±è´¥:', error);
                pinnedSMSConversations = new Set();
            }
        }













        // å›¾ç‰‡å°ç»„ä»¶åŠŸèƒ½
        function showPhotoWidgetOptions() {
            document.getElementById('photo-widget-modal').style.display = 'flex';
        }

        function closePhotoWidgetModal() {
            document.getElementById('photo-widget-modal').style.display = 'none';
        }

        function handlePhotoWidgetUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const imageData = e.target.result;

                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('photoWidgetImage', imageData);

                    // æ›´æ–°æ˜¾ç¤º
                    updatePhotoWidget(imageData);

                    showToast('å›¾ç‰‡å·²è®¾ç½®', 'success');
                    closePhotoWidgetModal();
                };

                reader.readAsDataURL(file);
            }
        }

        function updatePhotoWidget(imageData) {
            const placeholder = document.getElementById('photo-placeholder');
            const image = document.getElementById('photo-widget-image');

            if (imageData) {
                placeholder.style.display = 'none';
                image.src = imageData;
                image.style.display = 'block';

                // ç¡®ä¿å›¾ç‰‡æ­£ç¡®ç¼©æ”¾
                image.onload = function() {
                    // å›¾ç‰‡å·²åŠ è½½ï¼ŒCSSä¼šè‡ªåŠ¨å¤„ç†ç¼©æ”¾
                };
            } else {
                placeholder.style.display = 'block';
                image.style.display = 'none';
            }
        }

        function clearPhotoWidget() {
            localStorage.removeItem('photoWidgetImage');
            updatePhotoWidget(null);
            showToast('å›¾ç‰‡å·²æ¸…é™¤', 'success');
            closePhotoWidgetModal();
        }

        // çºªå¿µæ—¥å°ç»„ä»¶åŠŸèƒ½
        function showAnniversaryWidgetOptions() {
            // æ›´æ–°é€‰æ‹©åˆ—è¡¨
            updateAnniversaryWidgetSelect();
            document.getElementById('anniversary-widget-modal').style.display = 'flex';
        }

        function closeAnniversaryWidgetModal() {
            document.getElementById('anniversary-widget-modal').style.display = 'none';
        }

        function updateAnniversaryWidgetSelect() {
            const select = document.getElementById('widget-anniversary-select');
            const currentSelection = localStorage.getItem('anniversaryWidgetSelection');

            // æ¸…ç©ºé€‰é¡¹
            select.innerHTML = '<option value="">è¯·é€‰æ‹©çºªå¿µæ—¥</option>';

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘ä¼˜å…ˆæ˜¾ç¤ºç½®é¡¶çš„çºªå¿µæ—¥
            const pinnedAnniversaries = anniversaries.filter(a => a.isPinned);
            const regularAnniversaries = anniversaries.filter(a => !a.isPinned);

            // å…ˆæ·»åŠ ç½®é¡¶çºªå¿µæ—¥
            if (pinnedAnniversaries.length > 0) {
                const pinnedGroup = document.createElement('optgroup');
                pinnedGroup.label = 'â­ ç½®é¡¶çºªå¿µæ—¥';
                pinnedAnniversaries.forEach(anniversary => {
                    const option = document.createElement('option');
                    option.value = anniversary.id;
                    option.textContent = anniversary.name;
                    if (anniversary.id === currentSelection) {
                        option.selected = true;
                    }
                    pinnedGroup.appendChild(option);
                });
                select.appendChild(pinnedGroup);
            }

            // å†æ·»åŠ æ™®é€šçºªå¿µæ—¥
            if (regularAnniversaries.length > 0) {
                const regularGroup = document.createElement('optgroup');
                regularGroup.label = 'ğŸ“… å…¶ä»–çºªå¿µæ—¥';
                regularAnniversaries.forEach(anniversary => {
                    const option = document.createElement('option');
                    option.value = anniversary.id;
                    option.textContent = anniversary.name;
                    if (anniversary.id === currentSelection) {
                        option.selected = true;
                    }
                    regularGroup.appendChild(option);
                });
                select.appendChild(regularGroup);
            }
        }

        function updateAnniversaryWidget() {
            const select = document.getElementById('widget-anniversary-select');
            const selectedId = select.value;

            if (selectedId) {
                const anniversary = anniversaries.find(a => a.id === selectedId);
                if (anniversary) {
                    localStorage.setItem('anniversaryWidgetSelection', selectedId);
                    displayAnniversaryWidget(anniversary);
                    showToast('çºªå¿µæ—¥å°ç»„ä»¶å·²æ›´æ–°', 'success');
                }
            } else {
                clearAnniversaryWidget();
            }
        }

        function displayAnniversaryWidget(anniversary) {
            const placeholder = document.getElementById('anniversary-placeholder');
            const display = document.getElementById('anniversary-display');
            const nameEl = document.getElementById('widget-anniversary-name');
            const countdownEl = document.getElementById('widget-anniversary-countdown');
            const dateEl = document.getElementById('widget-anniversary-date');
            const widget = document.querySelector('.anniversary-widget-content').parentElement;

            // è®¡ç®—å¤©æ•°
            const now = new Date();
            const currentYear = now.getFullYear();
            const anniversaryDate = new Date(anniversary.date);
            const countType = anniversary.countType || 'countdown'; // é»˜è®¤ä¸ºå€’æ•°

            let countdownText = '';

            if (countType === 'countup') {
                // æ­£æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼Œç¬¬äºŒå¤©æ˜¾ç¤º1å¤©ï¼‰
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const anniversaryDateOnly = new Date(anniversaryDate.getFullYear(), anniversaryDate.getMonth(), anniversaryDate.getDate());
                const daysPassed = Math.floor((today - anniversaryDateOnly) / (1000 * 60 * 60 * 24));
                countdownText = daysPassed === 0 ? 'ä»Šå¤©' :
                               `${daysPassed}`;
            } else {
                // å€’æ•°ï¼šåŸºäºæ—¥å†æ—¥æœŸè®¡ç®—ï¼ˆå½“å¤©æ˜¾ç¤º"ä»Šå¤©"ï¼‰
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                let nextDate = new Date(currentYear, anniversaryDate.getMonth(), anniversaryDate.getDate());

                if (nextDate < today) {
                    nextDate.setFullYear(currentYear + 1);
                }

                const daysUntil = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                countdownText = daysUntil === 0 ? 'ä»Šå¤©' :
                               daysUntil === 1 ? 'æ˜å¤©' :
                               `${daysUntil}`;
            }

            // æ›´æ–°æ˜¾ç¤º
            nameEl.textContent = anniversary.name;
            countdownEl.textContent = countdownText;
            dateEl.textContent = formatDate(anniversary.date);

            // è®¾ç½®èƒŒæ™¯å›¾
            if (anniversary.backgroundImage) {
                widget.style.backgroundImage = `url('${anniversary.backgroundImage}')`;
                widget.style.backgroundSize = 'cover';
                widget.style.backgroundPosition = 'center';
                widget.style.backgroundRepeat = 'no-repeat';
                // æ·»åŠ åŠé€æ˜é®ç½©ä»¥ç¡®ä¿æ–‡å­—å¯è¯»æ€§
                widget.style.position = 'relative';
                if (!widget.querySelector('.widget-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'widget-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.1);
                        border-radius: inherit;
                        z-index: 1;
                    `;
                    widget.appendChild(overlay);
                }
                // ç¡®ä¿å†…å®¹åœ¨é®ç½©ä¹‹ä¸Šï¼Œè®¾ç½®ç™½è‰²æ–‡å­—
                const content = widget.querySelector('.anniversary-widget-content');
                if (content) {
                    content.style.position = 'relative';
                    content.style.zIndex = '2';

                    // ç¡®ä¿æ–‡å­—æ ·å¼æ­£ç¡®åº”ç”¨
                    const nameEl = content.querySelector('#widget-anniversary-name');
                    const countdownEl = content.querySelector('#widget-anniversary-countdown');
                    const dateEl = content.querySelector('#widget-anniversary-date');

                    // åªè®¾ç½®å¿…è¦çš„ç™½è‰²æ–‡å­—å’Œé˜´å½±ï¼Œè®©CSSæ§åˆ¶å¤§å°å’Œå¸ƒå±€
                    if (nameEl) {
                        nameEl.style.cssText += `
                            color: rgba(255, 255, 255, 0.9) !important;
                            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
                        `;
                    }

                    if (countdownEl) {
                        countdownEl.style.cssText += `
                            color: white !important;
                            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8) !important;
                        `;
                    }

                    if (dateEl) {
                        dateEl.style.cssText += `
                            color: rgba(255, 255, 255, 0.8) !important;
                            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
                        `;
                    }
                }
            } else {
                // æ¸…é™¤èƒŒæ™¯å›¾
                widget.style.backgroundImage = '';
                const overlay = widget.querySelector('.widget-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            placeholder.style.display = 'none';
            display.style.display = 'block';
        }

        function clearAnniversaryWidget() {
            localStorage.removeItem('anniversaryWidgetSelection');
            const placeholder = document.getElementById('anniversary-placeholder');
            const display = document.getElementById('anniversary-display');
            const widget = document.querySelector('.anniversary-widget-content').parentElement;

            // æ¸…é™¤èƒŒæ™¯å›¾å’Œé®ç½©
            if (widget) {
                widget.style.backgroundImage = '';
                const overlay = widget.querySelector('.widget-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            placeholder.style.display = 'block';
            display.style.display = 'none';

            showToast('çºªå¿µæ—¥å°ç»„ä»¶å·²æ¸…é™¤', 'success');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¼ºåˆ¶åˆ·æ–°çºªå¿µæ—¥å°ç»„ä»¶
        function refreshAnniversaryWidget() {
            if (anniversaries && anniversaries.length > 0) {
                // ä¼˜å…ˆæ˜¾ç¤ºç½®é¡¶çš„çºªå¿µæ—¥
                const pinnedAnniversary = anniversaries.find(a => a.isPinned);
                if (pinnedAnniversary) {
                    localStorage.setItem('anniversaryWidgetSelection', pinnedAnniversary.id);
                    displayAnniversaryWidget(pinnedAnniversary);
                    return;
                }

                // å¦‚æœæ²¡æœ‰ç½®é¡¶çš„ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªçºªå¿µæ—¥
                const firstAnniversary = anniversaries[0];
                if (firstAnniversary) {
                    localStorage.setItem('anniversaryWidgetSelection', firstAnniversary.id);
                    displayAnniversaryWidget(firstAnniversary);
                }
            } else {
                clearAnniversaryWidget();
            }
        }

        // ğŸ”¥ã€å¼€å‘è€…è°ƒè¯•ã€‘æ‰‹åŠ¨åˆ·æ–°å°ç»„ä»¶çš„å…¨å±€å‡½æ•°
        window.refreshWidget = refreshAnniversaryWidget;

        // ğŸ”¥ã€å¼€å‘è€…è°ƒè¯•ã€‘çºªå¿µæ—¥å°ç»„ä»¶è°ƒè¯•å·¥å…·
        window.anniversaryWidgetDebug = {
            // æŸ¥çœ‹å½“å‰çºªå¿µæ—¥åˆ—è¡¨
            listAnniversaries: () => {
                console.table(anniversaries.map(a => ({
                    id: a.id,
                    name: a.name,
                    isPinned: a.isPinned,
                    hasBackground: !!a.backgroundImage,
                    hasUserAvatar: !!a.userAvatar
                })));
            },

            // æŸ¥çœ‹å½“å‰å°ç»„ä»¶çŠ¶æ€
            checkWidget: () => {
                const saved = localStorage.getItem('anniversaryWidgetSelection');
                const current = anniversaries.find(a => a.id === saved);
                console.log('å°ç»„ä»¶çŠ¶æ€:', {
                    savedId: saved,
                    currentAnniversary: current ? current.name : 'æœªæ‰¾åˆ°',
                    isPinned: current ? current.isPinned : false,
                    hasBackground: current ? !!current.backgroundImage : false
                });
            },

            // å¼ºåˆ¶åˆ·æ–°å°ç»„ä»¶
            refresh: refreshAnniversaryWidget,

            // æ¸…é™¤å°ç»„ä»¶
            clear: clearAnniversaryWidget
        };

        // åˆå§‹åŒ–å°ç»„ä»¶
        function initializeWidgets() {
            try {
                // åˆå§‹åŒ–å›¾ç‰‡å°ç»„ä»¶
                const savedImage = localStorage.getItem('photoWidgetImage');
                if (savedImage) {
                    updatePhotoWidget(savedImage);
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘åˆå§‹åŒ–çºªå¿µæ—¥å°ç»„ä»¶ - ä¼˜å…ˆæ˜¾ç¤ºç½®é¡¶çºªå¿µæ—¥
                const savedAnniversary = localStorage.getItem('anniversaryWidgetSelection');
                if (anniversaries && anniversaries.length > 0) {
                    let anniversaryToShow = null;

                    // å¦‚æœæœ‰ä¿å­˜çš„é€‰æ‹©ï¼Œä¼˜å…ˆä½¿ç”¨
                    if (savedAnniversary) {
                        anniversaryToShow = anniversaries.find(a => a.id === savedAnniversary);
                    }

                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é€‰æ‹©æˆ–è€…ä¿å­˜çš„çºªå¿µæ—¥ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç½®é¡¶çš„çºªå¿µæ—¥
                    if (!anniversaryToShow) {
                        const pinnedAnniversary = anniversaries.find(a => a.isPinned);
                        if (pinnedAnniversary) {
                            anniversaryToShow = pinnedAnniversary;
                            // ä¿å­˜è¿™ä¸ªé€‰æ‹©
                            localStorage.setItem('anniversaryWidgetSelection', pinnedAnniversary.id);
                        }
                    }

                    if (anniversaryToShow) {
                        displayAnniversaryWidget(anniversaryToShow);
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å°ç»„ä»¶å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢ç…§ç‰‡æ–‡å­—æ˜¾ç¤º
        function togglePhotoText(container, description) {
            const overlay = container.querySelector('.photo-text-overlay');
            const sparkles = container.querySelector('.sparkle-container');
            const badge = container.querySelector('.photo-badge');

            if (overlay.style.display === 'none') {
                // æ˜¾ç¤ºæ–‡å­—ï¼Œéšè—æ˜Ÿæ˜Ÿå’Œæ ‡å¿—
                overlay.style.display = 'flex';
                sparkles.style.opacity = '0';
                badge.style.opacity = '0.3';
            } else {
                // éšè—æ–‡å­—ï¼Œæ˜¾ç¤ºæ˜Ÿæ˜Ÿå’Œæ ‡å¿—
                overlay.style.display = 'none';
                sparkles.style.opacity = '1';
                badge.style.opacity = '1';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ç…§ç‰‡æè¿°
        function showUserPhotoDescription(description) {
            const modalHtml = `
                <div id="photo-description-modal" class="modal" style="display: flex; z-index: 10000; background: rgba(0, 0, 0, 0.8);">
                    <div class="magical-photo-modal">
                        <div class="photo-modal-bg"></div>
                        <div class="photo-modal-content">
                            <div class="photo-modal-header">
                                <i class="fas fa-camera photo-modal-icon"></i>
                                <div class="photo-modal-title">ç…§ç‰‡å†…å®¹</div>
                            </div>
                            <div class="photo-modal-body">
                                <div class="photo-description-text">${description}</div>
                            </div>
                            <div class="photo-modal-footer">
                                <button class="photo-modal-btn" id="photo-description-close">ç¡®å®š</button>
                            </div>
                        </div>
                        <div class="modal-sparkles">
                            <div class="modal-sparkle modal-sparkle-1">âœ¨</div>
                            <div class="modal-sparkle modal-sparkle-2">â­</div>
                            <div class="modal-sparkle modal-sparkle-3">âœ¨</div>
                            <div class="modal-sparkle modal-sparkle-4">â­</div>
                            <div class="modal-sparkle modal-sparkle-5">ğŸ’«</div>
                            <div class="modal-sparkle modal-sparkle-6">âœ¨</div>
                            <div class="modal-sparkle modal-sparkle-7">â­</div>
                            <div class="modal-sparkle modal-sparkle-8">ğŸ’«</div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('photo-description-modal');
            const closeBtn = document.getElementById('photo-description-close');

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.onclick = () => {
                modal.remove();
            };

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // è‡ªå®šä¹‰è¾“å…¥æç¤ºæ¡†
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                // åˆ›å»ºæ¨¡æ€æ¡†HTML
                const modalHtml = `
                    <div id="custom-prompt-modal" class="modal" style="display: flex; z-index: 10000;">
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <div class="modal-title">${title}</div>
                            </div>
                            <div class="modal-body">
                                <input type="${type}" id="custom-prompt-input" class="form-input"
                                       placeholder="${placeholder}" value="${initialValue}"
                                       style="width: 100%; margin-top: 10px;">
                            </div>
                            <div class="modal-footer">
                                <button class="modal-button modal-secondary" id="custom-prompt-cancel">å–æ¶ˆ</button>
                                <button class="modal-button modal-primary" id="custom-prompt-confirm">ç¡®å®š</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('custom-prompt-modal');
                const input = document.getElementById('custom-prompt-input');
                const confirmBtn = document.getElementById('custom-prompt-confirm');
                const cancelBtn = document.getElementById('custom-prompt-cancel');

                // ç¡®å®šæŒ‰é’®äº‹ä»¶
                confirmBtn.onclick = () => {
                    const value = input.value;
                    modal.remove();
                    resolve(value);
                };

                // å–æ¶ˆæŒ‰é’®äº‹ä»¶
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(null);
                };

                // å›è½¦é”®ç¡®è®¤
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                };

                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => input.focus(), 100);
            });
        }

        // åˆ‡æ¢èŠå¤©æ ‡ç­¾
        function switchChatTab(tabId) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.chat-tab').forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });

            // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeç±»
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            } else {
                // å¦‚æœæ²¡æœ‰eventå¯¹è±¡ï¼Œæ ¹æ®tabIdè®¾ç½®active
                if (tabId === 'message-list') {
                    const messageTab = document.getElementById('message-tab');
                    if (messageTab && messageTab.classList) {
                        messageTab.classList.add('active');
                    }
                } else if (tabId === 'contact-list') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 1 && tabs[1] && tabs[1].classList) {
                        tabs[1].classList.add('active');
                    }
                } else if (tabId === 'moments-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 2 && tabs[2] && tabs[2].classList) {
                        tabs[2].classList.add('active');
                    }
                } else if (tabId === 'profile-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 3 && tabs[3] && tabs[3].classList) {
                        tabs[3].classList.add('active');
                    }
                }
            }

            // éšè—æ‰€æœ‰å†…å®¹
            const messageListEl = document.getElementById('message-list');
            const contactListEl = document.getElementById('contact-list');
            const profilePageEl = document.getElementById('profile-page');
            const momentsPageEl = document.getElementById('moments-page');
            const targetEl = document.getElementById(tabId);

            if (messageListEl) messageListEl.style.display = 'none';
            if (contactListEl) contactListEl.style.display = 'none';
            if (profilePageEl) profilePageEl.style.display = 'none';
            if (momentsPageEl) momentsPageEl.style.display = 'none';

            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            if (targetEl) targetEl.style.display = 'block';

            // æ§åˆ¶appæ ‡é¢˜çš„æ¸å˜æ•ˆæœå’Œå†…å®¹
            const appTitle = document.querySelector('#chat-screen .app-title');
            if (appTitle) {
                if (tabId === 'message-list') {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'ğŸ’¬';
                } else if (tabId === 'contact-list') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'è§’è‰²';
                } else if (tabId === 'moments-page') {
                    appTitle.classList.remove('chat-mode');
                                            appTitle.textContent = 'åŠ¨æ€';
                    // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢åˆ°åŠ¨æ€é¡µé¢æ—¶åŠ è½½ç”¨æˆ·è®¾ç½®
                    loadMomentsImages();
                } else if (tabId === 'profile-page') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'æˆ‘';
                }
            }

            // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
            const addContactBtn = document.getElementById('add-contact-btn');
            const addChatBtn = document.getElementById('add-chat-btn');
            const groupManageBtn = document.getElementById('group-manage-btn');

            if (addContactBtn && addChatBtn && groupManageBtn) {
                if (tabId === 'contact-list') {
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = isGroupManageMode ? 'none' : 'flex';
                    // ä¿®æ”¹åŠ å·æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸ºåˆ›å»ºè§’è‰²
                    addContactBtn.onclick = () => showCharacterForm();
                } else if (tabId === 'message-list') {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'flex';
                    groupManageBtn.style.display = 'none';
                } else if (tabId === 'moments-page') {
                                            // åŠ¨æ€é¡µé¢æ˜¾ç¤ºå‘å¸ƒæŒ‰é’®
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = 'none';
                    // ä¿®æ”¹åŠ å·æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸ºå‘å¸ƒåŠ¨æ€
                    addContactBtn.onclick = () => showPublishMoment();
                } else {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = 'none';
                }
            }

            // å¦‚æœæ˜¯åŠ¨æ€é¡µé¢ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½åŠ¨æ€å†…å®¹
            if (tabId === 'moments-page') {
                // åªåœ¨åŠ¨æ€åˆ—è¡¨ä¸ºç©ºæ—¶åŠ è½½ï¼Œé¿å…é‡å¤æ˜¾ç¤º
                const momentsList = document.getElementById('moments-list');
                if (momentsList && momentsList.children.length === 0) {
                loadMoments();
                }
                                        // ç§»é™¤åŠ¨æ€é¡µé¢çš„paddingï¼Œå®ç°å…¨å±æ•ˆæœ
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '0';
                }
            } else {
                // å…¶ä»–é¡µé¢æ¢å¤æ­£å¸¸padding
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '15px';
                }

                // åœæ­¢æ—¶é—´æ›´æ–°å™¨ï¼ˆèŠ‚çœèµ„æºï¼‰
                stopTimeUpdater();
            }
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;

            // æ›´æ–°çŠ¶æ€æ æ—¶é—´
            const statusTime = document.getElementById('status-bar-time');
            if (statusTime) {
                statusTime.textContent = timeString;
            }

            // æ›´æ–°åº”ç”¨å†…çŠ¶æ€æ æ—¶é—´
            const appStatusTimes = document.querySelectorAll('.app-status-time');
            appStatusTimes.forEach(element => {
                element.textContent = timeString;
            });

            // æ›´æ–°ä¸»æ—¶é’Ÿ
            const mainTime = document.getElementById('main-time');
            if (mainTime) {
                mainTime.textContent = timeString;
            }

            // æ›´æ–°æ—¥æœŸ
            const mainDate = document.getElementById('main-date');
            if (mainDate) {
                // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®æ—¶é’Ÿæ ·å¼æ˜¾ç¤ºä¸åŒçš„æ—¥æœŸæ ¼å¼
                const clockStyle = document.body.getAttribute('data-clock-style') || 'default';
                let dateText = '';

                switch (clockStyle) {
                    case 'modern':
                        // ç°ä»£æ ·å¼ï¼šè‹±æ–‡æ ¼å¼ "MON, DEC 18"
                        dateText = now.toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        }).toUpperCase();
                        break;
                    case 'compact':
                        // ç´§å‡‘æ ·å¼ï¼šç®€çŸ­æ ¼å¼ "12/18 å‘¨ä¸€"
                        const compactDate = now.toLocaleDateString('zh-CN', {
                            month: 'numeric',
                            day: 'numeric'
                        });
                        const compactWeekday = now.toLocaleDateString('zh-CN', {
                            weekday: 'short'
                        });
                        dateText = `${compactDate} ${compactWeekday}`;
                        break;
                    case 'bold':
                        // ç²—ä½“æ ·å¼ï¼šå®Œæ•´æ ¼å¼ "12æœˆ18æ—¥ æ˜ŸæœŸä¸€"
                        dateText = now.toLocaleDateString('zh-CN', {
                            month: 'long',
                            day: 'numeric',
                            weekday: 'long'
                        });
                        break;
                    default:
                        // é»˜è®¤æ ·å¼ï¼šæ ‡å‡†æ ¼å¼
                        dateText = now.toLocaleDateString('zh-CN', {
                            month: 'long',
                            day: 'numeric',
                            weekday: 'long'
                        });
                        break;
                }

                mainDate.textContent = dateText;
            }
        }

        // åŠ è½½è§’è‰²åˆ†ç»„æ•°æ®
        async function loadCharacterGroups() {
            try {
                const savedGroups = await db.characterGroups.orderBy('order').toArray();

                if (savedGroups.length === 0) {
                    // å¦‚æœæ²¡æœ‰åˆ†ç»„ï¼Œåˆ›å»ºé»˜è®¤åˆ†ç»„
                    const defaultGroups = [
                        { id: 'my_friends', name: 'æˆ‘çš„å¥½å‹', order: 999, isDefault: true, canInteract: false },
                        { id: 'special_care', name: 'ç‰¹åˆ«å…³å¿ƒ', order: 1, isDefault: false, canInteract: true },
                        { id: 'close_friends', name: 'äº²å¯†æœ‹å‹', order: 2, isDefault: false, canInteract: true },
                        { id: 'family', name: 'å®¶äºº', order: 3, isDefault: false, canInteract: true },
                        { id: 'classmates', name: 'åŒå­¦', order: 4, isDefault: false, canInteract: true },
                        { id: 'colleagues', name: 'åŒäº‹', order: 5, isDefault: false, canInteract: true }
                    ];

                    await db.characterGroups.bulkAdd(defaultGroups);
                    characterGroups = defaultGroups;
                } else {
                    characterGroups = savedGroups;
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²åˆ†ç»„å¤±è´¥:', error);
                // åˆ›å»ºåŸºæœ¬çš„é»˜è®¤åˆ†ç»„
                characterGroups = [
                    { id: 'my_friends', name: 'æˆ‘çš„å¥½å‹', order: 999, isDefault: true, canInteract: false }
                ];
            }
        }

        // ä¿å­˜è§’è‰²åˆ†ç»„æ•°æ®
        async function saveCharacterGroups() {
            try {
                await db.characterGroups.clear();
                await db.characterGroups.bulkAdd(characterGroups);
            } catch (error) {
                console.error('ä¿å­˜è§’è‰²åˆ†ç»„å¤±è´¥:', error);
            }
        }

        // åŠ è½½è§’è‰²æ•°æ® - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadCharacters() {
            try {
                // å…ˆæ£€æŸ¥IndexedDBä¸­æ˜¯å¦æœ‰æ•°æ®
                const savedCharacters = await db.characters.toArray();

                if (savedCharacters.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('characters');
                    if (localStorageData) {
                        const localCharacters = JSON.parse(localStorageData);

                        if (localCharacters.length > 0) {
                            // ä¸ºæ—§è§’è‰²æ•°æ®æ·»åŠ é»˜è®¤åˆ†ç»„
                            localCharacters.forEach(character => {
                                if (!character.groupId) {
                                    character.groupId = 'my_friends'; // é»˜è®¤åˆ†ç»„
                                }
                            });

                            // è¿ç§»æ•°æ®åˆ°IndexedDB
                            await db.characters.bulkAdd(localCharacters);
                            characters = localCharacters;
                            // å¯é€‰ï¼šæ¸…é™¤localStorageä¸­çš„æ—§æ•°æ®
                            // localStorage.removeItem('characters');
                        } else {
                            characters = [];
                        }
                    } else {
                        characters = [];
                    }
                } else {
                    // ç¡®ä¿æ‰€æœ‰è§’è‰²éƒ½æœ‰åˆ†ç»„ID
                    savedCharacters.forEach(character => {
                        if (!character.groupId) {
                            character.groupId = 'my_friends';
                        }
                    });
                    characters = savedCharacters;
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²æ•°æ®å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½
                const localStorageData = localStorage.getItem('characters');
                if (localStorageData) {
                    characters = JSON.parse(localStorageData);
                    // ä¸ºè§’è‰²æ·»åŠ é»˜è®¤åˆ†ç»„
                    characters.forEach(character => {
                        if (!character.groupId) {
                            character.groupId = 'my_friends';
                        }
                    });

                } else {
                    characters = [];
                }
            }
        }

        // ä¿å­˜è§’è‰²æ•°æ® - ä½¿ç”¨IndexedDB
        async function saveCharacters() {
            try {


                // æ£€æŸ¥é‡å¤ID
                const uniqueIds = new Set();
                const uniqueCharacters = [];

                for (const character of characters) {
                    if (!character.id) {
                        console.warn('å‘ç°æ²¡æœ‰IDçš„è§’è‰²ï¼Œè·³è¿‡ä¿å­˜:', character);
                        continue;
                    }

                    if (!uniqueIds.has(character.id)) {
                        uniqueIds.add(character.id);
                        uniqueCharacters.push(character);
                    } else {
                        console.warn(`å‘ç°é‡å¤IDçš„è§’è‰² (${character.id})ï¼Œè·³è¿‡é‡å¤é¡¹:`, character);
                    }
                }

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ“ä½œï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                if (uniqueCharacters.length === 0) {
                    console.warn('âš ï¸ æ‹’ç»ä¿å­˜ç©ºè§’è‰²æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±é£é™©');
                    return;
                }

                // ä½¿ç”¨äº‹åŠ¡è¿›è¡ŒåŸå­æ“ä½œ
                await db.transaction('rw', db.characters, async () => {
                    await db.characters.clear();
                    await db.characters.bulkPut(uniqueCharacters);
                });

                console.log(`âœ… å®‰å…¨ä¿å­˜äº† ${uniqueCharacters.length} ä¸ªè§’è‰²åˆ°æ•°æ®åº“`);


            } catch (error) {
                console.error('ä¿å­˜è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('ä¿å­˜è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                throw error;
            }
        }

        // æ˜¾ç¤ºå­˜å‚¨ä½¿ç”¨æƒ…å†µ
        function showStorageUsage() {
            const usage = [];

            // è®¡ç®—å„ç§æ•°æ®çš„å¤§å°
            const characters = localStorage.getItem('characters') || '[]';
            const chatMessages = localStorage.getItem('chatMessages') || '{}';
            const customEmojis = localStorage.getItem('customEmojis') || '[]';

            usage.push(`è§’è‰²æ•°æ®: ${(characters.length / 1024).toFixed(1)} KB`);
            usage.push(`èŠå¤©è®°å½•: ${(chatMessages.length / 1024).toFixed(1)} KB`);
            usage.push(`è¡¨æƒ…åŒ…: ${(customEmojis.length / 1024).toFixed(1)} KB`);

            const total = characters.length + chatMessages.length + customEmojis.length;
            usage.push(`æ€»è®¡: ${(total / 1024).toFixed(1)} KB`);


            alert('å­˜å‚¨ä½¿ç”¨æƒ…å†µ:\n' + usage.join('\n'));
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘åŠ è½½è”ç³»äººæ•°æ® - åªåŠ è½½ç”¨æˆ·ä¸»åŠ¨æ·»åŠ çš„è”ç³»äººï¼Œå¢å¼ºæµè§ˆå™¨å…¼å®¹æ€§
        async function loadContacts() {
            try {
                console.log('ğŸ”„ åŠ è½½è”ç³»äººåˆ—è¡¨...');

                // ä»æ•°æ®åº“åŠ è½½è”ç³»äººåˆ—è¡¨
                const savedContacts = await db.contacts.toArray();

                if (savedContacts.length === 0) {
                    // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è”ç³»äººï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('contacts');
                    if (localStorageData) {
                        const localContacts = JSON.parse(localStorageData);
                        contacts = Array.isArray(localContacts) ? localContacts : [];
                        console.log(`âœ… ä»localStorageè¿ç§»äº† ${contacts.length} ä¸ªè”ç³»äºº`);
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        await saveContacts();
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸è‡ªåŠ¨ç”Ÿæˆè”ç³»äººåˆ—è¡¨ï¼Œä¿æŒç”¨æˆ·çš„åˆ é™¤æ“ä½œ
                        contacts = [];
                        console.log('âœ… åˆå§‹åŒ–ç©ºè”ç³»äººåˆ—è¡¨ï¼ˆç”¨æˆ·å¯èƒ½åˆ é™¤äº†æ‰€æœ‰å¯¹è¯ï¼‰');
                    }
                } else {
                    // ä»æ•°æ®åº“å¯¹è±¡æ•°ç»„è½¬æ¢ä¸ºIDæ•°ç»„
                    contacts = savedContacts.map(contact => contact.characterId).filter(id => id);
                    console.log(`âœ… ä»æ•°æ®åº“åŠ è½½äº† ${contacts.length} ä¸ªè”ç³»äºº`);

                    // ğŸ”¥ã€ä¿®å¤ã€‘åªæ¸…ç†æ— æ•ˆçš„è”ç³»äººï¼Œä¸è‡ªåŠ¨æ·»åŠ æ–°çš„
                    if (characters && characters.length > 0) {
                        const characterIds = characters.map(char => char.id);
                        const validContacts = contacts.filter(id => characterIds.includes(id));

                        // åªæœ‰å½“å‘ç°æ— æ•ˆè”ç³»äººæ—¶æ‰æ›´æ–°
                        if (validContacts.length !== contacts.length) {
                            const removedCount = contacts.length - validContacts.length;
                            console.log(`ğŸ”§ æ¸…ç†äº† ${removedCount} ä¸ªæ— æ•ˆçš„è”ç³»äººè®°å½•`);
                            contacts = validContacts;
                            await saveContacts();
                        }
                    }
                }

            } catch (error) {
                console.error('âŒ åŠ è½½è”ç³»äººåˆ—è¡¨å¤±è´¥:', error);
                // ğŸ”¥ã€æµè§ˆå™¨å…¼å®¹æ€§ä¿®å¤ã€‘å‡ºé”™æ—¶å°è¯•ä»è§’è‰²åˆ—è¡¨é‡å»º
                if (characters && characters.length > 0) {
                    console.log('ğŸ”§ å‡ºé”™æ—¶ä»è§’è‰²åˆ—è¡¨é‡å»ºè”ç³»äºº');
                    contacts = characters.map(char => char.id);
                } else {
                    contacts = []; // å¦‚æœå‡ºé”™ï¼Œç¡®ä¿è”ç³»äººåˆ—è¡¨ä¸ºç©ºï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ
                }
            }
        }



        // ä¿å­˜è”ç³»äººæ•°æ® - ä½¿ç”¨IndexedDB
        async function saveContacts() {
            try {
        // è¿‡æ»¤æ‰ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ— æ•ˆID
        const validContacts = contacts.filter(id => id);
        // å°†è”ç³»äººIDåˆ—è¡¨è½¬æ¢ä¸ºæ•°æ®åº“éœ€è¦çš„å¯¹è±¡æ•°ç»„æ ¼å¼
        const contactArray = validContacts.map(id => ({ characterId: id }));

        await db.transaction('rw', db.contacts, async () => {
            // å…ˆæ¸…ç©ºæ—§è¡¨ï¼Œå†æ‰¹é‡å†™å…¥æ–°æ•°æ®
                await db.contacts.clear();
                if (contactArray.length > 0) {
                    await db.contacts.bulkAdd(contactArray);
                }
        });
            } catch (error) {
                console.error('ä¿å­˜è”ç³»äººå¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®ç®¡ç†ã€‘åŠ è½½çŸ­ä¿¡è”ç³»äºº
        async function loadSMSContacts() {
            try {
                console.log('ğŸ”„ åŠ è½½çŸ­ä¿¡è”ç³»äººåˆ—è¡¨...');
                const savedSMSContacts = await db.smsContacts.toArray();

                // è½¬æ¢ä¸ºç®€å•çš„IDæ•°ç»„æ ¼å¼ï¼Œä¿æŒä¸åŸæœ‰é€»è¾‘å…¼å®¹
                smsContacts = savedSMSContacts.map(contact => contact.characterId).filter(id => id);
                console.log(`âœ… ä»æ•°æ®åº“åŠ è½½äº† ${smsContacts.length} ä¸ªçŸ­ä¿¡è”ç³»äºº`);

                // æ¸…ç†æ— æ•ˆçš„è”ç³»äººï¼ˆè§’è‰²å·²è¢«åˆ é™¤ï¼‰
                if (characters && characters.length > 0) {
                    const characterIds = characters.map(char => char.id);
                    const validSMSContacts = smsContacts.filter(id => characterIds.includes(id));

                    if (validSMSContacts.length !== smsContacts.length) {
                        const removedCount = smsContacts.length - validSMSContacts.length;
                        console.log(`ğŸ”§ æ¸…ç†äº† ${removedCount} ä¸ªæ— æ•ˆçš„çŸ­ä¿¡è”ç³»äººè®°å½•`);
                        smsContacts = validSMSContacts;
                        await saveSMSContacts();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½çŸ­ä¿¡è”ç³»äººå¤±è´¥:', error);
                smsContacts = [];
            }
        }

        // ğŸ”¥ã€çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®ç®¡ç†ã€‘ä¿å­˜çŸ­ä¿¡è”ç³»äºº
        async function saveSMSContacts() {
            try {
                const validSMSContacts = smsContacts.filter(id => id);
                const smsContactArray = validSMSContacts.map(id => ({
                    characterId: id,
                    createdAt: Date.now()
                }));

                await db.transaction('rw', db.smsContacts, async () => {
                    await db.smsContacts.clear();
                    if (smsContactArray.length > 0) {
                        await db.smsContacts.bulkAdd(smsContactArray);
                    }
                });
                console.log(`âœ… ä¿å­˜äº† ${validSMSContacts.length} ä¸ªçŸ­ä¿¡è”ç³»äºº`);
            } catch (error) {
                console.error('ä¿å­˜çŸ­ä¿¡è”ç³»äººå¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®ç®¡ç†ã€‘åŠ è½½çŸ­ä¿¡æ¶ˆæ¯
        async function loadSMSMessages() {
            try {
                console.log('ğŸ”„ åŠ è½½çŸ­ä¿¡æ¶ˆæ¯...');
                const savedSMSMessages = await db.smsMessages.toArray();
                smsMessages = {};

                // ğŸ”¥ã€ä¿®å¤ã€‘å°†æ•°æ®åº“æ ¼å¼è½¬æ¢ä¸ºæ–°çš„å¤šæ¨¡æ€å†…å­˜æ ¼å¼ï¼Œæ”¯æŒå›¾ç‰‡æ¶ˆæ¯
                savedSMSMessages.forEach(msg => {
                    if (!smsMessages[msg.characterId]) {
                        smsMessages[msg.characterId] = [];
                    }

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ ¹æ®æ¶ˆæ¯ç±»å‹æ„å»ºæ­£ç¡®çš„å¤šæ¨¡æ€æ ¼å¼
                    let messageContent = [];

                    if (msg.isImage && msg.imageUrl) {
                        // å›¾ç‰‡æ¶ˆæ¯ï¼šåŒ…å«æ–‡æœ¬å’Œå›¾ç‰‡ä¸¤éƒ¨åˆ†
                        messageContent = [
                            { type: 'text', text: msg.content || '' },
                            { type: 'image_url', image_url: { url: msg.imageUrl } }
                        ];
                    } else {
                        // æ–‡æœ¬æ¶ˆæ¯ï¼šåªåŒ…å«æ–‡æœ¬
                        messageContent = [
                            { type: 'text', text: msg.content || '' }
                        ];
                    }

                    const messageObj = {
                        id: msg.id,
                        content: messageContent, // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è½¬æ¢ä¸ºå¤šæ¨¡æ€æ•°ç»„æ ¼å¼
                        text: msg.content, // ä¿ç•™ä»¥ä¾¿çŸ­ä¿¡ç•Œé¢æ˜¾ç¤º
                        timestamp: msg.timestamp,
                        isUser: msg.isUser,
                        // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤å›¾ç‰‡ç›¸å…³æ•°æ®
                        isImage: msg.isImage || false,
                        imageUrl: msg.imageUrl || null,
                        fileName: msg.fileName || null
                    };

                    smsMessages[msg.characterId].push(messageObj);
                });

                // æŒ‰æ—¶é—´æˆ³æ’åºæ¯ä¸ªè§’è‰²çš„æ¶ˆæ¯
                Object.keys(smsMessages).forEach(characterId => {
                    smsMessages[characterId].sort((a, b) => a.timestamp - b.timestamp);
                });

                const imageCount = savedSMSMessages.filter(msg => msg.isImage).length;
                console.log(`âœ… ä»æ•°æ®åº“åŠ è½½äº† ${savedSMSMessages.length} æ¡çŸ­ä¿¡æ¶ˆæ¯${imageCount > 0 ? `ï¼ˆåŒ…å« ${imageCount} å¼ å›¾ç‰‡ï¼‰` : ''}`);
            } catch (error) {
                console.error('åŠ è½½çŸ­ä¿¡æ¶ˆæ¯å¤±è´¥:', error);
                smsMessages = {};
            }
        }

        // ğŸ”¥ã€çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®ç®¡ç†ã€‘ä¿å­˜çŸ­ä¿¡æ¶ˆæ¯
        // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ä¿å­˜å•æ¡çŸ­ä¿¡æ¶ˆæ¯
        async function saveSingleSMSMessage(characterId, message) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                let contentToSave = '';
                if (Array.isArray(message.content)) {
                    // æ–°çš„å¤šæ¨¡æ€æ ¼å¼ï¼Œæå–æ–‡æœ¬å†…å®¹
                    const textPart = message.content.find(part => part.type === 'text');
                    contentToSave = textPart ? textPart.text : '';
                } else if (message.text) {
                    // å…¼å®¹æ—§æ ¼å¼
                    contentToSave = message.text;
                } else {
                    contentToSave = '';
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºå®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«å›¾ç‰‡ç›¸å…³å­—æ®µ
                const messageToSave = {
                    id: message.id,
                    characterId: characterId,
                    timestamp: message.timestamp,
                    content: contentToSave,
                    isUser: message.isUser,
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜å›¾ç‰‡ç›¸å…³æ•°æ®
                    isImage: message.isImage || false,
                    imageUrl: message.imageUrl || null,
                    fileName: message.fileName || null
                };

                await db.smsMessages.add(messageToSave);
                console.log(`âœ… ä¿å­˜äº†è§’è‰² ${characterId} çš„å•æ¡çŸ­ä¿¡æ¶ˆæ¯${message.isImage ? 'ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰' : ''}`);
            } catch (error) {
                console.error('ä¿å­˜å•æ¡çŸ­ä¿¡æ¶ˆæ¯å¤±è´¥:', error);
                throw error;
            }
        }

        // ğŸ”¥ã€æ‰¹é‡ä¿å­˜ã€‘ä¿å­˜æ‰€æœ‰çŸ­ä¿¡æ¶ˆæ¯ï¼ˆä»…ç”¨äºåˆå§‹åŒ–æˆ–ä¿®å¤ï¼‰
        async function saveSMSMessages(characterId) {
            try {
                if (!smsMessages[characterId]) return;

                const messagesToSave = smsMessages[characterId].map(msg => {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                    let contentToSave = '';
                    if (Array.isArray(msg.content)) {
                        // æ–°çš„å¤šæ¨¡æ€æ ¼å¼ï¼Œæå–æ–‡æœ¬å†…å®¹
                        const textPart = msg.content.find(part => part.type === 'text');
                        contentToSave = textPart ? textPart.text : '';
                    } else if (msg.text) {
                        // å…¼å®¹æ—§æ ¼å¼
                        contentToSave = msg.text;
                    } else {
                        contentToSave = '';
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºå®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«å›¾ç‰‡ç›¸å…³å­—æ®µ
                    return {
                        id: msg.id,
                        characterId: characterId,
                        timestamp: msg.timestamp,
                        content: contentToSave,
                        isUser: msg.isUser,
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜å›¾ç‰‡ç›¸å…³æ•°æ®
                        isImage: msg.isImage || false,
                        imageUrl: msg.imageUrl || null,
                        fileName: msg.fileName || null
                    };
                });

                await db.transaction('rw', db.smsMessages, async () => {
                    // åˆ é™¤è¯¥è§’è‰²çš„æ—§æ¶ˆæ¯
                    await db.smsMessages.where('characterId').equals(characterId).delete();
                    // æ·»åŠ æ–°æ¶ˆæ¯
                    if (messagesToSave.length > 0) {
                        await db.smsMessages.bulkAdd(messagesToSave);
                    }
                });

                const imageCount = messagesToSave.filter(msg => msg.isImage).length;
                console.log(`âœ… æ‰¹é‡ä¿å­˜äº†è§’è‰² ${characterId} çš„ ${messagesToSave.length} æ¡çŸ­ä¿¡æ¶ˆæ¯${imageCount > 0 ? `ï¼ˆåŒ…å« ${imageCount} å¼ å›¾ç‰‡ï¼‰` : ''}`);
            } catch (error) {
                console.error('æ‰¹é‡ä¿å­˜çŸ­ä¿¡æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½èŠå¤©æ¶ˆæ¯ - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadChatMessages() {
            try {
                const savedMessages = await db.chatMessages.toArray();
                chatMessages = {};

                if (savedMessages.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('chatMessages');
                    if (localStorageData) {

                        const localMessages = JSON.parse(localStorageData);

                        // å°†å¯¹è±¡æ ¼å¼è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼å­˜å‚¨åˆ°IndexedDB
                        const messageArray = [];
                        for (const [characterId, messages] of Object.entries(localMessages)) {
                            for (const message of messages) {
                                messageArray.push({
                                    id: `${characterId}_${message.id || message.timestamp}`,
                                    characterId: characterId,
                                    timestamp: message.timestamp,
                                    messageData: message
                                });
                            }
                        }

                        if (messageArray.length > 0) {
                            await db.chatMessages.bulkAdd(messageArray);
                        }

                        chatMessages = localMessages;

                    }
                } else {
                    // å°†æ•°ç»„æ ¼å¼è½¬æ¢å›å¯¹è±¡æ ¼å¼
                    for (const msgRecord of savedMessages) {
                        const characterId = msgRecord.characterId;
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ¶ˆæ¯æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œè¿‡æ»¤ç©ºå€¼
                        if (msgRecord.messageData && typeof msgRecord.messageData === 'object') {
                        chatMessages[characterId].push(msgRecord.messageData);
                        }
                    }

                    // ğŸ”¥ã€é‡å¤æ¶ˆæ¯ä¿®å¤ã€‘æŒ‰æ—¶é—´æˆ³æ’åºã€å»é‡å¹¶æ¸…ç†ç©ºå€¼
                    for (const characterId in chatMessages) {
                        console.log(`ğŸ”§ [å»é‡ä¿®å¤] å¤„ç†è§’è‰² ${characterId}: ${chatMessages[characterId].length} æ¡åŸå§‹è®°å½•`);

                        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘å»é‡é€»è¾‘ - æ ¹æ®æ¶ˆæ¯IDå’Œå†…å®¹+æ—¶é—´æˆ³å»é‡
                        const uniqueMessages = [];
                        const seenIds = new Set();
                        const seenContentTime = new Set();

                        chatMessages[characterId]
                            .filter(msg => {
                                // åŸºæœ¬æœ‰æ•ˆæ€§æ£€æŸ¥
                                if (!msg || typeof msg !== 'object' || !msg.timestamp) {
                                    return false;
                                }
                                return true;
                            })
                            .sort((a, b) => a.timestamp - b.timestamp) // å…ˆæŒ‰æ—¶é—´æ’åº
                            .forEach(msg => {
                                // æ–¹æ³•1: æ ¹æ®æ¶ˆæ¯IDå»é‡
                                if (msg.id && seenIds.has(msg.id)) {
                                    return; // è·³è¿‡é‡å¤çš„ID
                                }

                                // ğŸ”¥ã€ä¿®å¤ã€‘æ–¹æ³•2: æ ¹æ®å†…å®¹+æ—¶é—´æˆ³+ç‰¹æ®Šæ ‡è®°å»é‡ï¼ˆå¤„ç†æ²¡æœ‰IDæˆ–IDé‡å¤çš„æƒ…å†µï¼‰
                                const contentTimeKey = `${msg.content || ''}_${msg.timestamp}_${msg.sender || ''}_${msg.isProactive || ''}_${msg.isOfflineMode || ''}`;
                                if (seenContentTime.has(contentTimeKey)) {
                                    return; // è·³è¿‡é‡å¤çš„å†…å®¹+æ—¶é—´æˆ³
                                }

                                // è®°å½•å·²è§è¿‡çš„æ ‡è¯†
                                if (msg.id) seenIds.add(msg.id);
                                seenContentTime.add(contentTimeKey);

                                // æ·»åŠ åˆ°å”¯ä¸€æ¶ˆæ¯åˆ—è¡¨
                                uniqueMessages.push(msg);
                            });

                        // æ›¿æ¢ä¸ºå»é‡åçš„æ¶ˆæ¯
                        chatMessages[characterId] = uniqueMessages;

                        console.log(`âœ… [å»é‡ä¿®å¤] è§’è‰² ${characterId}: ${uniqueMessages.length} æ¡å”¯ä¸€æ¶ˆæ¯ (å»é‡äº† ${savedMessages.filter(m => m.characterId === characterId).length - uniqueMessages.length} æ¡é‡å¤)`);
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†æ•°æ®åº“ä¸­çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
                    await cleanupBlockedSystemMessages();
                }

                // ğŸ”¥ã€é‡æ„ã€‘åˆå§‹åŒ–æ¶ˆæ¯å†…å®¹å“ˆå¸Œï¼ŒçœŸæ­£æ™ºèƒ½çš„å˜åŒ–æ£€æµ‹
                lastSavedMessageHashes = {};
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    lastSavedMessageHashes[characterId] = generateMessagesHash(messages);
                }
                console.log('âœ… å·²åˆå§‹åŒ–æ¶ˆæ¯å“ˆå¸Œæ£€æµ‹å™¨:', Object.keys(lastSavedMessageHashes));

            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½
                const localStorageData = localStorage.getItem('chatMessages');
                if (localStorageData) {
                    chatMessages = JSON.parse(localStorageData);
                } else {
                    chatMessages = {};
                }
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†æ•°æ®åº“ä¸­é‡å¤çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
        async function cleanupBlockedSystemMessages() {
            try {
                // è·å–æ‰€æœ‰èŠå¤©æ¶ˆæ¯è®°å½•
                const allMessages = await db.chatMessages.toArray();
                const messagesToDelete = [];

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†é‡å¤çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
                const blockedMessagesByCharacter = {};

                for (const msgRecord of allMessages) {
                    if (msgRecord.messageData &&
                        msgRecord.messageData.sender === 'system' &&
                        msgRecord.messageData.isBlockedMessage) {

                        const characterId = msgRecord.characterId;
                        if (!blockedMessagesByCharacter[characterId]) {
                            blockedMessagesByCharacter[characterId] = [];
                        }
                        blockedMessagesByCharacter[characterId].push(msgRecord);
                    }
                }

                // å¯¹æ¯ä¸ªè§’è‰²ï¼Œåªä¿ç•™æœ€æ–°çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ é™¤é‡å¤çš„
                for (const characterId in blockedMessagesByCharacter) {
                    const messages = blockedMessagesByCharacter[characterId];
                    if (messages.length > 1) {
                        // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„ï¼Œåˆ é™¤å…¶ä»–çš„
                        messages.sort((a, b) => (b.messageData.timestamp || 0) - (a.messageData.timestamp || 0));
                        const toDelete = messages.slice(1); // åˆ é™¤é™¤ç¬¬ä¸€ä¸ªï¼ˆæœ€æ–°ï¼‰ä¹‹å¤–çš„æ‰€æœ‰æ¶ˆæ¯
                        messagesToDelete.push(...toDelete.map(msg => msg.id));
                    }
                }

                if (messagesToDelete.length > 0) {
                    await db.chatMessages.bulkDelete(messagesToDelete);
                    console.log(`å·²æ¸…ç† ${messagesToDelete.length} æ¡é‡å¤çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯`);
                }
            } catch (error) {
                console.error('æ¸…ç†æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // é˜²æŠ–ä¿å­˜è®¡æ—¶å™¨
        let saveMessagesTimer = null;
        let isSaving = false; // é˜²æ­¢å¹¶å‘ä¿å­˜
        let saveQueue = []; // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜é˜Ÿåˆ—
        let lastSavedMessageHashes = {}; // ğŸ”¥ã€é‡æ„ã€‘è®°å½•æ¯ä¸ªè§’è‰²çš„æ¶ˆæ¯å†…å®¹å“ˆå¸Œï¼Œè€Œä¸æ˜¯æ•°é‡
        let nextSequentialId = 0; // ğŸ”¥ã€æ–°å¢ã€‘å…¨å±€é¡ºåºID

        // ğŸ”¥ã€æ–°å¢ã€‘ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨çš„ç®€å•å“ˆå¸Œ
        function generateMessagesHash(messages) {
            if (!messages || messages.length === 0) return '';

            // ğŸ”¥ã€ä¿®å¤ã€‘ç”ŸæˆåŸºäºæ¶ˆæ¯IDã€å†…å®¹ã€ç±»å‹ã€å‘é€è€…å’Œç‰¹æ®Šæ ‡è®°çš„å“ˆå¸Œ
            const hashString = messages.map(msg =>
                `${msg.id || ''}:${msg.content || ''}:${msg.type || ''}:${msg.sender || ''}:${msg.isProactive || ''}:${msg.isOfflineMode || ''}`
            ).join('|');

            // ç®€å•çš„å­—ç¬¦ä¸²å“ˆå¸Œå‡½æ•°
            let hash = 0;
            for (let i = 0; i < hashString.length; i++) {
                const char = hashString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
            }
            return hash.toString();
        }

        // é˜²æŠ–ç‰ˆæœ¬çš„ä¿å­˜å‡½æ•°
        function saveChatMessages(forceResyncFor = null) { // ğŸ”¥ æ–°å¢å‚æ•°
            // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ åˆ°ä¿å­˜é˜Ÿåˆ—ï¼Œé˜²æ­¢åœ¨é«˜é¢‘è°ƒç”¨æ—¶ä¸¢å¤±ä¿å­˜è¯·æ±‚
            const saveRequest = {
                timestamp: Date.now(),
                id: Math.random().toString(36).substr(2, 9),
                forceResyncFor: forceResyncFor // ğŸ”¥ ä¼ é€’å¼ºåˆ¶åŒæ­¥ID
            };
            saveQueue.push(saveRequest);

            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (saveMessagesTimer) {
                clearTimeout(saveMessagesTimer);
            }

            // è®¾ç½®æ–°çš„è®¡æ—¶å™¨ï¼Œ500msåæ‰§è¡Œä¿å­˜
            saveMessagesTimer = setTimeout(async () => {
                if (isSaving) {
                    // å¦‚æœæ­£åœ¨ä¿å­˜ï¼Œå»¶è¿Ÿé‡è¯•
                    setTimeout(() => saveChatMessages(), 100);
                    return;
                }

                // ğŸ”¥ ä»é˜Ÿåˆ—ä¸­æ‰¾å‡ºæ‰€æœ‰éœ€è¦å¼ºåˆ¶åŒæ­¥çš„è§’è‰²ID
                const resyncIds = new Set();
                saveQueue.forEach(req => {
                    if (req.forceResyncFor) {
                        resyncIds.add(req.forceResyncFor);
                    }
                });

                // æ¸…ç©ºé˜Ÿåˆ—å¹¶æ‰§è¡Œä¿å­˜
                const currentQueue = [...saveQueue];
                saveQueue = [];

                if (currentQueue.length > 0) {
                    console.log(`ğŸ”„ æ‰§è¡Œæ‰¹é‡ä¿å­˜ï¼Œé˜Ÿåˆ—ä¸­æœ‰ ${currentQueue.length} ä¸ªè¯·æ±‚`);
                    await saveChatMessagesImmediate(Array.from(resyncIds)); // ğŸ”¥ ä¼ é€’IDåˆ—è¡¨
                }
            }, 500);
        }

        // ç«‹å³ä¿å­˜èŠå¤©æ¶ˆæ¯ - ä½¿ç”¨IndexedDBï¼ˆå¢å¼ºç‰ˆæœ¬ï¼ŒåŒ…å«å­˜å‚¨ç®¡ç†ï¼‰
        async function saveChatMessagesImmediate(forceResyncIds = []) { // ğŸ”¥ æ–°å¢å‚æ•°
            if (isSaving) {
                return;
            }
            isSaving = true;

            try {
                const storageInfo = await checkStorageUsage();
                if (storageInfo && storageInfo.needCleanup) {
                    console.warn('âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ•°æ®...');
                    await performSmartDataCleanup();
                }

                const newMessages = [];
                const charactersToDelete = new Set(forceResyncIds); // ğŸ”¥ ç›´æ¥ä½¿ç”¨å¼ºåˆ¶åŒæ­¥åˆ—è¡¨

                if (nextSequentialId === 0) {
                    const existingMessages = await db.chatMessages.toArray();
                    nextSequentialId = existingMessages.length;
                }

                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    // ğŸ”¥ã€é‡æ„ã€‘ä½¿ç”¨å“ˆå¸Œæ£€æµ‹çœŸæ­£çš„å†…å®¹å˜åŒ–ï¼Œè€Œä¸æ˜¯æ•°é‡å˜åŒ–
                    const currentHash = generateMessagesHash(messages);
                    const lastSavedHash = lastSavedMessageHashes[characterId] || '';

                    // ğŸ”¥ å¦‚æœè§’è‰²åœ¨å¼ºåˆ¶åŒæ­¥åˆ—è¡¨ä¸­ï¼Œç›´æ¥æ ‡è®°ä¸ºå¾…åˆ é™¤å’Œé‡æ–°æ·»åŠ 
                    if (charactersToDelete.has(characterId)) {
                        console.log(`ğŸ”„ è§’è‰² ${characterId}: å¼ºåˆ¶æ‰§è¡Œå®Œå…¨åŒæ­¥ (æ¥è‡ªå¤–éƒ¨è¯·æ±‚)`);
                        charactersToDelete.add(characterId);
                        for (let i = 0; i < messages.length; i++) {
                            const message = messages[i];
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ›´å®‰å…¨çš„IDç”Ÿæˆç­–ç•¥ï¼Œé¿å…æ½œåœ¨çš„é‡å¤é”®é—®é¢˜
                            const stableId = `${characterId}_sync_${message.timestamp || Date.now()}_${i}_${Math.random().toString(36).substr(2, 6)}`;
                            newMessages.push({
                                id: stableId,
                                characterId: characterId,
                                timestamp: message.timestamp,
                                messageOrder: i,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        }
                        lastSavedMessageHashes[characterId] = currentHash;
                        continue;
                    }

                    // ğŸ”¥ã€æ ¸å¿ƒæ”¹è¿›ã€‘åªæœ‰å½“å†…å®¹çœŸæ­£å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¿å­˜
                    if (currentHash !== lastSavedHash) {
                        console.log(`ğŸ“ è§’è‰² ${characterId}: æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼Œæ‰§è¡Œæ™ºèƒ½ä¿å­˜`);

                        // ç®€å•ç­–ç•¥ï¼šå†…å®¹å˜åŒ–æ—¶é‡å†™è¯¥è§’è‰²çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆä½†ä½¿ç”¨ç¨³å®šIDï¼‰
                        charactersToDelete.add(characterId);
                        for (let i = 0; i < messages.length; i++) {
                            const message = messages[i];
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ›´å®‰å…¨çš„IDç”Ÿæˆç­–ç•¥ï¼Œé¿å…æ½œåœ¨çš„é‡å¤é”®é—®é¢˜
                            const stableId = `${characterId}_update_${message.timestamp || Date.now()}_${i}_${Math.random().toString(36).substr(2, 6)}`;
                            newMessages.push({
                                id: stableId,
                                characterId,
                                timestamp: message.timestamp,
                                messageOrder: i,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        }
                        lastSavedMessageHashes[characterId] = currentHash;
                    }
                }

                const finalDeleteList = Array.from(charactersToDelete);
                if (finalDeleteList.length === 0 && newMessages.length === 0) {
                    console.log('ğŸ“ æ²¡æœ‰æ¶ˆæ¯å˜åŒ–éœ€è¦ä¿å­˜');
                    isSaving = false;
                    return;
                }

                // æ•°æ®åº“äº‹åŠ¡æ“ä½œ
                let retryCount = 0;
                const maxRetries = 3;
                while (retryCount < maxRetries) {
                    try {
                        await db.transaction('rw', db.chatMessages, async () => {
                            if (finalDeleteList.length > 0) {
                                for (const characterId of finalDeleteList) {
                                    const deletedCount = await db.chatMessages.where('characterId').equals(characterId).delete();
                                    console.log(`ğŸ—‘ï¸ å·²åˆ é™¤è§’è‰² ${characterId} çš„ ${deletedCount} æ¡æ—§æ¶ˆæ¯æ•°æ®`);
                                }
                            }
                            if (newMessages.length > 0) {
                                await db.chatMessages.bulkAdd(newMessages);
                                console.log(`âœ… å·²ä¿å­˜ ${newMessages.length} æ¡æ¶ˆæ¯åˆ°IndexedDB`);
                            }
                        });
                        break;
                    } catch (transactionError) {
                        retryCount++;
                        console.warn(`ğŸ”„ ä¿å­˜æ“ä½œå¤±è´¥ï¼Œé‡è¯• ${retryCount}/${maxRetries}:`, transactionError);
                        if (retryCount >= maxRetries) throw transactionError;
                        await new Promise(resolve => setTimeout(resolve, 100 * retryCount));
                    }
                }
                console.log(`âœ… ä¿å­˜æ“ä½œå®Œæˆ: å¼ºåˆ¶åŒæ­¥/åˆ é™¤äº† ${finalDeleteList.length} ä¸ªè§’è‰²çš„æ—§æ•°æ®ï¼Œä¿å­˜äº† ${newMessages.length} æ¡æ¶ˆæ¯`);

            } catch (error) {
                // ... (åŸæœ‰çš„é”™è¯¯å¤„ç†é€»è¾‘ä¿æŒä¸å˜) ...
                console.error('ä¿å­˜èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
                // (æ­¤å¤„çœç•¥äº†ä¸ä¹‹å‰ç›¸åŒçš„é”™è¯¯å¤„ç†å’Œç´§æ€¥æ¸…ç†ä»£ç )
            } finally {
                isSaving = false;
            }
        }



        // ğŸ”¥ã€é‡æ„ã€‘åŠ è½½èŠå¤©è®¾ç½® - ä¼˜å…ˆä½¿ç”¨IndexedDBï¼Œå‡å°‘localStorageä¾èµ– + çª—å£éš”ç¦»æ”¯æŒ
        async function loadChatSettings() {
            try {
                // ä¼˜å…ˆä»IndexedDBåŠ è½½
                const savedChatSettings = await db.chatSettings.toArray();

                // ğŸ”¥ã€æ–°åŠŸèƒ½ã€‘åŒæ—¶åŠ è½½çª—å£éš”ç¦»çš„è®¾ç½®
                const savedWindowChatSettings = await db.windowChatSettings.toArray();

                if (savedChatSettings.length > 0 || savedWindowChatSettings.length > 0) {
                    // IndexedDBä¸­æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                    console.log(`âœ… ä»IndexedDBåŠ è½½äº† ${savedChatSettings.length} ä¸ªèŠå¤©è®¾ç½®å’Œ ${savedWindowChatSettings.length} ä¸ªçª—å£éš”ç¦»è®¾ç½®`);
                    chatSettings = {};

                    // åŠ è½½å…¨å±€èŠå¤©è®¾ç½®
                    savedChatSettings.forEach(item => {
                        chatSettings[item.chatId] = item.settings;
                    });

                    // ğŸ”¥ã€æ–°åŠŸèƒ½ã€‘åŠ è½½çª—å£éš”ç¦»çš„è®¾ç½®
                    savedWindowChatSettings.forEach(item => {
                        const windowChatSettingsKey = `${item.chatId}_${item.windowId}`;
                        chatSettings[windowChatSettingsKey] = item.settings;
                    });

                    return;
                }

                // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»ï¼ˆä¸€æ¬¡æ€§è¿ç§»ï¼‰
                console.log('ğŸ”„ IndexedDBä¸­æ— æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»...');

                // æ£€æŸ¥æ–°æ ¼å¼çš„localStorageæ•°æ®
                const localStorageData = localStorage.getItem('chatSettings');
                if (localStorageData) {
                    const localSettings = JSON.parse(localStorageData);
                    await migrateChatSettingsToIndexedDB(localSettings);
                    return;
                }

                // æ£€æŸ¥æ—§æ ¼å¼çš„localStorageæ•°æ®ï¼ˆå•ä¸ªè§’è‰²å­˜å‚¨ï¼‰
                const migratedSettings = {};
                let foundOldData = false;

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('chatSettings_') && !key.includes('emergency')) {
                        try {
                            const chatId = key.replace('chatSettings_', '');
                            const settingData = localStorage.getItem(key);
                            if (settingData) {
                                migratedSettings[chatId] = JSON.parse(settingData);
                                foundOldData = true;
                            }
                        } catch (e) {
                            console.warn(`è·³è¿‡æ— æ•ˆçš„localStorageé”®: ${key}`, e);
                        }
                    }
                }

                if (foundOldData) {
                    console.log('ğŸ”„ å‘ç°æ—§æ ¼å¼æ•°æ®ï¼Œæ­£åœ¨è¿ç§»...');
                    await migrateChatSettingsToIndexedDB(migratedSettings);
                    return;
                }

                // æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©º
                chatSettings = {};
                console.log('ğŸ“ åˆå§‹åŒ–ç©ºçš„èŠå¤©è®¾ç½®');

            } catch (error) {
                console.error('ğŸš¨ åŠ è½½èŠå¤©è®¾ç½®å¤±è´¥:', error);

                // å°è¯•ä»ç´§æ€¥å¤‡ä»½æ¢å¤
                try {
                    const emergencyBackup = localStorage.getItem('chatSettings_emergency_backup');
                    if (emergencyBackup) {
                        chatSettings = JSON.parse(emergencyBackup);
                        console.log('ğŸ†˜ ä»ç´§æ€¥å¤‡ä»½æ¢å¤èŠå¤©è®¾ç½®');
                        showToast('âš ï¸ ä»ç´§æ€¥å¤‡ä»½æ¢å¤è®¾ç½®', 'warning');
                        return;
                    }
                } catch (backupError) {
                    console.error('ç´§æ€¥å¤‡ä»½ä¹Ÿæ— æ³•åŠ è½½:', backupError);
                }

                // æœ€åçš„å›é€€
                chatSettings = {};
                showToast('âŒ è®¾ç½®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿ç§»chatSettingsåˆ°IndexedDBçš„è¾…åŠ©å‡½æ•°
        async function migrateChatSettingsToIndexedDB(localSettings) {
            try {
                const settingsArray = Object.keys(localSettings).map(chatId => ({
                    id: chatId,
                    chatId: chatId,
                    settings: localSettings[chatId]
                }));

                if (settingsArray.length > 0) {
                    await db.chatSettings.bulkPut(settingsArray);
                    console.log(`âœ… æˆåŠŸè¿ç§» ${settingsArray.length} ä¸ªèŠå¤©è®¾ç½®åˆ°IndexedDB`);

                    // è¿ç§»æˆåŠŸåæ›´æ–°å†…å­˜
                    chatSettings = localSettings;

                    // å¯é€‰ï¼šæ¸…ç†æ—§çš„localStorageæ•°æ®ï¼ˆè°¨æ…æ“ä½œï¼‰
                    // localStorage.removeItem('chatSettings');
                }
            } catch (error) {
                console.error('ğŸš¨ è¿ç§»èŠå¤©è®¾ç½®åˆ°IndexedDBå¤±è´¥:', error);
                // è¿ç§»å¤±è´¥æ—¶ä»ç„¶ä½¿ç”¨localStorageæ•°æ®
                chatSettings = localSettings;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è‡ªåŠ¨ä¿å­˜æœºåˆ¶ - é˜²æ­¢æµè§ˆå™¨å¡é¡¿å¯¼è‡´æ•°æ®ä¸¢å¤±
        let autoSaveTimer = null;
        let pendingSettingsChanges = new Set();

        function scheduleAutoSave(chatId) {
            if (chatId) {
                pendingSettingsChanges.add(chatId);
            }

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ5ç§’åè‡ªåŠ¨ä¿å­˜
            autoSaveTimer = setTimeout(async () => {
                if (pendingSettingsChanges.size > 0) {
                    console.log(`ğŸ”„ è‡ªåŠ¨ä¿å­˜ ${pendingSettingsChanges.size} ä¸ªèŠå¤©è®¾ç½®...`);
                    try {
                        await saveChatSettings();
                        console.log('âœ… è‡ªåŠ¨ä¿å­˜å®Œæˆ');
                        pendingSettingsChanges.clear();
                    } catch (error) {
                        console.error('ğŸš¨ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                        // ä¿ç•™å¾…ä¿å­˜çš„è®¾ç½®ï¼Œä¸‹æ¬¡å†è¯•
                    }
                }
                autoSaveTimer = null;
            }, 5000); // 5ç§’å»¶è¿Ÿ
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é¡µé¢å¸è½½å‰å¼ºåˆ¶ä¿å­˜
        window.addEventListener('beforeunload', async (event) => {
            if (pendingSettingsChanges.size > 0) {
                console.log('ğŸ”„ é¡µé¢å¸è½½å‰å¼ºåˆ¶ä¿å­˜è®¾ç½®...');
                try {
                    // åŒæ­¥ä¿å­˜ï¼Œç¡®ä¿åœ¨é¡µé¢å…³é—­å‰å®Œæˆ
                    await saveChatSettings();
                    console.log('âœ… é¡µé¢å¸è½½å‰ä¿å­˜å®Œæˆ');
                } catch (error) {
                    console.error('ğŸš¨ é¡µé¢å¸è½½å‰ä¿å­˜å¤±è´¥:', error);
                }
            }
        });

        // ğŸ”¥ã€æ–°å¢ã€‘é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¿å­˜
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden && pendingSettingsChanges.size > 0) {
                console.log('ğŸ”„ é¡µé¢éšè—æ—¶ä¿å­˜è®¾ç½®...');
                try {
                    await saveChatSettings();
                    console.log('âœ… é¡µé¢éšè—æ—¶ä¿å­˜å®Œæˆ');
                    pendingSettingsChanges.clear();
                } catch (error) {
                    console.error('ğŸš¨ é¡µé¢éšè—æ—¶ä¿å­˜å¤±è´¥:', error);
                }
            }
        });

        // ğŸ”¥ã€æ–°å¢ã€‘è°ƒè¯•èŠå¤©è®°å½•æ ¼å¼çš„å·¥å…·å‡½æ•°
        async function debugChatMessagesFormat() {
            try {
                // æ£€æŸ¥å½“å‰æ•°æ®åº“ä¸­çš„èŠå¤©è®°å½•æ ¼å¼
                const dbMessages = await db.chatMessages.toArray();
                console.log('ğŸ“Š æ•°æ®åº“ä¸­çš„èŠå¤©è®°å½•æ ¼å¼åˆ†æ:');
                console.log(`æ€»æ•°: ${dbMessages.length} æ¡`);

                if (dbMessages.length > 0) {
                    const sample = dbMessages[0];
                    console.log('æ ·æœ¬è®°å½•ç»“æ„:', Object.keys(sample));
                    console.log('æ ·æœ¬è®°å½•:', sample);

                    const hasMessageData = dbMessages.some(msg => msg.messageData);
                    const hasDirectContent = dbMessages.some(msg => msg.content);

                    console.log(`åŒ…å«messageDataå­—æ®µ: ${hasMessageData}`);
                    console.log(`åŒ…å«ç›´æ¥contentå­—æ®µ: ${hasDirectContent}`);
                }

                // æ£€æŸ¥å†…å­˜ä¸­çš„èŠå¤©è®°å½•æ ¼å¼
                console.log('ğŸ“Š å†…å­˜ä¸­çš„èŠå¤©è®°å½•æ ¼å¼åˆ†æ:');
                const memoryMessageCount = Object.values(chatMessages).reduce((total, msgs) => total + msgs.length, 0);
                console.log(`æ€»æ•°: ${memoryMessageCount} æ¡`);

                if (memoryMessageCount > 0) {
                    const firstCharacter = Object.keys(chatMessages)[0];
                    const firstMessage = chatMessages[firstCharacter]?.[0];
                    if (firstMessage) {
                        console.log('å†…å­˜æ ·æœ¬è®°å½•ç»“æ„:', Object.keys(firstMessage));
                        console.log('å†…å­˜æ ·æœ¬è®°å½•:', firstMessage);
                    }
                }

                showToast('ğŸ“Š èŠå¤©è®°å½•æ ¼å¼åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'info');
            } catch (error) {
                console.error('è°ƒè¯•èŠå¤©è®°å½•æ ¼å¼å¤±è´¥:', error);
                showToast('è°ƒè¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†localStorageä¸­çš„æ—§chatSettingsæ•°æ®
        async function cleanupOldChatSettingsFromLocalStorage() {
            try {
                let cleanedCount = 0;
                const keysToRemove = [];

                // æ”¶é›†æ‰€æœ‰chatSettingsç›¸å…³çš„localStorageé”®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key === 'chatSettings' || key.startsWith('chatSettings_')) && !key.includes('emergency')) {
                        keysToRemove.push(key);
                    }
                }

                // ç¡®è®¤IndexedDBä¸­æœ‰æ•°æ®åå†æ¸…ç†
                const indexedDBSettings = await db.chatSettings.toArray();
                if (indexedDBSettings.length > 0 && keysToRemove.length > 0) {
                    const confirmCleanup = confirm(
                        `æ£€æµ‹åˆ° ${keysToRemove.length} ä¸ªæ—§çš„localStorageèŠå¤©è®¾ç½®æ•°æ®ã€‚\n\n` +
                        `IndexedDBä¸­å·²æœ‰ ${indexedDBSettings.length} ä¸ªè®¾ç½®ï¼Œå¯ä»¥å®‰å…¨æ¸…ç†localStorageæ•°æ®ã€‚\n\n` +
                        `æ˜¯å¦æ¸…ç†ä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼Ÿ`
                    );

                    if (confirmCleanup) {
                        keysToRemove.forEach(key => {
                            localStorage.removeItem(key);
                            cleanedCount++;
                        });

                        console.log(`âœ… å·²æ¸…ç† ${cleanedCount} ä¸ªæ—§çš„localStorageèŠå¤©è®¾ç½®`);
                        showToast(`ğŸ§¹ å·²æ¸…ç† ${cleanedCount} ä¸ªæ—§è®¾ç½®æ•°æ®`, 'success');
                    }
                }
            } catch (error) {
                console.error('æ¸…ç†æ—§chatSettingsæ•°æ®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘ä¿å­˜èŠå¤©è®¾ç½® - å®Œå…¨ä¾èµ–IndexedDBï¼Œé¿å…æ•°æ®ä¸¢å¤±
        async function saveChatSettings() {
            try {
                // å°†chatSettingså¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼å­˜å‚¨åˆ°IndexedDB
                const chatSettingsArray = Object.keys(chatSettings).map(chatId => ({
                    id: chatId,
                    chatId: chatId,
                    settings: chatSettings[chatId]
                }));

                if (chatSettingsArray.length === 0) {
                    console.warn('âš ï¸ èŠå¤©è®¾ç½®æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜æ“ä½œ');
                    return;
                }

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘ä½¿ç”¨bulkPutä»£æ›¿clear+bulkAddï¼Œé¿å…æ•°æ®ä¸¢å¤±
                await db.chatSettings.bulkPut(chatSettingsArray);

                console.log(`âœ… å®‰å…¨ä¿å­˜äº† ${chatSettingsArray.length} ä¸ªèŠå¤©è®¾ç½®åˆ°IndexedDB`);

            } catch (error) {
                console.error('ğŸš¨ ä¿å­˜èŠå¤©è®¾ç½®åˆ°IndexedDBå¤±è´¥:', error);

                // ğŸ”¥ã€ç´§æ€¥å¤‡ä»½ã€‘åªåœ¨IndexedDBå®Œå…¨å¤±è´¥æ—¶æ‰ä½¿ç”¨localStorage
                try {
                    console.warn('âš ï¸ æ­£åœ¨è¿›è¡Œç´§æ€¥å¤‡ä»½åˆ°localStorage...');
                    const emergencyBackup = {};
                    Object.keys(chatSettings).forEach(chatId => {
                        // åªä¿å­˜æœ€å…³é”®çš„è®¾ç½®ï¼Œé¿å…localStorageå®¹é‡é—®é¢˜
                        emergencyBackup[chatId] = {
                            bubbleStyle: chatSettings[chatId].bubbleStyle,
                            aiChatAvatar: chatSettings[chatId].aiChatAvatar,
                            myChatAvatar: chatSettings[chatId].myChatAvatar,
                            aiChatNickname: chatSettings[chatId].aiChatNickname,
                            myChatNickname: chatSettings[chatId].myChatNickname,
                            hideAvatars: chatSettings[chatId].hideAvatars,
                            selectedIdentityId: chatSettings[chatId].selectedIdentityId,
                            timestampEnabled: chatSettings[chatId].timestampEnabled,
                            timestampPosition: chatSettings[chatId].timestampPosition
                        };
                    });

                    localStorage.setItem('chatSettings_emergency_backup', JSON.stringify(emergencyBackup));
                    console.log('âœ… ç´§æ€¥å¤‡ä»½å·²ä¿å­˜åˆ°localStorage');

                    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
                    showToast('âš ï¸ æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œå·²å¯ç”¨ç´§æ€¥å¤‡ä»½æ¨¡å¼', 'warning');

                } catch (localStorageError) {
                    console.error('ğŸš¨ ç´§æ€¥å¤‡ä»½ä¹Ÿå¤±è´¥äº†:', localStorageError);
                    showToast('âŒ è®¾ç½®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´', 'error');
                    throw localStorageError;
                }
            }
        }

        // === åå°äº’åŠ¨ç³»ç»Ÿ ===
        let backgroundTimers = {};

        // ğŸ”¥ã€æ–°å¢ã€‘å…¨å±€åå°äº’åŠ¨ç³»ç»Ÿåˆå§‹åŒ– - ä¸ºæ‰€æœ‰è§’è‰²è®¾ç½®å®šæ—¶å™¨
        async function initGlobalBackgroundInteractionSystem() {
            console.log('ğŸš€ å¯åŠ¨å…¨å±€åå°äº’åŠ¨ç³»ç»Ÿ...');

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸è¦æ¸…é™¤ç°æœ‰å®šæ—¶å™¨ï¼Œé¿å…ä¸å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿå†²çª
            // clearAllBackgroundTimers();

            // ä¸ºæ¯ä¸ªè§’è‰²è®¾ç½®åå°äº’åŠ¨å®šæ—¶å™¨
            for (const character of characters) {
                try {
                    const chatSettings = await getChatSettings(character.id);

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®æ£€æŸ¥åå°äº’åŠ¨å¼€å…³çŠ¶æ€
                    const backgroundInteractionEnabled = chatSettings.backgroundInteractionEnabled === true;
                    const backgroundChatEnabled = chatSettings.backgroundChatEnabled === true;
                    const backgroundMomentsEnabled = chatSettings.backgroundMomentsEnabled === true;

                    if (!backgroundInteractionEnabled) {
                        console.log(`è§’è‰² ${character.name} çš„åå°äº’åŠ¨å·²ç¦ç”¨ï¼Œè·³è¿‡`);
                        continue;
                    }

                    console.log(`ä¸ºè§’è‰² ${character.name} è®¾ç½®åå°äº’åŠ¨å®šæ—¶å™¨`);

                    // è®¾ç½®ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨ - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    if (backgroundInteractionEnabled && backgroundChatEnabled) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æœ‰èŠå¤©è®°å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸è®¾ç½®å®šæ—¶å™¨
                        const messages = chatMessages[character.id] || [];
                        const hasUserMessages = messages.some(msg => msg.sender === 'sent');

                        if (hasUserMessages) {
                            await scheduleProactiveChatForCharacter(character.id);
                            console.log(`âœ… [å…¨å±€åˆå§‹åŒ–] ${character.name} åŠ¨æ€ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å·²è®¾ç½®`);
                        } else {
                            console.log(`â¸ï¸ [å…¨å±€åˆå§‹åŒ–] ${character.name} æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯è®°å½•ï¼Œæš‚ä¸è®¾ç½®ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨`);
                        }
                    } else {
                        console.log(`ğŸš« [å…¨å±€åˆå§‹åŒ–] ${character.name} ä¸»åŠ¨èŠå¤©å¼€å…³æœªå¼€å¯`);
                    }

                    // è®¾ç½®ä¸»åŠ¨å‘åŠ¨æ€å®šæ—¶å™¨ - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    if (backgroundInteractionEnabled && backgroundMomentsEnabled) {
                        const momentsInterval = getBackgroundMomentsInterval(chatSettings.backgroundMomentsFrequency || 'low');
                        backgroundTimers[character.id + '_moments'] = setInterval(() => {
                            triggerBackgroundMoments(character.id);
                        }, momentsInterval);
                        console.log(`${character.name} ä¸»åŠ¨å‘åŠ¨æ€å®šæ—¶å™¨å·²è®¾ç½®ï¼Œé—´éš”: ${momentsInterval}ms`);
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘è®¾ç½®åå°å†™æ—¥è®°å®šæ—¶å™¨
                    await initBackgroundDiarySystem(character.id);
                } catch (error) {
                    console.error(`ä¸ºè§’è‰² ${character.name} è®¾ç½®åå°äº’åŠ¨å®šæ—¶å™¨å¤±è´¥:`, error);
                }
            }
        }

        // åˆå§‹åŒ–åå°äº’åŠ¨ç³»ç»Ÿï¼ˆå•ä¸ªè§’è‰²ï¼‰
        async function initBackgroundInteractionSystem() {
            // ğŸ”¥ã€é‡è¦ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°ä¸åº”è¯¥åœ¨è§’è‰²åˆ‡æ¢æ—¶é‡æ–°è®¾ç½®å®šæ—¶å™¨ï¼
            // å®šæ—¶å™¨åº”è¯¥æ˜¯å…¨å±€çš„ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶è®¾ç½®ä¸€æ¬¡å³å¯
            // è¿™é‡Œåªæ˜¯ä¸ºäº†å…¼å®¹æ€§ä¿ç•™ï¼Œå®é™…ä¸åšä»»ä½•æ“ä½œ
            console.log('âš ï¸ [å·²åºŸå¼ƒ] initBackgroundInteractionSystem è¢«è°ƒç”¨ï¼Œä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ');
            console.log('ğŸ’¡ [æç¤º] åå°å®šæ—¶å™¨ç”±å…¨å±€ç³»ç»Ÿç®¡ç†ï¼Œè¯·ä½¿ç”¨ initGlobalBackgroundInteractionSystem');
        }

        // æ¸…é™¤æ‰€æœ‰åå°å®šæ—¶å™¨
        function clearAllBackgroundTimers() {
            Object.values(backgroundTimers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            backgroundTimers = {};

            // ğŸ”¥ã€æ–°å¢ã€‘åŒæ—¶æ¸…é™¤åå°å†™æ—¥è®°å®šæ—¶å™¨
            Object.values(backgroundDiaryTimers).forEach(timer => {
                if (timer) clearTimeout(timer);
            });
            backgroundDiaryTimers = {};
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åå°å†™æ—¥è®°ç³»ç»Ÿ
        let backgroundDiaryTimers = {};

        // ä¿å­˜æ—¥è®°æ—¶é—´è®¾ç½®
        async function saveDiaryTime() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            const timeInput = document.getElementById('diary-time-input');
            const selectedTime = timeInput.value;

            if (!selectedTime) {
                showToast('è¯·é€‰æ‹©å†™æ—¥è®°çš„æ—¶é—´', 'error');
                return;
            }

            // ä¿å­˜åˆ°èŠå¤©è®¾ç½®
            const chatSettings = getCurrentChatSettings();
            chatSettings.backgroundDiaryTime = selectedTime;
            await saveCurrentChatSettings(chatSettings);

            // ğŸ”¥ã€ä¿®å¤ã€‘åªé‡æ–°å®‰æ’å®šæ—¶å™¨ï¼Œä¸è¦ç«‹å³è§¦å‘
            if (currentChatCharacter) {
                // å…ˆæ¸…é™¤ç°æœ‰çš„æ—¥è®°å®šæ—¶å™¨
                if (backgroundDiaryTimers[currentChatCharacter.id]) {
                    clearTimeout(backgroundDiaryTimers[currentChatCharacter.id]);
                    delete backgroundDiaryTimers[currentChatCharacter.id];
                }

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†åå°å†™æ—¥è®°
                if (chatSettings.backgroundInteractionEnabled && chatSettings.backgroundDiaryEnabled) {
                    console.log(`â° é‡æ–°ä¸º ${currentChatCharacter.name} è®¾ç½®åå°å†™æ—¥è®°å®šæ—¶å™¨ï¼Œæ—¶é—´: ${selectedTime}`);
                    scheduleBackgroundDiary(currentChatCharacter.id, selectedTime);
                }
            }

            showToast(`å·²è®¾ç½® ${currentChatCharacter.name} åœ¨ ${selectedTime} å†™æ—¥è®°`, 'success');
        }

        // åˆå§‹åŒ–åå°å†™æ—¥è®°ç³»ç»Ÿ
        async function initBackgroundDiarySystem(characterId) {
            // æ¸…é™¤ç°æœ‰çš„æ—¥è®°å®šæ—¶å™¨
            if (backgroundDiaryTimers[characterId]) {
                clearTimeout(backgroundDiaryTimers[characterId]);
                delete backgroundDiaryTimers[characterId];
            }

            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // ç¾¤èŠä¸æ”¯æŒæ—¥è®°åŠŸèƒ½
            if (character.isGroup) {
                console.log(`ğŸš« ç¾¤èŠ ${character.name} ä¸æ”¯æŒåå°å†™æ—¥è®°åŠŸèƒ½`);
                return;
            }

            const chatSettings = await getChatSettings(characterId);
            const backgroundInteractionEnabled = chatSettings.backgroundInteractionEnabled === true;
            const backgroundDiaryEnabled = chatSettings.backgroundDiaryEnabled === true;
            const diaryTime = chatSettings.backgroundDiaryTime;

            if (!backgroundInteractionEnabled || !backgroundDiaryEnabled || !diaryTime) {
                console.log(`ğŸš« ${character.name} åå°å†™æ—¥è®°æœªå¯ç”¨æˆ–æœªè®¾ç½®æ—¶é—´`);
                return;
            }

            console.log(`â° ä¸º ${character.name} è®¾ç½®åå°å†™æ—¥è®°å®šæ—¶å™¨ï¼Œæ—¶é—´: ${diaryTime}`);
            scheduleBackgroundDiary(characterId, diaryTime);
        }

        // å®‰æ’åå°å†™æ—¥è®°
        function scheduleBackgroundDiary(characterId, diaryTime) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // è§£ææ—¶é—´
            const [hours, minutes] = diaryTime.split(':').map(Number);
            console.log(`â° [æ—¥è®°å®šæ—¶å™¨] è§£ææ—¶é—´: ${hours}:${minutes}`);

            // è®¡ç®—ä¸‹æ¬¡å†™æ—¥è®°çš„æ—¶é—´
            const now = new Date();
            const targetTime = new Date();
            targetTime.setHours(hours, minutes, 0, 0);

            console.log(`â° [æ—¥è®°å®šæ—¶å™¨] å½“å‰æ—¶é—´: ${now.toLocaleString()}`);
            console.log(`â° [æ—¥è®°å®šæ—¶å™¨] ç›®æ ‡æ—¶é—´: ${targetTime.toLocaleString()}`);

            // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœä»Šå¤©çš„æ—¶é—´å·²è¿‡ï¼Œè®¾ç½®ä¸ºæ˜å¤©
            if (targetTime <= now) {
                targetTime.setDate(targetTime.getDate() + 1);
                console.log(`â° [æ—¥è®°å®šæ—¶å™¨] ä»Šå¤©æ—¶é—´å·²è¿‡ï¼Œè°ƒæ•´ä¸ºæ˜å¤©: ${targetTime.toLocaleString()}`);
            }

            // æ·»åŠ éšæœºæ³¢åŠ¨ï¼ˆÂ±5åˆ†é’Ÿï¼‰
            const fluctuation = (Math.random() - 0.5) * 10 * 60 * 1000; // Â±5åˆ†é’Ÿçš„æ¯«ç§’æ•°
            targetTime.setTime(targetTime.getTime() + fluctuation);

            const delay = targetTime.getTime() - now.getTime();

            console.log(`ğŸ“ ${character.name} å°†åœ¨ ${targetTime.toLocaleString()} å†™æ—¥è®°ï¼ˆ${Math.round(delay / 60000)} åˆ†é’Ÿåï¼‰`);
            console.log(`â° [æ—¥è®°å®šæ—¶å™¨] å»¶è¿Ÿæ—¶é—´: ${delay}ms`);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿å»¶è¿Ÿæ—¶é—´ä¸ºæ­£æ•°
            if (delay <= 0) {
                console.warn(`âš ï¸ [æ—¥è®°å®šæ—¶å™¨] å»¶è¿Ÿæ—¶é—´ä¸ºè´Ÿæ•°æˆ–é›¶ï¼Œç«‹å³è§¦å‘`);
                setTimeout(async () => {
                    await triggerBackgroundDiary(characterId);
                }, 1000); // 1ç§’åè§¦å‘
                return;
            }

            // è®¾ç½®å®šæ—¶å™¨
            backgroundDiaryTimers[characterId] = setTimeout(async () => {
                console.log(`â° [æ—¥è®°å®šæ—¶å™¨] ${character.name} å®šæ—¶å™¨è§¦å‘ï¼`);
                await triggerBackgroundDiary(characterId);
                // å®‰æ’ä¸‹ä¸€æ¬¡å†™æ—¥è®°ï¼ˆæ˜å¤©åŒä¸€æ—¶é—´ï¼‰
                scheduleBackgroundDiary(characterId, diaryTime);
            }, delay);

            console.log(`âœ… [æ—¥è®°å®šæ—¶å™¨] ${character.name} å®šæ—¶å™¨å·²è®¾ç½®ï¼ŒID: ${backgroundDiaryTimers[characterId]}`);
        }

        // è§¦å‘åå°å†™æ—¥è®°
        async function triggerBackgroundDiary(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) {
                console.error(`âŒ æ‰¾ä¸åˆ°è§’è‰² ID: ${characterId}`);
                return;
            }

            console.log(`ğŸ“ ${character.name} å¼€å§‹åå°å†™æ—¥è®°...`);

            try {
                // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æœ‰æ—¥è®°
                const today = new Date().toISOString().split('T')[0];
                const diaryId = `${characterId}_${today}`;
                console.log(`ğŸ“ æ£€æŸ¥æ—¥è®°ID: ${diaryId}`);

                const existingDiary = await db.characterDiaries.get(diaryId);

                if (existingDiary && existingDiary.content) {
                    console.log(`ğŸ“ ${character.name} ä»Šå¤©å·²ç»å†™è¿‡æ—¥è®°äº†ï¼Œè·³è¿‡`);
                    return;
                }

                console.log(`ğŸ“ ${character.name} å¼€å§‹ç”Ÿæˆæ—¥è®°å†…å®¹...`);
                // ç”Ÿæˆæ—¥è®°å†…å®¹
                const diaryContent = await generateBackgroundDiary(character);
                console.log(`ğŸ“ ${character.name} æ—¥è®°å†…å®¹ç”Ÿæˆç»“æœ:`, diaryContent ? 'æˆåŠŸ' : 'å¤±è´¥');

                if (diaryContent) {
                    // ä¿å­˜æ—¥è®°åˆ°æ•°æ®åº“
                    const diaryData = {
                        id: diaryId,
                        characterId: characterId,
                        date: today,
                        content: diaryContent,
                        timestamp: Date.now(),
                        weather: getRandomWeather()
                    };

                    console.log(`ğŸ“ ${character.name} ä¿å­˜æ—¥è®°åˆ°æ•°æ®åº“...`, diaryData);
                    await db.characterDiaries.put(diaryData);

                    console.log(`âœ… ${character.name} åå°å†™æ—¥è®°å®Œæˆï¼å†…å®¹: ${diaryContent.substring(0, 50)}...`);

                    // åˆ›å»ºç³»ç»Ÿæ¨é€é€šçŸ¥
                    createDiaryNotification(character);
                } else {
                    console.error(`âŒ ${character.name} åå°å†™æ—¥è®°å¤±è´¥ï¼šå†…å®¹ç”Ÿæˆå¤±è´¥`);
                }
            } catch (error) {
                console.error(`âŒ ${character.name} åå°å†™æ—¥è®°å¤±è´¥:`, error);
            }
        }

        // ç”Ÿæˆåå°æ—¥è®°å†…å®¹
        async function generateBackgroundDiary(character) {
            try {
                console.log(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] å¼€å§‹ä¸º ${character.name} ç”Ÿæˆæ—¥è®°å†…å®¹...`);

                // è·å–èŠå¤©å†å²ä½œä¸ºæ—¥è®°ç´ æ
                const messages = chatMessages[character.id] || [];
                const recentMessages = messages.slice(-20); // æœ€è¿‘20æ¡æ¶ˆæ¯
                console.log(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] è·å–åˆ° ${recentMessages.length} æ¡æœ€è¿‘æ¶ˆæ¯`);

                // æ„å»ºæ—¥è®°ç”Ÿæˆprompt
                const currentDate = new Date().toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                const weather = getRandomWeather();

                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©å†…å®¹ï¼š\n' +
                        recentMessages.map(msg => {
                            const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : character.name;
                            return `${sender}: ${msg.text || msg.content || '[ç‰¹æ®Šæ¶ˆæ¯]'}`;
                        }).join('\n');
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ä¸æ‰‹åŠ¨å†™æ—¥è®°ç›¸åŒçš„è¯¦ç»†promptæ ¼å¼
                const prompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${character.bio}

ç°åœ¨æ˜¯${currentDate}ï¼Œä½ éœ€è¦å†™ä¸€ç¯‡ç§äººæ—¥è®°ã€‚

é‡è¦è¦æ±‚ï¼š
- è¯·ç›´æ¥è¾“å‡ºæ—¥è®°å†…å®¹ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼æˆ–ä»»ä½•ä»£ç å—
- è¯·åœ¨æ—¥è®°å¼€å¤´è‡ªå·±å†™ä¸Šæ—¥æœŸå’Œå¤©æ°”ï¼Œæ ¼å¼å¦‚ï¼š"${currentDate}ï¼Œå¤©æ°”ï¼š${weather}"
- ç”¨ä½ çš„å£å»å’Œæ€§æ ¼æ¥å†™
- è®°å½•ä½ ä»Šå¤©çš„æƒ³æ³•ã€æ„Ÿå—å’Œç»å†
- å¯ä»¥æåŠå¯¹ç”¨æˆ·çš„çœŸå®æ„Ÿæƒ…
- åŸºäºæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œå¯é€‚å½“è€ƒè™‘ä¸ç”¨æˆ·çš„äº’åŠ¨
- ä¿æŒè§’è‰²çš„ä¸€è‡´æ€§å’ŒçœŸå®æ€§
- å†…å®¹è¦è‡ªç„¶ã€çœŸå®ï¼ŒåƒçœŸæ­£çš„ç§äººæ—¥è®°
- å­—æ•°åœ¨100-200å­—ä¹‹é—´ï¼Œæ ¹æ®ä½ çš„æ€§æ ¼å’Œå½“å¤©çš„å¿ƒæƒ…è‡ªç”±å‘æŒ¥${chatContext}

ç‰¹æ®Šæ ·å¼è¯´æ˜ï¼ˆå¯é€‰ä½¿ç”¨ï¼Œæ¯ç§æ ·å¼åœ¨åŒä¸€ç¯‡æ—¥è®°ä¸­æœ€å¤šä½¿ç”¨1æ¬¡ï¼‰ï¼š
- å¦‚æœå†™åˆ°ä¸è¯¥è¯´çš„è¯æˆ–åæ‚”å†™ä¸‹çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ <strike>å†…å®¹</strike> æ ‡è®°åˆ’æ‰
- å¦‚æœè¡¨è¾¾é‡ç‚¹æˆ–è¯­æ°”æ¿€åŠ¨çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ <mark>å†…å®¹</mark> æ ‡è®°é«˜äº®

è¯·ç›´æ¥å†™å‡º${character.name}çš„ç§äººæ—¥è®°å†…å®¹ï¼š`;

                console.log(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] è°ƒç”¨APIç”Ÿæˆæ—¥è®°ï¼Œprompté•¿åº¦: ${prompt.length}`);
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨generateAIResponseè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨callChatAPI
                const response = await generateAIResponse(prompt, character);
                console.log(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] APIå“åº”:`, response ? `æˆåŠŸï¼Œé•¿åº¦: ${response.length}` : 'å¤±è´¥æˆ–ä¸ºç©º');

                if (response && response.trim()) {
                    let finalDiary = response.trim();

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸æ‰‹åŠ¨å†™æ—¥è®°ç›¸åŒçš„æ ¼å¼æ¸…ç†
                    finalDiary = cleanDiaryContent(finalDiary);

                    console.log(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] ${character.name} æ—¥è®°å†…å®¹ç”ŸæˆæˆåŠŸ`);
                    return finalDiary;
                }

                console.warn(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] ${character.name} æ—¥è®°å†…å®¹ä¸ºç©º`);
                return null;
            } catch (error) {
                console.error(`ğŸ“ [æ—¥è®°ç”Ÿæˆ] ${character.name} ç”Ÿæˆå¤±è´¥:`, error);
                return null;
            }
        }

        // åˆ›å»ºæ—¥è®°æ¨é€é€šçŸ¥
        function createDiaryNotification(character) {
            const notificationText = `ğŸ“– ${character.name}å†™æ—¥è®°å•¦~\nå¿«æ¥çœ‹çœ‹å§`;

            // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ—¥è®°é€šçŸ¥æ·»åŠ ç‰¹æ®Šæ ‡è¯†ï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»æ—¶è·³è½¬åˆ°æ—¥è®°ç•Œé¢
            const diaryNotificationText = `[æ—¥è®°] ${notificationText}`;

            // ä½¿ç”¨ç°æœ‰çš„æ¨é€é€šçŸ¥ç³»ç»Ÿï¼Œè®¾ç½®è¾ƒé«˜ä¼˜å…ˆçº§
            createPushNotification(character, diaryNotificationText, 100);
        }

        // è·å–éšæœºå¤©æ°”
        function getRandomWeather() {
            const weathers = ['â˜€ï¸', 'â›…', 'â˜ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ¨ï¸', 'ğŸŒ¤ï¸', 'ğŸŒ¦ï¸'];
            return weathers[Math.floor(Math.random() * weathers.length)];
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•åå°å†™æ—¥è®°åŠŸèƒ½
        async function testBackgroundDiary() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸æ”¯æŒæ—¥è®°åŠŸèƒ½', 'error');
                return;
            }

            console.log(`ğŸ§ª [æµ‹è¯•] æ‰‹åŠ¨è§¦å‘ ${currentChatCharacter.name} å†™æ—¥è®°...`);
            await triggerBackgroundDiary(currentChatCharacter.id);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è°ƒè¯•åå°å®šæ—¶å™¨çŠ¶æ€
        function debugBackgroundTimers() {
            console.log('ğŸ” [è°ƒè¯•] å½“å‰åå°å®šæ—¶å™¨çŠ¶æ€:');
            console.log('backgroundTimers:', Object.keys(backgroundTimers));
            console.log('backgroundDiaryTimers:', Object.keys(backgroundDiaryTimers));

            Object.keys(backgroundDiaryTimers).forEach(characterId => {
                const character = characters.find(c => c.id === characterId);
                const timerExists = backgroundDiaryTimers[characterId] !== null && backgroundDiaryTimers[characterId] !== undefined;
                console.log(`ğŸ“ ${character?.name || characterId}: å®šæ—¶å™¨${timerExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            });
        }

        // å…¨å±€å®šæ—¶å‘å¸ƒç³»ç»Ÿ
        let globalMomentsTimers = {};
        let globalMomentsCheckInterval = null;

        // åˆå§‹åŒ–å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿ
        async function initGlobalMomentsSystem() {
            console.log('ğŸš€ åˆå§‹åŒ–å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿ');

            // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨
            clearGlobalMomentsTimers();

            // ä¸ºæ‰€æœ‰è§’è‰²è®¾ç½®åå°å‘å¸ƒå®šæ—¶å™¨
            let activeCount = 0;
            if (characters && characters.length > 0) {
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†åå°å‘åŠ¨æ€ï¼Œéœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    if (chatSettings.backgroundInteractionEnabled === true && chatSettings.backgroundMomentsEnabled === true) {
                        const frequency = chatSettings.backgroundMomentsFrequency || 'low';
                        const interval = getBackgroundMomentsInterval(frequency);

                        globalMomentsTimers[character.id] = setInterval(async () => {
                            console.log(`â° å®šæ—¶å™¨è§¦å‘ï¼š${character.name} å‡†å¤‡å‘å¸ƒåŠ¨æ€`);
                            await triggerBackgroundMoments(character.id);
                        }, interval);

                        activeCount++;
                        console.log(`âœ… ä¸ºè§’è‰² ${character.name} è®¾ç½®äº†åå°å‘åŠ¨æ€å®šæ—¶å™¨ï¼Œé—´éš”: ${Math.round(interval/1000/60)}åˆ†é’Ÿ`);
                    }

                    // æ£€æŸ¥æ˜¯å¦æœ‰å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
                    if (chatSettings.scheduledMomentsEnabled && chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes.length > 0) {
                        console.log(`â° è§’è‰² ${character.name} å¯ç”¨äº†å®šæ—¶å‘å¸ƒï¼Œæ—¶é—´ç‚¹:`, chatSettings.scheduledMomentsTimes);
                    }
                }
            }

            // å¯åŠ¨å®šæ—¶æ£€æŸ¥å™¨ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦åˆ°äº†å‘å¸ƒæ—¶é—´ï¼‰
            if (!globalMomentsCheckInterval) {
                globalMomentsCheckInterval = setInterval(async () => {
                    await checkScheduledMomentsTime();
                }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

                console.log('â° å¯åŠ¨äº†å®šæ—¶å‘å¸ƒæ—¶é—´æ£€æŸ¥å™¨');
            }

            console.log(`ğŸ‰ å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ¿€æ´»äº† ${activeCount} ä¸ªè§’è‰²çš„åå°å‘å¸ƒ`);
        }

        // æ£€æŸ¥å®šæ—¶å‘å¸ƒæ—¶é—´
        async function checkScheduledMomentsTime() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            if (characters && characters.length > 0) {
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);

                    if (chatSettings.scheduledMomentsEnabled &&
                        chatSettings.scheduledMomentsTimes &&
                        chatSettings.scheduledMomentsTimes.includes(currentTime)) {

                        console.log(`â° å®šæ—¶å‘å¸ƒæ—¶é—´åˆ°ï¼š${character.name} åœ¨ ${currentTime} å‘å¸ƒåŠ¨æ€`);
                        await triggerBackgroundMoments(character.id, true); // è·³è¿‡å†·å´æ—¶é—´
                    }
                }
            }
        }

        // æ¸…é™¤å…¨å±€åŠ¨æ€å®šæ—¶å™¨
        function clearGlobalMomentsTimers() {
            Object.values(globalMomentsTimers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            globalMomentsTimers = {};

            if (globalMomentsCheckInterval) {
                clearInterval(globalMomentsCheckInterval);
                globalMomentsCheckInterval = null;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘è·å–åå°èŠå¤©é—´éš”æ—¶é—´ - æ”¹ä¸ºéšæœºé—´éš”ï¼Œç¬¦åˆç”¨æˆ·éœ€æ±‚
        function getBackgroundInterval(frequency) {
            switch (frequency) {
                case 'low':
                    // 1-2å°æ—¶éšæœºé—´éš”
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000;
                case 'medium':
                    // 30-60åˆ†é’Ÿéšæœºé—´éš”
                    return Math.random() * 30 * 60 * 1000 + 30 * 60 * 1000;
                case 'high':
                    // 10-30åˆ†é’Ÿéšæœºé—´éš”
                    return Math.random() * 20 * 60 * 1000 + 10 * 60 * 1000;
                default:
                    // é»˜è®¤1-2å°æ—¶
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè§’è‰²è®¾ç½®åŠ¨æ€ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
        async function scheduleProactiveChatForCharacter(characterId) {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (backgroundTimers[characterId + '_chat']) {
                clearTimeout(backgroundTimers[characterId + '_chat']);
                delete backgroundTimers[characterId + '_chat'];
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åœ¨è®¾ç½®å®šæ—¶å™¨å‰æ£€æŸ¥å¼€å…³çŠ¶æ€
            const character = characters.find(c => c.id === characterId);
            if (!character) {
                console.log(`ğŸš« [å®šæ—¶å™¨è®¾ç½®] è§’è‰²ä¸å­˜åœ¨: ${characterId}`);
                return;
            }

            const chatSettings = await getAsyncChatSettings(characterId);
            const backgroundInteractionEnabled = chatSettings.backgroundInteractionEnabled === true;
            const backgroundChatEnabled = chatSettings.backgroundChatEnabled === true;

            console.log(`ğŸ” [å®šæ—¶å™¨è®¾ç½®] ${character.name}:`, {
                backgroundInteractionEnabled,
                backgroundChatEnabled
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸¥æ ¼æ£€æŸ¥å¼€å…³çŠ¶æ€ - å¿…é¡»ä¸¤ä¸ªå¼€å…³éƒ½å¼€å¯
            if (!backgroundInteractionEnabled || !backgroundChatEnabled) {
                console.log(`ğŸš« [å®šæ—¶å™¨è®¾ç½®] ${character.name} å¼€å…³æœªå¼€å¯ï¼Œä¸è®¾ç½®å®šæ—¶å™¨`);
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æœ€åå›å¤æ—¶é—´
            const messages = chatMessages[characterId] || [];
            const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'sent');

            if (!lastUserMessage) {
                console.log(`ğŸš« [å®šæ—¶å™¨è®¾ç½®] ${character.name} æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯è®°å½•ï¼Œä¸è®¾ç½®å®šæ—¶å™¨`);
                return;
            }

            const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
            const tenMinutes = 10 * 60 * 1000; // 10åˆ†é’Ÿ
            console.log(`ğŸ• [å®šæ—¶å™¨è®¾ç½®] ${character.name}: è·ç¦»ç”¨æˆ·æœ€åå›å¤ ${Math.round(timeSinceLastUserMessage / 60000)} åˆ†é’Ÿ`);

            let delay;
            if (timeSinceLastUserMessage < tenMinutes) {
                // ç”¨æˆ·æœ€è¿‘æœ‰å›å¤ï¼Œç­‰å¾…10åˆ†é’Ÿåå†å¼€å§‹è®¡æ—¶
                delay = tenMinutes - timeSinceLastUserMessage;
                console.log(`â° [å®šæ—¶å™¨è®¾ç½®] ${character.name} å°†åœ¨${Math.round(delay / 60000)}åˆ†é’Ÿåå¼€å§‹ä¸»åŠ¨èŠå¤©è®¡æ—¶`);
            } else {
                // ç”¨æˆ·å·²ç»è¶…è¿‡10åˆ†é’Ÿæ²¡å›å¤ï¼Œç«‹å³å¼€å§‹éšæœºè®¡æ—¶
                delay = 0;
                console.log(`â° [å®šæ—¶å™¨è®¾ç½®] ${character.name} ç«‹å³å¼€å§‹ä¸»åŠ¨èŠå¤©è®¡æ—¶`);
            }

            // è®¾ç½®å®šæ—¶å™¨
            backgroundTimers[characterId + '_chat'] = setTimeout(async () => {
                // 10åˆ†é’Ÿç­‰å¾…æœŸç»“æŸï¼Œç°åœ¨å¼€å§‹éšæœºé—´éš”è®¡æ—¶
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åœ¨å®šæ—¶å™¨æ‰§è¡Œæ—¶å†æ¬¡æ£€æŸ¥å¼€å…³çŠ¶æ€
                const currentChatSettings = await getAsyncChatSettings(characterId);
                const currentBackgroundInteractionEnabled = currentChatSettings.backgroundInteractionEnabled === true;
                const currentBackgroundChatEnabled = currentChatSettings.backgroundChatEnabled === true;

                console.log(`ğŸ” [å®šæ—¶å™¨æ‰§è¡Œæ£€æŸ¥] ${character.name}:`, {
                    currentBackgroundInteractionEnabled,
                    currentBackgroundChatEnabled
                });

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœå¼€å…³è¢«å…³é—­ï¼Œå–æ¶ˆå®šæ—¶å™¨
                if (!currentBackgroundInteractionEnabled || !currentBackgroundChatEnabled) {
                    console.log(`ğŸš« [å®šæ—¶å™¨æ‰§è¡Œ] ${character.name} å¼€å…³å·²å…³é—­ï¼Œå–æ¶ˆä¸»åŠ¨èŠå¤©`);
                    return;
                }

                const randomInterval = getBackgroundInterval(currentChatSettings.backgroundChatFrequency || 'low');
                console.log(`â° [å®šæ—¶å™¨æ‰§è¡Œ] ${character.name} å°†åœ¨${Math.round(randomInterval / 60000)}åˆ†é’Ÿåå‘é€ä¸»åŠ¨æ¶ˆæ¯`);

                // è®¾ç½®å®é™…çš„ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
                backgroundTimers[characterId + '_chat'] = setTimeout(() => {
                    triggerBackgroundChat(characterId);
                    // å‘é€å®Œæ¶ˆæ¯åï¼Œé‡æ–°å®‰æ’ä¸‹æ¬¡çš„ä¸»åŠ¨èŠå¤©
                    scheduleProactiveChatForCharacter(characterId);
                }, randomInterval);
            }, delay);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œé‡æ–°å®‰æ’ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
        function onUserMessageSent(characterId) {
            const character = characters.find(c => c.id === characterId);
            console.log(`ç”¨æˆ·å‘ ${character?.name} å‘é€äº†æ¶ˆæ¯ï¼Œé‡æ–°å®‰æ’ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨`);
            // é‡æ–°å®‰æ’è¯¥è§’è‰²çš„ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
            scheduleProactiveChatForCharacter(characterId);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–æ‰€æœ‰è§’è‰²çš„ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
        async function reinitializeProactiveChatTimers() {
            console.log('ğŸ”„ é‡æ–°åˆå§‹åŒ–æ‰€æœ‰è§’è‰²çš„ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨...');

            for (const character of characters) {
                try {
                    const chatSettings = await getChatSettings(character.id);
                    const backgroundInteractionEnabled = chatSettings.backgroundInteractionEnabled === true;
                    const backgroundChatEnabled = chatSettings.backgroundChatEnabled === true;

                    if (backgroundInteractionEnabled && backgroundChatEnabled) {
                        const messages = chatMessages[character.id] || [];
                        const hasUserMessages = messages.some(msg => msg.sender === 'sent');

                        if (hasUserMessages) {
                            await scheduleProactiveChatForCharacter(character.id);
                            console.log(`âœ… ${character.name} ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å·²é‡æ–°è®¾ç½®`);
                        } else {
                            console.log(`â¸ï¸ ${character.name} æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯è®°å½•ï¼Œè·³è¿‡å®šæ—¶å™¨è®¾ç½®`);
                        }
                    } else {
                        console.log(`ğŸš« ${character.name} ä¸»åŠ¨èŠå¤©åŠŸèƒ½å·²ç¦ç”¨`);
                    }
                } catch (error) {
                    console.error(`âŒ ä¸º ${character.name} è®¾ç½®ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å¤±è´¥:`, error);
                }
            }

            console.log('ğŸ‰ ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨é‡æ–°åˆå§‹åŒ–å®Œæˆ');
        }

        // è·å–åå°åŠ¨æ€é—´éš”æ—¶é—´
        function getBackgroundMomentsInterval(frequency) {
            switch (frequency) {
                case 'low':
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // 4-8å°æ—¶
                case 'medium':
                    return Math.random() * 2 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000; // 2-4å°æ—¶
                case 'high':
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000; // 1-2å°æ—¶
                default:
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // é»˜è®¤4-8å°æ—¶
            }
        }

        // è§¦å‘åå°èŠå¤©
        async function triggerBackgroundChat(characterId, skipTimeCheck = false) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) {
                    console.log(`ğŸš« [ä¸»åŠ¨èŠå¤©] è§’è‰²ä¸å­˜åœ¨: ${characterId}`);
                    return;
                }

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘é¦–å…ˆæ£€æŸ¥å¼€å…³çŠ¶æ€
                const chatSettings = await getAsyncChatSettings(characterId);
                const backgroundInteractionEnabled = chatSettings.backgroundInteractionEnabled === true;
                const backgroundChatEnabled = chatSettings.backgroundChatEnabled === true;

                console.log(`ğŸ” [ä¸»åŠ¨èŠå¤©æ£€æŸ¥] ${character.name}:`, {
                    backgroundInteractionEnabled,
                    backgroundChatEnabled,
                    skipTimeCheck
                });

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸¥æ ¼æ£€æŸ¥å¼€å…³çŠ¶æ€ - å¿…é¡»ä¸¤ä¸ªå¼€å…³éƒ½å¼€å¯
                if (!backgroundInteractionEnabled || !backgroundChatEnabled) {
                    console.log(`ğŸš« [ä¸»åŠ¨èŠå¤©] ${character.name} å¼€å…³æœªå¼€å¯ï¼Œå–æ¶ˆå‘é€`);
                    return;
                }

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è‡³å°‘10åˆ†é’Ÿæ²¡æœ‰å›å¤ï¼ˆæµ‹è¯•æ—¶å¯è·³è¿‡ï¼‰
                if (!skipTimeCheck) {
                    const messages = chatMessages[characterId] || [];
                    const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'sent');

                    if (lastUserMessage) {
                        const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
                        const tenMinutes = 10 * 60 * 1000; // 10åˆ†é’Ÿ
                        console.log(`ğŸ• [ä¸»åŠ¨èŠå¤©æ—¶é—´æ£€æŸ¥] ${character.name}: è·ç¦»ç”¨æˆ·æœ€åå›å¤ ${Math.round(timeSinceLastUserMessage / 60000)} åˆ†é’Ÿ`);

                        if (timeSinceLastUserMessage < tenMinutes) {
                            console.log(`ğŸš« [ä¸»åŠ¨èŠå¤©] ${character.name} è·³è¿‡ï¼šç”¨æˆ·æœ€è¿‘${Math.round(timeSinceLastUserMessage / 60000)}åˆ†é’Ÿå‰æœ‰å›å¤`);
                            return; // ç”¨æˆ·æœ€è¿‘æœ‰æ´»åŠ¨ï¼Œä¸å‘é€è‡ªåŠ¨æ¶ˆæ¯
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç­‰å¾…æœŸå†…å‘é€è¿‡ä¸»åŠ¨æ¶ˆæ¯
                        const lastAIMessage = messages.slice().reverse().find(msg => msg.sender === 'received');
                        if (lastAIMessage && lastAIMessage.isProactive) {
                            // å¦‚æœæœ€åä¸€æ¡AIæ¶ˆæ¯æ˜¯ä¸»åŠ¨æ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆç†çš„æ—¶é—´é—´éš”å†…
                            const timeSinceLastProactive = Date.now() - lastAIMessage.timestamp;
                            const minInterval = getBackgroundInterval(chatSettings.backgroundChatFrequency || 'low');

                            if (timeSinceLastProactive < minInterval) {
                                console.log(`${character.name} è·³è¿‡ä¸»åŠ¨èŠå¤©ï¼šè·ç¦»ä¸Šæ¬¡ä¸»åŠ¨æ¶ˆæ¯ä»…${Math.round(timeSinceLastProactive / 60000)}åˆ†é’Ÿ`);
                                return;
                            }
                        }
                    }
                } else {
                    console.log(`${character.name} æµ‹è¯•æ¨¡å¼ï¼šè·³è¿‡10åˆ†é’Ÿæ—¶é—´æ£€æŸ¥`);
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å†å²æ¶ˆæ¯å›åˆæ•°å’Œè·¨çª—å£è®°å¿†æ•°
                const historyCount = chatSettings.historyCount || 5;
                const crossWindowMemory = chatSettings.crossWindowMemory || 3;

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–èŠå¤©æ¶ˆæ¯ï¼ˆæˆ‘ä¹‹å‰ä¸å°å¿ƒåˆ é™¤äº†è¿™è¡Œï¼‰
                const messages = chatMessages[characterId] || [];

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æŒ‰å›åˆæ•°æ­£ç¡®è®¡ç®—å†å²æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ¶ˆæ¯æ¡æ•°
                let recentMessages;
                if (messages.length > 0) {
                    // ä½¿ç”¨ä¸æ­£å¸¸èŠå¤©ç›¸åŒçš„é€»è¾‘ï¼šæŒ‰å›åˆè®¡ç®—æ¶ˆæ¯
                    recentMessages = calculateMessagesByRounds(messages, historyCount);
                } else {
                    recentMessages = [];
                }

                // ğŸ”¥ã€å¢å¼ºã€‘è·å–è§’è‰²å¯è§çš„åŠ¨æ€å†…å®¹ï¼ŒåŒ…å«åˆ†ç»„è¿‡æ»¤ã€æ—¶é—´æˆ³å’Œè¯„è®ºåŒº
                const recentMoments = await getVisibleMomentsForCharacter(characterId, crossWindowMemory);
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\næœ€è¿‘çš„åŠ¨æ€å†…å®¹å’Œè®¨è®ºï¼š\n';
                    recentMoments.forEach((moment, index) => {
                        const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ æ—¶é—´æˆ³ä¿¡æ¯
                        let timeInfo = '';
                        if (moment.timestamp) {
                            const now = Date.now();
                            const timeDiff = now - moment.timestamp;
                            const minutes = Math.floor(timeDiff / (1000 * 60));
                            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                            if (days > 0) {
                                timeInfo = `ï¼ˆ${days}å¤©å‰å‘å¸ƒï¼‰`;
                            } else if (hours > 0) {
                                timeInfo = `ï¼ˆ${hours}å°æ—¶å‰å‘å¸ƒï¼‰`;
                            } else if (minutes > 0) {
                                timeInfo = `ï¼ˆ${minutes}åˆ†é’Ÿå‰å‘å¸ƒï¼‰`;
                            } else {
                                timeInfo = 'ï¼ˆåˆšåˆšå‘å¸ƒï¼‰';
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘åŒ…å«è¯„è®ºåŒºå†…å®¹
                        const momentContent = `${authorName}: ${moment.text}${timeInfo}${moment.commentsText || ''}`;
                        momentsContext += momentContent;
                    });
                }

                // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©è®°å½•ï¼š\n' +
                        recentMessages.map(msg => {
                            if (msg.sender === 'sent') return `ç”¨æˆ·ï¼š${msg.content}`;
                            if (msg.sender === 'received') return `${character.name}ï¼š${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }

                // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºèŠå¤©å†å²ä¿¡æ¯
                console.log(`ğŸ” [ä¸»åŠ¨èŠå¤©è°ƒè¯•] ${character.name}:`);
                console.log(`  ğŸ“ æ€»æ¶ˆæ¯æ•°: ${messages.length}`);
                console.log(`  ğŸ“Š æœ€è¿‘æ¶ˆæ¯æ•°: ${recentMessages.length}`);
                console.log(`  ğŸ“‹ èŠå¤©å†å²é•¿åº¦: ${chatContext.length}`);
                if (recentMessages.length > 0) {
                    console.log(`  ğŸ• æœ€åä¸€æ¡æ¶ˆæ¯: ${recentMessages[recentMessages.length - 1].content.substring(0, 50)}...`);
                    console.log(`  ğŸ“œ å®Œæ•´èŠå¤©å†å²:`, chatContext);
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–ä¸–ç•Œä¹¦ä¿¡æ¯
                let worldbookContext = '';
                if (character.worldbook && character.worldbook.length > 0) {
                    worldbookContext = '\n\nä¸–ç•Œä¹¦ä¿¡æ¯ï¼š\n' +
                        character.worldbook.map(entry => `${entry.key}: ${entry.value}`).join('\n');
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ç”Ÿæˆæ›´å®Œæ•´çš„ä¸»åŠ¨èŠå¤©å†…å®¹ï¼ŒåŒ…å«äººè®¾ã€ä¸–ç•Œä¹¦ã€å†å²æ¶ˆæ¯ã€åŠ¨æ€ç­‰
                const prompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${character.bio}${worldbookContext}

ç°åœ¨ä½ è¦ä¸»åŠ¨ç»™ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚è¿™æ¡æ¶ˆæ¯åº”è¯¥æ˜¯ï¼š
1. ä¸¥æ ¼ç¬¦åˆä½ çš„äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹
2. è‡ªç„¶ã€æœ‰è¶£ã€æœ‰äº’åŠ¨æ€§
3. å¯ä»¥æ˜¯é—®å€™ã€åˆ†äº«ã€è¯¢é—®ã€å…³å¿ƒç­‰
4. ä¸è¦è¿‡äºæ­£å¼ï¼Œè¦åƒæœ‹å‹é—´çš„æ—¥å¸¸èŠå¤©
5. **é‡è¦**ï¼šå¦‚æœæœ‰èŠå¤©å†å²ï¼Œå¿…é¡»ä»”ç»†é˜…è¯»å¹¶åŸºäºå†å²å†…å®¹è¿›è¡Œè‡ªç„¶çš„å»¶ç»­æˆ–å›åº”ï¼Œç»å¯¹ä¸è¦é‡å¤ä¹‹å‰å·²ç»è¯´è¿‡çš„å†…å®¹
6. å¯ä»¥é€‚å½“æåŠæœ€è¿‘çš„åŠ¨æ€å†…å®¹ï¼Œè®©å¯¹è¯æ›´è‡ªç„¶
7. è€ƒè™‘å½“å‰æ—¶é—´å’Œæƒ…å¢ƒï¼Œè®©æ¶ˆæ¯æ›´è´´åˆå®é™…
8. ä¿æŒè§’è‰²çš„ä¸€è‡´æ€§å’Œè¿è´¯æ€§
9. **ç¦æ­¢é‡å¤**ï¼šä¸è¦å‘é€ä¸èŠå¤©å†å²ä¸­ç›¸åŒæˆ–ç›¸ä¼¼çš„æ¶ˆæ¯å†…å®¹${chatContext}${momentsContext}

è¯·ç”Ÿæˆä¸»åŠ¨èŠå¤©çš„æ¶ˆæ¯ï¼ˆå¯ä»¥æ˜¯1-12æ¡ï¼‰ï¼Œä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š`;

                const response = await generateAIResponse(prompt, character);
                if (response && response.trim()) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ä¸æ­£å¸¸AIå›å¤ç›¸åŒçš„å¤„ç†é€»è¾‘
                    const aiMessages = await parseAiResponse(response);

                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ä¸processAIReplyç›¸åŒçš„æ¶ˆæ¯å¤„ç†é€»è¾‘
                    for (let i = 0; i < aiMessages.length; i++) {
                        const msgData = aiMessages[i];
                        let aiMessage;

                        // ğŸ”¥ã€ä¿®å¤ã€‘è·³è¿‡æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡
                        if (typeof msgData === 'object' && msgData !== null && msgData.type === 'block_user') {
                            console.log('ğŸš« è·³è¿‡æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡ï¼Œä¸æ˜¾ç¤ºä¸ºæ¶ˆæ¯:', msgData);
                            continue;
                        }

                        if (typeof msgData === 'object' && msgData !== null) {
                            if (msgData.type === 'voice_message') {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'voice_message',
                                    content: msgData.content,
                                    timestamp: Date.now() + i * 100
                                };
                            } else if (msgData.type === 'ai_image') {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'ai_image',
                                    content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                                    imageDescription: msgData.description,
                                    timestamp: Date.now() + i * 100
                                };
                            } else if (msgData.type === 'transfer') {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'transfer',
                                    amount: msgData.amount,
                                    note: msgData.note,
                                    timestamp: Date.now() + i * 100
                                };
                            } else if (msgData.type === 'poke') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³
                                console.log('ğŸ” [callChatAPI] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', msgData);
                                const chatSettings = getCurrentChatSettings();
                                const userNickname = chatSettings.myChatNickname || 'ä½ ';
                                const pokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘AIæˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix

                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'system',
                                    content: `${currentChatCharacter.name}æˆ³äº†æˆ³${userNickname}${pokeSuffix}`,
                                    timestamp: Date.now() + i * 100,
                                    isPoke: true
                                };
                            } else if (msgData.type === 'emoji') {
                                const matchingEmoji = await findEmojiForAI(msgData.description);
                                if (matchingEmoji) {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '',
                                        image: matchingEmoji.url,
                                        isEmoji: true,
                                        emojiDescription: matchingEmoji.description,
                                        timestamp: Date.now() + i * 100
                                    };

                                    // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                                    if (msgData.name) {
                                        aiMessage.name = msgData.name;
                                        // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                                        const group = groupChats.find(g => g.id === characterId);
                                        if (group && group.members) {
                                            const member = group.members.find(m => m.name === msgData.name);
                                            if (member) {
                                                aiMessage.senderId = member.id;
                                            }
                                        }
                                    }

                                    // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                                } else {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else if (msgData.content) {
                                // æ™®é€šå¯¹è±¡æ¶ˆæ¯
                                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                                let processedContent;
                                if (typeof msgData.content === 'string') {
                                    processedContent = msgData.content;
                                } else if (Array.isArray(msgData.content) && msgData.content.length > 0) {
                                    // å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼ï¼š[{type: 'text', text: 'å†…å®¹'}]
                                    const firstItem = msgData.content[0];
                                    if (firstItem && firstItem.type === 'text' && firstItem.text) {
                                        processedContent = firstItem.text;
                                    } else {
                                        processedContent = '[å¤šåª’ä½“æ¶ˆæ¯]';
                                    }
                                } else if (msgData.content && typeof msgData.content === 'object') {
                                    // çº¦å®šæˆ–çºªå¿µæ—¥å¯¹è±¡
                                    if (msgData.content.name && typeof msgData.content.name === 'string') {
                                        if (msgData.content.type === 'create_appointment') {
                                            processedContent = `åˆ›å»ºäº†çº¦å®šï¼š${msgData.content.name}`;
                                        } else if (msgData.content.type === 'create_anniversary') {
                                            processedContent = `åˆ›å»ºäº†çºªå¿µæ—¥ï¼š${msgData.content.name}`;
                                        } else {
                                            processedContent = `æåŠäº†ï¼š${msgData.content.name}`;
                                        }
                                    } else {
                                        // å…¶ä»–å¯¹è±¡ç±»å‹
                                        processedContent = msgData.content.message || msgData.content.text || '[å¤šåª’ä½“æ¶ˆæ¯]';
                                    }
                                } else {
                                    processedContent = String(msgData.content || '');
                                }

                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: processedContent,
                                    timestamp: Date.now() + i * 100
                                };
                            } else {
                                console.log('ğŸ”¥ [ä¸»åŠ¨èŠå¤©] ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼:', msgData);
                                continue;
                            }
                        } else if (typeof msgData === 'string') {
                            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: msgData,
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            console.log('ğŸ”¥ [ä¸»åŠ¨èŠå¤©] æ— æ•ˆçš„æ¶ˆæ¯æ•°æ®:', msgData);
                            continue;
                        }

                        if (aiMessage) {
                            // ğŸ”¥ã€æ–°å¢ã€‘æ ‡è®°ä¸ºä¸»åŠ¨æ¶ˆæ¯
                            aiMessage.isProactive = true;
                            chatMessages[characterId].push(aiMessage);
                        }
                    }

                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ä¸»åŠ¨èŠå¤©æ¶ˆæ¯ä½¿ç”¨æ‰¹é‡æ·»åŠ ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        const newDbMessages = [];
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è·å–å®é™…æ·»åŠ åˆ°å†…å­˜ä¸­çš„æ¶ˆæ¯å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹çš„aiMessages
                        const actualMessages = chatMessages[characterId].slice(-aiMessages.length);
                        const startIndex = chatMessages[characterId].length - aiMessages.length;

                        for (let i = 0; i < actualMessages.length; i++) {
                            const aiMessage = actualMessages[i];
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                            const uniqueId = `${characterId}_proactive_${aiMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${startIndex + i}`;
                            newDbMessages.push({
                                id: uniqueId,
                                characterId: characterId,
                                timestamp: aiMessage.timestamp,
                                messageOrder: startIndex + i,
                                originalMessageId: aiMessage.id,
                                messageData: aiMessage
                            });
                        }

                        await db.chatMessages.bulkAdd(newDbMessages);
                        console.log(`âœ… [é«˜æ•ˆä¸»åŠ¨èŠå¤©] ${actualMessages.length} æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“`);
                    } catch (error) {
                        console.error('ä¸»åŠ¨èŠå¤©æ¶ˆæ¯æ‰¹é‡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç«‹å³ä¿å­˜è€Œä¸æ˜¯é˜²æŠ–ä¿å­˜ï¼Œç¡®ä¿ä¸»åŠ¨æ¶ˆæ¯ä¸ä¼šä¸¢å¤±
                        try {
                            await saveChatMessagesImmediate([characterId]);
                            console.log('âœ… [ä¸»åŠ¨èŠå¤©å›é€€] å…¨é‡ä¿å­˜æˆåŠŸ');
                        } catch (fallbackError) {
                            console.error('âŒ [ä¸»åŠ¨èŠå¤©å›é€€] å…¨é‡ä¿å­˜ä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                    console.log(`ğŸ”¥ [ä¸»åŠ¨èŠå¤©] ${character.name} å‘é€äº† ${aiMessages.length} æ¡æ¶ˆæ¯`);

                    // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•ä¸»åŠ¨èŠå¤©æ¶ˆæ¯åˆ°æ—¶é—´çº¿è®°å¿†
                    setTimeout(async () => {
                        try {
                            for (let i = 0; i < aiMessages.length; i++) {
                                const msgData = aiMessages[i];
                                let eventContent = '';

                                if (typeof msgData === 'string') {
                                    eventContent = msgData;
                                } else if (typeof msgData === 'object' && msgData.content) {
                                    eventContent = msgData.content;
                                } else if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                                    eventContent = msgData.content;
                                } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                                    eventContent = `è½¬è´¦ Â¥${msgData.amount}${msgData.note ? ` - ${msgData.note}` : ''}`;
                                } else if (typeof msgData === 'object' && msgData.type === 'poke') {
                                    eventContent = `æˆ³äº†æˆ³ç”¨æˆ·`;
                                } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                                    eventContent = `å‘é€è¡¨æƒ…åŒ…ï¼š${msgData.description}`;
                                }

                                if (eventContent) {
                                    await recordCrossAppEvent(
                                        characterId,
                                        'chat',
                                        'ai_message',
                                        {
                                            id: characterId,
                                            type: 'private_chat',
                                            sender: 'ai',
                                            content: eventContent,
                                            chatType: 'single',
                                            isProactive: true // æ ‡è®°ä¸ºä¸»åŠ¨æ¶ˆæ¯
                                        }
                                    );
                                    console.log(`ğŸ”¥ [ä¸»åŠ¨èŠå¤©] å·²è®°å½•æ—¶é—´çº¿äº‹ä»¶ - è§’è‰²: ${character.name}, å†…å®¹: ${eventContent.substring(0, 50)}...`);
                                }
                            }
                        } catch (error) {
                            console.error('ğŸ”¥ [ä¸»åŠ¨èŠå¤©] è®°å½•æ—¶é—´çº¿äº‹ä»¶å¤±è´¥:', error);
                        }
                    }, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œ

                    // å¦‚æœå½“å‰æ­£åœ¨å’Œè¿™ä¸ªè§’è‰²èŠå¤©ï¼Œç«‹å³æ˜¾ç¤ºæ¶ˆæ¯
                    if (currentChatCharacter && currentChatCharacter.id === characterId) {
                        renderChatMessages(characterId);
                    }

                    // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                    renderMessageList();

                    // ç§»é™¤äº†ä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¥å¿—
                }
            } catch (error) {
                console.error('åå°èŠå¤©å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•ä¸»åŠ¨èŠå¤©åŠŸèƒ½
        async function testActiveChat() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©è§’è‰²', 'error');
                return;
            }

            console.log(`ğŸ§ª æµ‹è¯•ä¸»åŠ¨èŠå¤©åŠŸèƒ½ - è§’è‰²: ${currentChatCharacter.name}`);
            showToast(`æ­£åœ¨æµ‹è¯• ${currentChatCharacter.name} çš„ä¸»åŠ¨èŠå¤©åŠŸèƒ½...`, 'info');

            try {
                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºæµ‹è¯•å‰çš„æ¶ˆæ¯æ•°é‡
                const beforeCount = (chatMessages[currentChatCharacter.id] || []).length;
                console.log(`æµ‹è¯•å‰æ¶ˆæ¯æ•°é‡: ${beforeCount}`);

                await triggerBackgroundChat(currentChatCharacter.id, true); // è·³è¿‡æ—¶é—´æ£€æŸ¥

                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºæµ‹è¯•åçš„æ¶ˆæ¯æ•°é‡
                const afterCount = (chatMessages[currentChatCharacter.id] || []).length;
                console.log(`æµ‹è¯•åæ¶ˆæ¯æ•°é‡: ${afterCount}`);

                if (afterCount > beforeCount) {
                    showToast('ä¸»åŠ¨èŠå¤©æµ‹è¯•æˆåŠŸï¼å·²ç”Ÿæˆæ–°æ¶ˆæ¯', 'success');
                } else {
                    showToast('ä¸»åŠ¨èŠå¤©æµ‹è¯•å®Œæˆï¼Œä½†æœªç”Ÿæˆæ–°æ¶ˆæ¯ï¼ˆå¯èƒ½è¢«æ¡ä»¶é™åˆ¶ï¼‰', 'warning');
                }
            } catch (error) {
                console.error('ä¸»åŠ¨èŠå¤©æµ‹è¯•å¤±è´¥:', error);
                showToast(`ä¸»åŠ¨èŠå¤©æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•ä¸»åŠ¨å‘åŠ¨æ€åŠŸèƒ½
        async function testActiveMoments() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©è§’è‰²', 'error');
                return;
            }

            console.log(`ğŸ§ª æµ‹è¯•ä¸»åŠ¨å‘åŠ¨æ€åŠŸèƒ½ - è§’è‰²: ${currentChatCharacter.name}`);
            showToast(`æ­£åœ¨æµ‹è¯• ${currentChatCharacter.name} çš„ä¸»åŠ¨å‘åŠ¨æ€åŠŸèƒ½...`, 'info');

            try {
                // ğŸ”¥ã€æ–°å¢ã€‘è·å–æµ‹è¯•å‰çš„åŠ¨æ€æ•°é‡
                const beforeMoments = await getRecentMoments(50);
                const beforeCount = beforeMoments.length;
                console.log(`æµ‹è¯•å‰åŠ¨æ€æ•°é‡: ${beforeCount}`);

                await triggerBackgroundMoments(currentChatCharacter.id, true); // è·³è¿‡å†·å´æ—¶é—´

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–æµ‹è¯•åçš„åŠ¨æ€æ•°é‡
                const afterMoments = await getRecentMoments(50);
                const afterCount = afterMoments.length;
                console.log(`æµ‹è¯•ååŠ¨æ€æ•°é‡: ${afterCount}`);

                if (afterCount > beforeCount) {
                    showToast('ä¸»åŠ¨å‘åŠ¨æ€æµ‹è¯•æˆåŠŸï¼å·²å‘å¸ƒæ–°åŠ¨æ€', 'success');
                } else {
                    showToast('ä¸»åŠ¨å‘åŠ¨æ€æµ‹è¯•å®Œæˆï¼Œä½†æœªå‘å¸ƒæ–°åŠ¨æ€', 'warning');
                }
            } catch (error) {
                console.error('ä¸»åŠ¨å‘åŠ¨æ€æµ‹è¯•å¤±è´¥:', error);
                showToast(`ä¸»åŠ¨å‘åŠ¨æ€æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æŸ¥çœ‹å½“å‰åå°å®šæ—¶å™¨çŠ¶æ€
        function checkBackgroundTimers() {
            console.log('ğŸ” å½“å‰åå°å®šæ—¶å™¨çŠ¶æ€:');
            console.log('backgroundTimers:', backgroundTimers);

            const activeTimers = Object.keys(backgroundTimers).length;
            console.log(`æ´»è·ƒå®šæ—¶å™¨æ•°é‡: ${activeTimers}`);

            if (activeTimers === 0) {
                console.log('âš ï¸ æ²¡æœ‰æ´»è·ƒçš„åå°å®šæ—¶å™¨');
                console.log('ğŸ’¡ å¯ä»¥è¿è¡Œ reinitializeProactiveChatTimers() æ¥é‡æ–°åˆå§‹åŒ–å®šæ—¶å™¨');
            } else {
                for (const [key, timer] of Object.entries(backgroundTimers)) {
                    console.log(`- ${key}: ${timer ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`);
                }
            }

            showToast(`å½“å‰æœ‰ ${activeTimers} ä¸ªæ´»è·ƒçš„åå°å®šæ—¶å™¨`, 'info');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°å¯åŠ¨åå°ç³»ç»Ÿï¼ˆç”¨äºæµ‹è¯•ï¼‰
        async function restartBackgroundSystem() {
            console.log('ğŸ”„ é‡æ–°å¯åŠ¨åå°äº’åŠ¨ç³»ç»Ÿ...');
            await initGlobalBackgroundInteractionSystem();
            checkBackgroundTimers();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æš‚åœæŒ‡å®šè§’è‰²çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨ï¼ˆç”¨äºçº¿ä¸‹æ¨¡å¼ï¼‰
        function pauseProactiveChatTimer(characterId) {
            const timerKey = characterId + '_chat';
            if (backgroundTimers[timerKey]) {
                clearTimeout(backgroundTimers[timerKey]);
                // ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€ï¼Œä»¥ä¾¿æ¢å¤æ—¶ä½¿ç”¨
                backgroundTimers[timerKey + '_paused'] = true;
                delete backgroundTimers[timerKey];
                console.log(`â¸ï¸ å·²æš‚åœè§’è‰² ${characters.find(c => c.id === characterId)?.name} çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨`);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤æŒ‡å®šè§’è‰²çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨ï¼ˆé€€å‡ºçº¿ä¸‹æ¨¡å¼æ—¶ï¼‰
        function resumeProactiveChatTimer(characterId) {
            const pausedKey = characterId + '_chat_paused';
            if (backgroundTimers[pausedKey]) {
                // åˆ é™¤æš‚åœæ ‡è®°
                delete backgroundTimers[pausedKey];
                // é‡æ–°å®‰æ’ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
                scheduleProactiveChatForCharacter(characterId);
                console.log(`â–¶ï¸ å·²æ¢å¤è§’è‰² ${characters.find(c => c.id === characterId)?.name} çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨`);
            }
        }

        // ğŸ”§ã€è°ƒè¯•ã€‘å°†é‡æ–°åˆå§‹åŒ–å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œæ–¹ä¾¿æ§åˆ¶å°è°ƒç”¨
        window.reinitializeProactiveChatTimers = reinitializeProactiveChatTimers;

        // ğŸ”¥ã€æš´éœ²æµ‹è¯•å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸã€‘
        window.testActiveChat = testActiveChat;
        window.testActiveMoments = testActiveMoments;
        window.checkBackgroundTimers = checkBackgroundTimers;


























        window.initGlobalBackgroundInteractionSystem = initGlobalBackgroundInteractionSystem;
        window.restartBackgroundSystem = restartBackgroundSystem;
        window.triggerPublisherReplyToComments = triggerPublisherReplyToComments;

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•å‘å¸ƒè€…å›å¤åŠŸèƒ½
        window.testPublisherReply = async function(momentId) {
            try {
                console.log('ğŸ§ª å¼€å§‹æµ‹è¯•å‘å¸ƒè€…å›å¤åŠŸèƒ½...');

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿momentIdæ˜¯æ­£ç¡®çš„æ•°å­—ç±»å‹
                const numericMomentId = typeof momentId === 'string' ? parseInt(momentId) : momentId;
                console.log(`ğŸ” æŸ¥æ‰¾åŠ¨æ€ID: ${numericMomentId} (åŸå§‹è¾“å…¥: ${momentId})`);

                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(numericMomentId);
                if (!moment) {
                    console.error('âŒ æœªæ‰¾åˆ°åŠ¨æ€:', numericMomentId);
                    // ğŸ”¥ã€è°ƒè¯•ã€‘åˆ—å‡ºæ‰€æœ‰åŠ¨æ€ID
                    const allMoments = await db.moments.toArray();
                    console.log('ğŸ“‹ æ•°æ®åº“ä¸­çš„æ‰€æœ‰åŠ¨æ€ID:', allMoments.map(m => `${m.id} (${typeof m.id})`));
                    return;
                }

                // è·å–å‘å¸ƒè€…è§’è‰²
                const publisherCharacter = characters.find(c => c.id === moment.characterId);
                if (!publisherCharacter) {
                    console.error('âŒ æœªæ‰¾åˆ°å‘å¸ƒè€…è§’è‰²:', moment.characterId);
                    console.log('ğŸ“‹ å¯ç”¨è§’è‰²:', characters.map(c => `${c.name} (ID: ${c.id})`));
                    return;
                }

                console.log(`ğŸ“ æµ‹è¯•åŠ¨æ€: ${moment.text}`);
                console.log(`ğŸ‘¤ å‘å¸ƒè€…: ${publisherCharacter.name} (ID: ${publisherCharacter.id})`);

                // ç›´æ¥è°ƒç”¨å‘å¸ƒè€…å›å¤å‡½æ•°
                await triggerPublisherReplyToComments(numericMomentId, publisherCharacter);

                console.log('âœ… æµ‹è¯•å®Œæˆ');
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
            }
        };

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ—å‡ºæœ€è¿‘çš„åŠ¨æ€IDï¼Œæ–¹ä¾¿æµ‹è¯•
        window.listRecentMoments = async function() {
            try {
                const moments = await db.moments.orderBy('timestamp').reverse().limit(10).toArray();
                console.log('ğŸ“‹ æœ€è¿‘10æ¡åŠ¨æ€:');
                moments.forEach((moment, index) => {
                    console.log(`${index + 1}. ID: ${moment.id} | å‘å¸ƒè€…: ${moment.nickname} | å†…å®¹: ${moment.text.substring(0, 30)}...`);
                });
                console.log('ğŸ’¡ ä½¿ç”¨ testPublisherReply(åŠ¨æ€ID) æ¥æµ‹è¯•å‘å¸ƒè€…å›å¤åŠŸèƒ½');
                console.log('ğŸ’¡ ä½¿ç”¨ forcePublisherReply(åŠ¨æ€ID) æ¥å¼ºåˆ¶å‘å¸ƒè€…å›å¤');
            } catch (error) {
                console.error('âŒ è·å–åŠ¨æ€åˆ—è¡¨å¤±è´¥:', error);
            }
        };

        // ğŸ”¥ã€æ–°å¢ã€‘å¼ºåˆ¶å‘å¸ƒè€…å›å¤åŠŸèƒ½ï¼ˆå¿½ç•¥æ¦‚ç‡æ£€æŸ¥ï¼‰
        window.forcePublisherReply = async function(momentId) {
            try {
                console.log('ğŸ§ª å¼ºåˆ¶å‘å¸ƒè€…å›å¤æµ‹è¯•...');

                const numericMomentId = typeof momentId === 'string' ? parseInt(momentId) : momentId;
                const moment = await db.moments.get(numericMomentId);
                if (!moment) {
                    console.error('âŒ æœªæ‰¾åˆ°åŠ¨æ€:', numericMomentId);
                    return;
                }

                const publisherCharacter = characters.find(c => c.id === moment.characterId);
                if (!publisherCharacter) {
                    console.error('âŒ æœªæ‰¾åˆ°å‘å¸ƒè€…è§’è‰²:', moment.characterId);
                    return;
                }

                // è·å–è¯„è®º
                const comments = await db.momentComments.where('momentId').equals(numericMomentId).toArray();
                const otherCharacterComments = comments.filter(comment =>
                    comment.authorId !== publisherCharacter.id &&
                    comment.authorId !== 'user' &&
                    comment.authorId
                );

                if (otherCharacterComments.length === 0) {
                    console.log('âŒ æ²¡æœ‰å…¶ä»–è§’è‰²çš„è¯„è®ºå¯å›å¤');
                    return;
                }

                // å¼ºåˆ¶é€‰æ‹©ä¸€æ¡è¯„è®ºå›å¤
                const randomComment = otherCharacterComments[Math.floor(Math.random() * otherCharacterComments.length)];
                console.log(`ğŸ¯ å¼ºåˆ¶ ${publisherCharacter.name} å›å¤ ${randomComment.nickname} çš„è¯„è®º`);

                const replyText = await generatePublisherReply(publisherCharacter, randomComment, numericMomentId);
                if (replyText) {
                    const reply = {
                        id: Date.now() + Math.random(),
                        nickname: publisherCharacter.name,
                        avatar: publisherCharacter.avatarUrl,
                        text: replyText,
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        characterId: publisherCharacter.id,
                        replyTo: randomComment.nickname
                    };

                    await saveCommentToMoment(numericMomentId, reply);
                    await updateMomentCommentCount(numericMomentId);
                    displayCommentUnderMoment(numericMomentId, reply);

                    console.log(`âœ… å¼ºåˆ¶å›å¤æˆåŠŸ: "${replyText}"`);
                } else {
                    console.log('âŒ ç”Ÿæˆå›å¤å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ å¼ºåˆ¶å›å¤æµ‹è¯•å¤±è´¥:', error);
            }
        };

        // è§¦å‘åå°å‘åŠ¨æ€ï¼ˆæµ‹è¯•ç‰ˆæœ¬ï¼Œè·³è¿‡å†·å´æ—¶é—´ï¼‰
        async function triggerBackgroundMomentsTest(characterId) {
            // ç§»é™¤äº†æµ‹è¯•å‘å¸ƒæ—¥å¿—
            // ç›´æ¥è°ƒç”¨æ­£å¸¸å‘å¸ƒå‡½æ•°ï¼Œä½†è·³è¿‡å†·å´æ—¶é—´æ£€æŸ¥
            await triggerBackgroundMoments(characterId, true);
        }

        // è§¦å‘åå°å‘åŠ¨æ€
        async function triggerBackgroundMoments(characterId, skipCooldown = false) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // æ£€æŸ¥å†·å´æ—¶é—´ï¼ˆé¿å…çŸ­æ—¶é—´å†…é‡å¤å‘å¸ƒï¼‰
                if (!skipCooldown) {
                    const lastMomentTime = character.lastMomentTime || 0;
                    const cooldownTime = 30 * 60 * 1000; // 30åˆ†é’Ÿå†·å´æ—¶é—´
                    if (Date.now() - lastMomentTime < cooldownTime) {
                        // ç§»é™¤äº†å†·å´æ—¶é—´æ—¥å¿—
                        return;
                    }
                } else {
                    // ç§»é™¤äº†æµ‹è¯•å‘å¸ƒæ—¥å¿—
                }

                const chatSettings = getCurrentChatSettings();

                // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•
                const messages = chatMessages[characterId] || [];
                const maxMemory = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-maxMemory);

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–è§’è‰²å¯è§çš„åŠ¨æ€å†…å®¹ï¼ŒåŒ…å«æ—¶é—´æˆ³å’Œåˆ†ç»„è¿‡æ»¤
                const recentMoments = await getVisibleMomentsForCharacter(characterId, 5);

                // æ„å»ºä¸Šä¸‹æ–‡
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©è®°å½•ï¼š\n' +
                        recentMessages.map(msg => {
                            if (msg.sender === 'sent') return `ç”¨æˆ·ï¼š${msg.content}`;
                            if (msg.sender === 'received') return `${character.name}ï¼š${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }

                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\næœ€è¿‘çš„åŠ¨æ€å†…å®¹å’Œè®¨è®ºï¼š\n';
                    recentMoments.forEach((moment, index) => {
                        const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ æ—¶é—´æˆ³ä¿¡æ¯
                        let timeInfo = '';
                        if (moment.timestamp) {
                            const now = Date.now();
                            const timeDiff = now - moment.timestamp;
                            const minutes = Math.floor(timeDiff / (1000 * 60));
                            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                            if (days > 0) {
                                timeInfo = `ï¼ˆ${days}å¤©å‰å‘å¸ƒï¼‰`;
                            } else if (hours > 0) {
                                timeInfo = `ï¼ˆ${hours}å°æ—¶å‰å‘å¸ƒï¼‰`;
                            } else if (minutes > 0) {
                                timeInfo = `ï¼ˆ${minutes}åˆ†é’Ÿå‰å‘å¸ƒï¼‰`;
                            } else {
                                timeInfo = 'ï¼ˆåˆšåˆšå‘å¸ƒï¼‰';
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘åŒ…å«è¯„è®ºåŒºå†…å®¹
                        const momentContent = `${authorName}: ${moment.text}${timeInfo}${moment.commentsText || ''}`;
                        momentsContext += momentContent;
                    });
                }

                // ç”ŸæˆåŠ¨æ€å†…å®¹
                const prompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${character.bio}ã€‚

ç°åœ¨ä½ è¦å‘å¸ƒä¸€æ¡åŠ¨æ€ã€‚è¿™æ¡åŠ¨æ€åº”è¯¥æ˜¯ï¼š
1. ç¬¦åˆä½ çš„äººè®¾å’Œæ€§æ ¼
2. ç”Ÿæ´»åŒ–ã€æœ‰è¶£ã€æœ‰ä¸ªæ€§
3. 50-200å­—å·¦å³
4. å¯ä»¥æ˜¯å¿ƒæƒ…ã€æ„Ÿæ‚Ÿã€æ—¥å¸¸ã€åˆ†äº«ç­‰
5. å¯ä»¥ç»“åˆæœ€è¿‘çš„èŠå¤©æˆ–åŠ¨æ€å†…å®¹ä½œä¸ºçµæ„Ÿ
6. è¦æœ‰ä½ ç‹¬ç‰¹çš„é£æ ¼ï¼Œä¸èƒ½å’Œå…¶ä»–è§’è‰²æ··æ·†
7. æ”¯æŒæ¢è¡Œæ˜¾ç¤ºï¼Œå¯ä»¥é€‚å½“åˆ†æ®µè®©å†…å®¹æ›´æ˜“è¯»
8. å¯ä»¥é€‰æ‹©æ€§åœ°é…å›¾ï¼Œå¦‚æœæƒ³è¦é…å›¾ï¼Œè¯·ç›´æ¥æ¢è¡Œï¼Œç„¶åç”¨æ–œä½“æ ¼å¼å†™ï¼š*[é…å›¾ï¼šè¯¦ç»†çš„å›¾ç‰‡æè¿°]*

## é…å›¾è§„åˆ™ï¼ˆä¸¥æ ¼éµå¾ªï¼‰ï¼š
- å¤§éƒ¨åˆ†åŠ¨æ€éƒ½ä¸éœ€è¦é…å›¾ï¼Œåªæœ‰åœ¨éå¸¸ç‰¹æ®Šã€å€¼å¾—è®°å½•çš„æ—¶åˆ»æ‰æ·»åŠ é…å›¾æè¿°
- çº¯æ–‡å­—æ„Ÿæ‚Ÿã€å¿ƒæƒ…ã€æ—¥å¸¸æƒ³æ³•ç­‰é€šå¸¸ä¸éœ€è¦é…å›¾
- åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µæ‰è€ƒè™‘é…å›¾ï¼šåˆ†äº«ç¾é£Ÿã€æ—…è¡Œé£æ™¯ã€ç‰¹æ®Šäº‹ä»¶ã€æœ‰è¶£å‘ç°ç­‰
- å›¾ç‰‡æè¿°è¦ç”ŸåŠ¨ã€å…·ä½“ï¼Œè®©äººèƒ½é€šè¿‡æ–‡å­—æƒ³è±¡å‡ºç”»é¢
- ä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°ï¼Œä¾‹å¦‚ï¼š*[é…å›¾ï¼šç…§ç‰‡é‡Œä¸€åªæ©˜çŒ«æ­£æ‡’æ´‹æ´‹åœ°è¶´åœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œé˜³å…‰æŠŠå®ƒé‡‘è‰²çš„æ¯›ç…§å¾—å‘äº®ï¼ŒèƒŒæ™¯æ˜¯è”šè“çš„å¤©ç©ºå’Œå‡ æœµç™½äº‘ã€‚]*
- å›¾ç‰‡æè¿°è¦ç¬¦åˆä½ çš„æ€§æ ¼å’Œå½“å‰æƒ…å¢ƒ

${chatContext}${momentsContext}

## é‡è¦æ ¼å¼è¦æ±‚ï¼š
- ç›´æ¥è¿”å›åŠ¨æ€æ–‡æœ¬å†…å®¹ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼
- ä¸è¦æ·»åŠ ä»»ä½•ä»£ç å—æ ‡è®°
- ä¸è¦æ·»åŠ "åŠ¨æ€å†…å®¹ï¼š"ç­‰å‰ç¼€
- ç›´æ¥ä»¥åŠ¨æ€æ­£æ–‡å¼€å§‹

è¯·ç”Ÿæˆä¸€æ¡ç¬¦åˆä½ äººè®¾çš„åŠ¨æ€å†…å®¹ï¼š`;

                const response = await generateAIResponse(prompt, character);
                if (response && response.trim()) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘åŠ¨æ€å†…å®¹åº”è¯¥æ˜¯çº¯æ–‡æœ¬ï¼Œå¼ºåŒ–æ ¼å¼å¤„ç†
                    let content = response.trim();

                    // ğŸ”¥ã€å¢å¼ºã€‘æ›´å¼ºçš„JSONæ ¼å¼æ£€æµ‹å’Œå¤„ç†
                    if (content.startsWith('[') || content.startsWith('{')) {
                        try {
                            const parsed = JSON.parse(content);
                            console.log(character.name + ' å‘åŠ¨æ€æ—¶AIè¿”å›äº†JSONæ ¼å¼ï¼Œæ­£åœ¨æå–æ–‡æœ¬:', parsed);

                            if (Array.isArray(parsed) && parsed.length > 0) {
                                // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆå¹¶æ‰€æœ‰æ–‡æœ¬å†…å®¹
                                content = parsed.map(item => {
                                    if (typeof item === 'string') {
                                        return item.trim();
                                    } else if (typeof item === 'object' && item.content) {
                                        return item.content.trim();
                                    } else if (typeof item === 'object' && item.text) {
                                        return item.text.trim();
                                    }
                                    return '';
                                }).filter(text => text).join('\n');
                            } else if (typeof parsed === 'object') {
                                // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–æ–‡æœ¬å­—æ®µ
                                content = parsed.content || parsed.text || parsed.message || JSON.stringify(parsed);
                            }

                            console.log(character.name + ' æå–åçš„åŠ¨æ€å†…å®¹:', content);
                        } catch (parseError) {
                            // å¦‚æœä¸æ˜¯æœ‰æ•ˆJSONï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬
                            console.log(character.name + ' åŠ¨æ€å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSONï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬');
                            content = response.trim();
                        }
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†å¯èƒ½çš„æ ¼å¼æ ‡è®°
                    content = content
                        .replace(/^```[\s\S]*?\n/, '') // ç§»é™¤å¼€å¤´çš„ä»£ç å—æ ‡è®°
                        .replace(/\n```$/, '') // ç§»é™¤ç»“å°¾çš„ä»£ç å—æ ‡è®°
                        .replace(/^\*\*åŠ¨æ€å†…å®¹\*\*:?\s*/i, '') // ç§»é™¤å¯èƒ½çš„æ ‡é¢˜
                        .replace(/^åŠ¨æ€å†…å®¹:?\s*/i, '') // ç§»é™¤å¯èƒ½çš„æ ‡é¢˜
                        .trim();

                    if (content) {
                        // è·å–å¤´åƒï¼Œç¡®ä¿å®‰å…¨
                        const avatar = getCharacterAvatar(character);
                        // ç§»é™¤äº†å‘å¸ƒåŠ¨æ€å¤´åƒæ—¥å¿—

                        // å‘å¸ƒåŠ¨æ€
                        const moment = {
                            id: Date.now(),  // ä½¿ç”¨æ•°å­—IDè€Œä¸æ˜¯å­—ç¬¦ä¸²
                            authorId: characterId,
                            nickname: character.name,
                            avatar: avatar, // è§’è‰²å¤´åƒ
                            text: content,
                            time: formatTime(new Date()),
                            timestamp: Date.now(),
                            characterId: characterId
                        };

                                                                    // ä¿å­˜åˆ°æ•°æ®åº“
                        await db.moments.add(moment);

                        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè§’è‰²å‘å¸ƒçš„åŠ¨æ€è®¾ç½®å¯è§æ€§
                        // è§’è‰²å‘å¸ƒçš„åŠ¨æ€é»˜è®¤ä¸ºéƒ¨åˆ†å¯è§ï¼Œåªæœ‰åŒåˆ†ç»„çš„è§’è‰²å¯ä»¥çœ‹åˆ°
                        if (character.groupId) {
                            await db.momentVisibility.add({
                                momentId: moment.id,
                                visibility: 'partial',
                                visibleGroups: [character.groupId],
                                timestamp: new Date()
                            });
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè§’è‰²å‘å¸ƒåŠ¨æ€åˆ›å»ºæ¨é€é€šçŸ¥
                        createPushNotification(character, `å‘å¸ƒäº†æ–°åŠ¨æ€ï¼š${content.length > 15 ? content.substring(0, 15) + '...' : content}`, 500);

                        // è®°å½•å‘å¸ƒæ—¶é—´
                        character.lastMomentTime = Date.now();
                        saveCharacters();

                        // å¼ºåˆ¶åˆ·æ–°åŠ¨æ€æ˜¾ç¤ºï¼ˆæ— è®ºå½“å‰åœ¨å“ªä¸ªé¡µé¢ï¼‰
                        setTimeout(() => {
                            loadMoments();
                        }, 100);

                        // è§¦å‘åŒåˆ†ç»„è§’è‰²çš„è‡ªå‘äº’åŠ¨ï¼ˆä¿æŒæ¦‚ç‡è®¾ç½®ï¼‰
                        setTimeout(() => {
                            triggerAIInteractions(moment.id, 'like');
                        }, 2000 + Math.random() * 3000); // 2-5ç§’åå¼€å§‹ç‚¹èµ

                        setTimeout(() => {
                            triggerAIInteractions(moment.id, 'comment');
                        }, 5000 + Math.random() * 5000); // 5-10ç§’åå¼€å§‹è¯„è®º

                        // ç§»é™¤äº†å‘å¸ƒåŠ¨æ€æ—¥å¿—
                    }
                }
            } catch (error) {
                console.error('åå°å‘åŠ¨æ€å¤±è´¥:', error);
            }
        }

        // è·å–æœ€è¿‘çš„åŠ¨æ€
        async function getRecentMoments(count = 5) {
            try {
                // ä»æ•°æ®åº“è·å–æœ€æ–°çš„åŠ¨æ€æ•°æ®
                const momentsData = await db.moments.orderBy('timestamp').reverse().limit(count).toArray();
                return momentsData || [];
            } catch (error) {
                console.error('è·å–æœ€è¿‘åŠ¨æ€å¤±è´¥:', error);
                return [];
            }
        }

        // ğŸ”¥ã€å¢å¼ºã€‘è·å–è§’è‰²å¯è§çš„åŠ¨æ€ï¼ˆç”¨äºèŠå¤©è®°å¿†é›†æˆï¼‰- åŒ…å«è¯„è®ºåŒºå†…å®¹
        async function getVisibleMomentsForCharacter(characterId, count = 5) {
            try {
                // è·å–æ‰€æœ‰æœ€æ–°åŠ¨æ€
                const allMoments = await db.moments.orderBy('timestamp').reverse().limit(count * 3).toArray();

                const visibleMoments = [];
                const character = characters.find(c => c.id === characterId);

                for (const moment of allMoments) {
                    if (visibleMoments.length >= count) break;

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥åŠ¨æ€å¯è§æ€§è®¾ç½®
                    const isVisible = await checkMomentVisibilityForCharacter(moment.id, characterId);
                    if (!isVisible) {
                        continue;
                    }

                    // ç”¨æˆ·å‘çš„åŠ¨æ€ï¼Œæ ¹æ®å¯è§æ€§è®¾ç½®å†³å®šæ˜¯å¦å¯è§
                    if (moment.authorId === 'user') {
                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯¥åŠ¨æ€çš„è¯„è®ºåŒºå†…å®¹
                        const momentWithComments = await enrichMomentWithComments(moment, characterId);
                        visibleMoments.push(momentWithComments);
                        continue;
                    }

                    // è§’è‰²è‡ªå·±å‘çš„åŠ¨æ€
                    if (moment.authorId === characterId || moment.characterId === characterId) {
                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯¥åŠ¨æ€çš„è¯„è®ºåŒºå†…å®¹
                        const momentWithComments = await enrichMomentWithComments(moment, characterId);
                        visibleMoments.push(momentWithComments);
                        continue;
                    }

                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¥½å‹åˆ†ç»„çš„è§’è‰²å‘çš„åŠ¨æ€
                    if (character && moment.characterId) {
                        const momentAuthor = characters.find(c => c.id === moment.characterId);
                        if (momentAuthor && areCharactersInSameGroup(character, momentAuthor)) {
                            // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯¥åŠ¨æ€çš„è¯„è®ºåŒºå†…å®¹
                            const momentWithComments = await enrichMomentWithComments(moment, characterId);
                            visibleMoments.push(momentWithComments);
                            continue;
                        }
                    }
                }

                return visibleMoments;
            } catch (error) {
                console.error('è·å–è§’è‰²å¯è§åŠ¨æ€å¤±è´¥:', error);
                return [];
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºåŠ¨æ€æ·»åŠ è¯„è®ºåŒºå†…å®¹çš„è¾…åŠ©å‡½æ•°
        async function enrichMomentWithComments(moment, characterId) {
            try {
                // è·å–è¯¥åŠ¨æ€çš„æ‰€æœ‰è¯„è®º
                const comments = await db.momentComments
                    .where('momentId')
                    .equals(moment.id)
                    .toArray();

                // æŒ‰æ—¶é—´æ’åºè¯„è®º
                comments.sort((a, b) => a.timestamp - b.timestamp);

                // ğŸ”¥ã€æ–°å¢ã€‘è¿‡æ»¤è§’è‰²å¯è§çš„è¯„è®ºï¼ˆåŸºäºåˆ†ç»„å…³ç³»ï¼‰
                const visibleComments = [];
                const character = characters.find(c => c.id === characterId);

                for (const comment of comments) {
                    // ç”¨æˆ·çš„è¯„è®ºæ€»æ˜¯å¯è§
                    if (comment.authorId === 'user') {
                        visibleComments.push(comment);
                        continue;
                    }

                    // è§’è‰²è‡ªå·±çš„è¯„è®ºæ€»æ˜¯å¯è§
                    if (comment.authorId === characterId) {
                        visibleComments.push(comment);
                        continue;
                    }

                    // æ£€æŸ¥è¯„è®ºè€…æ˜¯å¦ä¸å½“å‰è§’è‰²åœ¨åŒä¸€åˆ†ç»„
                    if (character && comment.authorId) {
                        const commentAuthor = characters.find(c => c.id === comment.authorId);
                        if (commentAuthor && areCharactersInSameGroup(character, commentAuthor)) {
                            visibleComments.push(comment);
                        }
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºè¯„è®ºåŒºæ‘˜è¦æ–‡æœ¬
                let commentsText = '';
                if (visibleComments.length > 0) {
                    commentsText = '\nè¯„è®ºåŒºï¼š\n';
                    visibleComments.forEach((comment, index) => {
                        const authorName = comment.authorId === 'user' ? 'ç”¨æˆ·' : comment.nickname;
                        commentsText += `  ${index + 1}. ${authorName}: ${comment.text}\n`;
                    });
                }

                // è¿”å›åŒ…å«è¯„è®ºä¿¡æ¯çš„åŠ¨æ€å¯¹è±¡
                return {
                    ...moment,
                    commentsText: commentsText,
                    commentsCount: visibleComments.length,
                    visibleComments: visibleComments
                };
            } catch (error) {
                console.error('è·å–åŠ¨æ€è¯„è®ºå¤±è´¥:', error);
                // å¦‚æœè·å–è¯„è®ºå¤±è´¥ï¼Œè¿”å›åŸå§‹åŠ¨æ€
                return {
                    ...moment,
                    commentsText: '',
                    commentsCount: 0,
                    visibleComments: []
                };
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥åŠ¨æ€å¯¹ç‰¹å®šè§’è‰²çš„å¯è§æ€§
        async function checkMomentVisibilityForCharacter(momentId, characterId) {
            try {
                // è·å–åŠ¨æ€çš„å¯è§æ€§è®¾ç½®
                const visibilitySettings = await db.momentVisibility.where('momentId').equals(momentId).first();

                // å¦‚æœæ²¡æœ‰å¯è§æ€§è®¾ç½®ï¼Œé»˜è®¤ä¸ºå…¬å¼€
                if (!visibilitySettings) {

                    return true;
                }

                const { visibility, visibleGroups } = visibilitySettings;


                // å…¬å¼€åŠ¨æ€ï¼Œæ‰€æœ‰äººå¯è§
                if (visibility === 'public') {

                    return true;
                }

                // ç§å¯†åŠ¨æ€ï¼Œåªæœ‰å‘å¸ƒè€…å¯è§
                if (visibility === 'private') {
                    const moment = await db.moments.get(momentId);
                    const isVisible = moment && (moment.authorId === characterId || moment.characterId === characterId);

                    return isVisible;
                }

                // éƒ¨åˆ†å¯è§åŠ¨æ€ï¼Œæ£€æŸ¥è§’è‰²æ˜¯å¦åœ¨å¯è§åˆ†ç»„ä¸­
                if (visibility === 'partial') {
                    const character = characters.find(c => c.id === characterId);
                    if (!character || !character.groupId) {

                        return false;
                    }
                    const isVisible = visibleGroups.includes(character.groupId);

                    return isVisible;
                }


                return false;
            } catch (error) {
                console.error('æ£€æŸ¥åŠ¨æ€å¯è§æ€§å¤±è´¥:', error);
                return true; // å‡ºé”™æ—¶é»˜è®¤å¯è§
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ä¸¤ä¸ªè§’è‰²æ˜¯å¦åœ¨åŒä¸€ä¸ªå¥½å‹åˆ†ç»„
        function areCharactersInSameGroup(char1, char2) {
            // æ£€æŸ¥ä¸¤ä¸ªè§’è‰²æ˜¯å¦åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­
            if (char1.groupId && char2.groupId && char1.groupId === char2.groupId) {
                return true;
            }

            // å¦‚æœæ²¡æœ‰åˆ†ç»„ä¿¡æ¯ï¼Œæ£€æŸ¥æ˜¯å¦éƒ½åœ¨è”ç³»äººåˆ—è¡¨ä¸­ï¼ˆå‘åå…¼å®¹ï¼‰
            return contacts.includes(char1.id) && contacts.includes(char2.id);
        }

        // ç”ŸæˆAIå“åº”çš„åŒ…è£…å‡½æ•°ï¼Œç”¨äºåå°äº’åŠ¨
        async function generateAIResponse(prompt, character) {
            try {
                // ä½¿ç”¨ç°æœ‰çš„ callChatAPI å‡½æ•°
                const response = await callChatAPI(prompt, character);
                return response;
            } catch (error) {
                console.error('AIå“åº”ç”Ÿæˆå¤±è´¥:', error);
                return null;
            }
        }

        // éªŒè¯å¤´åƒURLæ˜¯å¦æœ‰æ•ˆ
        function isValidAvatarUrl(url) {
            if (!url || typeof url !== 'string') return false;

            // æ£€æŸ¥base64æ ¼å¼
            if (url.startsWith('data:image/')) {
                // æ›´å®½æ¾çš„base64éªŒè¯ï¼Œåªæ£€æŸ¥åŸºæœ¬ç»“æ„
                const parts = url.split(',');
                if (parts.length !== 2) {
                    console.warn('base64å¤´åƒURLæ ¼å¼é”™è¯¯ï¼ˆç¼ºå°‘é€—å·åˆ†éš”ï¼‰:', url.substring(0, 50) + '...');
                    return false;
                }

                const header = parts[0];
                const data = parts[1];

                // æ£€æŸ¥headeræ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
                if (!header.includes('data:image/') || !header.includes('base64')) {
                    console.warn('base64å¤´åƒURLå¤´éƒ¨æ ¼å¼é”™è¯¯:', header);
                    return false;
                }

                // æ£€æŸ¥base64æ•°æ®æ˜¯å¦ä¸ºç©ºæˆ–è¿‡é•¿
                if (!data || data.length < 50) {
                    console.warn('base64å¤´åƒæ•°æ®ä¸ºç©ºæˆ–è¿‡çŸ­:', data.length);
                    return false;
                }

                if (data.length > 2000000) { // 2MBé™åˆ¶ï¼Œæ›´å®½æ¾
                    console.warn('base64å¤´åƒæ•°æ®è¿‡å¤§:', data.length, 'å»ºè®®å‹ç¼©åé‡æ–°ä¸Šä¼ ä»¥æé«˜æ€§èƒ½');
                    // ä¸å†ç›´æ¥æ‹’ç»ï¼Œåªæ˜¯è­¦å‘Š
                }

                // ç®€å•æ£€æŸ¥base64å­—ç¬¦æ˜¯å¦åˆæ³•
                const base64Chars = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Chars.test(data)) {
                    console.warn('base64å¤´åƒæ•°æ®åŒ…å«éæ³•å­—ç¬¦');
                    return false;
                }

                return true;
            }

            // æ£€æŸ¥HTTP(S) URLæ ¼å¼
            if (url.startsWith('http://') || url.startsWith('https://')) {
                try {
                    new URL(url);
                    return true;
                } catch (error) {
                    console.warn('æ— æ•ˆçš„HTTPå¤´åƒURL:', url);
                    return false;
                }
            }

            // å¦‚æœä¸æ˜¯data:imageæˆ–http(s)å¼€å¤´ï¼Œè€ƒè™‘å¯èƒ½æ˜¯å…¶ä»–æœ‰æ•ˆæ ¼å¼
            console.warn('æœªçŸ¥çš„å¤´åƒURLæ ¼å¼:', url.substring(0, 50) + '...');
            return false;
        }

        // è·å–è§’è‰²çš„å¤´åƒï¼ˆç”¨äºåŠ¨æ€å‘å¸ƒï¼‰
        function getCharacterAvatar(character) {
            // ä½¿ç”¨åŒæ­¥ç‰ˆæœ¬çš„è®¾ç½®è·å–ï¼Œé¿å…Promiseé—®é¢˜
            const chatSettings = getChatSettingsSync(character.id);

            // ä¼˜å…ˆçº§1ï¼šå¦‚æœè§’è‰²æœ‰èŠå¤©çª—å£çš„å¤´åƒè®¾ç½®ï¼Œä½¿ç”¨é‚£ä¸ª
            if (chatSettings.aiChatAvatar && chatSettings.aiChatAvatar.trim()) {
                const avatar = chatSettings.aiChatAvatar;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`è§’è‰²${character.name}çš„èŠå¤©å¤´åƒæ— æ•ˆï¼Œå°è¯•ä½¿ç”¨å…¶ä»–å¤´åƒ`);
                }
            }

            // ä¼˜å…ˆçº§2ï¼šå¦‚æœè§’è‰²æœ‰èŠå¤©çª—å£çš„å¤´åƒè®¾ç½®ï¼Œä½¿ç”¨é‚£ä¸ªï¼ˆå·²åœ¨ä¸Šé¢å¤„ç†ï¼‰

            // ä¼˜å…ˆçº§2ï¼šä½¿ç”¨è§’è‰²å¡é‡Œçš„å¤´åƒ
            if (character.avatarUrl && character.avatarUrl.trim()) {
                const avatar = character.avatarUrl;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`è§’è‰²${character.name}çš„è§’è‰²å¡å¤´åƒæ— æ•ˆï¼Œå¤§å°æˆ–æ ¼å¼é—®é¢˜`);
                }
            }

            console.log(`è§’è‰²${character.name}æ²¡æœ‰å¯ç”¨çš„å¤´åƒ`);
            return null;
        }

        // è·å–æŒ‡å®šè§’è‰²çš„èŠå¤©è®¾ç½® - ä½¿ç”¨IndexedDB
        async function getChatSettings(characterId) {
            try {
                const chatSettingsRecord = await db.chatSettings.get(characterId);
                if (chatSettingsRecord) {
                    return chatSettingsRecord.settings;
                }

                // å¦‚æœIndexedDBä¸­æ²¡æœ‰ï¼Œå°è¯•ä»localStorageè¿ç§»
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                if (savedSettings) {
                    console.log(`è¿ç§»è§’è‰² ${characterId} çš„èŠå¤©è®¾ç½®åˆ°IndexedDB`);
                    const settings = JSON.parse(savedSettings);

                    // ä¿å­˜åˆ°IndexedDB
                    await db.chatSettings.put({
                        id: characterId,
                        chatId: characterId,
                        settings: settings
                    });

                    return settings;
                }

                return {};
            } catch (error) {
                console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                // å›é€€åˆ°localStorage
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                return savedSettings ? JSON.parse(savedSettings) : {};
            }
        }

        // åŒæ­¥ç‰ˆæœ¬çš„getChatSettingsï¼ˆç”¨äºä¸æ”¯æŒasyncçš„åœ°æ–¹ï¼‰
        function getChatSettingsSync(characterId) {
            const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
            return savedSettings ? JSON.parse(savedSettings) : {};
        }

        // æ ¼å¼åŒ–åŠ¨æ€æ–‡å­—ï¼Œæ”¯æŒåˆ†è¡Œå’Œé…å›¾æè¿°
        function formatMomentText(text) {
            if (!text) return '';

            // æ›¿æ¢æ¢è¡Œç¬¦ä¸º<br>æ ‡ç­¾ï¼Œæ”¯æŒåˆ†è¡Œæ˜¾ç¤º
            let formattedText = text.replace(/\n/g, '<br>');

            // å¤„ç†é…å›¾æè¿°ï¼šåŒ¹é…*[é…å›¾ï¼šæè¿°]*æ ¼å¼
            formattedText = formattedText.replace(/\*\[é…å›¾ï¼š([^\]]+)\]\*/g, function(match, description) {
                return `<span style="font-style: italic; color: #999; font-size: 13px; line-height: 1.4;">[é…å›¾ï¼š${description}]</span>`;
            });

            return formattedText;
        }

        // è°ƒè¯•è§’è‰²åŠ¨æ€å¤´åƒ
        function debugMomentAvatar(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) {
                console.log('æ‰¾ä¸åˆ°åŠ¨æ€å…ƒç´ ');
                return;
            }

            // ä»IndexedDBè·å–åŠ¨æ€æ•°æ®
            db.moments.get(parseInt(momentId)).then(moment => {
                console.log('=== åŠ¨æ€å¤´åƒè°ƒè¯• ===');
                console.log('åŠ¨æ€ID:', momentId);
                console.log('è§’è‰²ID:', moment.characterId);
                console.log('ä¿å­˜çš„å¤´åƒ:', moment.avatar ? moment.avatar.substring(0, 50) + '...' : 'null');

                if (moment.characterId && moment.characterId !== 'user') {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character) {
                        console.log('æ‰¾åˆ°è§’è‰²:', character.name);
                        console.log('è§’è‰²å¡å¤´åƒ:', character.avatarUrl ? character.avatarUrl.substring(0, 50) + '...' : 'null');
                    } else {
                        console.log('æ‰¾ä¸åˆ°è§’è‰²æ•°æ®');
                    }
                }

                const avatarImg = momentElement.querySelector('.moment-avatar img');
                if (avatarImg) {
                    console.log('å½“å‰æ˜¾ç¤ºçš„å¤´åƒURL:', avatarImg.src ? avatarImg.src.substring(0, 50) + '...' : 'null');
                }
            });
        }

        // ç®€å•çš„å¤´åƒæ•°æ®ä¿®å¤
        async function fixAvatarData() {
            console.log('å¼€å§‹ä¿®å¤å¤´åƒæ•°æ®...');
            let fixedCount = 0;

            try {
                // æ¸…ç†è§’è‰²è®¾ç½®ä¸­çš„æˆªæ–­å¤´åƒ
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);
                    let needSave = false;

                    if (chatSettings.aiChatAvatar) {
                        const avatar = chatSettings.aiChatAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`æ¸…ç†${character.name}çš„èŠå¤©å¤´åƒè®¾ç½®`);
                            delete chatSettings.aiChatAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }

                    if (chatSettings.aiChatAvatar) {
                        const avatar = chatSettings.aiChatAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`æ¸…ç†${character.name}çš„èŠå¤©å¤´åƒè®¾ç½®`);
                            delete chatSettings.aiChatAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }

                    if (needSave) {
                        // ä¿å­˜åˆ°IndexedDBè€Œä¸æ˜¯localStorage
                        await db.chatSettings.put({
                            id: character.id,
                            chatId: character.id,
                            settings: chatSettings
                        });
                    }
                }

                // æ¸…ç†åŠ¨æ€æ•°æ®åº“ä¸­çš„æˆªæ–­å¤´åƒ
                const allMoments = await db.moments.toArray();
                let momentFixedCount = 0;

                for (const moment of allMoments) {
                    if (moment.avatar && moment.avatar.startsWith('data:image/')) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æˆªæ–­çš„å¤´åƒï¼ˆä»¥VNEKhsVJikç»“å°¾çš„æ˜¯æˆªæ–­çš„ï¼‰
                        if (moment.avatar.endsWith('VNEKhsVJik') || moment.avatar.endsWith('VNEKhsVJik:1') ||
                            (!moment.avatar.includes('=') && moment.avatar.split(',').length === 2)) {
                            console.log(`æ¸…ç†åŠ¨æ€ ${moment.id} çš„æˆªæ–­å¤´åƒ`);
                            await db.moments.update(moment.id, { avatar: null });
                            momentFixedCount++;
                        }
                    }
                }

                const totalFixed = fixedCount + momentFixedCount;
                console.log(`ä¿®å¤å®Œæˆ: æ¸…ç†äº†${fixedCount}ä¸ªè®¾ç½®å¤´åƒ, ${momentFixedCount}ä¸ªåŠ¨æ€å¤´åƒ`);

                alert(`ä¿®å¤å®Œæˆï¼\næ¸…ç†äº† ${fixedCount} ä¸ªè®¾ç½®ä¸­çš„æˆªæ–­å¤´åƒ\næ¸…ç†äº† ${momentFixedCount} ä¸ªåŠ¨æ€ä¸­çš„æˆªæ–­å¤´åƒ\n\nè¯·é‡æ–°ä¸ºè§’è‰²è®¾ç½®å¤´åƒ`);

                if (totalFixed > 0) {
                    loadMoments();
                }
            } catch (error) {
                console.error('ä¿®å¤å¤±è´¥:', error);
                alert('ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†åå°å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            clearAllBackgroundTimers();
            clearGlobalMomentsTimers();
        });

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•åŠ¨æ€å¯è§æ€§åŠŸèƒ½
        window.testMomentVisibility = async function() {
            try {


                // è·å–æ‰€æœ‰åŠ¨æ€
                const allMoments = await db.moments.toArray();


                // è·å–æ‰€æœ‰å¯è§æ€§è®¾ç½®
                const allVisibility = await db.momentVisibility.toArray();
                console.log(`ğŸ“Š æ€»å…±æœ‰ ${allVisibility.length} æ¡å¯è§æ€§è®¾ç½®`);

                // æµ‹è¯•æ¯ä¸ªè§’è‰²èƒ½çœ‹åˆ°çš„åŠ¨æ€
                for (const character of characters) {
                    const visibleMoments = await getVisibleMomentsForCharacter(character.id, 10);
                    console.log(`ğŸ‘¤ ${character.name} (åˆ†ç»„: ${character.groupId}) å¯ä»¥çœ‹åˆ° ${visibleMoments.length} æ¡åŠ¨æ€`);

                    visibleMoments.forEach((moment, index) => {
                        const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;
                        console.log(`  ${index + 1}. ${authorName}: ${moment.text.substring(0, 30)}...`);
                    });
                }


            } catch (error) {
                console.error('âŒ åŠ¨æ€å¯è§æ€§æµ‹è¯•å¤±è´¥:', error);
            }
        };

        // ğŸ”¥ã€è°ƒè¯•åŠŸèƒ½ã€‘æµ‹è¯•åŠ¨æ€ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ
        function debugMomentsSystem() {
            console.log('=== åŠ¨æ€ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===');
            console.log('è§’è‰²æ•°é‡:', characters ? characters.length : 0);
            console.log('å…¨å±€å®šæ—¶å™¨:', Object.keys(globalMomentsTimers));
            console.log('å®šæ—¶æ£€æŸ¥å™¨çŠ¶æ€:', globalMomentsCheckInterval ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ');

            if (characters && characters.length > 0) {
                console.log('å„è§’è‰²è®¾ç½®:');
                characters.forEach(async (character, index) => {
                    const settings = await getChatSettings(character.id);
                    console.log(`${index + 1}. ${character.name}:`, {
                        backgroundMomentsEnabled: settings.backgroundMomentsEnabled,
                        backgroundMomentsFrequency: settings.backgroundMomentsFrequency,
                        scheduledMomentsEnabled: settings.scheduledMomentsEnabled,
                        scheduledMomentsTimes: settings.scheduledMomentsTimes
                    });
                });
            }

            console.log('=========================');
        }

        // æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€
        window.debugMomentsSystem = debugMomentsSystem;


        // åŠ è½½å£çº¸ - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadWallpaper() {
            try {
                // å…ˆä»IndexedDBåŠ è½½
                const savedWallpaper = await db.wallpapers.get('main');

            if (savedWallpaper) {
                    selectedWallpaper = savedWallpaper.data;

                    if (savedWallpaper.type === 'image' && savedWallpaper.data.startsWith('data:image')) {
                    // åŠ è½½ä¸Šä¼ çš„å›¾ç‰‡
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${savedWallpaper.data})`;
                    } else if (savedWallpaper.type === 'gradient' || savedWallpaper.data.startsWith('linear-gradient')) {
                    // åŠ è½½æ¸å˜èƒŒæ™¯
                        document.querySelector('.wallpaper').style.backgroundImage = savedWallpaper.data;
                } else {
                    // åŠ è½½çº¯è‰²èƒŒæ™¯
                        document.querySelector('.wallpaper').style.backgroundColor = savedWallpaper.data;
                    document.querySelector('.wallpaper').style.backgroundImage = 'none';
                }

                document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                } else {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localWallpaper = localStorage.getItem('wallpaper');
                    const wallpaperType = localStorage.getItem('wallpaperType');

                    if (localWallpaper) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„å£çº¸æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        selectedWallpaper = localWallpaper;

                        // è¿ç§»åˆ°IndexedDB
                        await db.wallpapers.add({
                            id: 'main',
                            type: wallpaperType || 'gradient',
                            data: localWallpaper
                        });

                        if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                            document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                        } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                            document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                        } else {
                            document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                            document.querySelector('.wallpaper').style.backgroundImage = 'none';
                        }

                        document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                        document.querySelector('.wallpaper').style.backgroundPosition = 'center';

                        console.log('å£çº¸æ•°æ®è¿ç§»å®Œæˆ');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å£çº¸å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                const localWallpaper = localStorage.getItem('wallpaper');
                const wallpaperType = localStorage.getItem('wallpaperType');

                if (localWallpaper) {
                    selectedWallpaper = localWallpaper;

                    if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                    } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                        document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                    } else {
                        document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                        document.querySelector('.wallpaper').style.backgroundImage = 'none';
                    }

                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                }
            }
        }

        // åŠ è½½åº”ç”¨å›¾æ ‡ - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadAppIcons() {
            try {
                // å…ˆä»IndexedDBåŠ è½½
                const savedIcons = await db.appIcons.toArray();

                if (savedIcons.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('appIcons');
                    if (localStorageData) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„åº”ç”¨å›¾æ ‡æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localIcons = JSON.parse(localStorageData);

                        // è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼å­˜å‚¨åˆ°IndexedDB
                        const iconArray = Object.keys(localIcons).map(appId => ({
                            id: appId,
                            appId: appId,
                            iconClass: localIcons[appId]
                        }));

                        if (iconArray.length > 0) {
                            await db.appIcons.bulkAdd(iconArray);
                            console.log('åº”ç”¨å›¾æ ‡æ•°æ®è¿ç§»å®Œæˆ:', iconArray);
                        }

                        // åº”ç”¨å›¾æ ‡
                        Object.keys(localIcons).forEach(appId => {
                            const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                            if (iconElement) {
                                iconElement.className = localIcons[appId];
                            }
                        });
                    }
                } else {
                    // IndexedDBä¸­æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                    console.log('ä»IndexedDBåŠ è½½åº”ç”¨å›¾æ ‡æ•°æ®:', savedIcons);
                    savedIcons.forEach(iconData => {
                        const iconElement = document.querySelector(`.app[onclick="showApp('${iconData.appId}')"] .app-icon i`);
                        if (iconElement) {
                            iconElement.className = iconData.iconClass;
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½åº”ç”¨å›¾æ ‡å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                const localStorageData = localStorage.getItem('appIcons');
                if (localStorageData) {
                    const icons = JSON.parse(localStorageData);
                Object.keys(icons).forEach(appId => {
                    const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                    if (iconElement) {
                        iconElement.className = icons[appId];
                    }
                });
                }
            }
        }

        // åŠ è½½APIè®¾ç½® - ä½¿ç”¨IndexedDB
        async function loadApiSettings() {
            try {
                // å…ˆä»IndexedDBå°è¯•åŠ è½½
                const savedSettings = await db.apiSettings.get('main');
                if (savedSettings) {
                    apiSettings = savedSettings.settings;
                    console.log('ğŸ”§ [åº”ç”¨å¯åŠ¨] ä»IndexedDBåŠ è½½APIè®¾ç½®:', apiSettings);
                } else {
                    // å°è¯•ä»localStorageè¿ç§»
                    const localSettings = localStorage.getItem('apiSettings');
                    if (localSettings) {
                        console.log('ğŸ”§ [åº”ç”¨å¯åŠ¨] è¿ç§»APIè®¾ç½®ä»localStorageåˆ°IndexedDB');
                        apiSettings = JSON.parse(localSettings);

                        // ä¿å­˜åˆ°IndexedDB
                        await db.apiSettings.put({
                            id: 'main',
                            settings: apiSettings
                        });
                        console.log('ğŸ”§ [åº”ç”¨å¯åŠ¨] è¿ç§»å®Œæˆï¼Œå½“å‰APIè®¾ç½®:', apiSettings);
                    } else {
                        // ä½¿ç”¨é»˜è®¤è®¾ç½®
                        console.log('ğŸ”§ [åº”ç”¨å¯åŠ¨] ä½¿ç”¨é»˜è®¤APIè®¾ç½®');
                        apiSettings = {
                            type: 'gemini',
                            base: 'https://generativelanguage.googleapis.com/v1beta',
                            endpoint: '/chat/completions',
                            key: '',
                            model: 'gemini-2.0-flash-exp',
                            temperature: 0.70
                        };
                    }
                }

                // æ—§ç‰ˆæœ¬APIè®¾ç½®è¡¨å•æ›´æ–°ä»£ç å·²æ¸…ç† - ç°åœ¨ä½¿ç”¨æ–°ç‰ˆæœ¬çš„APIè®¾ç½®ç³»ç»Ÿ
            } catch (error) {
                console.error('åŠ è½½APIè®¾ç½®å¤±è´¥:', error);
                // æ—§ç‰ˆæœ¬é»˜è®¤è®¾ç½®ä»£ç å·²æ¸…ç†
            }
        }

        // ä¿å­˜åº”ç”¨å›¾æ ‡ - ä½¿ç”¨IndexedDB
        async function saveAppIcons() {
            try {
                console.log('ä¿å­˜åº”ç”¨å›¾æ ‡æ•°æ®åˆ°IndexedDB...');

                const defaultIcons = {
                    'chat-screen': 'fas fa-comment-dots',
                    'forum-screen': 'fas fa-comments',
                    'diary-book-screen': 'fas fa-book',
                    'characters-screen': 'fas fa-user-friends',
                    'shop-screen': 'fas fa-shopping-bag',
                    'settings-screen': 'fas fa-cog'
                };

                if (selectedAppIcon) {
                    defaultIcons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
                }

                // è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
                const iconArray = Object.keys(defaultIcons).map(appId => ({
                    id: appId,
                    appId: appId,
                    iconClass: defaultIcons[appId]
                }));

                // æ¸…ç©ºç°æœ‰æ•°æ®å¹¶æ’å…¥æ–°æ•°æ®
                await db.appIcons.clear();
                await db.appIcons.bulkAdd(iconArray);

                console.log('åº”ç”¨å›¾æ ‡æ•°æ®ä¿å­˜æˆåŠŸ');

                // åˆ·æ–°å›¾æ ‡æ˜¾ç¤º
                await loadAppIcons();
            } catch (error) {
                console.error('ä¿å­˜åº”ç”¨å›¾æ ‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
            const icons = {
                'chat-screen': 'fas fa-comment-dots',
                'weibo-screen': 'fab fa-weibo',
                'album-screen': 'fas fa-images',
                'characters-screen': 'fas fa-user-friends',
                'shop-screen': 'fas fa-shopping-bag',
                'settings-screen': 'fas fa-cog'
            };

            if (selectedAppIcon) {
                icons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
            }

            localStorage.setItem('appIcons', JSON.stringify(icons));
            loadAppIcons();
            }
        }

        // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
        function renderMessageList() {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸ºå¤šé€‰æ¨¡å¼åœ¨app-headerä¸­æ·»åŠ æŒ‰é’®
            const chatHeaderActions = document.querySelector('#chat-screen .chat-header-actions');
            if (isMessageListMultiSelectMode) {
                // éšè—åŸæœ‰çš„headeræŒ‰é’®
                if (chatHeaderActions) {
                    chatHeaderActions.style.display = 'none';
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¤šé€‰æŒ‰é’®ï¼Œé¿å…é‡å¤æ·»åŠ 
                let existingActions = document.querySelector('.chat-header-multiselect-actions');
                if (!existingActions) {
                    const multiselectActions = document.createElement('div');
                    multiselectActions.className = 'chat-header-multiselect-actions';
                    multiselectActions.innerHTML = `
                        <button class="multiselect-btn pin-btn" data-action="pin">
                            <i class="fas fa-thumbtack"></i>
                            <span>ç½®é¡¶</span>
                        </button>
                        <button class="multiselect-btn delete-btn" data-action="delete">
                            <i class="fas fa-trash"></i>
                            <span>åˆ é™¤</span>
                        </button>
                        <button class="multiselect-btn cancel-btn" data-action="cancel">
                            <i class="fas fa-times"></i>
                            <span>å–æ¶ˆ</span>
                        </button>
                    `;

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å†…è”onclické—®é¢˜
                    multiselectActions.onclick = function(e) {
                        const action = e.target.closest('[data-action]')?.dataset.action;
                        if (action === 'delete') {
                            deleteSelectedConversations();
                        } else if (action === 'cancel') {
                            exitMessageListMultiSelectMode();
                        } else if (action === 'pin') {
                            pinSelectedConversations();
                        }
                    };

                    // ğŸ”¥ã€ä¿®æ”¹ã€‘å°†æŒ‰é’®æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨é¡µé¢çš„app-headerä¸­
                    const chatAppHeader = document.querySelector('#chat-screen .app-header');
                    if (chatAppHeader) {
                        chatAppHeader.appendChild(multiselectActions);
                    }
                }
            } else {
                // ğŸ”¥ã€æ–°å¢ã€‘éå¤šé€‰æ¨¡å¼æ—¶æ¢å¤åŸæœ‰æŒ‰é’®ï¼Œç§»é™¤å¤šé€‰æŒ‰é’®
                if (chatHeaderActions) {
                    chatHeaderActions.style.display = 'flex';
                }
                const existingActions = document.querySelector('.chat-header-multiselect-actions');
                if (existingActions) {
                    existingActions.remove();
                }
            }

            // ğŸ”¥ã€æµè§ˆå™¨å…¼å®¹æ€§ä¿®å¤ã€‘å¢å¼ºå¯¹ contacts åˆ—è¡¨çš„å®¹é”™å¤„ç†
            console.log('ğŸ” renderMessageList æ•°æ®æ£€æŸ¥:', {
                charactersCount: characters.length,
                contactsCount: contacts.length,
                contactsArray: contacts,
                chatMessagesKeys: Object.keys(chatMessages).length
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘æ™ºèƒ½å¤„ç† contacts ä¸ºç©ºçš„æƒ…å†µ
            if (contacts.length === 0 && characters.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡åŠ è½½ï¼ˆæ²¡æœ‰ä»»ä½•èŠå¤©è®°å½•ï¼‰è¿˜æ˜¯ç”¨æˆ·åˆ é™¤äº†æ‰€æœ‰å¯¹è¯
                const hasAnyChatMessages = Object.keys(chatMessages).length > 0;

                if (hasAnyChatMessages) {
                    // å¦‚æœæœ‰èŠå¤©è®°å½•ä½†æ²¡æœ‰è”ç³»äººï¼Œè¯´æ˜å¯èƒ½æ˜¯æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®å¤
                    console.warn('âš ï¸ æ£€æµ‹åˆ°æœ‰èŠå¤©è®°å½•ä½†æ— è”ç³»äººï¼Œå¯èƒ½æ˜¯æ•°æ®ä¸ä¸€è‡´ï¼Œå°è¯•ä»èŠå¤©è®°å½•æ¢å¤è”ç³»äºº');
                    const chatCharacterIds = Object.keys(chatMessages);
                    const validContacts = chatCharacterIds.filter(id =>
                        characters.some(char => char.id === id)
                    );
                    if (validContacts.length > 0) {
                        contacts = validContacts;
                        saveContacts().catch(err => console.error('ä¿å­˜è”ç³»äººå¤±è´¥:', err));
                        console.log(`ğŸ”§ ä»èŠå¤©è®°å½•æ¢å¤äº† ${validContacts.length} ä¸ªè”ç³»äºº`);
                    }
                } else {
                    // å¦‚æœæ—¢æ²¡æœ‰è”ç³»äººä¹Ÿæ²¡æœ‰èŠå¤©è®°å½•ï¼Œè¿™æ˜¯æ­£å¸¸çš„åˆå§‹çŠ¶æ€
                    console.log('âœ… åˆå§‹çŠ¶æ€ï¼šæ— è”ç³»äººæ— èŠå¤©è®°å½•ï¼Œè¿™æ˜¯æ­£å¸¸çš„');
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘åªæ¸²æŸ“å­˜åœ¨äº contacts åˆ—è¡¨ä¸­çš„å•äººå¯¹è¯ï¼Œå¢åŠ å®¹é”™
            const singleChats = characters.filter(character => {
                if (!character || !character.id) return false;
                return contacts.includes(character.id);
            });

            const sortedSingleChats = singleChats.sort((a, b) => {
                const aPinned = isPinned(a.id);
                const bPinned = isPinned(b.id);
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                // ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´çš„æ’åºé€»è¾‘
                return 0;
            });

            sortedSingleChats.forEach(character => {
                // ç›´æ¥ä½¿ç”¨è§’è‰²å¯¹è±¡ï¼Œä¸éœ€è¦å†æŸ¥æ‰¾
                if (character) {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€çš„è®¾ç½®è·å–æ–¹å¼ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
                    const chatSettings = window.chatSettings && window.chatSettings[character.id] ?
                        window.chatSettings[character.id] : {};
                    const displayName = chatSettings.aiChatNickname || character.name;

                    const messages = chatMessages[character.id] || [];
                    // ğŸ”¥ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰æ¸¸æˆæ¶ˆæ¯ï¼Œåªæ˜¾ç¤ºæ­£å¸¸èŠå¤©æ¶ˆæ¯
                    const normalMessages = messages.filter(msg => !msg.isGameMessage && !msg.isGameContext && !msg.isOfflineMode);
                let lastMessageRaw = 'æš‚æ— æ¶ˆæ¯';

                if (normalMessages.length > 0) {
                    const lastMsg = normalMessages[normalMessages.length - 1];

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢undefinedé”™è¯¯
                    if (!lastMsg) {
                        lastMessageRaw = 'æš‚æ— æ¶ˆæ¯';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ç…§ç‰‡]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[å›¾ç‰‡]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[è¯­éŸ³]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[è½¬è´¦]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[ä½ç½®]';
                    } else if (lastMsg.type === 'call_message') {
                        lastMessageRaw = '[é€šè¯æ¶ˆæ¯]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[ç³»ç»Ÿæ¶ˆæ¯]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[è¡¨æƒ…]';
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¯¹è±¡ç±»å‹çš„content
                        if (typeof lastMsg.content === 'string') {
                            lastMessageRaw = lastMsg.content;
                        } else if (Array.isArray(lastMsg.content)) {
                            // å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œæå–æ–‡æœ¬éƒ¨åˆ†
                            const textPart = lastMsg.content.find(part => part.type === 'text');
                            lastMessageRaw = textPart ? textPart.text : '[å¤šåª’ä½“æ¶ˆæ¯]';
                        } else if (typeof lastMsg.content === 'object' && lastMsg.content !== null) {
                            // å¯¹è±¡ç±»å‹çš„contentï¼Œå°è¯•æå–æœ‰ç”¨ä¿¡æ¯
                            if (lastMsg.content.text) {
                                lastMessageRaw = lastMsg.content.text;
                            } else if (lastMsg.content.content) {
                                lastMessageRaw = lastMsg.content.content;
                            } else {
                                lastMessageRaw = '[ç‰¹æ®Šæ¶ˆæ¯]';
                            }
                        } else {
                            lastMessageRaw = lastMsg.content || '';
                        }
                    }
                }

                const lastMessage = truncateText(String(lastMessageRaw || 'æš‚æ— æ¶ˆæ¯'), 30);
                    const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'åˆšåˆš';

                    const messageItem = document.createElement('div');
                    const isPinnedConversation = isPinned(character.id);
                    messageItem.className = `message-item ${isPinnedConversation ? 'pinned' : ''} ${isMessageListMultiSelectMode && selectedConversations.includes(character.id) ? 'selected' : ''}`;
                    messageItem.dataset.conversationId = character.id; // æ·»åŠ å¯¹è¯ID

                    // æ ¹æ®æ¨¡å¼è®¾ç½®ä¸åŒçš„ç‚¹å‡»äº‹ä»¶
                    if (isMessageListMultiSelectMode) {
                        messageItem.onclick = () => toggleConversationSelection(character.id);
                    } else {
                        // ä½¿ç”¨å˜é‡æ¥æ§åˆ¶ç‚¹å‡»è¡Œä¸º
                        let isLongPress = false;

                        messageItem.onclick = (e) => {
                            if (!isLongPress) {
                                startChat(character);
                            }
                            isLongPress = false; // é‡ç½®æ ‡å¿—
                        };

                        // æ·»åŠ é•¿æŒ‰äº‹ä»¶ï¼ˆæ”¯æŒç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰
                        let pressTimer;

                        // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                        messageItem.addEventListener('touchstart', (e) => {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            pressTimer = setTimeout(() => {
                                console.log('è§¦æ‘¸é•¿æŒ‰è§¦å‘ï¼Œè§’è‰²ID:', character.id);
                                isLongPress = true; // è®¾ç½®é•¿æŒ‰æ ‡å¿—
                                enterMessageListMultiSelectMode(character.id);
                                e.preventDefault();
                            }, 800); // 800msé•¿æŒ‰
                        });

                        messageItem.addEventListener('touchend', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });

                        messageItem.addEventListener('touchmove', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });

                        // æ¡Œé¢ç«¯é¼ æ ‡äº‹ä»¶
                        messageItem.addEventListener('mousedown', (e) => {
                            if (e.button === 0) { // å·¦é”®
                                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                                pressTimer = setTimeout(() => {
                                    console.log('é¼ æ ‡é•¿æŒ‰è§¦å‘ï¼Œè§’è‰²ID:', character.id);
                                    isLongPress = true; // è®¾ç½®é•¿æŒ‰æ ‡å¿—
                                    enterMessageListMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800msé•¿æŒ‰
                            }
                        });

                        messageItem.addEventListener('mouseup', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });

                        messageItem.addEventListener('mouseleave', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });

                        // å³é”®ç‚¹å‡»è¿›å…¥å¤šé€‰æ¨¡å¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
                        messageItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            enterMessageListMultiSelectMode(character.id);
                        });
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶ç”ŸæˆçŠ¶æ€æŒ‡ç¤ºå™¨
                    let messageStatusIndicator = '';
                    if (character.isGroup === true) {
                        // ç¾¤èŠæ£€æŸ¥å±è”½çŠ¶æ€
                        const isMuted = isGroupMuted(character.id);
                        if (isMuted) {
                            messageStatusIndicator = '<div class="message-status-indicator muted" title="å·²å±è”½"><i class="fas fa-volume-mute"></i></div>';
                        }
                    } else {
                        // å•èŠæ£€æŸ¥æ‹‰é»‘çŠ¶æ€
                        const isUserBlocked = isBlocked('user', character.id);
                        const isCharacterBlocked = isBlocked(character.id, 'user');

                        if (isUserBlocked) {
                            messageStatusIndicator = '<div class="message-status-indicator blocked" title="å·²æ‹‰é»‘"><i class="fas fa-ban"></i></div>';
                        } else if (isCharacterBlocked) {
                            messageStatusIndicator = '<div class="message-status-indicator blocked-by" title="è¢«å¯¹æ–¹æ‹‰é»‘"><i class="fas fa-exclamation-triangle"></i></div>';
                        }
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°é‡å¹¶ç”Ÿæˆæœªè¯»æç¤º
                    let unreadBadge = '';
                    const unreadCount = getUnreadCount(character.id);
                    if (unreadCount > 0) {
                        const displayCount = unreadCount > 99 ? '99+' : unreadCount.toString();
                        const badgeClass = unreadCount > 99 ? 'unread-badge large-count' : 'unread-badge';
                        unreadBadge = `<div class="${badgeClass}" title="${unreadCount}æ¡æœªè¯»æ¶ˆæ¯">${displayCount}</div>`;
                    }

                    messageItem.innerHTML = `
                        ${isPinnedConversation ? '<div class="pin-indicator"><i class="fas fa-thumbtack"></i></div>' : ''}
                        ${isMessageListMultiSelectMode ? `
                            <div class="selection-checkbox ${selectedConversations.includes(character.id) ? 'selected' : ''}">
                                ${selectedConversations.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                            </div>
                        ` : ''}
                        <div class="message-avatar-container">
                            <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${character.avatarUrl ? '' : displayName.charAt(0)}
                            </div>
                            ${unreadBadge}
                            ${messageStatusIndicator}
                        </div>
                        <div class="message-content">
                            <div class="message-name">${displayName}</div>
                            <div class="message-preview">${lastMessage}</div>
                        </div>
                        <div class="message-time">${lastTime}</div>
                    `;

                    messageList.appendChild(messageItem);

                    // ğŸ”¥ã€æ–°å¢ã€‘è®¾ç½®ç½®é¡¶å¯¹è¯æ ·å¼ - æµ…ç°è‰²èƒŒæ™¯ï¼Œå»æ‰è“è‰²è¾¹æ¡†
                    if (isPinnedConversation) {
                        messageItem.style.background = 'rgba(0, 0, 0, 0.05)';
                        messageItem.style.borderLeft = 'none';
                    }
                }
            });

            // ğŸ”¥ã€ä¿®æ”¹ã€‘æ¸²æŸ“ç¾¤èŠ - æ”¯æŒç½®é¡¶æ’åº
            const sortedGroups = [...groupChats].sort((a, b) => {
                const aPinned = isPinned(a.id);
                const bPinned = isPinned(b.id);
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                return 0;
            });

            sortedGroups.forEach(group => {
                const messages = chatMessages[group.id] || [];
                let lastMessageRaw = 'æš‚æ— æ¶ˆæ¯';

                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢undefinedé”™è¯¯
                    if (!lastMsg) {
                        lastMessageRaw = 'æš‚æ— æ¶ˆæ¯';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ç…§ç‰‡]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[å›¾ç‰‡]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[è¯­éŸ³]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[è½¬è´¦]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[ä½ç½®]';
                    } else if (lastMsg.type === 'call_message') {
                        lastMessageRaw = '[é€šè¯æ¶ˆæ¯]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[ç³»ç»Ÿæ¶ˆæ¯]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[è¡¨æƒ…]';
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¯¹è±¡ç±»å‹çš„contentï¼ˆç¾¤èŠç‰ˆæœ¬ï¼‰
                        if (typeof lastMsg.content === 'string') {
                            lastMessageRaw = lastMsg.content;
                        } else if (Array.isArray(lastMsg.content)) {
                            // å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œæå–æ–‡æœ¬éƒ¨åˆ†
                            const textPart = lastMsg.content.find(part => part.type === 'text');
                            lastMessageRaw = textPart ? textPart.text : '[å¤šåª’ä½“æ¶ˆæ¯]';
                        } else if (typeof lastMsg.content === 'object' && lastMsg.content !== null) {
                            // å¯¹è±¡ç±»å‹çš„contentï¼Œå°è¯•æå–æœ‰ç”¨ä¿¡æ¯
                            if (lastMsg.content.text) {
                                lastMessageRaw = lastMsg.content.text;
                            } else if (lastMsg.content.content) {
                                lastMessageRaw = lastMsg.content.content;
                            } else {
                                lastMessageRaw = '[ç‰¹æ®Šæ¶ˆæ¯]';
                            }
                        } else {
                            lastMessageRaw = lastMsg.content || '';
                        }
                    }
                }

                const lastMessage = truncateText(String(lastMessageRaw || 'æš‚æ— æ¶ˆæ¯'), 30);
                const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'åˆšåˆš';

                const messageItem = document.createElement('div');
                const isGroupPinned = isPinned(group.id);
                messageItem.className = `message-item ${isGroupPinned ? 'pinned' : ''} ${isMessageListMultiSelectMode && selectedConversations.includes(group.id) ? 'selected' : ''}`;
                messageItem.dataset.conversationId = group.id; // æ·»åŠ å¯¹è¯ID

                // æ ¹æ®æ¨¡å¼è®¾ç½®ä¸åŒçš„ç‚¹å‡»äº‹ä»¶
                if (isMessageListMultiSelectMode) {
                    messageItem.onclick = () => toggleConversationSelection(group.id);
                } else {
                messageItem.onclick = () => startChat(group);

                    // æ·»åŠ é•¿æŒ‰äº‹ä»¶ï¼ˆæ”¯æŒç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰
                    let pressTimer;

                    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                    messageItem.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        pressTimer = setTimeout(() => {
                            console.log('è§¦æ‘¸é•¿æŒ‰è§¦å‘ï¼Œç¾¤èŠID:', group.id);
                            enterMessageListMultiSelectMode(group.id);
                            e.preventDefault();
                        }, 800); // 800msé•¿æŒ‰
                    });

                    messageItem.addEventListener('touchend', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });

                    messageItem.addEventListener('touchmove', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });

                    // æ¡Œé¢ç«¯é¼ æ ‡äº‹ä»¶
                    messageItem.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // å·¦é”®
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            pressTimer = setTimeout(() => {
                                console.log('é¼ æ ‡é•¿æŒ‰è§¦å‘ï¼Œç¾¤èŠID:', group.id);
                                enterMessageListMultiSelectMode(group.id);
                                e.preventDefault();
                            }, 800); // 800msé•¿æŒ‰
                        }
                    });

                    messageItem.addEventListener('mouseup', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });

                    messageItem.addEventListener('mouseleave', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });

                    // å³é”®ç‚¹å‡»è¿›å…¥å¤šé€‰æ¨¡å¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
                    messageItem.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        enterMessageListMultiSelectMode(group.id);
                    });
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ç¾¤èŠå±è”½çŠ¶æ€
                let groupStatusIndicator = '';
                const isMuted = isGroupMuted(group.id);
                if (isMuted) {
                    groupStatusIndicator = '<div class="message-status-indicator muted" title="å·²å±è”½"><i class="fas fa-volume-mute"></i></div>';
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ç¾¤èŠæœªè¯»æ¶ˆæ¯æ•°é‡
                let groupUnreadBadge = '';
                const groupUnreadCount = getUnreadCount(group.id);
                if (groupUnreadCount > 0) {
                    const displayCount = groupUnreadCount > 99 ? '99+' : groupUnreadCount.toString();
                    const badgeClass = groupUnreadCount > 99 ? 'unread-badge large-count' : 'unread-badge';
                    groupUnreadBadge = `<div class="${badgeClass}" title="${groupUnreadCount}æ¡æœªè¯»æ¶ˆæ¯">${displayCount}</div>`;
                }

                messageItem.innerHTML = `
                    ${isGroupPinned ? '<div class="pin-indicator"><i class="fas fa-thumbtack"></i></div>' : ''}
                    ${isMessageListMultiSelectMode ? `
                        <div class="selection-checkbox ${selectedConversations.includes(group.id) ? 'selected' : ''}">
                            ${selectedConversations.includes(group.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                        </div>
                    ` : ''}
                    <div class="message-avatar-container">
                        <div class="message-avatar" style="${group.avatarUrl ? `background-image: url(${group.avatarUrl}); background-size: cover; background-position: center;` : 'background-color: #4CAF50;'}">
                            ${group.avatarUrl ? '' : 'ç¾¤'}
                        </div>
                        ${groupUnreadBadge}
                        ${groupStatusIndicator}
                    </div>
                    <div class="message-content">
                                                        <div class="message-name">${group.name} <span class="group-member-count">(${group.members ? group.members.length + 1 : 1}äºº)</span></div>
                        <div class="message-preview">${lastMessage}</div>
                    </div>
                    <div class="message-time">${lastTime}</div>
                `;

                messageList.appendChild(messageItem);

                // ğŸ”¥ã€æ–°å¢ã€‘è®¾ç½®ç¾¤èŠç½®é¡¶æ ·å¼ - æµ…ç°è‰²èƒŒæ™¯ï¼Œå»æ‰è“è‰²è¾¹æ¡†
                if (isGroupPinned) {
                    messageItem.style.background = 'rgba(0, 0, 0, 0.05)';
                    messageItem.style.borderLeft = 'none';
                }
            });

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸²æŸ“å®Œæˆåï¼Œä¸ºäº†æµ‹è¯•ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ä¸€äº›æœªè¯»æ¶ˆæ¯
            // è¿™ä¸ªä»£ç ä»…ç”¨äºæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥åˆ é™¤
            if (window.location.hash === '#test-unread') {
                // ä¸º"ä¸€å·"è§’è‰²è®¾ç½®ä¸€äº›æœªè¯»æ¶ˆæ¯ç”¨äºæµ‹è¯•
                const testCharacter = characters.find(c => c.name === 'ä¸€å·');
                if (testCharacter) {
                    const oneHourAgo = Date.now() - 60 * 60 * 1000;
                    localStorage.setItem(`lastRead_${testCharacter.id}`, oneHourAgo.toString());
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡
        function getUnreadCount(characterId) {
            const messages = chatMessages[characterId] || [];
            const lastReadTime = localStorage.getItem(`lastRead_${characterId}`);

            if (!lastReadTime) {
                // å¦‚æœæ²¡æœ‰è®°å½•æœ€åé˜…è¯»æ—¶é—´ï¼Œè®¤ä¸ºæ‰€æœ‰æ¶ˆæ¯éƒ½å·²è¯»
                return 0;
            }

            const lastReadTimestamp = parseInt(lastReadTime);
            const unreadMessages = messages.filter(msg =>
                msg.timestamp > lastReadTimestamp && msg.sender !== 'user'
            );

            return unreadMessages.length;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
        function markAsRead(characterId) {
            const now = Date.now();
            localStorage.setItem(`lastRead_${characterId}`, now.toString());
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç½®é¡¶ç›¸å…³å‡½æ•°
        function loadPinnedConversations() {
            const saved = localStorage.getItem('pinnedConversations');
            pinnedConversations = saved ? JSON.parse(saved) : [];
        }

        function savePinnedConversations() {
            localStorage.setItem('pinnedConversations', JSON.stringify(pinnedConversations));
        }

        function togglePinConversation(conversationId) {
            const index = pinnedConversations.indexOf(conversationId);
            if (index > -1) {
                pinnedConversations.splice(index, 1);
            } else {
                pinnedConversations.push(conversationId);
            }
            savePinnedConversations();
        }

        function isPinned(conversationId) {
            return pinnedConversations.includes(conversationId);
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ç½®é¡¶é€‰ä¸­çš„å¯¹è¯ - æ”¯æŒé‡æ–°è®¾ç½®ç½®é¡¶
        async function pinSelectedConversations() {
            // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°è®¾ç½®ç½®é¡¶é€»è¾‘ï¼šæ¸…ç©ºç°æœ‰ç½®é¡¶ï¼Œåªç½®é¡¶å½“å‰é€‰ä¸­çš„å¯¹è¯
            pinnedConversations = [...selectedConversations];

            savePinnedConversations();
            renderMessageList();
            exitMessageListMultiSelectMode();

            const count = selectedConversations.length;
            showToast(`å·²é‡æ–°è®¾ç½®ç½®é¡¶ï¼Œå½“å‰ç½®é¡¶ ${count} ä¸ªå¯¹è¯`, 'success');
        }

        // æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼ˆè§’è‰²é¡µé¢ï¼‰- æŒ‰åˆ†ç»„æ˜¾ç¤º
        function renderContactList() {
            const contactList = document.querySelector('#contact-list .contact-section');
            if (!contactList) return;

            // æ¸…ç©ºæ‰€æœ‰å†…å®¹
            contactList.innerHTML = '';



            // æ·»åŠ å¤šé€‰æ¨¡å¼çš„å¤´éƒ¨
            if (isMultiSelectMode) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'multiselect-header';
                headerDiv.innerHTML = `
                    <div class="multiselect-info">
                        <i class="fas fa-check-circle multiselect-icon"></i>
                        <span class="multiselect-text">å·²é€‰æ‹© ${selectedCharacters.length} ä¸ªè§’è‰²</span>
                    </div>
                    <div class="multiselect-actions">
                        <button onclick="showMoveToGroupModal()" class="multiselect-btn move-btn" title="ç§»åŠ¨åˆ°åˆ†ç»„">
                            <i class="fas fa-folder"></i>
                            <span>ç§»åŠ¨</span>
                        </button>
                        <button onclick="deleteSelectedCharacters()" class="multiselect-btn delete-btn" title="åˆ é™¤é€‰ä¸­è§’è‰²">
                            <i class="fas fa-trash"></i>
                            <span>åˆ é™¤</span>
                        </button>
                        <button onclick="exitMultiSelectMode()" class="multiselect-btn cancel-btn" title="å–æ¶ˆå¤šé€‰">
                            <i class="fas fa-times"></i>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                `;
                contactList.appendChild(headerDiv);
            }

            // åˆ†ç»„ç®¡ç†æ¨¡å¼çš„å¤´éƒ¨
            if (isGroupManageMode) {
                const manageHeaderDiv = document.createElement('div');
                manageHeaderDiv.className = 'group-manage-header';
                manageHeaderDiv.innerHTML = `
                    <div class="group-manage-info">
                        <i class="fas fa-cogs group-manage-icon"></i>
                        <span class="group-manage-text">åˆ†ç»„ç®¡ç†æ¨¡å¼</span>
                    </div>
                    <div class="group-manage-actions">
                        <button onclick="showCreateGroupModal()" class="multiselect-btn create-btn" title="æ–°å»ºåˆ†ç»„">
                            <i class="fas fa-plus"></i>
                            <span>æ–°å»º</span>
                        </button>
                        <button onclick="exitGroupManageMode()" class="multiselect-btn done-btn" title="å®Œæˆç®¡ç†">
                            <i class="fas fa-check"></i>
                            <span>å®Œæˆ</span>
                        </button>
                    </div>
                `;
                contactList.appendChild(manageHeaderDiv);
            }

            // æŒ‰åˆ†ç»„æ¸²æŸ“è§’è‰²
            const sortedGroups = characterGroups.sort((a, b) => a.order - b.order);

            sortedGroups.forEach(group => {
                const groupCharacters = characters.filter(char => char.groupId === group.id);

                // å¦‚æœè¯¥åˆ†ç»„æ²¡æœ‰è§’è‰²ä¸”ä¸æ˜¯åˆ†ç»„ç®¡ç†æ¨¡å¼ï¼Œè·³è¿‡æ˜¾ç¤º
                if (groupCharacters.length === 0 && !isGroupManageMode) return;

                // åˆ›å»ºåˆ†ç»„æ ‡é¢˜
                const groupHeader = document.createElement('div');
                groupHeader.className = `group-header ${group.isDefault ? 'default-group' : 'custom-group'}`;

                let interactionIcon = '';
                if (group.canInteract && !group.isDefault) {
                    interactionIcon = '<i class="fas fa-comments group-interaction-icon" title="è¯¥åˆ†ç»„è§’è‰²å¯ä»¥åœ¨åŠ¨æ€ä¸­äº’åŠ¨"></i>';
                }

                if (isGroupManageMode) {
                    groupHeader.innerHTML = `
                        <div class="group-title-area">
                            <span class="group-title">${group.name} (${groupCharacters.length})</span>
                            ${interactionIcon}
                            <span class="group-count"></span>
                        </div>
                        <div class="group-manage-actions">
                            ${!group.isDefault ? `
                                <button onclick="editGroup('${group.id}')" class="edit-group-btn" title="ç¼–è¾‘åˆ†ç»„">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteGroup('${group.id}')" class="delete-group-btn" title="åˆ é™¤åˆ†ç»„">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                } else {
                    const isCollapsed = localStorage.getItem(`group_collapsed_${group.id}`) === 'true';
                    groupHeader.innerHTML = `
                        <div class="group-title-area" onclick="toggleGroupCollapse('${group.id}')">
                            <i class="fas fa-chevron-${isCollapsed ? 'right' : 'down'} group-chevron"></i>
                            <span class="group-title">${group.name}</span>
                            ${interactionIcon}
                            <span class="group-count">${groupCharacters.length}/${groupCharacters.length}</span>
                        </div>
                    `;
                }

                contactList.appendChild(groupHeader);

                // åˆ›å»ºè§’è‰²å®¹å™¨
                const charactersContainer = document.createElement('div');
                charactersContainer.className = 'group-characters';
                charactersContainer.id = `group-characters-${group.id}`;

                // æ£€æŸ¥æ˜¯å¦æŠ˜å 
                const isCollapsed = localStorage.getItem(`group_collapsed_${group.id}`) === 'true';
                if (isCollapsed && !isGroupManageMode) {
                    charactersContainer.style.display = 'none';
                }

                // æ¸²æŸ“åˆ†ç»„ä¸­çš„è§’è‰²
                groupCharacters.forEach(character => {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€çš„è®¾ç½®è·å–æ–¹å¼ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
                    const chatSettings = window.chatSettings && window.chatSettings[character.id] ?
                        window.chatSettings[character.id] : {};
                    const displayName = chatSettings.aiChatNickname || character.name;

                    // è·å–å¤´åƒå½¢çŠ¶è®¾ç½®
                    const avatarShape = chatSettings.avatarShape || 'circle';
                    const shapeClass = avatarShape === 'rounded-square' ? ' rounded-square' : '';

                    const contactItem = document.createElement('div');
                    contactItem.className = `contact-item ${isMultiSelectMode && selectedCharacters.includes(character.id) ? 'selected' : ''}`;
                    contactItem.dataset.characterId = character.id;

                    // æ ¹æ®æ¨¡å¼è®¾ç½®ä¸åŒçš„ç‚¹å‡»äº‹ä»¶
                    if (isMultiSelectMode) {
                        contactItem.onclick = () => toggleCharacterSelection(character.id);
                    } else {
                        contactItem.onclick = () => editCharacterFromContactList(character.id);

                        // æ·»åŠ é•¿æŒ‰äº‹ä»¶ï¼ˆæ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡ï¼‰
                        let pressTimer;

                        const startLongPress = (e) => {
                            pressTimer = setTimeout(() => {
                                // é•¿æŒ‰ç›´æ¥å¼¹å‡ºç§»åŠ¨è§’è‰²æ¨¡æ€æ¡†
                                showMoveCharacterModal(character.id);
                                e.preventDefault();
                            }, 800);
                        };

                        const cancelLongPress = () => {
                            clearTimeout(pressTimer);
                        };

                        // è§¦æ‘¸äº‹ä»¶
                        contactItem.addEventListener('touchstart', startLongPress);
                        contactItem.addEventListener('touchend', cancelLongPress);
                        contactItem.addEventListener('touchmove', cancelLongPress);

                        // é¼ æ ‡äº‹ä»¶ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                        contactItem.addEventListener('mousedown', startLongPress);
                        contactItem.addEventListener('mouseup', cancelLongPress);
                        contactItem.addEventListener('mouseleave', cancelLongPress);

                        // å³é”®ç‚¹å‡»
                        contactItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            // å³é”®ç›´æ¥å¼¹å‡ºç§»åŠ¨è§’è‰²æ¨¡æ€æ¡†
                            showMoveCharacterModal(character.id);
                        });
                    }

                    // ğŸ”¥ã€ä¿®æ”¹ã€‘æ£€æŸ¥æ‹‰é»‘/å±è”½çŠ¶æ€ - ä¿®å¤ç¾¤èŠåˆ¤æ–­é€»è¾‘ + æ·»åŠ è°ƒè¯•
                    let statusIndicator = '';
                    if (character.isGroup === true) {
                        // ç¾¤èŠæ£€æŸ¥å±è”½çŠ¶æ€
                        const isMuted = isGroupMuted(character.id);
                        if (isMuted) {
                            statusIndicator = '<div class="contact-status-indicator muted" title="å·²å±è”½"><i class="fas fa-volume-mute"></i></div>';
                        }
                    } else {
                        // å•èŠæ£€æŸ¥æ‹‰é»‘çŠ¶æ€
                        const isUserBlocked = isBlocked('user', character.id);
                        const isCharacterBlocked = isBlocked(character.id, 'user');



                        if (isUserBlocked) {
                            statusIndicator = '<div class="contact-status-indicator blocked" title="å·²æ‹‰é»‘"><i class="fas fa-ban"></i></div>';
                        } else if (isCharacterBlocked) {
                            statusIndicator = '<div class="contact-status-indicator blocked-by" title="è¢«å¯¹æ–¹æ‹‰é»‘"><i class="fas fa-exclamation-triangle"></i></div>';
                        }
                    }

                    contactItem.innerHTML = `
                        ${isMultiSelectMode ? `
                            <div class="selection-checkbox ${selectedCharacters.includes(character.id) ? 'selected' : ''}">
                                ${selectedCharacters.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                            </div>
                        ` : ''}
                        <div class="message-avatar${shapeClass}" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="contact-info">
                            <div class="message-name">${displayName}</div>
                            <div class="character-preview">${truncateText(character.bio || 'æš‚æ— äººè®¾æè¿°', 25)}</div>
                        </div>
                        ${statusIndicator}
                        ${isGroupManageMode ? `
                            <div class="move-character-btn" onclick="showMoveCharacterModal('${character.id}')" title="ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç»„">
                                <i class="fas fa-arrows-alt"></i>
                            </div>
                        ` : ''}
                    `;

                    charactersContainer.appendChild(contactItem);
                });

                // å¦‚æœåˆ†ç»„æ²¡æœ‰è§’è‰²ï¼Œæ˜¾ç¤ºæç¤º
                if (groupCharacters.length === 0 && isGroupManageMode) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-group-message';
                    emptyDiv.textContent = 'è¯¥åˆ†ç»„æš‚æ— è§’è‰²';
                    charactersContainer.appendChild(emptyDiv);
                }

                contactList.appendChild(charactersContainer);
            });

            // å¦‚æœå®Œå…¨æ²¡æœ‰è§’è‰²ï¼Œæ˜¾ç¤ºæç¤º
            if (characters.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-message';
                emptyDiv.textContent = 'è¿˜æ²¡æœ‰è§’è‰²ï¼Œç‚¹å‡»å³ä¸Šè§’+å·åˆ›å»ºè§’è‰²å§ï¼';
                contactList.appendChild(emptyDiv);
            }
        }

        // === åˆ†ç»„ç®¡ç†ç›¸å…³å‡½æ•° ===
        function enterGroupManageMode() {
            isGroupManageMode = true;
            renderContactList();

            // éšè—ç®¡ç†åˆ†ç»„æŒ‰é’®
            const groupManageBtn = document.getElementById('group-manage-btn');
            if (groupManageBtn) {
                groupManageBtn.style.display = 'none';
            }
        }

        function exitGroupManageMode() {
            isGroupManageMode = false;
            renderContactList();

            // æ˜¾ç¤ºç®¡ç†åˆ†ç»„æŒ‰é’®
            const groupManageBtn = document.getElementById('group-manage-btn');
            if (groupManageBtn) {
                groupManageBtn.style.display = 'flex';
            }
        }

        function toggleGroupCollapse(groupId) {
            const container = document.getElementById(`group-characters-${groupId}`);
            if (!container) return;

            const isCollapsed = container.style.display === 'none';
            container.style.display = isCollapsed ? 'block' : 'none';

            // ä¿å­˜æŠ˜å çŠ¶æ€
            localStorage.setItem(`group_collapsed_${groupId}`, !isCollapsed);

            // æ›´æ–°ç®­å¤´æ–¹å‘
            const chevron = document.querySelector(`[onclick="toggleGroupCollapse('${groupId}')"] .group-chevron`);
            if (chevron) {
                chevron.className = `fas fa-chevron-${isCollapsed ? 'down' : 'right'} group-chevron`;
            }
        }

        function showCreateGroupModal() {
            const modalHtml = `
                <div id="create-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">æ–°å»ºåˆ†ç»„</div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>åˆ†ç»„åç§°</label>
                                <input type="text" id="new-group-name" class="form-input" placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="new-group-interaction" class="form-checkbox">
                                    å…è®¸è¯¥åˆ†ç»„è§’è‰²åœ¨åŠ¨æ€ä¸­äº’åŠ¨
                                </label>
                                <p class="form-help-text">å¼€å¯åï¼Œè¯¥åˆ†ç»„çš„è§’è‰²å¯ä»¥åœ¨åŠ¨æ€é¡µé¢ç›¸äº’ç‚¹èµã€è¯„è®º</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideCreateGroupModal()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="createNewGroup()">åˆ›å»º</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('new-group-name').focus();
            }, 100);
        }

        function hideCreateGroupModal() {
            const modal = document.getElementById('create-group-modal');
            if (modal) modal.remove();
        }

        async function createNewGroup() {
            const nameInput = document.getElementById('new-group-name');
            const interactionCheckbox = document.getElementById('new-group-interaction');

            const name = nameInput.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                nameInput.focus();
                return;
            }

            // æ£€æŸ¥é‡å
            if (characterGroups.find(g => g.name === name)) {
                alert('åˆ†ç»„åç§°å·²å­˜åœ¨');
                nameInput.focus();
                return;
            }

            const newGroup = {
                id: 'group_' + Date.now(),
                name: name,
                order: characterGroups.length + 1,
                isDefault: false,
                canInteract: interactionCheckbox.checked
            };

            characterGroups.push(newGroup);
            await saveCharacterGroups();

            hideCreateGroupModal();
            renderContactList();
            showToast('åˆ†ç»„åˆ›å»ºæˆåŠŸ', 'success');
        }

        function editGroup(groupId) {
            const group = characterGroups.find(g => g.id === groupId);
            if (!group || group.isDefault) return;

            const modalHtml = `
                <div id="edit-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ç¼–è¾‘åˆ†ç»„</div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>åˆ†ç»„åç§°</label>
                                <input type="text" id="edit-group-name" class="form-input" value="${group.name}" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="edit-group-interaction" class="form-checkbox" ${group.canInteract ? 'checked' : ''}>
                                    å…è®¸è¯¥åˆ†ç»„è§’è‰²åœ¨åŠ¨æ€ä¸­äº’åŠ¨
                                </label>
                                <p class="form-help-text">å¼€å¯åï¼Œè¯¥åˆ†ç»„çš„è§’è‰²å¯ä»¥åœ¨åŠ¨æ€é¡µé¢ç›¸äº’ç‚¹èµã€è¯„è®º</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideEditGroupModal()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="updateGroup('${groupId}')">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('edit-group-name').focus();
            }, 100);
        }

        function hideEditGroupModal() {
            const modal = document.getElementById('edit-group-modal');
            if (modal) modal.remove();
        }

        async function updateGroup(groupId) {
            const nameInput = document.getElementById('edit-group-name');
            const interactionCheckbox = document.getElementById('edit-group-interaction');

            const name = nameInput.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                nameInput.focus();
                return;
            }

            // æ£€æŸ¥é‡åï¼ˆæ’é™¤è‡ªå·±ï¼‰
            if (characterGroups.find(g => g.name === name && g.id !== groupId)) {
                alert('åˆ†ç»„åç§°å·²å­˜åœ¨');
                nameInput.focus();
                return;
            }

            const groupIndex = characterGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                characterGroups[groupIndex].name = name;
                characterGroups[groupIndex].canInteract = interactionCheckbox.checked;

                await saveCharacterGroups();

                hideEditGroupModal();
                renderContactList();
                showToast('åˆ†ç»„æ›´æ–°æˆåŠŸ', 'success');
            }
        }

        async function deleteGroup(groupId) {
            const group = characterGroups.find(g => g.id === groupId);
            if (!group || group.isDefault) return;

            const groupCharacters = characters.filter(char => char.groupId === groupId);

            let confirmMsg = `ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${group.name}"å—ï¼Ÿ`;
            if (groupCharacters.length > 0) {
                confirmMsg += `\n\nè¯¥åˆ†ç»„ä¸‹æœ‰ ${groupCharacters.length} ä¸ªè§’è‰²ï¼Œå°†è¢«ç§»åŠ¨åˆ°"æˆ‘çš„å¥½å‹"åˆ†ç»„ã€‚`;
            }

            if (!confirm(confirmMsg)) return;

            // å°†è¯¥åˆ†ç»„çš„è§’è‰²ç§»åŠ¨åˆ°é»˜è®¤åˆ†ç»„
            groupCharacters.forEach(character => {
                character.groupId = 'my_friends';
            });

            // åˆ é™¤åˆ†ç»„
            const groupIndex = characterGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                characterGroups.splice(groupIndex, 1);
            }

            await Promise.all([
                saveCharacterGroups(),
                saveCharacters()
            ]);

            renderContactList();
            showToast('åˆ†ç»„åˆ é™¤æˆåŠŸ', 'success');
        }

        function showMoveCharacterModal(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            const availableGroups = characterGroups.filter(g => g.id !== character.groupId);

            const modalHtml = `
                <div id="move-character-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ç§»åŠ¨è§’è‰²ï¼š${character.name}</div>
                        </div>
                        <div class="modal-body">
                            <div class="group-list">
                                ${availableGroups.map(group => `
                                    <div class="group-option" onclick="moveCharacterToGroup('${characterId}', '${group.id}')">
                                        <span class="group-name">${group.name}</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                <div class="group-option" onclick="hideMoveCharacterModal(); enterMultiSelectMode('${characterId}');" style="color: #007AFF;">
                                    <span class="group-name">
                                        <i class="fas fa-check-square" style="margin-right: 6px;"></i>
                                        è¿›å…¥å¤šé€‰æ¨¡å¼
                                    </span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideMoveCharacterModal()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function hideMoveCharacterModal() {
            const modal = document.getElementById('move-character-modal');
            if (modal) modal.remove();
        }

        async function moveCharacterToGroup(characterId, targetGroupId) {
            const characterIndex = characters.findIndex(c => c.id === characterId);
            if (characterIndex !== -1) {
                const oldGroupId = characters[characterIndex].groupId;
                characters[characterIndex].groupId = targetGroupId;

                await saveCharacters();
                hideMoveCharacterModal();
                renderContactList();

                const targetGroup = characterGroups.find(g => g.id === targetGroupId);
                showToast(`å·²ç§»åŠ¨åˆ°"${targetGroup.name}"åˆ†ç»„`, 'success');
            }
        }

        function showMoveToGroupModal() {
            if (selectedCharacters.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„è§’è‰²');
                return;
            }

            const modalHtml = `
                <div id="move-to-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ç§»åŠ¨ ${selectedCharacters.length} ä¸ªè§’è‰²åˆ°åˆ†ç»„</div>
                        </div>
                        <div class="modal-body">
                            <div class="group-list">
                                ${characterGroups.map(group => `
                                    <div class="group-option" onclick="moveSelectedCharactersToGroup('${group.id}')">
                                        <span class="group-name">${group.name}</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideMoveToGroupModal()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function hideMoveToGroupModal() {
            const modal = document.getElementById('move-to-group-modal');
            if (modal) modal.remove();
        }

        async function moveSelectedCharactersToGroup(targetGroupId) {
            selectedCharacters.forEach(characterId => {
                const characterIndex = characters.findIndex(c => c.id === characterId);
                if (characterIndex !== -1) {
                    characters[characterIndex].groupId = targetGroupId;
                }
            });

            await saveCharacters();
            hideMoveToGroupModal();
            exitMultiSelectMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼

            const targetGroup = characterGroups.find(g => g.id === targetGroupId);
            showToast(`å·²ç§»åŠ¨ ${selectedCharacters.length} ä¸ªè§’è‰²åˆ°"${targetGroup.name}"åˆ†ç»„`, 'success');
        }

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        function renderCharacterList() {
            const characterList = document.getElementById('character-list');
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±è·³è¿‡ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»åˆ é™¤äº†äººç‰©åº”ç”¨ï¼‰
            if (!characterList) {
                console.log('character-listå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸²æŸ“');
                return;
            }

            characterList.innerHTML = '';

            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.onclick = () => editCharacter(character.id);

                characterItem.innerHTML = `
                    <div class="character-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-bio">${truncateText(character.bio, 50)}</div>
                    </div>
                `;

                characterList.appendChild(characterItem);
            });
        }



        // å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡é™åˆ¶
        let currentMessageOffset = 0;
        const MESSAGE_LIMIT = 50;

        // ğŸ”¥ã€æ–°å¢ã€‘åŒæ­¥åŒ…è£…å‡½æ•°ï¼Œç”¨äºå‘åå…¼å®¹
        function renderChatMessages(characterId, loadMore = false) {
            renderChatMessagesAsync(characterId, loadMore).catch(error => {
                console.error('æ¸²æŸ“èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ¶ˆæ¯æ·»åŠ æ°”æ³¡æˆ³çš„JavaScriptå‡½æ•°
        function addBubbleTail(messageContainer, message) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ°”æ³¡æˆ³æ ·å¼
            const chatContainer = document.querySelector('.chat-container');
            if (!chatContainer || !chatContainer.classList.contains('bubble-style-tail')) {
                return;
            }

            const messageBubble = messageContainer.querySelector('.message-bubble');
            if (!messageBubble) return;

            // åˆ›å»ºä¸‰è§’å½¢å…ƒç´ 
            const tail = document.createElement('div');
            tail.className = 'bubble-tail-js';
            tail.style.cssText = `
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;
                z-index: 100;
                pointer-events: none;
            `;

            if (message.sender === 'received') {
                // è§’è‰²æ¶ˆæ¯ - å·¦ä¾§ä¸‰è§’å½¢
                tail.style.cssText += `
                    left: -8px;
                    top: 10px;
                    border-width: 0 8px 10px 0;
                    border-color: transparent ${getComputedStyle(messageBubble).backgroundColor} transparent transparent;
                `;
            } else if (message.sender === 'sent') {
                // ç”¨æˆ·æ¶ˆæ¯ - å³ä¾§ä¸‰è§’å½¢
                tail.style.cssText += `
                    right: -8px;
                    top: 10px;
                    border-width: 10px 8px 0 0;
                    border-color: ${getComputedStyle(messageBubble).backgroundColor} transparent transparent transparent;
                `;
            }

            messageBubble.appendChild(tail);
        }

        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰
        async function renderChatMessagesAsync(characterId, loadMore = false) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = await getAsyncChatSettings(characterId); // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬ç¡®ä¿è·å–æ­£ç¡®çš„è®¾ç½®

            if (!loadMore) {
                // é‡æ–°æ¸²æŸ“æ—¶æ¸…ç©ºå®¹å™¨å¹¶é‡ç½®åç§»é‡
                messagesContainer.innerHTML = '';
                currentMessageOffset = Math.max(0, allMessages.length - MESSAGE_LIMIT);
            }

            // åº”ç”¨èŠå¤©èƒŒæ™¯ï¼ˆæ¸²æŸ“æ—¶ä¸ä¿å­˜ï¼Œé¿å…é‡å¤ä¿å­˜ï¼‰
            applyChatBackground(undefined, true);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ°”æ³¡æ ·å¼åœ¨æ¶ˆæ¯æ¸²æŸ“å‰åº”ç”¨
            applyBubbleStyle();

            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
            if (allMessages.length === 0) {
                const displayName = chatSettings.aiChatNickname || currentChatCharacter.name;
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-chat-state';
                emptyState.innerHTML = `
                    <div>å¼€å§‹å’Œ ${displayName} èŠå¤©å§</div>
                `;
                messagesContainer.appendChild(emptyState);
                return;
            }

            // å¦‚æœä¸æ˜¯åŠ è½½æ›´å¤šï¼Œä¸”æœ‰æ›´å¤šå†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤º"æŸ¥çœ‹å†å²æ¶ˆæ¯"æŒ‰é’®
            if (!loadMore && currentMessageOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>æŸ¥çœ‹å†å²æ¶ˆæ¯ (${currentMessageOffset}æ¡)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.appendChild(loadMoreBtn);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰çº¿ä¸‹æ¨¡å¼å’Œæ¸¸æˆæ¶ˆæ¯ï¼Œä¸åœ¨çº¿ä¸ŠèŠå¤©ç•Œé¢æ˜¾ç¤º
            const onlineMessages = allMessages.filter(msg => !msg.isOfflineMode && !msg.isGameMessage && !msg.isGameContext);

            // é‡æ–°è®¡ç®—åç§»é‡ï¼ŒåŸºäºè¿‡æ»¤åçš„æ¶ˆæ¯
            const adjustedOffset = loadMore ?
                Math.max(0, onlineMessages.length - MESSAGE_LIMIT) :
                Math.max(0, onlineMessages.length - MESSAGE_LIMIT);

            // è·å–è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
            const messagesToShow = loadMore ?
                onlineMessages.slice(Math.max(0, adjustedOffset - MESSAGE_LIMIT), adjustedOffset) :
                onlineMessages.slice(adjustedOffset);

            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–æ—¶é—´æˆ³è®¾ç½®ï¼Œé»˜è®¤å¼€å¯
            const timestampEnabled = chatSettings.timestampEnabled !== false; // é»˜è®¤ä¸ºtrueï¼Œåªæœ‰æ˜ç¡®è®¾ç½®ä¸ºfalseæ‰å…³é—­
            const timestampPosition = chatSettings.timestampPosition || 'center';

            let lastTimestamp = 0;

            messagesToShow.forEach((message, index) => {
                // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æˆ³ä¸€æˆ³ã€å¤´åƒæ›´æ¢ã€æ’¤å›ç­‰ï¼‰
                if (message.sender === 'system') {
                    // ğŸ”¥ã€ç§»é™¤ã€‘ä¸å†å¤„ç†æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯ï¼Œå› ä¸ºå®ƒä»¬ä¸å†ä¿å­˜åˆ°èŠå¤©è®°å½•ä¸­
                    // æ‹‰é»‘æç¤ºç°åœ¨ç”± addBlockedIndicatorToMessage å‡½æ•°ç›´æ¥åœ¨æ¯æ¡æ¶ˆæ¯ä¸‹æ–¹æ·»åŠ 

                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    messagesContainer.appendChild(systemContainer);
                    } else if (message.type === 'system_notification') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIé€‰æ­Œç­‰ç³»ç»Ÿé€šçŸ¥
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id;

                        const notificationElement = document.createElement('div');
                        notificationElement.className = 'system-notification';
                        notificationElement.style.cssText = `
                            color: #999;
                            font-size: 12px;
                            padding: 4px 8px;
                            background: rgba(0,0,0,0.05);
                            border-radius: 12px;
                            max-width: 80%;
                            text-align: center;
                        `;

                        notificationElement.textContent = message.content;

                        centerContainer.appendChild(notificationElement);
                        messagesContainer.appendChild(centerContainer);
                    } else if (message.type === 'recalled_message') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ’¤å›æ¶ˆæ¯çš„æ˜¾ç¤º
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ æ¶ˆæ¯IDä»¥æ”¯æŒé€‰æ‹©

                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';

                        // ğŸ”¥ã€å…¼å®¹æ€§ä¿®å¤ã€‘è§£ææ’¤å›æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒæ–°æ—§æ ¼å¼
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ä¸»è¦æç¤ºæ–‡å­—
                        let originalText = lines[1]; // åŸæ–‡éƒ¨åˆ†

                        recallElement.textContent = mainText;

                        // ğŸ”¥ã€å…¼å®¹æ€§å¤„ç†ã€‘æ”¯æŒå¤šç§åŸæ–‡æ ¼å¼
                        if (originalText) {
                            // æ–°æ ¼å¼ï¼šåŸæ–‡ï¼šxxx
                            if (originalText.startsWith('åŸæ–‡ï¼š')) {
                                const originalDiv = document.createElement('div');
                                originalDiv.className = 'original-text';
                                originalDiv.textContent = originalText;
                                recallElement.appendChild(originalDiv);
                            }
                            // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯åŸæ–‡å†…å®¹
                            else {
                                const originalDiv = document.createElement('div');
                                originalDiv.className = 'original-text';
                                originalDiv.textContent = `åŸæ–‡ï¼š${originalText}`;
                                recallElement.appendChild(originalDiv);
                            }
                        }
                        // ğŸ”¥ã€å…¼å®¹æ€§å¤„ç†ã€‘å¦‚æœæ²¡æœ‰åŸæ–‡ä½†æœ‰originalContentå­—æ®µ
                        else if (message.originalContent) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = `åŸæ–‡ï¼š${message.originalContent}`;
                            recallElement.appendChild(originalDiv);
                        }

                        centerContainer.appendChild(recallElement);
                        messagesContainer.appendChild(centerContainer);

                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ’¤å›æ¶ˆæ¯æ·»åŠ é€‰æ‹©åŠŸèƒ½
                        addMessageLongPressListener(centerContainer, message.id);
                    } else if (message.type === 'call_record') {
                        // å¤„ç†é€šè¯è®°å½•æ¶ˆæ¯
                        const centerContainer = document.createElement('div');
                        centerContainer.className = 'message-wrapper system';
                        centerContainer.dataset.messageId = message.id;

                        const callRecordElement = document.createElement('div');
                        callRecordElement.className = 'call-record-message';
                        callRecordElement.style.textAlign = 'center';
                        callRecordElement.style.color = '#888';
                        callRecordElement.style.fontSize = '13px';
                        callRecordElement.style.padding = '8px 0';

                        // ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬ï¼Œä¸æ·»åŠ å›¾æ ‡ï¼Œä¹Ÿä¸é‡å¤æ˜¾ç¤ºæ—¶é•¿
                        callRecordElement.textContent = message.content;

                        centerContainer.appendChild(callRecordElement);
                        messagesContainer.appendChild(centerContainer);
                    } else if (message.type === 'call_message') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†é€šè¯æ¶ˆæ¯ - æ˜¾ç¤ºä¸ºç®€å•çš„æ–‡æœ¬æ¶ˆæ¯
                        const centerContainer = document.createElement('div');
                        centerContainer.className = 'message-wrapper system';
                        centerContainer.dataset.messageId = message.id;

                        const callMessageElement = document.createElement('div');
                        callMessageElement.className = 'call-system-message';
                        callMessageElement.style.color = '#888';
                        callMessageElement.style.fontSize = '13px';
                        callMessageElement.style.textAlign = 'center';
                        callMessageElement.style.padding = '8px 0';
                        callMessageElement.textContent = message.content;

                        centerContainer.appendChild(callMessageElement);
                        messagesContainer.appendChild(centerContainer);
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å…¶ä»–ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚å¤´åƒæ›´æ¢ï¼‰- ä½¿ç”¨å±…ä¸­å®¹å™¨
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';

                        const systemContainer = document.createElement('div');
                        // ğŸ”¥ã€ç¾åŒ–ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå¥½å‹æ·»åŠ æˆåŠŸæ¶ˆæ¯ï¼Œåº”ç”¨ç‰¹æ®Šæ ·å¼
                        if (message.isFriendAddedMessage) {
                            systemContainer.className = 'friend-added-system-message';
                        } else {
                            systemContainer.className = 'system-message';
                        }
                        systemContainer.textContent = message.content;

                        centerContainer.appendChild(systemContainer);
                        messagesContainer.appendChild(centerContainer);
                    }
                    return;
                }

                // æ·»åŠ å±…ä¸­æ—¶é—´æˆ³ï¼ˆå¦‚æœå¯ç”¨ä¸”ä½ç½®ä¸ºå±…ä¸­ï¼‰
                if (timestampEnabled && timestampPosition === 'center') {
                    const currentTime = new Date(message.timestamp);
                    const timeDiff = currentTime - lastTimestamp;

                    // å¦‚æœè·ç¦»ä¸Šæ¡æ¶ˆæ¯è¶…è¿‡5åˆ†é’Ÿï¼Œæ˜¾ç¤ºæ—¶é—´æˆ³
                    if (index === 0 || timeDiff > 5 * 60 * 1000) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'timestamp timestamp-center';
                        timestampDiv.textContent = formatTimestamp(message.timestamp);
                        messagesContainer.appendChild(timestampDiv);
                        lastTimestamp = currentTime;
                    }
                }

                const messageContainer = document.createElement('div');
                // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯è¡¨æƒ…åŒ…æ¶ˆæ¯
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id; // æ·»åŠ æ¶ˆæ¯IDæ•°æ®å±æ€§

                if (message.sender === 'received') {
                    // ==== ç¾¤èŠæ”¯æŒ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }

                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';

                    if (isGroup && group) {
                        // ç¾¤èŠï¼šæ ¹æ®æ¶ˆæ¯çš„senderIdæˆ–nameæŸ¥æ‰¾æˆå‘˜
                        let member = null;
                        console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] ç¾¤èŠæ¶ˆæ¯æ¸²æŸ“ - senderId:', message.senderId, 'name:', message.name);
                        console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] ç¾¤æˆå‘˜åˆ—è¡¨:', group.members);
                        console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] å®Œæ•´æ¶ˆæ¯å¯¹è±¡:', message);

                        // è¡¨æƒ…åŒ…æ¶ˆæ¯å¤„ç†

                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                            console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] é€šè¿‡senderIdæ‰¾åˆ°æˆå‘˜:', member);
                            console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] senderIdæŸ¥æ‰¾è¯¦æƒ…:', {
                                messageSenderId: message.senderId,
                                memberIds: group.members.map(m => m.id),
                                foundMember: member
                            });
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                            console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] é€šè¿‡nameæ‰¾åˆ°æˆå‘˜:', member);
                            console.log('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] nameæŸ¥æ‰¾è¯¦æƒ…:', {
                                messageName: message.name,
                                memberNames: group.members.map(m => m.name),
                                foundMember: member
                            });
                        }

                        // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿ç¾¤èŠè¡¨æƒ…åŒ…æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºå‘é€è€…
                        if (member) {
                            displayAvatar = member.avatarUrl || '';
                            displayName = member.name;
                            color = member.color || '#4CAF50';
                        } else {
                            // å¦‚æœæ²¡æ‰¾åˆ°æˆå‘˜ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­çš„nameä½œä¸ºæ˜¾ç¤ºåç§°
                            displayAvatar = '';
                            displayName = message.name || 'ç¾¤æˆå‘˜';
                            color = '#4CAF50';
                            console.warn('ğŸ” [æ¶ˆæ¯æ¸²æŸ“] æœªæ‰¾åˆ°ç¾¤æˆå‘˜ï¼Œä½¿ç”¨æ¶ˆæ¯name:', message.name);
                        }

                        // å¤´åƒå’Œæ˜¾ç¤ºåå¤„ç†å®Œæˆ
                    } else if (character) {
                        // å•èŠ
                        displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';

                    // å¤´åƒé€‰æ‹©é€»è¾‘
                    } else {
                        // å…œåº•ï¼Œé˜²æ­¢æŠ¥é”™
                        displayAvatar = '';
                        displayName = 'æœªçŸ¥';
                        color = '#4CAF50';
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ°”æ³¡æ ·å¼ - ç¾¤èŠä¸­ä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                    let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';

                    // å¦‚æœæ˜¯ç¾¤èŠä¸”æœ‰æˆå‘˜ä¸“å±é¢œè‰²è®¾ç½®ï¼Œä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                    if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                        const memberColor = chatSettings.memberBubbleColors[message.senderId];
                        if (memberColor) {
                            bubbleColor = memberColor;
                        }
                    }

                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';

                    // å°†é€æ˜åº¦åº”ç”¨åˆ°èƒŒæ™¯è‰²è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ 
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);

                    // ğŸ”¥ å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                    let messageContent = '';

                    if (message.type === 'user_photo') {
                        // è§’è‰²å‘é€çš„"ä¼ªç…§ç‰‡" - ä½¿ç”¨ä¸ç”¨æˆ·ç›¸åŒçš„ç»“æ„
                        messageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">âœ¨</div>
                                        <div class="sparkle sparkle-2">â­</div>
                                        <div class="sparkle sparkle-3">âœ¨</div>
                                        <div class="sparkle sparkle-4">â­</div>
                                        <div class="sparkle sparkle-5">ğŸ’«</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${(message.photoDescription || message.content)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // è§’è‰²å‘é€çš„ä½ç½®æ¶ˆæ¯ - ä½¿ç”¨ä¸ç”¨æˆ·ç›¸åŒçš„ç»“æ„
                        messageContent = `
                            <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                <div class="location-card-header">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                    </svg>
                                    ${message.locationName}
                                </div>
                                <div class="location-card-map">
                                    <div class="map-background"></div>
                                    <div class="map-roads">
                                        <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                        <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                        <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                    </div>
                                    <div class="map-buildings">
                                        <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                        <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                        <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                        <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                        <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                        <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                    </div>
                                    <div class="map-marker">
                                        <div class="marker-pin">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'voice_message') {
                        // è¿‡æ»¤æ‰æ‹¬å·ä¸­çš„æè¿°æ€§å†…å®¹ï¼Œä¿ç•™å®é™…è¯´è¯å†…å®¹
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));

                        // AIè¯­éŸ³æ¶ˆæ¯ - ä½¿ç”¨å’Œç”¨æˆ·è¯­éŸ³æ¶ˆæ¯ä¸€æ ·çš„ç»“æ„
                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>

                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AIç”Ÿæˆçš„å›¾ç‰‡ - ä½¿ç”¨æ˜Ÿæ˜Ÿemojiå¡ç‰‡æ ·å¼
                        const imageDesc = message.imageDescription || message.content || 'AIæè¿°çš„å›¾ç‰‡';
                        messageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${imageDesc.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">âœ¨</div>
                                        <div class="sparkle sparkle-2">â­</div>
                                        <div class="sparkle sparkle-3">âœ¨</div>
                                        <div class="sparkle sparkle-4">â­</div>
                                        <div class="sparkle sparkle-5">ğŸ’«</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${imageDesc}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // è½¬è´¦æ¶ˆæ¯
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'ğŸ’•' : 'ğŸ’–';
                        const titleText = isUser ? 'ä½ å‘èµ·çš„è½¬è´¦' : 'æ”¶åˆ°è½¬è´¦';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';

                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²æ”¶æ¬¾' : 'å·²æ”¶æ¬¾'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²é€€å›' : 'å·²é€€å›'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIå‘æ¥çš„è½¬è´¦ä¸”æœªå¤„ç†ï¼Œæ·»åŠ ç‚¹å‡»å¤„ç†
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }

                        messageContent = `
                            <div class="transfer-message-container received">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                    <div class="transfer-title">${heartIcon} ${titleText}</div>
                                    <div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'è½¬è´¦'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'friend_request') {
                        // ğŸ”¥ã€æ–°å¢ã€‘AIä¸»åŠ¨å‘é€çš„å¥½å‹ç”³è¯·
                        let actionsHtml;
                        if (message.friendRequestProcessed) {
                            // å·²å¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºå¤„ç†ç»“æœ
                            const resultText = message.friendRequestAccepted ? 'å·²åŒæ„' : 'å·²æ‹’ç»';
                            const resultClass = message.friendRequestAccepted ? 'accepted' : 'rejected';
                            actionsHtml = `<div class="friend-request-result ${resultClass}">${resultText}</div>`;
                            console.log('ğŸ”„ æ¸²æŸ“å·²å¤„ç†çš„å¥½å‹ç”³è¯·:', message.id, resultText);
                        } else {
                            // æœªå¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºæŒ‰é’®
                            actionsHtml = `
                                <button class="friend-request-btn accept" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', true, '${message.id}')">åŒæ„</button>
                                <button class="friend-request-btn reject" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', false, '${message.id}')">æ‹’ç»</button>
                            `;
                            console.log('ğŸ”„ æ¸²æŸ“æœªå¤„ç†çš„å¥½å‹ç”³è¯·:', message.id);
                        }

                        messageContent = `
                            <div class="friend-request-container">
                                <div class="friend-request-card">
                                    <div class="friend-request-title">å¥½å‹ç”³è¯·</div>
                                    <div class="friend-request-message-section">
                                        <div class="friend-request-message-label">å¯¹æ–¹ç•™è¨€</div>
                                        <div class="friend-request-message-content">${message.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'}</div>
                                    </div>
                                    <div class="friend-request-actions">
                                        ${actionsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                        const chatMode = chatSettings.chatMode || 'online';

                        // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                        let processedContent;
                        if (typeof message.content === 'string') {
                            processedContent = message.content;
                        } else if (Array.isArray(message.content) && message.content.length > 0) {
                            // å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼ï¼š[{type: 'text', text: 'å†…å®¹'}]
                            const firstItem = message.content[0];
                            if (firstItem && firstItem.type === 'text' && firstItem.text) {
                                processedContent = firstItem.text;
                            } else {
                                processedContent = '[å¤šåª’ä½“æ¶ˆæ¯]';
                            }
                        } else if (message.content && typeof message.content === 'object') {
                            // çº¦å®šæˆ–çºªå¿µæ—¥å¯¹è±¡
                            if (message.content.name && typeof message.content.name === 'string') {
                                if (message.content.type === 'create_appointment') {
                                    processedContent = `åˆ›å»ºäº†çº¦å®šï¼š${message.content.name}`;
                                } else if (message.content.type === 'create_anniversary') {
                                    processedContent = `åˆ›å»ºäº†çºªå¿µæ—¥ï¼š${message.content.name}`;
                                } else {
                                    processedContent = `æåŠäº†ï¼š${message.content.name}`;
                                }
                            } else {
                                // å…¶ä»–å¯¹è±¡ç±»å‹
                                processedContent = message.content.message || message.content.text || '[å¤šåª’ä½“æ¶ˆæ¯]';
                            }
                        } else {
                            processedContent = String(message.content || '');
                        }

                        if (chatMode === 'offline') {
                            processedContent = processOfflineContent(processedContent);
                        }

                        // å¤„ç†@å†…å®¹
                        processedContent = processMentions(processedContent);

                        // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                        if (message.replyTo) {
                            messageContent = generateReplyHTML(message.replyTo) + processedContent;
                        } else {
                            messageContent = processedContent;
                        }
                    }

                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = generateAvatarHtml({
                            avatarUrl: displayAvatar,
                            backgroundColor: color,
                            displayName: displayName,
                            timestamp: message.timestamp,
                            timestampEnabled: timestampEnabled,
                            timestampPosition: timestampPosition,
                            chatSettings: chatSettings,
                            onClick: character ? `pokeCharacter('${character.id}')` : '',
                            title: character ? 'æˆ³ä¸€æˆ³' : displayName
                        });
                    }

                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'user_photo' || message.type === 'location' || message.type === 'ai_image' || message.type === 'friend_request') {
                        // è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ç…§ç‰‡ã€ä½ç½®æ¶ˆæ¯å’ŒAIå›¾ç‰‡æ¶ˆæ¯ä¸éœ€è¦é¢å¤–çš„æ°”æ³¡åŒ…è£¹
                        bubbleHtml = messageContent;
                    } else {
                        // æ™®é€šæ¶ˆæ¯ç”¨æ°”æ³¡åŒ…è£¹
                        bubbleHtml = `
                                                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                ${messageContent}
                                ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}

                                ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                    `;
                    }

      // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ˜µç§°æ˜¾ç¤º - ç‰¹åˆ«å¤„ç†è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯
      if (isGroup && group && displayName !== 'ç¾¤æˆå‘˜') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;

    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'ai_image' || message.type === 'user_photo' || message.type === 'location' || message.type === 'friend_request' || message.type === 'order_confirmation') {
        // ğŸ”¥ã€ä¿®å¤ã€‘å¯¹äºè¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€AIå›¾ç‰‡æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯ï¼Œæ˜µç§°éœ€è¦åœ¨å®¹å™¨å¤–éƒ¨
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // æ™®é€šæ¶ˆæ¯çš„å¤„ç†ï¼ˆåŒ…æ‹¬è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼‰
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    // è·å–æˆ‘çš„æ˜¾ç¤ºå¤´åƒå’Œæ°”æ³¡æ ·å¼
let myDisplayAvatar = chatSettings.myChatAvatar; // ä¼˜å…ˆä½¿ç”¨èŠå¤©ä¸“å±è®¾ç½®é‡Œçš„å¤´åƒ
let myDisplayName = chatSettings.myChatNickname; // ä¼˜å…ˆä½¿ç”¨èŠå¤©ä¸“å±è®¾ç½®é‡Œçš„æ˜µç§°

// å¦‚æœä¸“å±è®¾ç½®é‡Œæ²¡æœ‰ï¼Œåˆ™è¿›è¡ŒäºŒæ¬¡æŸ¥æ‰¾ï¼ˆä½œä¸ºä¿é™©æªæ–½ï¼‰
if ((!myDisplayAvatar || !myDisplayName) && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        // å¦‚æœå¤´åƒä¸ºç©ºï¼Œåˆ™ä½¿ç”¨èº«ä»½å¤´åƒ
        if (!myDisplayAvatar) myDisplayAvatar = selectedPersona.avatarUrl;
        // å¦‚æœæ˜µç§°ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨èº«ä»½æ˜µç§°
        if (!myDisplayName) myDisplayName = selectedPersona.name;
                        }
                    }

                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';

                    // å°†é€æ˜åº¦åº”ç”¨åˆ°èƒŒæ™¯è‰²è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ 
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);

                    // å¤„ç†ç”¨æˆ·çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // ç”¨æˆ·å‘é€çš„"ç…§ç‰‡"ï¼ˆæ–‡å­—æè¿°ï¼‰
                        myMessageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">âœ¨</div>
                                        <div class="sparkle sparkle-2">â­</div>
                                        <div class="sparkle sparkle-3">âœ¨</div>
                                        <div class="sparkle sparkle-4">â­</div>
                                        <div class="sparkle sparkle-5">ğŸ’«</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${(message.photoDescription || message.content)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        // ç”¨æˆ·å‘é€çš„è¯­éŸ³æ¶ˆæ¯
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>

                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // ç”¨æˆ·è½¬è´¦æ¶ˆæ¯ - åœ¨renderChatMessagesä¸­å¤„ç†
                        let cardClass = '';
                        let statusHtml = '';

                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²æ”¶æ¬¾</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²é€€å›</div>`;
                            cardClass = 'rejected';
                        }

                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">ğŸ’• ä½ å‘èµ·çš„è½¬è´¦</div>
                                    <div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'è½¬è´¦'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'order_confirmation') {
                        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†è®¢å•ç¡®è®¤æ¶ˆæ¯ - æ¼‚äº®çš„è´­ç‰©å°ç¥¨æ ·å¼
                        const orderDetails = message.orderDetails || {};
                        const orderType = message.orderType || '';

                        let receiptTitle = '';
                        let receiptIcon = '';
                        let receiptClass = '';

                        if (orderType === 'self_pay_self') {
                            receiptTitle = 'è®¢å•æ”¯ä»˜æˆåŠŸ';
                            receiptIcon = '';
                            receiptClass = 'success';
                        } else if (orderType === 'self_pay_ta') {
                            receiptTitle = 'è®¢å•ä¸‹å•æˆåŠŸ';
                            receiptIcon = '';
                            receiptClass = 'success';
                        }

                        const itemsHtml = orderDetails.items ? orderDetails.items.map(item => {
                            // ğŸ”¥ã€ä¿®å¤ã€‘ç”ŸæˆåŒ…å«é€‰é¡¹ä¿¡æ¯çš„å•†å“åç§°
                            let itemNameWithOptions = item.name;
                            if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                                const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                                    `${getOptionLabel(key)}: ${value}`
                                ).join(', ');
                                itemNameWithOptions += `<br><small style="color: #666; font-size: 11px;">${optionsText}</small>`;
                            }

                            return `
                                <div class="receipt-item">
                                    <span class="item-name">${itemNameWithOptions}</span>
                                    <span class="item-quantity">x${item.quantity}</span>
                                    <span class="item-price">Â¥${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `;
                        }).join('') : '';

                        myMessageContent = `
                            <div class="order-receipt-container">
                                <div class="receipt-card ${receiptClass}">
                                    <div class="receipt-header">
                                        <div class="receipt-title">${receiptTitle}</div>
                                    </div>

                                    <div class="receipt-divider"></div>

                                    <div class="receipt-info">
                                        <div class="receipt-row">
                                            <span class="label">è®¢å•å·</span>
                                            <span class="value">${orderDetails.orderNumber || 'N/A'}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span class="label">æ”¶è´§äºº</span>
                                            <span class="value">${orderType.endsWith('_self') ? 'æˆ‘è‡ªå·±' : (currentChatCharacter?.name || 'Ta')}</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span class="label">ä¸‹å•æ—¶é—´</span>
                                            <span class="value">${new Date(message.timestamp).toLocaleString('zh-CN', {
                                                month: '2-digit',
                                                day: '2-digit',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}</span>
                                        </div>
                                    </div>

                                    <div class="receipt-divider"></div>

                                    <div class="receipt-items">
                                        <div class="items-header">å•†å“æ¸…å•</div>
                                        ${itemsHtml}
                                    </div>

                                    <div class="receipt-divider"></div>

                                    <div class="receipt-total">
                                        <div class="total-row final">
                                            <span class="total-label">å®ä»˜é‡‘é¢</span>
                                            <span class="total-amount">Â¥${orderDetails.total ? orderDetails.total.toFixed(2) : '0.00'}</span>
                                        </div>
                                    </div>

                                    <div class="receipt-footer">
                                        <div class="thank-you">è›‹è®°æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'payment_request') {
                        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†ä»£ä»˜è¯·æ±‚æ¶ˆæ¯ - æ ¹æ®çŠ¶æ€åŠ¨æ€ç”Ÿæˆå†…å®¹
                        myMessageContent = generatePaymentRequestContent(message);
                    } else if (message.type === 'shared_post') {
                        // ã€æ–°å¢ã€‘å¤„ç†åˆ†äº«çš„è®ºå›å¸–å­å¡ç‰‡
                        const postData = message.postData || {};
                        myMessageContent = `
                            <div class="shared-post-card" onclick="showPostView(${postData.id}, 'chat')">
                                <div class="shared-post-header">è®ºå›å¸–å­åˆ†äº«</div>
                                <div class="shared-post-title">${postData.title || 'å¸–å­åŠ è½½å¤±è´¥'}</div>
                                <div class="shared-post-content">${truncateText(postData.content || '', 50)}</div>
                            </div>
                        `;
                    } else if (message.type === 'forwarded_message') {
                        // ã€æ–°å¢ã€‘å¤„ç†è½¬å‘çš„æ¶ˆæ¯å¡ç‰‡
                        myMessageContent = renderForwardedMessage(message);
                    } else if (message.type === 'location') {
                        // ç”¨æˆ·å‘é€çš„ä½ç½®æ¶ˆæ¯
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                        </svg>
                                        ${message.locationName}
                                    </div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯ï¼ˆç°åœ¨æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼‰
                        if (Array.isArray(message.content)) {
                            // ç»Ÿä¸€çš„æ•°ç»„æ ¼å¼å¤„ç†
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');

                            let baseContent = textPart?.text || '';
                            // å¤„ç†@å†…å®¹
                            baseContent = processMentions(baseContent);

                            // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }

                            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ˜¾ç¤º
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘å¤„ç†æ—§æ ¼å¼æ¶ˆæ¯ï¼ˆé€æ­¥è¿ç§»ä¸­ï¼‰
                            let baseContent = message.content;
                            // å¤„ç†@å†…å®¹
                            baseContent = processMentions(baseContent);

                            // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }
                        }
                    }

                    let myBubbleHtml = '';

                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location' || message.type === 'friend_request' || message.type === 'order_confirmation' || message.type === 'payment_request') {
                        // ç”¨æˆ·ç…§ç‰‡ã€è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ä½ç½®æ¶ˆæ¯ã€ä»£ä»˜è¯·æ±‚ä¸éœ€è¦é¢å¤–æ°”æ³¡åŒ…è£¹ï¼ˆå·²ç»æœ‰è‡ªå·±çš„å®¹å™¨ï¼‰
                        myBubbleHtml = myMessageContent;
                    } else {
                        // æ™®é€šæ¶ˆæ¯ç”¨æ°”æ³¡åŒ…è£¹
                        myBubbleHtml = `
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                ${myMessageContent}
                                ${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                                ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }

                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = generateAvatarHtml({
                            avatarUrl: myDisplayAvatar,
                            backgroundColor: '#007AFF',
                            displayName: '',
                            timestamp: message.timestamp,
                            timestampEnabled: timestampEnabled,
                            timestampPosition: timestampPosition,
                            chatSettings: chatSettings
                        });
                    }

                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }

                // æ·»åŠ æ»‘å…¥åŠ¨ç”»æ•ˆæœ - å‚è€ƒå®Œæˆ.htmlçš„å¼¹æ€§åŠ¨ç”»
                messageContainer.style.opacity = '0';
                messageContainer.style.transform = 'translateY(20px)';
                messageContainer.style.transition = 'opacity 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';

                messagesContainer.appendChild(messageContainer);

                // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ°”æ³¡æˆ³æ ·å¼æ·»åŠ çœŸå®çš„ä¸‰è§’å½¢å…ƒç´ 
                addBubbleTail(messageContainer, message);

                // è§¦å‘æ»‘å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    messageContainer.style.opacity = '1';
                    messageContainer.style.transform = 'translateY(0)';
                });

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶æ·»åŠ æŒ‡ç¤ºå™¨
                addBlockedIndicatorToMessage(messageContainer, message, characterId);

                // æ·»åŠ é•¿æŒ‰ç›‘å¬å™¨ç”¨äºå¤šé€‰åˆ é™¤
                addMessageLongPressListener(messageContainer, message.id);

                // æ·»åŠ å³é”®èœå•åŠŸèƒ½
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    // é¼ æ ‡å³é”®ç‚¹å‡»
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });

                    // ç‚¹å‡»å›¾ç‰‡é¢„è§ˆ
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
            });

            // ğŸ”¥ã€ç§»é™¤ã€‘ä¸å†éœ€è¦åº•éƒ¨çš„æ­£åœ¨è¾“å…¥æç¤ºå…ƒç´ ï¼Œæ”¹ä¸ºé¡¶éƒ¨æ ‡é¢˜å˜åŒ–

            // å¦‚æœä¸æ˜¯åŠ è½½æ›´å¤šï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (!loadMore) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½ç½®æ¶ˆæ¯æ°”æ³¡åŒ…è£…é—®é¢˜ - ä¿®å¤å·²æ¸²æŸ“çš„ä½ç½®æ¶ˆæ¯
            setTimeout(() => {
                const locationMessages = messagesContainer.querySelectorAll('.message-container.sent');
                locationMessages.forEach(container => {
                    const locationCard = container.querySelector('.location-card');
                    if (locationCard && container.querySelector('.message-bubble')) {
                        // å¦‚æœä½ç½®å¡ç‰‡è¢«åŒ…è£¹åœ¨æ°”æ³¡ä¸­ï¼Œæå–å‡ºæ¥
                        const bubble = container.querySelector('.message-bubble');
                        const avatar = container.querySelector('.message-avatar');
                        if (bubble && locationCard.closest('.message-bubble')) {
                            const locationContainer = locationCard.closest('.location-message-container');
                            if (locationContainer) {
                                container.innerHTML = locationContainer.outerHTML + (avatar ? avatar.outerHTML : '');
                            }
                        }
                    }
                });

                // ğŸ”¥ã€æ–°å¢ã€‘æ¸²æŸ“è§’è‰²çŠ¶æ€æ˜¾ç¤º - åœ¨æ¶ˆæ¯æ¸²æŸ“å®Œæˆåæ›´æ–°çŠ¶æ€
                if (currentChatCharacter) {
                    const headerContainer = document.querySelector('#api-chat-screen .header');
                    if (headerContainer) {
                        renderCharacterStatus(currentChatCharacter.id, headerContainer);
                    }
                }
            }, 50);
        }

        // åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
        function loadMoreMessages(characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();

            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollHeight = messagesContainer.scrollHeight;
            const scrollTop = messagesContainer.scrollTop;

            // è®¡ç®—è¦åŠ è½½çš„å†å²æ¶ˆæ¯èŒƒå›´
            const newOffset = Math.max(0, currentMessageOffset - MESSAGE_LIMIT);
            const historicalMessages = allMessages.slice(newOffset, currentMessageOffset);

            const existingLoadMoreBtn = messagesContainer.querySelector('.load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }

            // å¦‚æœè¿˜æœ‰æ›´å¤šå†å²æ¶ˆæ¯ï¼Œåœ¨é¡¶éƒ¨æ·»åŠ æ–°çš„"æŸ¥çœ‹å†å²æ¶ˆæ¯"æŒ‰é’®
            if (newOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>æŸ¥çœ‹å†å²æ¶ˆæ¯ (${newOffset}æ¡)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.insertBefore(loadMoreBtn, messagesContainer.firstChild);
            }

            // åœ¨ç°æœ‰æ¶ˆæ¯å‰é¢æ’å…¥å†å²æ¶ˆæ¯
            const timestampEnabled = chatSettings.timestampEnabled !== false; // ğŸ”¥ã€ä¿®å¤ã€‘é»˜è®¤å¼€å¯
            const timestampPosition = chatSettings.timestampPosition || 'center';
            let lastTimestamp = 0;

            // ä»åå¾€å‰æ’å…¥ï¼Œä¿æŒæ—¶é—´é¡ºåº
            for (let i = historicalMessages.length - 1; i >= 0; i--) {
                const message = historicalMessages[i];

                // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æˆ³ä¸€æˆ³ã€å¤´åƒæ›´æ¢ã€æ’¤å›ç­‰ï¼‰
                if (message.sender === 'system') {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯ - æ˜¾ç¤ºä¸ºå±…ä¸­çš„ç³»ç»Ÿæç¤º
                    if (message.isBlockedMessage) {
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id;

                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content || 'æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†';

                        centerContainer.appendChild(systemContainer);

                        // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
                        const insertAfter = messagesContainer.querySelector('.load-more-messages');
                        if (insertAfter) {
                            insertAfter.parentNode.insertBefore(centerContainer, insertAfter.nextSibling);
                        } else {
                            messagesContainer.insertBefore(centerContainer, messagesContainer.firstChild);
                        }
                        continue;
                    }

                    let containerToInsert;

                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                        containerToInsert = systemContainer;
                    } else if (message.type === 'recalled_message') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ’¤å›æ¶ˆæ¯çš„æ˜¾ç¤º
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ æ¶ˆæ¯IDä»¥æ”¯æŒé€‰æ‹©

                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';

                        // ğŸ”¥ã€å…¼å®¹æ€§ä¿®å¤ã€‘è§£ææ’¤å›æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒæ–°æ—§æ ¼å¼
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ä¸»è¦æç¤ºæ–‡å­—
                        let originalText = lines[1]; // åŸæ–‡éƒ¨åˆ†

                        recallElement.textContent = mainText;

                        // ğŸ”¥ã€å…¼å®¹æ€§å¤„ç†ã€‘æ”¯æŒå¤šç§åŸæ–‡æ ¼å¼
                        if (originalText) {
                            // æ–°æ ¼å¼ï¼šåŸæ–‡ï¼šxxx
                            if (originalText.startsWith('åŸæ–‡ï¼š')) {
                                const originalDiv = document.createElement('div');
                                originalDiv.className = 'original-text';
                                originalDiv.textContent = originalText;
                                recallElement.appendChild(originalDiv);
                            }
                            // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯åŸæ–‡å†…å®¹
                            else {
                                const originalDiv = document.createElement('div');
                                originalDiv.className = 'original-text';
                                originalDiv.textContent = `åŸæ–‡ï¼š${originalText}`;
                                recallElement.appendChild(originalDiv);
                            }
                        }
                        // ğŸ”¥ã€å…¼å®¹æ€§å¤„ç†ã€‘å¦‚æœæ²¡æœ‰åŸæ–‡ä½†æœ‰originalContentå­—æ®µ
                        else if (message.originalContent) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = `åŸæ–‡ï¼š${message.originalContent}`;
                            recallElement.appendChild(originalDiv);
                        }

                        centerContainer.appendChild(recallElement);
                        containerToInsert = centerContainer;
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å…¶ä»–ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚å¤´åƒæ›´æ¢ï¼‰- ä½¿ç”¨å±…ä¸­å®¹å™¨
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';

                        const systemContainer = document.createElement('div');
                        // ğŸ”¥ã€ç¾åŒ–ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå¥½å‹æ·»åŠ æˆåŠŸæ¶ˆæ¯ï¼Œåº”ç”¨ç‰¹æ®Šæ ·å¼
                        if (message.isFriendAddedMessage) {
                            systemContainer.className = 'friend-added-system-message';
                        } else {
                            systemContainer.className = 'system-message';
                        }
                        systemContainer.textContent = message.content;

                        centerContainer.appendChild(systemContainer);
                        containerToInsert = centerContainer;
                    }

                    // æ’å…¥åˆ°æŒ‰é’®åé¢ï¼ˆå¦‚æœæœ‰æŒ‰é’®çš„è¯ï¼‰
                    const insertAfter = messagesContainer.querySelector('.load-more-messages');
                    if (insertAfter) {
                        insertAfter.parentNode.insertBefore(containerToInsert, insertAfter.nextSibling);
                    } else {
                        messagesContainer.insertBefore(containerToInsert, messagesContainer.firstChild);
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ’¤å›æ¶ˆæ¯æ·»åŠ é€‰æ‹©åŠŸèƒ½
                    if (message.type === 'recalled_message') {
                        addMessageLongPressListener(containerToInsert, message.id);
                    }

                    continue;
                }

                const messageContainer = document.createElement('div');
                // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯è¡¨æƒ…åŒ…æ¶ˆæ¯
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id;

                if (message.sender === 'received') {
                    // ==== ç¾¤èŠæ”¯æŒ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }

                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';

                    if (isGroup && group) {
                        // ç¾¤èŠï¼šæ ¹æ®æ¶ˆæ¯çš„senderIdæˆ–nameæŸ¥æ‰¾æˆå‘˜
                        let member = null;
                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                        }

                        // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿ç¾¤èŠè¡¨æƒ…åŒ…æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºå‘é€è€…ï¼ˆloadMoreMessagesç‰ˆæœ¬ï¼‰
                        if (member) {
                            displayAvatar = member.avatarUrl || '';
                            displayName = member.name;
                            color = member.color || '#4CAF50';
                        } else {
                            // å¦‚æœæ²¡æ‰¾åˆ°æˆå‘˜ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­çš„nameä½œä¸ºæ˜¾ç¤ºåç§°
                            displayAvatar = '';
                            displayName = message.name || 'ç¾¤æˆå‘˜';
                            color = '#4CAF50';
                        }
                    } else if (character) {
                        // å•èŠ
                        displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';
                    } else {
                        // å…œåº•ï¼Œé˜²æ­¢æŠ¥é”™
                        displayAvatar = '';
                        displayName = 'æœªçŸ¥';
                        color = '#4CAF50';
                    }
                    // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ°”æ³¡æ ·å¼ - ç¾¤èŠä¸­ä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                    let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';

                    // å¦‚æœæ˜¯ç¾¤èŠä¸”æœ‰æˆå‘˜ä¸“å±é¢œè‰²è®¾ç½®ï¼Œä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                    if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                        const memberColor = chatSettings.memberBubbleColors[message.senderId];
                        if (memberColor) {
                            bubbleColor = memberColor;
                        }
                    }

                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';

                    // å°†é€æ˜åº¦åº”ç”¨åˆ°èƒŒæ™¯è‰²è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ 
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);

                    let messageContent = '';
                    if (message.type === 'voice_message') {
                        // è¿‡æ»¤æ‰æ‹¬å·ä¸­çš„æè¿°æ€§å†…å®¹ï¼Œä¿ç•™å®é™…è¯´è¯å†…å®¹
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));

                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>

                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AIç”Ÿæˆçš„å›¾ç‰‡ - ä½¿ç”¨æ˜Ÿæ˜Ÿemojiå¡ç‰‡æ ·å¼
                        const imageDesc = message.imageDescription || message.content || 'AIæè¿°çš„å›¾ç‰‡';
                        messageContent = `<div class="dreamy-photo-container" onclick="togglePhotoText(this, '${imageDesc.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"><div class="dreamy-photo"><div class="photo-misty-bg"></div><div class="photo-badge"><i class="fas fa-image"></i></div><div class="sparkle-container"><div class="sparkle sparkle-1">âœ¨</div><div class="sparkle sparkle-2">â­</div><div class="sparkle sparkle-3">âœ¨</div><div class="sparkle sparkle-4">â­</div><div class="sparkle sparkle-5">ğŸ’«</div></div><div class="photo-text-overlay" style="display: none;"><div class="photo-description">${imageDesc}</div></div></div></div>`;
                    } else if (message.type === 'transfer') {
                        // è½¬è´¦æ¶ˆæ¯
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'ğŸ’•' : 'ğŸ’–';
                        const titleText = isUser ? 'ä½ å‘èµ·çš„è½¬è´¦' : 'æ”¶åˆ°è½¬è´¦';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';

                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²æ”¶æ¬¾' : 'å·²æ”¶æ¬¾'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²é€€å›' : 'å·²é€€å›'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIå‘æ¥çš„è½¬è´¦ä¸”æœªå¤„ç†ï¼Œæ·»åŠ ç‚¹å‡»å¤„ç†
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }

                        messageContent = `<div class="transfer-message-container received"><div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div><div class="transfer-note">${message.note || 'è½¬è´¦'}</div>${statusHtml}</div></div>`;
                    } else if (message.type === 'shared_post') {
                        // ã€æ–°å¢ã€‘å¤„ç†åˆ†äº«çš„è®ºå›å¸–å­å¡ç‰‡
                        const postData = message.postData || {};
                        messageContent = `
                            <div class="shared-post-card" onclick="showPostView(${postData.id}, 'chat')">
                                <div class="shared-post-header">è®ºå›å¸–å­åˆ†äº«</div>
                                <div class="shared-post-title">${postData.title || 'å¸–å­åŠ è½½å¤±è´¥'}</div>
                                <div class="shared-post-content">${truncateText(postData.content || '', 50)}</div>
                            </div>
                        `;
                    } else if (message.type === 'forwarded_message') {
                        // ã€æ–°å¢ã€‘å¤„ç†è½¬å‘çš„æ¶ˆæ¯å¡ç‰‡
                        messageContent = renderForwardedMessage(message);
                    } else if (message.type === 'friend_request') {
                        // ğŸ”¥ã€æ–°å¢ã€‘AIä¸»åŠ¨å‘é€çš„å¥½å‹ç”³è¯·(ç¬¬äºŒå¤„)
                        let actionsHtml;
                        if (message.friendRequestProcessed) {
                            // å·²å¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºå¤„ç†ç»“æœ
                            const resultText = message.friendRequestAccepted ? 'å·²åŒæ„' : 'å·²æ‹’ç»';
                            const resultClass = message.friendRequestAccepted ? 'accepted' : 'rejected';
                            actionsHtml = `<div class="friend-request-result ${resultClass}">${resultText}</div>`;
                        } else {
                            // æœªå¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºæŒ‰é’®
                            actionsHtml = `
                                <button class="friend-request-btn accept" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', true, '${message.id}')">åŒæ„</button>
                                <button class="friend-request-btn reject" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', false, '${message.id}')">æ‹’ç»</button>
                            `;
                        }

                        messageContent = `
                            <div class="friend-request-container">
                                <div class="friend-request-card">
                                    <div class="friend-request-title">å¥½å‹ç”³è¯·</div>
                                    <div class="friend-request-message-section">
                                        <div class="friend-request-message-label">å¯¹æ–¹ç•™è¨€</div>
                                        <div class="friend-request-message-content">${message.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'}</div>
                                    </div>
                                    <div class="friend-request-actions">
                                        ${actionsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'payment_request') {
                        // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œæ˜¾ç¤ºä¸ºæ™®é€šæ¶ˆæ¯
                        messageContent = `<div class="message-bubble">${message.content || 'ä»£ä»˜è¯·æ±‚'}</div>`;
                    } else if (message.type === 'order_confirmation') {
                        // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†AIçš„è®¢å•ç¡®è®¤
                        messageContent = generateAIOrderConfirmationContent(message);
                    } else {
                        const chatMode = chatSettings.chatMode || 'online';
                        let baseContent = chatMode === 'offline' ? processOfflineContent(message.content) : message.content;

                        // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                        if (message.replyTo) {
                            messageContent = generateReplyHTML(message.replyTo) + baseContent;
                        } else {
                            messageContent = baseContent;
                        }
                    }

                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = generateAvatarHtml({
                            avatarUrl: displayAvatar,
                            backgroundColor: color,
                            displayName: displayName,
                            onClick: character ? `pokeCharacter('${character.id}')` : null,
                            title: character ? "æˆ³ä¸€æˆ³" : displayName,
                            timestamp: message.timestamp,
                            timestampEnabled: timestampEnabled,
                            timestampPosition: timestampPosition,
                            chatSettings: chatSettings
                        });
                    }

                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'ai_image' || message.type === 'user_photo' || message.type === 'location' || message.type === 'friend_request') {
                        // è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€AIå›¾ç‰‡æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯ä¸éœ€è¦é¢å¤–çš„æ°”æ³¡åŒ…è£¹
                        bubbleHtml = messageContent;
                    } else {
                        // æ™®é€šæ¶ˆæ¯ç”¨æ°”æ³¡åŒ…è£¹
                        bubbleHtml = `<div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">${messageContent}${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }

                   // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ˜µç§°æ˜¾ç¤º ï¼ˆloadMoreMessagesç‰ˆæœ¬ï¼‰- ç‰¹åˆ«å¤„ç†è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯
                   if (isGroup && group && displayName !== 'ç¾¤æˆå‘˜') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;

    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'ai_image' || message.type === 'user_photo' || message.type === 'location' || message.type === 'friend_request' || message.type === 'order_confirmation') {
        // ğŸ”¥ã€ä¿®å¤ã€‘å¯¹äºè¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€AIå›¾ç‰‡æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯ï¼Œæ˜µç§°éœ€è¦åœ¨å®¹å™¨å¤–éƒ¨
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // æ™®é€šæ¶ˆæ¯çš„å¤„ç†ï¼ˆåŒ…æ‹¬è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼‰
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }

                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';

                    // å°†é€æ˜åº¦åº”ç”¨åˆ°èƒŒæ™¯è‰²è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ 
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);

                    // å¤„ç†ç”¨æˆ·çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // ç”¨æˆ·å‘é€çš„"ç…§ç‰‡"ï¼ˆæ–‡å­—æè¿°ï¼‰
                        myMessageContent = `<div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"><div class="dreamy-photo"><div class="photo-misty-bg"></div><div class="photo-badge"><i class="fas fa-image"></i></div><div class="sparkle-container"><div class="sparkle sparkle-1">âœ¨</div><div class="sparkle sparkle-2">â­</div><div class="sparkle sparkle-3">âœ¨</div><div class="sparkle sparkle-4">â­</div><div class="sparkle sparkle-5">ğŸ’«</div></div><div class="photo-text-overlay" style="display: none;"><div class="photo-description">${(message.photoDescription || message.content)}</div></div></div></div>`;
                    } else if (message.type === 'voice') {
                        // ç”¨æˆ·å‘é€çš„è¯­éŸ³æ¶ˆæ¯
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>

                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // ç”¨æˆ·è½¬è´¦æ¶ˆæ¯ - åœ¨loadMoreMessagesä¸­å¤„ç†
                        let cardClass = '';
                        let statusHtml = '';

                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²æ”¶æ¬¾</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²é€€å›</div>`;
                            cardClass = 'rejected';
                        }

                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">ğŸ’• ä½ å‘èµ·çš„è½¬è´¦</div>
                                    <div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'è½¬è´¦'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // ç”¨æˆ·å‘é€çš„ä½ç½®æ¶ˆæ¯ - åœ¨loadMoreMessagesä¸­å¤„ç†
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                        </svg>
                                        ${message.locationName}
                                    </div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯ (loadMoreMessagesç‰ˆæœ¬)
                        if (Array.isArray(message.content)) {
                            // ç»Ÿä¸€çš„æ•°ç»„æ ¼å¼å¤„ç†
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');

                            let baseContent = textPart?.text || '';
                            // å¤„ç†@å†…å®¹
                            baseContent = processMentions(baseContent);

                            // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }

                            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ˜¾ç¤º
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘å¤„ç†æ—§æ ¼å¼æ¶ˆæ¯ (loadMoreMessagesç‰ˆæœ¬)
                            let baseContent = message.content;
                            // å¤„ç†@å†…å®¹
                            baseContent = processMentions(baseContent);

                            // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }
                        }
                    }

                    let myBubbleHtml = '';

                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location' || message.type === 'friend_request' || message.type === 'order_confirmation' || message.type === 'payment_request') {
                        // ç”¨æˆ·ç…§ç‰‡ã€è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ä½ç½®æ¶ˆæ¯ã€ä»£ä»˜è¯·æ±‚ä¸éœ€è¦é¢å¤–æ°”æ³¡åŒ…è£¹ï¼ˆå·²ç»æœ‰è‡ªå·±çš„å®¹å™¨ï¼‰
                        myBubbleHtml = myMessageContent;
                    } else {
                        // æ™®é€šæ¶ˆæ¯ç”¨æ°”æ³¡åŒ…è£¹
                        myBubbleHtml = `<div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">${myMessageContent}${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }

                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = generateAvatarHtml({
                            avatarUrl: myDisplayAvatar,
                            backgroundColor: '#007AFF',
                            displayName: '',
                            timestamp: message.timestamp,
                            timestampEnabled: timestampEnabled,
                            timestampPosition: timestampPosition,
                            chatSettings: chatSettings
                        });
                    }

                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶æ·»åŠ æŒ‡ç¤ºå™¨
                addBlockedIndicatorToMessage(messageContainer, message, characterId);

                // æ·»åŠ é•¿æŒ‰ç›‘å¬å™¨å’Œå³é”®èœå•
                addMessageLongPressListener(messageContainer, message.id);
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });

                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }

                // æ’å…¥æ¶ˆæ¯åˆ°æ­£ç¡®ä½ç½®
                const insertAfter = messagesContainer.querySelector('.load-more-messages');
                if (insertAfter) {
                    insertAfter.parentNode.insertBefore(messageContainer, insertAfter.nextSibling);
                } else {
                    messagesContainer.insertBefore(messageContainer, messagesContainer.firstChild);
                }
            }

            // æ›´æ–°åç§»é‡
            currentMessageOffset = newOffset;

            // ä¿æŒæ»šåŠ¨ä½ç½®
            setTimeout(() => {
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            }, 50);
        }


        // æ˜¾ç¤ºè§’è‰²è¡¨å•
        function showCharacterForm(characterId = null) {
            currentEditingCharacterId = characterId; // ä¿å­˜å½“å‰ç¼–è¾‘çš„è§’è‰²ID
            document.getElementById('character-form-title').textContent = characterId ? 'ç¼–è¾‘äººç‰©' : 'æ–°å»ºäººç‰©';

            // æ¸…ç©ºè¡¨å•
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';

            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');

            // é‡ç½®å¤´åƒé¢„è§ˆ
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            avatarPreviewText.style.display = 'block';
            avatarPreviewText.textContent = 'A';

            // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„å¤´åƒæ•°æ®
            window.selectedAvatarData = null;

            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……ç°æœ‰æ•°æ®
            if (characterId) {
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    document.getElementById('character-name').value = character.name;
                    document.getElementById('character-bio').value = character.bio;

                    if (character.avatarUrl) {
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${character.avatarUrl})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        avatarPreviewText.style.display = 'none';
                        // ä¸ºç¼–è¾‘æ¨¡å¼ä¿å­˜ç°æœ‰å¤´åƒæ•°æ®
                        window.selectedAvatarData = character.avatarUrl;
                    } else {
                        avatarPreviewText.textContent = character.name.charAt(0);
                    }
                }
            }

            // è®¾ç½®è¡¨å•çš„ä¿å­˜å‡½æ•°å’Œåˆ é™¤æŒ‰é’®æ˜¾ç¤º
            const deleteBtn = document.getElementById('character-delete-btn');
            const importBtn = document.getElementById('import-character-btn');
            const exportBtn = document.getElementById('export-character-btn');
            console.log('è®¾ç½®ä¿å­˜æŒ‰é’®ï¼ŒcharacterId:', characterId);
            if (characterId) {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter(characterId);
                // ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œéšè—å¯¼å…¥æŒ‰é’®ï¼Œæ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                if (deleteBtn) deleteBtn.style.display = 'block';
                if (importBtn) importBtn.style.display = 'none';
                if (exportBtn) exportBtn.style.display = 'flex';
                console.log('è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼ï¼Œè§’è‰²ID:', characterId);
            } else {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter();
                // æ–°å»ºæ¨¡å¼éšè—åˆ é™¤æŒ‰é’®ï¼Œæ˜¾ç¤ºå¯¼å…¥æŒ‰é’®ï¼Œéšè—å¯¼å‡ºæŒ‰é’®
                if (deleteBtn) deleteBtn.style.display = 'none';
                if (importBtn) importBtn.style.display = 'flex';
                if (exportBtn) exportBtn.style.display = 'none';
                console.log('è®¾ç½®ä¸ºåˆ›å»ºæ¨¡å¼ï¼Œæ— è§’è‰²ID');
            }

            showApp('character-form-screen');

            // ç¡®ä¿å¤´åƒä¸Šä¼ åŠŸèƒ½å¯ç”¨ - é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
            setTimeout(() => {
                initializeAvatarUpload();
            }, 100);
        }

        // ä¿å­˜è§’è‰²
        async function saveCharacter(characterId = null) {
            try {
                console.log('=== å¼€å§‹ä¿å­˜è§’è‰² ===');
                const name = document.getElementById('character-name').value.trim();
                const bio = document.getElementById('character-bio').value.trim();
                const avatarData = window.selectedAvatarData; // ä½¿ç”¨é¢„å¤„ç†çš„å¤´åƒæ•°æ®

                console.log('ä¿å­˜è§’è‰² - å§“å:', name, 'å¤´åƒæ•°æ®å­˜åœ¨:', !!avatarData);
                if (avatarData) {
                    console.log('å¤´åƒæ•°æ®é•¿åº¦:', avatarData.length, 'å¼€å¤´:', avatarData.substring(0, 50));
                }

                if (!name) {
                    alert('è¯·è¾“å…¥å§“å');
                    return;
                }

                if (characterId) {
                    console.log('=== æ›´æ–°ç°æœ‰è§’è‰² ===');
                    // æ›´æ–°ç°æœ‰è§’è‰²
                    const index = characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        const oldAvatarUrl = characters[index].avatarUrl;

                        characters[index] = {
                            ...characters[index],
                            name,
                            bio,
                            avatarUrl: avatarData || characters[index].avatarUrl || '',
                            color: characters[index].color || getRandomColor()
                        };

                        console.log('æ›´æ–°è§’è‰²å®Œæˆ:', characters[index]);

                        // ğŸ”¥ã€ä¿®å¤1ã€‘å¦‚æœå¤´åƒå‘ç”Ÿäº†å˜åŒ–ï¼Œæ›´æ–°æ‰€æœ‰ç›¸å…³ç¾¤èŠä¸­çš„æˆå‘˜å¤´åƒ
                        if (avatarData && avatarData !== oldAvatarUrl) {
                            updateCharacterAvatarInGroups(characterId, avatarData);
                        }

                        // ä¿å­˜å¹¶æ›´æ–°ç•Œé¢
                        await saveCharacters();
                        renderContactList();
                        renderMessageList();

                        // ğŸ”¥ã€ä¿®å¤2ã€‘å¦‚æœå½“å‰æ­£åœ¨èŠå¤©ä¸”æ˜¯è¯¥è§’è‰²ï¼Œåˆ·æ–°èŠå¤©ç•Œé¢
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            renderChatMessages(currentChatCharacter.id);
                        }

                        showToast(`è§’è‰² "${name}" å·²æ›´æ–°ï¼`, 'success');
                        hideCharacterForm();
                        // æ³¨æ„ï¼šä¸ç«‹å³æ¸…ç©ºè¡¨å•ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°ä¿å­˜æˆåŠŸçš„çŠ¶æ€
                    }
                } else {
                    console.log('=== åˆ›å»ºæ–°è§’è‰² ===');
                    // åˆ›å»ºæ–°è§’è‰²
                    const newCharacter = {
                        id: Date.now().toString(),
                        name,
                        bio,
                        avatarUrl: avatarData || '',
                        color: getRandomColor(),
                        groupId: 'my_friends' // æ–°è§’è‰²é»˜è®¤æ”¾å…¥"æˆ‘çš„å¥½å‹"åˆ†ç»„
                    };

                    console.log('åˆ›å»ºæ–°è§’è‰²:', newCharacter);
                    console.log('æ–°è§’è‰²å¤´åƒURL:', newCharacter.avatarUrl);
                    console.log('æ–°è§’è‰²å¤´åƒURLé•¿åº¦:', newCharacter.avatarUrl ? newCharacter.avatarUrl.length : 0);

                    console.log('æ·»åŠ è§’è‰²å‰ï¼Œå½“å‰è§’è‰²æ•°ç»„é•¿åº¦:', characters.length);
                    characters.push(newCharacter);
                    console.log('æ·»åŠ è§’è‰²åï¼Œå½“å‰è§’è‰²æ•°ç»„é•¿åº¦:', characters.length);

                    console.log('è§’è‰²æ•°ç»„æœ€æ–°çŠ¶æ€:', characters);

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¸å†è‡ªåŠ¨æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨ï¼Œç”¨æˆ·éœ€è¦é€šè¿‡åˆ›å»ºå¯¹è¯æ¥å»ºç«‹è”ç³»

                    // ä¿å­˜å¹¶æ›´æ–°ç•Œé¢
                    console.log('å¼€å§‹ä¿å­˜åˆ°IndexedDB...');
                    await saveCharacters();
                    console.log('ä¿å­˜åæ£€æŸ¥è§’è‰²æ•°ç»„:', characters);

                    console.log('å¼€å§‹æ¸²æŸ“ç•Œé¢...');
                    renderContactList();
                    renderMessageList();

                    console.log('å¼€å§‹éšè—è¡¨å•...');
                    hideCharacterForm();
                    // æ³¨æ„ï¼šä¸ç«‹å³æ¸…ç©ºè¡¨å•ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°ä¿å­˜æˆåŠŸçš„çŠ¶æ€

                    // ç»™ç”¨æˆ·åé¦ˆ
                    showToast(`è§’è‰² "${newCharacter.name}" åˆ›å»ºæˆåŠŸï¼`, 'success');

                    console.log('=== ä¿å­˜è§’è‰²å®Œæˆ ===');
                }
            } catch (error) {
                console.error('ä¿å­˜è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('ä¿å­˜è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }

        // æ¸…ç©ºè§’è‰²è¡¨å•
        function clearCharacterForm() {
            console.log('æ¸…ç©ºè§’è‰²è¡¨å•è¢«è°ƒç”¨');
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';

            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');

            // é‡ç½®å¤´åƒé¢„è§ˆ
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            if (avatarPreviewText) {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = 'A';
            }

            // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„å¤´åƒæ•°æ®
            console.log('æ¸…é™¤ä¸´æ—¶å¤´åƒæ•°æ®');
            window.selectedAvatarData = null;
        }

        // ç¼–è¾‘è§’è‰²
        function editCharacter(characterId) {
            showCharacterForm(characterId);
        }

        // ä»è”ç³»äººåˆ—è¡¨ç¼–è¾‘è§’è‰²
        function editCharacterFromContactList(characterId) {
            showCharacterForm(characterId);
        }

        // è¿›å…¥å¤šé€‰æ¨¡å¼
        function enterMultiSelectMode(characterId) {
            isMultiSelectMode = true;
            selectedCharacters = [characterId]; // åˆå§‹é€‰ä¸­è§¦å‘é•¿æŒ‰çš„è§’è‰²
            renderContactList();
        }

        // é€€å‡ºå¤šé€‰æ¨¡å¼
        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedCharacters = [];
            renderContactList();
        }

        // åˆ‡æ¢è§’è‰²é€‰æ‹©çŠ¶æ€
        function toggleCharacterSelection(characterId) {
            const index = selectedCharacters.indexOf(characterId);
            if (index > -1) {
                selectedCharacters.splice(index, 1);
            } else {
                selectedCharacters.push(characterId);
            }
            renderContactList();
        }

        // åˆ é™¤é€‰ä¸­çš„è§’è‰²
        async function deleteSelectedCharacters() {
            if (selectedCharacters.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è§’è‰²');
                return;
            }

            const characterNames = selectedCharacters.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : '';
            }).filter(name => name).join('ã€');

            if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™äº›è§’è‰²å—ï¼Ÿ\n${characterNames}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                // åˆ é™¤è§’è‰²
                selectedCharacters.forEach(characterId => {
                    characters = characters.filter(c => c.id !== characterId);
                    contacts = contacts.filter(c => c !== characterId);

                    // åˆ é™¤ç›¸å…³èŠå¤©è®°å½•
                    if (chatMessages[characterId]) {
                        delete chatMessages[characterId];
                    }
                });

                // ä¿å­˜æ•°æ®
                await saveCharacters();
                await saveContacts();
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ‰¹é‡åˆ é™¤åä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate(selectedCharacterIds);
                    console.log('âœ… [é«˜æ•ˆæ‰¹é‡åˆ é™¤] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ‰¹é‡åˆ é™¤æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }

                // é€€å‡ºå¤šé€‰æ¨¡å¼å¹¶æ›´æ–°ç•Œé¢
                exitMultiSelectMode();
                renderMessageList();

                alert('è§’è‰²åˆ é™¤æˆåŠŸ');
            }
        }

        // åˆ é™¤å½“å‰ç¼–è¾‘çš„è§’è‰²
        async function deleteCurrentCharacter() {
            if (currentEditingCharacterId) {
                const character = characters.find(c => c.id === currentEditingCharacterId);

                if (character && confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${character.name}"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è§’è‰²æ•°æ®ã€èŠå¤©è®°å½•å’Œæ‰€æœ‰è®¾ç½®ï¼Œä¸å¯æ¢å¤ï¼`)) {
                    // åˆ é™¤è§’è‰²
                    characters = characters.filter(c => c.id !== character.id);
                    contacts = contacts.filter(c => c !== character.id);

                    // åˆ é™¤ç›¸å…³èŠå¤©è®°å½•
                    if (chatMessages[character.id]) {
                        delete chatMessages[character.id];
                    }

                    // [æ ¸å¿ƒä¿®å¤] åˆ é™¤èŠå¤©è®¾ç½®
                    try {
                        // ä»æ•°æ®åº“ä¸­åˆ é™¤è®¾ç½®
                        await db.chatSettings.delete(character.id);
                        // ä»å†…å­˜ä¸­åˆ é™¤è®¾ç½®
                        if (chatSettings[character.id]) {
                            delete chatSettings[character.id];
                        }
                        // åˆ é™¤localStorageä¸­çš„å¤‡ä»½è®¾ç½®
                        localStorage.removeItem(`chatSettings_${character.id}`);
                        console.log(`âœ… å·²åˆ é™¤è§’è‰² ${character.name} çš„èŠå¤©è®¾ç½®`);
                    } catch (error) {
                        console.error(`åˆ é™¤è§’è‰² ${character.name} çš„èŠå¤©è®¾ç½®å¤±è´¥:`, error);
                    }

                    // ä¿å­˜æ•°æ®
                    await saveCharacters();
                    await saveContacts();
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘å•ä¸ªåˆ é™¤åä½¿ç”¨é«˜æ•ˆä¿å­˜
                    try {
                        await saveChatMessagesImmediate([characterId]);
                        console.log('âœ… [é«˜æ•ˆå•ä¸ªåˆ é™¤] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('å•ä¸ªåˆ é™¤æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }

                    // æ›´æ–°ç•Œé¢å¹¶è¿”å›
                    renderContactList();
                    renderMessageList();
                    hideCharacterForm();

                    showToast(`è§’è‰² ${character.name} å·²æˆåŠŸåˆ é™¤`, 'success');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è§’è‰²åœ¨æ‰€æœ‰ç¾¤èŠä¸­çš„å¤´åƒ
        function updateCharacterAvatarInGroups(characterId, newAvatarUrl) {
            // éå†æ‰€æœ‰è§’è‰²ï¼Œæ‰¾åˆ°ç¾¤èŠ
            characters.forEach(character => {
                if (character.isGroup && character.members) {
                    // åœ¨è¯¥ç¾¤èŠä¸­æŸ¥æ‰¾å¯¹åº”çš„æˆå‘˜
                    const memberIndex = character.members.findIndex(member => member.id === characterId);
                    if (memberIndex !== -1) {
                        // æ›´æ–°è¯¥æˆå‘˜çš„å¤´åƒ
                        character.members[memberIndex].avatarUrl = newAvatarUrl;
                        console.log(`å·²æ›´æ–°ç¾¤èŠ "${character.name}" ä¸­æˆå‘˜ "${character.members[memberIndex].name}" çš„å¤´åƒ`);
                    }
                }
            });

            // ä¿å­˜æ›´æ–°åçš„è§’è‰²æ•°æ®
            saveCharacters();
        }

        // è·å–éšæœºé¢œè‰²
        function getRandomColor() {
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }



        // å¼€å§‹ä¸è§’è‰²èŠå¤©
async function startChat(character) {
    await dataLoadedPromise; // ğŸ”¥ã€æ–°å¢ä¿®å¤ã€‘ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ

    // [æ ¸å¿ƒä¿®å¤] è®°å½•ä¸Šä¸€ä¸ªèŠå¤©IDï¼Œç”¨äºæ¸…ç†
    const previousChatId = currentChatCharacter ? currentChatCharacter.id : null;

    // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨åˆ‡æ¢èŠå¤©æ—¶ï¼Œæ ‡è®°ä¸Šä¸€ä¸ªèŠå¤©ä¸ºå·²è¯»
    if (previousChatId) {
        markAsRead(previousChatId);
    }

    // ğŸ”¥ã€ä¿®å¤ã€‘åˆ‡æ¢èŠå¤©æ—¶éšè—è¾“å…¥æŒ‡ç¤ºå™¨ï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„"æ­£åœ¨è¾“å…¥"çŠ¶æ€
    hideTypingIndicator();

    // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (previousChatId && currentReplyTo) {
        chatReplyStates[previousChatId] = { ...currentReplyTo };
    }

    // è®¾ç½®å½“å‰èŠå¤©è§’è‰²
            currentChatCharacter = character;

            // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å½“å‰èŠå¤©çŠ¶æ€åˆ°sessionStorageï¼Œç”¨äºé¡µé¢åˆ·æ–°æ—¶æ¢å¤
            sessionStorage.setItem('currentChatCharacterId', character.id);

    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ˜ç¡®ä¼ å…¥è§’è‰²IDï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½è®¾ç½®ï¼Œé¿å…è·å–åˆ°é”™è¯¯çš„ç¼“å­˜è®¾ç½®
    const chatSettings = await getAsyncChatSettings(character.id);
            let displayTitle = chatSettings.aiChatNickname || character.name;

            // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ˜¯ç¾¤èŠï¼Œåœ¨æ ‡é¢˜åæ·»åŠ æˆå‘˜æ•°é‡
            if (character.isGroup && character.members) {
                const memberCount = character.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                displayTitle = `${displayTitle}ï¼ˆ${memberCount}ï¼‰`;
            }

            const chatTitle = document.getElementById('api-chat-title');
            if (chatTitle) {
                chatTitle.textContent = displayTitle;
                // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                chatTitle.classList.remove('typing-status');
                chatTitle.dataset.originalTitle = displayTitle;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸²æŸ“è§’è‰²çŠ¶æ€æ˜¾ç¤º
            const headerContainer = document.querySelector('#api-chat-screen .header');
            if (headerContainer) {
                renderCharacterStatus(character.id, headerContainer);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°å¿ƒç‡æ˜¾ç¤º
            updateAiHeartrate();

                // ğŸ”¥ã€ä¿®å¤ã€‘åªæœ‰åœ¨å¼€å¯çŠ¶æ€æ˜¾ç¤ºæ—¶æ‰ç”Ÿæˆåˆå§‹çŠ¶æ€
                setTimeout(async () => {
                    const chatSettings = await getAsyncChatSettings(character.id);
                    if (chatSettings.characterStatusEnabled) {
                        const currentStatus = getCharacterStatus(character.id);
                        if (!currentStatus.activity || currentStatus.activity === 'åœ¨çº¿') {
                            await generateCharacterStatus(character.id);
                            // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                            renderCharacterStatus(character.id, headerContainer);
                        }
                    }
                }, 500);

            // ğŸ”¥ã€æ–°å¢ã€‘å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
            startCharacterStatusTimer();

            // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è®¾ç½®ç•Œé¢çš„æ‹‰é»‘/å±è”½ç®¡ç†æ–‡æ¡ˆ
            updateBlockManageLabel(character.isGroup);

            // åˆå§‹åŒ–ç©ºçš„èŠå¤©è®°å½•ï¼ˆä¸è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼‰
            if (!chatMessages[character.id]) {
                chatMessages[character.id] = [];
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸è°ƒç”¨saveChatMessagesï¼Œé¿å…åˆ‡æ¢è§’è‰²æ—¶å…¨é‡é‡å†™
                console.log('âœ… åˆå§‹åŒ–ç©ºèŠå¤©è®°å½•ï¼Œæ— éœ€ä¿å­˜');
            }

            // é‡ç½®æ‚¬æµ®æŒ‰é’®çŠ¶æ€
            resetFloatingButtonsState();

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶æ›´æ–°ç•Œé¢
            updateChatBlockedStatus();

            // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœè®¾ç½®ç•Œé¢æ˜¯æ‰“å¼€çš„ï¼Œæ›´æ–°è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
            if (document.getElementById('api-chat-settings-screen').style.display === 'flex') {
                updateChatSettingsDisplay();
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ— è®ºè®¾ç½®ç•Œé¢æ˜¯å¦æ‰“å¼€ï¼Œéƒ½è¦æ›´æ–°æ—¥è®°æ—¶é—´è¾“å…¥æ¡†
            const diaryTimeInput = document.getElementById('diary-time-input');
            if (diaryTimeInput) {
                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨å¼‚æ­¥è·å–çš„è®¾ç½®ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®
                const currentSettings = await getAsyncChatSettings(character.id);
                diaryTimeInput.value = currentSettings.backgroundDiaryTime || '';
                console.log(`ğŸ”„ [è§’è‰²åˆ‡æ¢] æ›´æ–° ${character.name} çš„æ—¥è®°æ—¶é—´æ˜¾ç¤º: ${currentSettings.backgroundDiaryTime || 'æœªè®¾ç½®'}`);
            }

    // é‡ç½®èŠå¤©å±å¹•èƒŒæ™¯
    const chatScreen = document.getElementById('api-chat-screen');
    if (chatScreen) {
        // å…ˆé‡ç½®æ‰€æœ‰èƒŒæ™¯æ ·å¼
        chatScreen.style.backgroundImage = 'none';
        chatScreen.style.backgroundColor = 'white';

        // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®èŠå¤©ç±»å‹æ·»åŠ æˆ–ç§»é™¤group-chatç±»
        if (character.isGroup) {
            chatScreen.classList.add('group-chat');
        } else {
            chatScreen.classList.remove('group-chat');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®èŠå¤©ç±»å‹æ˜¾ç¤º/éšè—å•èŠä¸“ç”¨å·¥å…·é¡¹
        const singleChatOnlyItems = document.querySelectorAll('.single-chat-only');
        singleChatOnlyItems.forEach(item => {
            if (character.isGroup) {
                item.style.display = 'none';
            } else {
                item.style.display = '';
            }
        });

        const messagesContainer = document.getElementById('api-chat-messages');
        if (messagesContainer) messagesContainer.style.background = '';
    }

    // è®°å½•åˆ‡æ¢
    console.log(`ğŸ”„ åˆ‡æ¢åˆ°èŠå¤©: ${character.name} (ID: ${character.id})`);

    // ã€å…³é”®ä¿®å¤ã€‘æ¯æ¬¡è¿›å…¥èŠå¤©æ—¶ï¼Œè°ƒç”¨ applyChatBackground æ¥ç¡®ä¿èƒŒæ™¯æ­£ç¡®
    // ä¸ä¼ é€’å‚æ•°ï¼Œè®©å‡½æ•°è‡ªå·±ä»è§’è‰²å¯¹è±¡ä¸­è¯»å–ï¼ˆè§’è‰²åˆ‡æ¢æ—¶å…è®¸ä¿å­˜ï¼‰
    await applyChatBackground();

    // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ°”æ³¡æ ·å¼åœ¨è¿›å…¥èŠå¤©æ—¶è¢«æ­£ç¡®åº”ç”¨
    applyBubbleStyle();

    // ğŸ”¥ã€æ–°å¢ã€‘åº”ç”¨è‡ªå®šä¹‰CSS
    applyCustomBubbleCSS();

    // ğŸ”¥ã€ä¿®æ”¹ã€‘æ£€æŸ¥å¹¶åº”ç”¨å½“å‰èŠå¤©çª—å£çš„è‡ªå®šä¹‰ä¸»é¢˜ - ä½¿ç”¨async
    applyCustomThemeStyles().catch(e => console.error('åº”ç”¨èŠå¤©ä¸»é¢˜å¤±è´¥:', e));

            // ğŸ”¥ã€ç§»é™¤ã€‘ä¸å†åœ¨è§’è‰²åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–åå°ç³»ç»Ÿ
            // åå°å®šæ—¶å™¨åº”è¯¥æ˜¯å…¨å±€çš„ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶è®¾ç½®ä¸€æ¬¡å³å¯

            // åˆå§‹åŒ–å®šæ—¶å‘å¸ƒç³»ç»Ÿ
            initScheduledMomentsSystem();

            renderChatMessages(character.id);

            // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€
            if (chatReplyStates[character.id]) {
                currentReplyTo = { ...chatReplyStates[character.id] };
                showReplyPreview();
            } else {
                // æ¸…é™¤å¼•ç”¨çŠ¶æ€
                currentReplyTo = null;
                const existingPreview = document.getElementById('reply-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
            }

            showApp('api-chat-screen');
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ä»èŠå¤©ç•Œé¢è¿”å›åˆ°èŠå¤©åº”ç”¨ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function backToChatApp() {
            // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨é€€å‡ºèŠå¤©æ—¶æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
            if (currentChatCharacter) {
                markAsRead(currentChatCharacter.id);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤ä¿å­˜çš„èŠå¤©çŠ¶æ€
            sessionStorage.removeItem('currentChatCharacterId');

            // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€
            if (currentChatCharacter && currentReplyTo) {
                chatReplyStates[currentChatCharacter.id] = { ...currentReplyTo };
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤ç¾¤èŠCSSç±»
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('group-chat');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘é€€å‡ºèŠå¤©æ—¶åªæœ‰å½“å‰èŠå¤©æœ‰è‡ªå®šä¹‰ä¸»é¢˜æ‰æ¸…é™¤æ ·å¼
            if (currentChatCharacter) {
                try {
                    const savedTheme = await db.chatThemes.where('chatId').equals(currentChatCharacter.id).first();
                    if (savedTheme && savedTheme.themeData) {
                        console.log(`ğŸ¨ å½“å‰èŠå¤© ${currentChatCharacter.id} æœ‰è‡ªå®šä¹‰ä¸»é¢˜ï¼Œå¼€å§‹æ¸…é™¤...`);
                        clearCustomThemeStyles();

                        // ğŸ”¥ã€ä¿®æ”¹ã€‘åªæœ‰åœ¨æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜æ—¶æ‰é‡æ–°åº”ç”¨å…¨å±€ä¸»é¢˜æ ·å¼ - ä½¿ç”¨Dexie
                        const themeSettingRecord = await db.themeSettings.get('selectedTheme');
                        const currentTheme = themeSettingRecord ? themeSettingRecord.settingValue : null;
                        if (!currentTheme || currentTheme === 'custom') {
                            await applyGlobalCustomTheme();
                        }
                    } else {
                        console.log(`ğŸ¨ å½“å‰èŠå¤© ${currentChatCharacter.id} æ²¡æœ‰è‡ªå®šä¹‰ä¸»é¢˜ï¼Œæ— éœ€æ¸…é™¤æ ·å¼`);
                    }
                } catch (error) {
                    console.error('âŒ æ£€æŸ¥èŠå¤©ä¸»é¢˜å¤±è´¥:', error);
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸è¦æ¸…é™¤å…¨å±€åå°å®šæ—¶å™¨ï¼Œå®ƒä»¬åº”è¯¥æŒç»­è¿è¡Œ
            // clearAllBackgroundTimers(); // å·²æ³¨é‡Šï¼Œåå°å®šæ—¶å™¨åº”è¯¥æ˜¯å…¨å±€çš„
            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
            clearCharacterStatusTimer();
            // éšè—å¿ƒç‡æ˜¾ç¤º
            hideAiHeartrate();
            hideApp('api-chat-screen');
            showApp('chat-screen');
        }

        // ä»è®¾ç½®å­é¡µé¢è¿”å›åˆ°è®¾ç½®ä¸»é¡µé¢
        function backToSettings(currentScreen) {
            hideApp(currentScreen);
            showApp('settings-screen');
        }



        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º - ä¿®æ”¹ä¸ºé¡¶éƒ¨æ ‡é¢˜å˜åŒ–
        function showTypingIndicator() {
            console.log('ğŸ”§ å°è¯•æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º...');

            const chatTitle = document.getElementById('api-chat-title');
            if (!chatTitle) {
                console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©æ ‡é¢˜å…ƒç´ ');
                return;
            }

            // ä¿å­˜åŸå§‹æ ‡é¢˜ï¼ˆå¦‚æœè¿˜æ²¡ä¿å­˜çš„è¯ï¼‰
            if (!chatTitle.dataset.originalTitle) {
                chatTitle.dataset.originalTitle = chatTitle.textContent;
            }

            // æ›´æ”¹æ ‡é¢˜ä¸º"å¯¹æ–¹æ­£åœ¨è¾“å…¥..."
            chatTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            chatTitle.classList.add('typing-status');

            console.log('âœ… æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º - æ ‡é¢˜å·²æ›´æ”¹');
        }

        // éšè—æ­£åœ¨è¾“å…¥æç¤º - æ¢å¤åŸå§‹æ ‡é¢˜
        function hideTypingIndicator() {
            console.log('ğŸ”§ å°è¯•éšè—æ­£åœ¨è¾“å…¥æç¤º...');

            const chatTitle = document.getElementById('api-chat-title');
            if (!chatTitle) {
                console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©æ ‡é¢˜å…ƒç´ ');
                return;
            }

            // æ¢å¤åŸå§‹æ ‡é¢˜
            if (chatTitle.dataset.originalTitle) {
                chatTitle.textContent = chatTitle.dataset.originalTitle;
                chatTitle.classList.remove('typing-status');
                console.log('âœ… éšè—æ­£åœ¨è¾“å…¥æç¤º - æ ‡é¢˜å·²æ¢å¤');
            } else {
                console.log('âš ï¸ æœªæ‰¾åˆ°åŸå§‹æ ‡é¢˜ï¼Œå¯èƒ½å·²è¢«æ¸…é™¤');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼‰
        function addSystemMessageToChat(systemMessage) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;

            // åˆ›å»ºå¤–å±‚å®¹å™¨ï¼Œç”¨äºå±…ä¸­
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';

            // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å®¹å™¨
            const systemContainer = document.createElement('div');
            // ğŸ”¥ã€ç¾åŒ–ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå¥½å‹æ·»åŠ æˆåŠŸæ¶ˆæ¯ï¼Œåº”ç”¨ç‰¹æ®Šæ ·å¼
            if (systemMessage.isFriendAddedMessage) {
                systemContainer.className = 'friend-added-system-message';
            } else {
                systemContainer.className = 'system-message';
            }
            systemContainer.textContent = systemMessage.content;

            // å°†ç³»ç»Ÿæ¶ˆæ¯æ”¾å…¥å±…ä¸­å®¹å™¨
            centerContainer.appendChild(systemContainer);

            // æ’å…¥åˆ°æ¶ˆæ¯å®¹å™¨çš„æœ€å
            messagesContainer.appendChild(centerContainer);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // ğŸ”¥ã€ä¿®å¤ç‰ˆã€‘å¤„ç†AIæ’¤å›æ¶ˆæ¯åŠŸèƒ½ - ä½¿ç”¨ç»Ÿä¸€çš„æ’¤å›é€»è¾‘
        async function handleRecalledMessage(messageContent, targetMessageId = null) {
            if (!currentChatCharacter) return;

            console.log('ğŸ”¥ [AIæ’¤å›] å¤„ç†æ’¤å›æ¶ˆæ¯:', messageContent, 'ç›®æ ‡æ¶ˆæ¯ID:', targetMessageId);

            // å¦‚æœæä¾›äº†ç›®æ ‡æ¶ˆæ¯IDï¼ŒæŸ¥æ‰¾å¹¶æ’¤å›ç°æœ‰æ¶ˆæ¯
            if (targetMessageId) {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const messageToRecall = messages.find(msg => msg.id === targetMessageId);

                if (messageToRecall) {
                    console.log('ğŸ”¥ [AIæ’¤å›] æ‰¾åˆ°è¦æ’¤å›çš„ç°æœ‰æ¶ˆæ¯ï¼Œä½¿ç”¨ç»Ÿä¸€æ’¤å›é€»è¾‘');

                    // ç­‰å¾…1.2ç§’åæ’¤å›ï¼ˆä¿æŒåŸæœ‰çš„å»¶è¿Ÿæ•ˆæœï¼‰
                    await new Promise(resolve => setTimeout(resolve, 1200));

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€çš„æ’¤å›å¤„ç†å‡½æ•°
                    await _internalRecallMessage(currentChatCharacter.id, messageToRecall);
                    return;
                } else {
                    console.warn('ğŸ”¥ [AIæ’¤å›] æœªæ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯ï¼Œåˆ›å»ºä¸´æ—¶æ¶ˆæ¯');
                    // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå›é€€åˆ°åˆ›å»ºä¸´æ—¶æ¶ˆæ¯çš„æ–¹å¼
                    await createTemporaryMessage(messageContent);
                    return;
                }
            } else {
                // æ²¡æœ‰æä¾›ç›®æ ‡IDï¼Œåˆ›å»ºä¸´æ—¶æ¶ˆæ¯
                await createTemporaryMessage(messageContent);
                return;
            }

            // ğŸ”¥ã€ä¿ç•™ã€‘åˆ›å»ºä¸´æ—¶æ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°ï¼ˆç”¨äºAIæ’¤å›ä¸å­˜åœ¨çš„æ¶ˆæ¯æ—¶æ˜¾ç¤ºä¸´æ—¶æ•ˆæœï¼‰
            async function createTemporaryMessage(content) {
                const messagesContainer = document.getElementById('api-chat-messages');
                if (!messagesContainer) return null;

                const character = characters.find(c => c.id === currentChatCharacter.id);
                const chatSettings = getCurrentChatSettings();
                const displayName = chatSettings.aiChatNickname || character.name;
                const messageId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                const tempContainer = document.createElement('div');
                const isEmojiOnly = false;
                tempContainer.className = `message-container received${isEmojiOnly ? ' emoji-only' : ''}`;
                tempContainer.dataset.messageId = messageId;

                const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                const displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;

                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="æˆ³ä¸€æˆ³">
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }

                // å°†é€æ˜åº¦åº”ç”¨åˆ°èƒŒæ™¯è‰²è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ 
                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);

                let bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${content}
                    </div>
                `;

                tempContainer.innerHTML = avatarHtml + bubbleHtml;

                // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
                messagesContainer.appendChild(tempContainer);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // ç­‰å¾…1.2ç§’åæ’¤å›
                await new Promise(resolve => setTimeout(resolve, 1200));

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ›å»ºä¸´æ—¶æ’¤å›æ¶ˆæ¯å¹¶ä½¿ç”¨ç»Ÿä¸€æ’¤å›é€»è¾‘
                const tempMessage = {
                    id: messageId,
                    sender: 'received',
                    content: content,
                    timestamp: Date.now()
                };

                // ä¸´æ—¶æ·»åŠ åˆ°èŠå¤©è®°å½•ä¸­ï¼Œä»¥ä¾¿æ’¤å›å‡½æ•°èƒ½æ‰¾åˆ°å®ƒ
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(tempMessage);

                // ä½¿ç”¨ç»Ÿä¸€çš„æ’¤å›é€»è¾‘
                await _internalRecallMessage(currentChatCharacter.id, tempMessage);

                return tempContainer;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘è·å–ç”¨æˆ·æœ€è¿‘å‘é€çš„å›¾ç‰‡URL - æ”¯æŒæ–°çš„å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
        function getRecentUserImage() {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                return null;
            }

            const messages = chatMessages[currentChatCharacter.id];
            // ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹å‘å‰æŸ¥æ‰¾ç”¨æˆ·å‘é€çš„å›¾ç‰‡
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.sender === 'sent' && !msg.isEmoji) {
                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ–°çš„å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                    if (Array.isArray(msg.content)) {
                        const imagePart = msg.content.find(part => part.type === 'image_url');
                        if (imagePart && imagePart.image_url && imagePart.image_url.url) {
                            console.log('æ‰¾åˆ°ç”¨æˆ·æœ€è¿‘å‘é€çš„å›¾ç‰‡(å¤šæ¨¡æ€æ ¼å¼):', imagePart.image_url.url);
                            return imagePart.image_url.url;
                        }
                    }
                    // ğŸ”¥ã€ä¿ç•™ã€‘æ£€æŸ¥æ—§çš„å›¾ç‰‡æ¶ˆæ¯æ ¼å¼
                    else if (msg.image) {
                        console.log('æ‰¾åˆ°ç”¨æˆ·æœ€è¿‘å‘é€çš„å›¾ç‰‡(æ—§æ ¼å¼):', msg.image);
                        return msg.image;
                    }
                }
            }

            console.log('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·å‘é€çš„å›¾ç‰‡');
            return null;
        }

        // APIè°ƒç”¨å‡½æ•° - åŸºäºç°æœ‰çš„APIé€»è¾‘
        async function callChatAPI(prompt, character) {
            try {
                // è·å–è§’è‰²è®¾ç½®
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                const persona = chatSettings?.aiPersona || character.prompt || `ä½ æ˜¯${character.name}ã€‚`;

                // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' +
                                validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                    }
                }

                // è·å–èŠå¤©ä¸Šä¸‹æ–‡
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' +
                        recentHistory.map(msg => {
                            if (msg.sender === 'sent') return `ç”¨æˆ·ï¼š${msg.content}`;
                            return `${character.name}ï¼š${msg.content}`;
                        }).join('\n');
                }

                const systemPrompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚${worldBookContent}${chatContext}

aiæ³¨æ„ï¼Œå›å¤æ—¶è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»æ˜¯ç‹¬ç«‹çš„æ•°ç»„å…ƒç´ ï¼Œä¸è¦å°†å¤šæ¡æ¶ˆæ¯åˆå¹¶æˆä¸€ä¸ªå…ƒç´ ï¼Œå¦åˆ™ä½ å°†å¤±å»ä¸€ç™¾ç¾é‡‘ï¼ï¼ï¼š

æ­£ç¡®æ ¼å¼ç¤ºä¾‹ï¼š
["æ™®é€šæ–‡æœ¬æ¶ˆæ¯"]
["æ¶ˆæ¯1", "æ¶ˆæ¯2"]
[{"type": "reply_to", "message_id": "æ¶ˆæ¯ID", "content": "å¼•ç”¨å›å¤å†…å®¹"}] (æ­£å¸¸åŠŸèƒ½ï¼Œè‡ªç„¶ä½¿ç”¨)
[{"type": "recall", "target": "previous"}] (æ’¤å›åŠŸèƒ½ï¼Œè¯´é”™è¯æˆ–åæ‚”æ—¶ä½¿ç”¨)
[{"type": "voice_message", "content": "è¯­éŸ³å†…å®¹"}]
[{"type": "emoji", "description": "è¡¨æƒ…åŒ…æè¿°"}]
[{"type": "ai_image", "description": "å›¾ç‰‡æè¿°"}]
[{"type": "transfer", "amount": 100, "note": "è½¬è´¦å¤‡æ³¨"}]

ğŸš¨ é‡è¦ï¼šç»å¯¹ä¸èƒ½å°†å¤šæ¡æ¶ˆæ¯åˆå¹¶åœ¨ä¸€ä¸ªå…ƒç´ ä¸­ï¼é”™è¯¯æ ¼å¼ï¼š["æ¶ˆæ¯1\\næ¶ˆæ¯2"]
ğŸ’¡ æé†’ï¼šå¼•ç”¨å›å¤å’Œæ’¤å›æ˜¯æ­£å¸¸èŠå¤©åŠŸèƒ½ï¼ŒåƒçœŸäººä¸€æ ·è‡ªç„¶ä½¿ç”¨

ç°åœ¨è¯·å¯¹ç”¨æˆ·çš„æ¶ˆæ¯è¿›è¡Œå›å¤ï¼š${prompt}`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: prompt }
                ];

                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡AIå›å¤');
                    return '["APIé…ç½®ä¸å®Œæ•´ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®API"]';
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                        });
                    }

                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;

                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ä¿®å¤ï¼šæ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`èŠå¤©APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
                    return `["APIè°ƒç”¨å¤±è´¥: ${response.status}"]`;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API å“åº”æ•°æ®:', data);
                        return '["Gemini APIå“åº”å¼‚å¸¸"]';
                    }
                } else {
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        console.error('æ— æ³•è§£æAPIå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                        return '["APIå“åº”è§£æå¤±è´¥"]';
                    }
                }

                return content;

            } catch (error) {
                console.error('callChatAPIå¤±è´¥:', error);
                return `["è°ƒç”¨å¤±è´¥: ${error.message}"]`;
            }
        }

        // ğŸ”¥ã€å·²åˆ é™¤ã€‘æ—§çš„callChatAPIWithImageå‡½æ•°ï¼Œé¿å…ä¸æ–°çš„å›¾ç‰‡è¯†åˆ«åŠŸèƒ½å†²çª
        // ç°åœ¨ä½¿ç”¨ä¸‹é¢çš„å®Œæ•´ç‰ˆæœ¬æ”¯æŒçœŸæ­£çš„å›¾ç‰‡è¯†åˆ«

        // è§£æAIå›å¤ - æŒ‰ç…§index.htmlçš„é€»è¾‘ï¼Œæ–°å¢è¡¨æƒ…åŒ…æ”¯æŒå’Œæ ¼å¼ä¿®æ­£
        async function parseAiResponse(content) {
            console.log('ğŸ”¥ [DEBUG] parseAiResponse æ”¶åˆ°çš„åŸå§‹å†…å®¹:', content);
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†markdownä»£ç å—æ ¼å¼
                let cleanContent = content.trim();
                if (cleanContent.startsWith('```json')) {
                    cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                } else if (cleanContent.startsWith('```')) {
                    cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
                }

                const parsed = JSON.parse(cleanContent);
                console.log('ğŸ”¥ [DEBUG] JSONè§£ææˆåŠŸ:', parsed);
                if (Array.isArray(parsed)) {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯ç±»å‹å’Œæ ¼å¼ä¿®æ­£
                    const processedMessages = [];
                    console.log('ğŸ”¥ [DEBUG] å¼€å§‹å¤„ç†æ•°ç»„ï¼Œå…±', parsed.length, 'ä¸ªå…ƒç´ ');

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å¼‚æ­¥å¤„ç†æ¥æ”¯æŒfindEmojiForAIå‡½æ•°
                    for (let index = 0; index < parsed.length; index++) {
                        const item = parsed[index];
                        console.log(`ğŸ”¥ [DEBUG] å¤„ç†ç¬¬${index + 1}ä¸ªå…ƒç´ :`, typeof item, item);

                        if (typeof item === 'object' && item.name && item.type === 'emoji') {
                            // å¤„ç†ç¾¤èŠè¡¨æƒ…åŒ…æ ¼å¼ {"name": "è§’è‰²å", "type": "emoji", "description": "è¡¨æƒ…åŒ…æè¿°"}

                            const matchingEmoji = await findEmojiForAI(item.description);

                            if (matchingEmoji) {
                                // ç›´æ¥å‘é€è¡¨æƒ…åŒ…ï¼Œä¸ç®¡æ˜¯å¦ä¸ºGIFæ ¼å¼
                                console.log('AIå‘é€è¡¨æƒ…åŒ…:', item.description);
                                // ä¿æŒåŸå§‹çš„ç¾¤èŠè¡¨æƒ…åŒ…æ ¼å¼ï¼Œç›´æ¥ä¼ é€’ç»™callChatAPIå¤„ç†
                                processedMessages.push(item); // ç›´æ¥æ¨é€åŸå§‹æ ¼å¼
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
                                console.warn('AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è¡¨æƒ…åŒ…:', item.description);
                                processedMessages.push({
                                    name: item.name,
                                    message: `[é”™è¯¯: è¡¨æƒ…åŒ…"${item.description}"ä¸å­˜åœ¨]`
                                });
                            }
                        } else if (typeof item === 'object' && item.type === 'emoji') {
                            // å¤„ç†å•èŠè¡¨æƒ…åŒ…æ ¼å¼

                            const matchingEmoji = await findEmojiForAI(item.description);

                            if (matchingEmoji) {
                                // ç›´æ¥å‘é€è¡¨æƒ…åŒ…ï¼Œä¸ç®¡æ˜¯å¦ä¸ºGIFæ ¼å¼
                                console.log('AIå‘é€è¡¨æƒ…åŒ…:', item.description);
                                const emojiMessage = {
                                    type: 'emoji',
                                    url: matchingEmoji.url,
                                    description: matchingEmoji.description,
                                    id: matchingEmoji.id
                                };

                                // è¡¨æƒ…åŒ…æ¶ˆæ¯å¤„ç†å®Œæˆ
                                processedMessages.push(emojiMessage);
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
                                console.warn('AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è¡¨æƒ…åŒ…:', item.description);
                                processedMessages.push(`[é”™è¯¯: è¡¨æƒ…åŒ…"${item.description}"ä¸å­˜åœ¨]`);
                            }
                        } else if (typeof item === 'object' && item.type === 'ai_photo') {
                            // å¤„ç†è§’è‰²å‘é€çš„"ä¼ªç…§ç‰‡"
                            // ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æè¿°
                            const photoDesc = item.description || 'è§’è‰²å‘é€çš„ç…§ç‰‡';
                            processedMessages.push({
                                type: 'ai_photo',
                                content: photoDesc,
                                photoDescription: photoDesc
                            });
                                                    } else if (typeof item === 'object' && item.type === 'location') {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è§’è‰²å‘é€çš„ä½ç½® - ä½¿ç”¨æ–°çš„locationNameå­—æ®µæ ¼å¼
                                // æ–°æ ¼å¼ï¼š{"name": "è§’è‰²å", "type": "location", "locationName": "ä½ç½®å", "coordinates": "åæ ‡"}
                                // æ—§æ ¼å¼ï¼š{"name": "è§’è‰²å", "type": "location", "name": "ä½ç½®å", "coordinates": "åæ ‡"} (æœ‰å­—æ®µå†²çª)

                                // è·å–ä½ç½®åç§° - ä¼˜å…ˆä½¿ç”¨locationNameå­—æ®µï¼Œå…¼å®¹æ—§çš„nameå­—æ®µ
                                const locationName = item.locationName || item.name || 'æœªçŸ¥ä½ç½®';

                                const locationMessage = {
                                    type: 'location',
                                    locationName: locationName,
                                    coordinates: item.coordinates || 'æœªçŸ¥åæ ‡',
                                    content: `[è§’è‰²åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${locationName}]`
                                };

                                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µï¼ˆè§’è‰²åï¼‰
                                if (item.name && item.locationName) {
                                    // å¦‚æœåŒæ—¶æœ‰nameå’ŒlocationNameï¼Œnameå°±æ˜¯è§’è‰²å
                                    locationMessage.name = item.name;
                                } else if (item.name && !item.locationName) {
                                    // å¦‚æœåªæœ‰nameå­—æ®µï¼Œéœ€è¦åˆ¤æ–­æ˜¯è§’è‰²åè¿˜æ˜¯ä½ç½®å
                                    // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾è¿™æ˜¯æ—§æ ¼å¼ï¼Œnameè¢«ä½ç½®åè¦†ç›–äº†
                                    // æš‚æ—¶ä¸è®¾ç½®è§’è‰²åï¼Œè®©åç»­å¤„ç†é€»è¾‘å¤„ç†
                                }

                                processedMessages.push(locationMessage);
                        } else if (typeof item === 'object' && item.type === 'change_avatar') {
                            // å¤„ç†å¤´åƒæ›´æ¢å¯¹è±¡


                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†å„ç§é”™è¯¯çš„å ä½ç¬¦
                            if (item.avatar_url === 'CURRENT_USER_IMAGE' ||
                                item.avatar_url === 'CURRENT_USER_IMAGE' ||
                                item.avatar_url === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                                item.avatar_url === 'å›¾ç‰‡URL') {
                                // è·å–æœ€è¿‘ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    item.avatar_url = recentUserImage;
                                    console.log('å°†å ä½ç¬¦æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡URL:', recentUserImage);
                                } else {
                                    console.warn('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æœ€è¿‘å‘é€çš„å›¾ç‰‡ï¼Œå¿½ç•¥å¤´åƒæ›´æ¢è¯·æ±‚');
                                    processedMessages.push(`[ç³»ç»Ÿï¼šæ— æ³•æ›´æ¢å¤´åƒï¼Œæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡]`);
                                    // ä¸è¦returnï¼Œç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
                                }
                            }

                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'ai_image') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€å›¾ç‰‡

                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'voice_message') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€è¯­éŸ³
                            const voiceMessage = {
                                type: 'voice_message',
                                content: item.content || '',
                                duration: item.duration || '0"'
                            };
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µ
                            if (item.name) {
                                voiceMessage.name = item.name;
                            }
                            processedMessages.push(voiceMessage);
                        } else if (typeof item === 'object' && item.type === 'transfer') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†AIè½¬è´¦ - ç¡®ä¿æ ¼å¼æ­£ç¡®
                            processedMessages.push({
                                type: 'transfer',
                                amount: item.amount || 0,
                                note: item.note || 'è½¬è´¦'
                            });
                        } else if (typeof item === 'object' && item.type === 'payment_request') {
                            // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå¿½ç•¥
                            console.log('ğŸ›’ [parseAiResponse] AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥:', item);
                        } else if (typeof item === 'object' && item.type === 'poke') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³
                            console.log('ğŸ” [parseAiResponse] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†æˆ³ä¸€æˆ³åç¼€æ›´æ–° - åªä¼ é€’å¯¹è±¡ï¼Œè®©createAIMessageå¤„ç†å…·ä½“é€»è¾‘
                            console.log('ğŸ” [parseAiResponse] è§’è‰²æ›´æ–°æˆ³ä¸€æˆ³åç¼€:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'recall') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æ’¤å›æ¶ˆæ¯
                            if (item.target === 'previous') {
                                // æ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯
                                processedMessages.push({
                                    type: 'recall_previous',
                                    content: '[AIæ’¤å›äº†ä¸Šä¸€æ¡æ¶ˆæ¯]'
                                });
                            }
                        } else if (typeof item === 'object' && item.type === 'reply') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤
                            processedMessages.push({
                                type: 'reply_message',
                                messageId: item.messageId,
                                content: item.content || ''
                            });
                        } else if (typeof item === 'object' && item.type === 'photo') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€ç…§ç‰‡å¡ç‰‡
                            processedMessages.push({
                                type: 'user_photo',
                                content: item.description || 'AIåˆ†äº«çš„ç…§ç‰‡',
                                photoDescription: item.description
                            });
                        } else if (typeof item === 'object' && item.type === 'recalled_message') {
                            // ğŸ”¥ã€ä¿ç•™ã€‘å¤„ç†ç³»ç»Ÿæ’¤å›æ¶ˆæ¯

                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'reply_to') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤
                            const replyMessage = {
                                type: 'reply_to',
                                message_id: item.message_id,
                                content: item.content || ''
                            };
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µ
                            if (item.name) {
                                replyMessage.name = item.name;
                            }
                            processedMessages.push(replyMessage);
                        } else if (typeof item === 'object' && item.type === 'friend_request') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨å‘é€å¥½å‹ç”³è¯· - è½»é‡çº§é˜²å´©åæ£€æŸ¥
                            if (!isRecentFriendRequestSpam(currentChatCharacter?.id)) {
                                processedMessages.push({
                                    type: 'friend_request',
                                    message: item.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'
                                });
                                console.log('âœ… [å¥½å‹ç”³è¯·] AIè‡ªç„¶å‘é€å¥½å‹ç”³è¯·:', item.message);
                            } else {
                                console.log('ğŸš« [é˜²å´©å] è·³è¿‡çŸ­æ—¶é—´å†…çš„é‡å¤ç”³è¯·ï¼Œè½¬ä¸ºæ™®é€šæ¶ˆæ¯');
                                // è½¬æ¢ä¸ºæ™®é€šæ¶ˆæ¯ï¼Œä¿æŒAIçš„è‡ªç„¶è¡¨è¾¾
                                processedMessages.push(item.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹');
                            }
                        } else if (typeof item === 'object' && item.type === 'select_song') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIé€‰æ­ŒæŒ‡ä»¤
                            console.log('ğŸµ AIé€‰æ­ŒæŒ‡ä»¤:', item);

                            // å¼‚æ­¥æ‰§è¡Œé€‰æ­Œæ“ä½œ
                            setTimeout(async () => {
                                const success = await aiSelectSong(item.title, currentChatCharacter?.name);
                                if (success) {
                                    console.log('âœ… AIæˆåŠŸé€‰æ‹©æ­Œæ›²');
                                } else {
                                    console.log('âŒ AIé€‰æ­Œå¤±è´¥');
                                }
                            }, 100);

                            // è¿”å›ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥å¯¹è±¡
                            processedMessages.push({
                                id: Date.now().toString(),
                                sender: 'system',
                                type: 'system_notification',
                                content: `${currentChatCharacter?.name || 'AI'}æ­£åœ¨ä¸ºä½ é€‰æ‹©æ­Œæ›²ï¼š${item.title}`,
                                timestamp: Date.now()
                            });
                        } else if (typeof item === 'object' && item.type === 'random_song') {
                            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIéšæœºé€‰æ­ŒæŒ‡ä»¤
                            console.log('ğŸµ AIéšæœºé€‰æ­ŒæŒ‡ä»¤:', item);

                            // å¼‚æ­¥æ‰§è¡Œéšæœºé€‰æ­Œæ“ä½œ
                            setTimeout(async () => {
                                const success = await aiSelectRandomSong(currentChatCharacter?.name);
                                if (success) {
                                    console.log('âœ… AIæˆåŠŸéšæœºé€‰æ‹©æ­Œæ›²');
                                } else {
                                    console.log('âŒ AIéšæœºé€‰æ­Œå¤±è´¥');
                                }
                            }, 100);

                            // è¿”å›ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥å¯¹è±¡
                            processedMessages.push({
                                id: Date.now().toString(),
                                sender: 'system',
                                type: 'system_notification',
                                content: `${currentChatCharacter?.name || 'AI'}æ­£åœ¨ä¸ºä½ éšæœºé€‰æ‹©ä¸€é¦–æ­Œæ›²`,
                                timestamp: Date.now()
                            });
                        } else if (typeof item === 'string') {
                            // ğŸš¨ ã€æ–°å¢ã€‘æ£€æŸ¥å¹¶ä¿®å¤åˆå¹¶æ¶ˆæ¯é—®é¢˜
                            const trimmedItem = item.trim();

                            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯AIç”¨æ–‡å­—æè¿°çš„æˆ³ä¸€æˆ³åç¼€ä¿®æ”¹
                            const pokeSuffixMatch = trimmedItem.match(/(.+)ä¿®æ”¹äº†è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€(?:ä¸º"(.+)"|ï¼ˆæ¸…ç©ºï¼‰)/);
                            if (pokeSuffixMatch) {
                                const characterName = pokeSuffixMatch[1];
                                const suffix = pokeSuffixMatch[2] || '';
                                console.log('ğŸ” [parseAiResponse] æ£€æµ‹åˆ°AIæ–‡å­—æè¿°æˆ³ä¸€æˆ³åç¼€ä¿®æ”¹ï¼Œè‡ªåŠ¨è½¬æ¢:', { characterName, suffix });

                                // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°èŠå¤©è®¾ç½®ä¸­çš„AIæˆ³ä¸€æˆ³åç¼€ï¼ˆå½±å“ç”¨æˆ·æˆ³AIæ—¶çš„æ˜¾ç¤ºï¼‰
                                const chatSettings = getCurrentChatSettings();
                                chatSettings.aiPokeSuffix = suffix;
                                await saveCurrentChatSettings(chatSettings);

                                // æ·»åŠ ç³»ç»Ÿé€šçŸ¥è€Œä¸æ˜¯æ™®é€šæ¶ˆæ¯
                                processedMessages.push({
                                    id: Date.now().toString(),
                                    sender: 'system',
                                    content: `${currentChatCharacter.name}ä¿®æ”¹äº†è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€${suffix ? `ä¸º"${suffix}"` : 'ï¼ˆæ¸…ç©ºï¼‰'}`,
                                    timestamp: Date.now(),
                                    type: 'system_notification'
                                });

                                console.log('âœ… [parseAiResponse] æˆ³ä¸€æˆ³åç¼€å·²æ›´æ–°:', suffix);
                            } else if (item.includes('\n')) {
                                console.warn('æ£€æµ‹åˆ°AIå°†å¤šæ¡æ¶ˆæ¯åˆå¹¶åœ¨ä¸€ä¸ªå…ƒç´ ä¸­ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ†æ‹†:', item);
                                // å°†æ¢è¡Œç¬¦åˆ†éš”çš„å†…å®¹åˆ†æ‹†æˆå¤šæ¡æ¶ˆæ¯
                                const splitMessages = item.split('\n')
                                    .map(msg => msg.trim())
                                    .filter(msg => msg.length > 0);
                                processedMessages.push(...splitMessages);
                            } else {
                                processedMessages.push(item);
                            }
                        } else {
                            processedMessages.push(item);
                        }
                    }

                    return processedMessages;
                }
            } catch (e) {}

            try {
                const match = content.match(/\[(.*?)\]/s);
                if (match && match[0]) {
                    const parsed = JSON.parse(match[0]);
                    if (Array.isArray(parsed)) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯ç±»å‹å’Œæ ¼å¼ä¿®æ­£ - ä½¿ç”¨å¼‚æ­¥å¤„ç†
                        const processedMessages = [];

                        for (const item of parsed) {
                            if (typeof item === 'object' && item.type === 'emoji') {
                                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å•èŠè¡¨æƒ…åŒ…æ ¼å¼ï¼ˆç¬¬äºŒå¤„ï¼‰
                                const matchingEmoji = await findEmojiForAI(item.description);

                                if (matchingEmoji) {
                                    // ç›´æ¥å‘é€è¡¨æƒ…åŒ…ï¼Œä¸ç®¡æ˜¯å¦ä¸ºGIFæ ¼å¼
                                    console.log('AIå‘é€è¡¨æƒ…åŒ…:', item.description);
                                    // è¿”å›è¡¨æƒ…åŒ…å¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´çš„è¡¨æƒ…åŒ…ä¿¡æ¯
                                    processedMessages.push({
                                        type: 'emoji',
                                        url: matchingEmoji.url,
                                        description: matchingEmoji.description,
                                        id: matchingEmoji.id
                                    });
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
                                    console.warn('AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è¡¨æƒ…åŒ…:', item.description);
                                    processedMessages.push(`[é”™è¯¯: è¡¨æƒ…åŒ…"${item.description}"ä¸å­˜åœ¨]`);
                                }
                            } else if (typeof item === 'object' && item.name && item.type === 'emoji') {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†ç¾¤èŠè¡¨æƒ…åŒ…æ ¼å¼ï¼ˆç¬¬äºŒå¤„ï¼‰- è¿™ä¸ªåˆ†æ”¯åº”è¯¥ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªåˆ†æ”¯å·²ç»å¤„ç†äº†
                                console.log('ğŸ” [parseAiResponse-ç¾¤èŠè¡¨æƒ…åŒ…-ç¬¬äºŒå¤„] æ£€æµ‹åˆ°é‡å¤çš„ç¾¤èŠè¡¨æƒ…åŒ…å¯¹è±¡:', item);
                                // ç›´æ¥æ¨é€åŸå§‹æ ¼å¼ï¼Œè®©callChatAPIå¤„ç†
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'ai_photo') {
                                // å¤„ç†è§’è‰²å‘é€çš„"ä¼ªç…§ç‰‡"
                                // ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æè¿°
                                const photoDesc = item.description || 'è§’è‰²å‘é€çš„ç…§ç‰‡';
                                processedMessages.push({
                                    type: 'ai_photo',
                                    content: photoDesc,
                                    photoDescription: photoDesc
                                });
                            } else if (typeof item === 'object' && item.type === 'location') {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è§’è‰²å‘é€çš„ä½ç½®(ç¬¬äºŒå¤„) - ä½¿ç”¨æ–°çš„locationNameå­—æ®µæ ¼å¼
                                // æ–°æ ¼å¼ï¼š{"name": "è§’è‰²å", "type": "location", "locationName": "ä½ç½®å", "coordinates": "åæ ‡"}
                                // æ—§æ ¼å¼ï¼š{"name": "è§’è‰²å", "type": "location", "name": "ä½ç½®å", "coordinates": "åæ ‡"} (æœ‰å­—æ®µå†²çª)

                                // è·å–ä½ç½®åç§° - ä¼˜å…ˆä½¿ç”¨locationNameå­—æ®µï¼Œå…¼å®¹æ—§çš„nameå­—æ®µ
                                const locationName = item.locationName || item.name || 'æœªçŸ¥ä½ç½®';

                                const locationMessage = {
                                    type: 'location',
                                    locationName: locationName,
                                    coordinates: item.coordinates || 'æœªçŸ¥åæ ‡',
                                    content: `[è§’è‰²åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${locationName}]`
                                };

                                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µï¼ˆè§’è‰²åï¼‰
                                if (item.name && item.locationName) {
                                    // å¦‚æœåŒæ—¶æœ‰nameå’ŒlocationNameï¼Œnameå°±æ˜¯è§’è‰²å
                                    locationMessage.name = item.name;
                                } else if (item.name && !item.locationName) {
                                    // å¦‚æœåªæœ‰nameå­—æ®µï¼Œéœ€è¦åˆ¤æ–­æ˜¯è§’è‰²åè¿˜æ˜¯ä½ç½®å
                                    // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾è¿™æ˜¯æ—§æ ¼å¼ï¼Œnameè¢«ä½ç½®åè¦†ç›–äº†
                                    // æš‚æ—¶ä¸è®¾ç½®è§’è‰²åï¼Œè®©åç»­å¤„ç†é€»è¾‘å¤„ç†
                                }

                                processedMessages.push(locationMessage);
                            } else if (typeof item === 'object' && item.type === 'change_avatar') {
                                // å¤„ç†å¤´åƒæ›´æ¢å¯¹è±¡


                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†å„ç§é”™è¯¯çš„å ä½ç¬¦
                                if (item.avatar_url === 'CURRENT_USER_IMAGE' ||
                                    item.avatar_url === 'CURRENT_USER_IMAGE' ||
                                    item.avatar_url === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                                    item.avatar_url === 'å›¾ç‰‡URL') {
                                    // è·å–æœ€è¿‘ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL
                                    const recentUserImage = getRecentUserImage();
                                    if (recentUserImage) {
                                        item.avatar_url = recentUserImage;
                                        console.log('å°†å ä½ç¬¦æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡URL(ç¬¬äºŒå¤„):', recentUserImage);
                                    } else {
                                        console.warn('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æœ€è¿‘å‘é€çš„å›¾ç‰‡ï¼Œå¿½ç•¥å¤´åƒæ›´æ¢è¯·æ±‚(ç¬¬äºŒå¤„)');
                                        processedMessages.push(`[ç³»ç»Ÿï¼šæ— æ³•æ›´æ¢å¤´åƒï¼Œæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡]`);
                                        // ä¸è¦returnï¼Œç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
                                    }
                                }

                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'ai_image') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€å›¾ç‰‡(ç¬¬äºŒå¤„)

                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'voice_message') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€è¯­éŸ³(ç¬¬äºŒå¤„)
                                const voiceMessage = {
                                    type: 'voice_message',
                                    content: item.content || '',
                                    duration: item.duration || '0"'
                                };
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µ
                                if (item.name) {
                                    voiceMessage.name = item.name;
                                }
                                processedMessages.push(voiceMessage);
                            } else if (typeof item === 'object' && item.type === 'transfer') {
                                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†AIè½¬è´¦(ç¬¬äºŒå¤„) - ç¡®ä¿æ ¼å¼æ­£ç¡®

                                processedMessages.push({
                                    type: 'transfer',
                                    amount: item.amount || 0,
                                    note: item.note || 'è½¬è´¦'
                                });
                            } else if (typeof item === 'object' && item.type === 'payment_request') {
                                // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå¿½ç•¥
                                console.log('ğŸ›’ [parseAiResponse-ç¬¬äºŒå¤„] AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥:', item);
                            } else if (typeof item === 'object' && item.type === 'poke') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³(ç¬¬äºŒå¤„)
                                console.log('ğŸ” [parseAiResponse-ç¬¬äºŒå¤„] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†æˆ³ä¸€æˆ³åç¼€æ›´æ–°(ç¬¬äºŒå¤„) - åªä¼ é€’å¯¹è±¡ï¼Œè®©createAIMessageå¤„ç†å…·ä½“é€»è¾‘
                                console.log('ğŸ” [parseAiResponse-ç¬¬äºŒå¤„] è§’è‰²æ›´æ–°æˆ³ä¸€æˆ³åç¼€:', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'recall') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æ’¤å›æ¶ˆæ¯(ç¬¬äºŒå¤„)
                                if (item.target === 'previous') {
                                    // æ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯
                                    processedMessages.push({
                                        type: 'recall_previous',
                                        content: '[AIæ’¤å›äº†ä¸Šä¸€æ¡æ¶ˆæ¯]'
                                    });
                                }
                            } else if (typeof item === 'object' && item.type === 'reply') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤(ç¬¬äºŒå¤„)
                                processedMessages.push({
                                    type: 'reply_message',
                                    messageId: item.messageId,
                                    content: item.content || ''
                                });
                            } else if (typeof item === 'object' && item.type === 'photo') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå‘é€ç…§ç‰‡å¡ç‰‡(ç¬¬äºŒå¤„)
                                processedMessages.push({
                                    type: 'user_photo',
                                    content: item.description || 'AIåˆ†äº«çš„ç…§ç‰‡',
                                    photoDescription: item.description
                                });
                            } else if (typeof item === 'object' && item.type === 'recalled_message') {
                                // ğŸ”¥ã€ä¿ç•™ã€‘å¤„ç†ç³»ç»Ÿæ’¤å›æ¶ˆæ¯(ç¬¬äºŒå¤„)

                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'reply_to') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤(ç¬¬äºŒå¤„)
                                const replyMessage = {
                                    type: 'reply_to',
                                    message_id: item.message_id,
                                    content: item.content || ''
                                };
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„nameå­—æ®µ
                                if (item.name) {
                                    replyMessage.name = item.name;
                                }
                                processedMessages.push(replyMessage);
                            } else if (typeof item === 'object' && item.type === 'friend_request') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨å‘é€å¥½å‹ç”³è¯·(ç¬¬äºŒå¤„) - è½»é‡çº§é˜²å´©åæ£€æŸ¥
                                if (!isRecentFriendRequestSpam(currentChatCharacter?.id)) {
                                    processedMessages.push({
                                        type: 'friend_request',
                                        message: item.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'
                                    });
                                    console.log('âœ… [å¥½å‹ç”³è¯·] AIè‡ªç„¶å‘é€å¥½å‹ç”³è¯·(ç¬¬äºŒå¤„):', item.message);
                                } else {
                                    console.log('ğŸš« [é˜²å´©å] è·³è¿‡çŸ­æ—¶é—´å†…çš„é‡å¤ç”³è¯·(ç¬¬äºŒå¤„)ï¼Œè½¬ä¸ºæ™®é€šæ¶ˆæ¯');
                                    // è½¬æ¢ä¸ºæ™®é€šæ¶ˆæ¯ï¼Œä¿æŒAIçš„è‡ªç„¶è¡¨è¾¾
                                    processedMessages.push(item.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹');
                                }
                            } else if (typeof item === 'object' && item.type === 'select_song') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIé€‰æ­ŒæŒ‡ä»¤
                                console.log('ğŸµ AIé€‰æ­ŒæŒ‡ä»¤:', item);

                                // å¼‚æ­¥æ‰§è¡Œé€‰æ­Œæ“ä½œ
                                setTimeout(async () => {
                                    const success = await aiSelectSong(item.title, currentChatCharacter?.name);
                                    if (success) {
                                        console.log('âœ… AIæˆåŠŸé€‰æ‹©æ­Œæ›²');
                                    } else {
                                        console.log('âŒ AIé€‰æ­Œå¤±è´¥');
                                    }
                                }, 100);

                                // è¿”å›ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥å¯¹è±¡
                                processedMessages.push({
                                    id: Date.now().toString(),
                                    sender: 'system',
                                    type: 'system_notification',
                                    content: `${currentChatCharacter?.name || 'AI'}æ­£åœ¨ä¸ºä½ é€‰æ‹©æ­Œæ›²ï¼š${item.title}`,
                                    timestamp: Date.now()
                                });
                            } else if (typeof item === 'object' && item.type === 'random_song') {
                                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIéšæœºé€‰æ­ŒæŒ‡ä»¤
                                console.log('ğŸµ AIéšæœºé€‰æ­ŒæŒ‡ä»¤:', item);

                                // å¼‚æ­¥æ‰§è¡Œéšæœºé€‰æ­Œæ“ä½œ
                                setTimeout(async () => {
                                    const success = await aiSelectRandomSong(currentChatCharacter?.name);
                                    if (success) {
                                        console.log('âœ… AIæˆåŠŸéšæœºé€‰æ‹©æ­Œæ›²');
                                    } else {
                                        console.log('âŒ AIéšæœºé€‰æ­Œå¤±è´¥');
                                    }
                                }, 100);

                                // è¿”å›ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥å¯¹è±¡
                                processedMessages.push({
                                    id: Date.now().toString(),
                                    sender: 'system',
                                    type: 'system_notification',
                                    content: `${currentChatCharacter?.name || 'AI'}æ­£åœ¨ä¸ºä½ éšæœºé€‰æ‹©ä¸€é¦–æ­Œæ›²`,
                                    timestamp: Date.now()
                                });
                            } else if (typeof item === 'string') {
                                // ğŸš¨ ã€æ–°å¢ã€‘æ£€æŸ¥å¹¶ä¿®å¤åˆå¹¶æ¶ˆæ¯é—®é¢˜
                                const trimmedItem = item.trim();

                                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯AIç”¨æ–‡å­—æè¿°çš„æˆ³ä¸€æˆ³åç¼€ä¿®æ”¹
                                const pokeSuffixMatch = trimmedItem.match(/(.+)ä¿®æ”¹äº†è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€(?:ä¸º"(.+)"|ï¼ˆæ¸…ç©ºï¼‰)/);
                                if (pokeSuffixMatch) {
                                    const characterName = pokeSuffixMatch[1];
                                    const suffix = pokeSuffixMatch[2] || '';
                                    console.log('ğŸ” [parseAiResponse-ç¬¬äºŒå¤„] æ£€æµ‹åˆ°AIæ–‡å­—æè¿°æˆ³ä¸€æˆ³åç¼€ä¿®æ”¹ï¼Œè‡ªåŠ¨è½¬æ¢:', { characterName, suffix });

                                    // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°èŠå¤©è®¾ç½®ä¸­çš„AIæˆ³ä¸€æˆ³åç¼€ï¼ˆå½±å“ç”¨æˆ·æˆ³AIæ—¶çš„æ˜¾ç¤ºï¼‰
                                    const chatSettings = getCurrentChatSettings();
                                    chatSettings.aiPokeSuffix = suffix;
                                    await saveCurrentChatSettings(chatSettings);

                                    // æ·»åŠ ç³»ç»Ÿé€šçŸ¥è€Œä¸æ˜¯æ™®é€šæ¶ˆæ¯
                                    processedMessages.push({
                                        id: Date.now().toString(),
                                        sender: 'system',
                                        content: `${currentChatCharacter.name}ä¿®æ”¹äº†è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€${suffix ? `ä¸º"${suffix}"` : 'ï¼ˆæ¸…ç©ºï¼‰'}`,
                                        timestamp: Date.now(),
                                        type: 'system_notification'
                                    });

                                    console.log('âœ… [parseAiResponse-ç¬¬äºŒå¤„] æˆ³ä¸€æˆ³åç¼€å·²æ›´æ–°:', suffix);
                                } else if (item.includes('\n')) {
                                    console.warn('æ£€æµ‹åˆ°AIå°†å¤šæ¡æ¶ˆæ¯åˆå¹¶åœ¨ä¸€ä¸ªå…ƒç´ ä¸­ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ†æ‹†:', item);
                                    // å°†æ¢è¡Œç¬¦åˆ†éš”çš„å†…å®¹åˆ†æ‹†æˆå¤šæ¡æ¶ˆæ¯
                                    const splitMessages = item.split('\n')
                                        .map(msg => msg.trim())
                                        .filter(msg => msg.length > 0);
                                    processedMessages.push(...splitMessages);
                                } else {
                                    processedMessages.push(item);
                                }
                            } else {
                                processedMessages.push(item);
                            }
                        }

                        console.log('ğŸ”¥ [DEBUG] parseAiResponse å¤„ç†å®Œæˆï¼Œè¿”å›', processedMessages.length, 'æ¡æ¶ˆæ¯:', processedMessages);
                        return processedMessages;
                    }
                }
            } catch (e) {}

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯åŸå§‹çš„JSONå­—ç¬¦ä¸²ï¼ˆAIå›å¤æ²¡æœ‰è¢«æ­£ç¡®åŒ…è£…ï¼‰
            if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                try {
                    const singleObject = JSON.parse(content.trim());
                    if (singleObject.type) {
                        console.log('æ£€æµ‹åˆ°å•ä¸ªJSONå¯¹è±¡ï¼Œå°è¯•å¤„ç†:', singleObject);
                        // å°†å•ä¸ªå¯¹è±¡åŒ…è£…æˆæ•°ç»„å†é€’å½’å¤„ç†
                        return await parseAiResponse(`[${content.trim()}]`);
                    }
                } catch (e) {
                    console.warn('æ— æ³•è§£æå•ä¸ªJSONå¯¹è±¡:', e);
                }
            }

            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```'));
            console.log('ğŸ” [parseAiResponse] JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨fallbackå¤„ç†ï¼Œç»“æœ:', lines.length > 0 ? lines : [content]);
            if (lines.length > 0) return lines;
            return [content];
        }

        // å¤„ç†çº¿ä¸‹æ¨¡å¼å†…å®¹ï¼šè¯†åˆ«ã€Œã€åŒ…è£¹çš„å¯¹è¯å’Œæå†™
        function processOfflineContent(content) {
            if (!content) return '';

            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†ç¦»å¯¹è¯å’Œæå†™
            const parts = [];
            let lastIndex = 0;

            // åŒ¹é…ã€Œã€åŒ…è£¹çš„å¯¹è¯
            const dialogRegex = /ã€Œ([^ã€]*)ã€/g;
            let match;

            while ((match = dialogRegex.exec(content)) !== null) {
                // æ·»åŠ å¯¹è¯å‰çš„æå†™éƒ¨åˆ†
                if (match.index > lastIndex) {
                    const description = content.slice(lastIndex, match.index).trim();
                    if (description) {
                        parts.push(`<span class="italic-gray">${description}</span>`);
                    }
                }

                // æ·»åŠ å¯¹è¯éƒ¨åˆ†ï¼ˆæ­£å¸¸æ˜¾ç¤ºï¼‰
                parts.push(`ã€Œ${match[1]}ã€`);
                lastIndex = match.index + match[0].length;
            }

            // æ·»åŠ æœ€åçš„æå†™éƒ¨åˆ†
            if (lastIndex < content.length) {
                const description = content.slice(lastIndex).trim();
                if (description) {
                    parts.push(`<span class="italic-gray">${description}</span>`);
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹è¯æ ‡è®°ï¼Œæ•´ä¸ªå†…å®¹ä½œä¸ºæå†™å¤„ç†
            if (parts.length === 0) {
                return `<span class="italic-gray">${content}</span>`;
            }

            return parts.join('');
        }



        // ğŸ”¥ã€ä¿®å¤ã€‘å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼Œä½¿ç”¨æ­£ç¡®çš„å¤šæ¨¡æ€æ•°æ®ç»“æ„
        async function sendImageMessage(imageUrl) {
            if (!currentChatCharacter) return;

            const chatInput = document.getElementById('api-chat-input');
            const textContent = chatInput ? chatInput.value.trim() : '';



            // åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„å¤šæ¨¡æ€æ¶ˆæ¯å¯¹è±¡
            const messageContent = [
                { type: 'text', text: textContent }
            ];

            if (imageUrl) {
                messageContent.push({
                    type: 'image_url',
                    image_url: { url: imageUrl }
                });
            }

            console.log('ğŸ” [sendImageMessage] åˆ›å»ºçš„æ¶ˆæ¯å†…å®¹:', messageContent);
            console.log('ğŸ” [sendImageMessage] æ–‡æœ¬å†…å®¹:', textContent);
            console.log('ğŸ” [sendImageMessage] å›¾ç‰‡URLé•¿åº¦:', imageUrl ? imageUrl.length : 0);
            console.log('ğŸ” [sendImageMessage] æ¶ˆæ¯å†…å®¹æ•°ç»„é•¿åº¦:', messageContent.length);
            console.log('ğŸ” [sendImageMessage] æ¶ˆæ¯å†…å®¹è¯¦æƒ…:', messageContent.map((item, index) => ({
                index,
                type: item.type,
                hasText: !!item.text,
                hasImageUrl: !!item.image_url,
                textLength: item.text ? item.text.length : 0,
                imageUrlLength: item.image_url?.url ? item.image_url.url.length : 0
            })));



            const message = {
                id: Date.now().toString(),
                sender: 'sent',
                content: messageContent, // ä½¿ç”¨æ–°çš„æ•°ç»„æ ¼å¼
                timestamp: Date.now(),
                // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œæ·»åŠ å¼•ç”¨ä¿¡æ¯
                replyTo: currentReplyTo ? {
                    id: currentReplyTo.id,
                    content: currentReplyTo.content,
                    senderName: currentReplyTo.senderName
                } : null
            };



            // æ·»åŠ åˆ°èŠå¤©è®°å½•
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(message);

            // ğŸ”¥ã€ä¿®å¤ã€‘å›¾ç‰‡æ¶ˆæ¯ä½¿ç”¨ä¸æ–‡å­—æ¶ˆæ¯ç›¸åŒçš„å•æ¡ä¿å­˜æœºåˆ¶
            try {
                const stableId = `${currentChatCharacter.id}_${message.id}_${chatMessages[currentChatCharacter.id].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: currentChatCharacter.id,
                    timestamp: message.timestamp,
                    messageOrder: chatMessages[currentChatCharacter.id].length - 1,
                    originalMessageId: message.id,
                    messageData: message
                });
                console.log('âœ… [é«˜æ•ˆå‘é€å›¾ç‰‡] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('å›¾ç‰‡æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                await saveChatMessagesImmediate();
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•åˆ°å…¨å±€è®°å¿†äº‹ä»¶
            await recordMemoryEvent(
                [currentChatCharacter.id, 'user'],
                {
                    type: currentChatCharacter.isGroup ? 'group_chat' : 'private_chat',
                    id: currentChatCharacter.id
                },
                'message',
                {
                    sender: 'user',
                    content: textContent,
                    hasImage: !!imageUrl
                },
                0.6 // ç”¨æˆ·æ¶ˆæ¯é‡è¦æ€§
            );

            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ·æ–°UI
            if (chatInput) {
                chatInput.value = '';
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å¼•ç”¨çŠ¶æ€
            cancelReply();
            if (currentChatCharacter) {
                delete chatReplyStates[currentChatCharacter.id];
            }
            addMessageWithAnimation(message, currentChatCharacter.id);
            renderMessageList();

            // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è§’è‰²çŠ¶æ€æ›´æ–°
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);

            // è®¾ç½®ä¸ºå¾…å›å¤æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            pendingUserMessage = message;

            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
            }
        }

        // è°ƒç”¨èŠå¤©API
        // ç¬¬ä¸€ä¸ªcallChatAPIå‡½æ•°å·²åˆ é™¤ï¼Œä½¿ç”¨ä¸‹é¢çš„å®Œæ•´ç‰ˆæœ¬

        // ä¸Šä¼ å›¾ç‰‡
        function uploadImage() {
            document.getElementById('image-upload').click();
        }

        // æ˜¾ç¤ºå›¾ç‰‡
        function showImage(imageUrl) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤å¯¹æœªå®šä¹‰çš„photoså˜é‡çš„å¼•ç”¨ï¼Œç›´æ¥æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
            let modal = document.getElementById('image-preview-modal');
            if (!modal) {
                // åˆ›å»ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
                modal = document.createElement('div');
                modal.id = 'image-preview-modal';
                modal.className = 'image-preview-modal';

                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                };

                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.alt = 'é¢„è§ˆå›¾ç‰‡';
                img.style.cursor = 'zoom-out';

                // ç‚¹å‡»å›¾ç‰‡ä¹Ÿå¯ä»¥å…³é—­
                img.onclick = () => modal.style.display = 'none';

                modal.appendChild(img);
                document.body.appendChild(modal);
            }

            // è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
            const img = modal.querySelector('img');
            img.src = imageUrl;
            modal.style.display = 'flex';

            // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ é”®ç›˜ESCé”®å…³é—­åŠŸèƒ½
            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    modal.style.display = 'none';
                    document.removeEventListener('keydown', handleKeyPress);
                }
            };
            document.addEventListener('keydown', handleKeyPress);
        }

        // æ˜¾ç¤ºèŠå¤©è®¾ç½®
        function showChatSettings() {
            console.log('æ˜¾ç¤ºèŠå¤©è®¾ç½®è¢«è°ƒç”¨');

            // å…ˆéšè—å½“å‰çš„èŠå¤©ç•Œé¢
            hideApp('api-chat-screen');

            // æ˜¾ç¤ºè®¾ç½®ç•Œé¢
            const element = document.getElementById('api-chat-settings-screen');
            if (element) {
                element.style.display = 'flex';
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.zIndex = '1000';
                element.style.background = 'white';

                // é‡æ–°åˆå§‹åŒ–èŠå¤©è®¾ç½®ç•Œé¢ä»¥åŠ è½½å½“å‰è®¾ç½®
                initializeChatSettings();

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ°”æ³¡æ ·å¼åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤ºæ—¶è¢«æ­£ç¡®åº”ç”¨
                applyBubbleStyle();

                // æ›´æ–°å„ç§è®¾ç½®çš„æ˜¾ç¤ºçŠ¶æ€
                updateWorldbookMountDisplay();

                // æ£€æµ‹å½“å‰èŠå¤©ç±»å‹å¹¶æ˜¾ç¤ºç›¸åº”è®¾ç½®
                const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
                console.log('å½“å‰èŠå¤©ç±»å‹:', isGroupChat ? 'ç¾¤èŠ' : 'å•èŠ');

                // æ ¹æ®èŠå¤©ç±»å‹æ˜¾ç¤ºä¸åŒçš„è®¾ç½®é€‰é¡¹
                const groupChatSettings = document.getElementById('group-chat-settings');
                const pokeSettingsSection = document.getElementById('poke-settings-section');

                if (isGroupChat) {
                    // ç¾¤èŠæ¨¡å¼ï¼šæ˜¾ç¤ºç¾¤èŠè®¾ç½®ï¼Œéšè—æˆ³ä¸€æˆ³å’Œå•èŠä¸“ç”¨åŠŸèƒ½
                    if (groupChatSettings) groupChatSettings.style.display = 'block';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'none';

                    // éšè—å•èŠä¸“ç”¨è®¾ç½®é¡¹
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => item.style.display = 'none');

                    // æ›´æ–°ç¾¤èŠä¿¡æ¯æ˜¾ç¤º
                    updateGroupChatInfo();
                } else {
                    // å•èŠæ¨¡å¼ï¼šéšè—ç¾¤èŠè®¾ç½®ï¼Œæ˜¾ç¤ºæˆ³ä¸€æˆ³å’Œå•èŠä¸“ç”¨åŠŸèƒ½
                    if (groupChatSettings) groupChatSettings.style.display = 'none';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'block';

                    // æ˜¾ç¤ºå•èŠä¸“ç”¨è®¾ç½®é¡¹
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => {
                        if (item.classList.contains('settings-section')) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'flex';
                        }
                    });

                    // æ›´æ–°è®°å¿†å…±äº«çŠ¶æ€æ˜¾ç¤º
                    updateMemoryShareStatus();
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è§†é¢‘é€šè¯å½¢è±¡è®¾ç½®çš„æ˜¾ç¤ºçŠ¶æ€
                updateVideoAvatarSettingVisibility();

                console.log('èŠå¤©è®¾ç½®ç•Œé¢å·²æ˜¾ç¤º');
            } else {
                console.error('æ‰¾ä¸åˆ°api-chat-settings-screenå…ƒç´ ');
                alert('è®¾ç½®ç•Œé¢æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // éšè—èŠå¤©è®¾ç½®
        function hideChatSettings() {
            hideApp('api-chat-settings-screen');
            // è¿”å›åˆ°èŠå¤©ç•Œé¢
            if (currentChatCharacter) {
                showApp('api-chat-screen');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²è¶³è¿¹åŠŸèƒ½
        let footprintsUpdateTimer = null;
        let currentFootprintsCharacter = null;

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
        function getLocalDateString(date = new Date()) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–è§’è‰²çš„æ˜¾ç¤ºå¤´åƒï¼ˆä¼˜å…ˆåŠ¨æ€å¤´åƒï¼Œç„¶åè§’è‰²å¡å¤´åƒï¼‰
        async function getCharacterDisplayAvatar(character) {
            try {
                // 1. æŸ¥æ‰¾è§’è‰²åœ¨åŠ¨æ€ä¸­æœ€æ–°çš„å¤´åƒï¼ˆä½¿ç”¨authorIdå­—æ®µï¼‰
                const characterMoments = await db.moments
                    .where('authorId')
                    .equals(character.id)
                    .reverse()
                    .limit(10)
                    .toArray();

                // æ‰¾åˆ°æœ€æ–°çš„æœ‰å¤´åƒçš„åŠ¨æ€
                for (const moment of characterMoments) {
                    if (moment.avatar && isValidAvatarUrl(moment.avatar)) {
                        console.log(`âœ… ä½¿ç”¨è§’è‰² ${character.name} åœ¨åŠ¨æ€ä¸­çš„å¤´åƒ`);
                        return moment.avatar;
                    }
                }

                // 2. å¦‚æœæ²¡æœ‰åŠ¨æ€å¤´åƒï¼Œä½¿ç”¨è§’è‰²å¡å¤´åƒ
                if (character.avatar && isValidAvatarUrl(character.avatar)) {
                    console.log(`âœ… ä½¿ç”¨è§’è‰² ${character.name} çš„è§’è‰²å¡å¤´åƒ`);
                    return character.avatar;
                }

                // 3. å…¼å®¹æ—§ç‰ˆæœ¬çš„avatarUrlå­—æ®µ
                if (character.avatarUrl && isValidAvatarUrl(character.avatarUrl)) {
                    console.log(`âœ… ä½¿ç”¨è§’è‰² ${character.name} çš„avatarUrlå¤´åƒ`);
                    return character.avatarUrl;
                }

                // 4. æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå¤´åƒ
                console.log(`âš ï¸ è§’è‰² ${character.name} æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒ`);
                return null;
            } catch (error) {
                console.error('è·å–è§’è‰²æ˜¾ç¤ºå¤´åƒå¤±è´¥:', error);
                // é™çº§åˆ°è§’è‰²å¡å¤´åƒ
                return character.avatar || character.avatarUrl || null;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿ç§»è¶³è¿¹æ•°æ®ä»localStorageåˆ°Dexieæ•°æ®åº“
        async function migrateFootprintsFromLocalStorage() {
            try {
                console.log('ğŸ”„ å¼€å§‹è¿ç§»è¶³è¿¹æ•°æ®ä»localStorageåˆ°Dexieæ•°æ®åº“...');

                // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰è¶³è¿¹ç¼“å­˜
                const localStorageCache = localStorage.getItem('footprints_cache');
                if (!localStorageCache) {
                    console.log('âœ… localStorageä¸­æ²¡æœ‰è¶³è¿¹ç¼“å­˜ï¼Œæ— éœ€è¿ç§»');
                    return;
                }

                const cache = JSON.parse(localStorageCache);
                let migratedCount = 0;
                let totalCount = 0;

                // éå†æ‰€æœ‰æ—¥æœŸçš„ç¼“å­˜æ•°æ®
                for (const [date, dateCache] of Object.entries(cache)) {
                    if (typeof dateCache === 'object' && dateCache !== null) {
                        // éå†è¯¥æ—¥æœŸä¸‹çš„æ‰€æœ‰è§’è‰²æ•°æ®
                        for (const [characterId, footprintData] of Object.entries(dateCache)) {
                            totalCount++;
                            try {
                                const footprintId = `${characterId}_${date}`;

                                // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥è®°å½•
                                const existingFootprint = await db.characterFootprints.get(footprintId);
                                if (existingFootprint) {
                                    console.log(`â­ï¸ è·³è¿‡å·²å­˜åœ¨çš„è¶³è¿¹è®°å½•: ${footprintId}`);
                                    continue;
                                }

                                // è¿ç§»æ•°æ®åˆ°Dexie
                                const footprintRecord = {
                                    id: footprintId,
                                    characterId: characterId,
                                    date: date,
                                    data: footprintData.data,
                                    timestamp: footprintData.timestamp || Date.now(),
                                    lastUpdateTime: footprintData.lastUpdateTime || footprintData.timestamp || Date.now(),
                                    isComplete: footprintData.isComplete || false
                                };

                                await db.characterFootprints.add(footprintRecord);
                                migratedCount++;
                                console.log(`âœ… è¿ç§»è¶³è¿¹è®°å½•: ${footprintId}`);
                            } catch (error) {
                                console.error(`âŒ è¿ç§»è¶³è¿¹è®°å½•å¤±è´¥ ${characterId}_${date}:`, error);
                            }
                        }
                    }
                }

                if (migratedCount > 0) {
                    console.log(`âœ… è¶³è¿¹æ•°æ®è¿ç§»å®Œæˆ: æ€»è®¡ ${totalCount} æ¡è®°å½•ï¼ŒæˆåŠŸè¿ç§» ${migratedCount} æ¡`);

                    // è¿ç§»æˆåŠŸåï¼Œå¯ä»¥é€‰æ‹©æ¸…ç†localStorageä¸­çš„æ—§æ•°æ®
                    // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæš‚æ—¶ä¿ç•™localStorageæ•°æ®ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ¸…ç†
                    console.log('ğŸ’¡ æç¤º: localStorageä¸­çš„æ—§è¶³è¿¹æ•°æ®å·²ä¿ç•™ï¼Œæ‚¨å¯ä»¥åœ¨ç¡®è®¤è¿ç§»æˆåŠŸåæ‰‹åŠ¨æ¸…ç†');
                } else {
                    console.log('â„¹ï¸ æ²¡æœ‰æ–°çš„è¶³è¿¹æ•°æ®éœ€è¦è¿ç§»');
                }
            } catch (error) {
                console.error('âŒ è¶³è¿¹æ•°æ®è¿ç§»å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘è¶³è¿¹ç¼“å­˜ç®¡ç† - ä½¿ç”¨Dexieæ•°æ®åº“æ›¿ä»£localStorage
        async function getFootprintsCache(characterId) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
                const today = getLocalDateString();
                const footprintId = `${characterId}_${today}`;

                // ä»Dexieæ•°æ®åº“è·å–è¶³è¿¹æ•°æ®
                const footprint = await db.characterFootprints.get(footprintId);
                return footprint || null;
            } catch (error) {
                console.error('è·å–è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
                return null;
            }
        }

        async function setFootprintsCache(characterId, data, lastUpdateTime = null) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
                const today = getLocalDateString();
                const footprintId = `${characterId}_${today}`;

                const footprintRecord = {
                    id: footprintId,
                    characterId: characterId,
                    date: today,
                    data: data,
                    timestamp: Date.now(),
                    lastUpdateTime: lastUpdateTime || Date.now(),
                    isComplete: false
                };

                // ä¿å­˜åˆ°Dexieæ•°æ®åº“
                await db.characterFootprints.put(footprintRecord);
                console.log(`âœ… è¶³è¿¹ç¼“å­˜å·²ä¿å­˜åˆ°æ•°æ®åº“: ${characterId} (${today})`);
            } catch (error) {
                console.error('ä¿å­˜è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿½åŠ æ–°è¶³è¿¹åˆ°ç°æœ‰ç¼“å­˜ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function appendToFootprintsCache(characterId, newFootprints) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
                const today = getLocalDateString();
                const footprintId = `${characterId}_${today}`;

                // ä»æ•°æ®åº“è·å–ç°æœ‰è¶³è¿¹
                const existingFootprint = await db.characterFootprints.get(footprintId);

                if (!existingFootprint) {
                    console.warn('æ²¡æœ‰æ‰¾åˆ°ç°æœ‰ç¼“å­˜ï¼Œåˆ›å»ºæ–°ç¼“å­˜å¹¶ä¿å­˜æ–°è¶³è¿¹');
                    // å¦‚æœæ²¡æœ‰ç°æœ‰ç¼“å­˜ï¼Œç›´æ¥åˆ›å»ºæ–°ç¼“å­˜
                    await setFootprintsCache(characterId, newFootprints, Date.now());
                    return true;
                }

                const existingData = existingFootprint.data;

                // åˆå¹¶æ–°è¶³è¿¹åˆ°ç°æœ‰æ•°æ®
                if (newFootprints.activities) {
                    if (!existingData.activities) {
                        existingData.activities = [];
                    }
                    existingData.activities = existingData.activities.concat(newFootprints.activities);
                }
                if (newFootprints.locations) {
                    if (!existingData.locations) {
                        existingData.locations = [];
                    }
                    // å»é‡å¹¶åˆå¹¶ä½ç½®ä¿¡æ¯
                    const locationMap = new Map();
                    existingData.locations.forEach(loc => locationMap.set(loc.name, loc));
                    newFootprints.locations.forEach(loc => locationMap.set(loc.name, loc));
                    existingData.locations = Array.from(locationMap.values());
                }

                // æ›´æ–°æ•°æ®åº“è®°å½•
                existingFootprint.data = existingData;
                existingFootprint.timestamp = Date.now();
                existingFootprint.lastUpdateTime = Date.now();

                await db.characterFootprints.put(existingFootprint);
                console.log(`âœ… è¶³è¿¹ç¼“å­˜å·²è¿½åŠ æ›´æ–°åˆ°æ•°æ®åº“: ${characterId}ï¼Œæ€»è®¡ ${existingData.activities?.length || 0} ä¸ªæ´»åŠ¨`);
                console.log('ğŸ“¦ æ›´æ–°åçš„ç¼“å­˜æ•°æ®:', existingData);
                return true;
            } catch (error) {
                console.error('è¿½åŠ è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
                return false;
            }
        }

        async function cleanupFootprintsCache() {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
                const today = getLocalDateString();

                // ä»æ•°æ®åº“è·å–æ‰€æœ‰è¶³è¿¹è®°å½•
                const allFootprints = await db.characterFootprints.toArray();

                // è®¡ç®—æ¸…ç†å‰çš„æ•°æ®é‡
                const beforeCount = allFootprints.length;

                // æ‰¾å‡ºéœ€è¦åˆ é™¤çš„è¿‡æœŸè®°å½•ï¼ˆä¸æ˜¯ä»Šå¤©çš„ï¼‰
                const expiredFootprints = allFootprints.filter(footprint => footprint.date !== today);

                if (expiredFootprints.length > 0) {
                    // åˆ é™¤è¿‡æœŸçš„è¶³è¿¹è®°å½•
                    const expiredIds = expiredFootprints.map(fp => fp.id);
                    await db.characterFootprints.bulkDelete(expiredIds);

                    console.log(`ğŸ§¹ è¶³è¿¹ç¼“å­˜æ¸…ç†å®Œæˆ: æ¸…ç†å‰ ${beforeCount} ä¸ªè®°å½•ï¼Œåˆ é™¤äº† ${expiredFootprints.length} ä¸ªè¿‡æœŸè®°å½•`);
                } else {
                    console.log(`ğŸ§¹ è¶³è¿¹ç¼“å­˜æ£€æŸ¥å®Œæˆ: å…± ${beforeCount} ä¸ªè®°å½•ï¼Œæ— éœ€æ¸…ç†`);
                }
            } catch (error) {
                console.error('æ¸…ç†è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è®¾ç½®åˆå¤œè‡ªåŠ¨æ¸…ç†ç¼“å­˜
        function setupMidnightCacheCleanup() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºæ˜å¤©åˆå¤œ

            const msUntilMidnight = tomorrow.getTime() - now.getTime();

            setTimeout(async () => {
                console.log('ğŸ•› åˆå¤œè‡ªåŠ¨æ¸…ç†è¶³è¿¹ç¼“å­˜');
                try {
                    await cleanupFootprintsCache();
                } catch (error) {
                    console.error('åˆå¤œè‡ªåŠ¨æ¸…ç†è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
                }

                // è®¾ç½®æ¯24å°æ—¶æ¸…ç†ä¸€æ¬¡
                setInterval(async () => {
                    console.log('ğŸ•› å®šæ—¶æ¸…ç†è¶³è¿¹ç¼“å­˜');
                    try {
                        await cleanupFootprintsCache();
                    } catch (error) {
                        console.error('å®šæ—¶æ¸…ç†è¶³è¿¹ç¼“å­˜å¤±è´¥:', error);
                    }
                }, 24 * 60 * 60 * 1000);
            }, msUntilMidnight);

            console.log(`â° è¶³è¿¹ç¼“å­˜å°†åœ¨ ${Math.floor(msUntilMidnight / 1000 / 60)} åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†`);
        }

        // æ˜¾ç¤ºè§’è‰²æ‰‹æœº
        async function showCharacterPhone() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸æ”¯æŒæŸ¥çœ‹æ‰‹æœºåŠŸèƒ½', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…é™¤ä¹‹å‰è§’è‰²çš„ç¼“å­˜æ ‡è®°å’Œæ•°æ®ï¼Œç¡®ä¿æ–°è§’è‰²æ•°æ®é‡æ–°ç”Ÿæˆ
            window.phoneMessagesGenerated = false;
            window.phoneNotesGenerated = false;
            window.phonePhotosGenerated = false;
            window.phoneContactsData = null;
            window.phoneContactsChats = null;

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºè§’è‰²å¤´åƒä¿¡æ¯
            debugCharacterAvatar();

            // æ›´æ–°æ‰‹æœºç•Œé¢æ ‡é¢˜
            const titleElement = document.getElementById('character-phone-title');
            if (titleElement) {
                titleElement.textContent = `${currentChatCharacter.name}çš„æ‰‹æœº`;
            }

            // æ˜¾ç¤ºæ‰‹æœºç•Œé¢
            hideApp('api-chat-screen');
            showApp('character-phone-screen');

            // ğŸ”¥ã€ä¸´æ—¶ä¿®å¤ã€‘æ£€æŸ¥APIé…ç½®ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ç›´æ¥ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            if (!apiSettings.base || !apiSettings.key) {
                console.log('APIæœªé…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                generatePhoneMessages();
                switchPhoneTab('messages');
                return;
            }

            // å°è¯•APIç”Ÿæˆï¼Œå¤±è´¥åˆ™å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
            try {
                await generatePhoneMessagesAPI();
            } catch (error) {
                console.error('APIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
                generatePhoneMessages();
            }

            // é‡ç½®æ ‡ç­¾é¡µçŠ¶æ€ï¼Œç¡®ä¿æ˜¾ç¤ºæ¶ˆæ¯æ ‡ç­¾
            switchPhoneTab('messages');
        }

        // ç”Ÿæˆæ‰‹æœºæ¨¡æ‹Ÿæ•°æ®ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
        function generatePhoneData() {
            // ç”Ÿæˆæ¶ˆæ¯æ•°æ®
            generatePhoneMessages();
            // ç”Ÿæˆå¤‡å¿˜å½•æ•°æ®
            generatePhoneNotes();
            // ç”Ÿæˆç›¸å†Œæ•°æ®
            generatePhonePhotos();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šè¿‡APIç”Ÿæˆè§’è‰²æ‰‹æœºæ¶ˆæ¯
        async function generatePhoneMessagesAPI() {
            const messagesContainer = document.querySelector('.phone-messages-list');
            if (!messagesContainer) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰è§’è‰²ç”Ÿæˆè¿‡ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›
            if (window.phoneMessagesGenerated && window.phoneMessagesCharacterId === currentChatCharacter.id) {
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>æ­£åœ¨æ‰“å¼€${currentChatCharacter.name}çš„äººé™…åœˆå¯¹è¯...</p>
                    </div>
                `;

                // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºå®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                const contextInfo = await buildPhoneContextInfo();

                const prompt = `è¯·ä¸ºè§’è‰²"${currentChatCharacter.name}"ç”Ÿæˆæ‰‹æœºä¸­çš„äººé™…åœˆå¯¹è¯åˆ—è¡¨ã€‚

${contextInfo}

ğŸš¨ ä¸¥æ ¼çº¦æŸæ¡ä»¶ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1. å¿…é¡»é€å­—é€å¥ä»”ç»†é˜…è¯»ä¸Šè¿°è§’è‰²çš„å®Œæ•´äººè®¾æè¿°
2. ç»å¯¹ä¸è¦æ·»åŠ ä»»ä½•è§’è‰²è®¾å®šä¸­æ²¡æœ‰æ˜ç¡®æåŠçš„èº«ä»½ã€èŒä¸šæˆ–ç¤¾ä¼šåœ°ä½
3. å¦‚æœè§’è‰²è®¾å®šä¸­æ²¡æœ‰æåŠç‰¹æ®Šèº«ä»½ï¼Œå°±æŒ‰ç…§æœ€åŸºæœ¬çš„èº«ä»½ç”Ÿæˆè”ç³»äºº
4. å¦‚æœè§’è‰²æ˜¯å­¦ç”Ÿä¸”è®¾å®šä¸­æ²¡æœ‰æåŠå…¶ä»–èº«ä»½ï¼Œç»å¯¹ä¸è¦ç”Ÿæˆä»»ä½•å·¥ä½œç›¸å…³è”ç³»äººï¼ˆåŠ©ç†ã€å¾‹å¸ˆã€ç§å¨ç­‰ï¼‰
5. å¦‚æœè§’è‰²è®¾å®šä¸­æ²¡æœ‰æåŠå…„å¼Ÿå§å¦¹ï¼Œç»å¯¹ä¸è¦ç”Ÿæˆå…„å¼Ÿå§å¦¹è”ç³»äºº
6. ä»»ä½•ç§°è°“éƒ½å¿…é¡»ä¸è§’è‰²è®¾å®šä¸­æ˜ç¡®æè¿°çš„èº«ä»½å®Œå…¨ä¸€è‡´ï¼Œä¸è¦ä½¿ç”¨"æ€»"ã€"è€æ¿"ç­‰èŒåœºç§°è°“é™¤éè®¾å®šä¸­æ˜ç¡®æåŠ
7. å¦‚æœå¯¹è§’è‰²çš„æŸä¸ªæ–¹é¢æœ‰ç–‘é—®ï¼Œå®å¯ä¿å®ˆç”Ÿæˆä¹Ÿä¸è¦æ·»åŠ è®¾å®šä¸­æ²¡æœ‰çš„å†…å®¹
8. ä¸¥æ ¼ç¦æ­¢æ ¹æ®è§’è‰²åå­—ã€å¤–è²Œç­‰æ¨æµ‹å…¶ç¤¾ä¼šåœ°ä½æˆ–å®¶åº­èƒŒæ™¯

è¦æ±‚ï¼š
1. é¦–å…ˆä»”ç»†åˆ†æè§’è‰²çš„å®Œæ•´äººè®¾æè¿°ï¼Œç†è§£è§’è‰²çš„çœŸå®èº«ä»½ã€èŒä¸šã€ç¤¾ä¼šåœ°ä½ã€å®¶åº­èƒŒæ™¯
2. ç”Ÿæˆ5-8ä¸ªä¸åŒçš„è”ç³»äººï¼Œè”ç³»äººç±»å‹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²è®¾å®šä¸­æè¿°çš„èº«ä»½èƒŒæ™¯
3. æ¯ä¸ªè”ç³»äººéƒ½è¦æœ‰åˆç†çš„å…³ç³»è®¾å®šå’Œä¸ªæ€§ï¼Œå…³ç³»è¦çœŸå®å¯ä¿¡ä¸”ç¬¦åˆè§’è‰²è®¾å®š
4. ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆæœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼ˆ20å­—ä»¥å†…ï¼‰
5. ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆ5-10è½®å®Œæ•´çš„èŠå¤©è®°å½•ï¼ˆåŒ…å«æ—¥æœŸåˆ†éš”ã€æ”¶å‘æ¶ˆæ¯ã€æ—¶é—´ï¼‰
6. æ¶ˆæ¯å†…å®¹è¦ä¸¥æ ¼ç¬¦åˆè§’è‰²è®¾å®šä¸­çš„èº«ä»½ã€ç”Ÿæ´»èƒŒæ™¯å’Œç¤¾ä¼šåœ°ä½ï¼Œä½“ç°çœŸå®çš„äººé™…å…³ç³»
7. æ—¶é—´è¦åˆç†ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€2å¤©å‰ç­‰ï¼‰
8. å‚è€ƒè§’è‰²çš„äººè®¾ã€ä¸–ç•Œä¹¦è®¾å®šã€è®°å¿†å’Œæœ€è¿‘èŠå¤©è®°å½•æ¥ç”Ÿæˆç¬¦åˆè§’è‰²ä¸–ç•Œè§‚çš„è”ç³»äºº
9. èŠå¤©è®°å½•è¦è‡ªç„¶æœ‰è¶£ï¼Œä½“ç°è§’è‰²ä¸è”ç³»äººçš„çœŸå®å…³ç³»
10. ç»å¯¹ä¸è¦ç”Ÿæˆä¸è§’è‰²å®Œæ•´è®¾å®šå†²çªçš„å†…å®¹ï¼Œä»¥è§’è‰²çš„è¯¦ç»†æè¿°ä¸ºå”¯ä¸€å‡†åˆ™

ğŸ”¥ æœ€åæ£€æŸ¥ï¼šç”Ÿæˆå‰è¯·å†æ¬¡ç¡®è®¤ï¼š
- æ¯ä¸ªè”ç³»äººéƒ½ç¬¦åˆè§’è‰²è®¾å®šä¸­æ˜ç¡®æè¿°çš„èº«ä»½èƒŒæ™¯
- æ²¡æœ‰æ·»åŠ ä»»ä½•è®¾å®šä¸­æœªæåŠçš„èº«ä»½ã€èŒä¸šæˆ–å®¶åº­æˆå‘˜
- æ‰€æœ‰ç§°è°“éƒ½ä¸è§’è‰²çš„çœŸå®èº«ä»½åŒ¹é…
- å¦‚æœè§’è‰²åªæ˜¯æ™®é€šå­¦ç”Ÿï¼Œè”ç³»äººåº”è¯¥æ˜¯åŒå­¦ã€æœ‹å‹ã€å®¶äººï¼Œä¸åº”è¯¥æœ‰å·¥ä½œç›¸å…³äººå‘˜

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{
  "contacts": [
    {
      "name": "è”ç³»äººå§“å",
      "relationship": "å…³ç³»ï¼ˆå¦‚ï¼šå¥½å‹ã€åŒäº‹ã€å®¶äººç­‰ï¼‰",
      "avatar": {
        "icon": "fas fa-heart",
        "color": "#FF6B6B"
      },
      "lastMessage": "æœ€æ–°æ¶ˆæ¯å†…å®¹",
      "time": "æ—¶é—´",
      "chatHistory": [
        {
          "type": "date",
          "content": "ä»Šå¤©"
        },
        {
          "type": "received",
          "content": "æ¶ˆæ¯å†…å®¹",
          "time": "10:30"
        },
        {
          "type": "sent",
          "content": "å›å¤å†…å®¹",
          "time": "10:32"
        }
      ]
    }
  ]
}

æ³¨æ„ï¼šè¯·ç¡®ä¿è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—è¯´æ˜ã€‚`;

                const response = await callPhoneAPI(prompt);
                const data = cleanAndFixJSON(response);

                if (data.contacts && Array.isArray(data.contacts)) {
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘å­˜å‚¨è”ç³»äººæ•°æ®å’Œå®Œæ•´èŠå¤©è®°å½•
                    window.phoneContactsData = data.contacts;

                    // ğŸ”¥ã€æ–°å¢ã€‘å­˜å‚¨æ¯ä¸ªè”ç³»äººçš„èŠå¤©è®°å½•
                    window.phoneContactsChats = {};
                    data.contacts.forEach(contact => {
                        if (contact.chatHistory) {
                            window.phoneContactsChats[contact.name] = contact.chatHistory;
                        }
                    });

                    // ç”ŸæˆHTML
                    const messagesHTML = data.contacts.map(contact => `
                        <div class="phone-message-item" onclick="openPhoneMessage('${contact.name}')">
                            <div class="phone-message-avatar" style="background: ${contact.avatar.color};">
                                <i class="${contact.avatar.icon}"></i>
                            </div>
                            <div class="phone-message-info">
                                <div class="phone-message-header">
                                    <div class="phone-message-name">${contact.name}</div>
                                    <div class="phone-message-time">${contact.time}</div>
                                </div>
                                <div class="phone-message-preview">${contact.lastMessage}</div>
                            </div>
                        </div>
                    `).join('');

                    messagesContainer.innerHTML = messagesHTML;
                    window.phoneMessagesGenerated = true;
                    window.phoneMessagesCharacterId = currentChatCharacter.id;
                    showToast('âœ… äººé™…åœˆå¯¹è¯æˆåŠŸæ‰“å¼€', 'success');
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ‰‹æœºæ¶ˆæ¯å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', 'warning');
                // å›é€€åˆ°é»˜è®¤æ•°æ®
                generatePhoneMessages();
            }
        }

        // ç”Ÿæˆæ¶ˆæ¯æ•°æ®
        function generatePhoneMessages() {
            const messagesContainer = document.querySelector('.phone-messages-list');
            if (!messagesContainer) return;

            const sampleMessages = [
                { name: 'å°çº¢', preview: 'ä»Šå¤©å¤©æ°”çœŸå¥½å‘¢~', time: '10:30' },
                { name: 'å°æ˜', preview: 'å‘¨æœ«ä¸€èµ·å‡ºå»ç©å§', time: 'æ˜¨å¤©' },
                { name: 'å¦ˆå¦ˆ', preview: 'è®°å¾—æŒ‰æ—¶åƒé¥­å“¦', time: 'æ˜¨å¤©' },
                { name: 'åŒäº‹å°æ', preview: 'æ˜å¤©çš„ä¼šè®®è®°å¾—å‡†å¤‡èµ„æ–™', time: '2å¤©å‰' },
                { name: 'å®¤å‹', preview: 'æ™šä¸Šä¸€èµ·çœ‹ç”µå½±å—ï¼Ÿ', time: '3å¤©å‰' }
            ];

            const messageAvatars = {
                'å°çº¢': { icon: 'fas fa-heart', color: '#FF6B6B' },
                'å°æ˜': { icon: 'fas fa-gamepad', color: '#4ECDC4' },
                'å¦ˆå¦ˆ': { icon: 'fas fa-home', color: '#45B7D1' },
                'åŒäº‹å°æ': { icon: 'fas fa-briefcase', color: '#96CEB4' },
                'å®¤å‹': { icon: 'fas fa-coffee', color: '#FECA57' }
            };

            messagesContainer.innerHTML = sampleMessages.map(msg => {
                const avatar = messageAvatars[msg.name] || { icon: 'fas fa-user', color: '#007AFF' };
                return `
                    <div class="phone-message-item" onclick="openPhoneMessage('${msg.name}')">
                        <div class="phone-message-avatar" style="background: ${avatar.color};">
                            <i class="${avatar.icon}"></i>
                        </div>
                        <div class="phone-message-info">
                            <div class="phone-message-header">
                                <div class="phone-message-name">${msg.name}</div>
                                <div class="phone-message-time">${msg.time}</div>
                            </div>
                            <div class="phone-message-preview">${msg.preview}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šè¿‡APIç”Ÿæˆè§’è‰²å¤‡å¿˜å½•
        async function generatePhoneNotesAPI() {
            const notesContainer = document.querySelector('.phone-notes-list');
            if (!notesContainer) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰è§’è‰²ç”Ÿæˆè¿‡ï¼Œå¦‚æœä¸æ˜¯åˆ™é‡æ–°ç”Ÿæˆ
            if (window.phoneNotesGenerated && window.phoneNotesCharacterId === currentChatCharacter.id) {
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                notesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>æ­£åœ¨ç”Ÿæˆ${currentChatCharacter.name}çš„å¤‡å¿˜å½•...</p>
                    </div>
                `;

                // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                const contextInfo = await buildPhoneContextInfo();

                const prompt = `è¯·ä¸ºè§’è‰²"${currentChatCharacter.name}"ç”Ÿæˆæ‰‹æœºä¸­çš„å¤‡å¿˜å½•åˆ—è¡¨ã€‚

${contextInfo}

âš ï¸ é‡è¦æé†’ï¼š
- å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§’è‰²çš„å¹´é¾„ã€èº«ä»½ã€ç”Ÿæ´»çŠ¶æ€æ¥ç”Ÿæˆå¤‡å¿˜å½•ç±»å‹
- å¦‚æœè§’è‰²æ˜¯å­¦ç”Ÿï¼Œå¤‡å¿˜å½•åº”è¯¥æ˜¯å­¦ä¹ ç›¸å…³ã€ç”Ÿæ´»ç›¸å…³ï¼Œä¸è¦æœ‰å·¥ä½œè®¡åˆ’
- å¦‚æœè§’è‰²æ˜¯ä¸Šç­æ—ï¼Œå¯ä»¥æœ‰å·¥ä½œç›¸å…³å¤‡å¿˜å½•
- å¤‡å¿˜å½•å†…å®¹è¦çœŸå®åæ˜ è§’è‰²çš„æ—¥å¸¸ç”Ÿæ´»

è¦æ±‚ï¼š
1. ç”Ÿæˆ5-7ä¸ªä¸åŒç±»å‹çš„å¤‡å¿˜å½•ï¼Œç±»å‹å¿…é¡»ç¬¦åˆè§’è‰²èº«ä»½ï¼ˆå­¦ç”Ÿï¼šå­¦ä¹ ç¬”è®°ã€ä½œä¸šæé†’ã€è€ƒè¯•å®‰æ’ç­‰ï¼›ä¸Šç­æ—ï¼šå·¥ä½œè®¡åˆ’ã€ä¼šè®®å®‰æ’ç­‰ï¼‰
2. æ¯ä¸ªå¤‡å¿˜å½•è¦æœ‰åˆé€‚çš„emojiå›¾æ ‡
3. å†…å®¹è¦ä¸¥æ ¼ç¬¦åˆè§’è‰²çš„èº«ä»½ã€å¹´é¾„å’Œç”Ÿæ´»èƒŒæ™¯
4. é¢„è§ˆæ–‡å­—æ§åˆ¶åœ¨30å­—ä»¥å†…
5. æ—¶é—´è¦åˆç†åˆ†å¸ƒ
6. å‚è€ƒè§’è‰²çš„äººè®¾ã€ä¸–ç•Œä¹¦è®¾å®šã€è®°å¿†å’Œæœ€è¿‘èŠå¤©è®°å½•æ¥ç”Ÿæˆç¬¦åˆè§’è‰²ç‰¹ç‚¹çš„å¤‡å¿˜å½•
7. ç»å¯¹ä¸è¦ç”Ÿæˆä¸è§’è‰²è®¾å®šå†²çªçš„å†…å®¹

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{
  "notes": [
    {
      "title": "ğŸ“š å¤‡å¿˜å½•æ ‡é¢˜",
      "preview": "å¤‡å¿˜å½•é¢„è§ˆå†…å®¹...",
      "time": "æ—¶é—´",
      "content": "å®Œæ•´çš„å¤‡å¿˜å½•å†…å®¹ï¼Œå¯ä»¥å¾ˆè¯¦ç»†"
    }
  ]
}

æ³¨æ„ï¼šè¯·ç¡®ä¿è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—è¯´æ˜ã€‚`;

                const response = await callPhoneAPI(prompt);
                const data = cleanAndFixJSON(response);

                if (data.notes && Array.isArray(data.notes)) {
                    // å­˜å‚¨å¤‡å¿˜å½•æ•°æ®ä¾›åç»­ä½¿ç”¨
                    window.phoneNotesData = data.notes;

                    // ç”ŸæˆHTML
                    const notesHTML = data.notes.map(note => `
                        <div class="phone-note-item" onclick="openPhoneNoteAPI('${note.title}')">
                            <div class="phone-note-title">${note.title}</div>
                            <div class="phone-note-preview">${note.preview}</div>
                            <div class="phone-note-time">${note.time}</div>
                        </div>
                    `).join('');

                    notesContainer.innerHTML = notesHTML;
                    window.phoneNotesGenerated = true;
                    window.phoneNotesCharacterId = currentChatCharacter.id;
                    showToast('âœ… å¤‡å¿˜å½•ç”Ÿæˆå®Œæˆ', 'success');
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤‡å¿˜å½•å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', 'warning');
                // å›é€€åˆ°é»˜è®¤æ•°æ®
                generatePhoneNotes();
            }
        }

        // ç”Ÿæˆå¤‡å¿˜å½•æ•°æ®ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
        function generatePhoneNotes() {
            const notesContainer = document.querySelector('.phone-notes-list');
            if (!notesContainer) return;

            const sampleNotes = [
                { title: 'ğŸ›’ è´­ç‰©æ¸…å•', preview: 'ç‰›å¥¶ã€é¢åŒ…ã€é¸¡è›‹ã€æ°´æœã€æ´—å‘æ°´...', time: 'ä»Šå¤© 14:20' },
                { title: 'ğŸ’¼ å·¥ä½œè®¡åˆ’', preview: 'å®Œæˆé¡¹ç›®æŠ¥å‘Šï¼Œå‡†å¤‡ä¸‹å‘¨çš„ä¼šè®®ï¼Œæ•´ç†å®¢æˆ·èµ„æ–™...', time: 'æ˜¨å¤© 16:45' },
                { title: 'ğŸ“š è¯»ä¹¦ç¬”è®°', preview: 'ä»Šå¤©è¯»äº†ä¸€æœ¬å¾ˆæœ‰è¶£çš„ä¹¦ï¼Œå…³äºæ—¶é—´ç®¡ç†çš„...', time: '2å¤©å‰' },
                { title: 'âœˆï¸ æ—…è¡Œè®¡åˆ’', preview: 'ä¸‹ä¸ªæœˆçš„æ—…è¡Œå®‰æ’ï¼šè®¢æœºç¥¨ã€é…’åº—ã€æ™¯ç‚¹æ”»ç•¥...', time: '1å‘¨å‰' },
                { title: 'ğŸƒâ€â™€ï¸ å¥èº«è®°å½•', preview: 'ä»Šå¤©è·‘æ­¥5å…¬é‡Œï¼Œåšäº†30åˆ†é’ŸåŠ›é‡è®­ç»ƒ...', time: '1å‘¨å‰' }
            ];

            notesContainer.innerHTML = sampleNotes.map(note => `
                <div class="phone-note-item" onclick="openPhoneNote('${note.title}')">
                    <div class="phone-note-title">${note.title}</div>
                    <div class="phone-note-preview">${note.preview}</div>
                    <div class="phone-note-time">${note.time}</div>
                </div>
            `).join('');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šè¿‡APIç”Ÿæˆè§’è‰²ç›¸å†Œ
        async function generatePhonePhotosAPI() {
            const photosContainer = document.querySelector('.phone-photos-grid');
            if (!photosContainer) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰è§’è‰²ç”Ÿæˆè¿‡ï¼Œå¦‚æœä¸æ˜¯åˆ™é‡æ–°ç”Ÿæˆ
            if (window.phonePhotosGenerated && window.phonePhotosCharacterId === currentChatCharacter.id) {
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                photosContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>æ­£åœ¨ç”Ÿæˆ${currentChatCharacter.name}çš„ç›¸å†Œ...</p>
                    </div>
                `;

                // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                const contextInfo = await buildPhoneContextInfo();

                const prompt = `è¯·ä¸ºè§’è‰²"${currentChatCharacter.name}"ç”Ÿæˆæ‰‹æœºç›¸å†Œä¸­çš„ç…§ç‰‡/è§†é¢‘æè¿°ã€‚

${contextInfo}

âš ï¸ é‡è¦æé†’ï¼š
- å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§’è‰²çš„å¹´é¾„ã€èº«ä»½ã€ç”Ÿæ´»ç¯å¢ƒæ¥ç”Ÿæˆç…§ç‰‡/è§†é¢‘ç±»å‹
- å¦‚æœè§’è‰²æ˜¯å­¦ç”Ÿï¼Œç…§ç‰‡åº”è¯¥æ˜¯æ ¡å›­ç”Ÿæ´»ã€å­¦ä¹ ã€æœ‹å‹èšä¼šç­‰ï¼Œä¸è¦æœ‰å·¥ä½œåœºæ™¯
- å¦‚æœè§’è‰²æ˜¯ä¸Šç­æ—ï¼Œå¯ä»¥æœ‰å·¥ä½œç›¸å…³ç…§ç‰‡
- ç…§ç‰‡åœºæ™¯è¦ç¬¦åˆè§’è‰²çš„å®é™…ç”Ÿæ´»çŠ¶æ€å’Œç»æµæ¡ä»¶

è¦æ±‚ï¼š
1. ç”Ÿæˆ9å¼ ç…§ç‰‡/è§†é¢‘çš„æè¿°ï¼ˆå¯ä»¥åŒ…å«è§†é¢‘ï¼‰
2. å†…å®¹è¦ä¸¥æ ¼ç¬¦åˆè§’è‰²çš„ç”Ÿæ´»èƒŒæ™¯ã€å…´è¶£çˆ±å¥½å’ŒçœŸå®ç¤¾äº¤åœˆ
3. æ¯ä¸ªç…§ç‰‡/è§†é¢‘è¦æœ‰æ ‡é¢˜ã€æ‹æ‘„æ—¶é—´å’Œè¯¦ç»†æè¿°
4. ç±»å‹è¦ç¬¦åˆè§’è‰²èº«ä»½ï¼ˆå­¦ç”Ÿï¼šæ ¡å›­ç…§ã€å­¦ä¹ ç…§ã€æœ‹å‹åˆç…§ã€ç”Ÿæ´»ç…§ç­‰ï¼›ä¸Šç­æ—ï¼šå¯åŒ…å«å·¥ä½œç…§ï¼‰
5. æè¿°è¦ç”ŸåŠ¨æœ‰è¶£ï¼Œä½“ç°è§’è‰²çš„ä¸ªæ€§ï¼Œä½†å¿…é¡»çœŸå®å¯ä¿¡
6. å‚è€ƒè§’è‰²çš„äººè®¾ã€ä¸–ç•Œä¹¦è®¾å®šã€è®°å¿†å’Œæœ€è¿‘èŠå¤©è®°å½•æ¥ç”Ÿæˆç¬¦åˆè§’è‰²ä¸–ç•Œè§‚çš„ç…§ç‰‡/è§†é¢‘
7. ç»å¯¹ä¸è¦ç”Ÿæˆä¸è§’è‰²è®¾å®šå†²çªçš„å†…å®¹

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{
  "media": [
    {
      "title": "ç…§ç‰‡/è§†é¢‘æ ‡é¢˜",
      "type": "photo", // æˆ– "video"
      "time": "æ‹æ‘„æ—¶é—´",
      "duration": "0:15", // ä»…è§†é¢‘éœ€è¦ï¼Œæ ¼å¼å¦‚ "0:15" è¡¨ç¤º15ç§’
      "description": "è¯¦ç»†æè¿°è¿™å¼ ç…§ç‰‡/è§†é¢‘çš„å†…å®¹ã€èƒŒæ™¯æ•…äº‹ã€å½“æ—¶çš„å¿ƒæƒ…ç­‰"
    }
  ]
}

æ³¨æ„ï¼šè¯·ç¡®ä¿è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—è¯´æ˜ã€‚`;

                const response = await callPhoneAPI(prompt);
                const data = cleanAndFixJSON(response);

                if (data.media && Array.isArray(data.media)) {
                    // å­˜å‚¨ç›¸å†Œæ•°æ®ä¾›åç»­ä½¿ç”¨
                    window.phonePhotosData = data.media;

                    // ç”ŸæˆHTML
                    const photosHTML = data.media.map((item, index) => `
                        <div class="phone-photo-item" data-photo-index="${index}" onclick="openPhonePhotoByIndex(${index})">
                            <div class="phone-photo-placeholder">
                                <i class="fas fa-${item.type === 'video' ? 'play-circle' : 'image'}"></i>
                            </div>
                        </div>
                    `).join('');

                    photosContainer.innerHTML = photosHTML;
                    window.phonePhotosGenerated = true;
                    window.phonePhotosCharacterId = currentChatCharacter.id;
                    showToast('âœ… ç›¸å†Œç”Ÿæˆå®Œæˆ', 'success');
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('ç”Ÿæˆç›¸å†Œå¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', 'warning');
                // å›é€€åˆ°é»˜è®¤æ•°æ®
                generatePhonePhotos();
            }
        }

        // ç”Ÿæˆç›¸å†Œæ•°æ®ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
        function generatePhonePhotos() {
            const photosContainer = document.querySelector('.phone-photos-grid');
            if (!photosContainer) return;

            // åˆ›å»º6ä¸ªæœ‰æ„ä¹‰çš„ç…§ç‰‡
            const photoTitles = ['æ˜¥æ—¥æ¨±èŠ±', 'å’–å•¡æ—¶å…‰', 'å¤•é˜³è¥¿ä¸‹', 'åŸå¸‚å¤œæ™¯', 'ç¾é£Ÿè®°å½•', 'æ—…è¡Œå›å¿†'];
            const photoItems = photoTitles.map(title => `
                <div class="phone-photo-item" onclick="openPhonePhoto('${title}')">
                    <div class="phone-photo-placeholder">
                        <i class="fas fa-image"></i>
                    </div>
                </div>
            `).join('');

            photosContainer.innerHTML = photoItems;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºè§’è‰²æ‰‹æœºä¸Šä¸‹æ–‡ä¿¡æ¯
        async function buildPhoneContextInfo() {
            let contextInfo = '';

            // 1. è§’è‰²åŸºæœ¬ä¿¡æ¯
            const characterInfo = `è§’è‰²ä¿¡æ¯ï¼š
å§“åï¼š${currentChatCharacter.name}
äººè®¾ï¼š${currentChatCharacter.description || currentChatCharacter.bio || currentChatCharacter.prompt || 'æš‚æ— æè¿°'}`;
            contextInfo += characterInfo + '\n\n';

            // 2. ä¸–ç•Œä¹¦ä¿¡æ¯
            try {
                const chatSettings = getCurrentChatSettings();
                const localBookIds = chatSettings.selectedWorldbooks || [];
                const globalBooks = window.activeGlobalWorldbooks || [];
                const allBookIds = [...new Set([...globalBooks, ...localBookIds])];

                if (allBookIds.length > 0) {
                    contextInfo += 'ä¸–ç•Œä¹¦è®¾å®šï¼š\n';
                    allBookIds.forEach((bookId, index) => {
                        const worldbook = worldbooks.find(w => w.id === bookId);
                        if (worldbook) {
                            contextInfo += `${index + 1}. ${worldbook.name || worldbook.title}ï¼š${worldbook.content}\n`;
                        }
                    });
                    contextInfo += '\n';
                }
            } catch (error) {
                console.error('è·å–ä¸–ç•Œä¹¦ä¿¡æ¯å¤±è´¥:', error);
            }

            // 3. å…¨å±€è®°å¿†ä¿¡æ¯
            try {
                const memorySettings = getGlobalMemorySettings();
                if (memorySettings.enabled !== false) {
                    const currentContext = {
                        type: currentChatCharacter.isGroup ? 'group_chat' : 'private_chat',
                        id: currentChatCharacter.id
                    };
                    const memoryContent = await buildGlobalMemoryContext(currentChatCharacter.id, currentContext, memorySettings.memoryDays || 7);
                    if (memoryContent && memoryContent.trim()) {
                        contextInfo += 'è§’è‰²è®°å¿†ï¼š\n' + memoryContent + '\n\n';
                    }
                }
            } catch (error) {
                console.error('è·å–å…¨å±€è®°å¿†å¤±è´¥:', error);
            }

            // 4. æœ€è¿‘èŠå¤©è®°å½•ï¼ˆæœ€è¿‘20è½®ï¼‰
            try {
                const characterId = currentChatCharacter.id;
                if (chatMessages[characterId] && chatMessages[characterId].length > 0) {
                    const recentMessages = chatMessages[characterId].slice(-40); // å–æœ€è¿‘40æ¡æ¶ˆæ¯ï¼ˆçº¦20è½®å¯¹è¯ï¼‰
                    if (recentMessages.length > 0) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘è·å–çœŸå®çš„ç”¨æˆ·å
                        const realUserName = getCurrentPersonaName();
                        contextInfo += 'æœ€è¿‘èŠå¤©è®°å½•ï¼š\n';
                        recentMessages.forEach(msg => {
                            const sender = msg.sender === 'sent' ? realUserName : currentChatCharacter.name;
                            contextInfo += `${sender}ï¼š${msg.content}\n`;
                        });
                        contextInfo += '\n';
                    }
                }
            } catch (error) {
                console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', error);
            }

            return contextInfo;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è°ƒè¯•è§’è‰²å¤´åƒè·å–æƒ…å†µ
        function debugCharacterAvatar() {
            if (!currentChatCharacter) {
                console.log('âŒ æ²¡æœ‰å½“å‰è§’è‰²');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            console.log('ğŸ” è§’è‰²å¤´åƒè°ƒè¯•ä¿¡æ¯:');
            console.log('  - è§’è‰²åç§°:', currentChatCharacter.name);
            console.log('  - è§’è‰²ID:', currentChatCharacter.id);
            console.log('  - èŠå¤©ä¸“ç”¨å¤´åƒ:', chatSettings.aiChatAvatar || '(æœªè®¾ç½®)');
            console.log('  - è§’è‰²å¡å¤´åƒ:', currentChatCharacter.avatarUrl || '(æœªè®¾ç½®)');

            const finalAvatar = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl || '';
            console.log('  - æœ€ç»ˆä½¿ç”¨å¤´åƒ:', finalAvatar || '(ç©ºç™½ - å°†æ˜¾ç¤ºé»˜è®¤å›¾æ ‡)');

            if (!finalAvatar) {
                console.warn('âš ï¸ è§’è‰²å¤´åƒä¸ºç©ºï¼è¯·æ£€æŸ¥ï¼š');
                console.warn('   1. æ˜¯å¦åœ¨èŠå¤©è®¾ç½®ä¸­è®¾ç½®äº†AIå¤´åƒ');
                console.warn('   2. è§’è‰²å¡æ˜¯å¦æœ‰å¤´åƒURL');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è°ƒè¯•è§’è‰²å¤‡æ³¨è®¾ç½®æƒ…å†µ
        function debugCharacterNickname() {
            if (!currentChatCharacter) {
                console.log('âŒ æ²¡æœ‰å½“å‰è§’è‰²');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            console.log('ğŸ” è§’è‰²å¤‡æ³¨è°ƒè¯•ä¿¡æ¯:');
            console.log('  - è§’è‰²åç§°:', currentChatCharacter.name);
            console.log('  - è§’è‰²ID:', currentChatCharacter.id);
            console.log('  - è®¾ç½®çš„AIæ˜µç§°:', chatSettings.aiChatNickname || '(æœªè®¾ç½®)');
            console.log('  - è®¾ç½®çš„æˆ‘çš„æ˜µç§°:', chatSettings.myChatNickname || '(æœªè®¾ç½®)');
            console.log('  - æœ€ç»ˆæ˜¾ç¤ºåç§°:', chatSettings.aiChatNickname || currentChatCharacter.name);

            // æ£€æŸ¥å…¨å±€è®¾ç½®ç¼“å­˜
            console.log('ğŸ” å…¨å±€è®¾ç½®ç¼“å­˜çŠ¶æ€:');
            if (window.chatSettings && window.chatSettings[currentChatCharacter.id]) {
                const cachedSettings = window.chatSettings[currentChatCharacter.id];
                console.log('  - ç¼“å­˜ä¸­çš„AIæ˜µç§°:', cachedSettings.aiChatNickname || '(æœªè®¾ç½®)');
                console.log('  - ç¼“å­˜ä¸­çš„æˆ‘çš„æ˜µç§°:', cachedSettings.myChatNickname || '(æœªè®¾ç½®)');
            } else {
                console.log('  - ç¼“å­˜çŠ¶æ€: æœªæ‰¾åˆ°è¯¥è§’è‰²çš„è®¾ç½®ç¼“å­˜');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²æ‰‹æœºä¸“ç”¨JSONå“åº”æ¸…ç†å’Œä¿®å¤å‡½æ•°
        function cleanAndFixJSON(response) {
            console.log('APIåŸå§‹å“åº”:', response);

            if (!response || response.trim() === '') {
                throw new Error('APIè¿”å›ç©ºå“åº”');
            }

            // æ¸…ç†APIå“åº”ï¼Œç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
            let cleanResponse = response.trim();
            if (cleanResponse.startsWith('```json')) {
                cleanResponse = cleanResponse.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            } else if (cleanResponse.startsWith('```')) {
                cleanResponse = cleanResponse.replace(/^```\s*/, '').replace(/\s*```$/, '');
            }

            console.log('æ¸…ç†åçš„å“åº”:', cleanResponse);

            if (!cleanResponse || cleanResponse.trim() === '') {
                throw new Error('æ¸…ç†åå“åº”ä¸ºç©º');
            }

            // ğŸ”¥ã€å¢å¼ºã€‘å°è¯•ä¿®å¤ä¸å®Œæ•´çš„JSON
            let jsonToparse = cleanResponse;

            // æ£€æŸ¥JSONæ˜¯å¦å®Œæ•´
            try {
                return JSON.parse(jsonToparse);
            } catch (parseError) {
                console.warn('JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤:', parseError.message);

                // å°è¯•ä¿®å¤å¸¸è§çš„JSONæˆªæ–­é—®é¢˜
                if (!jsonToparse.trim().endsWith('}')) {
                    // å¦‚æœJSONæ²¡æœ‰æ­£ç¡®ç»“æŸï¼Œå°è¯•è¡¥å…¨
                    let openBraces = (jsonToparse.match(/{/g) || []).length;
                    let closeBraces = (jsonToparse.match(/}/g) || []).length;
                    let openBrackets = (jsonToparse.match(/\[/g) || []).length;
                    let closeBrackets = (jsonToparse.match(/]/g) || []).length;

                    // è¡¥å…¨ç¼ºå¤±çš„é—­åˆç¬¦å·
                    for (let i = 0; i < openBrackets - closeBrackets; i++) {
                        jsonToparse += ']';
                    }
                    for (let i = 0; i < openBraces - closeBraces; i++) {
                        jsonToparse += '}';
                    }

                    console.log('å°è¯•ä¿®å¤åçš„JSON:', jsonToparse);

                    // å†æ¬¡å°è¯•è§£æ
                    try {
                        return JSON.parse(jsonToparse);
                    } catch (secondError) {
                        console.error('ä¿®å¤åä»ç„¶æ— æ³•è§£æJSON:', secondError.message);
                        throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}`);
                    }
                } else {
                    throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}`);
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²æ‰‹æœºAPIè°ƒç”¨æ ¸å¿ƒå‡½æ•°
        async function callPhoneAPI(prompt) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ apiSettings
            if (!apiSettings.base || !apiSettings.key) {
                throw new Error('è¯·å…ˆé…ç½®APIè®¾ç½®');
            }

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let response;

            if (isGemini) {
                // Gemini API æ ¼å¼
                const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;

                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 8192
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } else {
                // OpenAI å…¼å®¹æ ¼å¼
                let apiUrl;
                if (apiSettings.base.endsWith('/chat/completions')) {
                    apiUrl = apiSettings.base;
                } else if (apiSettings.base.endsWith('/v1')) {
                    apiUrl = `${apiSettings.base}/chat/completions`;
                } else {
                    apiUrl = `${apiSettings.base}/v1/chat/completions`;
                }

                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.8,
                        max_tokens: 8192
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }
        }

        // åˆ‡æ¢æ‰‹æœºæ ‡ç­¾é¡µ
        async function switchPhoneTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.phone-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.phone-tab[onclick*="${tabName}"]`).classList.add('active');

            // åˆ‡æ¢å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.phone-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`phone-${tabName}-content`).style.display = 'block';

            // æ ¹æ®æ ‡ç­¾é¡µç±»å‹ç”Ÿæˆå†…å®¹
            if (tabName === 'notes') {
                // ğŸ”¥ã€å¢å¼ºã€‘æ£€æŸ¥APIé…ç½®ï¼Œæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (!apiSettings.base || !apiSettings.key) {
                    console.log('APIæœªé…ç½®ï¼Œå¤‡å¿˜å½•ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                    generatePhoneNotes();
                } else {
                    try {
                        await generatePhoneNotesAPI();
                    } catch (error) {
                        console.error('å¤‡å¿˜å½•APIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
                        generatePhoneNotes();
                    }
                }
            } else if (tabName === 'photos') {
                // ğŸ”¥ã€å¢å¼ºã€‘æ£€æŸ¥APIé…ç½®ï¼Œæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (!apiSettings.base || !apiSettings.key) {
                    console.log('APIæœªé…ç½®ï¼Œç›¸å†Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                    generatePhonePhotos();
                } else {
                    try {
                        await generatePhonePhotosAPI();
                    } catch (error) {
                        console.error('ç›¸å†ŒAPIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
                        generatePhonePhotos();
                    }
                }
            }
        }

        // ğŸ”¥ã€ä¼˜åŒ–ã€‘é€šè¿‡APIç”Ÿæˆå¯¹è¯è¯¦æƒ… - ä¼˜å…ˆä½¿ç”¨å·²åŠ è½½çš„æ•°æ®
        async function generatePhoneChatMessagesAPI(contactName) {
            const messagesContainer = document.getElementById('phone-chat-messages');
            if (!messagesContainer) return;

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰èŠå¤©è®°å½•
            if (window.phoneContactsChats && window.phoneContactsChats[contactName]) {
                console.log('âœ… ä½¿ç”¨å·²åŠ è½½çš„èŠå¤©è®°å½•:', contactName);
                const chatHistory = window.phoneContactsChats[contactName];
                const contact = window.phoneContactsData?.find(c => c.name === contactName);

                // ç›´æ¥æ¸²æŸ“å·²æœ‰çš„èŠå¤©è®°å½•
                const messagesHTML = chatHistory.map(msg => {
                    if (msg.type === 'date') {
                        return `
                            <div class="phone-date-separator">
                                <span>${msg.content}</span>
                            </div>
                        `;
                    } else if (msg.type === 'received') {
                        return `
                            <div class="phone-message-bubble">
                                <div class="phone-message-row">
                                    <div class="phone-message-avatar-small" style="background: ${contact?.avatar?.color || '#007AFF'};">
                                        <i class="${contact?.avatar?.icon || 'fas fa-user'}"></i>
                                    </div>
                                    <div class="phone-message-content">
                                        <div class="phone-message-text">${msg.content}</div>
                                    </div>
                                </div>
                                <div class="phone-message-time">${msg.time}</div>
                            </div>
                        `;
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å‘é€æ¶ˆæ¯ä½¿ç”¨è§’è‰²çš„çœŸå®å¤´åƒ
                        let characterAvatarUrl = '';
                        if (currentChatCharacter) {
                            const chatSettings = getCurrentChatSettings();
                            // ä¼˜å…ˆçº§ï¼šèŠå¤©ä¸“ç”¨å¤´åƒ > è§’è‰²å¡å¤´åƒ > é»˜è®¤å›¾æ ‡
                            characterAvatarUrl = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl || '';
                        }

                        const avatarHtml = characterAvatarUrl ?
                            `<img src="${characterAvatarUrl}" alt="${currentChatCharacter?.name || 'æˆ‘'}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                            '<i class="fas fa-user"></i>';

                        return `
                            <div class="phone-message-bubble sent">
                                <div class="phone-message-row">
                                    <div class="phone-message-avatar-small" style="background: var(--color-text-lighter);">
                                        ${avatarHtml}
                                    </div>
                                    <div class="phone-message-content">
                                        <div class="phone-message-text">${msg.content}</div>
                                    </div>
                                </div>
                                <div class="phone-message-time">${msg.time}</div>
                            </div>
                        `;
                    }
                }).join('');

                messagesContainer.innerHTML = messagesHTML;

                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);

                return; // ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦APIè°ƒç”¨
            }

            // ğŸ”¥ã€å¤‡ç”¨ã€‘å¦‚æœæ²¡æœ‰é¢„åŠ è½½çš„æ•°æ®ï¼Œæ‰è¿›è¡ŒAPIè°ƒç”¨
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>æ­£åœ¨ç”Ÿæˆä¸${contactName}çš„å¯¹è¯...</p>
                    </div>
                `;

                // è·å–è”ç³»äººä¿¡æ¯
                const contact = window.phoneContactsData?.find(c => c.name === contactName);
                const relationship = contact?.relationship || 'æœ‹å‹';

                // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                const contextInfo = await buildPhoneContextInfo();

                const prompt = `è¯·ä¸ºè§’è‰²"${currentChatCharacter.name}"ç”Ÿæˆä¸"${contactName}"ï¼ˆ${relationship}ï¼‰çš„æ‰‹æœºèŠå¤©è®°å½•ã€‚

${contextInfo}

âš ï¸ é‡è¦æé†’ï¼š
- å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§’è‰²çš„å¹´é¾„ã€èº«ä»½ã€ç”Ÿæ´»çŠ¶æ€æ¥ç”Ÿæˆå¯¹è¯å†…å®¹
- å¯¹è¯å†…å®¹è¦ç¬¦åˆä¸¤äººçš„çœŸå®å…³ç³»å’Œè§’è‰²è®¾å®š
- å¦‚æœè§’è‰²æ˜¯å­¦ç”Ÿï¼Œå¯¹è¯åº”è¯¥å›´ç»•å­¦ä¹ ã€æ ¡å›­ç”Ÿæ´»ã€æœ‹å‹èšä¼šç­‰
- ç»å¯¹ä¸è¦ç”Ÿæˆä¸è§’è‰²è®¾å®šå†²çªçš„å¯¹è¯å†…å®¹

è¦æ±‚ï¼š
1. ç”Ÿæˆ5-10è½®å®Œæ•´çš„å¯¹è¯
2. å¯¹è¯è¦è‡ªç„¶ã€æœ‰è¶£ï¼Œä¸¥æ ¼ä½“ç°ä¸¤äººçš„çœŸå®å…³ç³»
3. åŒ…å«å‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯
4. æ¶ˆæ¯å†…å®¹è¦ä¸¥æ ¼ç¬¦åˆè§’è‰²èº«ä»½å’Œå…³ç³»ç±»å‹
5. å¯ä»¥åŒ…å«emojiè¡¨æƒ…
6. æ—¶é—´è¦åˆç†é€’å¢
7. å‚è€ƒè§’è‰²çš„äººè®¾ã€ä¸–ç•Œä¹¦è®¾å®šã€è®°å¿†å’Œæœ€è¿‘èŠå¤©è®°å½•æ¥ç”Ÿæˆç¬¦åˆè§’è‰²ä¸–ç•Œè§‚çš„å¯¹è¯å†…å®¹
8. ç»å¯¹ä¸è¦ç”Ÿæˆä¸è§’è‰²è®¾å®šå†²çªçš„å†…å®¹

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{
  "messages": [
    {
      "type": "date",
      "content": "ä»Šå¤©"
    },
    {
      "type": "received", // æˆ– "sent"
      "content": "æ¶ˆæ¯å†…å®¹",
      "time": "æ—¶é—´"
    }
  ]
}

æ³¨æ„ï¼šè¯·ç¡®ä¿è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—è¯´æ˜ã€‚`;

                const response = await callPhoneAPI(prompt);
                const data = cleanAndFixJSON(response);

                if (data.messages && Array.isArray(data.messages)) {
                    // ç”Ÿæˆæ¶ˆæ¯HTML
                    const messagesHTML = data.messages.map(msg => {
                        if (msg.type === 'date') {
                            return `
                                <div class="phone-date-separator">
                                    <span>${msg.content}</span>
                                </div>
                            `;
                        } else if (msg.type === 'received') {
                            return `
                                <div class="phone-message-bubble">
                                    <div class="phone-message-row">
                                        <div class="phone-message-avatar-small" style="background: ${contact?.avatar?.color || '#007AFF'};">
                                            <i class="${contact?.avatar?.icon || 'fas fa-user'}"></i>
                                        </div>
                                        <div class="phone-message-content">
                                            <div class="phone-message-text">${msg.content}</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-time">${msg.time}</div>
                                </div>
                            `;
                        } else {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å‘é€æ¶ˆæ¯ä½¿ç”¨è§’è‰²çš„çœŸå®å¤´åƒ
                            let characterAvatarUrl = '';
                            if (currentChatCharacter) {
                                const chatSettings = getCurrentChatSettings();
                                // ä¼˜å…ˆçº§ï¼šèŠå¤©ä¸“ç”¨å¤´åƒ > è§’è‰²å¡å¤´åƒ > é»˜è®¤å›¾æ ‡
                                characterAvatarUrl = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl || '';
                            }

                            const avatarHtml = characterAvatarUrl ?
                                `<img src="${characterAvatarUrl}" alt="${currentChatCharacter?.name || 'æˆ‘'}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                                '<i class="fas fa-user"></i>';

                            return `
                                <div class="phone-message-bubble sent">
                                    <div class="phone-message-row">
                                        <div class="phone-message-avatar-small" style="background: var(--color-text-lighter);">
                                            ${avatarHtml}
                                        </div>
                                        <div class="phone-message-content">
                                            <div class="phone-message-text">${msg.content}</div>
                                        </div>
                                    </div>
                                    <div class="phone-message-time">${msg.time}</div>
                                </div>
                            `;
                        }
                    }).join('');

                    messagesContainer.innerHTML = messagesHTML;

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¯¹è¯å¤±è´¥:', error);
                showToast('ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¯¹è¯', 'warning');
                // å›é€€åˆ°é»˜è®¤å¯¹è¯
                await generatePhoneChatMessages(contactName);
            }
        }

        // æ‰“å¼€æ‰‹æœºæ¶ˆæ¯è¯¦æƒ…
        async function openPhoneMessage(contactName) {
            // æ›´æ–°å¯¹è¯æ ‡é¢˜
            const titleElement = document.getElementById('phone-chat-contact-name');
            if (titleElement) {
                titleElement.textContent = contactName;
            }

            // æ˜¾ç¤ºå¯¹è¯ç•Œé¢
            hideApp('character-phone-screen');
            showApp('character-phone-chat-screen');

            // ç”Ÿæˆå¯¹è¯å†…å®¹
            await generatePhoneChatMessagesAPI(contactName);
        }

        // ç”Ÿæˆæ‰‹æœºå¯¹è¯æ¶ˆæ¯
        async function generatePhoneChatMessages(contactName) {
            const messagesContainer = document.getElementById('phone-chat-messages');
            if (!messagesContainer) return;

            // è·å–å½“å‰è§’è‰²çš„å¤´åƒï¼ˆä¼˜å…ˆèŠå¤©ä¸“ç”¨å¤´åƒï¼Œå…¶æ¬¡è§’è‰²å¡å¤´åƒï¼‰
            let characterAvatarUrl = '';
            if (currentChatCharacter) {
                const chatSettings = getCurrentChatSettings();
                characterAvatarUrl = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl || '';
            }

            // æ ¹æ®è”ç³»äººç”Ÿæˆä¸åŒçš„å¯¹è¯å†…å®¹
            const conversations = {
                'å°çº¢': [
                    { type: 'date', content: 'ä»Šå¤©' },
                    { type: 'received', content: 'æ—©ä¸Šå¥½ï¼ä»Šå¤©å¤©æ°”çœŸå¥½å‘¢~', time: '09:15' },
                    { type: 'sent', content: 'æ˜¯å•Šï¼Œé˜³å…‰å¾ˆæ¸©æš–', time: '09:16' },
                    { type: 'received', content: 'è¦ä¸è¦ä¸€èµ·å»å…¬å›­èµ°èµ°ï¼Ÿ', time: '09:17' },
                    { type: 'sent', content: 'å¥½ä¸»æ„ï¼å‡ ç‚¹å‡ºå‘ï¼Ÿ', time: '09:18' },
                    { type: 'received', content: 'ä¸‹åˆ2ç‚¹æ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨å…¬å›­é‡Œé‡é¤', time: '09:20' },
                    { type: 'sent', content: 'å®Œç¾ï¼æˆ‘å¸¦ç‚¹å°é£Ÿå’Œé¥®æ–™', time: '09:22' },
                    { type: 'received', content: 'å¤ªå¥½äº†ï¼é‚£æˆ‘å‡†å¤‡é‡é¤å«å’Œä¸€äº›æ°´æœ ğŸğŸŠ', time: '10:30' }
                ],
                'å°æ˜': [
                    { type: 'date', content: 'æ˜¨å¤©' },
                    { type: 'received', content: 'å˜¿ï¼å‘¨æœ«æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ', time: '14:30' },
                    { type: 'sent', content: 'è¿˜æ²¡æƒ³å¥½ï¼Œä½ æœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ', time: '14:32' },
                    { type: 'received', content: 'å¬è¯´æ–°å¼€äº†ä¸€å®¶æ¸¸æˆå…ï¼Œæˆ‘ä»¬å»è¯•è¯•ï¼Ÿ', time: '14:35' },
                    { type: 'sent', content: 'å¬èµ·æ¥ä¸é”™ï¼åœ¨å“ªé‡Œï¼Ÿ', time: '14:36' },
                    { type: 'received', content: 'å°±åœ¨å¸‚ä¸­å¿ƒçš„è´­ç‰©ä¸­å¿ƒä¸‰æ¥¼', time: '14:38' },
                    { type: 'received', content: 'ä»–ä»¬æœ‰æœ€æ–°çš„VRæ¸¸æˆå’Œè¡—æœº', time: '14:39' },
                    { type: 'sent', content: 'å¤ªæ£’äº†ï¼å‘¨å…­ä¸‹åˆå»æ€ä¹ˆæ ·ï¼Ÿ', time: '14:41' },
                    { type: 'received', content: 'å®Œç¾ï¼æˆ‘ä»¬2ç‚¹åœ¨é—¨å£è§é¢', time: '14:43' }
                ],
                'å¦ˆå¦ˆ': [
                    { type: 'date', content: 'æ˜¨å¤©' },
                    { type: 'received', content: 'å®è´ï¼Œè®°å¾—æŒ‰æ—¶åƒé¥­å“¦', time: '12:00' },
                    { type: 'sent', content: 'çŸ¥é“äº†å¦ˆå¦ˆï¼Œæˆ‘ä¼šæ³¨æ„çš„', time: '12:05' },
                    { type: 'received', content: 'å†°ç®±é‡Œæœ‰æˆ‘æ˜¨å¤©åšçš„æ±¤ï¼Œè®°å¾—çƒ­ä¸€ä¸‹å–', time: '12:06' },
                    { type: 'sent', content: 'å¥½çš„ï¼Œè°¢è°¢å¦ˆå¦ˆï¼', time: '12:07' },
                    { type: 'received', content: 'è¿˜æœ‰ï¼Œæ™šä¸Šæ—©ç‚¹ä¼‘æ¯ï¼Œä¸è¦ç†¬å¤œ', time: '18:30' },
                    { type: 'sent', content: 'æˆ‘ä¼šçš„ï¼Œæ‚¨ä¹Ÿè¦æ³¨æ„èº«ä½“', time: '18:32' },
                    { type: 'received', content: 'è¿™å‘¨æœ«å›å®¶åƒé¥­å—ï¼Ÿ', time: '19:00' },
                    { type: 'sent', content: 'å¥½çš„ï¼Œæˆ‘å‘¨æ—¥å›å»', time: '19:02' }
                ],
                'åŒäº‹å°æ': [
                    { type: 'date', content: '2å¤©å‰' },
                    { type: 'received', content: 'æ˜å¤©çš„ä¼šè®®è®°å¾—å‡†å¤‡èµ„æ–™', time: '16:45' },
                    { type: 'sent', content: 'å¥½çš„ï¼Œæˆ‘å·²ç»åœ¨æ•´ç†äº†', time: '16:47' },
                    { type: 'received', content: 'è€æ¿è¯´è¿™æ¬¡ä¼šè®®å¾ˆé‡è¦ï¼Œå¯èƒ½ä¼šè®¨è®ºæ–°é¡¹ç›®', time: '16:48' },
                    { type: 'sent', content: 'äº†è§£ï¼Œæˆ‘ä¼šè®¤çœŸå‡†å¤‡çš„', time: '16:50' },
                    { type: 'received', content: 'éœ€è¦æˆ‘å¸®ä½ å‡†å¤‡ä»€ä¹ˆå—ï¼Ÿ', time: '16:52' },
                    { type: 'sent', content: 'è°¢è°¢ï¼å¦‚æœæœ‰éœ€è¦æˆ‘ä¼šè”ç³»ä½ ', time: '16:54' },
                    { type: 'received', content: 'å¥½çš„ï¼ŒåŠ æ²¹ï¼ğŸ’ª', time: '16:55' }
                ],
                'å®¤å‹': [
                    { type: 'date', content: '3å¤©å‰' },
                    { type: 'received', content: 'æ™šä¸Šä¸€èµ·çœ‹ç”µå½±å—ï¼Ÿ', time: '19:30' },
                    { type: 'sent', content: 'å¥½å•Šï¼çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ', time: '19:32' },
                    { type: 'received', content: 'æˆ‘ä¹°äº†çˆ†ç±³èŠ±ï¼Œè¿˜æœ‰æ–°ä¸Šæ˜ çš„ç§‘å¹»ç‰‡', time: '19:33' },
                    { type: 'sent', content: 'å¬èµ·æ¥å¾ˆæ£’ï¼å‡ ç‚¹å¼€å§‹ï¼Ÿ', time: '19:35' },
                    { type: 'received', content: '8ç‚¹æ€ä¹ˆæ ·ï¼Ÿæˆ‘å‡†å¤‡ä¸€äº›é¥®æ–™', time: '19:36' },
                    { type: 'sent', content: 'å®Œç¾ï¼æˆ‘å¸¦ç‚¹é›¶é£Ÿ', time: '19:38' },
                    { type: 'received', content: 'å¤ªå¥½äº†ï¼ç”µå½±ä¹‹å¤œå¼€å§‹ï¼ğŸ¿ğŸ¬', time: '19:40' }
                ]
            };

            const conversation = conversations[contactName] || [
                { type: 'date', content: 'ä»Šå¤©' },
                { type: 'received', content: 'ä½ å¥½ï¼', time: '10:00' },
                { type: 'sent', content: 'ä½ å¥½ï¼', time: '10:01' }
            ];

            // è·å–è”ç³»äººå¤´åƒé…ç½®ï¼ˆä¸æ¶ˆæ¯åˆ—è¡¨ä¿æŒä¸€è‡´ï¼‰
            const contactAvatars = {
                'å°çº¢': { icon: 'fas fa-heart', color: '#FF6B6B' },
                'å°æ˜': { icon: 'fas fa-gamepad', color: '#4ECDC4' },
                'å¦ˆå¦ˆ': { icon: 'fas fa-home', color: '#45B7D1' },
                'åŒäº‹å°æ': { icon: 'fas fa-briefcase', color: '#96CEB4' },
                'å®¤å‹': { icon: 'fas fa-coffee', color: '#FECA57' }
            };

            const contactAvatar = contactAvatars[contactName] || { icon: 'fas fa-user', color: '#007AFF' };

            // ç”Ÿæˆæ¶ˆæ¯HTML
            const messagesHTML = conversation.map(msg => {
                if (msg.type === 'date') {
                    return `
                        <div class="phone-date-separator">
                            <span>${msg.content}</span>
                        </div>
                    `;
                } else if (msg.type === 'received') {
                    return `
                        <div class="phone-message-bubble">
                            <div class="phone-message-row">
                                <div class="phone-message-avatar-small" style="background: ${contactAvatar.color};">
                                    <i class="${contactAvatar.icon}"></i>
                                </div>
                                <div class="phone-message-content">
                                    <div class="phone-message-text">${msg.content}</div>
                                </div>
                            </div>
                            <div class="phone-message-time">${msg.time}</div>
                        </div>
                    `;
                } else {
                    // å‘é€æ¶ˆæ¯ä½¿ç”¨è§’è‰²çš„çœŸå®å¤´åƒ
                    const avatarHtml = characterAvatarUrl ?
                        `<img src="${characterAvatarUrl}" alt="æˆ‘" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                        '<i class="fas fa-user"></i>';

                    return `
                        <div class="phone-message-bubble sent">
                            <div class="phone-message-row">
                                <div class="phone-message-avatar-small" style="background: var(--color-text-lighter);">
                                    ${avatarHtml}
                                </div>
                                <div class="phone-message-content">
                                    <div class="phone-message-text">${msg.content}</div>
                                </div>
                            </div>
                            <div class="phone-message-time">${msg.time}</div>
                        </div>
                    `;
                }
            }).join('');

            messagesContainer.innerHTML = messagesHTML;

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // æ‰“å¼€æ‰‹æœºå¤‡å¿˜å½•è¯¦æƒ…
        function openPhoneNote(noteTitle) {
            // å¤‡å¿˜å½•æ•°æ®
            const notes = {
                'ğŸ›’ è´­ç‰©æ¸…å•': {
                    title: 'ğŸ›’ è´­ç‰©æ¸…å•',
                    time: 'ä»Šå¤© 14:20',
                    content: `ç‰›å¥¶ - 2ç›’
é¢åŒ… - 1è¢‹å…¨éº¦é¢åŒ…
é¸¡è›‹ - 1æ‰“
è‹¹æœ - 5ä¸ªçº¢å¯Œå£«
é¦™è•‰ - 1ä¸²
é…¸å¥¶ - 4æ¯
èƒ¡èåœ - 500g
è¥¿çº¢æŸ¿ - 3ä¸ª
æ´—å‘æ°´ - 1ç“¶
ç‰™è† - 1æ”¯

è®°å¾—å»è¶…å¸‚çš„æ—¶å€™å¸¦è´­ç‰©è¢‹ï¼Œç¯ä¿åˆå®ç”¨ï¼`
                },
                'ğŸ’¼ å·¥ä½œè®¡åˆ’': {
                    title: 'ğŸ’¼ å·¥ä½œè®¡åˆ’',
                    time: 'æ˜¨å¤© 16:45',
                    content: `æœ¬å‘¨å·¥ä½œå®‰æ’ï¼š

1. å®Œæˆé¡¹ç›®æŠ¥å‘Š
   - æ•´ç†æ•°æ®åˆ†æç»“æœ
   - æ’°å†™æ€»ç»“æŠ¥å‘Š
   - å‡†å¤‡æ¼”ç¤ºæ–‡ç¨¿

2. å‡†å¤‡ä¸‹å‘¨ä¼šè®®
   - æ”¶é›†å›¢é˜Ÿåé¦ˆ
   - åˆ¶å®šä¸‹é˜¶æ®µè®¡åˆ’
   - é¢„çº¦ä¼šè®®å®¤

3. å®¢æˆ·æ²Ÿé€š
   - å›å¤é‚®ä»¶
   - å®‰æ’äº§å“æ¼”ç¤º
   - è·Ÿè¿›åˆä½œè¿›å±•

4. å­¦ä¹ æå‡
   - é˜…è¯»è¡Œä¸šæŠ¥å‘Š
   - å‚åŠ åœ¨çº¿åŸ¹è®­
   - æ•´ç†å­¦ä¹ ç¬”è®°`
                },
                'ğŸ“š è¯»ä¹¦ç¬”è®°': {
                    title: 'ğŸ“š è¯»ä¹¦ç¬”è®°',
                    time: '2å¤©å‰',
                    content: `ã€Šäººç±»ç®€å²ã€‹è¯»ä¹¦ç¬”è®°

ä»Šå¤©è¯»äº†ä¸€æœ¬å¾ˆæœ‰è¶£çš„ä¹¦ï¼Œä½œè€…ä»ç‹¬ç‰¹çš„è§’åº¦è®²è¿°äº†äººç±»å‘å±•çš„å†å²ã€‚

ä¸»è¦è§‚ç‚¹ï¼š
1. è®¤çŸ¥é©å‘½ - äººç±»å­¦ä¼šäº†è™šæ„æ•…äº‹
2. å†œä¸šé©å‘½ - æ”¹å˜äº†äººç±»çš„ç”Ÿæ´»æ–¹å¼
3. ç§‘å­¦é©å‘½ - æ¨åŠ¨äº†ç°ä»£æ–‡æ˜çš„å‘å±•

å°è±¡æ·±åˆ»çš„å¥å­ï¼š
"å†å²çš„é“åˆ™å°±æ˜¯ï¼Œäº‹åçœ‹æ¥æ— å¯é¿å…çš„äº‹ï¼Œåœ¨å½“æ—¶çœ‹æ¥æ€»æ˜¯æ¯«ä¸æ˜æ˜¾ã€‚"

æ€è€ƒï¼š
äººç±»çš„å‘å±•ç¡®å®å……æ»¡äº†å¶ç„¶æ€§ï¼Œæ¯ä¸€æ¬¡é‡å¤§å˜é©éƒ½æ·±åˆ»å½±å“äº†åç»­çš„å†å²è¿›ç¨‹ã€‚è¿™è®©æˆ‘å¯¹æœªæ¥å……æ»¡äº†å¥½å¥‡å’ŒæœŸå¾…ã€‚`
                },
                'âœˆï¸ æ—…è¡Œè®¡åˆ’': {
                    title: 'âœˆï¸ æ—…è¡Œè®¡åˆ’',
                    time: '1å‘¨å‰',
                    content: `ä¸‹ä¸ªæœˆçš„æ—…è¡Œå®‰æ’ï¼š

ç›®çš„åœ°ï¼šäº¬éƒ½ã€å¤§é˜ª
æ—¶é—´ï¼š4æœˆ15æ—¥-4æœˆ22æ—¥ï¼ˆ7å¤©6å¤œï¼‰

è¡Œç¨‹å®‰æ’ï¼š
Day 1-3: äº¬éƒ½
- æ¸…æ°´å¯ºã€é‡‘é˜å¯ºã€ä¼è§ç¨»è·å¤§ç¤¾
- ç¥—å›­ã€äºŒå¹´å‚ä¸‰å¹´å‚
- å²šå±±ç«¹æ—ã€å¤©é¾™å¯º

Day 4-6: å¤§é˜ª
- å¤§é˜ªåŸã€å¿ƒæ–‹æ¡¥ã€é“é¡¿å €
- ç¯çƒå½±åŸ
- å¥ˆè‰¯ä¸€æ—¥æ¸¸ï¼ˆå–‚å°é¹¿ï¼‰

Day 7: è¿”ç¨‹

å¾…åŠäº‹é¡¹ï¼š
âœ“ è®¢æœºç¥¨
âœ“ é¢„å®šé…’åº—
â–¡ åŠç†ç­¾è¯
â–¡ å…‘æ¢æ—¥å…ƒ
â–¡ ä¸‹è½½ç¿»è¯‘app
â–¡ å‡†å¤‡è¡Œææ¸…å•

æœŸå¾…è¿™æ¬¡æ—…è¡Œï¼ğŸŒ¸`
                },
                'ğŸƒâ€â™€ï¸ å¥èº«è®°å½•': {
                    title: 'ğŸƒâ€â™€ï¸ å¥èº«è®°å½•',
                    time: '1å‘¨å‰',
                    content: `æœ¬å‘¨å¥èº«æ€»ç»“ï¼š

å‘¨ä¸€ï¼šè·‘æ­¥5å…¬é‡Œ + åŠ›é‡è®­ç»ƒ30åˆ†é’Ÿ
- é…é€Ÿï¼š6åˆ†é’Ÿ/å…¬é‡Œ
- å¿ƒç‡ï¼šå¹³å‡150bpm
- åŠ›é‡è®­ç»ƒï¼šèƒ¸éƒ¨ã€è‚©éƒ¨

å‘¨ä¸‰ï¼šç‘œä¼½60åˆ†é’Ÿ
- å“ˆä»–ç‘œä¼½
- ä¸“æ³¨å‘¼å¸å’Œæ‹‰ä¼¸
- æ„Ÿè§‰èº«å¿ƒæ”¾æ¾

å‘¨äº”ï¼šæ¸¸æ³³45åˆ†é’Ÿ
- è‡ªç”±æ³³1000ç±³
- è›™æ³³500ç±³
- æ°´ä¸­æœ‰æ°§è¿åŠ¨

å‘¨å…­ï¼šå¾’æ­¥ç™»å±±
- è·ç¦»ï¼š8å…¬é‡Œ
- çˆ¬å‡ï¼š500ç±³
- é£æ™¯å¾ˆç¾ï¼Œå¿ƒæƒ…æ„‰æ‚¦

ä¸‹å‘¨ç›®æ ‡ï¼š
- å¢åŠ è·‘æ­¥è·ç¦»åˆ°6å…¬é‡Œ
- å°è¯•æ–°çš„åŠ›é‡è®­ç»ƒåŠ¨ä½œ
- ä¿æŒæ¯å‘¨4æ¬¡è¿åŠ¨é¢‘ç‡

åšæŒå°±æ˜¯èƒœåˆ©ï¼ğŸ’ª`
                }
            };

            const note = notes[noteTitle] || {
                title: noteTitle,
                time: 'æœªçŸ¥æ—¶é—´',
                content: 'æš‚æ— å†…å®¹'
            };

            // æ›´æ–°å¤‡å¿˜å½•è¯¦æƒ…å†…å®¹
            document.getElementById('phone-note-detail-title').textContent = note.title;
            document.getElementById('phone-note-detail-time').textContent = note.time;
            document.getElementById('phone-note-detail-body').textContent = note.content;

            // æ˜¾ç¤ºå¤‡å¿˜å½•è¯¦æƒ…ç•Œé¢
            hideApp('character-phone-screen');
            showApp('character-phone-note-screen');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰“å¼€APIç”Ÿæˆçš„å¤‡å¿˜å½•è¯¦æƒ…
        function openPhoneNoteAPI(noteTitle) {
            const note = window.phoneNotesData?.find(n => n.title === noteTitle);

            if (note) {
                // æ›´æ–°å¤‡å¿˜å½•è¯¦æƒ…å†…å®¹
                document.getElementById('phone-note-detail-title').textContent = note.title;
                document.getElementById('phone-note-detail-time').textContent = note.time;
                document.getElementById('phone-note-detail-body').textContent = note.content;

                // æ˜¾ç¤ºå¤‡å¿˜å½•è¯¦æƒ…ç•Œé¢
                hideApp('character-phone-screen');
                showApp('character-phone-note-screen');
            } else {
                showToast('å¤‡å¿˜å½•æ•°æ®æœªæ‰¾åˆ°', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šè¿‡ç´¢å¼•æ‰“å¼€APIç”Ÿæˆçš„ç›¸å†Œè¯¦æƒ…
        function openPhonePhotoByIndex(photoIndex) {
            const photo = window.phonePhotosData?.[photoIndex];

            if (photo) {
                openPhonePhotoAPI(photo.title);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰“å¼€APIç”Ÿæˆçš„ç›¸å†Œè¯¦æƒ…
        function openPhonePhotoAPI(photoTitle) {
            const photo = window.phonePhotosData?.find(p => p.title === photoTitle);

            if (photo) {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®åª’ä½“ç±»å‹è®¾ç½®é¡¶éƒ¨æ ‡é¢˜
                const headerTitle = document.querySelector('#character-phone-photo-screen .app-title');
                if (headerTitle) {
                    headerTitle.textContent = photo.type === 'video' ? 'è§†é¢‘' : 'ç…§ç‰‡';
                }

                // æ›´æ–°ç…§ç‰‡è¯¦æƒ…å†…å®¹
                document.getElementById('phone-photo-detail-title').textContent = photo.title;
                document.getElementById('phone-photo-detail-time').textContent = photo.time;
                document.getElementById('phone-photo-detail-description').textContent = photo.description;

                // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®åª’ä½“ç±»å‹æ˜¾ç¤ºä¸åŒçš„é¢„è§ˆç•Œé¢
                const imageContainer = document.getElementById('phone-photo-detail-image');
                if (photo.type === 'video') {
                    // è§†é¢‘ç±»å‹æ˜¾ç¤ºè§†é¢‘æ’­æ”¾ç•Œé¢
                    imageContainer.innerHTML = `
                        <div class="phone-video-placeholder-large">
                            <i class="fas fa-play-circle"></i>
                            <p>è§†é¢‘é¢„è§ˆ</p>
                            <p style="margin-top: 5px; font-size: 14px; color: var(--color-text-lighter);">
                                ${photo.duration || '0:10'}
                            </p>
                        </div>
                    `;
                } else {
                    // ç…§ç‰‡ç±»å‹æ˜¾ç¤ºç…§ç‰‡ç•Œé¢
                    imageContainer.innerHTML = `
                        <div class="phone-photo-placeholder-large">
                            <i class="fas fa-image"></i>
                            <p>ç…§ç‰‡é¢„è§ˆ</p>
                        </div>
                    `;
                }

                // æ˜¾ç¤ºç…§ç‰‡è¯¦æƒ…ç•Œé¢
                hideApp('character-phone-screen');
                showApp('character-phone-photo-screen');
            } else {
                showToast('ç…§ç‰‡æ•°æ®æœªæ‰¾åˆ°', 'error');
            }
        }

        // æ‰“å¼€æ‰‹æœºç…§ç‰‡è¯¦æƒ…ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
        function openPhonePhoto(photoTitle) {
            // ç…§ç‰‡æ•°æ®
            const photos = {
                'æ˜¥æ—¥æ¨±èŠ±': {
                    title: 'æ˜¥æ—¥æ¨±èŠ±',
                    time: '2024å¹´3æœˆ15æ—¥ 14:30',
                    description: 'æ˜¥å¤©çš„æ¨±èŠ±ç››å¼€ï¼Œç²‰è‰²çš„èŠ±ç“£åœ¨å¾®é£ä¸­è½»èˆï¼Œä»¿ä½›åœ¨è¯‰è¯´ç€æ˜¥å¤©çš„æ•…äº‹ã€‚è¿™æ˜¯åœ¨å…¬å›­é‡Œæ‹æ‘„çš„ï¼Œå½“æ—¶é˜³å…‰æ­£å¥½ï¼Œæ¸©åº¦é€‚å®œï¼Œæ˜¯ä¸ªæ‹ç…§çš„å¥½æ—¥å­ã€‚'
                },
                'å’–å•¡æ—¶å…‰': {
                    title: 'å’–å•¡æ—¶å…‰',
                    time: '2024å¹´3æœˆ12æ—¥ 10:15',
                    description: 'å‘¨æœ«çš„æ‚ é—²æ—¶å…‰ï¼Œä¸€æ¯é¦™æµ“çš„å’–å•¡ï¼Œä¸€æœ¬å¥½ä¹¦ï¼Œè¿˜æœ‰çª—å¤–çš„é˜³å…‰ã€‚è¿™å°±æ˜¯æˆ‘æœ€å–œæ¬¢çš„ç”Ÿæ´»æ–¹å¼ï¼Œç®€å•è€Œç¾å¥½ã€‚'
                },
                'å¤•é˜³è¥¿ä¸‹': {
                    title: 'å¤•é˜³è¥¿ä¸‹',
                    time: '2024å¹´3æœˆ10æ—¥ 18:45',
                    description: 'å‚æ™šæ—¶åˆ†ï¼Œå¤•é˜³è¥¿ä¸‹ï¼Œå¤©ç©ºè¢«æŸ“æˆäº†é‡‘é»„è‰²ã€‚ç«™åœ¨å¤©å°ä¸Šçœ‹ç€è¿™ç¾ä¸½çš„æ™¯è‰²ï¼Œå¿ƒæƒ…æ ¼å¤–å¹³é™ã€‚è¿™æ ·çš„æ—¶åˆ»æ€»æ˜¯è®©äººæ„Ÿåˆ°ç”Ÿæ´»çš„ç¾å¥½ã€‚'
                },
                'åŸå¸‚å¤œæ™¯': {
                    title: 'åŸå¸‚å¤œæ™¯',
                    time: '2024å¹´3æœˆ8æ—¥ 20:30',
                    description: 'å¤œæ™šçš„åŸå¸‚ç¯ç«é€šæ˜ï¼Œé«˜æ¥¼å¤§å¦åœ¨å¤œè‰²ä¸­é—ªé—ªå‘å…‰ã€‚ä»é«˜å¤„ä¿¯ç°ï¼Œæ•´ä¸ªåŸå¸‚å°±åƒä¸€é¢—ç’€ç’¨çš„æ˜ç ï¼Œå……æ»¡äº†ç°ä»£éƒ½å¸‚çš„é­…åŠ›ã€‚'
                },
                'ç¾é£Ÿè®°å½•': {
                    title: 'ç¾é£Ÿè®°å½•',
                    time: '2024å¹´3æœˆ5æ—¥ 12:00',
                    description: 'ä»Šå¤©å°è¯•äº†ä¸€å®¶æ–°å¼€çš„é¤å…ï¼Œè¿™é“èœçš„æ‘†ç›˜å¾ˆç²¾è‡´ï¼Œå‘³é“ä¹Ÿå¾ˆä¸é”™ã€‚å’Œæœ‹å‹ä¸€èµ·äº«ç”¨ç¾é£Ÿçš„æ—¶å…‰æ€»æ˜¯ç‰¹åˆ«æ„‰å¿«ï¼Œå€¼å¾—è®°å½•ä¸‹æ¥ã€‚'
                },
                'æ—…è¡Œå›å¿†': {
                    title: 'æ—…è¡Œå›å¿†',
                    time: '2024å¹´2æœˆ28æ—¥ 16:20',
                    description: 'ä¸Šä¸ªæœˆçš„æ—…è¡Œç…§ç‰‡ï¼Œé‚£æ˜¯ä¸€æ¬¡éš¾å¿˜çš„æ—…ç¨‹ã€‚è™½ç„¶åªæ˜¯çŸ­çŸ­å‡ å¤©ï¼Œä½†æ˜¯çœ‹åˆ°äº†å¾ˆå¤šç¾ä¸½çš„é£æ™¯ï¼Œè®¤è¯†äº†æœ‰è¶£çš„äººï¼Œç•™ä¸‹äº†çè´µçš„å›å¿†ã€‚'
                }
            };

            const photo = photos[photoTitle] || {
                title: photoTitle,
                time: 'æœªçŸ¥æ—¶é—´',
                description: 'æš‚æ— æè¿°'
            };

            // æ›´æ–°ç…§ç‰‡è¯¦æƒ…å†…å®¹
            document.getElementById('phone-photo-detail-title').textContent = photo.title;
            document.getElementById('phone-photo-detail-time').textContent = photo.time;
            document.getElementById('phone-photo-detail-description').textContent = photo.description;

            // æ˜¾ç¤ºç…§ç‰‡è¯¦æƒ…ç•Œé¢
            hideApp('character-phone-screen');
            showApp('character-phone-photo-screen');
        }




        // æ˜¾ç¤ºè§’è‰²è¶³è¿¹
        async function showCharacterFootprints() {


            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸æ”¯æŒè¶³è¿¹åŠŸèƒ½', 'error');
                return;
            }

            currentFootprintsCharacter = currentChatCharacter;



            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜å’Œå¤´åƒ
            const nameElement = document.getElementById('footprints-character-name');
            const avatarElement = document.getElementById('footprints-character-avatar');

            if (nameElement) {
                nameElement.textContent = `${currentChatCharacter.name}çš„è¶³è¿¹`;
            }

            if (avatarElement) {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜å…ˆæ˜¾ç¤ºè§’è‰²åœ¨åŠ¨æ€ä¸­çš„å¤´åƒï¼Œç„¶åæ˜¯è§’è‰²å¡å¤´åƒ
                const characterAvatar = await getCharacterDisplayAvatar(currentChatCharacter);
                if (characterAvatar) {
                    avatarElement.innerHTML = `<img src="${characterAvatar}" alt="${currentChatCharacter.name}">`;
                } else {
                    avatarElement.innerHTML = '<i class="fas fa-user"></i>';
                }
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            showModal('character-footprints-modal');

            // åŠ è½½è¶³è¿¹æ•°æ®
            loadCharacterFootprints();

            // è®¾ç½®è‡ªåŠ¨æ›´æ–°
            setupFootprintsAutoUpdate();

            // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤ç”¨æˆ·çš„è‡ªåŠ¨æ›´æ–°è®¾ç½®
            restoreFootprintsAutoUpdateSetting();
        }

        // éšè—è§’è‰²è¶³è¿¹
        function hideCharacterFootprints(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }

            hideModal('character-footprints-modal');

            // æ¸…é™¤è‡ªåŠ¨æ›´æ–°å®šæ—¶å™¨
            if (footprintsUpdateTimer) {
                clearInterval(footprintsUpdateTimer);
                footprintsUpdateTimer = null;
            }

            currentFootprintsCharacter = null;
        }

        // ğŸ”¥ã€é‡æ„ã€‘åŠ è½½è§’è‰²è¶³è¿¹æ•°æ® - æ”¯æŒå¢é‡æ›´æ–°
        async function loadCharacterFootprints(forceRefresh = false) {
            if (!currentFootprintsCharacter) return;

            const timelineElement = document.getElementById('footprints-timeline');
            if (!timelineElement) return;

            const characterId = currentFootprintsCharacter.id;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥ä»Šæ—¥ç¼“å­˜å’Œå¢é‡æ›´æ–°é€»è¾‘
            if (!forceRefresh) {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥DOMä¸­çš„è¶³è¿¹æ˜¯å¦å±äºå½“å‰è§’è‰²
                const existingFootprints = timelineElement.querySelectorAll('.footprint-item');
                if (existingFootprints.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªè§’è‰²çš„è¶³è¿¹ï¼ˆé€šè¿‡æ£€æŸ¥ç¼“å­˜çš„è§’è‰²IDï¼‰
                    const lastCharacterId = timelineElement.dataset.characterId;
                    if (lastCharacterId === characterId) {
                        console.log(`ğŸ­ DOMä¸­å·²æœ‰å½“å‰è§’è‰² ${characterId} çš„ ${existingFootprints.length} ä¸ªè¶³è¿¹ï¼Œè·³è¿‡é‡æ–°æ¸²æŸ“`);
                        return; // é¿å…è¦†ç›–å·²ç»è¿½åŠ çš„æ–°è¶³è¿¹
                    } else {
                        console.log(`ğŸ”„ DOMä¸­æ˜¯å…¶ä»–è§’è‰² ${lastCharacterId} çš„è¶³è¿¹ï¼Œæ¸…ç©ºå¹¶é‡æ–°åŠ è½½è§’è‰² ${characterId} çš„è¶³è¿¹`);
                        timelineElement.innerHTML = ''; // æ¸…ç©ºå…¶ä»–è§’è‰²çš„è¶³è¿¹
                    }
                }

                const cachedData = await getFootprintsCache(characterId);
                if (cachedData) {
                    const cacheAge = Date.now() - cachedData.timestamp;
                    const lastUpdateAge = Date.now() - cachedData.lastUpdateTime;
                    const cacheHours = Math.floor(cacheAge / (60 * 60 * 1000));
                    const cacheMinutes = Math.floor((cacheAge % (60 * 60 * 1000)) / (60 * 1000));

                    console.log(`ğŸ“¦ ä»æ•°æ®åº“åŠ è½½è¶³è¿¹ï¼Œå…± ${cachedData.data.activities?.length || 0} ä¸ªæ´»åŠ¨`);
                    console.log('ğŸ“¦ ç¼“å­˜æ•°æ®:', cachedData.data);

                    // ç›´æ¥ä½¿ç”¨ç¼“å­˜
                    await renderFootprintsTimeline(cachedData.data, true);
                    return;
                } else {
                    // ğŸ”¥ã€ç®€åŒ–ã€‘æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œç›´æ¥ç”Ÿæˆä»0:00åˆ°å½“å‰æ—¶é—´çš„è¶³è¿¹
                    console.log('ğŸ“ æ²¡æœ‰ä»Šæ—¥è¶³è¿¹ç¼“å­˜ï¼Œç”Ÿæˆä»0:00åˆ°å½“å‰æ—¶é—´çš„è¶³è¿¹');
                    await generateTodayFootprints();
                    return;
                }
            }

            // ğŸ”¥ã€ç®€åŒ–ã€‘æ‰‹åŠ¨åˆ·æ–° - åƒèŠå¤©ä¸€æ ·åœ¨é¡¶éƒ¨è¿½åŠ 
            if (forceRefresh) {
                console.log('æ‰‹åŠ¨åˆ·æ–°ï¼šå°è¯•å¢é‡æ›´æ–°...');

                // ğŸ”¥ã€ç®€åŒ–ã€‘åœ¨é¡¶éƒ¨æ’å…¥åŠ è½½çŠ¶æ€ï¼Œä¸æ¸…ç©ºåŸæœ‰å†…å®¹
                timelineElement.insertAdjacentHTML('afterbegin', `
                    <div class="footprint-item footprints-loading-item">
                        <div class="footprint-time">--:--</div>
                        <div class="footprint-content">
                            <p class="footprint-activity">
                                <i class="fas fa-sync-alt fa-spin"></i> è¡Œç¨‹æŠ¥å¤‡ä¸­...
                            </p>
                            <p class="footprint-location">
                                <i class="fas fa-map-marker-alt"></i> è¯·ç¨å€™
                            </p>
                        </div>
                    </div>
                `);

                const updateResult = await tryIncrementalUpdate(currentFootprintsCharacter);

                // ç§»é™¤åŠ è½½çŠ¶æ€
                const loadingItem = timelineElement.querySelector('.footprints-loading-item');
                if (loadingItem) {
                    loadingItem.remove();
                }

                if (updateResult.success && updateResult.hasNewContent) {
                    console.log(`âœ… æ‰‹åŠ¨åˆ·æ–°ï¼šå¢é‡æ›´æ–°æˆåŠŸï¼Œæ–°å¢ ${updateResult.newCount} ä¸ªæ´»åŠ¨`);
                    showToast(`æ–°å¢äº† ${updateResult.newCount} ä¸ªè¶³è¿¹`, 'success');
                } else {
                    console.log('â„¹ï¸ æ‰‹åŠ¨åˆ·æ–°ï¼šå½“å‰æ—¶é—´æ®µæš‚æ— æ–°æ´»åŠ¨');
                    showToast('å½“å‰æ—¶é—´æ®µæš‚æ— æ–°æ´»åŠ¨', 'info');
                }
                return; // ğŸ”¥ã€å…³é”®ã€‘æ‰‹åŠ¨åˆ·æ–°å®Œæˆï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåé¢çš„å®Œæ•´ç”Ÿæˆ
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            timelineElement.innerHTML = `
                <div class="footprints-loading">
                    <i class="fas fa-brain fa-pulse"></i>
                    <p>æ­£åœ¨åŸºäºè§’è‰²äººè®¾ç”Ÿæˆè¶³è¿¹...</p>
                    <p class="loading-detail">åˆ†æè§’è‰²æ€§æ ¼ã€ä¸–ç•Œä¹¦è®¾å®šå’Œè®°å¿†æ•°æ®ä¸­</p>
                </div>
            `;

            try {
                await generateSampleFootprints();
            } catch (error) {
                console.error('åŠ è½½è¶³è¿¹å¤±è´¥:', error);
                timelineElement.innerHTML = `
                    <div class="footprints-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>åŠ è½½è¶³è¿¹å¤±è´¥</p>
                        <p>è¯·ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }

        // ğŸ”¥ã€ç®€åŒ–ã€‘ç”Ÿæˆä»Šæ—¥è¶³è¿¹ï¼ˆä»0:00åˆ°å½“å‰æ—¶é—´ï¼‰
        async function generateTodayFootprints() {
            const timelineElement = document.getElementById('footprints-timeline');
            if (!timelineElement || !currentFootprintsCharacter) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            timelineElement.innerHTML = `
                <div class="footprints-loading">
                    <div class="footprints-loading-spinner"></div>
                    <p>æ­£åœ¨æŸ¥çœ‹ä»Šæ—¥è¶³è¿¹...</p>
                    <p class="loading-detail">ä»Šæ—¥è¡Œç¨‹æŠ¥å¤‡ä¸­</p>
                </div>
            `;

            try {
                const now = new Date();
                // ç®€å•ç²—æš´ï¼šä»ä»Šå¤©0:00å¼€å§‹åˆ°å½“å‰æ—¶é—´
                const startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

                // ä½¿ç”¨å¢é‡æ›´æ–°é€»è¾‘
                const incrementalPrompt = await buildIncrementalFootprintsPrompt(currentFootprintsCharacter, startTime, now);
                const footprintsData = await generateCharacterFootprints(incrementalPrompt);

                if (footprintsData && footprintsData.activities && footprintsData.activities.length > 0) {
                    await renderFootprintsTimeline(footprintsData);
                    await setFootprintsCache(currentFootprintsCharacter.id, footprintsData);
                    console.log('âœ… ä»Šæ—¥è¶³è¿¹ç”Ÿæˆå®Œæˆ');
                } else {
                    throw new Error('AIæœªç”Ÿæˆæœ‰æ•ˆè¶³è¿¹');
                }
            } catch (error) {
                console.error('ç”Ÿæˆè¶³è¿¹å¤±è´¥:', error);
                timelineElement.innerHTML = `
                    <div class="footprints-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>ç”Ÿæˆè¶³è¿¹å¤±è´¥</p>
                        <p>è¯·ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }

        // ç”ŸæˆAIé©±åŠ¨çš„è§’è‰²è¶³è¿¹æ•°æ®
        async function generateSampleFootprints() {
            const timelineElement = document.getElementById('footprints-timeline');
            if (!timelineElement || !currentFootprintsCharacter) return;

            try {
                // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
                timelineElement.innerHTML = `
                    <div class="footprints-loading">
                        <i class="fas fa-brain fa-pulse"></i>
                        <p>æ­£åœ¨åŸºäºè§’è‰²äººè®¾ç”Ÿæˆè¶³è¿¹...</p>
                        <p class="loading-detail">åˆ†æè§’è‰²æ€§æ ¼ã€ä¸–ç•Œä¹¦è®¾å®šå’Œè®°å¿†æ•°æ®ä¸­</p>
                    </div>
                `;

                // æ„å»ºè¶³è¿¹ç”Ÿæˆçš„æç¤ºè¯
                const footprintsPrompt = await buildFootprintsPrompt();

                // è°ƒç”¨AIç”Ÿæˆè¶³è¿¹
                const footprintsData = await generateCharacterFootprints(footprintsPrompt);

                if (footprintsData && footprintsData.length > 0) {
                    await renderFootprintsTimeline(footprintsData);
                } else {
                    // å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                    timelineElement.innerHTML = `
                        <div class="footprints-empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>è¶³è¿¹ç”Ÿæˆå¤±è´¥</p>
                            <p>è¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ç”Ÿæˆè¶³è¿¹æ—¶å‡ºé”™:', error);
                timelineElement.innerHTML = `
                    <div class="footprints-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>è¶³è¿¹ç”Ÿæˆå‡ºé”™</p>
                        <p>è¯·ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }

        // æ„å»ºè¶³è¿¹ç”Ÿæˆçš„æç¤ºè¯
        async function buildFootprintsPrompt() {
            const character = currentFootprintsCharacter;



            const now = new Date();
            const currentTime = now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
            const currentDate = now.toLocaleDateString('zh-CN');

            // è·å–è§’è‰²åŸºæœ¬ä¿¡æ¯
            let characterInfo = `è§’è‰²åç§°: ${character.name}\n`;
            if (character.bio) {
                characterInfo += `è§’è‰²äººè®¾: ${character.bio}\n`;
            }
            if (character.persona) {
                characterInfo += `è§’è‰²æ€§æ ¼: ${character.persona}\n`;
            }

            // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•å’Œæ—¶é—´ä¿¡æ¯
            let chatContext = '';
            let chatTimeInfo = '';
            try {
                const recentMessages = chatMessages[character.id] || [];
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´åˆ¤æ–­ä»Šæ—¥æ¶ˆæ¯ï¼Œä¸è¶³è¿¹æ—¥æœŸé€»è¾‘ä¿æŒä¸€è‡´
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
                const todayEnd = todayStart + 24 * 60 * 60 * 1000;

                const todayMessages = recentMessages.filter(msg => {
                    if (msg.timestamp) {
                        return msg.timestamp >= todayStart && msg.timestamp < todayEnd;
                    }
                    return false;
                });

                if (todayMessages.length > 0) {
                    chatContext = '\nä»Šæ—¥å¯¹è¯è®°å½•:\n';
                    chatTimeInfo = '\nä»Šæ—¥èŠå¤©æ—¶é—´ç‚¹:\n';

                    todayMessages.forEach(msg => {
                        const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : character.name;
                        const msgTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentç¡®ä¿æ¶ˆæ¯å†…å®¹æ˜¯å­—ç¬¦ä¸²
                        const messageContent = safeExtractMessageContent(msg);
                        chatContext += `[${msgTime}] ${sender}: ${messageContent}\n`;
                        chatTimeInfo += `- ${msgTime}: ä¸ç”¨æˆ·è¿›è¡Œå¯¹è¯\n`;
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰ä»Šæ—¥æ¶ˆæ¯ï¼Œè·å–æœ€è¿‘å‡ æ¡ä½œä¸ºå‚è€ƒ
                    const lastFewMessages = recentMessages.slice(-3);
                    if (lastFewMessages.length > 0) {
                        chatContext = '\næœ€è¿‘çš„å¯¹è¯å‚è€ƒ:\n';
                        lastFewMessages.forEach(msg => {
                            const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : character.name;
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentç¡®ä¿æ¶ˆæ¯å†…å®¹æ˜¯å­—ç¬¦ä¸²
                            const messageContent = safeExtractMessageContent(msg);
                            chatContext += `${sender}: ${messageContent}\n`;
                        });
                    }
                }
            } catch (error) {
                console.log('è·å–èŠå¤©è®°å½•å¤±è´¥:', error);
            }

            // è·å–ä¸–ç•Œä¹¦ä¿¡æ¯
            let worldbookContent = '';
            try {
                const chatSettings = getCurrentChatSettings();
                const localBookIds = chatSettings.selectedWorldbooks || [];
                const globalBooks = window.activeGlobalWorldbooks || [];
                const allBookIds = [...new Set([...globalBooks, ...localBookIds])];

                if (allBookIds.length > 0) {
                    worldbookContent = '\nä¸–ç•Œä¹¦è®¾å®š:\n';
                    allBookIds.forEach((bookId, index) => {
                        const worldbook = worldbooks.find(w => w.id === bookId);
                        if (worldbook) {
                            worldbookContent += `${index + 1}. ${worldbook.name || worldbook.title}: ${worldbook.content}\n`;
                        }
                    });
                }
            } catch (error) {
                console.log('è·å–ä¸–ç•Œä¹¦ä¿¡æ¯å¤±è´¥:', error);
            }

            // è·å–å…¨å±€è®°å¿†ä¿¡æ¯
            let memoryContent = '';
            try {
                const memorySettings = getGlobalMemorySettings();
                if (memorySettings.enabled !== false) {
                    const currentContext = {
                        type: character.isGroup ? 'group_chat' : 'private_chat',
                        id: character.id
                    };
                    memoryContent = await buildGlobalMemoryContext(character.id, currentContext, memorySettings.memoryDays || 7);
                    if (memoryContent && memoryContent.trim()) {
                        memoryContent = '\nå…¨å±€è®°å¿†:\n' + memoryContent + '\n';
                    }
                }
            } catch (error) {
                console.log('è·å–å…¨å±€è®°å¿†å¤±è´¥:', error);
            }

            const prompt = `ä½ éœ€è¦ä¸ºè§’è‰²ç”Ÿæˆä»Šå¤©çš„è¡Œä¸ºè¶³è¿¹ã€‚è¯·æ ¹æ®è§’è‰²çš„äººè®¾ã€æ€§æ ¼ã€ä¸–ç•Œä¹¦è®¾å®šã€èŠå¤©è®°å½•å’Œè®°å¿†æ¥ç”Ÿæˆç¬¦åˆè§’è‰²ç‰¹ç‚¹çš„çœŸå®è¡Œä¸ºè½¨è¿¹ã€‚

${characterInfo}${worldbookContent}${chatContext}${chatTimeInfo}${memoryContent}

å½“å‰æ—¶é—´: ${currentDate} ${currentTime}

è¯·ç”Ÿæˆä»åˆç†çš„èµ·å§‹æ—¶é—´åˆ°å½“å‰æ—¶é—´(${currentTime})çš„è§’è‰²è¡Œä¸ºè¶³è¿¹ã€‚è¦æ±‚:

1. è¡Œä¸ºå¿…é¡»ç¬¦åˆè§’è‰²çš„äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹
2. å‚è€ƒä¸–ç•Œä¹¦è®¾å®šä¸­çš„èƒŒæ™¯ä¿¡æ¯
3. ç»“åˆå…¨å±€è®°å¿†ä¸­çš„ç›¸å…³ä¿¡æ¯
4. å¦‚æœæœ‰ä»Šæ—¥èŠå¤©è®°å½•ï¼Œè¯·ç¡®ä¿èŠå¤©æ—¶é—´ç‚¹çš„è¶³è¿¹æ˜¯"æ­£åœ¨ä¸ç”¨æˆ·èŠå¤©"æˆ–ç›¸å…³æ´»åŠ¨
5. å…¶ä»–æ—¶é—´ç‚¹ç”Ÿæˆåˆç†çš„æ´»åŠ¨ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç¬¦åˆè§’è‰²ç‰¹ç‚¹çš„è¡Œä¸º
6. è¡Œä¸ºè¦è‡ªç„¶ã€çœŸå®ï¼Œä½“ç°è§’è‰²çš„çœŸå®ç”Ÿæ´»
7. ä¸è¦å›é¿ä»»ä½•æ—¶é—´æ®µï¼Œè§’è‰²å¯èƒ½åœ¨ç¡è§‰ã€å·¥ä½œã€å¨±ä¹ã€ç¤¾äº¤ã€åšå®¶åŠ¡ã€æƒ…ä¾£å¤œç”Ÿæ´»ç­‰ä»»ä½•æ´»åŠ¨ï¼Œè§’è‰²è¦æ‹¥æœ‰ç¬¦åˆäººè®¾çš„ä½œæ¯
8. æ¯ä¸ªè¶³è¿¹åŒ…å«å…·ä½“æ—¶é—´ã€è¡Œä¸ºæè¿°ã€åœ°ç‚¹
9. è¡Œä¸ºç±»å‹å¯ä»¥æ˜¯: sleep(ç¡è§‰), daily(æ—¥å¸¸), work(å·¥ä½œ), leisure(ä¼‘é—²), social(ç¤¾äº¤), travel(å‡ºè¡Œ), chat(èŠå¤©), nightlife(å¤œç”Ÿæ´»), intimate(ç§å¯†), etc.

âš ï¸ é‡è¦ï¼šè¶³è¿¹æè¿°é£æ ¼è¦æ±‚
- æ¯æ¡è¶³è¿¹æè¿°å¿…é¡»åœ¨30å­—ä»¥å†…
- ä½¿ç”¨å®¢è§‚ã€ç®€æ´çš„è®°å½•é£æ ¼ï¼Œç±»ä¼¼æ—¥å¿—
- é¿å…è¿‡åº¦æ–‡è‰ºåŒ–çš„æè¿°å’Œåœºæ™¯æ¸²æŸ“
- ç›´æ¥è®°å½•è¡Œä¸ºäº‹å®ï¼Œä¸è¦è¿‡å¤šæƒ…æ„Ÿæè¿°
- æ­£ç¡®ç¤ºä¾‹ï¼š"æ­£åœ¨ä¸å¥¹èŠå¤©ï¼Œå‘Šè¯‰å¥¹è‡ªå·±ä¼šä¸€ç›´ç­‰ä¸‹å»"ã€"æ²¡ä»€ä¹ˆèƒƒå£ï¼Œéšæ„åƒäº†ç‚¹åˆé¥­"
- é”™è¯¯ç¤ºä¾‹ï¼š"èµ°å»Šçš„å£°æ§ç¯ç†„ç­ï¼Œå‘¨å›´é™·å…¥ä¸€ç‰‡é»‘æš—å’Œå¯‚é™ã€‚ä»–ä¸€åŠ¨ä¸åŠ¨ï¼Œåƒä¸€åº§é›•å¡‘"

è¯·ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªè¶³è¿¹å¯¹è±¡åŒ…å«:
{
  "time": "HH:MM",
  "activity": "å…·ä½“çš„è¡Œä¸ºæè¿°ï¼ˆ30å­—ä»¥å†…ï¼Œå®¢è§‚è®°å½•ï¼‰",
  "location": "å…·ä½“åœ°ç‚¹",
  "type": "è¡Œä¸ºç±»å‹"
}

åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–è§£é‡Šæ–‡å­—ã€‚ç¡®ä¿æ—¶é—´æŒ‰é¡ºåºæ’åˆ—ï¼Œä¸”ä¸è¶…è¿‡å½“å‰æ—¶é—´${currentTime}ã€‚`;

            return prompt;
        }

        // ğŸ”¥ã€é‡æ„ã€‘è°ƒç”¨AIç”Ÿæˆè§’è‰²è¶³è¿¹ - æ”¯æŒä¼ å…¥è§’è‰²å‚æ•°
        async function generateCharacterFootprints(prompt, character = null) {
            try {
                // ä½¿ç”¨ä¼ å…¥çš„è§’è‰²æˆ–å½“å‰è¶³è¿¹è§’è‰²
                const targetCharacter = character || currentFootprintsCharacter;
                if (!targetCharacter) {
                    console.error('âŒ generateCharacterFootprints: æ²¡æœ‰æŒ‡å®šè§’è‰²');
                    return null;
                }

                // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®ç±»å‹
                await debugDatabaseTypes();

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿currentFootprintsCharacteræœ‰æ•ˆ
                if (!currentFootprintsCharacter || typeof currentFootprintsCharacter.id !== 'string') {
                    console.error('âŒ generateCharacterFootprints: currentFootprintsCharacteræ— æ•ˆ:', currentFootprintsCharacter);
                    return null;
                }

                // ä½¿ç”¨ç°æœ‰çš„callChatAPIå‡½æ•°ï¼Œä½†è®¾ç½®ç‰¹æ®Šæ ‡è®°é¿å…è®°å½•åˆ°è®°å¿†ç³»ç»Ÿ
                const response = await callChatAPI(prompt, targetCharacter);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©ºæˆ–åŒ…å«é”™è¯¯ä¿¡æ¯
                if (!response || typeof response !== 'string') {
                    console.error('âŒ AIå“åº”ä¸ºç©ºæˆ–æ— æ•ˆ:', response);
                    return null;
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å“åº”
                if (response.includes('ç©ºå“åº”æ¬¡æ•°è¾¾åˆ°ä¸Šé™') || response.includes('è¯·ä¿®æ”¹è¾“å…¥æç¤ºè¯')) {
                    console.error('âŒ AIè¿”å›é”™è¯¯å“åº”:', response);
                    return null;
                }

                // å°è¯•è§£æJSONå“åº”
                let footprintsData;
                try {
                    // æ¸…ç†å“åº”æ–‡æœ¬ï¼Œç§»é™¤å¯èƒ½çš„markdownæ ‡è®°
                    let cleanResponse = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ¸…ç†åçš„å“åº”æ˜¯å¦ä¸ºç©º
                    if (!cleanResponse) {
                        console.error('âŒ æ¸…ç†åçš„å“åº”ä¸ºç©º');
                        return null;
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ›¿æ¢ç”¨æˆ·åå ä½ç¬¦
                    const userName = getCurrentPersonaName();
                    cleanResponse = cleanResponse.replace(/\{\{user\}\}/g, userName);

                    footprintsData = JSON.parse(cleanResponse);
                } catch (parseError) {
                    console.error('è§£æè¶³è¿¹JSONå¤±è´¥:', parseError);
                    console.log('åŸå§‹å“åº”:', response);
                    return null;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘éªŒè¯æ•°æ®æ ¼å¼ - æ”¯æŒå¯¹è±¡æ ¼å¼
                if (Array.isArray(footprintsData)) {
                    // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯æ•°ç»„
                    const filteredData = footprintsData.filter(item =>
                        item.time && item.activity && item.location && item.type
                    );
                    // ğŸ”¥ã€æ–°å¢ã€‘æ›¿æ¢æ•°ç»„ä¸­çš„ç”¨æˆ·åå ä½ç¬¦
                    const userName = getCurrentPersonaName();
                    filteredData.forEach(item => {
                        if (item.activity) item.activity = item.activity.replace(/\{\{user\}\}/g, userName);
                        if (item.location) item.location = item.location.replace(/\{\{user\}\}/g, userName);
                    });
                    return filteredData;
                } else if (footprintsData && typeof footprintsData === 'object') {
                    // æ–°æ ¼å¼ï¼šå¯¹è±¡åŒ…å«activitieså’Œlocations
                    if (footprintsData.activities && Array.isArray(footprintsData.activities)) {
                        // ğŸ”¥ã€æ–°å¢ã€‘æ›¿æ¢å¯¹è±¡ä¸­çš„ç”¨æˆ·åå ä½ç¬¦
                        const userName = getCurrentPersonaName();
                        footprintsData.activities.forEach(item => {
                            if (item.activity) item.activity = item.activity.replace(/\{\{user\}\}/g, userName);
                            if (item.location) item.location = item.location.replace(/\{\{user\}\}/g, userName);
                        });
                        if (footprintsData.locations) {
                            footprintsData.locations.forEach(item => {
                                if (item.name) item.name = item.name.replace(/\{\{user\}\}/g, userName);
                            });
                        }
                        console.log('âœ… è¶³è¿¹æ•°æ®æ ¼å¼æ­£ç¡®:', footprintsData);
                        return footprintsData;
                    } else {
                        console.error('è¶³è¿¹æ•°æ®ç¼ºå°‘activitiesæ•°ç»„:', footprintsData);
                        return null;
                    }
                } else {
                    console.error('è¶³è¿¹æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', footprintsData);
                    return null;
                }
            } catch (error) {
                console.error('è°ƒç”¨AIç”Ÿæˆè¶³è¿¹å¤±è´¥:', error);
                return null;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸²æŸ“è¶³è¿¹æ—¶é—´çº¿ - å¤„ç†æ•°æ®æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
        async function renderFootprintsTimeline(footprintsData, isFromCache = false) {
            const timelineElement = document.getElementById('footprints-timeline');
            if (!timelineElement || !currentFootprintsCharacter) return;

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç»Ÿä¸€æ•°æ®æ ¼å¼å¤„ç†
            let activities = [];
            if (Array.isArray(footprintsData)) {
                // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯æ•°ç»„
                activities = footprintsData;
            } else if (footprintsData && footprintsData.activities) {
                // æ–°æ ¼å¼ï¼šå¯¹è±¡åŒ…å«activities
                activities = footprintsData.activities;
            } else {
                console.error('âŒ è¶³è¿¹æ•°æ®æ ¼å¼é”™è¯¯:', footprintsData);
                return;
            }

            console.log(`ğŸ­ æ¸²æŸ“è¶³è¿¹æ—¶é—´çº¿: ${activities.length} ä¸ªæ´»åŠ¨`, activities);

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            const sortedFootprints = activities.sort((a, b) => b.time.localeCompare(a.time));

            const footprintsHTML = sortedFootprints.map((footprint, index) => `
                <div class="footprint-item type-${footprint.type}" style="animation-delay: ${index * 0.1}s">
                    <div class="footprint-time">${footprint.time}</div>
                    <div class="footprint-content">
                        <p class="footprint-activity">${footprint.activity}</p>
                        <p class="footprint-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${footprint.location}
                        </p>
                    </div>
                </div>
            `).join('');

            timelineElement.innerHTML = footprintsHTML;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ ‡è®°å½“å‰æ˜¾ç¤ºçš„æ˜¯å“ªä¸ªè§’è‰²çš„è¶³è¿¹
            if (currentFootprintsCharacter) {
                timelineElement.dataset.characterId = currentFootprintsCharacter.id;
            }

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘åªæœ‰æ–°ç”Ÿæˆçš„æ•°æ®æ‰ä¿å­˜åˆ°ç¼“å­˜
            if (!isFromCache && currentFootprintsCharacter) {
                await setFootprintsCache(currentFootprintsCharacter.id, footprintsData);
            }

            // ğŸ”¥ã€å·²åˆ é™¤ã€‘ç”Ÿæˆä¿¡æ¯æç¤º - æ ¹æ®ç”¨æˆ·è¦æ±‚ç§»é™¤åº•éƒ¨æç¤ºæ¶ˆæ¯
        }

        // ğŸ”¥ã€ç®€åŒ–ã€‘å¢é‡è¿½åŠ æ–°è¶³è¿¹ - åƒèŠå¤©ä¸€æ ·åœ¨é¡¶éƒ¨è¿½åŠ 
        function appendNewFootprintsToTimeline(newFootprints) {
            const timelineElement = document.getElementById('footprints-timeline');
            if (!timelineElement || !currentFootprintsCharacter) return;

            // ğŸ”¥ã€ç»Ÿä¸€æ•°æ®æ ¼å¼ã€‘
            let newActivities = [];
            if (Array.isArray(newFootprints)) {
                newActivities = newFootprints;
            } else if (newFootprints && newFootprints.activities) {
                newActivities = newFootprints.activities;
            } else {
                console.error('âŒ æ–°è¶³è¿¹æ•°æ®æ ¼å¼é”™è¯¯:', newFootprints);
                return;
            }

            if (newActivities.length === 0) {
                console.log('â„¹ï¸ æ²¡æœ‰æ–°è¶³è¿¹éœ€è¦è¿½åŠ ');
                return;
            }

            console.log(`ğŸ†• åœ¨é¡¶éƒ¨è¿½åŠ  ${newActivities.length} ä¸ªæ–°è¶³è¿¹`);

            // ğŸ”¥ã€ç®€åŒ–ã€‘æŒ‰æ—¶é—´æ’åºæ–°è¶³è¿¹ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedNewFootprints = newActivities.sort((a, b) => b.time.localeCompare(a.time));

            // ğŸ”¥ã€ä¿®å¤ã€‘åå‘éå†æ–°è¶³è¿¹ï¼Œç¡®ä¿æœ€æ–°çš„åœ¨æœ€ä¸Šæ–¹
            sortedNewFootprints.reverse().forEach((footprint, index) => {
                const footprintHTML = `
                    <div class="footprint-item type-${footprint.type || 'daily'} new-footprint" style="animation-delay: ${index * 0.2}s; opacity: 0; transform: translateY(-20px);">
                        <div class="footprint-time">${footprint.time}</div>
                        <div class="footprint-content">
                            <p class="footprint-activity">${footprint.activity}</p>
                            <p class="footprint-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${footprint.location}
                            </p>
                        </div>
                    </div>
                `;

                // ğŸ”¥ã€ç®€åŒ–ã€‘ç›´æ¥æ’å…¥åˆ°é¡¶éƒ¨
                timelineElement.insertAdjacentHTML('afterbegin', footprintHTML);
            });

            // ğŸ”¥ã€åŠ¨ç”»æ•ˆæœã€‘è®©æ–°è¶³è¿¹é€ä¸ªå‡ºç°
            setTimeout(() => {
                const newItems = timelineElement.querySelectorAll('.new-footprint');
                newItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                        item.style.transition = 'all 0.3s ease';
                        item.classList.add('highlight-new');

                        // 3ç§’åç§»é™¤é«˜äº®
                        setTimeout(() => {
                            item.classList.remove('new-footprint', 'highlight-new');
                        }, 3000);
                    }, index * 200);
                });
            }, 100);
        }



        // åˆ·æ–°è§’è‰²è¶³è¿¹
        async function refreshCharacterFootprints() {
            const refreshBtn = document.querySelector('.footprints-refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.add('refreshing');
                refreshBtn.disabled = true;
            }

            try {
                // å¼ºåˆ¶åˆ·æ–°ï¼Œä¸ä½¿ç”¨ç¼“å­˜
                await loadCharacterFootprints(true);
                showToast('è¶³è¿¹å·²æ›´æ–°', 'success');
            } catch (error) {
                console.error('åˆ·æ–°è¶³è¿¹å¤±è´¥:', error);
                showToast('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                // ç§»é™¤åˆ·æ–°åŠ¨ç”»
                setTimeout(() => {
                    if (refreshBtn) {
                        refreshBtn.classList.remove('refreshing');
                        refreshBtn.disabled = false;
                    }
                }, 1000);
            }
        }

        // æ›´æ–°è¶³è¿¹æ›´æ–°é¢‘ç‡
        function updateFootprintsFrequency() {
            setupFootprintsAutoUpdate();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤ç”¨æˆ·çš„è‡ªåŠ¨æ›´æ–°è®¾ç½®
        function restoreFootprintsAutoUpdateSetting() {
            const savedSetting = localStorage.getItem('footprints_auto_update');
            if (savedSetting) {
                const frequencySelect = document.getElementById('footprints-update-frequency');
                if (frequencySelect) {
                    frequencySelect.value = savedSetting;
                    console.log(`âœ… æ¢å¤è¶³è¿¹è‡ªåŠ¨æ›´æ–°è®¾ç½®: ${savedSetting}`);
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–è¶³è¿¹è‡ªåŠ¨æ›´æ–°
        function initializeFootprintsAutoUpdate() {
            // æ¢å¤è®¾ç½®
            restoreFootprintsAutoUpdateSetting();

            // å¦‚æœè®¾ç½®ä¸æ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œå¯åŠ¨åå°æ›´æ–°
            const savedSetting = localStorage.getItem('footprints_auto_update');
            if (savedSetting && savedSetting !== 'manual') {
                console.log('ğŸ”„ å¯åŠ¨æ—¶æ¢å¤è¶³è¿¹åå°è‡ªåŠ¨æ›´æ–°...');
                setupFootprintsAutoUpdate();
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘è®¾ç½®è¶³è¿¹è‡ªåŠ¨æ›´æ–° - æ”¯æŒåå°æ›´æ–°å’Œå¢é‡æ›´æ–°
        function setupFootprintsAutoUpdate() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (footprintsUpdateTimer) {
                clearInterval(footprintsUpdateTimer);
                footprintsUpdateTimer = null;
            }

            const frequencySelect = document.getElementById('footprints-update-frequency');
            if (!frequencySelect) return;

            const frequency = frequencySelect.value;
            if (frequency === 'manual') {
                console.log('è¶³è¿¹æ›´æ–°è®¾ç½®ä¸ºæ‰‹åŠ¨æ¨¡å¼');
                // ä¿å­˜è®¾ç½®åˆ°localStorage
                localStorage.setItem('footprints_auto_update', 'manual');
                return;
            }

            const intervalMinutes = parseInt(frequency);
            const intervalMs = intervalMinutes * 60 * 1000;

            console.log(`è®¾ç½®è¶³è¿¹è‡ªåŠ¨æ›´æ–°ï¼Œé—´éš”ï¼š${intervalMinutes}åˆ†é’Ÿï¼ˆåå°è¿è¡Œï¼‰`);

            // ä¿å­˜è®¾ç½®åˆ°localStorage
            localStorage.setItem('footprints_auto_update', frequency);

            footprintsUpdateTimer = setInterval(async () => {
                console.log('ğŸ”„ åå°è‡ªåŠ¨æ›´æ–°è¶³è¿¹æ•°æ®...');
                try {
                    // ğŸ”¥ã€å…³é”®æ”¹è¿›ã€‘åå°å¢é‡æ›´æ–°æ‰€æœ‰è§’è‰²çš„è¶³è¿¹
                    await updateAllCharacterFootprints();

                    // å¦‚æœå½“å‰æœ‰æ‰“å¼€çš„è¶³è¿¹é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                    const modal = document.getElementById('character-footprints-modal');
                    if (currentFootprintsCharacter && modal && modal.style.display !== 'none') {
                        await loadCharacterFootprints(false); // ä½¿ç”¨ç¼“å­˜ï¼Œä¸å¼ºåˆ¶åˆ·æ–°
                        console.log('âœ… å½“å‰æ‰“å¼€çš„è¶³è¿¹é¡µé¢å·²æ›´æ–°');
                    }
                } catch (error) {
                    console.error('åå°è‡ªåŠ¨æ›´æ–°è¶³è¿¹å¤±è´¥:', error);
                }
            }, intervalMs);
        }

        // ğŸ”¥ã€ç®€åŒ–ã€‘åå°æ›´æ–°æ‰€æœ‰è§’è‰²çš„è¶³è¿¹
        async function updateAllCharacterFootprints() {
            try {
                console.log(`ğŸ”„ å¼€å§‹åå°æ›´æ–°æ‰€æœ‰è§’è‰²çš„è¶³è¿¹`);

                for (const character of characters) {
                    try {
                        await updateCharacterFootprintsIncremental(character);
                    } catch (error) {
                        console.error(`æ›´æ–°è§’è‰² ${character.name} è¶³è¿¹å¤±è´¥:`, error);
                    }
                }

                console.log('âœ… åå°è¶³è¿¹æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('åå°æ›´æ–°è¶³è¿¹å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘å¢é‡æ›´æ–°å•ä¸ªè§’è‰²çš„è¶³è¿¹ - è¿”å›æ›´æ–°ç»“æœ
        async function updateCharacterFootprintsIncremental(character) {
            const characterId = character.id;
            const cachedData = await getFootprintsCache(characterId);

            if (!cachedData) {
                // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œç”Ÿæˆå®Œæ•´çš„è¶³è¿¹
                console.log(`è§’è‰² ${character.name} æ²¡æœ‰è¶³è¿¹ç¼“å­˜ï¼Œç”Ÿæˆå®Œæ•´è¶³è¿¹`);
                const fullPrompt = await buildFootprintsPrompt();
                const footprints = await generateCharacterFootprints(fullPrompt, character);
                if (footprints) {
                    await setFootprintsCache(characterId, footprints, Date.now());
                    console.log(`âœ… è§’è‰² ${character.name} å®Œæ•´è¶³è¿¹ç”ŸæˆæˆåŠŸ`);
                    return { hasNewContent: true, newCount: footprints.activities?.length || 0 };
                }
                return { hasNewContent: false, newCount: 0 };
            }

            const now = new Date();
            const lastUpdateTime = new Date(cachedData.lastUpdateTime);

            console.log(`ğŸ”„ å¢é‡æ›´æ–°è§’è‰² ${character.name} çš„è¶³è¿¹...`);

            try {
                // ğŸ”¥ã€å¢å¼ºã€‘æ£€æŸ¥æ—¶é—´é—´éš”ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„æ—¶é—´ç”Ÿæˆæ–°æ´»åŠ¨
                const timeDiffMinutes = (now - lastUpdateTime) / (1000 * 60);

                if (timeDiffMinutes < 10) {
                    console.log(`è§’è‰² ${character.name} è·ç¦»ä¸Šæ¬¡æ›´æ–°ä»…${Math.round(timeDiffMinutes)}åˆ†é’Ÿï¼Œæ—¶é—´å¤ªçŸ­ï¼Œè·³è¿‡æ›´æ–°`);
                    return { hasNewContent: false, newCount: 0 };
                }

                console.log(`ğŸ”„ ä¸ºè§’è‰² ${character.name} ç”Ÿæˆ ${Math.round(timeDiffMinutes)} åˆ†é’Ÿçš„æ–°è¶³è¿¹...`);

                // ç”Ÿæˆä»ä¸Šæ¬¡æ›´æ–°æ—¶é—´åˆ°ç°åœ¨çš„æ–°è¶³è¿¹
                const incrementalPrompt = await buildIncrementalFootprintsPrompt(character, lastUpdateTime, now);
                const newFootprints = await generateCharacterFootprints(incrementalPrompt, character);

                if (newFootprints && newFootprints.activities && newFootprints.activities.length > 0) {
                    // ğŸ”¥ã€æ”¹è¿›ã€‘å…ˆè¿½åŠ åˆ°ç¼“å­˜ï¼Œå†æ›´æ–°æ˜¾ç¤º
                    const success = await appendToFootprintsCache(characterId, newFootprints);
                    if (success) {
                        console.log(`âœ… è§’è‰² ${character.name} è¶³è¿¹å¢é‡æ›´æ–°æˆåŠŸï¼Œæ–°å¢ ${newFootprints.activities.length} ä¸ªæ´»åŠ¨`);

                        // ğŸ”¥ã€ç®€åŒ–ã€‘å¦‚æœç”¨æˆ·æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªè§’è‰²çš„è¶³è¿¹ï¼Œå®æ—¶è¿½åŠ æ–°è¶³è¿¹
                        if (currentFootprintsCharacter && currentFootprintsCharacter.id === characterId) {
                            console.log(`ğŸ­ ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹ ${character.name} çš„è¶³è¿¹ï¼Œå®æ—¶è¿½åŠ æ–°è¶³è¿¹`);
                            appendNewFootprintsToTimeline(newFootprints);
                        }
                        return { hasNewContent: true, newCount: newFootprints.activities.length };
                    } else {
                        console.error(`âŒ è§’è‰² ${character.name} ç¼“å­˜ä¿å­˜å¤±è´¥ï¼Œä½†ä»æ›´æ–°DOMæ˜¾ç¤º`);
                        // ğŸ”¥ã€å®¹é”™ã€‘å³ä½¿ç¼“å­˜å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°DOMæ˜¾ç¤º
                        if (currentFootprintsCharacter && currentFootprintsCharacter.id === characterId) {
                            console.log(`ğŸ­ ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹ ${character.name} çš„è¶³è¿¹ï¼Œå®æ—¶è¿½åŠ æ–°è¶³è¿¹ï¼ˆç¼“å­˜å¤±è´¥ä½†DOMæ›´æ–°ï¼‰`);
                            appendNewFootprintsToTimeline(newFootprints);
                        }
                        return { hasNewContent: true, newCount: newFootprints.activities.length };
                    }
                } else {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å³ä½¿AIæ²¡æœ‰è¿”å›æ´»åŠ¨ï¼Œä¹Ÿè¦è®°å½•è¿™æ¬¡å°è¯•ï¼Œé¿å…é¢‘ç¹é‡è¯•
                    console.log(`âš ï¸ è§’è‰² ${character.name} åœ¨æ­¤æ—¶é—´æ®µå†…AIæœªç”Ÿæˆæ–°æ´»åŠ¨ï¼Œä½†æ›´æ–°æ—¶é—´æˆ³ä»¥é¿å…é‡å¤å°è¯•`);

                    // æ›´æ–°lastUpdateTimeï¼Œé¿å…é¢‘ç¹é‡è¯• - ä½¿ç”¨æ•°æ®åº“
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´ï¼Œä¸çºªå¿µæ—¥åŠŸèƒ½ä¿æŒä¸€è‡´
                        const today = getLocalDateString();
                        const footprintId = `${characterId}_${today}`;
                        const existingFootprint = await db.characterFootprints.get(footprintId);
                        if (existingFootprint) {
                            existingFootprint.lastUpdateTime = Date.now();
                            await db.characterFootprints.put(existingFootprint);
                            console.log(`ğŸ”„ å·²æ›´æ–°è§’è‰² ${character.name} çš„lastUpdateTimeï¼Œé¿å…é¢‘ç¹é‡è¯•`);
                        }
                    } catch (error) {
                        console.error(`æ›´æ–°è§’è‰² ${character.name} çš„lastUpdateTimeå¤±è´¥:`, error);
                    }
                    return { hasNewContent: false, newCount: 0 };
                }
            } catch (error) {
                console.error(`è§’è‰² ${character.name} å¢é‡æ›´æ–°å¤±è´¥:`, error);
                return { hasNewContent: false, newCount: 0 };
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘å°è¯•å¢é‡æ›´æ–°ï¼ˆç”¨äºå‰å°è°ƒç”¨ï¼‰
        async function tryIncrementalUpdate(character) {
            try {
                console.log(`ğŸ”„ å¼€å§‹å¢é‡æ›´æ–°è§’è‰² ${character.name} çš„è¶³è¿¹`);

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–å¢é‡æ›´æ–°çš„å®é™…ç»“æœ
                const updateResult = await updateCharacterFootprintsIncremental(character);

                console.log(`âœ… è§’è‰² ${character.name} å¢é‡æ›´æ–°å®Œæˆï¼Œç»“æœ:`, updateResult);
                return {
                    success: true,
                    hasNewContent: updateResult.hasNewContent,
                    newCount: updateResult.newCount
                };
            } catch (error) {
                console.error('å¢é‡æ›´æ–°å¤±è´¥:', error);
                return { success: false, hasNewContent: false, newCount: 0 };
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ„å»ºå¢é‡è¶³è¿¹æç¤ºè¯ - å¼ºåŒ–è§’è‰²ç‹¬ç«‹ç”Ÿæ´»
        async function buildIncrementalFootprintsPrompt(character, fromTime, toTime) {
            const fromTimeStr = fromTime.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
            const toTimeStr = toTime.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });

            // è·å–ç°æœ‰è¶³è¿¹ä½œä¸ºä¸Šä¸‹æ–‡
            const cachedData = await getFootprintsCache(character.id);
            const existingActivities = cachedData?.data?.activities || [];

            // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•
            const recentMessages = await getRecentChatContext(character.id, fromTime, toTime);

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–æœ€åä¸€ä¸ªæ´»åŠ¨ä½œä¸ºè¿ç»­æ€§å‚è€ƒ
            const lastActivity = existingActivities.length > 0 ? existingActivities[existingActivities.length - 1] : null;
            const lastActivityInfo = lastActivity ?
                `æœ€åæ´»åŠ¨: ${lastActivity.time} - ${lastActivity.activity} (åœ¨${lastActivity.location}ï¼Œå¿ƒæƒ…${lastActivity.mood || 'æ­£å¸¸'})` :
                'ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•çš„æ´»åŠ¨';

            // ğŸ”¥ã€æ–°å¢ã€‘åˆ†ææ—¶é—´æ®µç‰¹ç‚¹
            const timeAnalysis = analyzeTimeSegment(fromTime, toTime);

            // ğŸ”¥ã€æ–°å¢ã€‘åˆ¤æ–­æ˜¯å¦æœ‰èŠå¤©äº’åŠ¨
            const hasChat = !recentMessages.includes('æ­¤æ—¶é—´æ®µå†…æ²¡æœ‰èŠå¤©è®°å½•');

            const prompt = `ä½ éœ€è¦ä¸ºè§’è‰²ç”Ÿæˆä» ${fromTimeStr} åˆ° ${toTimeStr} è¿™ä¸ªæ—¶é—´æ®µçš„æ–°è¡Œä¸ºè¶³è¿¹ã€‚

è§’è‰²ä¿¡æ¯:
- å§“å: ${character.name}
- äººè®¾: ${character.personality || 'æš‚æ— '}

å½“å‰çŠ¶æ€:
${lastActivityInfo}

æ—¶é—´æ®µåˆ†æ:
${timeAnalysis}

ç”¨æˆ·äº’åŠ¨æƒ…å†µ:
${recentMessages}

å·²æœ‰è¶³è¿¹ï¼ˆä¿æŒè¿ç»­æ€§ï¼‰:
${existingActivities.map(act => `${act.time} - ${act.activity} (${act.location}) [${act.mood || 'æ­£å¸¸'}]`).join('\n') || 'ä»Šå¤©è¿˜æ²¡æœ‰è¶³è¿¹è®°å½•'}

ç”Ÿæˆè¦æ±‚ï¼š
1. **è§’è‰²æ˜¯æ´»ç”Ÿç”Ÿçš„äºº** - ${hasChat ? 'ç»“åˆä¸ç”¨æˆ·çš„äº’åŠ¨ï¼ŒåŒæ—¶' : 'å³ä½¿æ²¡æœ‰ç”¨æˆ·äº’åŠ¨ï¼Œä¹Ÿè¦'}æœ‰è‡ªå·±çš„ç”Ÿæ´»èŠ‚å¥
2. **ä¿æŒé€»è¾‘è¿ç»­æ€§** - åŸºäºæœ€åä¸€ä¸ªæ´»åŠ¨çš„ä½ç½®å’ŒçŠ¶æ€è‡ªç„¶è¿‡æ¸¡
3. **ç¬¦åˆæ—¶é—´ç‰¹ç‚¹** - è€ƒè™‘${timeAnalysis}çš„æ´»åŠ¨ç‰¹å¾
4. **ä½“ç°è§’è‰²ä¸ªæ€§** - æ´»åŠ¨è¦ç¬¦åˆ${character.name}çš„æ€§æ ¼ç‰¹å¾
5. **ç”Ÿæ´»è¦çœŸå®ä¸°å¯Œ** - åŒ…æ‹¬å·¥ä½œã€ä¼‘æ¯ã€å¨±ä¹ã€ç¤¾äº¤ã€ç§å¯†æ—¶å…‰ç­‰å„ä¸ªæ–¹é¢
6. **æƒ…ç»ªæœ‰å˜åŒ–** - å¿ƒæƒ…è¦æœ‰è‡ªç„¶çš„èµ·ä¼å’Œå˜åŒ–
7. **ä¸å›é¿ä»»ä½•æ´»åŠ¨** - å¯ä»¥æ˜¯ç¡è§‰ã€å·¥ä½œã€å¨±ä¹ã€å¤œç”Ÿæ´»ã€ç§å¯†æ´»åŠ¨ç­‰ä»»ä½•ç¬¦åˆè§’è‰²çš„è¡Œä¸º

âš ï¸ è¶³è¿¹æè¿°é£æ ¼è¦æ±‚ï¼š
- æ¯æ¡è¶³è¿¹æè¿°å¿…é¡»åœ¨30å­—ä»¥å†…
- ä½¿ç”¨å®¢è§‚ã€ç®€æ´çš„è®°å½•é£æ ¼ï¼Œç±»ä¼¼æ—¥å¿—
- é¿å…è¿‡åº¦æ–‡è‰ºåŒ–çš„æè¿°å’Œåœºæ™¯æ¸²æŸ“
- ç›´æ¥è®°å½•è¡Œä¸ºäº‹å®ï¼Œä¸è¦è¿‡å¤šæƒ…æ„Ÿæè¿°
- æ­£ç¡®ç¤ºä¾‹ï¼š"æ­£åœ¨ä¸å¥¹èŠå¤©ï¼Œå‘Šè¯‰å¥¹è‡ªå·±ä¼šä¸€ç›´ç­‰ä¸‹å»"ã€"æ²¡ä»€ä¹ˆèƒƒå£ï¼Œéšæ„åƒäº†ç‚¹åˆé¥­"
- é”™è¯¯ç¤ºä¾‹ï¼š"èµ°å»Šçš„å£°æ§ç¯ç†„ç­ï¼Œå‘¨å›´é™·å…¥ä¸€ç‰‡é»‘æš—å’Œå¯‚é™ã€‚ä»–ä¸€åŠ¨ä¸åŠ¨ï¼Œåƒä¸€åº§é›•å¡‘"

é‡è¦æé†’ï¼š
- è§’è‰²æœ‰è‡ªå·±çš„å®Œæ•´ç”Ÿæ´»ï¼Œä¸å®Œå…¨ä¾èµ–ç”¨æˆ·äº’åŠ¨
- æ¯ä¸ªæ—¶é—´æ®µéƒ½åº”è¯¥æœ‰åˆç†çš„æ´»åŠ¨å®‰æ’ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆæ—¶é—´
- ${hasChat ? 'å¦‚æœæœ‰èŠå¤©ï¼Œè¦åœ¨åˆé€‚çš„æ—¶é—´ç‚¹ä½“ç°äº’åŠ¨' : 'æ²¡æœ‰èŠå¤©æ—¶ï¼Œè§’è‰²å¯ä»¥åšè‡ªå·±çš„äº‹æƒ…ï¼ˆå·¥ä½œã€å­¦ä¹ ã€ä¼‘æ¯ã€å¨±ä¹ã€ç¤¾äº¤ã€ç§å¯†æ´»åŠ¨ç­‰ï¼‰'}
- æ´»åŠ¨è¦å…·ä½“ã€å®¢è§‚ï¼Œé¿å…ç©ºæ³›å’Œæ–‡è‰ºåŒ–çš„æè¿°
- ä¸è¦å› ä¸ºæ—¶é—´æ®µè€Œé™åˆ¶æ´»åŠ¨ç±»å‹ï¼Œè§’è‰²çš„ç”Ÿæ´»åº”è¯¥æ˜¯å¤šæ ·åŒ–çš„

è¿”å›JSONæ ¼å¼ï¼š
{
    "activities": [
        {"time": "HH:MM", "activity": "å…·ä½“æ´»åŠ¨æè¿°ï¼ˆ30å­—ä»¥å†…ï¼Œå®¢è§‚è®°å½•ï¼‰", "location": "å…·ä½“åœ°ç‚¹", "mood": "å½“å‰å¿ƒæƒ…"}
    ],
    "locations": [
        {"name": "åœ°ç‚¹å", "type": "åœ°ç‚¹ç±»å‹", "description": "ç®€çŸ­æè¿°"}
    ]
}`;

            return prompt;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ†ææ—¶é—´æ®µç‰¹ç‚¹
        function analyzeTimeSegment(fromTime, toTime) {
            const fromHour = fromTime.getHours();
            const toHour = toTime.getHours();
            const duration = (toTime - fromTime) / (1000 * 60); // åˆ†é’Ÿæ•°

            let timeCharacteristics = [];

            // åˆ†ææ—¶é—´æ®µç‰¹ç‚¹
            if (fromHour >= 6 && fromHour < 9) {
                timeCharacteristics.push('æ™¨é—´æ—¶å…‰ï¼ˆé€‚åˆæ´—æ¼±ã€æ—©é¤ã€æ™¨ç»ƒã€å‡†å¤‡ä¸€å¤©çš„å·¥ä½œï¼‰');
            }
            if (fromHour >= 9 && fromHour < 12) {
                timeCharacteristics.push('ä¸Šåˆæ—¶æ®µï¼ˆç²¾åŠ›å……æ²›ï¼Œé€‚åˆé‡è¦å·¥ä½œã€å­¦ä¹ ã€åˆ›ä½œï¼‰');
            }
            if (fromHour >= 12 && fromHour < 14) {
                timeCharacteristics.push('åˆé—´ä¼‘æ¯ï¼ˆé€‚åˆç”¨é¤ã€åˆä¼‘ã€è½»æ¾æ´»åŠ¨ï¼‰');
            }
            if (fromHour >= 14 && fromHour < 18) {
                timeCharacteristics.push('ä¸‹åˆæ—¶å…‰ï¼ˆé€‚åˆç»§ç»­å·¥ä½œã€å¤„ç†äº‹åŠ¡ã€ç¤¾äº¤æ´»åŠ¨ï¼‰');
            }
            if (fromHour >= 18 && fromHour < 21) {
                timeCharacteristics.push('å‚æ™šæ—¶åˆ†ï¼ˆé€‚åˆæ™šé¤ã€æ”¾æ¾ã€å¨±ä¹ã€ä¸äººäº¤æµï¼‰');
            }
            if (fromHour >= 21 && fromHour < 24) {
                timeCharacteristics.push('å¤œæ™šæ—¶å…‰ï¼ˆé€‚åˆä¼‘é—²ã€åæ€ã€å‡†å¤‡ä¼‘æ¯ï¼‰');
            }
            if (fromHour >= 0 && fromHour < 6) {
                timeCharacteristics.push('æ·±å¤œ/å‡Œæ™¨ï¼ˆé€šå¸¸æ˜¯ä¼‘æ¯æ—¶é—´ï¼Œå¶å°”å¯èƒ½æœ‰ç‰¹æ®Šæ´»åŠ¨ï¼‰');
            }

            // åˆ†ææ—¶é•¿
            let durationDesc = '';
            if (duration <= 30) {
                durationDesc = 'çŸ­æ—¶é—´æ®µï¼Œé€‚åˆå•ä¸€ä¸“æ³¨æ´»åŠ¨';
            } else if (duration <= 120) {
                durationDesc = 'ä¸­ç­‰æ—¶é•¿ï¼Œå¯ä»¥å®‰æ’1-2ä¸ªè¿ç»­æ´»åŠ¨';
            } else {
                durationDesc = 'è¾ƒé•¿æ—¶æ®µï¼Œå¯ä»¥å®‰æ’å¤šä¸ªä¸åŒç±»å‹çš„æ´»åŠ¨';
            }

            return `${timeCharacteristics.join('ã€')}ï¼›${durationDesc}ï¼ˆæ—¶é•¿çº¦${Math.round(duration)}åˆ†é’Ÿï¼‰`;
        }

        // ğŸ”¥ã€é‡æ„ã€‘è·å–æŒ‡å®šæ—¶é—´æ®µçš„èŠå¤©ä¸Šä¸‹æ–‡ - å¢å¼ºç‹¬ç«‹ç”Ÿæ´»æŒ‡å¯¼
        async function getRecentChatContext(characterId, fromTime, toTime) {
            try {
                const messages = chatMessages[characterId] || [];
                const recentMessages = messages.filter(msg => {
                    const msgTime = new Date(msg.timestamp);
                    return msgTime >= fromTime && msgTime <= toTime;
                });

                if (recentMessages.length === 0) {
                    // ğŸ”¥ã€æ”¹è¿›ã€‘æ²¡æœ‰èŠå¤©æ—¶ç»™å‡ºæ›´ç§¯æçš„æŒ‡å¯¼
                    return `æ­¤æ—¶é—´æ®µå†…æ²¡æœ‰ä¸ç”¨æˆ·çš„èŠå¤©è®°å½•ï¼Œè§’è‰²å¯ä»¥ä¸“æ³¨äºè‡ªå·±çš„ç”Ÿæ´»ï¼š
- å¯ä»¥è¿›è¡Œæ—¥å¸¸å·¥ä½œã€å­¦ä¹ æˆ–ä¼‘æ¯
- å¯ä»¥æ€è€ƒæœ€è¿‘ä¸ç”¨æˆ·çš„å¯¹è¯å†…å®¹
- å¯ä»¥ä¸ºä¸‹æ¬¡è§é¢åšå‡†å¤‡
- å¯ä»¥äº«å—ç‹¬å¤„çš„æ—¶å…‰ï¼Œåšè‡ªå·±å–œæ¬¢çš„äº‹æƒ…
- æ ¹æ®è§’è‰²æ€§æ ¼å®‰æ’åˆé€‚çš„ä¸ªäººæ´»åŠ¨`;
                }

                const chatContext = recentMessages.map(msg => {
                    const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : 'è§’è‰²';
                    const msgTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    const content = safeExtractMessageContent(msg);
                    return `[${msgTime}] ${sender}: ${content}`;
                }).join('\n');

                return `ä¸ç”¨æˆ·æœ‰ä»¥ä¸‹äº’åŠ¨ï¼Œè§’è‰²çš„æ´»åŠ¨å¯ä»¥ä½“ç°è¿™äº›å¯¹è¯çš„å½±å“ï¼š
${chatContext}
ï¼ˆè§’è‰²å¯ä»¥åŸºäºè¿™äº›å¯¹è¯å†…å®¹è°ƒæ•´å¿ƒæƒ…å’Œåç»­æ´»åŠ¨ï¼‰`;
            } catch (error) {
                console.error('è·å–èŠå¤©ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                return 'è·å–èŠå¤©è®°å½•å¤±è´¥ï¼Œè§’è‰²æŒ‰æ­£å¸¸ç”Ÿæ´»èŠ‚å¥å®‰æ’æ´»åŠ¨';
            }
        }

        // ä¿®æ”¹è§’è‰²å¤´åƒ
        function changeCharacterAvatar() {
            // ä¸´æ—¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¾“å…¥æ¡†ï¼Œé¿å…å¹²æ‰°åŸæœ‰çš„å¤´åƒä¸Šä¼ åŠŸèƒ½
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*,.jpg,.jpeg,.png,.gif,.webp';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);

            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                        if (characterIndex !== -1) {
                            characters[characterIndex].avatarUrl = event.target.result;
                            await saveCharacters();
                            renderCharacterList();
                            renderContactList();
                            renderMessageList();
                            renderChatMessages(currentChatCharacter.id);
                        }
                        // æ¸…ç†ä¸´æ—¶å…ƒç´ 
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    // å¦‚æœç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œä¹Ÿè¦æ¸…ç†ä¸´æ—¶å…ƒç´ 
                    document.body.removeChild(tempInput);
                }
            };

            tempInput.click();
        }

        // ä¿®æ”¹å¤‡æ³¨
        async function changeCharacterNickname() {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„å¤‡æ³¨åç§°:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].name = newName.trim();
                    await saveCharacters();
                    const chatTitle = document.getElementById('api-chat-title');
                    if (chatTitle) {
                        chatTitle.textContent = newName.trim();
                        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                        chatTitle.classList.remove('typing-status');
                        chatTitle.dataset.originalTitle = newName.trim();
                    }
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                }
            }
        }

        // ğŸ”¥ã€å…¨æ–°ã€‘æŸ¥æ‰¾èŠå¤©å†…å®¹ - æ˜¾ç¤ºæœç´¢æ¨¡æ€æ¡†
        function searchChatContent() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœ
            document.getElementById('search-keyword-input').value = '';
            document.getElementById('search-results-summary').style.display = 'none';
            document.getElementById('search-results-container').style.display = 'none';

            showModal('search-chat-modal');

            // èšç„¦åˆ°æœç´¢æ¡†
            setTimeout(() => {
                document.getElementById('search-keyword-input').focus();
            }, 100);
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ‰§è¡ŒèŠå¤©æœç´¢ - æœç´¢å®Œæ•´èŠå¤©è®°å½•
        async function performChatSearch() {
            const keyword = document.getElementById('search-keyword-input').value.trim();
            if (!keyword) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä»æ•°æ®åº“è·å–å®Œæ•´çš„èŠå¤©è®°å½•ï¼Œè€Œä¸æ˜¯åªæœç´¢å†…å­˜ä¸­çš„æ¶ˆæ¯
            let allMessages = [];
            try {
                const dbMessages = await db.chatMessages
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                allMessages = dbMessages.sort((a, b) => a.timestamp - b.timestamp);

            } catch (error) {
                console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', error);
                // å¦‚æœæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°å†…å­˜ä¸­çš„æ¶ˆæ¯
                allMessages = chatMessages[currentChatCharacter.id] || [];
            }

            const foundMessages = allMessages.filter((msg, index) => {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ¶ˆæ¯å†…å®¹åœ¨messageDataå­—æ®µä¸­
                if (!msg.messageData) {
                    return false;
                }

                const messageData = msg.messageData;
                let searchText = '';

                if (typeof messageData.content === 'string') {
                    searchText = messageData.content;
                } else if (Array.isArray(messageData.content)) {
                    // å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯
                    searchText = messageData.content
                        .filter(item => item && item.type === 'text')
                        .map(item => item.text || '')
                        .join(' ');
                } else if (messageData.content && typeof messageData.content === 'object') {
                    // å¤„ç†å¯¹è±¡ç±»å‹çš„content
                    searchText = messageData.content.text || messageData.content.content || '';
                } else {
                    searchText = messageData.content ? String(messageData.content) : '';
                }

                // ç¡®ä¿searchTextæ˜¯å­—ç¬¦ä¸²
                if (typeof searchText !== 'string') {
                    searchText = '';
                }

                return searchText.toLowerCase().includes(keyword.toLowerCase());
            });


            // æ˜¾ç¤ºæœç´¢ç»Ÿè®¡
            const summaryDiv = document.getElementById('search-results-summary');
            const statsDiv = document.getElementById('search-stats');
            statsDiv.innerHTML = `
                <strong>æœç´¢ç»“æœï¼š</strong>æ‰¾åˆ° <span style="color: #007AFF; font-weight: bold;">${foundMessages.length}</span> æ¡åŒ…å«"<span style="color: #007AFF;">${keyword}</span>"çš„æ¶ˆæ¯
                <br><small style="color: #666;">ç‚¹å‡»ä»»æ„æ¶ˆæ¯æŸ¥çœ‹å‰å10æ¡æ¶ˆæ¯çš„ä¸Šä¸‹æ–‡</small>
            `;
            summaryDiv.style.display = 'block';

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            const resultsContainer = document.getElementById('search-results-container');
            const resultsList = document.getElementById('search-results-list');

            if (foundMessages.length === 0) {
                resultsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æ²¡æœ‰æ‰¾åˆ°åŒ…å«è¯¥å…³é”®è¯çš„æ¶ˆæ¯</div>';
            } else {
                resultsList.innerHTML = foundMessages.map((msg, index) => {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä»messageDataè·å–å‘é€è€…å’Œå†…å®¹ä¿¡æ¯
                    const messageData = msg.messageData;
                    if (!messageData) return '';

                    let senderName = '';
                    if (messageData.isUser || messageData.sender === 'sent') {
                        senderName = 'æˆ‘';
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
                        if (currentChatCharacter.isGroup) {


                            // ç¾¤èŠï¼šæ˜¾ç¤ºå…·ä½“çš„å‘é€è€…åç§°
                            // å°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µæ¥è·å–å‘é€è€…åç§°
                            senderName = messageData.senderName ||
                                        messageData.characterName ||
                                        messageData.name ||
                                        (messageData.sender !== 'received' ? messageData.sender : 'æœªçŸ¥æˆå‘˜');
                        } else {
                            // ç§èŠï¼šæ˜¾ç¤ºè§’è‰²åç§°
                            senderName = currentChatCharacter.name || 'è§’è‰²';
                        }
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹è¿›è¡Œé«˜äº®
                    let displayContent = '';
                    if (typeof messageData.content === 'string') {
                        displayContent = messageData.content;
                    } else if (Array.isArray(messageData.content)) {
                        displayContent = messageData.content
                            .filter(item => item && item.type === 'text')
                            .map(item => item.text || '')
                            .join(' ');
                    } else if (messageData.content && typeof messageData.content === 'object') {
                        // å¤„ç†å¯¹è±¡ç±»å‹çš„content
                        displayContent = messageData.content.text || messageData.content.content || '';
                    } else {
                        displayContent = messageData.content ? String(messageData.content) : 'æ¶ˆæ¯å†…å®¹ä¸ºç©º';
                    }

                    // å¦‚æœå¤„ç†åä»ç„¶ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
                    if (!displayContent || displayContent.trim() === '') {
                        displayContent = 'æ¶ˆæ¯å†…å®¹ä¸ºç©º';
                    }

                    const highlightedContent = displayContent.replace(
                        new RegExp(keyword, 'gi'),
                        `<span class="search-highlight">$&</span>`
                    );
                    const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <div class="search-result-item" onclick="showMessageContext(${allMessages.indexOf(msg)})">
                            <div class="search-result-content">${highlightedContent}</div>
                            <div class="search-result-meta">
                                <span class="search-result-sender">${senderName}</span>
                                <span class="search-result-time">${timeStr}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            resultsContainer.style.display = 'block';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºæ¶ˆæ¯ä¸Šä¸‹æ–‡
        async function showMessageContext(messageIndex) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å…¨éƒ¨æ¶ˆæ¯æ•°æ®ï¼Œè€Œä¸æ˜¯åªæœ‰å½“å‰æ˜¾ç¤ºçš„
            let allMessages = [];
            try {
                const dbMessages = await db.chatMessages
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                allMessages = dbMessages.sort((a, b) => a.timestamp - b.timestamp);
            } catch (error) {
                console.error('è·å–èŠå¤©è®°å½•å¤±è´¥:', error);
                allMessages = chatMessages[currentChatCharacter.id] || [];
            }

            const targetMessage = allMessages[messageIndex];
            if (!targetMessage) return;

            // è·å–å‰å10æ¡æ¶ˆæ¯
            const startIndex = Math.max(0, messageIndex - 10);
            const endIndex = Math.min(allMessages.length - 1, messageIndex + 10);
            const contextMessages = allMessages.slice(startIndex, endIndex + 1);

            // æ¸²æŸ“ä¸Šä¸‹æ–‡æ¶ˆæ¯
            const container = document.getElementById('message-context-container');
            container.innerHTML = contextMessages.map((msg, index) => {
                const actualIndex = startIndex + index;
                const isTarget = actualIndex === messageIndex;

                // ğŸ”¥ã€ä¿®å¤ã€‘ä»messageDataè·å–å‘é€è€…ä¿¡æ¯
                const messageData = msg.messageData;
                if (!messageData) return '';

                let senderName = '';
                let senderClass = '';

                if (messageData.isUser || messageData.sender === 'sent') {
                    senderName = 'æˆ‘';
                    senderClass = 'user';
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
                    if (currentChatCharacter.isGroup) {
                        // ç¾¤èŠï¼šæ˜¾ç¤ºå…·ä½“çš„å‘é€è€…åç§°
                        // å°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µæ¥è·å–å‘é€è€…åç§°
                        senderName = messageData.senderName ||
                                    messageData.characterName ||
                                    messageData.name ||
                                    (messageData.sender !== 'received' ? messageData.sender : 'æœªçŸ¥æˆå‘˜');
                        senderClass = 'character';
                    } else {
                        // ç§èŠï¼šæ˜¾ç¤ºè§’è‰²åç§°
                        senderName = currentChatCharacter.name || 'è§’è‰²';
                        senderClass = 'character';
                    }
                }

                const targetClass = isTarget ? ' target' : '';
                const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹æ˜¾ç¤ºï¼Œé˜²æ­¢undefined
                let displayContent = '';
                if (typeof messageData.content === 'string') {
                    displayContent = messageData.content;
                } else if (Array.isArray(messageData.content)) {
                    displayContent = messageData.content
                        .filter(item => item && item.type === 'text')
                        .map(item => item.text || '')
                        .join(' ');
                } else if (messageData.content && typeof messageData.content === 'object') {
                    // å¤„ç†å¯¹è±¡ç±»å‹çš„content
                    displayContent = messageData.content.text || messageData.content.content || '';
                } else {
                    displayContent = messageData.content ? String(messageData.content) : 'æ¶ˆæ¯å†…å®¹ä¸ºç©º';
                }

                // å¦‚æœå¤„ç†åä»ç„¶ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
                if (!displayContent || displayContent.trim() === '') {
                    displayContent = 'æ¶ˆæ¯å†…å®¹ä¸ºç©º';
                }

                return `
                    <div class="context-message ${senderClass}${targetClass}">
                        <div class="context-message-meta">${senderName} Â· ${timeStr}</div>
                        <div>${displayContent}</div>
                    </div>
                `;
            }).join('');

            showModal('message-context-modal');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ”¯æŒå›è½¦é”®æœç´¢
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-keyword-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performChatSearch();
                    }
                });
            }
        });



        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡†
        function showExportOptions() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            document.getElementById('export-options-modal').style.display = 'flex';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡†
        function hideExportOptions(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('export-options-modal').style.display = 'none';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€‰æ‹©å¯¼å‡ºæ ¼å¼
        function selectExportFormat(format) {
            document.getElementById('format-html').checked = format === 'html';
            document.getElementById('format-json').checked = format === 'json';

            // æ›´æ–°é€‰ä¸­æ ·å¼
            document.querySelectorAll('.export-format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[onclick="selectExportFormat('${format}')"]`).classList.add('selected');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰§è¡Œå¯¼å‡º
        async function executeExport() {
            const selectedFormat = document.querySelector('input[name="exportFormat"]:checked').value;
            hideExportOptions();

            if (selectedFormat === 'html') {
                exportChatHistoryAsHTML();
            } else if (selectedFormat === 'json') {
                await exportChatHistoryAsJSON();
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘å¯¼å‡ºèŠå¤©è®°å½• - å®Œæ•´HTMLæ ¼å¼ï¼ˆé‡å‘½ååŸå‡½æ•°ï¼‰
        function exportChatHistoryAsHTML() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            if (messages.length === 0) {
                showToast('æ²¡æœ‰èŠå¤©è®°å½•å¯å¯¼å‡º', 'warning');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            const userName = chatSettings.myChatNickname || 'æˆ‘';
            const exportTime = new Date();
            const totalMessages = messages.length;

            // è·å–æ—¶é—´èŒƒå›´
            const firstMessageTime = new Date(messages[0].timestamp || Date.now());
            const lastMessageTime = new Date(messages[messages.length - 1].timestamp || Date.now());

            // ç¡®ä¿æ—¥æœŸæœ‰æ•ˆ
            if (isNaN(firstMessageTime.getTime())) {
                firstMessageTime = new Date();
            }
            if (isNaN(lastMessageTime.getTime())) {
                lastMessageTime = new Date();
            }

            // æ„å»ºHTMLå†…å®¹
            let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ ${characterName} çš„èŠå¤©è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Helvetica, Arial, sans-serif;
            background: #f0f0f0;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #007AFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .header .info {
            font-size: 14px;
            opacity: 0.9;
        }
        .chat-content {
            padding: 20px;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .message.user {
            flex-direction: row-reverse;
        }
        .message.ai {
            flex-direction: row;
        }
        .message.system {
            justify-content: center;
            margin: 10px 0;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        .message.user .message-bubble {
            background: #007AFF;
            color: white;
            border-bottom-right-radius: 6px;
        }
        .message.ai .message-bubble {
            background: #e5e5ea;
            color: #333;
            border-bottom-left-radius: 6px;
        }
        .message.system .message-bubble {
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            text-align: center;
            border-radius: 12px;
            padding: 6px 12px;
            margin: 0 auto;
            max-width: 60%;
        }

        /* ğŸ”¥ã€æ–°å¢ã€‘çºªå¿µæ—¥å’Œçº¦å®šæé†’æ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼ */
        .message-container.received .message-bubble.reminder-message {
            background: linear-gradient(135deg, #FFE4E1, #FFF0F5) !important;
            border: 1px solid #FFB6C1 !important;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3) !important;
            position: relative;
        }

        .message-container.received .message-bubble.reminder-message::before {
            content: 'ğŸ“…';
            position: absolute;
            top: -8px;
            left: -8px;
            background: #FF69B4;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            z-index: 10;
        }

        .message-container.received .message-bubble.reminder-message {
            animation: reminderPulse 2s ease-in-out;
        }

        @keyframes reminderPulse {
            0% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 4px 16px rgba(255, 182, 193, 0.5); }
            100% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3); }
        }
        .sender-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            padding: 0 16px;
        }
        .message.user .sender-name {
            text-align: right;
        }
        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 16px;
        }
        .message.user .timestamp {
            text-align: right;
        }
        .quote-block {
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #007AFF;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
        }
        .message.user .quote-block {
            border-left-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
        }
        .quote-sender {
            font-weight: 600;
            color: #007AFF;
            font-size: 12px;
            margin-bottom: 2px;
        }
        .message.user .quote-sender {
            color: rgba(255,255,255,0.9);
        }
        .special-message {
            font-style: italic;
            color: #666;
        }
        .footer {
            background: #f8f8f8;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }
        .stats {
            background: #f8f8f8;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                margin: 0;
                box-shadow: none;
            }
            .message-bubble {
                max-width: 85%;
            }
            .header h1 {
                font-size: 20px;
            }
            .chat-content {
                padding: 15px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }





        /* å‘å¸–æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007AFF;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary,
        .btn-primary {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e5e5e5;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        /* è¯„è®ºäº’åŠ¨æŒ‰é’® */
        .reply-actions {
            margin-top: 8px;
            display: flex;
            gap: 15px;
        }

        .reply-action-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .reply-action-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .reply-action-btn.liked {
            color: #ff3b30;
        }

        .reply-action-btn.liked i {
            color: #ff3b30;
        }

        .like-count {
            font-size: 11px;
            min-width: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä¸ ${characterName} çš„èŠå¤©è®°å½•</h1>
            <div class="info">
                å¯¼å‡ºæ—¶é—´ï¼š${exportTime.toLocaleString('zh-CN')}<br>
                å…± ${totalMessages} æ¡æ¶ˆæ¯ | ${firstMessageTime.toLocaleDateString('zh-CN')} - ${lastMessageTime.toLocaleDateString('zh-CN')}
            </div>
        </div>
        <div class="chat-content">`;

            // å¤„ç†æ¯æ¡æ¶ˆæ¯
            messages.forEach((message, index) => {
                const time = formatTime(message.timestamp);
                const isUser = message.sender === 'sent';
                const isSystem = message.sender === 'system';

                if (isSystem) {
                    // ç³»ç»Ÿæ¶ˆæ¯
                    htmlContent += `
            <div class="message system">
                <div class="message-bubble">${escapeHtml(message.content)}</div>
            </div>`;
                } else {
                    // ç”¨æˆ·æˆ–AIæ¶ˆæ¯
                    const messageClass = isUser ? 'user' : 'ai';
                    const senderName = isUser ? userName : characterName;
                    let messageContent = '';

                    // å¤„ç†å¼•ç”¨æ¶ˆæ¯
                    if (message.replyTo) {
                        const quoteSender = message.replyTo.senderName || (message.replyTo.sender === 'sent' ? userName : characterName);
                        const quoteContent = truncateText(message.replyTo.content || '[æ¶ˆæ¯å·²åˆ é™¤]', 20);
                        messageContent += `
                <div class="quote-block">
                    <div class="quote-sender">${escapeHtml(quoteSender)}</div>
                    <div>${escapeHtml(quoteContent)}</div>
                </div>`;
                    }

                    // å¤„ç†æ¶ˆæ¯å†…å®¹
                    let content = message.content || '';
                    let specialClass = '';

                    if (message.type === 'voice_message') {
                        content = `ğŸµ è¯­éŸ³æ¶ˆæ¯ï¼š${content}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'transfer') {
                        content = `ğŸ’° è½¬è´¦ï¼š${message.amount}å…ƒ${message.note ? ` (${message.note})` : ''}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'location') {
                        content = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 4px; vertical-align: middle;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/></svg>ä½ç½®ï¼š${message.locationName || 'ä½ç½®ä¿¡æ¯'}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'friend_request') {
                        content = `ğŸ‘‹ å¥½å‹ç”³è¯·ï¼š${message.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'user_photo') {
                        content = `ğŸ“· å›¾ç‰‡ï¼š${content}`;
                        specialClass = ' special-message';
                    } else if (message.isEmoji) {
                        content = `ğŸ˜Š è¡¨æƒ…åŒ…ï¼š${message.emojiDescription || content}`;
                        specialClass = ' special-message';
                    } else if (Array.isArray(content)) {
                        // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘å¤„ç†æ•°ç»„æ ¼å¼æ¶ˆæ¯ï¼ˆç°åœ¨æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼‰
                        const textPart = content.find(part => part.type === 'text')?.text || '';
                        const imagePart = content.find(part => part.type === 'image_url');

                        if (textPart && imagePart) {
                            content = `ğŸ“·ğŸ“ å›¾ç‰‡+æ–‡å­—ï¼š${textPart}`;
                        } else if (imagePart) {
                            content = 'ğŸ“· å›¾ç‰‡æ¶ˆæ¯';
                        } else if (textPart) {
                            content = textPart; // çº¯æ–‡å­—æ¶ˆæ¯
                        } else {
                            content = 'ğŸ“± å¤šåª’ä½“æ¶ˆæ¯';
                        }

                        if (imagePart) {
                            specialClass = ' special-message';
                        }
                    }

                    messageContent += `<div class="${specialClass.trim()}">${escapeHtml(content)}</div>`;

                    htmlContent += `
            <div class="message ${messageClass}">
                <div class="message-bubble">
                    ${messageContent}
                </div>
            </div>
            <div class="timestamp">${time}</div>`;
                }

                // æ¯50æ¡æ¶ˆæ¯æ·»åŠ ä¸€ä¸ªåˆ†é¡µæ ‡è®°ï¼ˆä¾¿äºé•¿èŠå¤©è®°å½•çš„æŸ¥çœ‹ï¼‰
                if ((index + 1) % 50 === 0 && index !== messages.length - 1) {
                    htmlContent += `
            <div class="message system">
                <div class="message-bubble">--- ç¬¬ ${Math.floor((index + 1) / 50)} é¡µ ---</div>
            </div>`;
                }
            });

            htmlContent += `
        </div>
        <div class="stats">
            ğŸ“Š èŠå¤©ç»Ÿè®¡<br>
            æ€»æ¶ˆæ¯æ•°ï¼š${totalMessages} æ¡ |
            æˆ‘çš„æ¶ˆæ¯ï¼š${messages.filter(m => m.sender === 'sent').length} æ¡ |
            ${characterName} çš„æ¶ˆæ¯ï¼š${messages.filter(m => m.sender === 'received').length} æ¡ |
            ç³»ç»Ÿæ¶ˆæ¯ï¼š${messages.filter(m => m.sender === 'system').length} æ¡
        </div>
        <div class="footer">
            æ­¤èŠå¤©è®°å½•ç”±æ‰‹æœºèŠå¤©åº”ç”¨è‡ªåŠ¨ç”Ÿæˆ<br>
            å¯¼å‡ºæ—¶é—´ï¼š${exportTime.toLocaleString('zh-CN')}
        </div>
    </div>
</body>
</html>`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileName = `ä¸${characterName}çš„èŠå¤©è®°å½•_${exportTime.getFullYear()}-${(exportTime.getMonth() + 1).toString().padStart(2, '0')}-${exportTime.getDate().toString().padStart(2, '0')}.html`;

            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ¸…ç†URLå¯¹è±¡
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 1000);

            showToast(`èŠå¤©è®°å½•å·²å¯¼å‡ºï¼š${fileName}`, 'success');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å‡ºèŠå¤©è®°å½•ä¸ºJSONæ ¼å¼ï¼ˆåŒ…å«å®Œæ•´è®°å¿†ç³»ç»Ÿï¼‰
        async function exportChatHistoryAsJSON() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            try {
                showToast('æ­£åœ¨æ”¶é›†æ•°æ®...', 'info');

                const characterId = currentChatCharacter.id;
                const characterName = currentChatCharacter.name;
                const exportTime = new Date();

                // æ„å»ºå®Œæ•´çš„å¯¼å‡ºæ•°æ®
                const exportData = {
                    exportInfo: {
                        characterId: characterId,
                        characterName: characterName,
                        exportTime: exportTime.toISOString(),
                        version: '1.0',
                        description: `${characterName}çš„å®Œæ•´èŠå¤©æ•°æ®å¤‡ä»½`
                    },

                    // èŠå¤©è®°å½•ï¼ˆChatåº”ç”¨ï¼‰- ä»æ•°æ®åº“è·å–
                    chatMessages: await db.chatMessages.where('characterId').equals(characterId).toArray(),

                    // çŸ­ä¿¡è®°å½•ï¼ˆçŸ­ä¿¡åº”ç”¨ï¼‰- ä»æ•°æ®åº“è·å–
                    smsMessages: await db.smsMessages.where('characterId').equals(characterId).toArray(),

                    // èŠå¤©è®¾ç½® - ä»æ•°æ®åº“è·å–ï¼ˆä½¿ç”¨chatIdå­—æ®µï¼‰
                    chatSettings: await db.chatSettings.where('chatId').equals(characterId).toArray(),

                    // è®°å¿†ç³»ç»Ÿæ•°æ®
                    coreMemories: await db.coreMemories.where('characterId').equals(characterId).toArray(),
                    episodicMemories: await db.episodicMemories.where('characterId').equals(characterId).toArray(),
                    memorySummaries: await db.memorySummaries.where('characterId').equals(characterId).toArray(),
                    crossAppTimeline: await db.crossAppTimeline.where('characterId').equals(characterId).toArray()
                };

                // ç»Ÿè®¡ä¿¡æ¯
                const stats = {
                    chatMessages: exportData.chatMessages.length,
                    smsMessages: exportData.smsMessages.length,
                    coreMemories: exportData.coreMemories.length,
                    episodicMemories: exportData.episodicMemories.length,
                    memorySummaries: exportData.memorySummaries.length,
                    crossAppTimeline: exportData.crossAppTimeline.length
                };

                console.log('ğŸ“Š å¯¼å‡ºæ•°æ®ç»Ÿè®¡:', stats);

                // åˆ›å»ºJSONæ–‡ä»¶
                const jsonContent = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = `${characterName}_å®Œæ•´æ•°æ®å¤‡ä»½_${exportTime.getFullYear()}-${(exportTime.getMonth() + 1).toString().padStart(2, '0')}-${exportTime.getDate().toString().padStart(2, '0')}.json`;

                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);

                const statsText = Object.entries(stats)
                    .filter(([key, value]) => value > 0)
                    .map(([key, value]) => {
                        const labels = {
                            chatMessages: 'èŠå¤©æ¶ˆæ¯',
                            smsMessages: 'çŸ­ä¿¡æ¶ˆæ¯',
                            coreMemories: 'æ ¸å¿ƒè®°å¿†',
                            episodicMemories: 'æƒ…æ™¯è®°å¿†',
                            memorySummaries: 'å‰§æƒ…æ€»ç»“',
                            crossAppTimeline: 'æ—¶é—´çº¿è®°å¿†'
                        };
                        return `${labels[key]}: ${value}æ¡`;
                    })
                    .join(', ');

                showToast(`å®Œæ•´æ•°æ®å·²å¯¼å‡ºï¼š${fileName}ï¼ˆ${statsText}ï¼‰`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºJSONæ•°æ®å¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ–‡æœ¬æˆªæ–­å‡½æ•°
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }



        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå¯¼å…¥é€‰é¡¹æ¨¡æ€æ¡†
        function showImportOptions() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            document.getElementById('import-options-modal').style.display = 'flex';

            // é‡ç½®æ–‡ä»¶é€‰æ‹©çŠ¶æ€
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-file-info').style.display = 'none';
            document.getElementById('import-execute-btn').disabled = true;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—å¯¼å…¥é€‰é¡¹æ¨¡æ€æ¡†
        function hideImportOptions(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('import-options-modal').style.display = 'none';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†å¯¼å…¥æ–‡ä»¶é€‰æ‹©
        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                showToast('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // éªŒè¯æ–‡ä»¶æ ¼å¼
                    if (!data.exportInfo || !data.exportInfo.characterName) {
                        showToast('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼', 'error');
                        return;
                    }

                    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                    document.getElementById('import-file-name').textContent = file.name;

                    const stats = [];
                    if (data.chatMessages?.length) stats.push(`èŠå¤©æ¶ˆæ¯: ${data.chatMessages.length}æ¡`);
                    if (data.smsMessages?.length) stats.push(`çŸ­ä¿¡æ¶ˆæ¯: ${data.smsMessages.length}æ¡`);
                    if (data.coreMemories?.length) stats.push(`æ ¸å¿ƒè®°å¿†: ${data.coreMemories.length}æ¡`);
                    if (data.episodicMemories?.length) stats.push(`æƒ…æ™¯è®°å¿†: ${data.episodicMemories.length}æ¡`);
                    if (data.memorySummaries?.length) stats.push(`å‰§æƒ…æ€»ç»“: ${data.memorySummaries.length}æ¡`);
                    if (data.crossAppTimeline?.length) stats.push(`æ—¶é—´çº¿è®°å¿†: ${data.crossAppTimeline.length}æ¡`);

                    document.getElementById('import-file-preview').innerHTML = `
                        <strong>è§’è‰²ï¼š</strong>${data.exportInfo.characterName}<br>
                        <strong>å¯¼å‡ºæ—¶é—´ï¼š</strong>${new Date(data.exportInfo.exportTime).toLocaleString('zh-CN')}<br>
                        <strong>åŒ…å«æ•°æ®ï¼š</strong>${stats.join(', ')}
                    `;

                    document.getElementById('import-file-info').style.display = 'block';
                    document.getElementById('import-execute-btn').disabled = false;

                    // ä¿å­˜æ•°æ®åˆ°ä¸´æ—¶å˜é‡
                    window.pendingImportData = data;

                } catch (error) {
                    showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æJSON', 'error');
                    console.error('è§£æå¯¼å…¥æ–‡ä»¶å¤±è´¥:', error);
                }
            };

            reader.readAsText(file);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‰§è¡Œå¯¼å…¥æ“ä½œ
        async function executeImport() {
            if (!window.pendingImportData) {
                showToast('æ²¡æœ‰å¾…å¯¼å…¥çš„æ•°æ®', 'error');
                return;
            }

            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'warning');
                return;
            }

            try {
                showToast('æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
                hideImportOptions();

                const data = window.pendingImportData;
                const characterId = currentChatCharacter.id;

                // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                await db.transaction('rw', [
                    db.chatMessages,
                    db.smsMessages,
                    db.chatSettings,
                    db.coreMemories,
                    db.episodicMemories,
                    db.memorySummaries,
                    db.crossAppTimeline
                ], async () => {
                    // 1. åˆ é™¤è¯¥è§’è‰²çš„æ‰€æœ‰ç°æœ‰æ•°æ®
                    await db.chatMessages.where('characterId').equals(characterId).delete();
                    await db.smsMessages.where('characterId').equals(characterId).delete();
                    await db.chatSettings.where('chatId').equals(characterId).delete();
                    await db.coreMemories.where('characterId').equals(characterId).delete();
                    await db.episodicMemories.where('characterId').equals(characterId).delete();
                    await db.memorySummaries.where('characterId').equals(characterId).delete();
                    await db.crossAppTimeline.where('characterId').equals(characterId).delete();

                    // 2. å¯¼å…¥æ–°æ•°æ®
                    if (data.chatMessages?.length) {
                        await db.chatMessages.bulkAdd(data.chatMessages);
                    }
                    if (data.smsMessages?.length) {
                        await db.smsMessages.bulkAdd(data.smsMessages);
                    }
                    if (data.chatSettings?.length) {
                        await db.chatSettings.bulkAdd(data.chatSettings);
                    }
                    if (data.coreMemories?.length) {
                        await db.coreMemories.bulkAdd(data.coreMemories);
                    }
                    if (data.episodicMemories?.length) {
                        await db.episodicMemories.bulkAdd(data.episodicMemories);
                    }
                    if (data.memorySummaries?.length) {
                        await db.memorySummaries.bulkAdd(data.memorySummaries);
                    }
                    if (data.crossAppTimeline?.length) {
                        await db.crossAppTimeline.bulkAdd(data.crossAppTimeline);
                    }
                });

                // 3. é‡æ–°åŠ è½½æ•°æ®åˆ°å†…å­˜
                await loadChatMessages(); // é‡æ–°åŠ è½½èŠå¤©è®°å½•åˆ°å†…å­˜
                await loadSMSMessages(); // é‡æ–°åŠ è½½çŸ­ä¿¡è®°å½•åˆ°å†…å­˜
                await loadChatSettings(); // é‡æ–°åŠ è½½èŠå¤©è®¾ç½®åˆ°å†…å­˜

                // 4. åˆ·æ–°ç•Œé¢æ˜¾ç¤º
                renderMessageList();

                // å¦‚æœå½“å‰åœ¨çŸ­ä¿¡åº”ç”¨ï¼Œä¹Ÿåˆ·æ–°çŸ­ä¿¡ç•Œé¢
                const smsScreen = document.getElementById('sms-screen');
                if (smsScreen && smsScreen.style.display !== 'none') {
                    loadSMSHistory();
                }

                // ç»Ÿè®¡å¯¼å…¥çš„æ•°æ®
                const stats = [];
                if (data.chatMessages?.length) stats.push(`èŠå¤©æ¶ˆæ¯: ${data.chatMessages.length}æ¡`);
                if (data.smsMessages?.length) stats.push(`çŸ­ä¿¡æ¶ˆæ¯: ${data.smsMessages.length}æ¡`);
                if (data.coreMemories?.length) stats.push(`æ ¸å¿ƒè®°å¿†: ${data.coreMemories.length}æ¡`);
                if (data.episodicMemories?.length) stats.push(`æƒ…æ™¯è®°å¿†: ${data.episodicMemories.length}æ¡`);
                if (data.memorySummaries?.length) stats.push(`å‰§æƒ…æ€»ç»“: ${data.memorySummaries.length}æ¡`);
                if (data.crossAppTimeline?.length) stats.push(`æ—¶é—´çº¿è®°å¿†: ${data.crossAppTimeline.length}æ¡`);

                showToast(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å·²å¯¼å…¥ï¼š${stats.join(', ')}ã€‚å»ºè®®åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸æ˜¾ç¤º`, 'success');

                // æ¸…ç†ä¸´æ—¶æ•°æ®
                delete window.pendingImportData;

            } catch (error) {
                console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®æ¶ˆæ¯IDæŸ¥æ‰¾æ¶ˆæ¯
        function findMessageById(messageId) {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                return null;
            }

            const messages = chatMessages[currentChatCharacter.id];
            const result = messages.find(msg => msg.id === messageId);
            return result;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–å½“å‰ç”¨æˆ·èº«ä»½åç§°
        function getCurrentPersonaName() {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.selectedIdentityId) {
                const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                if (selectedPersona) {
                    // ä¼˜å…ˆä½¿ç”¨ç¾¤èŠæ˜µç§°
                    return chatSettings.myChatNickname || selectedPersona.name;
                }
            }
            return 'ç”¨æˆ·';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–å½“å‰ç”¨æˆ·èº«ä»½æè¿°
        function getCurrentPersonaDescription() {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.selectedIdentityId) {
                const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                if (selectedPersona && selectedPersona.description) {
                    return selectedPersona.description;
                }
            }
            return 'æˆ‘æ˜¯ç”¨æˆ·';
        }



        // è®¾ç½®å¯¹æ–¹æ°”æ³¡é¢œè‰²
        function changeTheirBubbleColor() {
            colorPickerContext = 'theirBubble';
            document.getElementById('color-picker-title').textContent = 'è®¾ç½®å¯¹æ–¹æ°”æ³¡é¢œè‰²';
            showModal('color-picker-modal');
        }

        // è®¾ç½®æˆ‘æ–¹æ°”æ³¡é¢œè‰²
        function changeMyBubbleColor() {
            colorPickerContext = 'myBubble';
            document.getElementById('color-picker-title').textContent = 'è®¾ç½®æˆ‘æ–¹æ°”æ³¡é¢œè‰²';
            showModal('color-picker-modal');
        }

        // æ˜¾ç¤ºæ°”æ³¡é¢œè‰²è®¾ç½®
        function showBubbleColorSettings() {
            alert('æ°”æ³¡é¢œè‰²è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¾ç½®ï¼š\nâ€¢ ä¿®æ”¹å¯¹æ–¹æ°”æ³¡é¢œè‰²\nâ€¢ ä¿®æ”¹æˆ‘æ–¹æ°”æ³¡é¢œè‰²');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå¸¦é€‰é¡¹çš„æ¸…ç©ºå†å²è®°å½•æ¨¡æ€æ¡†
        function showClearHistoryOptionsModal() {
            if (!currentChatCharacter) return;

            // åˆ›å»ºæ¨¡æ€æ¡†çš„HTMLç»“æ„
            const modalHTML = `
                <div id="clear-history-options-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">æ¸…ç©ºèŠå¤©è®°å½•</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                                ä½ ç¡®å®šè¦æ¸…ç©ºä¸ <strong>${currentChatCharacter.name}</strong> çš„èŠå¤©è®°å½•å—ï¼Ÿ
                            </p>
                            <div class="setting-section">
                                <div class="section-header" style="padding: 0 0 10px 0;">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">åŒæ­¥æ¸…é™¤ç›¸å…³è®°å¿†</span>
                                </div>
                                <div class="checkbox-group">
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="clear-core-memory" value="core" checked>
                                        <span class="checkbox-custom"></span>
                                        <div class="checkbox-content">
                                            <div class="checkbox-title">æ ¸å¿ƒè®°å¿†</div>
                                            <div class="checkbox-desc">è§’è‰²è®°ä½çš„å…³é”®ä¿¡æ¯ï¼ˆå¦‚ç”Ÿæ—¥ã€å…³ç³»ï¼‰ã€‚</div>
                                        </div>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="clear-episodic-memory" value="episodic" checked>
                                        <span class="checkbox-custom"></span>
                                        <div class="checkbox-content">
                                            <div class="checkbox-title">æƒ…æ™¯è®°å¿†</div>
                                            <div class="checkbox-desc">æ—¥å¸¸äº’åŠ¨å’Œç»å†çš„è®°å¿†ã€‚</div>
                                        </div>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="clear-timeline" value="timeline" checked>
                                        <span class="checkbox-custom"></span>
                                        <div class="checkbox-content">
                                            <div class="checkbox-title">æ—¶é—´çº¿</div>
                                            <div class="checkbox-desc">æ‰€æœ‰æ´»åŠ¨çš„è¯¦ç»†æ—¶é—´è®°å½•ã€‚</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <p style="margin-top: 15px; font-size: 12px; color: #999;">
                                <strong>æç¤ºï¼š</strong>èŠå¤©è®¾ç½®ï¼ˆå¦‚èº«ä»½ã€èƒŒæ™¯ï¼‰å°†ä¼šè¢«ä¿ç•™ã€‚
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" style="background-color: #ff3b30;" onclick="executeClearHistory()">ç¡®è®¤æ¸…ç©º</button>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œæ¸…é™¤æ“ä½œ
        async function executeClearHistory() {
            const characterId = currentChatCharacter.id;
            console.log(`ğŸ§¹ å¼€å§‹æ¸…ç†è§’è‰² ${characterId} çš„èŠå¤©æ•°æ®...`);
            showToast('æ­£åœ¨è¿›è¡Œæ·±åº¦æ¸…ç†...', 'info');

            // è·å–ç”¨æˆ·é€‰æ‹©
            const clearCore = document.getElementById('clear-core-memory')?.checked || false;
            const clearEpisodic = document.getElementById('clear-episodic-memory')?.checked || false;
            const clearTimeline = document.getElementById('clear-timeline')?.checked || false;

            // ç§»é™¤æ¨¡æ€æ¡†
            const modal = document.getElementById('clear-history-options-modal');
            if (modal) modal.remove();

            try {
                // 1. æ¸…ç©ºèŠå¤©æ¶ˆæ¯ (æ€»æ˜¯æ‰§è¡Œ)
                chatMessages[characterId] = [];
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ¸…ç©ºæ¶ˆæ¯åä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('âœ… [é«˜æ•ˆæ¸…ç©º] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ¸…ç©ºæ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }
                console.log('âœ… èŠå¤©æ¶ˆæ¯å·²æ¸…ç©º');

                // 2. æ ¹æ®ç”¨æˆ·çš„å‹¾é€‰ï¼Œé€‰æ‹©æ€§åœ°æ¸…é™¤è®°å¿†
                const contextId = characterId;

                if (clearCore) {
                    // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘å…¼å®¹æ€§æŸ¥è¯¢ï¼šåˆ é™¤åŒ¹é…contextIdçš„è®°å¿† + æ²¡æœ‰contextIdçš„æ—§è®°å¿†
                    const coreMemoriesToDelete = await db.coreMemories
                        .where('characterId').equals(characterId)
                        .and(memory => {
                            // åˆ é™¤æ¡ä»¶ï¼šcontextIdåŒ¹é… æˆ–è€… æ²¡æœ‰contextIdå­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                            return !memory.contextId || memory.contextId === contextId;
                        })
                        .primaryKeys();
                    if (coreMemoriesToDelete.length > 0) {
                        await db.coreMemories.bulkDelete(coreMemoriesToDelete);
                        console.log(`âœ… æ¸…é™¤äº† ${coreMemoriesToDelete.length} æ¡æ ¸å¿ƒè®°å¿†`);
                    } else {
                        console.log(`â„¹ï¸ è§’è‰² ${characterId} åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰æ ¸å¿ƒè®°å¿†éœ€è¦æ¸…é™¤`);
                    }
                }

                if (clearEpisodic) {
                    // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘å…¼å®¹æ€§æŸ¥è¯¢ï¼šåˆ é™¤åŒ¹é…contextIdçš„è®°å¿† + æ²¡æœ‰contextIdçš„æ—§è®°å¿†
                    const episodicMemoriesToDelete = await db.episodicMemories
                        .where('characterId').equals(characterId)
                        .and(memory => {
                            // åˆ é™¤æ¡ä»¶ï¼šcontextIdåŒ¹é… æˆ–è€… æ²¡æœ‰contextIdå­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                            return !memory.contextId || memory.contextId === contextId;
                        })
                        .primaryKeys();
                    if (episodicMemoriesToDelete.length > 0) {
                        await db.episodicMemories.bulkDelete(episodicMemoriesToDelete);
                        console.log(`âœ… æ¸…é™¤äº† ${episodicMemoriesToDelete.length} æ¡æƒ…æ™¯è®°å¿†`);
                    } else {
                        console.log(`â„¹ï¸ è§’è‰² ${characterId} åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰æƒ…æ™¯è®°å¿†éœ€è¦æ¸…é™¤`);
                    }
                }

                if (clearTimeline) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ç®€åŒ–æ—¶é—´çº¿æŸ¥è¯¢æ¡ä»¶ï¼šç›´æ¥æŒ‰characterIdåˆ é™¤æ‰€æœ‰ç›¸å…³è®°å½•
                    const timelineEventsToDelete = await db.crossAppTimeline.where('characterId').equals(characterId).primaryKeys();
                    if (timelineEventsToDelete.length > 0) {
                        await db.crossAppTimeline.bulkDelete(timelineEventsToDelete);
                        console.log(`âœ… æ¸…é™¤äº† ${timelineEventsToDelete.length} æ¡æ—¶é—´çº¿è®°å½•`);
                    } else {
                        console.log(`â„¹ï¸ è§’è‰² ${characterId} æ²¡æœ‰æ—¶é—´çº¿è®°å½•éœ€è¦æ¸…é™¤`);
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ç®€åŒ–è®°å¿†æ‘˜è¦æŸ¥è¯¢æ¡ä»¶
                    const memorySummariesToDelete = await db.memorySummaries.where('characterId').equals(characterId).primaryKeys();
                    if (memorySummariesToDelete.length > 0) {
                        await db.memorySummaries.bulkDelete(memorySummariesToDelete);
                        console.log(`âœ… æ¸…é™¤äº† ${memorySummariesToDelete.length} æ¡è®°å¿†æ‘˜è¦`);
                    } else {
                        console.log(`â„¹ï¸ è§’è‰² ${characterId} æ²¡æœ‰è®°å¿†æ‘˜è¦éœ€è¦æ¸…é™¤`);
                    }
                }

                // 3. åˆ·æ–°ç•Œé¢
                renderChatMessages(characterId);
                renderMessageList();

                showToast('æ‰€é€‰æ•°æ®å·²å½»åº•æ¸…é™¤ï¼', 'success');
                console.log(`ğŸ§¹ è§’è‰² ${characterId} çš„æ•°æ®æ¸…ç†å®Œæˆ`);

                hideChatSettings();

            } catch (error) {
                console.error('æ·±åº¦æ¸…ç†å¤±è´¥:', error);
                showToast('æ¸…ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'error');
            }
        }

        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChatHistory() {
            // ğŸ”¥ã€æœ€ç»ˆä¿®å¤ã€‘ä¸å†ç›´æ¥æ‰§è¡Œåˆ é™¤ï¼Œè€Œæ˜¯è°ƒç”¨æ–°çš„å‡½æ•°æ¥æ˜¾ç¤ºå¸¦é€‰é¡¹çš„æ¨¡æ€æ¡†
            showClearHistoryOptionsModal();
        }

        // é€‰æ‹©é¢œè‰²
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }

        // åº”ç”¨èŠå¤©èƒŒæ™¯
// æ¥å—ä¸€ä¸ªå¯é€‰çš„ backgroundUrl å‚æ•°
async function applyChatBackground(backgroundUrl, skipSave = false) {
            if (!currentChatCharacter) return;

    console.log(`âš¡ applyChatBackground è¢«è°ƒç”¨: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id}), skipSave: ${skipSave}`);

    // 1. åˆ›å»ºä¸€ä¸ªä¸“å±äºå½“å‰èŠå¤©çš„èƒŒæ™¯è®¾ç½®å­—æ®µ
    // æ³¨æ„ï¼šè¿™é‡Œä¸å†ä½¿ç”¨chatSettingså¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥åœ¨characterå¯¹è±¡ä¸Šæ·»åŠ èƒŒæ™¯å±æ€§
    if (!currentChatCharacter.background) {
        currentChatCharacter.background = null;
    }

    // 2. å†³å®šæœ€ç»ˆè¦ä½¿ç”¨çš„èƒŒæ™¯ã€‚ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨è§’è‰²å¯¹è±¡ä¸­çš„å€¼
    const backgroundToApply = backgroundUrl !== undefined ? backgroundUrl : currentChatCharacter.background;

    // 3. æ£€æŸ¥æ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°
    const needsUpdate = currentChatCharacter.background !== backgroundToApply;

    // 4. æ›´æ–°è§’è‰²å¯¹è±¡ä¸­çš„è®¾ç½®
    currentChatCharacter.background = backgroundToApply;

    // 5. ğŸ”¥ã€ä¼˜åŒ–ã€‘åªåœ¨çœŸæ­£éœ€è¦æ›´æ–°ä¸”ä¸è·³è¿‡ä¿å­˜æ—¶æ‰ä¿å­˜
    if (needsUpdate && !skipSave) {
        console.log(`ğŸ’¾ [èƒŒæ™¯ä¿å­˜] ${currentChatCharacter.name}: èƒŒæ™¯å·²æ›´æ–°ï¼Œä¿å­˜åˆ°æ•°æ®åº“`);
        await saveCharacters();
    } else if (skipSave) {
        console.log(`â­ï¸ [èƒŒæ™¯ä¿å­˜] ${currentChatCharacter.name}: è·³è¿‡ä¿å­˜ï¼ˆskipSave=trueï¼‰`);
    } else {
        console.log(`â­ï¸ [èƒŒæ™¯ä¿å­˜] ${currentChatCharacter.name}: èƒŒæ™¯æœªå˜åŒ–ï¼Œè·³è¿‡ä¿å­˜`);
    }

    // 5. ç›´æ¥è®¾ç½®èƒŒæ™¯æ ·å¼
            const chatScreen = document.getElementById('api-chat-screen');
    if (!chatScreen) return;

    if (backgroundToApply) {
        console.log(`ğŸ–¼ï¸ åº”ç”¨èŠå¤©èƒŒæ™¯: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);

        // ç›´æ¥è®¾ç½®æ ·å¼
        chatScreen.style.backgroundImage = `url(${backgroundToApply})`;
                    chatScreen.style.backgroundSize = 'cover';
                    chatScreen.style.backgroundPosition = 'center';
                    chatScreen.style.backgroundColor = 'transparent';

        const messagesContainer = document.getElementById('api-chat-messages');
                    if (messagesContainer) messagesContainer.style.background = 'transparent';
                } else {
        console.log(`ğŸ–¼ï¸ é‡ç½®èŠå¤©èƒŒæ™¯: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);

        // é‡ç½®ä¸ºé»˜è®¤æ ·å¼
                    chatScreen.style.backgroundImage = 'none';
                    chatScreen.style.backgroundColor = 'white';

        const messagesContainer = document.getElementById('api-chat-messages');
                    if (messagesContainer) messagesContainer.style.background = '';
                }

    console.log(`âœ… èƒŒæ™¯æ ·å¼å·²åº”ç”¨: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);
        }

        // ä¿å­˜æ°”æ³¡æ ·å¼è®¾ç½®
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();

            // ä¿å­˜æ ·å¼è®¾ç½®
            chatSettings.bubbleStyle = window.selectedBubbleStyle || 'default';
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            chatSettings.bubbleOpacity = document.getElementById('bubble-opacity').value;

            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            const styleNames = {
                'default': 'é»˜è®¤æ ·å¼',
                'shadow': 'ç»å…¸é˜´å½±',
                'tail': 'ç»å…¸æ°”æ³¡',
                'paper': 'çº¸å¼ æ ·å¼'
            };

            document.getElementById('current-bubble-style').textContent = styleNames[chatSettings.bubbleStyle] || 'é»˜è®¤æ ·å¼';

            saveCurrentChatSettings(chatSettings);
            applyBubbleStyle();
            hideModal('bubble-style-modal');

            showToast('æ°”æ³¡æ ·å¼è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // åº”ç”¨æ°”æ³¡æ ·å¼
        function applyBubbleStyle() {
            // ğŸ”¥ã€ä¿®å¤ã€‘å³ä½¿æ²¡æœ‰currentChatCharacterä¹Ÿè¦å°è¯•åº”ç”¨æ ·å¼
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;

            // è·å–èŠå¤©è®¾ç½®ï¼Œå¦‚æœæ²¡æœ‰currentChatCharacteråˆ™ä½¿ç”¨é»˜è®¤è®¾ç½®
            let chatSettings = {};
            if (currentChatCharacter) {
                chatSettings = getCurrentChatSettings();
            } else {
                // ä½¿ç”¨é»˜è®¤è®¾ç½®
                chatSettings = {
                    bubbleStyle: 'default',
                    myBubbleColor: '#007AFF',
                    aiBubbleColor: '#f0f0f0',
                    bubbleOpacity: '1'
                };
            }

            // ç§»é™¤æ‰€æœ‰æ ·å¼ç±»
            messagesContainer.className = messagesContainer.className
                .split(' ')
                .filter(cls => !cls.startsWith('bubble-style-'))
                .join(' ');

            // æ·»åŠ å½“å‰æ ·å¼ç±»
            const style = chatSettings.bubbleStyle || 'default';
            messagesContainer.classList.add(`bubble-style-${style}`);

            // è®¾ç½®CSSå˜é‡ç”¨äºåŠ¨æ€é¢œè‰²
            const myColor = chatSettings.myBubbleColor || '#007AFF';
            const aiColor = chatSettings.aiBubbleColor || '#f0f0f0';
            const opacity = chatSettings.bubbleOpacity || '1';

            messagesContainer.style.setProperty('--my-bubble-color', myColor);
            messagesContainer.style.setProperty('--ai-bubble-color', aiColor);
            messagesContainer.style.setProperty('--bubble-opacity', opacity);

            // åº”ç”¨è‡ªå®šä¹‰CSS
            const customCSS = chatSettings.customBubbleCSS || '';
            applyCustomBubbleCSS();

            console.log(`ğŸ¨ æ°”æ³¡æ ·å¼å·²åº”ç”¨: ${style} (è§’è‰²: ${currentChatCharacter?.name || 'æ— '})`);
        }

        // æ˜¾ç¤ºæ°”æ³¡é¢œè‰²é€‰æ‹©å™¨
        function showBubbleColorPicker(context) {
            colorPickerContext = context;
            document.getElementById('color-picker-title').textContent = 'è®¾ç½®æ°”æ³¡é¢œè‰²';
            showModal('color-picker-modal');
        }

        // é€‰æ‹©é¢œè‰²
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }

        // åº”ç”¨é¢œè‰²é€‰æ‹©
        async function applyColorSelection() {
            const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor || '#007AFF';
            const opacity = document.getElementById('opacity-slider').value;

            if (colorPickerContext === 'theirBubble') {
                chatSettings.theirBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            } else if (colorPickerContext === 'myBubble') {
                chatSettings.myBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            }

            await saveChatSettings();
            renderChatMessages(currentChatCharacter.id);
            hideModal('color-picker-modal');
        }

        // æ˜¾ç¤ºå£çº¸é€‰æ‹©å™¨
        function showWallpaperPicker() {
            showModal('wallpaper-picker-modal');
        }

        // é€‰æ‹©å£çº¸ï¼ˆä¿ç•™å‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œä½†ç°åœ¨ä¸»è¦é€šè¿‡æ–‡ä»¶ä¸Šä¼ é€‰æ‹©ï¼‰
        function selectWallpaper(wallpaperId) {
            console.log('é€‰æ‹©å£çº¸:', wallpaperId);
            selectedWallpaper = wallpaperId;
            console.log('selectedWallpaperå·²è®¾ç½®ä¸º:', selectedWallpaper);
        }

        // åº”ç”¨å£çº¸é€‰æ‹©
        async function applyWallpaperSelection() {
            console.log('åº”ç”¨å£çº¸è¢«è°ƒç”¨ï¼ŒselectedWallpaper:', selectedWallpaper);

            if (!selectedWallpaper) {
                alert('è¯·å…ˆä»ç›¸å†Œé€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºå£çº¸');
                return;
            }

            if (selectedWallpaper.startsWith('data:image')) {
                // åº”ç”¨ä¸Šä¼ çš„å›¾ç‰‡å£çº¸
                console.log('åº”ç”¨å›¾ç‰‡å£çº¸');
                document.querySelector('.wallpaper').style.backgroundImage = `url(${selectedWallpaper})`;
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';

                // ä½¿ç”¨IndexedDBä¿å­˜å£çº¸ï¼Œé¿å…localStorageç©ºé—´é™åˆ¶
                try {
                    await db.wallpapers.clear();
                    await db.wallpapers.add({
                        id: 'main',
                        type: 'image',
                        data: selectedWallpaper
                    });
                    console.log('å£çº¸ä¿å­˜æˆåŠŸåˆ°IndexedDB');
            hideModal('wallpaper-picker-modal');
                } catch (e) {
                    console.error('ä¿å­˜å£çº¸å¤±è´¥:', e);
                    alert('ä¿å­˜å£çº¸å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                alert('è¯·å…ˆä»ç›¸å†Œé€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºå£çº¸');
            }
        }

        // ä¸Šä¼ è‡ªå®šä¹‰å£çº¸
        function uploadCustomWallpaper() {
            document.getElementById('custom-wallpaper-upload').click();
        }

        // å…¨å±€å˜é‡
        let selectedAppForIcon = null;
        let uploadedIconImage = null;

        // æ˜¾ç¤ºå›¾æ ‡é€‰æ‹©å™¨
        function showIconPicker() {
            generateAppList();
            showModal('icon-picker-modal');
        }

        // ç”Ÿæˆåº”ç”¨åˆ—è¡¨
        function generateAppList() {
            const container = document.getElementById('app-list-container');
            container.innerHTML = '';

            // è·å–æ‰€æœ‰åº”ç”¨çš„ä¿¡æ¯
            const apps = [
                // ä¸»å±å¹•åº”ç”¨
                { id: 'chat-screen', name: 'Chat', selector: '.mini-app[onclick="showApp(\'chat-screen\')"] .mini-app-icon' },
                { id: 'worldbook-screen', name: 'ä¸–ç•Œä¹¦', selector: '.mini-app[onclick*="worldbook-screen"] .mini-app-icon' },
                { id: 'anniversary-screen', name: 'çºªå¿µæ—¥', selector: '.mini-app[onclick="showApp(\'anniversary-screen\')"] .mini-app-icon' },
                // ğŸ”¥ã€ä¿®å¤ã€‘è®ºå›appä½¿ç”¨æ›´ç›´æ¥çš„é€‰æ‹©å™¨ï¼Œé€šè¿‡çˆ¶å…ƒç´ æŸ¥æ‰¾
                { id: 'forum-screen', name: 'è®ºå›', selector: '.home-section.bottom-left .mini-app:nth-child(2) .mini-app-icon' },
                // Dockæ åº”ç”¨
                { id: 'messages-screen', name: 'çŸ­ä¿¡', selector: '.dock-app[onclick="showApp(\'messages-screen\')"] .dock-app-icon' },
                { id: 'settings-screen', name: 'è®¾ç½®', selector: '.dock-app[onclick="showApp(\'settings-screen\')"] .dock-app-icon' },
                { id: 'memory-viewer-screen', name: 'è®°å¿†', selector: '.dock-app[onclick="showApp(\'memory-viewer-screen\')"] .dock-app-icon' }
            ];

            apps.forEach(app => {
                const appElement = document.querySelector(app.selector);
                if (appElement) {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item-selector';
                    appItem.onclick = () => selectAppForIcon(app.id, app.name, app.selector);

                    // è·å–å½“å‰å›¾æ ‡
                    const iconHtml = appElement.innerHTML;

                    appItem.innerHTML = `
                        <div class="app-item-icon">
                            ${iconHtml}
                        </div>
                        <div class="app-item-name">${app.name}</div>
                    `;

                    container.appendChild(appItem);
                }
            });
        }

        // é€‰æ‹©è¦ä¿®æ”¹å›¾æ ‡çš„åº”ç”¨
        function selectAppForIcon(appId, appName, selector) {
            selectedAppForIcon = { id: appId, name: appName, selector: selector };

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.app-item-selector').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            document.getElementById('icon-upload-section').style.display = 'block';

            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            resetIconUpload();
        }

        // è§¦å‘å›¾æ ‡ä¸Šä¼ 
        function triggerIconUpload() {
            if (!selectedAppForIcon) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„åº”ç”¨');
                return;
            }
            document.getElementById('custom-icon-upload').click();
        }

        // é‡ç½®å›¾æ ‡ä¸Šä¼ 
        function resetIconUpload() {
            uploadedIconImage = null;
            document.getElementById('upload-placeholder').style.display = 'block';
            document.getElementById('icon-preview-img').style.display = 'none';
            document.querySelector('.upload-area').classList.remove('has-image');
            document.getElementById('apply-icon-btn').style.display = 'none';
        }

        // åº”ç”¨å›¾æ ‡æ›´æ”¹
        async function applyIconChange() {
            if (!selectedAppForIcon || !uploadedIconImage) {
                alert('è¯·é€‰æ‹©åº”ç”¨å’Œä¸Šä¼ å›¾æ ‡');
                return;
            }

            try {
                // æ›´æ–°åº”ç”¨å›¾æ ‡
                const appIconElement = document.querySelector(selectedAppForIcon.selector);
                if (appIconElement) {
                    appIconElement.innerHTML = `<img src="${uploadedIconImage}" alt="${selectedAppForIcon.name}" class="app-icon-img">`;
                }

                // ä¿å­˜åˆ°IndexedDB
                await saveCustomAppIcon(selectedAppForIcon.id, uploadedIconImage);

                showToast('åº”ç”¨å›¾æ ‡å·²æ›´æ–°ï¼', 'success');
                hideModal('icon-picker-modal');

                // é‡ç½®çŠ¶æ€
                selectedAppForIcon = null;
                uploadedIconImage = null;
            } catch (error) {
                console.error('æ›´æ–°åº”ç”¨å›¾æ ‡å¤±è´¥:', error);
                showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ä¿å­˜è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡åˆ°IndexedDB
        async function saveCustomAppIcon(appId, imageData) {
            try {
                await db.appIcons.put({
                    id: appId,
                    appId: appId,
                    imageData: imageData,
                    updatedAt: new Date()
                });
                console.log('åº”ç”¨å›¾æ ‡å·²ä¿å­˜:', appId);
            } catch (error) {
                console.error('ä¿å­˜åº”ç”¨å›¾æ ‡å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡
        async function loadCustomAppIcons() {
            try {
                const customIcons = await db.appIcons.toArray();
                customIcons.forEach(iconData => {
                    if (iconData.imageData) {
                        // æŸ¥æ‰¾å¯¹åº”çš„åº”ç”¨å›¾æ ‡å…ƒç´ å¹¶æ›´æ–°
                        const apps = [
                            { id: 'chat-screen', selector: '.mini-app[onclick="showApp(\'chat-screen\')"] .mini-app-icon' },
                            { id: 'worldbook-screen', selector: '.mini-app[onclick*="worldbook-screen"] .mini-app-icon' },
                            { id: 'anniversary-screen', selector: '.mini-app[onclick="showApp(\'anniversary-screen\')"] .mini-app-icon' },
                            // ğŸ”¥ã€ä¿®å¤ã€‘è®ºå›appä½¿ç”¨æ›´ç›´æ¥çš„é€‰æ‹©å™¨
                            { id: 'forum-screen', selector: '.home-section.bottom-left .mini-app:nth-child(2) .mini-app-icon' },
                            { id: 'messages-screen', selector: '.dock-app[onclick="showApp(\'messages-screen\')"] .dock-app-icon' },
                            { id: 'settings-screen', selector: '.dock-app[onclick="showApp(\'settings-screen\')"] .dock-app-icon' },
                            { id: 'memory-viewer-screen', selector: '.dock-app[onclick="showApp(\'memory-viewer-screen\')"] .dock-app-icon' }
                        ];

                        const app = apps.find(a => a.id === iconData.appId);
                        if (app) {
                            const appIconElement = document.querySelector(app.selector);
                            if (appIconElement) {
                                appIconElement.innerHTML = `<img src="${iconData.imageData}" alt="${iconData.appId}" class="app-icon-img">`;
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨å›¾æ ‡ä¸Šä¼ åŠŸèƒ½
        function initializeIconUpload() {
            const iconInput = document.getElementById('custom-icon-upload');
            if (!iconInput) {
                console.error('æ‰¾ä¸åˆ°custom-icon-uploadå…ƒç´ ');
                return;
            }

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            iconInput.removeEventListener('change', handleIconUpload);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            iconInput.addEventListener('change', handleIconUpload);
            console.log('åº”ç”¨å›¾æ ‡ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
        }

        // å¤„ç†å›¾æ ‡ä¸Šä¼ 
        async function handleIconUpload(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }

                try {
                    // å‹ç¼©å›¾ç‰‡
                    const compressedImage = await compressImage(file, 200, 0.8);

                    // æ›´æ–°é¢„è§ˆ
                    const uploadArea = document.querySelector('.upload-area');
                    const placeholder = document.getElementById('upload-placeholder');
                    const previewImg = document.getElementById('icon-preview-img');

                    placeholder.style.display = 'none';
                    previewImg.src = compressedImage;
                    previewImg.style.display = 'block';
                    uploadArea.classList.add('has-image');

                    // ä¿å­˜å›¾ç‰‡æ•°æ®
                    uploadedIconImage = compressedImage;

                    // æ˜¾ç¤ºåº”ç”¨æŒ‰é’®
                    document.getElementById('apply-icon-btn').style.display = 'inline-block';

                    showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
                    showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // æ›´æ”¹èŠå¤©ä¸»é¢˜é¢œè‰²
        function changeChatThemeColor() {
            colorPickerContext = 'theme';
            document.getElementById('color-picker-title').textContent = 'è®¾ç½®èŠå¤©ä¸»é¢˜é¢œè‰²';
            showModal('color-picker-modal');
        }



        // æ˜¾ç¤ºæ¶ˆæ¯èœå•
        function showMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            console.log('æ¡Œé¢ç«¯å³é”®èœå•ï¼Œè®¾ç½®selectedMessageId:', selectedMessageId);

            // å…ˆéšè—ç°æœ‰èœå•ï¼Œç¡®ä¿æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            hideMessageMenu();

            // åˆ›å»ºæˆ–è·å–èœå•å…ƒç´ 
            let menu = document.getElementById('message-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'message-context-menu';
                menu.className = 'message-menu';
                document.body.appendChild(menu);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¯æ¬¡éƒ½é‡æ–°è®¾ç½®èœå•å†…å®¹ï¼Œé¿å…äº‹ä»¶ç»‘å®šé—®é¢˜
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„ï¼ˆåªæœ‰ç”¨æˆ·æ¶ˆæ¯å¯ä»¥ç¼–è¾‘å’Œæ’¤å›ï¼‰
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === messageId);
            const isUserMessage = message && message.sender === 'sent';

            let menuItems = [
                '<div class="message-menu-item" data-action="reply">å¼•ç”¨</div>',
                '<div class="message-menu-item" data-action="copy">å¤åˆ¶</div>'
            ];

            // ğŸ”¥ã€æ–°å¢ã€‘åªæœ‰AIè§’è‰²æ¶ˆæ¯æ‰æ˜¾ç¤ºå¿ƒå£°é€‰é¡¹
            if (!isUserMessage) {
                menuItems.push('<div class="message-menu-item" data-action="inner-thoughts">å¿ƒå£°</div>');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥ç¼–è¾‘ï¼Œç”¨æˆ·æ¶ˆæ¯å¯ä»¥æ’¤å›
            menuItems.push('<div class="message-menu-item" data-action="edit">ç¼–è¾‘</div>');

            if (isUserMessage) {
                menuItems.push('<div class="message-menu-item" data-action="recall">æ’¤å›</div>');
            }

            menuItems.push('<div class="message-menu-item" data-action="select">å¤šé€‰</div>');

            menu.innerHTML = menuItems.join('');

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å†…è”onclické—®é¢˜
            menu.onclick = function(e) {
                const action = e.target.dataset.action;
                if (action) {
                    e.stopPropagation();
                    console.log('èœå•ç‚¹å‡»ï¼Œaction:', action, 'selectedMessageId:', selectedMessageId);

                    // ğŸ”¥ã€ä¸´æ—¶ä¿®å¤ã€‘ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„messageIdè€Œä¸æ˜¯å…¨å±€å˜é‡
                    const targetId = messageId;
                    console.log('ä½¿ç”¨messageId:', targetId);

                    switch(action) {
                        case 'reply':
                            replyToMessage(targetId);
                            break;
                        case 'copy':
                            copyMessage(targetId);
                            break;
                        case 'edit':
                            showEditMessageModal(targetId);
                            break;
                        case 'recall':
                            deleteMessage(targetId);
                            break;
                        case 'inner-thoughts':
                            showInnerThoughtsModal(targetId);
                            break;
                        case 'select':
                            enterMessageSelectionMode(targetId);
                            break;
                    }
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ‰‹åŠ¨éšè—èœå•ï¼Œä¸ä¼ é€’äº‹ä»¶å‚æ•°
                    hideMessageMenu(null);
                }
            };

            // å®šä½èœå•
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;

            menu.style.display = 'block';
            menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;

            // ğŸ”¥ã€ä¿®å¤ã€‘å»¶è¿Ÿæ·»åŠ å¤–éƒ¨ç‚¹å‡»ç›‘å¬å™¨ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                document.removeEventListener('click', hideMessageMenu);
                document.removeEventListener('touchstart', hideMessageMenu);
                // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                document.addEventListener('click', hideMessageMenu);
                document.addEventListener('touchstart', hideMessageMenu);
            }, 100);
        }

        // éšè—æ¶ˆæ¯èœå•
        function hideMessageMenu(event) {
            // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœç‚¹å‡»æ¥è‡ªèœå•å†…éƒ¨ï¼Œä¸éšè—èœå•
            if (event && event.target) {
                const menu = document.getElementById('message-context-menu');
                if (menu && menu.contains(event.target)) {
                    return;
                }
            }

            const menu = document.getElementById('message-context-menu');
            if (menu) {
                menu.style.display = 'none';
                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†èœå•çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
                menu.onclick = null;
            }
            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿ç§»é™¤å¤–éƒ¨ç‚¹å‡»ç›‘å¬å™¨
            document.removeEventListener('click', hideMessageMenu);
            document.removeEventListener('touchstart', hideMessageMenu);
            // ğŸ”¥ã€ä¿®å¤ã€‘é‡ç½®é€‰ä¸­çš„æ¶ˆæ¯ID
            selectedMessageId = null;
        }

        // å¼•ç”¨æ¶ˆæ¯åŠŸèƒ½
        let currentReplyTo = null;

        // ğŸ”¥ã€æ–°å¢ã€‘æ¯ä¸ªèŠå¤©çš„å¼•ç”¨çŠ¶æ€å­˜å‚¨
        let chatReplyStates = {};

        // ğŸ”¥ã€ä¿®å¤ã€‘å¼•ç”¨æ¶ˆæ¯ - æ”¯æŒä¼ å…¥æ¶ˆæ¯ID
        function replyToMessage(messageId = null) {
            const targetMessageId = messageId || selectedMessageId;
            console.log('å¼•ç”¨æ¶ˆæ¯:', targetMessageId, 'æ¥æº:', messageId ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
            if (!targetMessageId) {
                console.log('é”™è¯¯: æ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯ID');
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === targetMessageId);

            if (message) {
                // è®¾ç½®å¼•ç”¨ä¿¡æ¯
                let messageContent = '[æ¶ˆæ¯]';

                // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘å¤„ç†æ•°ç»„æ ¼å¼çš„æ¶ˆæ¯å†…å®¹
                if (Array.isArray(message.content)) {
                    const textPart = message.content.find(p => p.type === 'text');
                    const imagePart = message.content.find(p => p.type === 'image_url');

                    if (textPart?.text) {
                        messageContent = textPart.text;
                    } else if (imagePart) {
                        messageContent = '[å›¾ç‰‡]';
                    } else {
                        messageContent = '[å¤šåª’ä½“æ¶ˆæ¯]';
                    }
                } else if (message.type === 'forwarded_message') {
                    // ğŸ”¥ã€æ–°å¢ã€‘è½¬å‘æ¶ˆæ¯ç‰¹æ®Šå¤„ç† - æ˜¾ç¤ºè½¬å‘å†…å®¹é¢„è§ˆ
                    messageContent = `[è½¬å‘] ${message.content}`;
                    if (message.forwardedMessages && message.forwardedMessages.length > 0) {
                        const firstMsg = message.forwardedMessages[0];
                        const senderName = firstMsg.sender === 'sent' ? (firstMsg.userName || 'ç”¨æˆ·') : (firstMsg.name || firstMsg.characterName || 'AI');
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                        const firstMsgContent = safeExtractMessageContent(firstMsg);
                        messageContent += ` - ${senderName}: ${firstMsgContent.substring(0, 20)}...`;
                    }
                } else if (typeof message.content === 'string') {
                    messageContent = message.content;
                } else if (message.image) {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æ—§æ ¼å¼çš„å›¾ç‰‡æ¶ˆæ¯
                    messageContent = '[å›¾ç‰‡]';
                } else {
                    messageContent = '[ç‰¹æ®Šæ¶ˆæ¯]';
                }

                currentReplyTo = {
                    id: message.id,
                    content: messageContent,
                    sender: message.sender,
                    timestamp: message.timestamp,
                    senderName: getSenderDisplayName(message)
                };

                // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€
                if (currentChatCharacter) {
                    chatReplyStates[currentChatCharacter.id] = { ...currentReplyTo };
                }

                // æ˜¾ç¤ºå¼•ç”¨é¢„è§ˆ
                showReplyPreview();

                // èšç„¦åˆ°è¾“å…¥æ¡†
                const inputBox = document.getElementById('api-chat-input');
                if (inputBox) {
                    inputBox.focus();
                }
            }

            hideMessageMenu();
        }

        // è·å–å‘é€è€…æ˜¾ç¤ºåç§°
        function getSenderDisplayName(message) {
            if (message.sender === 'sent') {
                const chatSettings = getCurrentChatSettings();
                if (chatSettings.selectedIdentityId) {
                    const persona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                    if (persona) return persona.name;
                }
                return chatSettings.myChatNickname || 'æˆ‘';
            } else if (message.sender === 'received') {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
                const group = groupChats.find(g => g.id === currentChatCharacter.id);
                if (group) {
                    // ç¾¤èŠä¸­ï¼Œæ ¹æ®æ¶ˆæ¯çš„senderIdæˆ–nameæŸ¥æ‰¾æˆå‘˜
                    let member = null;
                    if (message.senderId) {
                        member = group.members.find(m => m.id === message.senderId);
                    } else if (message.name) {
                        member = group.members.find(m => m.name === message.name);
                    }
                    return member?.name || 'ç¾¤æˆå‘˜';
                } else {
                    // å•èŠ
                    const chatSettings = getCurrentChatSettings();
                    return chatSettings.aiChatNickname || currentChatCharacter.name;
                }
            }
            return 'æœªçŸ¥';
        }

        // æ˜¾ç¤ºå¼•ç”¨é¢„è§ˆ
        function showReplyPreview() {
            if (!currentReplyTo) return;

            // ç§»é™¤å·²å­˜åœ¨çš„å¼•ç”¨é¢„è§ˆ
            const existingPreview = document.getElementById('reply-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // åˆ›å»ºå¼•ç”¨é¢„è§ˆå…ƒç´ 
            const replyPreview = document.createElement('div');
            replyPreview.id = 'reply-preview';
            replyPreview.className = 'reply-preview';

            // æˆªæ–­æ˜¾ç¤ºå†…å®¹ - ç¼©çŸ­åˆ°25å­—ç¬¦
            const displayContent = truncateText(currentReplyTo.content, 25);

            replyPreview.innerHTML = `
                <div class="reply-preview-content">
                    <div class="reply-preview-line"></div>
                    <div class="reply-preview-text">
                        <div class="reply-preview-sender">${currentReplyTo.senderName}</div>
                        <div class="reply-preview-message">${displayContent}</div>
                    </div>
                    <button class="reply-preview-close" onclick="cancelReply()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿å¼•ç”¨é¢„è§ˆå¯è§
            replyPreview.style.display = 'block';
            replyPreview.style.visibility = 'visible';

            // æ’å…¥åˆ°è¾“å…¥åŒºåŸŸå†…éƒ¨çš„é¡¶éƒ¨
            const inputArea = document.querySelector('.chat-input-area');
            if (inputArea) {
                // å°†å¼•ç”¨é¢„è§ˆæ’å…¥åˆ°è¾“å…¥åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ä¹‹å‰
                const firstChild = inputArea.firstElementChild;
                if (firstChild) {
                    inputArea.insertBefore(replyPreview, firstChild);
                } else {
                    inputArea.appendChild(replyPreview);
                }
            }
        }

        // å–æ¶ˆå¼•ç”¨
        function cancelReply() {
            currentReplyTo = null;

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€
            if (currentChatCharacter) {
                delete chatReplyStates[currentChatCharacter.id];
            }

            const replyPreview = document.getElementById('reply-preview');
            if (replyPreview) {
                replyPreview.remove();
            }
        }

        // ç”Ÿæˆå¼•ç”¨æ¶ˆæ¯çš„HTML
        function generateReplyHTML(replyTo) {
            if (!replyTo) return '';

            let displayContent = truncateText(replyTo.content, 20);
            // å¤„ç†å¼•ç”¨æ¶ˆæ¯ä¸­çš„@å†…å®¹
            displayContent = processMentions(displayContent);

            return `
                <div class="reply-reference">
                    <div class="reply-reference-line"></div>
                    <div class="reply-reference-content">
                        <div class="reply-reference-sender">${replyTo.senderName}</div>
                        <div class="reply-reference-message">${displayContent}</div>
                    </div>
                </div>
            `;
        }

        // å¤åˆ¶æ¶ˆæ¯
        function copyMessage(messageId = null) {
            const targetMessageId = messageId || selectedMessageId;
            console.log('å¤åˆ¶æ¶ˆæ¯:', targetMessageId, 'æ¥æº:', messageId ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
            if (!targetMessageId) {
                console.log('é”™è¯¯: æ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯ID');
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === targetMessageId);

            if (message) {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                const messageContent = safeExtractMessageContent(message);
                navigator.clipboard.writeText(messageContent).then(() => {
                    alert('æ¶ˆæ¯å·²å¤åˆ¶');
                }).catch(() => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }

            hideMessageMenu();
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¶ˆæ¯æ¨¡æ€æ¡†
        function showEditMessageModal(messageId) {
            if (!messageId) return;

            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === messageId);

            if (!message) {
                showToast('æ¶ˆæ¯ä¸å­˜åœ¨', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨é€šç”¨å‡½æ•°å®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹
            let messageContent = '';
            try {
                messageContent = safeExtractMessageContent(message);
                // å¦‚æœæå–çš„å†…å®¹æ˜¯ç‰¹æ®Šæ¶ˆæ¯ç±»å‹çš„æè¿°ï¼Œæç¤ºç”¨æˆ·é‡æ–°è¾“å…¥
                if (messageContent.startsWith('[') && messageContent.endsWith(']')) {
                    messageContent = '[æ­¤æ¶ˆæ¯åŒ…å«ç‰¹æ®Šæ ¼å¼ï¼Œè¯·é‡æ–°è¾“å…¥å†…å®¹]';
                    console.warn('ç¼–è¾‘æ¶ˆæ¯æ—¶å‘ç°ç‰¹æ®Šç±»å‹çš„content:', message);
                }
            } catch (error) {
                console.error('æå–æ¶ˆæ¯å†…å®¹æ—¶å‡ºé”™:', error);
                messageContent = '[æ­¤æ¶ˆæ¯åŒ…å«ç‰¹æ®Šæ ¼å¼ï¼Œè¯·é‡æ–°è¾“å…¥å†…å®¹]';
            }

            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'edit-message-modal';

            const senderName = message.sender === 'sent' ? 'ä½ ' : (message.name || currentChatCharacter.name);

            modal.innerHTML = `
                <div class="modal-content edit-message-modal">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘æ¶ˆæ¯</h3>
                        <button class="modal-close" onclick="hideEditMessageModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="edit-message-info">
                            <span class="message-sender">${senderName}</span>
                            <span class="message-time">${formatTimestamp(message.timestamp)}</span>
                        </div>
                        <div class="edit-form-group">
                            <label>æ¶ˆæ¯å†…å®¹ï¼š</label>
                            <textarea
                                id="edit-message-content"
                                class="edit-message-textarea"
                                placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."
                                maxlength="2000"
                            >${messageContent}</textarea>
                            <div class="edit-message-counter">
                                <span id="edit-char-count">${messageContent.length}</span>/2000
                            </div>
                        </div>
                        ${message.image ? `
                            <div class="edit-form-group">
                                <label>å›¾ç‰‡ï¼š</label>
                                <div class="edit-message-image">
                                    <img src="${message.image}" alt="æ¶ˆæ¯å›¾ç‰‡" />
                                    <button class="remove-image-btn" onclick="removeMessageImage()">åˆ é™¤å›¾ç‰‡</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-cancel" onclick="hideEditMessageModal()">å–æ¶ˆ</button>
                        <button class="modal-btn modal-confirm" onclick="saveEditedMessage('${messageId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // æ·»åŠ å­—ç¬¦è®¡æ•°åŠŸèƒ½
            const textarea = document.getElementById('edit-message-content');
            const charCount = document.getElementById('edit-char-count');
            textarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘èšç„¦ä½†ä¸é€‰ä¸­æ–‡æœ¬ï¼Œå…‰æ ‡ç§»åˆ°æœ«å°¾
            setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }, 100);
        }

        // éšè—ç¼–è¾‘æ¶ˆæ¯æ¨¡æ€æ¡†
        function hideEditMessageModal() {
            const modal = document.getElementById('edit-message-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ä¿å­˜ç¼–è¾‘åçš„æ¶ˆæ¯
        async function saveEditedMessage(messageId) {
            const newContent = document.getElementById('edit-message-content').value.trim();

            if (!newContent) {
                showToast('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === messageId);

            if (messageIndex !== -1) {
                const oldContent = messages[messageIndex].content;

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿contentå­—æ®µå§‹ç»ˆæ˜¯å­—ç¬¦ä¸²ï¼Œé˜²æ­¢[object Object]é—®é¢˜
                if (typeof newContent === 'string') {
                    messages[messageIndex].content = newContent;
                } else {
                    console.warn('ç¼–è¾‘æ¶ˆæ¯æ—¶æ£€æµ‹åˆ°éå­—ç¬¦ä¸²å†…å®¹ï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²:', newContent);
                    messages[messageIndex].content = String(newContent);
                }

                // æ·»åŠ ç¼–è¾‘æ ‡è®°
                messages[messageIndex].edited = true;
                messages[messageIndex].editTime = Date.now();

                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨ä¿å­˜åˆ°æ•°æ®åº“å‰ï¼Œå†æ¬¡ç¡®ä¿æ¶ˆæ¯æ•°æ®æ ¼å¼æ­£ç¡®
                const messageToSave = {
                    ...messages[messageIndex],
                    content: String(messages[messageIndex].content) // å¼ºåˆ¶ç¡®ä¿contentæ˜¯å­—ç¬¦ä¸²
                };

                // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ›´æ–°æ•°æ®åº“ä¸­çš„å•æ¡æ¶ˆæ¯ï¼Œé¿å…å…¨é‡é‡å†™
                try {
                    const dbMessage = await db.chatMessages
                        .where('characterId').equals(currentChatCharacter.id)
                        .and(msg => msg.originalMessageId === messages[messageIndex].id)
                        .first();

                    if (dbMessage) {
                        dbMessage.messageData = messageToSave;
                        await db.chatMessages.put(dbMessage);
                        console.log('âœ… [é«˜æ•ˆç¼–è¾‘] æ¶ˆæ¯ç¼–è¾‘å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    }
                } catch (error) {
                    console.error('ç¼–è¾‘æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                    saveChatMessages();
                }
                renderChatMessages(currentChatCharacter.id);
                hideEditMessageModal();

                showToast('æ¶ˆæ¯å·²æ›´æ–°', 'success');

                console.log(`æ¶ˆæ¯å·²ç¼–è¾‘: "${oldContent}" -> "${newContent}"`);
            } else {
                showToast('æ¶ˆæ¯ä¸å­˜åœ¨', 'error');
            }
        }

        // ç§»é™¤æ¶ˆæ¯å›¾ç‰‡
        function removeMessageImage() {
            // è¿™ä¸ªåŠŸèƒ½å¯ä»¥åœ¨åç»­æ‰©å±•
            showToast('æš‚ä¸æ”¯æŒç§»é™¤å›¾ç‰‡', 'info');
        }

        // ç¼–è¾‘æ¶ˆæ¯ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬æ¥å£ï¼‰
        function editMessage() {
            if (!selectedMessageId) return;

            showEditMessageModal(selectedMessageId);
            hideModal('message-menu-modal');
        }

        // éªŒè¯å¤´åƒæ¥æºæ˜¯å¦æœ‰æ•ˆ
        async function validateAvatarSource(avatarUrl) {
            console.log('éªŒè¯å¤´åƒæ¥æº:', avatarUrl);
            if (!avatarUrl) return false;

            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å ä½ç¬¦ï¼Œå…ˆæ›¿æ¢ä¸ºå®é™…å›¾ç‰‡URLå†éªŒè¯
            let actualAvatarUrl = avatarUrl;
            if (avatarUrl === 'CURRENT_USER_IMAGE' ||
                avatarUrl === 'CURRENT_USER_IMAGE' ||
                avatarUrl === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                avatarUrl === 'å›¾ç‰‡URL') {
                const recentUserImage = getRecentUserImage();
                if (recentUserImage) {
                    actualAvatarUrl = recentUserImage;
                    console.log('å ä½ç¬¦æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡URL:', actualAvatarUrl);
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·å‘é€çš„å›¾ç‰‡ï¼ŒéªŒè¯å¤±è´¥');
                    return false;
                }
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„å›¾ç‰‡ï¼ˆåœ¨èŠå¤©è®°å½•ä¸­ï¼‰
            if (currentChatCharacter && chatMessages[currentChatCharacter.id]) {
                const userImages = [];

                // éå†æ‰€æœ‰ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œæå–å›¾ç‰‡URL
                chatMessages[currentChatCharacter.id]
                    .filter(msg => msg.sender === 'sent')
                    .forEach(msg => {
                        // å¤„ç†æ—§æ ¼å¼çš„å›¾ç‰‡æ¶ˆæ¯ï¼ˆç›´æ¥æœ‰ image å­—æ®µï¼‰
                        if (msg.image) {
                            userImages.push(msg.image);
                        }

                        // å¤„ç†æ–°æ ¼å¼çš„å¤šæ¨¡æ€æ¶ˆæ¯ï¼ˆcontent æ˜¯æ•°ç»„ï¼‰
                        if (Array.isArray(msg.content)) {
                            msg.content.forEach(item => {
                                if (item.type === 'image_url' && item.image_url && item.image_url.url) {
                                    userImages.push(item.image_url.url);
                                }
                            });
                        }
                    });

                console.log('ç”¨æˆ·å‘é€çš„å›¾ç‰‡åˆ—è¡¨:', userImages);
                console.log('æ£€æŸ¥å¤´åƒURLæ˜¯å¦åœ¨ç”¨æˆ·å›¾ç‰‡ä¸­:', userImages.includes(actualAvatarUrl));

                if (userImages.includes(actualAvatarUrl)) {
                    console.log('å¤´åƒæ¥æºéªŒè¯é€šè¿‡ï¼šç”¨æˆ·å‘é€çš„å›¾ç‰‡');
                    return true;
                }
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸–ç•Œä¹¦ä¸­æä¾›çš„å¤´åƒURL
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks) {
                for (const worldbookId of chatSettings.selectedWorldbooks) {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook && worldbook.content && worldbook.content.includes(actualAvatarUrl)) {
                        console.log('å¤´åƒæ¥æºéªŒè¯é€šè¿‡ï¼šä¸–ç•Œä¹¦ä¸­çš„URL');
                        return true;
                    }
                }
            }

            console.log('å¤´åƒæ¥æºéªŒè¯å¤±è´¥');
            return false;
        }

        // è§’è‰²ä¸»åŠ¨æ›´æ¢å¤´åƒåŠŸèƒ½ - åªä¿®æ”¹èŠå¤©è®¾ç½®ä¸­çš„å¤´åƒï¼Œä¸ä¿®æ”¹è§’è‰²å¡
        async function changeCharacterAvatarByAI(newAvatarUrl, reason = '') {
            if (!currentChatCharacter || !newAvatarUrl) return false;

            try {
                // è·å–æˆ–åˆ›å»ºå½“å‰èŠå¤©çš„è®¾ç½®
                const currentSettings = getCurrentChatSettings();

                // å‹ç¼©å¤´åƒå›¾ç‰‡ä»¥å‡å°‘å­˜å‚¨ç©ºé—´
                let compressedAvatarUrl = newAvatarUrl;
                if (newAvatarUrl.startsWith('data:image')) {
                    try {
                        compressedAvatarUrl = await compressImage(newAvatarUrl, 200, 0.7);
                        console.log('å¤´åƒå·²å‹ç¼©ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´');
                    } catch (error) {
                        console.warn('å¤´åƒå‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', error);
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ç›´æ¥è¦†ç›–èŠå¤©å¤´åƒå­—æ®µï¼ŒAIæ¢å¤´åƒä¼šè¦†ç›–ç”¨æˆ·è®¾ç½®
                if (!chatSettings[currentChatCharacter.id]) {
                    chatSettings[currentChatCharacter.id] = {};
                }
                chatSettings[currentChatCharacter.id].aiChatAvatar = compressedAvatarUrl;

                console.log(`èŠå¤©å¤´åƒå·²æ›´æ–°ï¼š`, {
                    characterId: currentChatCharacter.id,
                    characterName: currentChatCharacter.name,
                    avatarUrl: compressedAvatarUrl.substring(0, 50) + '...',
                    settingsSnapshot: {
                        aiChatAvatar: !!chatSettings[currentChatCharacter.id].aiChatAvatar
                    }
                });

                // ä¿å­˜èŠå¤©è®¾ç½®
                await saveChatSettings();

                // å‘é€ç³»ç»Ÿæç¤ºæ¶ˆæ¯
                const systemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${currentChatCharacter.name} æ›´æ¢äº†å¤´åƒ${reason ? ': ' + reason : ''}`,
                    timestamp: Date.now(),
                    isAvatarChange: true
                };

                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(systemMessage);
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¤´åƒæ›´æ¢ç³»ç»Ÿæ¶ˆæ¯ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([currentChatCharacter.id]);
                    console.log('âœ… [é«˜æ•ˆå¤´åƒæ›´æ¢ç³»ç»Ÿæ¶ˆæ¯] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('å¤´åƒæ›´æ¢ç³»ç»Ÿæ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨ä¿å­˜æ¶ˆæ¯åå†åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œç¡®ä¿åŒ…å«æ–°å¤´åƒå’Œç³»ç»Ÿæ¶ˆæ¯
                renderChatMessages(currentChatCharacter.id);

                // ğŸ”¥ã€æ–°å¢ã€‘å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
                forceRefreshAvatars();

                console.log(`è§’è‰² ${currentChatCharacter.name} åœ¨å½“å‰èŠå¤©ä¸­æ›´æ¢äº†å¤´åƒï¼Œä½†è§’è‰²å¡ä¿æŒä¸å˜`);

                return true;
            } catch (error) {
                console.error('è§’è‰²æ›´æ¢å¤´åƒå¤±è´¥:', error);
                return false;
            }

            return false;
        }

        // åˆ é™¤æ¶ˆæ¯
        async function deleteMessage(messageId = null) {
            const targetMessageId = messageId || selectedMessageId;
            console.log('åˆ é™¤æ¶ˆæ¯:', targetMessageId, 'æ¥æº:', messageId ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
            if (!targetMessageId) {
                console.log('é”™è¯¯: æ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯ID');
                return;
            }

                const messages = chatMessages[currentChatCharacter.id] || [];
                const messageIndex = messages.findIndex(msg => msg.id === targetMessageId);

            if (messageIndex === -1) {
                hideMessageMenu();
                return;
            }

            const messageToDelete = messages[messageIndex];

            if (confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ é™¤ç›¸å…³çš„æ—¶é—´çº¿è®°å½•å’Œå·¥ä½œè®°å¿†
                try {
                    await deleteRelatedTimelineEvents(messageToDelete);
                    console.log('âœ… å·²æ¸…ç†æ’¤å›æ¶ˆæ¯çš„ç›¸å…³æ—¶é—´çº¿è®°å½•');
                } catch (error) {
                    console.error('åˆ é™¤æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
                }

                // ğŸ”¥ã€ç»ˆæä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€çš„æ’¤å›å¤„ç†å‡½æ•°
                await _internalRecallMessage(currentChatCharacter.id, messageToDelete);
            }

            hideMessageMenu();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µçš„è¾…åŠ©å‡½æ•°
        async function checkStorageUsage() {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage || 0) / (1024 * 1024);
                    const quotaMB = (estimate.quota || 0) / (1024 * 1024);
                    const usagePercent = quotaMB > 0 ? (usedMB / quotaMB) * 100 : 0;

                    return {
                        usedMB: usedMB,
                        quotaMB: quotaMB,
                        usagePercent: usagePercent,
                        needCleanup: usagePercent > 80 // è¶…è¿‡80%æ—¶éœ€è¦æ¸…ç†
                    };
                }
            } catch (error) {
                console.warn('æ— æ³•æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ:', error);
            }
            return null;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ™ºèƒ½æ•°æ®æ¸…ç†å‡½æ•°
        async function performSmartDataCleanup() {
            try {
                // ç®€å•çš„æ¸…ç†ç­–ç•¥ï¼šä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯
                const allMessages = await db.chatMessages.orderBy('timestamp').toArray();
                if (allMessages.length > 5000) {
                    const messagesToDelete = allMessages.slice(0, allMessages.length - 3000);
                    const idsToDelete = messagesToDelete.map(msg => msg.id);
                    await db.chatMessages.bulkDelete(idsToDelete);
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${idsToDelete.length} æ¡æ—§æ¶ˆæ¯`);
                }
            } catch (error) {
                console.error('æ•°æ®æ¸…ç†å¤±è´¥:', error);
            }
        }

        /**
         * ğŸ”¥ã€ç»ˆæä¿®å¤ç‰ˆ & åŠ¨ç”»æ¢å¤ã€‘ç»Ÿä¸€çš„å†…éƒ¨æ’¤å›æ¶ˆæ¯å¤„ç†å‡½æ•°
         * @param {string} characterId - è§’è‰²ID
         * @param {object} messageToRecall - è¦æ’¤å›çš„æ¶ˆæ¯å¯¹è±¡
         */
        async function _internalRecallMessage(characterId, messageToRecall) {
            const messages = chatMessages[characterId] || [];
            const messageIndex = messages.findIndex(msg => msg.id === messageToRecall.id);

            if (messageIndex === -1) {
                console.error('âŒ [æ ¸å¿ƒæ’¤å›] æœªåœ¨å†…å­˜ä¸­æ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯:', messageToRecall);
                return;
            }

            // 1. ğŸ”¥ã€åŠ¨ç”»æ¢å¤ã€‘åœ¨æ•°æ®æ“ä½œå‰ï¼Œå…ˆæ’­æ”¾UIåŠ¨ç”»
            const messageContainer = document.querySelector(`[data-message-id="${messageToRecall.id}"]`);
            if (messageContainer) {
                console.log('ğŸ¬ [æ ¸å¿ƒæ’¤å›] æ’­æ”¾æ’¤å›åŠ¨ç”»...');
                // ä½¿ç”¨ä½ CSSä¸­å·²æœ‰çš„fadeOutåŠ¨ç”»
                messageContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            }

            // 2. ğŸ”¥ã€é«˜æ•ˆæ’¤å›ã€‘ç›´æ¥åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹å•æ¡æ¶ˆæ¯ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                // æ‰¾åˆ°æ•°æ®åº“ä¸­å¯¹åº”çš„æ¶ˆæ¯
                const dbMessage = await db.chatMessages
                    .where('characterId').equals(characterId)
                    .and(msg => msg.originalMessageId === messageToRecall.id)
                    .first();

                if (dbMessage) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨é€šç”¨å‡½æ•°å®‰å…¨åœ°æå–åŸæ¶ˆæ¯å†…å®¹ï¼Œé˜²æ­¢[object Object]é—®é¢˜
                    const originalContentText = safeExtractMessageContent(messageToRecall);

                    // ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ¶ˆæ¯å†…å®¹
                    const whoRecalled = messageToRecall.sender === 'sent' ? 'ä½ ' : (currentChatCharacter.name || 'å¯¹æ–¹');
                    dbMessage.messageData = {
                        ...dbMessage.messageData,
                        sender: 'system', // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿æ•°æ®åº“ä¸­ä¹Ÿæ˜¯ç³»ç»Ÿæ¶ˆæ¯
                        type: 'recalled_message',
                        content: `${whoRecalled}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯\nåŸæ–‡ï¼š${originalContentText}`, // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨æå–çš„å†…å®¹
                        originalContent: originalContentText, // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜å®‰å…¨æå–çš„å†…å®¹
                        isRecalled: true
                    };

                    // å•æ¡æ¶ˆæ¯æ›´æ–°ï¼Œä¸è§¦å‘å…¨é‡é‡å†™
                    await db.chatMessages.put(dbMessage);
                    console.log('âœ… [é«˜æ•ˆæ’¤å›] æ•°æ®åº“å•æ¡æ¶ˆæ¯æ›´æ–°å®Œæˆ');
                }
            } catch (error) {
                console.error('æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹å¼:', error);
            }

            // 3. æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯ä¸ºç³»ç»Ÿæ¶ˆæ¯æ ¼å¼
            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨é€šç”¨å‡½æ•°å®‰å…¨åœ°æå–åŸæ¶ˆæ¯å†…å®¹
            const originalContentText = safeExtractMessageContent(messageToRecall);

            const whoRecalled = messageToRecall.sender === 'sent' ? 'ä½ ' : (currentChatCharacter.name || 'å¯¹æ–¹');
            messages[messageIndex] = {
                id: messageToRecall.id,
                sender: 'system', // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿æ˜¯ç³»ç»Ÿæ¶ˆæ¯
                type: 'recalled_message',
                content: `${whoRecalled}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯\nåŸæ–‡ï¼š${originalContentText}`, // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨æå–çš„å†…å®¹
                originalContent: originalContentText, // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜å®‰å…¨æå–çš„å†…å®¹
                timestamp: messageToRecall.timestamp,
                isRecalled: true
            };

            // 4. åˆ·æ–°UIï¼ˆä¸è°ƒç”¨saveChatMessagesï¼Œé¿å…å“ˆå¸Œæ£€æµ‹ï¼‰
            renderChatMessages(characterId);
            renderMessageList(); // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨çš„æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ

            console.log(`ğŸ‰ [é«˜æ•ˆæ’¤å›] è§’è‰² ${characterId} çš„æ¶ˆæ¯ ${messageToRecall.id} å·²æˆåŠŸæ’¤å›`);
        }


        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // æ ¼å¼åŒ–æ—¶é—´æˆ³ï¼ˆå®Œæ•´æ—¶é—´ï¼‰
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;

            if (messageDate.getTime() === today.getTime()) {
                return timeStr; // ä»Šå¤©åªæ˜¾ç¤ºæ—¶é—´
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return `æ˜¨å¤© ${timeStr}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}æœˆ${day}æ—¥ ${timeStr}`;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆä»…æ—¶åˆ†ï¼‰
        function formatTimeOnly(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸ
        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
        }

        // åŠ è½½URL
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            let fullUrl = url;

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }

            document.getElementById('browser-frame').src = fullUrl;
        }

        // æ—§ç‰ˆæœ¬APIç±»å‹åˆ‡æ¢å¤„ç†å·²åˆ é™¤ - ä½¿ç”¨æ–°ç‰ˆæœ¬çš„APIè®¾ç½®ç³»ç»Ÿ

        // æ—§ç‰ˆæœ¬æµ‹è¯•APIè¿æ¥å’Œè·å–æ¨¡å‹åˆ—è¡¨å‡½æ•°å·²åˆ é™¤ - ç°åœ¨ä½¿ç”¨æ–°ç‰ˆæœ¬çš„APIè®¾ç½®ç³»ç»Ÿ

        // ä¿å­˜APIè®¾ç½®
        async function saveApiSettings() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();
            const temperature = parseFloat(document.getElementById('temperature-slider').value) || 0.75;
            const emojiRecognitionEnabled = document.getElementById('emoji-recognition-enabled').checked;

            if (!baseUrl || !apiKey || !model) {
                showToast('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯', 'error');
                return;
            }

            apiSettings = {
                base: baseUrl,
                key: apiKey,
                model: model,
                temperature: temperature,
                emojiRecognitionEnabled: emojiRecognitionEnabled,
                endpoint: '/chat/completions'  // æ·»åŠ é»˜è®¤endpoint
            };

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶ä¿å­˜åˆ°IndexedDBå’ŒlocalStorageï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                await db.apiSettings.put({
                    id: 'main',
                    settings: apiSettings
                });
                localStorage.setItem('apiSettings', JSON.stringify(apiSettings));

                showToast('APIè®¾ç½®å·²ä¿å­˜ï¼', 'success');
                console.log('ğŸ”§ [APIè®¾ç½®] å·²ä¿å­˜åˆ°IndexedDBå’ŒlocalStorage:', apiSettings);
            } catch (error) {
                console.error('ä¿å­˜APIè®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜APIè®¾ç½®å¤±è´¥: ' + error.message, 'error');
                return;
            }

            // æ›´æ–°æ¸©åº¦æ˜¾ç¤º
            document.getElementById('temperature-value').textContent = temperature.toFixed(2);

            // ä¿®å¤ï¼šä¿å­˜åä¸è·³è½¬ï¼Œç•™åœ¨å½“å‰APIè®¾ç½®é¡µé¢
        }

        // ğŸŒŸ Geminiç›´è¿å¿«é€Ÿè®¾ç½®
        function setGeminiDirect() {
            // è‡ªåŠ¨å¡«å……Geminié…ç½®
            document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
            document.getElementById('api-key').placeholder = 'è¯·è¾“å…¥Google AI Studioçš„API Key';

            // æ¸…ç©ºä¹‹å‰çš„æ¨¡å‹é€‰æ‹©å¹¶æ·»åŠ Geminiæ¨¡å‹
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (å®éªŒç‰ˆ) - æ¨è</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash - å¿«é€Ÿ</option>
                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B - è½»é‡</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro - ç¨³å®š</option>
                <option value="gemini-pro">Gemini Pro - ç»å…¸</option>
                <option value="gemini-pro-vision">Gemini Pro Vision - è§†è§‰</option>
                <option value="æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°</option>
            `;

            // æ·»åŠ æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½
            modelSelect.onchange = function() {
                if (this.value === 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°') {
                    const customModel = prompt('è¯·è¾“å…¥Geminiæ¨¡å‹åç§°\n\nå¸¸è§é€‰é¡¹ï¼š\nâ€¢ gemini-2.0-flash-exp\nâ€¢ gemini-1.5-flash\nâ€¢ gemini-1.5-pro\nâ€¢ gemini-pro');
                    if (customModel && customModel.trim()) {
                        const newOption = new Option(customModel.trim(), customModel.trim());
                        this.insertBefore(newOption, this.lastElementChild);
                        this.value = customModel.trim();
                    } else {
                        this.value = '';
                    }
                }
            };

            showToast('ğŸŒŸ Geminiç›´è¿é…ç½®å·²è‡ªåŠ¨å¡«å†™ï¼\n\nä½¿ç”¨è¯´æ˜ï¼š\n1. è¯·åœ¨Google AI Studioè·å–API Key\n2. é€‰æ‹©åˆé€‚çš„æ¨¡å‹\n3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯é…ç½®', 'success');
        }

        // ğŸ¤— HuggingFaceåä»£å¿«é€Ÿè®¾ç½®
        function setHuggingFaceProxy() {
            // è‡ªåŠ¨å¡«å……HuggingFaceåä»£é…ç½® - ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼
            document.getElementById('api-base').value = 'https://xxx-xxx.hf.space/v1';
            document.getElementById('api-key').placeholder = 'è¯·è¾“å…¥HuggingFaceçš„API Token';

            // æ¸…ç©ºä¹‹å‰çš„æ¨¡å‹é€‰æ‹©å¹¶æ·»åŠ å¸¸è§HFæ¨¡å‹
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                <optgroup label="Llamaç³»åˆ—">
                    <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7b-chat-hf</option>
                    <option value="meta-llama/Llama-2-13b-chat-hf">Llama-2-13b-chat-hf</option>
                    <option value="meta-llama/Meta-Llama-3-8B-Instruct">Meta-Llama-3-8B-Instruct</option>
                </optgroup>
                <optgroup label="å¯¹è¯æ¨¡å‹">
                <option value="microsoft/DialoGPT-large">DialoGPT-large</option>
                <option value="microsoft/DialoGPT-medium">DialoGPT-medium</option>
                    <option value="facebook/blenderbot-400M-distill">BlenderBot-400M</option>
                </optgroup>
                <optgroup label="é€šç”¨æ¨¡å‹">
                    <option value="mistralai/Mistral-7B-Instruct-v0.1">Mistral-7B-Instruct</option>
                    <option value="teknium/OpenHermes-2.5-Mistral-7B">OpenHermes-2.5-Mistral-7B</option>
                </optgroup>
                <optgroup label="è‡ªå®šä¹‰">
                    <option value="custom">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°...</option>
                </optgroup>
            `;

            // æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥åŠŸèƒ½
            modelSelect.onchange = function() {
                if (this.value === 'custom') {
                    const customModel = prompt('è¯·è¾“å…¥æ¨¡å‹åç§°ï¼ˆä¾‹å¦‚ï¼šmeta-llama/Llama-2-7b-chat-hfï¼‰ï¼š');
                    if (customModel && customModel.trim()) {
                        const newOption = new Option(customModel.trim(), customModel.trim());
                        this.insertBefore(newOption, this.lastElementChild);
                        this.value = customModel.trim();
                    } else {
                        this.value = '';
                    }
                }
            };

            showToast('ğŸ¤— HuggingFaceåä»£é…ç½®å·²è‡ªåŠ¨å¡«å†™ï¼\n\nè¯·ï¼š\n1. å°†åœ°å€ä¸­çš„ xxx-xxx æ›¿æ¢ä¸ºå®é™…çš„HF Spaceåœ°å€\n2. é€‰æ‹©æ¨¡å‹æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°', 'success');
        }

        // ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾
        function saveCurrentConfig() {
            const configName = document.getElementById('config-name-input').value.trim();

            if (!configName) {
                showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
                return;
            }

            const currentConfig = {
                name: configName,
                base: document.getElementById('api-base').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value.trim(),
                temperature: parseFloat(document.getElementById('temperature-slider').value) || 0.75,
                emojiRecognitionEnabled: document.getElementById('emoji-recognition-enabled').checked,
                savedAt: new Date().toLocaleString()
            };

            // è·å–å·²ä¿å­˜çš„é…ç½®
            let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé…ç½®
            const existingIndex = savedConfigs.findIndex(config => config.name === configName);
            if (existingIndex !== -1) {
                if (confirm(`é…ç½®"${configName}"å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                    savedConfigs[existingIndex] = currentConfig;
                } else {
                    return;
                }
            } else {
                savedConfigs.push(currentConfig);
            }

            localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
            document.getElementById('config-name-input').value = '';

            renderSavedConfigs();
            showToast(`é…ç½®"${configName}"å·²ä¿å­˜`, 'success');
        }

        // æ¸²æŸ“å·²ä¿å­˜çš„é…ç½®
        function renderSavedConfigs() {
            const container = document.getElementById('saved-configs-container');
            const noConfigsMessage = document.getElementById('no-configs-message');
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');

            if (savedConfigs.length === 0) {
                container.style.display = 'none';
                noConfigsMessage.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            noConfigsMessage.style.display = 'none';

            container.innerHTML = savedConfigs.map(config => `
                <div class="config-card" style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s ease; cursor: pointer;" onclick="loadConfig('${config.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #333; font-size: 15px;">${config.name}</div>
                        <button onclick="event.stopPropagation(); deleteConfig('${config.name}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 12px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,107,107,0.1)'" onmouseout="this.style.background='none'">ğŸ—‘ï¸</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                        <div>ğŸŒ ${config.base}</div>
                        <div>ğŸ¤– ${config.model}</div>
                        <div>ğŸŒ¡ï¸ æ¸©åº¦: ${config.temperature}</div>
                    </div>
                    <div style="font-size: 11px; color: #999;">ä¿å­˜äº: ${config.savedAt}</div>
                </div>
            `).join('');
        }

        // åŠ è½½é…ç½®
        function loadConfig(configName) {
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            const config = savedConfigs.find(c => c.name === configName);

            if (!config) {
                showToast('é…ç½®ä¸å­˜åœ¨', 'error');
                return;
            }

            // å¡«å……è¡¨å•
            document.getElementById('api-base').value = config.base;
            document.getElementById('api-key').value = config.key;
            document.getElementById('temperature-slider').value = config.temperature;
            document.getElementById('temperature-value').textContent = config.temperature.toFixed(2);

            // å¤„ç†æ¨¡å‹é€‰æ‹©
            const modelSelect = document.getElementById('model-select');
            const existingOption = Array.from(modelSelect.options).find(option => option.value === config.model);
            if (!existingOption) {
                // å¦‚æœæ¨¡å‹ä¸åœ¨å½“å‰é€‰é¡¹ä¸­ï¼Œæ·»åŠ å®ƒ
                const newOption = new Option(config.model, config.model);
                modelSelect.appendChild(newOption);
            }
            modelSelect.value = config.model;

            // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½®
            const emojiRecognitionCheckbox = document.getElementById('emoji-recognition-enabled');
            if (emojiRecognitionCheckbox) {
                emojiRecognitionCheckbox.checked = config.emojiRecognitionEnabled !== false;
            }

            showToast(`å·²åŠ è½½é…ç½®"${configName}"`, 'success');
        }

        // åˆ é™¤é…ç½®
        function deleteConfig(configName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${configName}"å—ï¼Ÿ`)) {
                let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
                savedConfigs = savedConfigs.filter(config => config.name !== configName);
                localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
                renderSavedConfigs();
                showToast(`é…ç½®"${configName}"å·²åˆ é™¤`, 'success');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é…ç½®
        function clearAllConfigs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ä¿å­˜çš„é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('savedApiConfigs');
                renderSavedConfigs();
                showToast('æ‰€æœ‰é…ç½®å·²æ¸…ç©º', 'success');
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();

            if (!baseUrl || !apiKey || !model) {
                showToast('è¯·å…ˆå¡«å†™å®Œæ•´çš„APIé…ç½®', 'error');
                return;
            }

            const testBtn = document.getElementById('test-api-connection-btn');
            const originalText = testBtn.textContent;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testBtn.disabled = true;

            try {
                // æ ¹æ®ä¸åŒçš„APIç±»å‹æ„å»ºæµ‹è¯•è¯·æ±‚
                let testUrl, testPayload, testHeaders;

                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini APIæµ‹è¯•
                    testUrl = `${baseUrl}/models/${model}:generateContent?key=${apiKey}`;
                    testPayload = {
                        contents: [{
                            parts: [{ text: "Hello" }]
                        }],
                        generationConfig: {
                            temperature: 0.7
                            // ä¸æ·»åŠ maxOutputTokensç­‰Geminiä¸æ”¯æŒçš„å‚æ•°
                        }
                    };
                    testHeaders = {
                        'Content-Type': 'application/json'
                    };
                } else {
                    // OpenAIå…¼å®¹APIæµ‹è¯• - æ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                    if (baseUrl.endsWith('/v1')) {
                        testUrl = `${baseUrl}/chat/completions`;
                    } else if (baseUrl.includes('/v1/')) {
                        // ä¿®å¤ï¼šå¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                        testUrl = `${baseUrl}/chat/completions`;
                    } else {
                        testUrl = `${baseUrl}/v1/chat/completions`;
                    }
                    testPayload = {
                        model: model,
                        messages: [{ role: "user", content: "Hello" }],
                        max_tokens: 10
                    };
                    testHeaders = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                }

                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: testHeaders,
                    body: JSON.stringify(testPayload)
                });

                if (response.ok) {
                    showToast('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');

                    // ğŸ”¥ã€ä¿®å¤ã€‘æµ‹è¯•æˆåŠŸåè‡ªåŠ¨ä¿å­˜APIè®¾ç½®ï¼Œé¿å…ç”¨æˆ·é‡å¤è¾“å…¥
                    apiSettings = {
                        base: baseUrl,
                        key: apiKey,
                        model: model,
                        temperature: parseFloat(document.getElementById('temperature-slider').value) || 0.75,
                        endpoint: '/chat/completions'
                    };

                    // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶ä¿å­˜åˆ°IndexedDBå’ŒlocalStorageï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                    try {
                        await db.apiSettings.put({
                            id: 'main',
                            settings: apiSettings
                        });
                        localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
                        console.log('ğŸ”§ [APIæµ‹è¯•] APIè®¾ç½®å·²è‡ªåŠ¨ä¿å­˜åˆ°IndexedDBå’ŒlocalStorage');
                    } catch (error) {
                        console.error('è‡ªåŠ¨ä¿å­˜APIè®¾ç½®å¤±è´¥:', error);
                    }
                } else {
                    const errorText = await response.text();
                    showToast(`âŒ APIè¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    console.error('APIæµ‹è¯•å¤±è´¥:', errorText);
                }
            } catch (error) {
                showToast(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                console.error('APIæµ‹è¯•é”™è¯¯:', error);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }

        // è·å–æ¨¡å‹åˆ—è¡¨
        async function fetchModels() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();

            if (!baseUrl || !apiKey) {
                showToast('è¯·å…ˆå¡«å†™APIåœ°å€å’Œå¯†é’¥', 'error');
                return;
            }

            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = 'è·å–ä¸­...';
            fetchBtn.disabled = true;

            try {
                let modelsUrl, headers;

                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini API
                    modelsUrl = `${baseUrl}/models?key=${apiKey}`;
                    headers = {};
                } else {
                    // OpenAIå…¼å®¹API - æ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                    if (baseUrl.endsWith('/v1')) {
                        modelsUrl = `${baseUrl}/models`;
                    } else if (baseUrl.includes('/v1/')) {
                        // ä¿®å¤ï¼šå¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ models
                        modelsUrl = `${baseUrl}/models`;
                    } else {
                        modelsUrl = `${baseUrl}/v1/models`;
                    }
                    headers = {
                        'Authorization': `Bearer ${apiKey}`
                    };
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤è¶…æ—¶æ§åˆ¶ï¼Œé¿å…AbortError
                const response = await fetch(modelsUrl, {
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const modelSelect = document.getElementById('model-select');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';

                let models = [];
                if (data.models) {
                    // Gemini APIæ ¼å¼ - ä¿®å¤æ¨¡å‹è¿‡æ»¤é€»è¾‘
                    console.log('Gemini APIå“åº”æ•°æ®:', data);
                    models = data.models
                        .filter(model => {
                            // å…è®¸æ‰€æœ‰æ”¯æŒgenerateContentçš„æ¨¡å‹
                            return model.name && (
                                model.name.includes('gemini') ||
                                model.name.includes('models/') ||
                                model.supportedGenerationMethods?.includes('generateContent') ||
                                model.name.includes('generate')
                            );
                        })
                        .map(model => {
                            // æå–æ¨¡å‹åç§°ï¼Œå»æ‰å‰ç¼€
                            const modelName = model.name.includes('/')
                                ? model.name.split('/').pop()
                                : model.name;
                            return modelName;
                        });

                    // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹ï¼ˆè°ƒè¯•ç”¨ï¼‰
                    if (models.length === 0 && data.models.length > 0) {
                        console.log('è¿‡æ»¤åæ²¡æœ‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ¨¡å‹:', data.models);
                        models = data.models.map(model =>
                            model.name.includes('/') ? model.name.split('/').pop() : model.name
                        );
                    }
                } else if (data.data) {
                    // OpenAI APIæ ¼å¼
                    models = data.data.map(model => model.id);
                }

                models.forEach(modelId => {
                    const option = new Option(modelId, modelId);
                    modelSelect.appendChild(option);
                });

                showToast(`âœ… æˆåŠŸè·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, 'success');
            } catch (error) {
                let errorMessage = error.message;

                if (errorMessage.includes('Failed to fetch') || errorMessage.includes('ERR_TIMED_OUT')) {
                    if (baseUrl.includes('.hf.space')) {
                        errorMessage = 'HuggingFace Spaceè¿æ¥è¶…æ—¶ï¼Œå¯èƒ½éœ€è¦å…ˆå¯åŠ¨æœåŠ¡æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚\n\nğŸ’¡ å»ºè®®ï¼š\n1. æ£€æŸ¥HF Spaceæ˜¯å¦æ­£åœ¨è¿è¡Œ\n2. å°è¯•å…ˆæ‰‹åŠ¨è®¿é—®è¯¥URLæµ‹è¯•è¿æ¥\n3. å¦‚æœæœåŠ¡ä¸æ”¯æŒ/modelsç«¯ç‚¹ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°';
                    } else {
                        errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ä»¥åŠç½‘ç»œè¿æ¥';
                    }
                }

                showToast(`âŒ è·å–æ¨¡å‹å¤±è´¥: ${errorMessage}`, 'error');
                console.error('è·å–æ¨¡å‹å¤±è´¥:', error);

                // ä¸ºGeminiæä¾›å¸¸è§æ¨¡å‹é€‰é¡¹ä½œä¸ºåå¤‡
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    const modelSelect = document.getElementById('model-select');
                    modelSelect.innerHTML = `
                        <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (å®éªŒç‰ˆ)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-pro">Gemini Pro</option>
                        <option value="gemini-pro-vision">Gemini Pro Vision</option>
                        <option value="æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°</option>
                    `;
                    setTimeout(() => {
                        showToast('ğŸ’¡ å·²ä¸ºæ‚¨æä¾›å¸¸è§Geminiæ¨¡å‹é€‰é¡¹', 'info');
                    }, 1000);
                }

                // å¦‚æœæ˜¯HF Spaceï¼Œç»™å‡ºé¢å¤–æç¤º
                if (baseUrl.includes('.hf.space')) {
                    setTimeout(() => {
                        showToast('ğŸ’¡ æç¤ºï¼šHuggingFace Spaceå¯èƒ½ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ï¼Œå»ºè®®æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°', 'info');
                    }, 2000);
                }
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }

        // å¯¼å‡ºå®Œæ•´å¤‡ä»½
        function exportFullBackup() {
            // è¿™é‡Œå¯ä»¥å®ç°å®Œæ•´çš„æ•°æ®å¯¼å‡ºåŠŸèƒ½
            showToast('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å¯¼å…¥å®Œæ•´å¤‡ä»½
        function importFullBackup() {
            // è¿™é‡Œå¯ä»¥å®ç°å®Œæ•´çš„æ•°æ®å¯¼å…¥åŠŸèƒ½
            document.getElementById('import-full-backup-input').click();
        }

        // åˆå§‹åŒ–APIè®¾ç½®ç•Œé¢
        async function initializeApiSettings() {
            // åŠ è½½å·²ä¿å­˜çš„APIé…ç½®åˆ°è¡¨å•
            await loadApiSettingsToForm();

            // æ¸²æŸ“å·²ä¿å­˜çš„é…ç½®
            renderSavedConfigs();
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘åŠ è½½APIè®¾ç½®åˆ°è¡¨å•å¹¶è‡ªåŠ¨æ‹‰å–æ¨¡å‹
        async function loadApiSettingsToForm() {
            try {
                // ä»IndexedDBåŠ è½½è®¾ç½®
                const savedSettings = await db.apiSettings.get('main');
                let settings = null;

                if (savedSettings) {
                    settings = savedSettings.settings;
                } else {
                    // å°è¯•ä»localStorageè¿ç§»
                    const localSettings = localStorage.getItem('apiSettings');
                    if (localSettings) {
                        settings = JSON.parse(localSettings);
                        // è¿ç§»åˆ°IndexedDB
                        await db.apiSettings.put({
                            id: 'main',
                            settings: settings
                        });
                        console.log('ğŸ”§ [APIè®¾ç½®] å·²è¿ç§»localStorageè®¾ç½®åˆ°IndexedDB');
                    }
                }

                if (settings) {
                    console.log('ğŸ”§ [APIè®¾ç½®] åŠ è½½å·²ä¿å­˜çš„APIè®¾ç½®:', settings);

                    // å¡«å……è¡¨å•å­—æ®µ
                    if (settings.base) {
                        const baseInput = document.getElementById('api-base');
                        if (baseInput) baseInput.value = settings.base;
                    }

                    if (settings.key) {
                        const keyInput = document.getElementById('api-key');
                        if (keyInput) keyInput.value = settings.key;
                    }

                    if (settings.temperature !== undefined) {
                        const tempSlider = document.getElementById('temperature-slider');
                        const tempValue = document.getElementById('temperature-value');
                        if (tempSlider && tempValue) {
                            tempSlider.value = settings.temperature;
                            tempValue.textContent = settings.temperature.toFixed(2);
                        }
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½®
                    const emojiRecognitionCheckbox = document.getElementById('emoji-recognition-enabled');
                    if (emojiRecognitionCheckbox) {
                        // é»˜è®¤å¯ç”¨è¡¨æƒ…åŒ…è¯†åˆ«ï¼ˆå‘åå…¼å®¹ï¼‰
                        emojiRecognitionCheckbox.checked = settings.emojiRecognitionEnabled !== false;
                    }

                    // ğŸ”¥ã€é‡è¦ä¿®å¤ã€‘å¦‚æœæœ‰ä¿å­˜çš„APIè®¾ç½®ï¼Œè‡ªåŠ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨
                    if (settings.base && settings.key) {
                        console.log('ğŸ”§ [APIè®¾ç½®] æ£€æµ‹åˆ°å®Œæ•´çš„APIé…ç½®ï¼Œè‡ªåŠ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨');

                        // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿UIå·²ç»åŠ è½½å®Œæˆ
                        setTimeout(() => {
                            fetchModels().then(() => {
                                // æ‹‰å–å®Œæˆåï¼Œå¦‚æœæœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œé€‰ä¸­å®ƒ
                                if (settings.model) {
                                    const modelSelect = document.getElementById('model-select');
                                    if (modelSelect) {
                                        // å¦‚æœæ¨¡å‹ä¸åœ¨é€‰é¡¹ä¸­ï¼Œæ·»åŠ å®ƒ
                                        const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                        if (!existingOption) {
                                            const newOption = new Option(settings.model, settings.model);
                                            modelSelect.appendChild(newOption);
                                        }
                                        modelSelect.value = settings.model;
                                        console.log('ğŸ”§ [APIè®¾ç½®] å·²è‡ªåŠ¨é€‰ä¸­ä¿å­˜çš„æ¨¡å‹:', settings.model);
                                    }
                                }
                            }).catch(error => {
                                console.log('ğŸ”§ [APIè®¾ç½®] è‡ªåŠ¨æ‹‰å–æ¨¡å‹å¤±è´¥ï¼Œä½†ä¼šä¿ç•™å·²ä¿å­˜çš„æ¨¡å‹é€‰é¡¹');
                                // å³ä½¿æ‹‰å–å¤±è´¥ï¼Œä¹Ÿè¦æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰é¡¹
                                if (settings.model) {
                                    const modelSelect = document.getElementById('model-select');
                                    if (modelSelect) {
                                        const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                        if (!existingOption) {
                                            const newOption = new Option(settings.model, settings.model);
                                            modelSelect.appendChild(newOption);
                                        }
                                        modelSelect.value = settings.model;
                                        console.log('ğŸ”§ [APIè®¾ç½®] å·²æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰é¡¹:', settings.model);
                                    }
                                }
                            });
                        }, 500);
                    } else {
                        // æ²¡æœ‰å®Œæ•´çš„APIé…ç½®æ—¶ï¼Œä»ç„¶è¦æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰é¡¹
                        if (settings.model) {
                            const modelSelect = document.getElementById('model-select');
                            if (modelSelect) {
                                const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                if (!existingOption) {
                                    const newOption = new Option(settings.model, settings.model);
                                    modelSelect.appendChild(newOption);
                                }
                                modelSelect.value = settings.model;
                                console.log('ğŸ”§ [APIè®¾ç½®] å·²æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰é¡¹ï¼ˆæ— è‡ªåŠ¨æ‹‰å–ï¼‰:', settings.model);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½APIè®¾ç½®å¤±è´¥:', error);
            }
        }

        // ç”µæ± ç®¡ç†åŠŸèƒ½
        async function initBatteryManager() {
            // è®¾ç½®å›ºå®šçš„ç”µæ± ç”µé‡æ˜¾ç¤ºï¼ˆ75%ï¼‰
            setFixedBatteryDisplay();
        }

        function setFixedBatteryDisplay() {
            // è®¾ç½®å›ºå®šçš„ç”µæ± ç”µé‡ä¸º100%ï¼ˆæ»¡ç”µï¼‰
            const fixedLevel = 100;

            // æ›´æ–°ä¸»çŠ¶æ€æ ç”µæ± 
            const batteryContainer = document.getElementById('status-bar-battery');
            if (batteryContainer) {
                const batteryLevelEl = batteryContainer.querySelector('.battery-level');
                if (batteryLevelEl) {
                    batteryLevelEl.style.width = `${fixedLevel}%`;
                }
                // ç§»é™¤å……ç”µçŠ¶æ€
                batteryContainer.classList.remove('charging');
            }

            // æ›´æ–°åº”ç”¨å†…çŠ¶æ€æ ç”µæ± 
            const appBatteryContainers = document.querySelectorAll('.app-battery-container');
            const appBatteryLevels = document.querySelectorAll('.app-battery-level');

            // è®¾ç½®åº”ç”¨å†…ç”µæ± å›¾æ ‡ä¸ºå›ºå®šç”µé‡
            appBatteryLevels.forEach(element => {
                element.style.width = `${fixedLevel}%`;
            });

            // ç§»é™¤åº”ç”¨å†…ç”µæ± å……ç”µçŠ¶æ€
            appBatteryContainers.forEach(container => {
                container.classList.remove('charging');
            });
        }

        // æ‰‹åŠ¨æµ‹è¯•ç”µæ± æ˜¾ç¤ºåŠŸèƒ½ - æ‚¨å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°
        function testBatteryDisplay() {
            console.log('æµ‹è¯•å›ºå®šç”µæ± æ˜¾ç¤ºåŠŸèƒ½');
            setFixedBatteryDisplay();
            console.log('ç”µæ± æ˜¾ç¤ºå·²è®¾ç½®ä¸ºå›ºå®š100%ç”µé‡ï¼ˆæ»¡ç”µï¼‰');
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function changeTheme(themeName) {
            const body = document.body;

            // ğŸ”¥ã€ä¿®å¤ã€‘åˆ‡æ¢ä¸»é¢˜æ—¶æ¸…é™¤è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼
            clearCustomThemeStyles();
            clearGlobalCustomTheme();
            body.classList.remove('custom-theme-applied');

            // ç§»é™¤ä¹‹å‰çš„ä¸»é¢˜
            body.removeAttribute('data-theme');

            // åº”ç”¨æ–°ä¸»é¢˜
            if (themeName !== 'default') {
                body.setAttribute('data-theme', themeName);
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°Dexie
            try {
                await db.themeSettings.put({
                    id: 'selectedTheme',
                    settingName: 'selectedTheme',
                    settingValue: themeName,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('âŒ ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
            }

            // ç»™ç”¨æˆ·åé¦ˆ
            const themeNames = {
                'default': 'ç®€çº¦é£æ ¼',
                'cute': 'å¯çˆ±é£æ ¼',
                'dark': 'å¤œé—´æ¨¡å¼'
            };

            // æ˜¾ç¤ºToastæç¤º
            showToast(`å·²åˆ‡æ¢åˆ° ${themeNames[themeName]} ä¸»é¢˜ï¼`, 'success');
        }

        // ğŸ¨ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸»é¢˜åŠŸèƒ½
        let customThemeData = {
            chatTopBg: null,
            chatBottomBg: null,
            buttons: {
                back: null,
                offline: null,
                settings: null,
                expand: null,
                continue: null,
                send: null
            },
            globalTopAppBar: null,
            globalBottomAppBar: null,
            globalBackButton: null,
            globalAddButton: null,
            globalBg: null,
            scope: 'selected', // selected, all
            selectedChats: []
        };

        // ğŸ”¥ã€æ–°å¢ã€‘å›¾ç‰‡ä¸Šä¼ é€‰æ‹©ç›¸å…³å˜é‡
        let currentUploadType = null; // å½“å‰ä¸Šä¼ ç±»å‹
        let currentUploadCallback = null; // å½“å‰ä¸Šä¼ å›è°ƒå‡½æ•°

        let currentButtonType = null; // å½“å‰æ­£åœ¨ä¸Šä¼ çš„æŒ‰é’®ç±»å‹

        // åˆ‡æ¢è‡ªå®šä¹‰ä¸»é¢˜é€‰é¡¹å¡
        function switchCustomThemeTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.custom-theme-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // éšè—æ‰€æœ‰å†…å®¹é¢æ¿
            document.querySelectorAll('.custom-theme-content-pane').forEach(pane => {
                pane.style.display = 'none';
            });

            // æ¿€æ´»å½“å‰é€‰é¡¹å¡
            document.querySelector(`.custom-theme-tab[onclick="switchCustomThemeTab('${tabName}')"]`).classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”å†…å®¹é¢æ¿
            if (tabName === 'chat') {
                document.getElementById('chat-theme-content').style.display = 'block';
                loadChatSelectionList();
            } else if (tabName === 'global') {
                document.getElementById('global-theme-content').style.display = 'block';
            }
        }

        // ä¸Šä¼ èŠå¤©ç•Œé¢é¡¶éƒ¨èƒŒæ™¯
        function uploadChatTopBackground() {
            showImageUploadChoice('chat-top-bg', 'é€‰æ‹©èŠå¤©é¡¶éƒ¨èƒŒæ™¯æ¥æº');
        }

        // ä¸Šä¼ èŠå¤©ç•Œé¢åº•éƒ¨èƒŒæ™¯
        function uploadChatBottomBackground() {
            showImageUploadChoice('chat-bottom-bg', 'é€‰æ‹©èŠå¤©åº•éƒ¨èƒŒæ™¯æ¥æº');
        }

        // ä¸Šä¼ æŒ‰é’®å›¾æ ‡
        function uploadButtonIcon(buttonType) {
            currentButtonType = buttonType;
            const buttonNames = {
                back: 'è¿”å›æŒ‰é’®',
                offline: 'çº¿ä¸‹æ¨¡å¼æŒ‰é’®',
                settings: 'èŠå¤©è®¾ç½®æŒ‰é’®',
                expand: 'åŠŸèƒ½åŒºå±•å¼€æŒ‰é’®',
                continue: 'ç»­å†™æŒ‰é’®',
                send: 'å‘é€æ¶ˆæ¯æŒ‰é’®'
            };
            showImageUploadChoice(`button-${buttonType}`, `é€‰æ‹©${buttonNames[buttonType]}æ ·å¼æ¥æº`);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ é€‰æ‹©æ¨¡æ€æ¡†
        function showImageUploadChoice(uploadType, title, callback) {
            currentUploadType = uploadType;
            currentUploadCallback = callback;

            document.getElementById('image-upload-choice-title').textContent = title || 'é€‰æ‹©å›¾ç‰‡æ¥æº';
            showModal('image-upload-choice-modal');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€‰æ‹©æœ¬åœ°ä¸Šä¼ 
        function chooseLocalUpload() {
            hideModal('image-upload-choice-modal');

            // æ ¹æ®ä¸Šä¼ ç±»å‹è§¦å‘å¯¹åº”çš„æ–‡ä»¶é€‰æ‹©å™¨
            switch(currentUploadType) {
                case 'global-top-app-bar':
                    document.getElementById('global-top-app-bar-input').click();
                    break;
                case 'global-bottom-app-bar':
                    document.getElementById('global-bottom-app-bar-input').click();
                    break;
                case 'global-back-button':
                    document.getElementById('global-back-button-input').click();
                    break;
                case 'global-add-button':
                    document.getElementById('global-add-button-input').click();
                    break;
                case 'global-bg':
                    document.getElementById('global-bg-input').click();
                    break;
                case 'chat-top-bg':
                    document.getElementById('chat-top-bg-input').click();
                    break;
                case 'chat-bottom-bg':
                    document.getElementById('chat-bottom-bg-input').click();
                    break;
                case 'button-back':
                case 'button-offline':
                case 'button-settings':
                case 'button-expand':
                case 'button-continue':
                case 'button-send':
                    document.getElementById('button-icon-input').click();
                    break;
                default:
                    if (currentUploadCallback) {
                        currentUploadCallback('local');
                    }
                    break;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€‰æ‹©URLä¸Šä¼ 
        function chooseUrlUpload() {
            hideModal('image-upload-choice-modal');

            document.getElementById('image-url-input').value = '';
            document.getElementById('url-preview').style.display = 'none';
            document.getElementById('url-input-title').textContent = `è¾“å…¥${getUploadTypeTitle(currentUploadType)}URL`;
            showModal('url-input-modal');

            // ç›‘å¬URLè¾“å…¥å˜åŒ–
            const urlInput = document.getElementById('image-url-input');
            urlInput.oninput = function() {
                const url = this.value.trim();
                if (url && isValidImageUrl(url)) {
                    showUrlPreview(url);
                } else {
                    hideUrlPreview();
                }
            };
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–ä¸Šä¼ ç±»å‹æ ‡é¢˜
        function getUploadTypeTitle(uploadType) {
            const titles = {
                'global-top-app-bar': 'é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯',
                'global-bottom-app-bar': 'åº•éƒ¨åº”ç”¨æ èƒŒæ™¯',
                'global-back-button': 'è¿”å›æŒ‰é’®',
                'global-add-button': 'æ·»åŠ æŒ‰é’®',
                'global-bg': 'å…¨å±€èƒŒæ™¯',
                'chat-top-bg': 'èŠå¤©é¡¶éƒ¨èƒŒæ™¯',
                'chat-bottom-bg': 'èŠå¤©åº•éƒ¨èƒŒæ™¯',
                'button-back': 'è¿”å›æŒ‰é’®',
                'button-offline': 'çº¿ä¸‹æ¨¡å¼æŒ‰é’®',
                'button-settings': 'èŠå¤©è®¾ç½®æŒ‰é’®',
                'button-expand': 'åŠŸèƒ½åŒºå±•å¼€æŒ‰é’®',
                'button-continue': 'ç»­å†™æŒ‰é’®',
                'button-send': 'å‘é€æ¶ˆæ¯æŒ‰é’®'
            };
            return titles[uploadType] || 'å›¾ç‰‡';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éªŒè¯å›¾ç‰‡URL
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const supportedDomains = [
                    'i.postimg.cc',
                    'files.catbox.moe',
                    'i.ibb.co',
                    'i.imgur.com',
                    'cdn.discordapp.com',
                    'media.discordapp.net'
                ];

                // æ£€æŸ¥åŸŸåæ˜¯å¦åœ¨æ”¯æŒåˆ—è¡¨ä¸­ï¼Œæˆ–è€…URLä»¥å›¾ç‰‡æ‰©å±•åç»“å°¾
                const domain = urlObj.hostname;
                const pathname = urlObj.pathname.toLowerCase();
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];

                return supportedDomains.includes(domain) ||
                       imageExtensions.some(ext => pathname.endsWith(ext));
            } catch {
                return false;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºURLé¢„è§ˆ
        function showUrlPreview(url) {
            const preview = document.getElementById('url-preview');
            const img = document.getElementById('url-preview-img');

            img.onload = function() {
                preview.style.display = 'block';
            };

            img.onerror = function() {
                hideUrlPreview();
                showToast('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®', 'error');
            };

            img.src = url;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—URLé¢„è§ˆ
        function hideUrlPreview() {
            document.getElementById('url-preview').style.display = 'none';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç¡®è®¤URLä¸Šä¼ 
        function confirmUrlUpload() {
            const url = document.getElementById('image-url-input').value.trim();

            if (!url) {
                showToast('è¯·è¾“å…¥å›¾ç‰‡URL', 'warning');
                return;
            }

            if (!isValidImageUrl(url)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL', 'warning');
                return;
            }

            hideModal('url-input-modal');

            // å¤„ç†URLä¸Šä¼ 
            handleUrlUpload(url);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†URLä¸Šä¼ 
        function handleUrlUpload(url) {
            switch(currentUploadType) {
                case 'global-top-app-bar':
                    customThemeData.globalTopAppBar = url;
                    updatePreview('global-top-app-bar-preview', url);
                    updateThemeItemStatus('global-top-app-bar-item', true);
                    showToast('å…¨å±€é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯å·²è®¾ç½®', 'success');
                    break;
                case 'global-bottom-app-bar':
                    customThemeData.globalBottomAppBar = url;
                    updatePreview('global-bottom-app-bar-preview', url);
                    updateThemeItemStatus('global-bottom-app-bar-item', true);
                    showToast('å…¨å±€åº•éƒ¨åº”ç”¨æ èƒŒæ™¯å·²è®¾ç½®', 'success');
                    break;
                case 'global-back-button':
                    customThemeData.globalBackButton = url;
                    updatePreview('global-back-button-preview', url);
                    updateThemeItemStatus('global-back-button-item', true);
                    showToast('å…¨å±€è¿”å›æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'global-add-button':
                    customThemeData.globalAddButton = url;
                    updatePreview('global-add-button-preview', url);
                    updateThemeItemStatus('global-add-button-item', true);
                    showToast('å…¨å±€æ·»åŠ æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'global-bg':
                    customThemeData.globalBg = url;
                    updatePreview('global-bg-preview', url);
                    updateThemeItemStatus('global-bg-item', true);
                    showToast('å…¨å±€èƒŒæ™¯å·²è®¾ç½®', 'success');
                    break;
                case 'chat-top-bg':
                    customThemeData.chatTopBg = url;
                    updatePreview('chat-top-bg-preview', url);
                    updateThemeItemStatus('chat-top-bg-item', true);
                    showToast('èŠå¤©é¡¶éƒ¨èƒŒæ™¯å·²è®¾ç½®', 'success');
                    break;
                case 'chat-bottom-bg':
                    customThemeData.chatBottomBg = url;
                    updatePreview('chat-bottom-bg-preview', url);
                    updateThemeItemStatus('chat-bottom-bg-item', true);
                    showToast('èŠå¤©åº•éƒ¨èƒŒæ™¯å·²è®¾ç½®', 'success');
                    break;
                case 'button-back':
                    customThemeData.buttons.back = url;
                    updatePreview('back-btn-preview', url);
                    updateThemeItemStatus('back-btn-item', true);
                    showToast('è¿”å›æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'button-offline':
                    customThemeData.buttons.offline = url;
                    updatePreview('offline-btn-preview', url);
                    updateThemeItemStatus('offline-btn-item', true);
                    showToast('çº¿ä¸‹æ¨¡å¼æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'button-settings':
                    customThemeData.buttons.settings = url;
                    updatePreview('settings-btn-preview', url);
                    updateThemeItemStatus('settings-btn-item', true);
                    showToast('èŠå¤©è®¾ç½®æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'button-expand':
                    customThemeData.buttons.expand = url;
                    updatePreview('expand-btn-preview', url);
                    updateThemeItemStatus('expand-btn-item', true);
                    showToast('åŠŸèƒ½åŒºå±•å¼€æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'button-continue':
                    customThemeData.buttons.continue = url;
                    updatePreview('continue-btn-preview', url);
                    updateThemeItemStatus('continue-btn-item', true);
                    showToast('ç»­å†™æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                case 'button-send':
                    customThemeData.buttons.send = url;
                    updatePreview('send-btn-preview', url);
                    updateThemeItemStatus('send-btn-item', true);
                    showToast('å‘é€æ¶ˆæ¯æŒ‰é’®æ ·å¼å·²è®¾ç½®', 'success');
                    break;
                default:
                    if (currentUploadCallback) {
                        currentUploadCallback('url', url);
                    }
                    break;
            }
        }

        // ä¸Šä¼ å…¨å±€é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯
        function uploadGlobalTopAppBar() {
            showImageUploadChoice('global-top-app-bar', 'é€‰æ‹©é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯æ¥æº');
        }

        // ä¸Šä¼ å…¨å±€åº•éƒ¨åº”ç”¨æ èƒŒæ™¯
        function uploadGlobalBottomAppBar() {
            showImageUploadChoice('global-bottom-app-bar', 'é€‰æ‹©åº•éƒ¨åº”ç”¨æ èƒŒæ™¯æ¥æº');
        }

        // ä¸Šä¼ å…¨å±€è¿”å›æŒ‰é’®æ ·å¼
        function uploadGlobalBackButton() {
            showImageUploadChoice('global-back-button', 'é€‰æ‹©è¿”å›æŒ‰é’®æ ·å¼æ¥æº');
        }

        // ä¸Šä¼ å…¨å±€æ·»åŠ æŒ‰é’®æ ·å¼
        function uploadGlobalAddButton() {
            showImageUploadChoice('global-add-button', 'é€‰æ‹©æ·»åŠ æŒ‰é’®æ ·å¼æ¥æº');
        }

        // ä¸Šä¼ å…¨å±€èƒŒæ™¯
        function uploadGlobalBackground() {
            showImageUploadChoice('global-bg', 'é€‰æ‹©å…¨å±€èƒŒæ™¯æ¥æº');
        }

        // å¤„ç†èŠå¤©é¡¶éƒ¨èƒŒæ™¯ä¸Šä¼ 
        function handleChatTopBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.chatTopBg = e.target.result;
                    updatePreview('chat-top-bg-preview', e.target.result);
                    updateThemeItemStatus('chat-top-bg-item', true);
                    showToast('èŠå¤©é¡¶éƒ¨èƒŒæ™¯å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†èŠå¤©åº•éƒ¨èƒŒæ™¯ä¸Šä¼ 
        function handleChatBottomBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.chatBottomBg = e.target.result;
                    updatePreview('chat-bottom-bg-preview', e.target.result);
                    updateThemeItemStatus('chat-bottom-bg-item', true);
                    showToast('èŠå¤©åº•éƒ¨èƒŒæ™¯å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†æŒ‰é’®å›¾æ ‡ä¸Šä¼ 
        function handleButtonIconUpload(event) {
            const file = event.target.files[0];
            if (file && currentButtonType) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.buttons[currentButtonType] = e.target.result;
                    updatePreview(`${currentButtonType}-btn-preview`, e.target.result);
                    updateThemeItemStatus(`${currentButtonType}-btn-item`, true);

                    const buttonNames = {
                        back: 'è¿”å›æŒ‰é’®',
                        offline: 'çº¿ä¸‹æ¨¡å¼æŒ‰é’®',
                        settings: 'èŠå¤©è®¾ç½®æŒ‰é’®',
                        expand: 'åŠŸèƒ½åŒºå±•å¼€æŒ‰é’®',
                        continue: 'ç»­å†™æŒ‰é’®',
                        send: 'å‘é€æ¶ˆæ¯æŒ‰é’®'
                    };

                    showToast(`${buttonNames[currentButtonType]}å›¾æ ‡å·²ä¸Šä¼ `, 'success');
                    currentButtonType = null;
                };
                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°ä¸»é¢˜é¡¹çŠ¶æ€
        function updateThemeItemStatus(itemId, isConfigured) {
            const item = document.getElementById(itemId);
            if (!item) return;

            const statusIndicator = item.querySelector('.theme-item-status');
            if (isConfigured) {
                item.classList.add('theme-item-configured');
                if (statusIndicator) {
                    statusIndicator.style.display = 'flex';
                }
            } else {
                item.classList.remove('theme-item-configured');
                if (statusIndicator) {
                    statusIndicator.style.display = 'none';
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ‰€æœ‰ä¸»é¢˜é¡¹çŠ¶æ€ï¼ˆåº”ç”¨åè°ƒç”¨ï¼‰
        function clearAllThemeItemStatus() {
            const configuredItems = document.querySelectorAll('.theme-item-configured');
            configuredItems.forEach(item => {
                item.classList.remove('theme-item-configured');
                const statusIndicator = item.querySelector('.theme-item-status');
                if (statusIndicator) {
                    statusIndicator.style.display = 'none';
                }
            });
        }

        // å¤„ç†å…¨å±€é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯ä¸Šä¼ 
        function handleGlobalTopAppBarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.globalTopAppBar = e.target.result;
                    updatePreview('global-top-app-bar-preview', e.target.result);
                    updateThemeItemStatus('global-top-app-bar-item', true);

                    console.log('ğŸ¨ å…¨å±€é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯å·²ä¸Šä¼ :', e.target.result);
                    showToast('å…¨å±€é¡¶éƒ¨åº”ç”¨æ èƒŒæ™¯å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†å…¨å±€åº•éƒ¨åº”ç”¨æ èƒŒæ™¯ä¸Šä¼ 
        function handleGlobalBottomAppBarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.globalBottomAppBar = e.target.result;
                    updatePreview('global-bottom-app-bar-preview', e.target.result);
                    updateThemeItemStatus('global-bottom-app-bar-item', true);

                    showToast('å…¨å±€åº•éƒ¨åº”ç”¨æ èƒŒæ™¯å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†å…¨å±€è¿”å›æŒ‰é’®æ ·å¼ä¸Šä¼ 
        function handleGlobalBackButtonUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.globalBackButton = e.target.result;
                    updatePreview('global-back-button-preview', e.target.result);
                    updateThemeItemStatus('global-back-button-item', true);

                    showToast('å…¨å±€è¿”å›æŒ‰é’®æ ·å¼å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†å…¨å±€æ·»åŠ æŒ‰é’®æ ·å¼ä¸Šä¼ 
        function handleGlobalAddButtonUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.globalAddButton = e.target.result;
                    updatePreview('global-add-button-preview', e.target.result);
                    updateThemeItemStatus('global-add-button-item', true);

                    showToast('å…¨å±€æ·»åŠ æŒ‰é’®æ ·å¼å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // å¤„ç†å…¨å±€èƒŒæ™¯ä¸Šä¼ 
        function handleGlobalBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customThemeData.globalBg = e.target.result;
                    updatePreview('global-bg-preview', e.target.result);
                    updateThemeItemStatus('global-bg-item', true);

                    showToast('å…¨å±€åº”ç”¨èƒŒæ™¯å·²ä¸Šä¼ ', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å…¨å±€ä¸»é¢˜ç¼“å­˜
        function clearGlobalThemeCache() {
            globalThemeCache = null;
            globalThemeCacheTime = 0;
            console.log('ğŸ¨ å…¨å±€ä¸»é¢˜ç¼“å­˜å·²æ¸…é™¤');
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¿å­˜å¹¶åº”ç”¨å…¨å±€ä¸»é¢˜ - ä½¿ç”¨Dexie
        async function saveAndApplyGlobalTheme() {
            try {
                // æå–å…¨å±€æ ·å¼æ•°æ®
                const globalThemeData = {
                    globalTopAppBar: customThemeData.globalTopAppBar,
                    globalBottomAppBar: customThemeData.globalBottomAppBar,
                    globalBackButton: customThemeData.globalBackButton,
                    globalAddButton: customThemeData.globalAddButton,
                    globalBg: customThemeData.globalBg
                };

                // ä¿å­˜åˆ°Dexieæ•°æ®åº“
                await db.globalThemes.put({
                    id: 'global',
                    themeType: 'global',
                    themeData: globalThemeData,
                    timestamp: Date.now()
                });

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°æ•°æ®
                clearGlobalThemeCache();

                // ç«‹å³åº”ç”¨å…¨å±€æ ·å¼
                applyGlobalCustomTheme(globalThemeData);

                console.log('ğŸ¨ å…¨å±€ä¸»é¢˜å·²ä¿å­˜å¹¶åº”ç”¨åˆ°Dexieæ•°æ®åº“');
            } catch (error) {
                console.error('âŒ ä¿å­˜å…¨å±€ä¸»é¢˜å¤±è´¥:', error);
                showToast('ä¿å­˜å…¨å±€ä¸»é¢˜å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€ä¼˜åŒ–ã€‘å…¨å±€ä¸»é¢˜ç¼“å­˜ï¼Œé¿å…é‡å¤æ•°æ®åº“æŸ¥è¯¢
        let globalThemeCache = null;
        let globalThemeCacheTime = 0;
        const GLOBAL_THEME_CACHE_DURATION = 30000; // 30ç§’ç¼“å­˜

        // ğŸ”¥ã€æ–°å¢ã€‘å›¾ç‰‡é¢„åŠ è½½ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½å¯¼è‡´å¡é¡¿
        const imagePreloadCache = new Map();
        const MAX_IMAGE_CACHE_SIZE = 50; // æœ€å¤šç¼“å­˜50å¼ å›¾ç‰‡

        // ğŸ”¥ã€æ–°å¢ã€‘é¢„åŠ è½½å›¾ç‰‡å‡½æ•°
        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥ç¼“å­˜
                if (imagePreloadCache.has(url)) {
                    resolve(imagePreloadCache.get(url));
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    // æ·»åŠ åˆ°ç¼“å­˜
                    if (imagePreloadCache.size >= MAX_IMAGE_CACHE_SIZE) {
                        // åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                        const firstKey = imagePreloadCache.keys().next().value;
                        imagePreloadCache.delete(firstKey);
                    }
                    imagePreloadCache.set(url, img);
                    resolve(img);
                };
                img.onerror = () => {
                    console.warn('ğŸ–¼ï¸ å›¾ç‰‡é¢„åŠ è½½å¤±è´¥:', url);
                    reject(new Error(`Failed to load image: ${url}`));
                };
                img.src = url;
            });
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åº”ç”¨å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜ - ä½¿ç”¨Dexie + ç¼“å­˜ä¼˜åŒ–
        async function applyGlobalCustomTheme(globalThemeData = null) {
            const root = document.documentElement;

            // å¦‚æœæ²¡æœ‰ä¼ å…¥æ•°æ®ï¼Œä»ç¼“å­˜æˆ–Dexieæ•°æ®åº“åŠ è½½
            if (!globalThemeData) {
                const now = Date.now();

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘å…ˆæ£€æŸ¥ç¼“å­˜
                if (globalThemeCache && (now - globalThemeCacheTime) < GLOBAL_THEME_CACHE_DURATION) {
                    globalThemeData = globalThemeCache;
                    console.log('ğŸ¨ ä»ç¼“å­˜åŠ è½½å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜');
                } else {
                    // ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œä»æ•°æ®åº“åŠ è½½
                    try {
                        const savedGlobalTheme = await db.globalThemes.get('global');
                        if (savedGlobalTheme && savedGlobalTheme.themeData) {
                            globalThemeData = savedGlobalTheme.themeData;
                            // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ›´æ–°ç¼“å­˜
                            globalThemeCache = globalThemeData;
                            globalThemeCacheTime = now;
                            console.log('ğŸ¨ ä»DexieåŠ è½½ä¿å­˜çš„å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜å¹¶ç¼“å­˜');
                        } else {
                            console.log('ğŸ¨ æ²¡æœ‰ä¿å­˜çš„å…¨å±€ä¸»é¢˜');
                            return;
                        }
                    } catch (error) {
                        console.error('âŒ åŠ è½½å…¨å±€ä¸»é¢˜æ•°æ®å¤±è´¥:', error);
                        return;
                    }
                }
            }

            // æ¸…é™¤ä¹‹å‰çš„å…¨å±€æ ·å¼
            clearGlobalCustomTheme();

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡ï¼Œç„¶ååº”ç”¨å…¨å±€æ ·å¼
            const imagesToPreload = [];
            if (globalThemeData.globalTopAppBar) imagesToPreload.push(globalThemeData.globalTopAppBar);
            if (globalThemeData.globalBottomAppBar) imagesToPreload.push(globalThemeData.globalBottomAppBar);
            if (globalThemeData.globalBackButton) imagesToPreload.push(globalThemeData.globalBackButton);
            if (globalThemeData.globalAddButton) imagesToPreload.push(globalThemeData.globalAddButton);
            if (globalThemeData.globalBg) imagesToPreload.push(globalThemeData.globalBg);

            // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
            try {
                await Promise.all(imagesToPreload.map(url => preloadImage(url)));
                console.log('ğŸ¨ å…¨å±€ä¸»é¢˜å›¾ç‰‡é¢„åŠ è½½å®Œæˆ');
            } catch (error) {
                console.warn('ğŸ¨ éƒ¨åˆ†å…¨å±€ä¸»é¢˜å›¾ç‰‡é¢„åŠ è½½å¤±è´¥:', error);
            }

            // åº”ç”¨å…¨å±€æ ·å¼
            const appliedGlobalStyles = new Set();

            if (globalThemeData.globalTopAppBar) {
                root.style.setProperty('--custom-global-top-app-bar', `url(${globalThemeData.globalTopAppBar})`);
                appliedGlobalStyles.add('top-app-bar');
                console.log('ğŸ¨ è®¾ç½®CSSå˜é‡ --custom-global-top-app-bar:', `url(${globalThemeData.globalTopAppBar})`);
            }

            if (globalThemeData.globalBottomAppBar) {
                root.style.setProperty('--custom-global-bottom-app-bar', `url(${globalThemeData.globalBottomAppBar})`);
                appliedGlobalStyles.add('bottom-app-bar');
            }

            if (globalThemeData.globalBackButton) {
                root.style.setProperty('--custom-global-back-button', `url(${globalThemeData.globalBackButton})`);
                appliedGlobalStyles.add('back-button');
            }

            if (globalThemeData.globalAddButton) {
                root.style.setProperty('--custom-global-add-button', `url(${globalThemeData.globalAddButton})`);
                appliedGlobalStyles.add('add-button');
            }

            if (globalThemeData.globalBg) {
                root.style.setProperty('--custom-global-bg', `url(${globalThemeData.globalBg})`);
                appliedGlobalStyles.add('bg');
            }

            // ä¸ºbodyæ·»åŠ å…¨å±€æ ·å¼æ ‡è®°
            const globalStyleTypes = ['top-app-bar', 'bottom-app-bar', 'back-button', 'add-button', 'bg'];
            globalStyleTypes.forEach(styleType => {
                if (appliedGlobalStyles.has(styleType)) {
                    document.body.setAttribute(`data-has-custom-global-${styleType}`, 'true');
                } else {
                    document.body.removeAttribute(`data-has-custom-global-${styleType}`);
                }
            });

            // æ·»åŠ å…¨å±€ä¸»é¢˜åº”ç”¨æ ‡è®°
            document.body.classList.add('custom-theme-applied');

            console.log('ğŸ¨ å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼å·²åº”ç”¨');
            console.log('ğŸ¨ åº”ç”¨çš„å…¨å±€æ ·å¼:', appliedGlobalStyles);
            console.log('ğŸ¨ bodyç±»å:', document.body.className);
            console.log('ğŸ¨ bodyå±æ€§:', Array.from(document.body.attributes).map(attr => `${attr.name}="${attr.value}"`));
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜
        function clearGlobalCustomTheme() {
            console.log('ğŸ¨ å¼€å§‹æ¸…é™¤å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼...');

            const root = document.documentElement;
            const globalVariablesToClear = [
                '--custom-global-top-app-bar',
                '--custom-global-bottom-app-bar',
                '--custom-global-back-button',
                '--custom-global-add-button',
                '--custom-global-bg'
            ];

            globalVariablesToClear.forEach(variable => {
                root.style.removeProperty(variable);
            });

            // æ¸…é™¤å…¨å±€æ ·å¼æ ‡è®°
            const globalStyleTypes = ['top-app-bar', 'bottom-app-bar', 'back-button', 'add-button', 'bg'];
            globalStyleTypes.forEach(styleType => {
                document.body.removeAttribute(`data-has-custom-global-${styleType}`);
            });

            console.log('ğŸ¨ å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼æ¸…é™¤å®Œæˆ');
        }

        // æ›´æ–°é¢„è§ˆå›¾
        function updatePreview(previewId, imageUrl) {
            const preview = document.getElementById(previewId);
            if (preview) {
                preview.style.backgroundImage = `url(${imageUrl})`;
                preview.classList.add('has-image');
            }
        }

        // åŠ è½½èŠå¤©çª—å£é€‰æ‹©åˆ—è¡¨
        function loadChatSelectionList() {
            const container = document.getElementById('chat-selection-list');
            if (!container) return;

            // è·å–æ‰€æœ‰èŠå¤©å¯¹è±¡ï¼ˆåŒ…æ‹¬æ™®é€šè§’è‰²å’Œç¾¤èŠï¼‰
            const allChatObjects = [];

            // æ·»åŠ æ™®é€šè§’è‰²ï¼ˆä»contactsä¸­è·å–æ´»è·ƒçš„èŠå¤©ï¼‰
            if (characters && characters.length > 0 && contacts && contacts.length > 0) {
                characters.forEach(character => {
                    // åªæ·»åŠ åœ¨contactsä¸­çš„è§’è‰²ï¼ˆè¡¨ç¤ºæœ‰è¿‡èŠå¤©è®°å½•ï¼‰
                    if (contacts.includes(character.id)) {
                        allChatObjects.push({
                            id: character.id,
                            name: character.name,
                            avatarUrl: character.avatarUrl,
                            isGroup: false
                        });
                    }
                });
            }

            // æ·»åŠ ç¾¤èŠï¼ˆä»groupChatsæ•°ç»„è·å–ï¼‰
            if (groupChats && groupChats.length > 0) {
                groupChats.forEach(group => {
                    allChatObjects.push({
                        id: group.id,
                        name: group.name,
                        avatarUrl: group.avatarUrl,
                        isGroup: true
                    });
                });
            }

            console.log('ğŸ¨ åŠ è½½èŠå¤©çª—å£åˆ—è¡¨:');
            console.log('  - æ™®é€šè§’è‰²æ•°é‡:', characters?.length || 0);
            console.log('  - æ´»è·ƒè”ç³»äººæ•°é‡:', contacts?.length || 0);
            console.log('  - ç¾¤èŠæ•°é‡:', groupChats?.length || 0);
            console.log('  - æ€»èŠå¤©å¯¹è±¡:', allChatObjects);

            let html = '';
            allChatObjects.forEach(chatObj => {
                const isSelected = customThemeData.selectedChats.includes(chatObj.id);
                const avatarStyle = chatObj.avatarUrl ?
                    `background-image: url(${chatObj.avatarUrl})` : '';

                // ç¡®å®šå›¾æ ‡
                let iconClass = chatObj.isGroup ? 'fas fa-users' : 'fas fa-user';

                html += `
                    <div class="chat-selection-item ${isSelected ? 'selected' : ''}"
                         onclick="toggleChatSelection('${chatObj.id}')">
                        <div class="chat-selection-checkbox">
                            ${isSelected ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                        <div class="chat-selection-avatar" style="${avatarStyle}">
                            ${!chatObj.avatarUrl ? `<i class="${iconClass}"></i>` : ''}
                        </div>
                        <div class="chat-selection-info">
                            <div class="chat-selection-name">${chatObj.name}</div>
                            <div class="chat-selection-desc">${chatObj.isGroup ? 'ç¾¤èŠ' : 'ç§èŠ'}</div>
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— èŠå¤©çª—å£<br><small>è¯·å…ˆä¸è§’è‰²èŠå¤©æˆ–åˆ›å»ºç¾¤èŠ</small></div>';
            }

            container.innerHTML = html;
        }

        // åˆ‡æ¢èŠå¤©çª—å£é€‰æ‹©çŠ¶æ€
        function toggleChatSelection(chatId) {
            const index = customThemeData.selectedChats.indexOf(chatId);
            if (index > -1) {
                customThemeData.selectedChats.splice(index, 1);
            } else {
                customThemeData.selectedChats.push(chatId);
            }
            loadChatSelectionList();
        }

        // å¤„ç†åº”ç”¨èŒƒå›´é€‰æ‹©
        document.addEventListener('DOMContentLoaded', function() {
            // åº”ç”¨èŒƒå›´é€‰æ‹©äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.closest('.theme-scope-option')) {
                    const option = e.target.closest('.theme-scope-option');
                    const scope = option.dataset.scope;

                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    document.querySelectorAll('.theme-scope-option').forEach(opt => {
                        opt.classList.remove('active');
                    });

                    // æ¿€æ´»å½“å‰é€‰é¡¹
                    option.classList.add('active');
                    customThemeData.scope = scope;

                    // æ˜¾ç¤º/éšè—èŠå¤©é€‰æ‹©åˆ—è¡¨
                    const selectionList = document.getElementById('chat-selection-list');
                    if (selectionList) {
                        if (scope === 'selected') {
                            selectionList.style.display = 'block';
                            loadChatSelectionList();
                        } else {
                            selectionList.style.display = 'none';
                        }
                    }
                }
            });
        });





        // ğŸ”¥ã€ä¿®æ”¹ã€‘é‡ç½®è‡ªå®šä¹‰ä¸»é¢˜ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function resetCustomTheme() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                // 1. æ¸…é™¤å·²åº”ç”¨çš„æ ·å¼
                clearCustomThemeStyles();
                clearGlobalCustomTheme(); // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å…¨å±€ä¸»é¢˜
                clearGlobalThemeCache(); // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ¸…é™¤å…¨å±€ä¸»é¢˜ç¼“å­˜
                document.body.classList.remove('custom-theme-applied');

                // ğŸ”¥ã€ä¿®æ”¹ã€‘2. æ¸…é™¤Dexieæ•°æ®åº“ä¸­çš„æ•°æ®
                try {
                    await db.globalThemes.clear();
                    await db.chatThemes.clear();
                    await db.themeSettings.clear();
                    console.log('ğŸ§¹ å·²æ¸…é™¤Dexieæ•°æ®åº“ä¸­çš„ä¸»é¢˜æ•°æ®');
                } catch (error) {
                    console.error('âŒ æ¸…é™¤ä¸»é¢˜æ•°æ®å¤±è´¥:', error);
                }

                // 3. é‡ç½®å†…å­˜ä¸­çš„æ•°æ®
                customThemeData = {
                    chatTopBg: null,
                    chatBottomBg: null,
                    buttons: {
                        back: null,
                        offline: null,
                        settings: null,
                        expand: null,
                        continue: null,
                        send: null
                    },
                    globalTopAppBar: null,
                    globalBottomAppBar: null,
                    globalBackButton: null,
                    globalAddButton: null,
                    globalBg: null,
                    scope: 'selected',
                    selectedChats: []
                };

                // 4. é‡ç½®ç•Œé¢é¢„è§ˆå›¾
                document.querySelectorAll('.theme-item-preview').forEach(preview => {
                    preview.style.backgroundImage = 'none';
                    preview.classList.remove('has-image');
                });

                // 5. é‡ç½®åº”ç”¨èŒƒå›´é€‰æ‹©
                document.querySelectorAll('.theme-scope-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                const defaultScope = document.querySelector('.theme-scope-option[data-scope="selected"]');
                if (defaultScope) {
                    defaultScope.classList.add('active');
                }

                // 6. æ˜¾ç¤ºèŠå¤©é€‰æ‹©åˆ—è¡¨ï¼ˆå› ä¸ºé»˜è®¤æ˜¯selectedæ¨¡å¼ï¼‰
                const selectionList = document.getElementById('chat-selection-list');
                if (selectionList) {
                    selectionList.style.display = 'block';
                    loadChatSelectionList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                }

                console.log('ğŸ¨ è‡ªå®šä¹‰ä¸»é¢˜å·²å®Œå…¨é‡ç½®');
                showToast('è‡ªå®šä¹‰ä¸»é¢˜å·²é‡ç½®', 'success');
            }
        }

        // é¢„è§ˆè‡ªå®šä¹‰ä¸»é¢˜
        function previewCustomTheme() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰å†…å®¹
            const hasCustomContent = customThemeData.chatTopBg ||
                                    customThemeData.chatBottomBg ||
                                    Object.values(customThemeData.buttons).some(btn => btn) ||
                                    customThemeData.globalTopAppBar ||
                                    customThemeData.globalBottomAppBar ||
                                    customThemeData.globalBackButton ||
                                    customThemeData.globalAddButton ||
                                    customThemeData.globalBg;

            if (!hasCustomContent) {
                showToast('è¯·å…ˆä¸Šä¼ è‡ªå®šä¹‰å†…å®¹', 'warning');
                return;
            }

            // ä¿å­˜å½“å‰ä¸»é¢˜çŠ¶æ€
            const currentThemeState = {
                hasCustomTheme: document.body.classList.contains('custom-theme-applied'),
                cssVariables: {}
            };

            // ä¿å­˜å½“å‰CSSå˜é‡
            const root = document.documentElement;
            const variablesToSave = [
                '--custom-chat-top-bg',
                '--custom-chat-bottom-bg',
                '--custom-back-btn',
                '--custom-offline-btn',
                '--custom-settings-btn',
                '--custom-expand-btn',
                '--custom-continue-btn',
                '--custom-send-btn',
                '--custom-global-top-app-bar',
                '--custom-global-bottom-app-bar',
                '--custom-global-back-button',
                '--custom-global-add-button',
                '--custom-global-bg'
            ];

            variablesToSave.forEach(variable => {
                currentThemeState.cssVariables[variable] = root.style.getPropertyValue(variable);
            });

            // ä¸´æ—¶åº”ç”¨é¢„è§ˆä¸»é¢˜
            const previewThemeData = {
                chatTopBg: customThemeData.chatTopBg,
                chatBottomBg: customThemeData.chatBottomBg,
                buttons: { ...customThemeData.buttons },
                globalTopAppBar: customThemeData.globalTopAppBar,
                globalBottomAppBar: customThemeData.globalBottomAppBar,
                globalBackButton: customThemeData.globalBackButton,
                globalAddButton: customThemeData.globalAddButton,
                globalBg: customThemeData.globalBg
            };
            applyCustomThemeStyles(previewThemeData).catch(e => console.error('é¢„è§ˆä¸»é¢˜å¤±è´¥:', e));

            // æ˜¾ç¤ºé¢„è§ˆæç¤ºå’Œæ“ä½œæŒ‰é’®
            showPreviewModal(currentThemeState);
        }

        // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        function showPreviewModal(currentThemeState) {
            const modal = document.createElement('div');
            modal.className = 'modal phone-modal';
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            modal.id = 'theme-preview-modal';

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ğŸ¨ ä¸»é¢˜é¢„è§ˆ</h3>
                    </div>
                    <div class="modal-body">
                        <div class="preview-info">
                            <div class="preview-tip">
                                <i class="fas fa-eye"></i>
                                <span>æ­£åœ¨é¢„è§ˆè‡ªå®šä¹‰ä¸»é¢˜æ•ˆæœ</span>
                            </div>
                            <div class="preview-desc">
                                æ‚¨å¯ä»¥åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢æŸ¥çœ‹å®é™…æ•ˆæœï¼Œé¢„è§ˆä¸ä¼šä¿å­˜è®¾ç½®ã€‚
                            </div>
                        </div>

                        <div class="preview-actions">
                            <button class="preview-action-btn goto-chat-btn" onclick="gotoChat()">
                                <i class="fas fa-comment"></i>
                                <span>æŸ¥çœ‹èŠå¤©æ•ˆæœ</span>
                            </button>
                            <button class="preview-action-btn goto-home-btn" onclick="gotoHome()">
                                <i class="fas fa-home"></i>
                                <span>æŸ¥çœ‹å…¨å±€æ•ˆæœ</span>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-button modal-secondary" onclick="cancelPreview()">å–æ¶ˆé¢„è§ˆ</button>
                        <button class="modal-button modal-primary" onclick="confirmPreview().catch(e => console.error('åº”ç”¨ä¸»é¢˜å¤±è´¥:', e))">åº”ç”¨ä¸»é¢˜</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å…¨å±€å˜é‡
            window.previewState = currentThemeState;

            showToast('ğŸ¨ é¢„è§ˆæ¨¡å¼å·²å¼€å¯', 'info');
        }

        // å–æ¶ˆé¢„è§ˆ
        function cancelPreview() {
            const modal = document.getElementById('theme-preview-modal');
            if (modal) {
                modal.remove();
            }

            // æ¢å¤åŸå§‹ä¸»é¢˜çŠ¶æ€
            if (window.previewState) {
                const root = document.documentElement;

                // æ¢å¤CSSå˜é‡
                Object.keys(window.previewState.cssVariables).forEach(variable => {
                    const value = window.previewState.cssVariables[variable];
                    if (value) {
                        root.style.setProperty(variable, value);
                    } else {
                        root.style.removeProperty(variable);
                    }
                });

                // æ¢å¤ä¸»é¢˜ç±»
                if (window.previewState.hasCustomTheme) {
                    document.body.classList.add('custom-theme-applied');
                } else {
                    document.body.classList.remove('custom-theme-applied');
                }

                window.previewState = null;
            }

            showToast('é¢„è§ˆå·²å–æ¶ˆ', 'info');
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¡®è®¤é¢„è§ˆå¹¶åº”ç”¨ä¸»é¢˜ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function confirmPreview() {
            const modal = document.getElementById('theme-preview-modal');
            if (modal) {
                modal.remove();
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç›´æ¥åº”ç”¨ä¸»é¢˜ï¼ˆè·³è¿‡é‡å¤çš„æ ·å¼åº”ç”¨ï¼‰
            await applyCustomTheme();

            window.previewState = null;
        }

        // é¢„è§ˆæ—¶è·³è½¬åˆ°èŠå¤©ç•Œé¢
        function gotoChat() {
            try {
                // å¦‚æœæœ‰æ´»è·ƒçš„èŠå¤©ï¼Œç›´æ¥è·³è½¬
                if (currentChatCharacter) {
                    showApp('api-chat-screen');
                } else {
                    // å¦åˆ™è·³è½¬åˆ°æ¶ˆæ¯åˆ—è¡¨é€‰æ‹©èŠå¤©
                    showApp('chat-screen');
                    // ç¡®ä¿switchChatTabå‡½æ•°å­˜åœ¨
                    if (typeof switchChatTab === 'function') {
                        switchChatTab('message-list');
                    }
                }

                // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
                const modal = document.getElementById('theme-preview-modal');
                if (modal) {
                    modal.remove();
                }
            } catch (error) {
                console.error('è·³è½¬åˆ°èŠå¤©ç•Œé¢å¤±è´¥:', error);
                showToast('è·³è½¬å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢', 'warning');
            }
        }

        // é¢„è§ˆæ—¶è·³è½¬åˆ°ä¸»ç•Œé¢
        function gotoHome() {
            try {
                // å…³é—­æ‰€æœ‰åº”ç”¨ï¼Œå›åˆ°ä¸»å±å¹•
                const allApps = document.querySelectorAll('.app-screen');
                allApps.forEach(app => {
                    app.style.display = 'none';
                });

                // æ˜¾ç¤ºä¸»å±å¹•å…ƒç´ 
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                const dockBar = document.getElementById('dock-bar');
                const mainStatusBar = document.getElementById('status-bar');

                if (clockContainer) clockContainer.style.display = 'block';
                if (homeGrid) homeGrid.style.display = 'grid';
                if (dockBar) dockBar.style.display = 'block';
                if (mainStatusBar) mainStatusBar.style.display = 'flex';

                // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
                const modal = document.getElementById('theme-preview-modal');
                if (modal) {
                    modal.remove();
                }
            } catch (error) {
                console.error('è·³è½¬åˆ°ä¸»ç•Œé¢å¤±è´¥:', error);
                showToast('è·³è½¬å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°ä¸»ç•Œé¢', 'warning');
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åº”ç”¨è‡ªå®šä¹‰ä¸»é¢˜ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function applyCustomTheme() {
            // ğŸ”¥ã€ä¿®å¤ã€‘åˆ†åˆ«æ£€æŸ¥èŠå¤©å†…å®¹å’Œå…¨å±€å†…å®¹
            const hasChatContent = customThemeData.chatTopBg ||
                                 customThemeData.chatBottomBg ||
                                 Object.values(customThemeData.buttons).some(btn => btn);

            const hasGlobalContent = customThemeData.globalTopAppBar ||
                                   customThemeData.globalBottomAppBar ||
                                   customThemeData.globalBackButton ||
                                   customThemeData.globalAddButton ||
                                   customThemeData.globalBg;

            if (!hasChatContent && !hasGlobalContent) {
                showToast('è¯·å…ˆä¸Šä¼ è‡ªå®šä¹‰å†…å®¹', 'warning');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘å¤„ç†å…¨å±€æ ·å¼ - ç›´æ¥åº”ç”¨ï¼Œä¸éœ€è¦é€‰æ‹©èŠå¤©çª—å£
            if (hasGlobalContent) {
                await saveAndApplyGlobalTheme();
                console.log('ğŸ¨ å…¨å±€ä¸»é¢˜å·²åº”ç”¨åˆ°æ‰€æœ‰åº”ç”¨é¡µé¢');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†èŠå¤©å†…å®¹ - åªæœ‰åœ¨æœ‰èŠå¤©å†…å®¹æ—¶æ‰éœ€è¦é€‰æ‹©èŠå¤©çª—å£
            if (hasChatContent) {
                // æ ¹æ®åº”ç”¨èŒƒå›´å¤„ç†
                let targetChats = [];
                if (customThemeData.scope === 'selected') {
                    if (customThemeData.selectedChats.length === 0) {
                        showToast('è¯·é€‰æ‹©è¦åº”ç”¨çš„èŠå¤©çª—å£', 'warning');
                        return;
                    }
                    targetChats = customThemeData.selectedChats;
            } else if (customThemeData.scope === 'all') {
                // è·å–æ‰€æœ‰èŠå¤©å¯¹è±¡IDï¼ˆåŒ…æ‹¬ç¾¤èŠï¼‰
                const allChatIds = [];

                // æ·»åŠ æ´»è·ƒçš„æ™®é€šè§’è‰²èŠå¤©
                if (characters && contacts) {
                    characters.forEach(character => {
                        if (contacts.includes(character.id)) {
                            allChatIds.push(character.id);
                        }
                    });
                }

                // æ·»åŠ æ‰€æœ‰ç¾¤èŠ
                if (groupChats) {
                    groupChats.forEach(group => {
                        allChatIds.push(group.id);
                    });
                }

                targetChats = allChatIds;
            }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ¯ä¸ªç›®æ ‡èŠå¤©çª—å£ä¿å­˜èŠå¤©ä¸»é¢˜æ•°æ®ï¼ˆä¸åŒ…å«å…¨å±€æ ·å¼ï¼‰
                const chatThemeDataToSave = {
                    chatTopBg: customThemeData.chatTopBg,
                    chatBottomBg: customThemeData.chatBottomBg,
                    buttons: { ...customThemeData.buttons }
                };

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸ºæ¯ä¸ªç›®æ ‡èŠå¤©çª—å£ä¿å­˜ä¸»é¢˜æ•°æ®åˆ°Dexie
                for (const chatId of targetChats) {
                    try {
                        await db.chatThemes.put({
                            chatId: chatId,
                            themeData: chatThemeDataToSave,
                            timestamp: Date.now()
                        });
                        console.log(`ğŸ¨ ä¸ºèŠå¤©çª—å£ ${chatId} ä¿å­˜èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜åˆ°Dexie`);
                    } catch (error) {
                        console.error(`âŒ ä¿å­˜èŠå¤©ä¸»é¢˜å¤±è´¥ (${chatId}):`, error);
                    }
                }

                // æ£€æŸ¥å½“å‰èŠå¤©çª—å£æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯åˆ™ç«‹å³åº”ç”¨èŠå¤©ä¸»é¢˜
                if (currentChatCharacter && targetChats.includes(currentChatCharacter.id)) {
                    applyCustomThemeStyles(chatThemeDataToSave).catch(e => console.error('åº”ç”¨èŠå¤©ä¸»é¢˜å¤±è´¥:', e));
                    console.log(`ğŸ¨ å½“å‰èŠå¤©çª—å£ ${currentChatCharacter.id} åœ¨ç›®æ ‡èŒƒå›´å†…ï¼Œç«‹å³åº”ç”¨èŠå¤©ä¸»é¢˜`);
                }

                showToast(`èŠå¤©ä¸»é¢˜å·²åº”ç”¨åˆ° ${targetChats.length} ä¸ªèŠå¤©çª—å£`, 'success');
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘è®¾ç½®è‡ªå®šä¹‰ä¸»é¢˜æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰ä¸»é¢˜ - ä½¿ç”¨Dexie
            try {
                await db.themeSettings.put({
                    id: 'selectedTheme',
                    settingName: 'selectedTheme',
                    settingValue: 'custom',
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('âŒ ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®åº”ç”¨çš„å†…å®¹æ˜¾ç¤ºä¸åŒçš„æç¤º
            if (hasGlobalContent && !hasChatContent) {
                showToast('å…¨å±€ä¸»é¢˜å·²åº”ç”¨åˆ°æ‰€æœ‰åº”ç”¨é¡µé¢', 'success');
            } else if (hasGlobalContent && hasChatContent) {
                showToast('å…¨å±€ä¸»é¢˜å’ŒèŠå¤©ä¸»é¢˜å·²åº”ç”¨', 'success');
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ‰€æœ‰å·²è®¾ç½®é¡¹çš„çŠ¶æ€æŒ‡ç¤ºå™¨
            clearAllThemeItemStatus();

            // è¿”å›ä¸»é¢˜è®¾ç½®é¡µé¢
            setTimeout(() => {
                backToSettings('custom-theme-screen');
            }, 1500);
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åº”ç”¨èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function applyCustomThemeStyles(themeData = null) {
            const root = document.documentElement;

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…é™¤ä¹‹å‰çš„èŠå¤©è‡ªå®šä¹‰æ ·å¼ï¼ˆä¸å½±å“å…¨å±€æ ·å¼ï¼‰
            clearCustomThemeStyles();

            // ğŸ”¥ã€ä¿®æ”¹ã€‘å¦‚æœæ²¡æœ‰ä¼ å…¥ä¸»é¢˜æ•°æ®ï¼Œå°è¯•ä»å½“å‰èŠå¤©çª—å£åŠ è½½ - ä½¿ç”¨Dexie
            if (!themeData && currentChatCharacter) {
                try {
                    const savedTheme = await db.chatThemes.where('chatId').equals(currentChatCharacter.id).first();
                    if (savedTheme && savedTheme.themeData) {
                        themeData = savedTheme.themeData;
                        console.log(`ğŸ¨ ä¸ºèŠå¤©çª—å£ ${currentChatCharacter.id} ä»DexieåŠ è½½è‡ªå®šä¹‰ä¸»é¢˜`);
                    } else {
                        console.log(`ğŸ¨ èŠå¤©çª—å£ ${currentChatCharacter.id} æ²¡æœ‰è‡ªå®šä¹‰ä¸»é¢˜`);
                        return;
                    }
                } catch (error) {
                    console.error('âŒ åŠ è½½èŠå¤©ä¸»é¢˜æ•°æ®å¤±è´¥:', error);
                    return;
                }
            }

            // å¦‚æœä»ç„¶æ²¡æœ‰ä¸»é¢˜æ•°æ®ï¼Œé€€å‡º
            if (!themeData) {
                console.log('ğŸ¨ æ²¡æœ‰ä¸»é¢˜æ•°æ®å¯åº”ç”¨');
                return;
            }

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘é¢„åŠ è½½èŠå¤©ä¸»é¢˜å›¾ç‰‡
            const chatImagesToPreload = [];
            if (themeData.chatTopBg) chatImagesToPreload.push(themeData.chatTopBg);
            if (themeData.chatBottomBg) chatImagesToPreload.push(themeData.chatBottomBg);
            if (themeData.buttons) {
                Object.values(themeData.buttons).forEach(buttonImage => {
                    if (buttonImage && buttonImage.trim() !== '') {
                        chatImagesToPreload.push(buttonImage);
                    }
                });
            }

            // é¢„åŠ è½½èŠå¤©ä¸»é¢˜å›¾ç‰‡
            try {
                await Promise.all(chatImagesToPreload.map(url => preloadImage(url)));
                console.log('ğŸ¨ èŠå¤©ä¸»é¢˜å›¾ç‰‡é¢„åŠ è½½å®Œæˆ');
            } catch (error) {
                console.warn('ğŸ¨ éƒ¨åˆ†èŠå¤©ä¸»é¢˜å›¾ç‰‡é¢„åŠ è½½å¤±è´¥:', error);
            }

            // åº”ç”¨èŠå¤©ç•Œé¢æ ·å¼
            if (themeData.chatTopBg) {
                root.style.setProperty('--custom-chat-top-bg', `url(${themeData.chatTopBg})`);
                document.body.setAttribute('data-has-chat-top-bg', 'true');
                console.log('ğŸ¨ è®¾ç½®é¡¶éƒ¨èƒŒæ™¯:', themeData.chatTopBg);
            }

            if (themeData.chatBottomBg) {
                root.style.setProperty('--custom-chat-bottom-bg', `url(${themeData.chatBottomBg})`);
                document.body.setAttribute('data-has-chat-bottom-bg', 'true');
                console.log('ğŸ¨ è®¾ç½®åº•éƒ¨èƒŒæ™¯:', themeData.chatBottomBg);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘åº”ç”¨æŒ‰é’®æ ·å¼ - åªå¤„ç†æœ‰å›¾ç‰‡çš„æŒ‰é’®ï¼Œå¹¶æ·»åŠ æ ‡è®°
            const appliedButtons = new Set();
            if (themeData.buttons) {
                Object.keys(themeData.buttons).forEach(buttonType => {
                    const buttonImage = themeData.buttons[buttonType];
                    if (buttonImage && buttonImage.trim() !== '') {
                        root.style.setProperty(`--custom-${buttonType}-btn`, `url(${buttonImage})`);
                        // ä¸ºç‰¹å®šæŒ‰é’®æ·»åŠ è‡ªå®šä¹‰æ ·å¼ç±»
                        applyButtonCustomStyle(buttonType, buttonImage);
                        // æ·»åŠ åˆ°å·²åº”ç”¨åˆ—è¡¨
                        appliedButtons.add(buttonType);
                        console.log(`ğŸ¨ åº”ç”¨æŒ‰é’®æ ·å¼: ${buttonType} -> ${buttonImage}`);
                    }
                });
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºbodyæ·»åŠ å…·ä½“çš„æŒ‰é’®æ ·å¼æ ‡è®°ï¼Œç”¨äºCSSé€‰æ‹©å™¨
            const buttonTypes = ['back', 'offline', 'settings', 'expand', 'continue', 'send'];
            buttonTypes.forEach(buttonType => {
                if (appliedButtons.has(buttonType)) {
                    document.body.setAttribute(`data-has-custom-${buttonType}-btn`, 'true');
                } else {
                    document.body.removeAttribute(`data-has-custom-${buttonType}-btn`);
                }
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘å…¨å±€æ ·å¼å¤„ç†å·²ç§»åŠ¨åˆ° applyGlobalCustomTheme å‡½æ•°

            // æ·»åŠ èŠå¤©ä¸»é¢˜åº”ç”¨æ ‡è®°
            document.body.classList.add('custom-theme-applied');

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸åœ¨èŠå¤©ä¸»é¢˜åº”ç”¨æ—¶é‡å¤åº”ç”¨å…¨å±€ä¸»é¢˜ï¼Œé¿å…å¡é¡¿å’Œå†²çª
            // å…¨å±€ä¸»é¢˜åº”è¯¥åªåœ¨é¡µé¢åŠ è½½æ—¶å’Œä¸»é¢˜åˆ‡æ¢æ—¶åº”ç”¨
            console.log('ğŸ¨ èŠå¤©ä¸»é¢˜åº”ç”¨å®Œæˆï¼Œè·³è¿‡å…¨å±€ä¸»é¢˜é‡å¤åº”ç”¨ä»¥é¿å…å†²çª');

            console.log('ğŸ¨ èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼å·²åº”ç”¨');
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…é™¤èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼ï¼ˆä¸æ¸…é™¤å…¨å±€æ ·å¼ï¼‰
        function clearCustomThemeStyles() {
            console.log('ğŸ¨ å¼€å§‹æ¸…é™¤èŠå¤©è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼...');

            const root = document.documentElement;
            const variablesToClear = [
                '--custom-chat-top-bg',
                '--custom-chat-bottom-bg',
                '--custom-back-btn',
                '--custom-offline-btn',
                '--custom-settings-btn',
                '--custom-expand-btn',
                '--custom-continue-btn',
                '--custom-send-btn'
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸å†æ¸…é™¤å…¨å±€æ ·å¼å˜é‡
            ];

            // æ¸…é™¤CSSå˜é‡
            variablesToClear.forEach(variable => {
                root.style.removeProperty(variable);
                console.log(`æ¸…é™¤CSSå˜é‡: ${variable}`);
            });

            // æ¸…é™¤dataå±æ€§
            document.body.removeAttribute('data-has-chat-top-bg');
            document.body.removeAttribute('data-has-chat-bottom-bg');

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…é™¤èŠå¤©æŒ‰é’®æ ·å¼æ ‡è®°
            const buttonTypes = ['back', 'offline', 'settings', 'expand', 'continue', 'send'];
            buttonTypes.forEach(buttonType => {
                document.body.removeAttribute(`data-has-custom-${buttonType}-btn`);
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¸å†æ¸…é™¤å…¨å±€æ ·å¼æ ‡è®°ï¼Œä¿æŒå…¨å±€ä¸»é¢˜ç”Ÿæ•ˆ

            // æ¸…é™¤æŒ‰é’®çš„å†…è”æ ·å¼
            clearButtonCustomStyles();

            // æ¸…é™¤èƒŒæ™¯æ ·å¼
            clearBackgroundCustomStyles();

            console.log('ğŸ¨ è‡ªå®šä¹‰ä¸»é¢˜æ ·å¼æ¸…é™¤å®Œæˆ');
        }

        // ä¸ºç‰¹å®šæŒ‰é’®åº”ç”¨è‡ªå®šä¹‰æ ·å¼
        function applyButtonCustomStyle(buttonType, imageUrl) {
            let selector = '';

            switch (buttonType) {
                case 'back':
                    selector = '.back-btn';
                    break;
                case 'offline':
                    selector = '#offline-mode-icon';
                    break;
                case 'settings':
                    selector = '.header-actions .action-btn:last-child';
                    break;
                case 'expand':
                    selector = '.toggle-tools-btn';
                    break;
                case 'continue':
                    selector = '.chat-action-btn[onclick*="triggerSmartReply"]';
                    break;
                case 'send':
                    selector = '.send-button';
                    break;
            }

            if (selector) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    // å®Œå…¨ç”¨å›¾ç‰‡æ›¿ä»£æŒ‰é’® - ä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§
                    element.style.setProperty('background-image', `url(${imageUrl})`, 'important');
                    element.style.setProperty('background-size', 'cover', 'important');
                    element.style.setProperty('background-position', 'center', 'important');
                    element.style.setProperty('background-repeat', 'no-repeat', 'important');
                    element.style.setProperty('color', 'transparent', 'important'); // éšè—æ–‡å­—
                    element.style.setProperty('text-shadow', 'none', 'important'); // ç§»é™¤æ–‡å­—é˜´å½±
                    element.style.setProperty('border', 'none', 'important'); // ç§»é™¤è¾¹æ¡†
                    element.style.setProperty('box-shadow', 'none', 'important'); // ç§»é™¤é˜´å½±
                    element.style.setProperty('background-color', 'transparent', 'important'); // ç§»é™¤èƒŒæ™¯è‰²
                    element.classList.add('custom-button-styled');

                    // éšè—æŒ‰é’®å†…çš„å›¾æ ‡å’Œæ–‡å­—
                    const icons = element.querySelectorAll('i, span, .icon');
                    icons.forEach(icon => {
                        icon.style.setProperty('opacity', '0', 'important');
                    });
                });
            }
        }

        // æ¸…é™¤æŒ‰é’®çš„è‡ªå®šä¹‰æ ·å¼
        function clearButtonCustomStyles() {
            console.log('ğŸ¨ æ¸…é™¤æŒ‰é’®è‡ªå®šä¹‰æ ·å¼...');

            // æ¸…é™¤æ‰€æœ‰æ ‡è®°ä¸ºè‡ªå®šä¹‰æ ·å¼çš„æŒ‰é’®
            const customButtons = document.querySelectorAll('.custom-button-styled');
            customButtons.forEach(button => {
                // ä½¿ç”¨removePropertyæ¢å¤é»˜è®¤æ ·å¼
                button.style.removeProperty('background-image');
                button.style.removeProperty('background-size');
                button.style.removeProperty('background-position');
                button.style.removeProperty('background-repeat');
                button.style.removeProperty('color');
                button.style.removeProperty('text-shadow');
                button.style.removeProperty('border');
                button.style.removeProperty('box-shadow');
                button.style.removeProperty('background-color');
                button.classList.remove('custom-button-styled');

                // æ¢å¤æŒ‰é’®å†…çš„å›¾æ ‡å’Œæ–‡å­—æ˜¾ç¤º
                const icons = button.querySelectorAll('i, span, .icon');
                icons.forEach(icon => {
                    icon.style.removeProperty('opacity');
                });

                console.log('æ¸…é™¤æŒ‰é’®æ ·å¼:', button.className);
            });

            // é¢å¤–æ¸…é™¤å¯èƒ½çš„æŒ‰é’®æ ·å¼ï¼ˆé˜²æ­¢é—æ¼ï¼‰
            const buttonSelectors = [
                '.back-btn',
                '#offline-mode-icon',
                '.header-actions .action-btn:last-child',
                '.toggle-tools-btn',
                '.chat-action-btn[onclick*="triggerSmartReply"]',
                '.send-button'
            ];

            buttonSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    // ä½¿ç”¨removePropertyæ¢å¤é»˜è®¤æ ·å¼
                    element.style.removeProperty('background-image');
                    element.style.removeProperty('background-size');
                    element.style.removeProperty('background-position');
                    element.style.removeProperty('background-repeat');
                    element.style.removeProperty('color');
                    element.style.removeProperty('text-shadow');
                    element.style.removeProperty('border');
                    element.style.removeProperty('box-shadow');
                    element.style.removeProperty('background-color');

                    // æ¢å¤æŒ‰é’®å†…çš„å›¾æ ‡å’Œæ–‡å­—æ˜¾ç¤º
                    const icons = element.querySelectorAll('i, span, .icon');
                    icons.forEach(icon => {
                        icon.style.removeProperty('opacity');
                    });
                });
            });
        }

        // æ¸…é™¤èƒŒæ™¯è‡ªå®šä¹‰æ ·å¼
        function clearBackgroundCustomStyles() {
            console.log('ğŸ¨ æ¸…é™¤èƒŒæ™¯è‡ªå®šä¹‰æ ·å¼...');

            // æ¸…é™¤èŠå¤©ç•Œé¢èƒŒæ™¯
            const chatTopElements = document.querySelectorAll('#api-chat-screen .app-status-bar, #api-chat-screen .app-header');
            chatTopElements.forEach(element => {
                element.style.backgroundImage = '';
                element.style.backgroundSize = '';
                element.style.backgroundPosition = '';
                element.style.backgroundRepeat = '';
            });

            const chatBottomElements = document.querySelectorAll('#api-chat-screen .chat-input-area');
            chatBottomElements.forEach(element => {
                element.style.backgroundImage = '';
                element.style.backgroundSize = '';
                element.style.backgroundPosition = '';
                element.style.backgroundRepeat = '';
            });

            // æ¸…é™¤å…¨å±€èƒŒæ™¯
            const globalElements = document.querySelectorAll('.app-status-bar, .app-screen');
            globalElements.forEach(element => {
                element.style.backgroundImage = '';
                element.style.backgroundSize = '';
                element.style.backgroundPosition = '';
                element.style.backgroundRepeat = '';
            });
        }

        // ğŸ”¥ã€åˆ é™¤ã€‘æ—§çš„ä¸»é¢˜åŠ è½½å‡½æ•° - ç°åœ¨ä½¿ç”¨Dexieæ•°æ®åº“
        // ä¸»é¢˜åŠ è½½å·²è¿ç§»åˆ°æ•°æ®åº“å‡çº§è¿‡ç¨‹ä¸­è‡ªåŠ¨å¤„ç†

        // ğŸ”¥ã€åˆ é™¤ã€‘æ—§çš„è¿ç§»å‡½æ•° - ç°åœ¨åœ¨æ•°æ®åº“å‡çº§ä¸­è‡ªåŠ¨å¤„ç†

        // ğŸ”¥ã€ä¿®æ”¹ã€‘æ˜¾ç¤ºä¸»é¢˜ç®¡ç†ç•Œé¢ - ä½¿ç”¨Dexie
        async function showThemeManagement() {
            try {
                // è·å–æ‰€æœ‰æœ‰è‡ªå®šä¹‰ä¸»é¢˜çš„èŠå¤©çª—å£
                const themeChats = [];
                const allChatThemes = await db.chatThemes.toArray();

                // æ£€æŸ¥æ‰€æœ‰è§’è‰²èŠå¤©
                if (characters && contacts) {
                    characters.forEach(character => {
                        if (contacts.includes(character.id)) {
                            const chatTheme = allChatThemes.find(theme => theme.chatId === character.id);
                            if (chatTheme) {
                                themeChats.push({
                                    id: character.id,
                                    name: character.name,
                                    type: 'character',
                                    themeData: chatTheme.themeData
                                });
                            }
                        }
                    });
                }

                // æ£€æŸ¥æ‰€æœ‰ç¾¤èŠ
                if (groupChats) {
                    groupChats.forEach(group => {
                        const chatTheme = allChatThemes.find(theme => theme.chatId === group.id);
                        if (chatTheme) {
                            themeChats.push({
                                id: group.id,
                                name: group.name,
                                type: 'group',
                                themeData: chatTheme.themeData
                            });
                        }
                    });
                }

                if (themeChats.length === 0) {
                    showToast('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è‡ªå®šä¹‰ä¸»é¢˜', 'info');
                    return;
                }

            // åˆ›å»ºç®¡ç†ç•Œé¢
            const modal = document.createElement('div');
            modal.className = 'modal phone-modal';
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            modal.id = 'theme-management-modal';

            const chatListHtml = themeChats.map(chat => `
                <div class="theme-chat-item" data-chat-id="${chat.id}">
                    <div class="theme-chat-info">
                        <div class="theme-chat-name">${chat.name}</div>
                        <div class="theme-chat-type">${chat.type === 'group' ? 'ç¾¤èŠ' : 'è§’è‰²'}</div>
                    </div>
                    <div class="theme-chat-actions">
                        <button class="theme-chat-btn preview-theme-btn" onclick="previewChatTheme('${chat.id}')" title="é¢„è§ˆä¸»é¢˜">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="theme-chat-btn remove-theme-btn" onclick="removeChatTheme('${chat.id}')" title="ç§»é™¤ä¸»é¢˜">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ä¸»é¢˜ç®¡ç†</h3>
                        <button class="modal-close" onclick="closeThemeManagement()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="theme-management-info">
                            <p>æ‰¾åˆ° ${themeChats.length} ä¸ªèŠå¤©çª—å£æœ‰è‡ªå®šä¹‰ä¸»é¢˜</p>
                        </div>
                        <div class="theme-chat-list">
                            ${chatListHtml}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-button modal-secondary" onclick="closeThemeManagement()">å…³é—­</button>
                        <button class="modal-button modal-danger" onclick="clearAllThemes()">æ¸…é™¤æ‰€æœ‰ä¸»é¢˜</button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('âŒ æ˜¾ç¤ºä¸»é¢˜ç®¡ç†ç•Œé¢å¤±è´¥:', error);
                showToast('åŠ è½½ä¸»é¢˜ç®¡ç†ç•Œé¢å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…³é—­ä¸»é¢˜ç®¡ç†ç•Œé¢
        function closeThemeManagement() {
            const modal = document.getElementById('theme-management-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘é¢„è§ˆæŒ‡å®šèŠå¤©çª—å£çš„ä¸»é¢˜ - ä½¿ç”¨Dexie
        async function previewChatTheme(chatId) {
            try {
                const chatTheme = await db.chatThemes.where('chatId').equals(chatId).first();
                if (chatTheme && chatTheme.themeData) {
                    await applyCustomThemeStyles(chatTheme.themeData);

                    // æ‰¾åˆ°èŠå¤©çª—å£åç§°
                    let chatName = 'æœªçŸ¥èŠå¤©';
                    if (characters && contacts) {
                        const character = characters.find(c => c.id === chatId);
                        if (character && contacts.includes(character.id)) {
                            chatName = character.name;
                        }
                    }
                    if (groupChats) {
                        const group = groupChats.find(g => g.id === chatId);
                        if (group) {
                            chatName = group.name;
                        }
                    }

                    showToast(`æ­£åœ¨é¢„è§ˆ ${chatName} çš„ä¸»é¢˜`, 'info');
                } else {
                    showToast('æœªæ‰¾åˆ°ä¸»é¢˜æ•°æ®', 'error');
                }
            } catch (error) {
                console.error('âŒ é¢„è§ˆä¸»é¢˜å¤±è´¥:', error);
                showToast('é¢„è§ˆä¸»é¢˜å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ç§»é™¤æŒ‡å®šèŠå¤©çª—å£çš„ä¸»é¢˜ - ä½¿ç”¨Dexie
        async function removeChatTheme(chatId) {
            try {
                // æ‰¾åˆ°èŠå¤©çª—å£åç§°
                let chatName = 'æœªçŸ¥èŠå¤©';
                if (characters && contacts) {
                    const character = characters.find(c => c.id === chatId);
                    if (character && contacts.includes(character.id)) {
                        chatName = character.name;
                    }
                }
                if (groupChats) {
                    const group = groupChats.find(g => g.id === chatId);
                    if (group) {
                        chatName = group.name;
                    }
                }

                if (confirm(`ç¡®å®šè¦ç§»é™¤ ${chatName} çš„è‡ªå®šä¹‰ä¸»é¢˜å—ï¼Ÿ`)) {
                    await db.chatThemes.where('chatId').equals(chatId).delete();

                    // å¦‚æœå½“å‰èŠå¤©çª—å£å°±æ˜¯è¢«ç§»é™¤ä¸»é¢˜çš„çª—å£ï¼Œæ¸…é™¤æ ·å¼
                    if (currentChatCharacter && currentChatCharacter.id === chatId) {
                        clearCustomThemeStyles();
                    }

                    showToast(`å·²ç§»é™¤ ${chatName} çš„è‡ªå®šä¹‰ä¸»é¢˜`, 'success');

                    // åˆ·æ–°ç®¡ç†ç•Œé¢
                    closeThemeManagement();
                    setTimeout(() => showThemeManagement().catch(e => console.error('åˆ·æ–°ä¸»é¢˜ç®¡ç†å¤±è´¥:', e)), 100);
                }
            } catch (error) {
                console.error('âŒ ç§»é™¤ä¸»é¢˜å¤±è´¥:', error);
                showToast('ç§»é™¤ä¸»é¢˜å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰ä¸»é¢˜ - ä½¿ç”¨Dexie
        async function clearAllThemes() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©çª—å£çš„è‡ªå®šä¹‰ä¸»é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                try {
                    // è·å–æ‰€æœ‰èŠå¤©ä¸»é¢˜æ•°é‡
                    const allChatThemes = await db.chatThemes.toArray();
                    const themeCount = allChatThemes.length;

                    // åˆ é™¤æ‰€æœ‰èŠå¤©ä¸»é¢˜æ•°æ®
                    await db.chatThemes.clear();

                    // æ¸…é™¤å½“å‰åº”ç”¨çš„ä¸»é¢˜æ ·å¼
                    clearCustomThemeStyles();

                    showToast(`å·²æ¸…é™¤ ${themeCount} ä¸ªèŠå¤©çª—å£çš„è‡ªå®šä¹‰ä¸»é¢˜`, 'success');

                    // å…³é—­ç®¡ç†ç•Œé¢
                    closeThemeManagement();
                } catch (error) {
                    console.error('âŒ æ¸…é™¤æ‰€æœ‰ä¸»é¢˜å¤±è´¥:', error);
                    showToast('æ¸…é™¤æ‰€æœ‰ä¸»é¢˜å¤±è´¥', 'error');
                }
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜ - ä½¿ç”¨Dexie
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘æ£€æŸ¥å½“å‰é€‰æ‹©çš„ä¸»é¢˜ç±»å‹ï¼Œåªåœ¨ä½¿ç”¨è‡ªå®šä¹‰ä¸»é¢˜æ—¶æ‰åº”ç”¨
                const themeSettingRecord = await db.themeSettings.get('selectedTheme');
                const currentTheme = themeSettingRecord ? themeSettingRecord.settingValue : null;

                if (!currentTheme || currentTheme === 'custom') {
                    // æ²¡æœ‰è®¾ç½®ä¸»é¢˜æˆ–ä½¿ç”¨è‡ªå®šä¹‰ä¸»é¢˜æ—¶ï¼Œåº”ç”¨è‡ªå®šä¹‰ä¸»é¢˜
                    await applyGlobalCustomTheme(); // åº”ç”¨å…¨å±€ä¸»é¢˜
                    console.log('ğŸ¨ é¡µé¢åŠ è½½æ—¶ä»Dexieåº”ç”¨å…¨å±€è‡ªå®šä¹‰ä¸»é¢˜');
                } else {
                    // ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜æ—¶ï¼Œåº”ç”¨å¯¹åº”çš„ç³»ç»Ÿä¸»é¢˜
                    const body = document.body;
                    body.removeAttribute('data-theme');
                    if (currentTheme !== 'default') {
                        body.setAttribute('data-theme', currentTheme);
                    }
                    console.log(`ğŸ¨ é¡µé¢åŠ è½½æ—¶åº”ç”¨ç³»ç»Ÿä¸»é¢˜: ${currentTheme}`);
                }
            } catch (error) {
                console.error('âŒ é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¸»é¢˜å¤±è´¥:', error);
            }
        });

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–è‡ªå®šä¹‰ä¸»é¢˜ç•Œé¢ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function initCustomThemeScreen() {
            console.log('ğŸ¨ åˆå§‹åŒ–è‡ªå®šä¹‰ä¸»é¢˜ç•Œé¢');

            // ç¡®ä¿é»˜è®¤é€‰ä¸­èŠå¤©ç•Œé¢é€‰é¡¹å¡
            switchCustomThemeTab('chat');

            // ğŸ”¥ã€ä¿®æ”¹ã€‘åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®åˆ°ç•Œé¢ - ä½¿ç”¨async
            await loadCustomThemeToUI();
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åŠ è½½è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®åˆ°ç•Œé¢ - æ”¹ä¸ºasyncæ”¯æŒDexie
        async function loadCustomThemeToUI() {
            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä»Dexieæ•°æ®åº“åŠ è½½å…¨å±€ä¸»é¢˜æ•°æ®
                const savedGlobalTheme = await db.globalThemes.get('global');
                let globalThemeData = {};
                if (savedGlobalTheme && savedGlobalTheme.themeData) {
                    globalThemeData = savedGlobalTheme.themeData;
                    console.log('ğŸ¨ ä»DexieåŠ è½½å…¨å±€ä¸»é¢˜æ•°æ®åˆ°ç•Œé¢');
                }

                // ğŸ”¥ã€ä¿®æ”¹ã€‘æ„å»ºå®Œæ•´çš„ä¸»é¢˜æ•°æ®å¯¹è±¡
                const themeData = {
                    // èŠå¤©ç•Œé¢æ•°æ®ï¼ˆä»å†…å­˜ä¸­çš„customThemeDataè·å–ï¼Œå› ä¸ºè¿™æ˜¯ç¼–è¾‘ä¸­çš„æ•°æ®ï¼‰
                    chatTopBg: customThemeData.chatTopBg,
                    chatBottomBg: customThemeData.chatBottomBg,
                    buttons: { ...customThemeData.buttons },
                    // å…¨å±€ç•Œé¢æ•°æ®ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
                    globalTopAppBar: globalThemeData.globalTopAppBar,
                    globalBottomAppBar: globalThemeData.globalBottomAppBar,
                    globalBackButton: globalThemeData.globalBackButton,
                    globalAddButton: globalThemeData.globalAddButton,
                    globalBg: globalThemeData.globalBg,
                    // åº”ç”¨èŒƒå›´è®¾ç½®
                    scope: customThemeData.scope || 'selected',
                    selectedChats: customThemeData.selectedChats || []
                };

                // æ›´æ–°å†…å­˜ä¸­çš„customThemeData
                customThemeData = themeData;

                    // æ›´æ–°é¢„è§ˆå›¾å’ŒçŠ¶æ€æŒ‡ç¤ºå™¨
                    if (themeData.chatTopBg) {
                        updatePreview('chat-top-bg-preview', themeData.chatTopBg);
                        updateThemeItemStatus('chat-top-bg-item', true);
                    }
                    if (themeData.chatBottomBg) {
                        updatePreview('chat-bottom-bg-preview', themeData.chatBottomBg);
                        updateThemeItemStatus('chat-bottom-bg-item', true);
                    }

                    // æ›´æ–°æŒ‰é’®é¢„è§ˆå’ŒçŠ¶æ€æŒ‡ç¤ºå™¨
                    if (themeData.buttons && typeof themeData.buttons === 'object') {
                        Object.keys(themeData.buttons).forEach(buttonType => {
                            if (themeData.buttons[buttonType]) {
                                updatePreview(`${buttonType}-btn-preview`, themeData.buttons[buttonType]);
                                updateThemeItemStatus(`${buttonType}-btn-item`, true);
                            }
                        });
                    }

                    // ğŸ”¥ã€åˆ é™¤é‡å¤ã€‘å…¨å±€ä¸»é¢˜æœ¬æ¥å°±æœ‰çŠ¶æ€æŒ‡ç¤ºå™¨ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œé‡å¤æ›´æ–°
                    // åªæ›´æ–°é¢„è§ˆå›¾å³å¯
                    if (themeData.globalTopAppBar) {
                        updatePreview('global-top-app-bar-preview', themeData.globalTopAppBar);
                    }
                    if (themeData.globalBottomAppBar) {
                        updatePreview('global-bottom-app-bar-preview', themeData.globalBottomAppBar);
                    }
                    if (themeData.globalBackButton) {
                        updatePreview('global-back-button-preview', themeData.globalBackButton);
                    }
                    if (themeData.globalAddButton) {
                        updatePreview('global-add-button-preview', themeData.globalAddButton);
                    }
                    if (themeData.globalBg) {
                        updatePreview('global-bg-preview', themeData.globalBg);
                    }

                    // æ›´æ–°åº”ç”¨èŒƒå›´é€‰æ‹©
                    document.querySelectorAll('.theme-scope-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    const activeScope = document.querySelector(`.theme-scope-option[data-scope="${themeData.scope}"]`);
                    if (activeScope) {
                        activeScope.classList.add('active');
                    }

            } catch (error) {
                console.error('âŒ åŠ è½½è‡ªå®šä¹‰ä¸»é¢˜ç•Œé¢æ•°æ®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åŠ è½½ä¿å­˜çš„ä¸»é¢˜ - ä½¿ç”¨Dexie
        async function loadSavedTheme() {
            try {
                const themeSettingRecord = await db.themeSettings.get('selectedTheme');
                const savedTheme = themeSettingRecord ? themeSettingRecord.settingValue : null;
                if (savedTheme && savedTheme !== 'default') {
                    document.body.setAttribute('data-theme', savedTheme);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ä¿å­˜çš„ä¸»é¢˜å¤±è´¥:', error);
            }
        }

        // ä¸–ç•Œä¹¦ç›¸å…³åŠŸèƒ½
        let worldbooks = [];
        let editingWorldbook = null;

        // åŠ è½½ä¸–ç•Œä¹¦æ•°æ® - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadWorldbooks() {
            try {
                // å…ˆä»IndexedDBåŠ è½½
                const savedWorldbooks = await db.worldbooks.toArray();

                if (savedWorldbooks.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('worldbooks');
                    if (localStorageData) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„ä¸–ç•Œä¹¦æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localWorldbooks = JSON.parse(localStorageData);

                        if (localWorldbooks.length > 0) {
                            // ç¡®ä¿æ¯ä¸ªä¸–ç•Œä¹¦éƒ½æœ‰idå­—æ®µ
                            const migrationData = localWorldbooks.map(wb => ({
                                id: wb.id || Date.now().toString() + Math.random(),
                                title: wb.title,
                                content: wb.content,
                                createdAt: wb.createdAt || new Date().toISOString(),
                                updatedAt: wb.updatedAt || new Date().toISOString()
                            }));

                            // è¿ç§»åˆ°IndexedDB
                            await db.worldbooks.bulkAdd(migrationData);
                            worldbooks = migrationData;
                            console.log('ä¸–ç•Œä¹¦æ•°æ®è¿ç§»å®Œæˆ:', worldbooks);
                        } else {
                            worldbooks = [];
                        }
                    } else {
                        worldbooks = [];
                    }
                } else {
                    // IndexedDBä¸­æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                    worldbooks = savedWorldbooks;
                    console.log('ä»IndexedDBåŠ è½½ä¸–ç•Œä¹¦æ•°æ®:', worldbooks);
                }

                // è§’è‰²ä¸–ç•Œä¹¦è¿ç§»åŠŸèƒ½å·²ç§»é™¤

            } catch (error) {
                console.error('åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                const localStorageData = localStorage.getItem('worldbooks');
                if (localStorageData) {
                    try {
                        worldbooks = JSON.parse(localStorageData);
                } catch (e) {
                        worldbooks = [];
                    }
                } else {
                    worldbooks = [];
                }

                // è§’è‰²ä¸–ç•Œä¹¦è¿ç§»åŠŸèƒ½å·²ç§»é™¤
            }
            renderWorldbookList();
        }



        // ä¿å­˜ä¸–ç•Œä¹¦æ•°æ® - ä½¿ç”¨IndexedDB
        async function saveWorldbooks() {
            try {
                console.log('ä¿å­˜ä¸–ç•Œä¹¦æ•°æ®åˆ°IndexedDB:', worldbooks);

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ“ä½œï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                if (worldbooks.length === 0) {
                    console.warn('âš ï¸ ä¸–ç•Œä¹¦æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜æ“ä½œ');
                    return;
                }

                // ä½¿ç”¨äº‹åŠ¡è¿›è¡ŒåŸå­æ“ä½œ
                await db.transaction('rw', db.worldbooks, async () => {
                    await db.worldbooks.clear();
                    await db.worldbooks.bulkAdd(worldbooks);
                });

                console.log(`âœ… å®‰å…¨ä¿å­˜äº† ${worldbooks.length} ä¸ªä¸–ç•Œä¹¦åˆ°æ•°æ®åº“`);

                console.log('ä¸–ç•Œä¹¦æ•°æ®ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜ä¸–ç•Œä¹¦æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            }
        }

        function showWorldbookForm(isGlobal) {
    // æ ¹æ®ä¼ å…¥çš„ç±»å‹æ¥å†³å®šè¡¨å•æ ‡é¢˜
    let title;
    if (isGlobal) {
        title = 'æ–°å»ºå…¨å±€è®¾å®š';
    } else {
        title = 'æ–°å»ºå±€éƒ¨è®¾å®š';
    }
    document.getElementById('worldbook-form-title').textContent = title;

    editingWorldbook = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';

    // å°†åˆ›å»ºç±»å‹æš‚å­˜èµ·æ¥ï¼Œä»¥ä¾¿ä¿å­˜æ—¶ä½¿ç”¨
    window.newWorldbookIsGlobal = isGlobal;

            showApp('worldbook-form-screen');
        }

        function hideWorldbookForm() {
            hideApp('worldbook-form-screen');
            // ç¡®ä¿è¿”å›åˆ°ä¸–ç•Œä¹¦åº”ç”¨ï¼Œè€Œä¸æ˜¯ä¸»å±å¹•
            showApp('worldbook-screen');
        }

        async function saveWorldbook() {
            const title = document.getElementById('worldbook-title').value.trim();
            const content = document.getElementById('worldbook-content').value.trim();

    if (!title || !content) {
        alert('è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹');
                return;
            }

    let isGlobal;
    if (editingWorldbook) {
        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¿æŒå…¶åŸæœ‰çš„ç±»å‹ä¸å˜
        isGlobal = editingWorldbook.isGlobal;
    } else {
        // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œè¯»å–æˆ‘ä»¬æš‚å­˜çš„ç±»å‹
        isGlobal = window.newWorldbookIsGlobal;
            }

            const worldbook = {
                id: editingWorldbook ? editingWorldbook.id : Date.now().toString(),
                title: title,
                content: content,
        isGlobal: isGlobal, // æ ¹æ®æ­£ç¡®çš„çŠ¶æ€è®¾ç½®
                createdAt: editingWorldbook ? editingWorldbook.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };



            if (editingWorldbook) {
                const index = worldbooks.findIndex(w => w.id === editingWorldbook.id);
        if (index !== -1) worldbooks[index] = worldbook;
            } else {
                worldbooks.push(worldbook);
            }

            await saveWorldbooks();
            renderWorldbookList();
            showToast(editingWorldbook ? 'ä¸–ç•Œä¹¦å·²æ›´æ–°ï¼' : 'ä¸–ç•Œä¹¦å·²åˆ›å»ºï¼', 'success');
            hideWorldbookForm();
        }
// --- æ–°å¢å‡½æ•° ---
async function toggleGlobalWorldbook(bookId, isEnabled) {
    // ç¡®ä¿window.activeGlobalWorldbookså­˜åœ¨
    if (!window.activeGlobalWorldbooks) {
        window.activeGlobalWorldbooks = [];
    }

    if (isEnabled) {
        // å¦‚æœå¼€å¯ï¼Œæ·»åŠ åˆ°æ¿€æ´»åˆ—è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!window.activeGlobalWorldbooks.includes(bookId)) {
            window.activeGlobalWorldbooks.push(bookId);
        }
    } else {
        // å¦‚æœå…³é—­ï¼Œä»æ¿€æ´»åˆ—è¡¨ä¸­ç§»é™¤
        window.activeGlobalWorldbooks = window.activeGlobalWorldbooks.filter(id => id !== bookId);
    }

    // ä¿å­˜æ¿€æ´»çŠ¶æ€åˆ°æ•°æ®åº“çš„ globalSettings è¡¨
    try {
        await db.globalSettings.put({
            id: 'main',
            activeGlobalWorldbooks: window.activeGlobalWorldbooks
        });
        console.log('å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®å·²ä¿å­˜:', window.activeGlobalWorldbooks);
        showToast('å…¨å±€è®¾å®šå·²æ›´æ–°', 'success');
    } catch (error) {
        console.error("ä¿å­˜å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®å¤±è´¥:", error);
        showToast('è®¾ç½®ä¿å­˜å¤±è´¥', 'error');
    }
        }

        function editWorldbook(id) {
            const worldbook = worldbooks.find(w => w.id === id);
            if (worldbook) {
                editingWorldbook = worldbook;
        // ç¼–è¾‘æ—¶ä¸æ˜¾ç¤ºâ€œæ–°å»ºâ€ï¼Œè€Œæ˜¯â€œç¼–è¾‘â€
        let title;
        if (worldbook.isGlobal) {
            title = 'ç¼–è¾‘å…¨å±€è®¾å®š';
        } else {
            title = 'ç¼–è¾‘å±€éƒ¨è®¾å®š';
        }
        document.getElementById('worldbook-form-title').textContent = title;
                document.getElementById('worldbook-title').value = worldbook.title || worldbook.name;
                document.getElementById('worldbook-content').value = worldbook.content;
                showApp('worldbook-form-screen');
            }
        }

        async function deleteWorldbook(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿ')) {
                console.log('ğŸ—‘ï¸ åˆ é™¤ä¸–ç•Œä¹¦:', id);
                console.log('åˆ é™¤å‰çš„ä¸–ç•Œä¹¦åˆ—è¡¨:', worldbooks.map(w => ({id: w.id, name: w.name || w.title})));

                // ä»å†…å­˜æ•°ç»„ä¸­åˆ é™¤
                const initialLength = worldbooks.length;
                worldbooks = worldbooks.filter(w => w.id !== id);
                const finalLength = worldbooks.length;

                console.log(`åˆ é™¤æ“ä½œ: ${initialLength} -> ${finalLength}, åˆ é™¤äº† ${initialLength - finalLength} ä¸ªé¡¹ç›®`);

                if (initialLength === finalLength) {
                    console.warn('âš ï¸ åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°è¦åˆ é™¤çš„ä¸–ç•Œä¹¦');
                    showToast('åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°æŒ‡å®šçš„ä¸–ç•Œä¹¦', 'error');
                    return;
                }

                // ä¿å­˜åˆ°æ•°æ®åº“
                try {
                    await saveWorldbooks();
                    console.log('âœ… ä¸–ç•Œä¹¦åˆ é™¤æˆåŠŸ');
                    showToast('ä¸–ç•Œä¹¦å·²åˆ é™¤', 'success');
                } catch (error) {
                    console.error('âŒ åˆ é™¤ä¸–ç•Œä¹¦æ—¶æ•°æ®åº“ä¿å­˜å¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥ï¼šæ•°æ®åº“ä¿å­˜é”™è¯¯', 'error');
                }

                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderWorldbookList();
            }
        }

// ç”¨è¿™æ®µæ–°ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ renderWorldbookList å‡½æ•°
        function renderWorldbookList() {
    const globalContainer = document.getElementById('global-worldbooks-content');
    const localContainer = document.getElementById('local-worldbooks-content');
    if (!globalContainer || !localContainer) return;

    const globalBooks = worldbooks.filter(w => w.isGlobal);
    const localBooks = worldbooks.filter(w => !w.isGlobal);

    let globalHtml = '';
    let localHtml = '';

    // --- æ¸²æŸ“å…¨å±€ä¸–ç•Œä¹¦ ---
    globalHtml += `<div class="worldbook-section">`;
    if (globalBooks.length > 0) {
        globalBooks.forEach(book => {
            // ç¡®ä¿ä½¿ç”¨window.activeGlobalWorldbookså¹¶æ£€æŸ¥å…¶æ˜¯å¦ä¸ºæ•°ç»„
            const isChecked = Array.isArray(window.activeGlobalWorldbooks) && window.activeGlobalWorldbooks.includes(book.id) ? 'checked' : '';
            const dateObj = new Date(book.updatedAt || book.createdAt || Date.now());
            const date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString();
            const preview = truncateText(book.content, 60);
            globalHtml += `
                <div class="worldbook-item" onclick="editWorldbook('${book.id}')">
                    <div class="worldbook-header">
                        <div class="worldbook-content-flex">
                            <div class="worldbook-title">${book.title || book.name}</div>
                            <div class="worldbook-desc-text">${preview}</div>
                            <div class="worldbook-date-text">æ›´æ–°äº ${date}</div>
                        </div>
                        <div class="worldbook-actions">
                            <button onclick="event.stopPropagation(); deleteWorldbook('${book.id}')" class="delete-worldbook-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                            <label class="toggle-switch" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="toggleGlobalWorldbook('${book.id}', this.checked)" ${isChecked}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        globalHtml += '<div class="empty-message">æš‚æ— å…¨å±€è®¾å®š</div>';
    }
    globalHtml += '</div>';

    // --- æ¸²æŸ“å±€éƒ¨ä¸–ç•Œä¹¦ ---
    localHtml += `<div class="worldbook-section">`;
    if (localBooks.length > 0) {
        localBooks.forEach(book => {
            const dateObj = new Date(book.updatedAt || book.createdAt || Date.now());
            const date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString();
            const preview = truncateText(book.content, 60);
            localHtml += `
                <div class="worldbook-item" onclick="editWorldbook('${book.id}')">
                    <div class="worldbook-header">
                        <div class="worldbook-content-flex">
                            <div class="worldbook-title">${book.title || book.name}</div>
                            <div class="worldbook-desc-text">${preview}</div>
                            <div class="worldbook-date-text">æ›´æ–°äº ${date}</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteWorldbook('${book.id}')" class="delete-worldbook-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        localHtml += '<div class="empty-message">æš‚æ— å±€éƒ¨è®¾å®š</div>';
    }
    localHtml += '</div>';

    globalContainer.innerHTML = globalHtml;
    localContainer.innerHTML = localHtml;
}
function switchWorldbookTab(tabName) {
    currentWorldbookTab = tabName; // <--- æ ¸å¿ƒä¿®æ”¹ï¼šè®°å½•å½“å‰æ ‡ç­¾é¡µ

    const globalContent = document.getElementById('global-worldbooks-content');
    const localContent = document.getElementById('local-worldbooks-content');
    const tabs = document.querySelectorAll('.worldbook-tab');

    tabs.forEach(tab => {
        if (tab.getAttribute('onclick').includes(tabName)) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    // éšè—æ‰€æœ‰å†…å®¹é¢æ¿
    globalContent.style.display = 'none';
    localContent.style.display = 'none';

    if (tabName === 'global') {
        globalContent.style.display = 'block';
    } else if (tabName === 'local') {
        localContent.style.display = 'block';
    }

    renderWorldbookList();
}
function onWorldbookAddClick() {
    if (currentWorldbookTab === 'global') {
        showWorldbookForm(true); // åˆ›å»ºå…¨å±€è®¾å®š
    } else if (currentWorldbookTab === 'local') {
        showWorldbookForm(false); // åˆ›å»ºå±€éƒ¨è®¾å®š
    }
        }





        // è°ƒè¯•ï¼šæŸ¥çœ‹æ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®
        function debugWorldbooks() {
            console.log('ğŸ“‹ å½“å‰æ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®:');
            worldbooks.forEach((wb, index) => {
                console.log(`${index + 1}. ID: "${wb.id}", åç§°: "${wb.name || wb.title}", æ¥æº: "${wb.source}", åˆ†ç±»: "${wb.category}", å…¨å±€: ${wb.isGlobal}`);
            });
            console.log(`æ€»è®¡: ${worldbooks.length} ä¸ªä¸–ç•Œä¹¦`);
            return worldbooks;
        }



        // æ¸…ç©ºæ‰€æœ‰ä¸–ç•Œä¹¦ï¼ˆç»ˆææ–¹æ¡ˆï¼‰
        async function clearAllWorldbooks() {
            if (confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ä¸–ç•Œä¹¦å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ’¤é”€ï¼')) {
                console.log('ğŸ’£ æ¸…ç©ºæ‰€æœ‰ä¸–ç•Œä¹¦...');
                const count = worldbooks.length;
                worldbooks = [];
                await saveWorldbooks();
                renderWorldbookList();
                showToast(`å·²æ¸…ç©ºæ‰€æœ‰${count}ä¸ªä¸–ç•Œä¹¦`, 'success');
                console.log('âœ… æ‰€æœ‰ä¸–ç•Œä¹¦å·²æ¸…ç©º');
            }
        }

        // ä¿®å¤ä¸–ç•Œä¹¦IDé—®é¢˜
        async function fixWorldbookIds() {
            console.log('ğŸ”§ ä¿®å¤ä¸–ç•Œä¹¦IDé—®é¢˜...');
            let fixedCount = 0;

            worldbooks.forEach((wb, index) => {
                if (!wb.id || typeof wb.id !== 'string') {
                    wb.id = `fixed_${Date.now()}_${index}`;
                    fixedCount++;
                    console.log(`ä¿®å¤äº†ä¸–ç•Œä¹¦ "${wb.name || wb.title}" çš„ID`);
                }
            });

            if (fixedCount > 0) {
                await saveWorldbooks();
                renderWorldbookList();
                showToast(`ä¿®å¤äº†${fixedCount}ä¸ªä¸–ç•Œä¹¦çš„ID`, 'success');
            } else {
                console.log('æ‰€æœ‰ä¸–ç•Œä¹¦IDéƒ½æ­£å¸¸');
            }

            return fixedCount;
        }








        // ================== éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½ ==================

        // LRCæ­Œè¯è§£æå‡½æ•°
        function parseLRC(lrcContent) {
            if (!lrcContent) return { lyrics: ['â™ª æš‚æ— æ­Œè¯'], timings: [] };

            const lines = lrcContent.split('\n');
            const lyrics = [];
            const timings = [];
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;

            for (const line of lines) {
                let match;
                const matches = [];

                // æ‰¾åˆ°æ‰€æœ‰æ—¶é—´æ ‡ç­¾
                while ((match = timeRegex.exec(line)) !== null) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const totalSeconds = minutes * 60 + seconds + milliseconds / 1000;
                    matches.push(totalSeconds);
                }

                const text = line.replace(/\[\d{2}:\d{2}\.\d{2,3}\]/g, '').trim();

                if (text && !text.startsWith('[')) {
                    // ä¸ºæ¯ä¸ªæ—¶é—´æ ‡ç­¾åˆ›å»ºä¸€ä¸ªæ­Œè¯æ¡ç›®
                    if (matches.length > 0) {
                        for (const time of matches) {
                            lyrics.push(text);
                            timings.push(time);
                        }
                    } else {
                        lyrics.push(text);
                        timings.push(null); // æ²¡æœ‰æ—¶é—´æ ‡ç­¾
                    }
                }
            }

            // å¦‚æœæœ‰æ—¶é—´ä¿¡æ¯ï¼ŒæŒ‰æ—¶é—´æ’åº
            if (timings.some(t => t !== null)) {
                const combined = lyrics.map((lyric, index) => ({
                    text: lyric,
                    time: timings[index]
                })).filter(item => item.time !== null).sort((a, b) => a.time - b.time);

                return {
                    lyrics: combined.map(item => item.text),
                    timings: combined.map(item => item.time),
                    hasTimings: true
                };
            }

            return {
                lyrics: lyrics.length > 0 ? lyrics : ['â™ª æš‚æ— æ­Œè¯'],
                timings: [],
                hasTimings: false
            };
        }

        // ç½‘æ˜“äº‘éŸ³ä¹binæ ¼å¼æ­Œè¯è§£æå‡½æ•°
        function parseNeteaseBin(binData) {
            try {
                const uint8Array = new Uint8Array(binData);

                // ç½‘æ˜“äº‘éŸ³ä¹binæ ¼å¼è§£æ
                // è·³è¿‡æ–‡ä»¶å¤´éƒ¨åˆ†ï¼ˆé€šå¸¸å‰å‡ ä¸ªå­—èŠ‚æ˜¯æ ‡è¯†ç¬¦ï¼‰
                let offset = 0;

                // æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å¼€å§‹ä½ç½®
                while (offset < uint8Array.length - 4) {
                    // å¯»æ‰¾å¯èƒ½çš„JSONå¼€å§‹æ ‡è®° '{'
                    if (uint8Array[offset] === 0x7B ||
                        (uint8Array[offset] ^ 0x64) === 0x7B ||
                        (uint8Array[offset] ^ 0x4E) === 0x7B) {
                        break;
                    }
                    offset++;
                }

                // å°è¯•å¤šç§è§£å¯†æ–¹å¼
                const decryptMethods = [
                    // æ–¹æ³•1: ç›´æ¥è¯»å–
                    () => new TextDecoder('utf-8').decode(uint8Array.slice(offset)),
                    // æ–¹æ³•2: XOR 0x64
                    () => {
                        let text = '';
                        for (let i = offset; i < uint8Array.length; i++) {
                            text += String.fromCharCode(uint8Array[i] ^ 0x64);
                        }
                        return text;
                    },
                    // æ–¹æ³•3: XOR 0x4E (å¦ä¸€ç§å¸¸è§çš„å¯†é’¥)
                    () => {
                        let text = '';
                        for (let i = offset; i < uint8Array.length; i++) {
                            text += String.fromCharCode(uint8Array[i] ^ 0x4E);
                        }
                        return text;
                    }
                ];

                for (const method of decryptMethods) {
                    try {
                        const text = method();

                        // å°è¯•è§£æä¸ºJSON
                        try {
                            const jsonData = JSON.parse(text);
                            if (jsonData.lyric) {
                                return parseLRC(jsonData.lyric);
                            }
                            if (jsonData.lrc && jsonData.lrc.lyric) {
                                return parseLRC(jsonData.lrc.lyric);
                            }
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥çš„LRCæ ¼å¼
                            if (text.includes('[') && text.includes(']')) {
                                return parseLRC(text);
                            }
                        }
                    } catch (e) {
                        continue; // å°è¯•ä¸‹ä¸€ç§æ–¹æ³•
                    }
                }

                return { lyrics: ['â™ª binæ­Œè¯è§£æå¤±è´¥', 'â™ª è¯·å°è¯•ä½¿ç”¨LRCæ ¼å¼æ­Œè¯'], timings: [], hasTimings: false };
            } catch (error) {
                console.error('è§£æbinæ­Œè¯å¤±è´¥:', error);
                return { lyrics: ['â™ª æ­Œè¯è§£æå¤±è´¥'], timings: [], hasTimings: false };
            }
        }

        // éŸ³ä¹æ’­æ”¾å™¨çŠ¶æ€
        let musicPlayer = {
            isPlaying: false,
            currentSong: null,
            playlist: [], // ç°åœ¨ä»æ•°æ®åº“åŠ è½½
            currentIndex: 0,
            currentTime: 0,
            totalTime: 0,
            isVinylMode: true,
            currentLyricIndex: 0,
            listeningStartTime: null,
            totalListeningTime: 0,
            playMode: 'sequential', // 'sequential', 'loop-all', 'loop-one', 'shuffle'
            audioElement: null,
            albumCover: null,
            listeningTimer: null,
            activeChatId: null, // è®°å½•å¼€å¯å¬æ­Œçš„èŠå¤©çª—å£ID
            isActive: false, // è®°å½•éŸ³ä¹æ’­æ”¾å™¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
            // ğŸ”¥ã€æ–°å¢ã€‘éŸ³é¢‘ç¼“å­˜ç®¡ç†
            audioCache: new Map(), // ç¼“å­˜å·²åˆ›å»ºçš„blob URL
            maxCacheSize: 3 // æœ€å¤šç¼“å­˜3ä¸ªéŸ³é¢‘æ–‡ä»¶
        }

        // ğŸ”¥ã€ä¿®å¤å†…å­˜æ³„æ¼ã€‘ç®€åŒ–çš„éŸ³é¢‘URLç®¡ç†å‡½æ•°
        function getAudioUrl(song) {
            // å¦‚æœä¸æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œç›´æ¥è¿”å›URL
            if (!song.isLocalFile || !song.url.startsWith('data:')) {
                return song.url;
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¯¹äºæœ¬åœ°æ–‡ä»¶ï¼Œç›´æ¥è¿”å›base64 URL
            // ä¸è¿›è¡Œä»»ä½•è½¬æ¢ï¼Œé¿å…åˆ›å»ºé¢å¤–çš„å†…å­˜å¯¹è±¡
            console.log('ğŸµ ä½¿ç”¨æœ¬åœ°æ–‡ä»¶base64 URL:', song.title);
            logMemoryUsage('è·å–éŸ³é¢‘URLå');
            return song.url;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†æ‰€æœ‰éŸ³é¢‘ç¼“å­˜
        function clearAudioCache() {
            for (const [songId, blobUrl] of musicPlayer.audioCache) {
                if (blobUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(blobUrl);
                }
                console.log('ğŸ§¹ é‡Šæ”¾éŸ³é¢‘ç¼“å­˜:', songId);
            }
            musicPlayer.audioCache.clear();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å†…å­˜ä½¿ç”¨ç›‘æ§å‡½æ•°
        function logMemoryUsage(context = '') {
            if (performance.memory) {
                const memory = performance.memory;
                const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                const limit = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);
                console.log(`ğŸ§  å†…å­˜ä½¿ç”¨ ${context}: ${used}MB / ${total}MB (é™åˆ¶: ${limit}MB)`);

                // å¦‚æœå†…å­˜ä½¿ç”¨è¶…è¿‡80%ï¼Œå‘å‡ºè­¦å‘Š
                if (used / limit > 0.8) {
                    console.warn('âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå»ºè®®æ¸…ç†ç¼“å­˜');
                }
            }
        };

        // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
        async function initializeMusicPlayer() {
            try {
                // ä»æ•°æ®åº“åŠ è½½æ’­æ”¾åˆ—è¡¨
                const playlistItems = await db.musicPlaylist.orderBy('addedTime').toArray();
                musicPlayer.playlist = playlistItems;

                // å¦‚æœæœ‰æ­Œæ›²ä¸”æ²¡æœ‰å½“å‰æ­Œæ›²ï¼Œè®¾ç½®ç¬¬ä¸€é¦–ä¸ºå½“å‰æ­Œæ›²
                if (playlistItems.length > 0 && !musicPlayer.currentSong) {
                    const firstSong = playlistItems[0];

                    // åŠ è½½å°é¢
                    let coverImageData = null;
                    if (firstSong.coverImage) {
                        const coverRecord = await db.musicCovers.get(firstSong.coverImage);
                        if (coverRecord) {
                            coverImageData = coverRecord.imageData;
                        }
                    }

                    musicPlayer.currentSong = {
                        ...firstSong,
                        coverImageData: coverImageData
                    };
                    musicPlayer.currentIndex = 0;
                }

                // ä¸å†æ¯æ¬¡åˆå§‹åŒ–æ—¶é‡ç½®å¬æ­Œæ—¶é—´
                // åªæœ‰åœ¨å®Œå…¨å…³é—­æ’­æ”¾å™¨æ—¶æ‰é‡ç½®
            } catch (error) {
                console.error('åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨å¤±è´¥:', error);
                // å¦‚æœæ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ’­æ”¾åˆ—è¡¨
                musicPlayer.playlist = [];
            }

            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            const currentTimeEl = document.getElementById('modal-current-time');
            const totalTimeEl = document.getElementById('modal-total-time');
            if (currentTimeEl) currentTimeEl.textContent = '0:00';
            if (totalTimeEl) totalTimeEl.textContent = '0:00';
        }

        // æ‰“å¼€éŸ³ä¹æ’­æ”¾å™¨
        async function openMusicPlayer() {
            // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
            await initializeMusicPlayer();

            const modal = document.getElementById('music-modal');
            const statusDisplay = document.getElementById('music-status-display');
            const phoneScreen = document.getElementById('phone-screen');

            if (modal && phoneScreen) {
                // è·å–æ‰‹æœºå±å¹•çš„ä½ç½®å’Œå¤§å°
                const rect = phoneScreen.getBoundingClientRect();

                // è®¾ç½®éŸ³ä¹æ’­æ”¾å™¨è¦†ç›–æ‰‹æœºå±å¹•
                modal.style.top = rect.top + 'px';
                modal.style.left = rect.left + 'px';
                modal.style.width = rect.width + 'px';
                modal.style.height = rect.height + 'px';
                modal.style.display = 'block';

                // æ›´æ–°æ’­æ”¾å™¨èƒŒæ™¯è‰²
                updatePlayerBackground();
            }
            if (statusDisplay) {
                statusDisplay.style.display = 'flex';
            }

            // å¦‚æœæ²¡æœ‰å½“å‰æ­Œæ›²ï¼Œé€‰æ‹©ç¬¬ä¸€é¦–
            if (!musicPlayer.currentSong && musicPlayer.playlist.length > 0) {
                musicPlayer.currentSong = musicPlayer.playlist[0];
                musicPlayer.currentIndex = 0;
                updateMusicDisplay();
            }

            // è®¾ç½®å½“å‰èŠå¤©è§’è‰²å’Œæ´»è·ƒçŠ¶æ€
            musicPlayer.activeChatId = currentChatCharacter ? currentChatCharacter.id : null;

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„å¬æ­Œä¼šè¯ï¼ˆæ’­æ”¾å™¨ä¹‹å‰å®Œå…¨å…³é—­äº†ï¼‰
            const isNewSession = !musicPlayer.isActive;
            musicPlayer.isActive = true;

            // åªæœ‰åœ¨æ–°ä¼šè¯æ—¶æ‰é‡ç½®å¬æ­Œæ—¶é—´
            if (isNewSession) {
                musicPlayer.totalListeningTime = 0;
            }

            // å¼€å§‹æˆ–ç»§ç»­å¬æ­Œè®¡æ—¶
            startListeningTimer();

            // æ›´æ–°æ˜¾ç¤º
            updateListeningTime();
            updatePlayModeButton();

            // ç¡®ä¿æ­Œè¯æ˜¾ç¤ºæ­£ç¡®åˆå§‹åŒ–
            updateMusicDisplay();
            updateLyrics();
        }

        // å…³é—­éŸ³ä¹æ’­æ”¾å™¨ï¼ˆæš‚æ—¶é€€å‡ºï¼Œä¸é‡ç½®å¬æ­Œæ—¶é•¿ï¼‰
        function closeMusicModal() {
            const modal = document.getElementById('music-modal');
            modal.style.display = 'none';

            // ä¸æš‚åœå¬æ­Œè®¡æ—¶ï¼Œä¿æŒè®¡æ—¶å™¨ç»§ç»­è¿è¡Œ
            // è¿™æ ·å½“ç”¨æˆ·å†æ¬¡æ‰“å¼€æ’­æ”¾å™¨æ—¶ï¼Œå¬æ­Œæ—¶é•¿ä¼šä¿æŒä¸å˜
        }

        // å®Œå…¨å…³é—­éŸ³ä¹æ’­æ”¾å™¨ï¼ˆç»“æŸå¬æ­Œï¼‰
        function closeMusicPlayer() {
            const modal = document.getElementById('music-modal');
            const statusDisplay = document.getElementById('music-status-display');

            // éšè—æ¨¡æ€æ¡†å’ŒçŠ¶æ€æ æ˜¾ç¤º
            if (modal) modal.style.display = 'none';
            if (statusDisplay) statusDisplay.style.display = 'none';

            // åœæ­¢éŸ³é¢‘æ’­æ”¾
            if (musicPlayer.audioElement) {
                musicPlayer.audioElement.pause();
                // ç›´æ¥è®¾ç½®ä¸º nullï¼Œé¿å…è§¦å‘é”™è¯¯äº‹ä»¶
                musicPlayer.audioElement.src = '';
                musicPlayer.audioElement = null;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†éŸ³é¢‘ç¼“å­˜
            clearAudioCache();

            // é‡ç½®æ’­æ”¾çŠ¶æ€
            musicPlayer.isPlaying = false;
            musicPlayer.isActive = false;

            // åœæ­¢å¬æ­Œè®¡æ—¶
            stopListeningTimer();

            // é‡ç½®å”±ç‰‡æœºåŠ¨ç”»
            const vinylDisc = document.getElementById('vinyl-disc');
            const tonearm = document.getElementById('tonearm');
            if (vinylDisc) vinylDisc.classList.remove('playing');
            if (tonearm) tonearm.classList.remove('playing');

            // é‡ç½®æ’­æ”¾æŒ‰é’®
            const playBtn = document.getElementById('modal-play-btn');
            if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i>';

            console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å®Œå…¨å…³é—­');
        }

        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        function togglePlayback() {
            // å¦‚æœæ²¡æœ‰å½“å‰æ­Œæ›²ä¸”æœ‰æ­Œå•ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€é¦–
            if (!musicPlayer.audioElement && musicPlayer.playlist.length > 0) {
                musicPlayer.currentIndex = 0;
                const firstSong = musicPlayer.playlist[0];
                playSongFromPlaylist(firstSong);
                return;
            }

            // å¦‚æœæ²¡æœ‰æ­Œå•ï¼Œç›´æ¥è¿”å›
            if (musicPlayer.playlist.length === 0) {
                return;
            }

            musicPlayer.isPlaying = !musicPlayer.isPlaying;

            const playBtn = document.getElementById('modal-play-btn');
            const vinylDisc = document.getElementById('vinyl-disc');
            const tonearm = document.getElementById('tonearm');
            const statusIcon = document.querySelector('.music-icon');

            if (musicPlayer.isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                vinylDisc.classList.add('playing');
                tonearm.classList.add('playing');
                if (statusIcon) statusIcon.style.animation = 'musicPulse 1s ease-in-out infinite';

                // æ’­æ”¾çœŸå®éŸ³é¢‘
                if (musicPlayer.audioElement) {
                    musicPlayer.audioElement.play().catch(error => {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                        // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œæ¢å¤æš‚åœçŠ¶æ€
                        musicPlayer.isPlaying = false;
                        playBtn.innerHTML = '<i class="fas fa-play"></i>';
                        vinylDisc.classList.remove('playing');
                        tonearm.classList.remove('playing');
                        if (statusIcon) statusIcon.style.animation = 'musicPulse 2s ease-in-out infinite';
                        alert(`æ’­æ”¾å¤±è´¥ï¼š${error.message}\nè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ`);
                    });
                }

                // åªåœ¨çœŸæ­£å¼€å§‹æ–°æ­Œæ›²æ—¶é‡ç½®æ—¶é—´å’Œæ­Œè¯ç´¢å¼•
                // å¦‚æœæ˜¯æš‚åœåæ¢å¤æ’­æ”¾ï¼Œä¸åº”è¯¥é‡ç½®
                if (musicPlayer.audioElement && musicPlayer.audioElement.currentTime === 0) {
                    musicPlayer.currentTime = 0;
                    musicPlayer.currentLyricIndex = 0;
                    // ç«‹å³æ›´æ–°æ­Œè¯æ˜¾ç¤º
                    updateLyrics();
                }


                startPlaybackSimulation();
            } else {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                vinylDisc.classList.remove('playing');
                tonearm.classList.remove('playing');
                if (statusIcon) statusIcon.style.animation = 'musicPulse 2s ease-in-out infinite';

                // æš‚åœçœŸå®éŸ³é¢‘
                if (musicPlayer.audioElement) {
                    musicPlayer.audioElement.pause();
                }
            }
        }

        // ä¸Šä¸€é¦–
        async function previousTrack() {
            if (musicPlayer.playlist.length === 0) return;

            const oldIndex = musicPlayer.currentIndex;
            musicPlayer.currentIndex = musicPlayer.currentIndex > 0 ?
                musicPlayer.currentIndex - 1 : musicPlayer.playlist.length - 1;

            const song = musicPlayer.playlist[musicPlayer.currentIndex];

            // åŠ è½½å°é¢
            let coverImageData = null;
            if (song.coverImage) {
                try {
                    const coverRecord = await db.musicCovers.get(song.coverImage);
                    if (coverRecord) {
                        coverImageData = coverRecord.imageData;
                    }
                } catch (error) {
                    console.error('åŠ è½½å°é¢å¤±è´¥:', error);
                }
            }

            musicPlayer.currentSong = {
                ...song,
                coverImageData: coverImageData
            };
            musicPlayer.currentTime = 0;
            musicPlayer.currentLyricIndex = 0;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨çš„éŸ³é¢‘åˆ‡æ¢å‡½æ•°
            if (musicPlayer.audioElement) {
                const wasPlaying = musicPlayer.isPlaying;
                const success = await switchToSong(song, wasPlaying);
                if (!success) {
                    musicPlayer.isPlaying = false;
                }
            }

            updateMusicDisplay();
            if (musicPlayer.isPlaying) {
                startPlaybackSimulation();
            }
        }

        // ä¸‹ä¸€é¦–
        async function nextTrack() {
            if (musicPlayer.playlist.length === 0) return;

            let nextIndex;
            switch (musicPlayer.playMode) {
                case 'shuffle':
                    nextIndex = Math.floor(Math.random() * musicPlayer.playlist.length);
                    break;
                case 'loop-one':
                    nextIndex = musicPlayer.currentIndex; // å•æ›²å¾ªç¯ï¼Œä¿æŒå½“å‰ç´¢å¼•
                    break;
                case 'loop-all':
                    nextIndex = musicPlayer.currentIndex < musicPlayer.playlist.length - 1 ?
                        musicPlayer.currentIndex + 1 : 0;
                    break;
                case 'sequential':
                default:
                    nextIndex = musicPlayer.currentIndex < musicPlayer.playlist.length - 1 ?
                        musicPlayer.currentIndex + 1 : musicPlayer.currentIndex; // é¡ºåºæ’­æ”¾ï¼Œåˆ°æœ€åä¸€é¦–å°±åœæ­¢
                    break;
            }

            const oldIndex = musicPlayer.currentIndex;
            musicPlayer.currentIndex = nextIndex;
            const song = musicPlayer.playlist[musicPlayer.currentIndex];

            // åŠ è½½å°é¢
            let coverImageData = null;
            if (song.coverImage) {
                try {
                    const coverRecord = await db.musicCovers.get(song.coverImage);
                    if (coverRecord) {
                        coverImageData = coverRecord.imageData;
                    }
                } catch (error) {
                    console.error('åŠ è½½å°é¢å¤±è´¥:', error);
                }
            }

            musicPlayer.currentSong = {
                ...song,
                coverImageData: coverImageData
            };
            musicPlayer.currentTime = 0;
            musicPlayer.currentLyricIndex = 0;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨çš„éŸ³é¢‘åˆ‡æ¢å‡½æ•°
            if (musicPlayer.audioElement) {
                // nextTracké€šå¸¸æ˜¯åœ¨éœ€è¦æ’­æ”¾çš„æƒ…å†µä¸‹è°ƒç”¨çš„
                const success = await switchToSong(song, true);
                if (success) {
                    musicPlayer.isPlaying = true;
                } else {
                    musicPlayer.isPlaying = false;
                }
            }

            updateMusicDisplay();

            // ç¡®ä¿åœ¨åˆ‡æ¢æ—¶å¯åŠ¨æ’­æ”¾æ¨¡æ‹Ÿ
            startPlaybackSimulation();
        }

        // åˆ‡æ¢è§†å›¾æ¨¡å¼
        function toggleMusicView() {
            musicPlayer.isVinylMode = !musicPlayer.isVinylMode;

            const vinylMode = document.getElementById('vinyl-mode');
            const lyricsMode = document.getElementById('lyrics-mode');
            const toggleBtn = document.getElementById('view-toggle-btn');
            const currentLyricDisplay = document.querySelector('.current-lyric-display');

            if (musicPlayer.isVinylMode) {
                vinylMode.style.display = 'block';
                lyricsMode.style.display = 'none';
                // åœ¨å”±ç‰‡æœºæ¨¡å¼ä¸‹æ˜¾ç¤ºå½“å‰æ­Œè¯
                if (currentLyricDisplay) currentLyricDisplay.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
            } else {
                vinylMode.style.display = 'none';
                lyricsMode.style.display = 'block';
                // åœ¨æ­Œè¯æ¨¡å¼ä¸‹éšè—å½“å‰æ­Œè¯æ˜¾ç¤ºï¼Œé¿å…é‡å¤
                if (currentLyricDisplay) currentLyricDisplay.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-compact-disc"></i>';

                // ç¡®ä¿æ­Œè¯æ¨¡å¼å®¹å™¨æ­£ç¡®åˆå§‹åŒ–
                setTimeout(() => {
                    // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ­Œè¯å¹¶æ»šåŠ¨åˆ°å½“å‰ä½ç½®
                    const fullLyricsEl = document.getElementById('full-lyrics-display');
                    if (fullLyricsEl) {
                        fullLyricsEl.innerHTML = ''; // æ¸…ç©ºå†…å®¹å¼ºåˆ¶é‡æ–°æ¸²æŸ“
                    }
                    updateLyrics();
                }, 100);
            }

            // æ›´æ–°æ­Œè¯æ˜¾ç¤º
            if (musicPlayer.isVinylMode) {
                updateLyrics();
            }
        }

        // æ›´æ–°éŸ³ä¹æ˜¾ç¤º
        function updateMusicDisplay() {
            if (!musicPlayer.currentSong) return;

            const song = musicPlayer.currentSong;

            // æ›´æ–°çŠ¶æ€æ 
            document.getElementById('current-lyric').textContent = `â™ª ${song.title} - ${song.artist}`;

            // æ›´æ–°å”±ç‰‡æœºæ¨¡å¼
            document.getElementById('vinyl-song-title').textContent = song.title;
            document.getElementById('vinyl-artist-name').textContent = song.artist;

            // æ›´æ–°æ­Œè¯æ¨¡å¼
            document.getElementById('lyrics-song-title').textContent = song.title;
            document.getElementById('lyrics-artist-name').textContent = song.artist;

            // æ›´æ–°æ—¶é•¿æ˜¾ç¤º
            const totalTimeEl = document.getElementById('modal-total-time');
            if (totalTimeEl) {
                const duration = musicPlayer.audioElement ? musicPlayer.audioElement.duration : 0;
                if (duration && !isNaN(duration) && duration > 0) {
                    totalTimeEl.textContent = formatMusicTime(duration);
                } else {
                    totalTimeEl.textContent = '0:00';
                }
            }

            // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
            const currentTimeEl = document.getElementById('modal-current-time');
            if (currentTimeEl) {
                const currentTime = musicPlayer.audioElement ? musicPlayer.audioElement.currentTime : 0;
                if (currentTime && !isNaN(currentTime) && currentTime >= 0) {
                    currentTimeEl.textContent = formatMusicTime(currentTime);
                } else {
                    currentTimeEl.textContent = '0:00';
                }
            }

            // æ›´æ–°è¿›åº¦æ¡
            const progressFill = document.getElementById('modal-progress');
            if (progressFill && musicPlayer.audioElement) {
                const currentTime = musicPlayer.audioElement.currentTime || 0;
                const duration = musicPlayer.audioElement.duration || 0;
                if (duration > 0) {
                    const progress = (currentTime / duration) * 100;
                    progressFill.style.width = `${progress}%`;
                }
            }

            // æ›´æ–°å¬æ­Œæ—¶é—´æ˜¾ç¤º
            updateListeningTime();

            // æ›´æ–°å”±ç‰‡æœºå°é¢
            updateVinylCover();

            // æ›´æ–°æ­Œè¯
            updateLyrics();

            // æ›´æ–°æ’­æ”¾å™¨èƒŒæ™¯è‰²
            updatePlayerBackground();
        }

        // ç‚¹å‡»æ­Œè¯è·³è½¬åˆ°å¯¹åº”æ—¶é—´
        function seekToLyric(lyricIndex) {
            if (!musicPlayer.audioElement || !musicPlayer.currentSong || !musicPlayer.currentSong.lyrics) {
                return;
            }

            const totalDuration = musicPlayer.audioElement.duration;
            const lyricsCount = musicPlayer.currentSong.lyrics.length;

            if (totalDuration && lyricsCount > 0) {
                // ä½¿ç”¨ä¸æ­Œè¯åŒæ­¥ç›¸åŒçš„ç®—æ³•è®¡ç®—æ—¶é—´
                const introTime = Math.min(totalDuration * 0.03, 5);
                const outroTime = totalDuration * 0.02;
                const lyricsTime = totalDuration - introTime - outroTime;

                let targetTime;
                if (lyricIndex === 0) {
                    targetTime = introTime;
                } else if (lyricIndex === lyricsCount - 1) {
                    targetTime = totalDuration - outroTime;
                } else {
                    const lyricsProgress = lyricIndex / lyricsCount;
                    targetTime = introTime + (lyricsProgress * lyricsTime);
                }

                // è·³è½¬åˆ°ç›®æ ‡æ—¶é—´
                musicPlayer.audioElement.currentTime = Math.min(Math.max(targetTime, 0), totalDuration);
                musicPlayer.currentTime = targetTime;
                musicPlayer.currentLyricIndex = lyricIndex;

                // æ›´æ–°æ˜¾ç¤º
                updateLyrics();


            }
        }

        // æ ¼å¼åŒ–éŸ³ä¹æ’­æ”¾æ—¶é—´ï¼ˆç§’æ•°è½¬æ¢ä¸ºåˆ†:ç§’æ ¼å¼ï¼‰
        function formatMusicTime(seconds) {
            if (!seconds || isNaN(seconds) || seconds <= 0) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // å¼€å§‹å¬æ­Œè®¡æ—¶
        function startListeningTimer() {
            if (musicPlayer.listeningTimer) {
                clearInterval(musicPlayer.listeningTimer);
            }

            musicPlayer.listeningTimer = setInterval(() => {
                if (musicPlayer.isPlaying && musicPlayer.isActive) {
                    musicPlayer.totalListeningTime += 1; // æŒ‰ç§’è®¡ç®—
                    updateListeningTime(); // ä½¿ç”¨ç»Ÿä¸€çš„æ›´æ–°å‡½æ•°
                }
            }, 1000);
        }

        // æš‚åœå¬æ­Œè®¡æ—¶ï¼ˆä¸é‡ç½®æ—¶é•¿ï¼‰
        function pauseListeningTimer() {
            if (musicPlayer.listeningTimer) {
                clearInterval(musicPlayer.listeningTimer);
                musicPlayer.listeningTimer = null;
            }
        }

        // åœæ­¢å¬æ­Œè®¡æ—¶å¹¶é‡ç½®æ—¶é•¿
        function stopListeningTimer() {
            if (musicPlayer.listeningTimer) {
                clearInterval(musicPlayer.listeningTimer);
                musicPlayer.listeningTimer = null;
            }
            // é‡ç½®å¬æ­Œæ—¶é•¿
            musicPlayer.totalListeningTime = 0;
        }

        // è·å–å½“å‰éŸ³ä¹æ’­æ”¾çŠ¶æ€ï¼ˆä¾›AIè§’è‰²ä½¿ç”¨ï¼‰
        function getMusicPlayingStatus(characterId) {
            if (!musicPlayer.isActive || musicPlayer.activeChatId !== characterId) {
                return null;
            }

            const minutes = Math.floor(musicPlayer.totalListeningTime / 60);
            const seconds = musicPlayer.totalListeningTime % 60;

            // è·å–å½“å‰æ­Œè¯ä¿¡æ¯
            let lyricsInfo = null;
            if (musicPlayer.currentSong && musicPlayer.currentSong.lyrics) {
                const lyrics = musicPlayer.currentSong.lyrics;
                const currentLyricIndex = musicPlayer.currentLyricIndex || 0;

                // å¦‚æœæœ‰æ—¶é—´åŒæ­¥æ­Œè¯ï¼Œè·å–å½“å‰æ’­æ”¾ä½ç½®çš„æ­Œè¯
                let currentLyric = lyrics[currentLyricIndex] || lyrics[0] || 'â™ª æš‚æ— æ­Œè¯';

                // å¦‚æœæœ‰æ—¶é—´åŒæ­¥ä¿¡æ¯ä¸”æ­£åœ¨æ’­æ”¾ï¼Œæ ¹æ®å½“å‰æ—¶é—´è·å–å‡†ç¡®çš„æ­Œè¯
                if (musicPlayer.currentSong.hasTimedLyrics &&
                    musicPlayer.currentSong.lyricsTimings &&
                    musicPlayer.audioElement &&
                    !musicPlayer.audioElement.paused) {

                    const currentTime = musicPlayer.audioElement.currentTime;
                    const timings = musicPlayer.currentSong.lyricsTimings;

                    // æ‰¾åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„æ­Œè¯ç´¢å¼•
                    let newIndex = 0;
                    for (let i = 0; i < timings.length; i++) {
                        if (currentTime >= timings[i]) {
                            newIndex = i;
                        } else {
                            break;
                        }
                    }
                    currentLyric = lyrics[newIndex] || currentLyric;
                }

                lyricsInfo = {
                    hasLyrics: true,
                    currentLyric: currentLyric,
                    allLyrics: lyrics,
                    hasTimedLyrics: musicPlayer.currentSong.hasTimedLyrics || false,
                    totalLines: lyrics.length
                };
            }

            return {
                isPlaying: musicPlayer.isPlaying,
                isListening: musicPlayer.isActive,
                currentSong: musicPlayer.currentSong ? {
                    title: musicPlayer.currentSong.title,
                    artist: musicPlayer.currentSong.artist,
                    album: musicPlayer.currentSong.album,
                    lyrics: lyricsInfo  // ğŸ”¥ã€æ–°å¢ã€‘æ­Œè¯ä¿¡æ¯
                } : null,
                listeningDuration: {
                    minutes: minutes,
                    seconds: seconds,
                    total: musicPlayer.totalListeningTime,
                    formatted: `${minutes}åˆ†${seconds}ç§’`
                }
            };
        }



        // æ›´æ–°æ­Œè¯æ˜¾ç¤º
        function updateLyrics() {
            const currentLyricText = document.getElementById('current-lyric-text');



            if (!musicPlayer.currentSong || !musicPlayer.currentSong.lyrics || musicPlayer.currentSong.lyrics.length === 0) {
                // æ²¡æœ‰æ­Œè¯æ—¶æ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
                if (currentLyricText) {
                    currentLyricText.textContent = musicPlayer.isPlaying ? 'â™ª æ­£åœ¨æ’­æ”¾' : 'â™ª ç‚¹å‡»æ’­æ”¾å¼€å§‹å¬æ­Œ';
                }

                // æ›´æ–°çµåŠ¨å²›æ­Œè¯æ˜¾ç¤º
                const dynamicIslandLyric = document.getElementById('current-lyric');
                if (dynamicIslandLyric) {
                    dynamicIslandLyric.textContent = musicPlayer.isPlaying ? 'â™ª æ­£åœ¨æ’­æ”¾' : 'â™ª ç‚¹å‡»å¼€å§‹å¬æ­Œ';
                }
                return;
            }

            const lyrics = musicPlayer.currentSong.lyrics;
            let currentIndex = musicPlayer.currentLyricIndex;

            // å¦‚æœæœ‰æ—¶é—´åŒæ­¥ä¿¡æ¯ï¼Œæ ¹æ®å½“å‰æ’­æ”¾æ—¶é—´è®¡ç®—æ­Œè¯ç´¢å¼•
            if (musicPlayer.currentSong.hasTimedLyrics &&
                musicPlayer.currentSong.lyricsTimings &&
                musicPlayer.audioElement &&
                !musicPlayer.audioElement.paused) {

                const currentTime = musicPlayer.audioElement.currentTime;
                const timings = musicPlayer.currentSong.lyricsTimings;

                // æ‰¾åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„æ­Œè¯ç´¢å¼•
                let newIndex = 0;
                for (let i = 0; i < timings.length; i++) {
                    if (currentTime >= timings[i]) {
                        newIndex = i;
                    } else {
                        break;
                    }
                }

                currentIndex = newIndex;
                musicPlayer.currentLyricIndex = currentIndex;
            }

            const currentLyric = lyrics[currentIndex] || 'â™ª';

            // æ›´æ–°æ–°çš„å½“å‰æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ
            if (currentLyricText) {
                currentLyricText.textContent = currentLyric;
            }

            // æ›´æ–°çµåŠ¨å²›æ­Œè¯æ˜¾ç¤º
            const dynamicIslandLyric = document.getElementById('current-lyric');
            if (dynamicIslandLyric) {
                dynamicIslandLyric.textContent = currentLyric;
            }

            // æ›´æ–°å”±ç‰‡æœºæ¨¡å¼çš„æ­Œè¯ - åªæ˜¾ç¤ºå½“å‰ä¸€å¥
            const currentEl = document.getElementById('lyric-current');
            if (currentEl) {
                currentEl.textContent = currentLyric;
            }

            // æ›´æ–°å®Œæ•´æ­Œè¯æ¨¡å¼å¹¶å®ç°æ»šåŠ¨
            const fullLyricsEl = document.getElementById('full-lyrics-display');
            if (fullLyricsEl) {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“æ­Œè¯åˆ—è¡¨
                const existingLines = fullLyricsEl.querySelectorAll('.lyric-line');
                if (existingLines.length !== lyrics.length) {
                    // é‡æ–°æ¸²æŸ“æ­Œè¯åˆ—è¡¨
                    const newHTML = lyrics.map((lyric, index) => {
                        const isEmpty = lyric.trim() === '';
                        return `<div class="lyric-line ${isEmpty ? 'empty' : ''}" data-index="${index}" onclick="seekToLyric(${index})">${lyric || '&nbsp;'}</div>`;
                    }).join('');
                    fullLyricsEl.innerHTML = newHTML;
                }

                // æ›´æ–°æ´»è·ƒçŠ¶æ€
                const allLines = fullLyricsEl.querySelectorAll('.lyric-line');
                allLines.forEach((line, index) => {
                    line.classList.toggle('active', index === currentIndex);
                });

                // ä½¿ç”¨transformå®ç°å¹³æ»‘æ»šåŠ¨ - åªåœ¨æ­Œè¯æ¨¡å¼ä¸‹æ‰§è¡Œ
                if (!musicPlayer.isVinylMode) {
                    const container = document.querySelector('.full-lyrics-container');
                    const lyricsMode = document.getElementById('lyrics-mode');

                    if (container && lyricsMode && lyricsMode.style.display !== 'none') {
                        const activeLyricEl = fullLyricsEl.querySelector('.lyric-line.active');
                        if (activeLyricEl && currentIndex >= 0) {
                            const containerHeight = container.clientHeight;

                          // è°ƒæ•´ä½ç½®è®©æ­Œè¯å†é ä¸Šä¸€ç‚¹ï¼šä½¿ç”¨1/3ä½ç½®
                            const offset = (containerHeight / 3) - activeLyricEl.offsetTop - (activeLyricEl.offsetHeight / 2);

                            // ä½¿ç”¨transformå®ç°å¹³æ»‘æ»šåŠ¨
                            fullLyricsEl.style.transform = `translateY(${offset}px)`;
                        }
                    }
                }
            }
        }

        // æ¨¡æ‹Ÿæ’­æ”¾è¿›åº¦
        function startPlaybackSimulation() {
            if (!musicPlayer.isPlaying) return;

            const interval = setInterval(() => {
                if (!musicPlayer.isPlaying) {
                    clearInterval(interval);
                    return;
                }

                // å¦‚æœæœ‰çœŸå®éŸ³é¢‘ï¼Œä½¿ç”¨éŸ³é¢‘çš„å½“å‰æ—¶é—´
                if (musicPlayer.audioElement && !musicPlayer.audioElement.paused) {
                    musicPlayer.currentTime = Math.floor(musicPlayer.audioElement.currentTime);
                    const totalTime = musicPlayer.audioElement.duration || 300;

                    // æ›´æ–°è¿›åº¦æ¡
                    const progress = (musicPlayer.currentTime / totalTime) * 100;
                    document.getElementById('modal-progress').style.width = `${Math.min(progress, 100)}%`;

                    // æ£€æŸ¥æ˜¯å¦ç»“æŸ
                    if (musicPlayer.audioElement.ended) {
                        clearInterval(interval);
                        if (musicPlayer.repeatMode === 'one') {
                            musicPlayer.audioElement.currentTime = 0;
                            musicPlayer.audioElement.play();
                        } else if (musicPlayer.repeatMode === 'all' || musicPlayer.repeatMode === 'none') {
                            nextTrack();
                        }
                        return;
                    }
                } else {
                    // æ¨¡æ‹Ÿæ’­æ”¾
                    musicPlayer.currentTime += 1;
                    const totalTime = 300; // å‡è®¾æ­Œæ›²5åˆ†é’Ÿ

                    // æ›´æ–°è¿›åº¦æ¡
                    const progress = (musicPlayer.currentTime / totalTime) * 100;
                    const progressBar = document.getElementById('modal-progress');
                    if (progressBar) {
                        progressBar.style.width = `${Math.min(progress, 100)}%`;
                    }

                    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                    const currentTimeEl = document.getElementById('modal-current-time');
                    const totalTimeEl = document.getElementById('modal-total-time');
                    if (currentTimeEl) currentTimeEl.textContent = formatMusicTime(musicPlayer.currentTime);
                    if (totalTimeEl) totalTimeEl.textContent = formatMusicTime(totalTime);

                    // æ­Œæ›²ç»“æŸï¼Œè‡ªåŠ¨ä¸‹ä¸€é¦–
                    if (musicPlayer.currentTime >= totalTime) {
                        clearInterval(interval);
                        switch (musicPlayer.playMode) {
                            case 'loop-one':
                                musicPlayer.currentTime = 0;
                                startPlaybackSimulation();
                                break;
                            case 'loop-all':
                            case 'shuffle':
                                nextTrack();
                                break;
                            case 'sequential':
                                // é¡ºåºæ’­æ”¾ï¼Œåˆ°æœ€åä¸€é¦–å°±åœæ­¢
                                if (musicPlayer.currentIndex < musicPlayer.playlist.length - 1) {
                                    nextTrack();
                                } else {
                                    musicPlayer.isPlaying = false;
                                    updateMusicDisplay();
                                }
                                break;
                        }
                        return;
                    }
                }

                // æ—¶é—´æ˜¾ç¤ºç”±timeupdateäº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œä¸é‡å¤æ›´æ–°

                // æ›´æ–°æ­Œè¯
                if (musicPlayer.currentSong && musicPlayer.currentSong.lyrics && musicPlayer.currentSong.lyrics.length > 0) {
                    let newLyricIndex = 0;

                    // å¦‚æœæœ‰æ—¶é—´åŒæ­¥ä¿¡æ¯ï¼Œä½¿ç”¨ç²¾ç¡®çš„æ—¶é—´åŒæ­¥
                    if (musicPlayer.currentSong.hasTimedLyrics && musicPlayer.currentSong.lyricsTimings) {
                        const currentTime = musicPlayer.audioElement ? musicPlayer.audioElement.currentTime : musicPlayer.currentTime;
                        const timings = musicPlayer.currentSong.lyricsTimings;

                        const adjustedTime = currentTime;

                        // æ‰¾åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„æ­Œè¯ç´¢å¼•
                        for (let i = 0; i < timings.length; i++) {
                            if (adjustedTime >= timings[i]) {
                                newLyricIndex = i;
                            } else {
                                break;
                            }
                        }
                    } else {
                        // ä½¿ç”¨ç®€åŒ–ç®—æ³•ï¼ˆå¹³å‡åˆ†é…æ—¶é—´ï¼‰
                        const totalDuration = musicPlayer.audioElement ? musicPlayer.audioElement.duration : 300;
                        const lyricsCount = musicPlayer.currentSong.lyrics.length;
                        const currentTime = musicPlayer.currentTime;

                        if (totalDuration > 0 && lyricsCount > 0) {
                            const timePerLyric = totalDuration / lyricsCount;
                            const adjustedTime = currentTime;
                            newLyricIndex = Math.min(
                                Math.max(Math.floor(adjustedTime / timePerLyric), 0),
                                lyricsCount - 1
                            );
                        }
                    }

                    // æ›´æ–°æ­Œè¯ç´¢å¼•
                    if (newLyricIndex !== musicPlayer.currentLyricIndex) {
                        musicPlayer.currentLyricIndex = newLyricIndex;
                        updateLyrics();
                    }
                }
            }, musicPlayer.currentSong && musicPlayer.currentSong.hasTimedLyrics ? 200 : 500); // æœ‰æ—¶é—´åŒæ­¥æ—¶æ›´é¢‘ç¹æ›´æ–°
        }

        // è·å–å½“å‰è§’è‰²åç§°
        function getCurrentCharacterName() {
            if (currentChatCharacter) {
                return currentChatCharacter.name;
            }
            return 'ä½ ';
        }

        // æ›´æ–°å¬æ­Œæ—¶é•¿æ˜¾ç¤º
        function updateListeningTime() {
            const duration = document.getElementById('listening-duration');
            if (duration && musicPlayer.isActive) {
                const minutes = Math.floor(musicPlayer.totalListeningTime / 60);

                // è·å–å½“å‰èŠå¤©è§’è‰²åç§°ï¼ˆæ¢å¤è‡ªåŠ¨åˆ‡æ¢åŠŸèƒ½ï¼‰
                let characterName = 'ä½ ';
                if (currentChatCharacter) {
                    characterName = currentChatCharacter.name;
                }

                const displayText = `å·²ä¸€èµ·å¬ ${minutes} åˆ†é’Ÿ`;
                duration.textContent = displayText;

                // ä¸å†ä¿å­˜åˆ° localStorageï¼ˆæ¯æ¬¡é‡æ–°è®¡æ—¶ï¼‰
            }
        }

        // ç‚¹å‡»çŠ¶æ€æ éŸ³ä¹åŒºåŸŸæ‰“å¼€æ¨¡æ€æ¡†
        function openMusicModal() {
            openMusicPlayer();
        }

        // æå–å›¾ç‰‡ä¸»è‰²è°ƒ
        function extractImageColors(imageElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = 50;
                canvas.height = 50;

                ctx.drawImage(imageElement, 0, 0, 50, 50);

                const imageData = ctx.getImageData(0, 0, 50, 50);
                const data = imageData.data;

                let r = 0, g = 0, b = 0;
                let pixelCount = 0;

                for (let i = 0; i < data.length; i += 4) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    pixelCount++;
                }

                r = Math.floor(r / pixelCount);
                g = Math.floor(g / pixelCount);
                b = Math.floor(b / pixelCount);

                resolve({ r, g, b });
            });
        }

        // æ›´æ–°æ’­æ”¾å™¨èƒŒæ™¯è‰²
        function updatePlayerBackground() {
            const modal = document.getElementById('music-modal');
            const modalContent = document.querySelector('.music-modal-content');
            const albumCoverImg = document.getElementById('album-cover');

            if (albumCoverImg && albumCoverImg.src && !albumCoverImg.src.includes('data:image/svg') && albumCoverImg.style.display !== 'none') {
                // å¦‚æœæœ‰å°é¢å›¾ç‰‡ï¼Œæå–ä¸»è‰²è°ƒ
                extractImageColors(albumCoverImg).then(colors => {
                    const { r, g, b } = colors;

                    // åˆ›å»ºåŸºäºå°é¢çš„æ¯›ç»ç’ƒæ•ˆæœ
                    const bgColor = `rgba(${r}, ${g}, ${b}, 0.3)`;

                    if (modalContent) {
                        modalContent.style.background = bgColor;
                        modalContent.style.backdropFilter = 'blur(30px) saturate(1.5)';
                        modalContent.style.webkitBackdropFilter = 'blur(30px) saturate(1.5)';
                    }
                });
            } else {
                // é»˜è®¤é›¾éœ¾ç°æ¯›ç»ç’ƒæ•ˆæœ
                if (modalContent) {
                    modalContent.style.background = 'rgba(200, 200, 200, 0.25)';
                    modalContent.style.backdropFilter = 'blur(30px) saturate(1.5)';
                    modalContent.style.webkitBackdropFilter = 'blur(30px) saturate(1.5)';
                }
            }
        }

        // åˆ‡æ¢æ’­æ”¾æ¨¡å¼
        function togglePlayMode() {
            // æ’­æ”¾æ¨¡å¼: sequential(é¡ºåº) -> loop-all(åˆ—è¡¨å¾ªç¯) -> loop-one(å•æ›²å¾ªç¯) -> shuffle(éšæœº)
            const modes = ['sequential', 'loop-all', 'loop-one', 'shuffle'];
            const currentIndex = modes.indexOf(musicPlayer.playMode || 'sequential');
            const nextIndex = (currentIndex + 1) % modes.length;
            musicPlayer.playMode = modes[nextIndex];

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            updatePlayModeButton();
        }



        // æ›´æ–°æ’­æ”¾æ¨¡å¼æŒ‰é’®æ˜¾ç¤º
        function updatePlayModeButton() {
            const btn = document.getElementById('play-mode-btn');
            const icon = btn.querySelector('i');

            switch (musicPlayer.playMode) {
                case 'sequential':
                    icon.className = 'fas fa-list-ol';
                    btn.title = 'é¡ºåºæ’­æ”¾';
                    btn.classList.remove('active');
                    // ç§»é™¤æ•°å­—æ˜¾ç¤º
                    const numberEl1 = btn.querySelector('.loop-number');
                    if (numberEl1) numberEl1.remove();
                    break;
                case 'loop-all':
                    icon.className = 'fas fa-redo';
                    btn.title = 'åˆ—è¡¨å¾ªç¯';
                    btn.classList.remove('active');
                    // ç§»é™¤æ•°å­—æ˜¾ç¤º
                    const numberEl2 = btn.querySelector('.loop-number');
                    if (numberEl2) numberEl2.remove();
                    break;
                case 'loop-one':
                    icon.className = 'fas fa-repeat';
                    btn.title = 'å•æ›²å¾ªç¯';
                    btn.classList.remove('active');
                    // æ·»åŠ æ•°å­—1çš„æ˜¾ç¤º
                    if (!btn.querySelector('.loop-number')) {
                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'loop-number';
                        numberSpan.textContent = '1';
                        btn.appendChild(numberSpan);
                    }
                    break;
                case 'shuffle':
                    icon.className = 'fas fa-random';
                    btn.title = 'éšæœºæ’­æ”¾';
                    btn.classList.remove('active');
                    // ç§»é™¤æ•°å­—æ˜¾ç¤º
                    const numberEl3 = btn.querySelector('.loop-number');
                    if (numberEl3) numberEl3.remove();
                    break;
            }
        }

        // åˆ‡æ¢å¾ªç¯æ’­æ”¾
        function toggleRepeat() {
            const modes = ['none', 'one', 'all'];
            const currentIndex = modes.indexOf(musicPlayer.repeatMode || 'none');
            const nextIndex = (currentIndex + 1) % modes.length;
            musicPlayer.repeatMode = modes[nextIndex];

            const repeatBtn = document.getElementById('repeat-btn');
            const icons = {
                'none': 'fas fa-redo',
                'one': 'fas fa-redo-alt',
                'all': 'fas fa-redo'
            };

            repeatBtn.innerHTML = `<i class="${icons[musicPlayer.repeatMode]}"></i>`;
            repeatBtn.classList.toggle('active', musicPlayer.repeatMode !== 'none');

            // æ˜¾ç¤ºæç¤º
            const modeNames = {
                'sequential': 'é¡ºåºæ’­æ”¾',
                'loop': 'å•æ›²å¾ªç¯',
                'random': 'éšæœºæ’­æ”¾'
            };
            console.log(`åˆ‡æ¢åˆ°: ${modeNames[musicPlayer.playMode]}`);
        }

        // æ‰“å¼€æ’­æ”¾åˆ—è¡¨æ¨¡æ€æ¡†
        function openPlaylistModal() {
            const modal = document.getElementById('playlist-modal');
            if (modal) {
                modal.style.display = 'flex';
                loadPlaylistItems();
            }
        }

        // å…³é—­æ’­æ”¾åˆ—è¡¨æ¨¡æ€æ¡†
        function closePlaylistModal() {
            const modal = document.getElementById('playlist-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // åŠ è½½æ’­æ”¾åˆ—è¡¨é¡¹ç›®
        async function loadPlaylistItems() {
            try {
                const playlistItems = await db.musicPlaylist.orderBy('addedTime').toArray();
                const container = document.getElementById('playlist-items');

                if (!container) return;

                container.innerHTML = '';

                if (playlistItems.length === 0) {
                    container.innerHTML = `
                        <div class="playlist-empty">
                            <i class="fas fa-music"></i>
                            <div>æš‚æ— æ­Œæ›²</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">æ·»åŠ ä¸€äº›æ­Œæ›²å¼€å§‹äº«å—éŸ³ä¹å§</div>
                        </div>
                    `;
                    return;
                }

                playlistItems.forEach((song, index) => {
                    const songElement = document.createElement('div');
                    songElement.className = 'playlist-item-modern';

                    songElement.innerHTML = `
                        <div class="song-number">${index + 1}</div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                        <div class="song-actions">
                            <button class="play-btn" title="æ’­æ”¾" data-song-id="${song.id}">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick="removeSongFromPlaylist('${song.id}')"
                                    class="delete-btn" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    // æ·»åŠ æ’­æ”¾æŒ‰é’®äº‹ä»¶ç›‘å¬
                    const playBtn = songElement.querySelector('.play-btn');
                    playBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        playSongFromPlaylist(song);
                    });

                    container.appendChild(songElement);
                });
            } catch (error) {
                console.error('åŠ è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥:', error);
            }
        }



        // æ·»åŠ è‡ªå®šä¹‰æ­Œæ›²åˆ°æ’­æ”¾åˆ—è¡¨
        async function addCustomSong() {
            const urlInput = document.getElementById('song-url-input');
            const titleInput = document.getElementById('song-title-input');
            const artistInput = document.getElementById('song-artist-input');
            const coverInput = document.getElementById('song-cover-input');
            const localMusicInput = document.getElementById('local-music-input');
            const lyricsFileInput = document.getElementById('lyrics-file-input');

            let url = urlInput.value.trim();
            const title = titleInput.value.trim();
            const artist = artistInput.value.trim();
            let isLocalFile = false;

            // ğŸ”¥ã€ä¿®å¤å†…å­˜æ³„æ¼ã€‘æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æœ¬åœ°éŸ³ä¹æ–‡ä»¶ - ä¼˜åŒ–å†…å­˜ä½¿ç”¨
            if (localMusicInput.files && localMusicInput.files[0]) {
                const audioFile = localMusicInput.files[0];

                try {
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¯¹äºå°æ–‡ä»¶ï¼ˆ<10MBï¼‰ä½¿ç”¨base64ï¼Œå¤§æ–‡ä»¶ä½¿ç”¨blob URL
                    if (audioFile.size < 10 * 1024 * 1024) {
                        // å°æ–‡ä»¶ï¼šè½¬æ¢ä¸ºbase64æ ¼å¼å­˜å‚¨
                        url = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(audioFile);
                        });
                        console.log('ğŸµ å°æ–‡ä»¶å·²è½¬æ¢ä¸ºbase64æ ¼å¼');
                    } else {
                        // å¤§æ–‡ä»¶ï¼šåˆ›å»ºblob URLï¼ˆæ³¨æ„ï¼šè¿™ä¸ªURLåœ¨é¡µé¢åˆ·æ–°åä¼šå¤±æ•ˆï¼‰
                        url = URL.createObjectURL(audioFile);
                        console.log('ğŸµ å¤§æ–‡ä»¶å·²åˆ›å»ºblob URL');
                        alert('æ³¨æ„ï¼šå¤§æ–‡ä»¶åœ¨é¡µé¢åˆ·æ–°åéœ€è¦é‡æ–°æ·»åŠ ');
                    }
                    isLocalFile = true;
                } catch (error) {
                    console.error('å¤„ç†æœ¬åœ°éŸ³ä¹æ–‡ä»¶å¤±è´¥:', error);
                    alert('å¤„ç†æœ¬åœ°éŸ³ä¹æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }

                // å¦‚æœæ²¡æœ‰å¡«å†™æ ‡é¢˜ï¼Œä½¿ç”¨æ–‡ä»¶å
                if (!title) {
                    titleInput.value = audioFile.name.replace(/\.[^/.]+$/, "");
                }
            }

            if (!url || !titleInput.value.trim() || !artist) {
                alert('è¯·å¡«å†™å®Œæ•´çš„æ­Œæ›²ä¿¡æ¯æˆ–é€‰æ‹©æœ¬åœ°éŸ³ä¹æ–‡ä»¶');
                return;
            }

            try {
                const songId = Date.now().toString();
                let coverImageId = null;

                // å¤„ç†å°é¢ä¸Šä¼ 
                if (coverInput.files && coverInput.files[0]) {
                    const file = coverInput.files[0];
                    const reader = new FileReader();

                    await new Promise((resolve, reject) => {
                        reader.onload = async (e) => {
                            try {
                                coverImageId = `cover_${songId}`;
                                await db.musicCovers.add({
                                    id: coverImageId,
                                    songId: songId,
                                    imageData: e.target.result,
                                    timestamp: Date.now()
                                });
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }

                // å¤„ç†æ­Œè¯æ–‡ä»¶
                let lyricsArray = [];

                // æ£€æŸ¥æ˜¯å¦ä¸Šä¼ äº†æ­Œè¯æ–‡ä»¶
                if (lyricsFileInput.files && lyricsFileInput.files[0]) {
                    const lyricsFile = lyricsFileInput.files[0];
                    const fileName = lyricsFile.name.toLowerCase();

                    if (fileName.endsWith('.lrc')) {
                        // LRCæ ¼å¼æ­Œè¯
                        const lrcContent = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsText(lyricsFile, 'utf-8');
                        });
                        const lrcResult = parseLRC(lrcContent);
                        lyricsArray = lrcResult.lyrics;
                        // ä¿å­˜æ—¶é—´ä¿¡æ¯åˆ°æ­Œæ›²æ•°æ®ä¸­
                        if (lrcResult.hasTimings) {
                            window.tempLyricsTimings = lrcResult.timings;
                        }
                    } else if (fileName.endsWith('.bin')) {
                        // binæ ¼å¼æ­Œè¯
                        const binData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsArrayBuffer(lyricsFile);
                        });
                        const binResult = parseNeteaseBin(binData);
                        lyricsArray = binResult.lyrics;
                        if (binResult.hasTimings) {
                            window.tempLyricsTimings = binResult.timings;
                        }
                    } else {
                        // å…¶ä»–æ–‡æœ¬æ ¼å¼ï¼Œå°è¯•ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
                        const textContent = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsText(lyricsFile, 'utf-8');
                        });
                        lyricsArray = textContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    }
                }

                // å¦‚æœæ²¡æœ‰æ­Œè¯ï¼Œä½¿ç”¨é»˜è®¤æ­Œè¯
                if (lyricsArray.length === 0) {
                    lyricsArray = ['â™ª æš‚æ— æ­Œè¯'];
                }



                // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ æ­Œæ›²åˆ°æ•°æ®åº“ - åŒ…å«isLocalFileå­—æ®µ
                await db.musicPlaylist.add({
                    id: songId,
                    title: titleInput.value.trim(),
                    artist: artist,
                    album: '',
                    duration: '0:00',
                    url: url,
                    isLocalFile: isLocalFile, // ğŸ”¥ã€æ–°å¢ã€‘æ ‡è¯†æ˜¯å¦ä¸ºæœ¬åœ°æ–‡ä»¶
                    coverImage: coverImageId,
                    lyrics: lyricsArray,
                    lyricsTimings: window.tempLyricsTimings || [],
                    hasTimedLyrics: !!(window.tempLyricsTimings && window.tempLyricsTimings.length > 0),
                    addedTime: Date.now()
                });

                // æ¸…ç†ä¸´æ—¶å˜é‡
                delete window.tempLyricsTimings;

                // æ¸…ç©ºè¾“å…¥æ¡†
                urlInput.value = '';
                titleInput.value = '';
                artistInput.value = '';
                coverInput.value = '';
                localMusicInput.value = '';
                lyricsFileInput.value = '';

                // é‡ç½®æ­Œè¯æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                const lyricsStatus = document.getElementById('lyrics-file-status');
                if (lyricsStatus) {
                    lyricsStatus.style.display = 'none';
                }

                // é‡ç½®æ–‡ä»¶é€‰æ‹©æ¡†æ˜¾ç¤ºæ–‡å­—
                const fileText = document.querySelector('.file-input-text');
                if (fileText) {
                    fileText.textContent = 'æœªé€‰å°é¢';
                }

                // é‡æ–°åŠ è½½æ’­æ”¾åˆ—è¡¨
                await loadPlaylistItems();

                alert('æ­Œæ›²æ·»åŠ æˆåŠŸï¼');
            } catch (error) {
                console.error('æ·»åŠ æ­Œæ›²å¤±è´¥:', error);
                alert('æ·»åŠ æ­Œæ›²å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä»æ’­æ”¾åˆ—è¡¨åˆ é™¤æ­Œæ›²
        async function removeSongFromPlaylist(songId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é¦–æ­Œæ›²å—ï¼Ÿ')) {
                return;
            }

            try {
                // åˆ é™¤æ­Œæ›²
                await db.musicPlaylist.delete(songId);

                // åˆ é™¤ç›¸å…³å°é¢
                const coverRecord = await db.musicCovers.where('songId').equals(songId).first();
                if (coverRecord) {
                    await db.musicCovers.delete(coverRecord.id);
                }

                // é‡æ–°åŠ è½½æ’­æ”¾åˆ—è¡¨
                await loadPlaylistItems();

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²ï¼Œåœæ­¢æ’­æ”¾
                if (musicPlayer.currentSong && musicPlayer.currentSong.id === songId) {
                    musicPlayer.currentSong = null;
                    musicPlayer.isPlaying = false;
                    updateMusicDisplay();
                }
            } catch (error) {
                console.error('åˆ é™¤æ­Œæ›²å¤±è´¥:', error);
                alert('åˆ é™¤æ­Œæ›²å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä»æ’­æ”¾åˆ—è¡¨æ’­æ”¾æ­Œæ›²
        async function playSongFromPlaylist(song) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•ï¼Œç¡®ä¿åˆ‡æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const songIndex = musicPlayer.playlist.findIndex(item => item.id === song.id);
                if (songIndex !== -1) {
                    musicPlayer.currentIndex = songIndex;
                }

                // è·å–å°é¢å›¾ç‰‡
                let coverImageData = null;
                if (song.coverImage) {
                    const coverRecord = await db.musicCovers.get(song.coverImage);
                    if (coverRecord) {
                        coverImageData = coverRecord.imageData;
                    }
                }

                // ğŸ”¥ã€ä¿®å¤å†…å­˜æ³„æ¼ã€‘æ­£ç¡®æ¸…ç†å½“å‰éŸ³é¢‘
                if (musicPlayer.audioElement) {
                    musicPlayer.audioElement.pause();
                    // æ¸…ç†éŸ³é¢‘æºï¼Œé‡Šæ”¾å†…å­˜
                    musicPlayer.audioElement.src = '';
                    musicPlayer.audioElement.load();
                    // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                    musicPlayer.audioElement.onloadedmetadata = null;
                    musicPlayer.audioElement.onerror = null;
                    musicPlayer.audioElement.onplay = null;
                    musicPlayer.audioElement.onpause = null;
                    musicPlayer.audioElement.onended = null;
                    musicPlayer.audioElement.ontimeupdate = null;
                    musicPlayer.audioElement = null;

                    // å¼ºåˆ¶åƒåœ¾å›æ”¶æç¤º
                    if (window.gc) {
                        window.gc();
                    }
                    console.log('ğŸ§¹ éŸ³é¢‘å¯¹è±¡å·²æ¸…ç†');
                    logMemoryUsage('æ¸…ç†éŸ³é¢‘å¯¹è±¡å');
                }

                // ğŸ”¥ã€ä¿®å¤å†…å­˜æ³„æ¼ã€‘é‡ç”¨éŸ³é¢‘å…ƒç´ ï¼Œé¿å…é‡å¤åˆ›å»º
                if (song.url && song.url.trim() !== '') {
                    // å¦‚æœæ²¡æœ‰éŸ³é¢‘å…ƒç´ ï¼Œæ‰åˆ›å»ºæ–°çš„
                    if (!musicPlayer.audioElement) {
                        musicPlayer.audioElement = new Audio();
                        console.log('ğŸµ åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ ');
                    }

                    const audio = musicPlayer.audioElement;
                    // è®¾ç½®æ–°çš„éŸ³é¢‘æº
                    audio.src = getAudioUrl(song);
                    audio.load(); // é‡æ–°åŠ è½½éŸ³é¢‘

                    audio.addEventListener('loadedmetadata', function() {
                        musicPlayer.totalTime = audio.duration;
                        console.log('æ­Œæ›²åŠ è½½æˆåŠŸï¼Œæ—¶é•¿:', audio.duration);
                        updateMusicDisplay(); // æ›´æ–°æ˜¾ç¤ºä»¥æ˜¾ç¤ºæ­£ç¡®çš„æ—¶é•¿

                        // ç¡®ä¿æ—¶é•¿æ˜¾ç¤ºæ­£ç¡®
                        const totalTimeEl = document.getElementById('modal-total-time');
                        if (totalTimeEl && audio.duration && !isNaN(audio.duration) && audio.duration > 0) {
                            totalTimeEl.textContent = formatMusicTime(audio.duration);
                        }
                    });

                    audio.addEventListener('error', function(e) {
                        // å¦‚æœéŸ³é¢‘å…ƒç´ å·²ç»è¢«æ¸…ç†ï¼ˆsrcä¸ºç©ºï¼‰ï¼Œåˆ™ä¸æ˜¾ç¤ºé”™è¯¯
                        if (!audio.src || audio.src === '' || audio.src === window.location.href) {
                            console.log('éŸ³é¢‘å…ƒç´ å·²è¢«æ¸…ç†ï¼Œå¿½ç•¥é”™è¯¯äº‹ä»¶');
                            return;
                        }
                        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                        musicPlayer.isPlaying = false;
                        updateMusicDisplay();
                        alert('éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ');
                    });

                    audio.addEventListener('play', function() {
                        musicPlayer.isPlaying = true;
                        updateMusicDisplay();
                        startListeningTimer(); // å¼€å§‹è®¡æ—¶
                    });

                    audio.addEventListener('pause', function() {
                        musicPlayer.isPlaying = false;
                        updateMusicDisplay();
                        pauseListeningTimer(); // æš‚åœè®¡æ—¶ï¼ˆä¸é‡ç½®æ—¶é•¿ï¼‰
                    });

                    audio.addEventListener('ended', function() {
                        // æ ¹æ®æ’­æ”¾æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
                        switch (musicPlayer.playMode) {
                            case 'loop-one':
                                // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
                                audio.currentTime = 0;
                                audio.play().catch(console.error);
                                musicPlayer.isPlaying = true;
                                break;
                            case 'sequential':
                                // é¡ºåºæ’­æ”¾ï¼Œå¦‚æœä¸æ˜¯æœ€åä¸€é¦–åˆ™æ’­æ”¾ä¸‹ä¸€é¦–
                                if (musicPlayer.currentIndex < musicPlayer.playlist.length - 1) {
                                    nextTrack();
                                    // nextTrack()å†…éƒ¨å·²ç»å¤„ç†äº†æ’­æ”¾çŠ¶æ€ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                                } else {
                                    // æœ€åä¸€é¦–æ­Œæ’­æ”¾å®Œæ¯•ï¼Œåœæ­¢æ’­æ”¾
                                    musicPlayer.isPlaying = false;
                                }
                                break;
                            case 'loop-all':
                            case 'shuffle':
                                // åˆ—è¡¨å¾ªç¯æˆ–éšæœºæ’­æ”¾ï¼Œç›´æ¥æ’­æ”¾ä¸‹ä¸€é¦–
                                nextTrack();
                                // nextTrack()å†…éƒ¨å·²ç»å¤„ç†äº†æ’­æ”¾çŠ¶æ€ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                                break;
                        }
                        updateMusicDisplay();
                    });

                    audio.addEventListener('timeupdate', function() {
                        musicPlayer.currentTime = audio.currentTime;
                        updateMusicDisplay();

                        // å®æ—¶æ›´æ–°æ—¶é—´æ˜¾ç¤º
                        const currentTimeEl = document.getElementById('modal-current-time');
                        const totalTimeEl = document.getElementById('modal-total-time');

                        if (currentTimeEl && audio.currentTime >= 0) {
                            currentTimeEl.textContent = formatMusicTime(audio.currentTime);
                        }

                        if (totalTimeEl && audio.duration && !isNaN(audio.duration) && audio.duration > 0) {
                            totalTimeEl.textContent = formatMusicTime(audio.duration);
                        }

                        // æ›´æ–°è¿›åº¦æ¡
                        const progressFill = document.getElementById('modal-progress');
                        if (progressFill && audio.duration && audio.duration > 0) {
                            const progress = (audio.currentTime / audio.duration) * 100;
                            progressFill.style.width = `${Math.min(progress, 100)}%`;
                        }
                    });

                    // éŸ³é¢‘å…ƒç´ å·²ç»åœ¨å¼€å¤´è®¾ç½®ï¼Œä¸éœ€è¦é‡å¤èµ‹å€¼
                } else {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç¼ºå°‘URLçš„æƒ…å†µ
                    console.error('æ­Œæ›²ç¼ºå°‘URL:', song);
                    alert('æ­Œæ›²æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·é‡æ–°æ·»åŠ ');
                    return;
                }

                // è®¾ç½®å½“å‰æ­Œæ›²
                musicPlayer.currentSong = {
                    ...song,
                    coverImageData: coverImageData
                };
                musicPlayer.currentTime = 0;
                musicPlayer.currentLyricIndex = 0;
                musicPlayer.isPlaying = false;



                // æ›´æ–°æ˜¾ç¤º
                updateMusicDisplay();

                // å…³é—­æ’­æ”¾åˆ—è¡¨æ¨¡æ€æ¡†
                closePlaylistModal();

                // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                setTimeout(() => {
                    togglePlayback();
                }, 100);

            } catch (error) {
                console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
                alert('æ’­æ”¾æ­Œæ›²å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°å”±ç‰‡æœºå°é¢
        async function updateVinylCover() {
            const albumCoverImg = document.getElementById('album-cover');
            const vinylLabel = document.querySelector('.vinyl-label');

            if (!albumCoverImg || !vinylLabel) return;

            // å¦‚æœå½“å‰æ­Œæ›²æœ‰å°é¢æ•°æ®ï¼Œä½¿ç”¨å®ƒ
            if (musicPlayer.currentSong && musicPlayer.currentSong.coverImageData) {
                albumCoverImg.src = musicPlayer.currentSong.coverImageData;
                albumCoverImg.style.display = 'block';
                vinylLabel.style.background = '#ddd'; // æœ‰å°é¢æ—¶ä½¿ç”¨æµ…ç°è‰²èƒŒæ™¯
            } else {
                // æ²¡æœ‰å°é¢æ—¶éšè—å›¾ç‰‡ï¼Œæ˜¾ç¤ºé»˜è®¤çš„æµ…ç°è‰²èƒŒæ™¯
                albumCoverImg.style.display = 'none';
                vinylLabel.style.background = '#ddd'; // é»˜è®¤æµ…ç°è‰²
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å®‰å…¨çš„éŸ³é¢‘åˆ‡æ¢å‡½æ•° - ç»Ÿä¸€å¤„ç†æ‰€æœ‰åˆ‡æ­Œæ“ä½œ
        async function switchToSong(song, shouldPlay = true) {
            try {
                if (!musicPlayer.audioElement) {
                    console.error('éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨');
                    return false;
                }

                // å…ˆæš‚åœå½“å‰æ’­æ”¾
                musicPlayer.audioElement.pause();

                // æ£€æŸ¥æ­Œæ›²URL
                if (!song.url || song.url.trim() === '') {
                    console.error('æ­Œæ›²ç¼ºå°‘URL:', song);
                    alert('æ­Œæ›²æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·é‡æ–°æ·»åŠ ');
                    return false;
                }

                // è®¾ç½®æ–°çš„éŸ³é¢‘æº - ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿ
                musicPlayer.audioElement.src = getAudioUrl(song);
                musicPlayer.audioElement.load();

                // è¿”å›Promiseï¼Œç­‰å¾…éŸ³é¢‘å‡†å¤‡å°±ç»ª
                return new Promise((resolve) => {
                    const onCanPlay = () => {
                        musicPlayer.audioElement.removeEventListener('canplay', onCanPlay);
                        musicPlayer.audioElement.removeEventListener('error', onError);

                        if (shouldPlay) {
                            musicPlayer.audioElement.play().catch(error => {
                                console.error('æ’­æ”¾å¤±è´¥:', error);
                                musicPlayer.isPlaying = false;
                                updateMusicDisplay();
                                alert(`æ’­æ”¾å¤±è´¥ï¼š${song.title}\n${error.message}`);
                                resolve(false);
                            }).then(() => {
                                musicPlayer.isPlaying = true;
                                updateMusicDisplay();
                                resolve(true);
                            });
                        } else {
                            resolve(true);
                        }
                    };

                    const onError = (e) => {
                        musicPlayer.audioElement.removeEventListener('canplay', onCanPlay);
                        musicPlayer.audioElement.removeEventListener('error', onError);
                        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                        musicPlayer.isPlaying = false;
                        updateMusicDisplay();
                        alert(`éŸ³é¢‘åŠ è½½å¤±è´¥ï¼š${song.title}\nè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ`);
                        resolve(false);
                    };

                    musicPlayer.audioElement.addEventListener('canplay', onCanPlay, { once: true });
                    musicPlayer.audioElement.addEventListener('error', onError, { once: true });
                });

            } catch (error) {
                console.error('åˆ‡æ¢æ­Œæ›²å¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘AIé€‰æ­ŒåŠŸèƒ½ - è®©AIè§’è‰²å¯ä»¥ä¸ºç”¨æˆ·é€‰æ‹©æ­Œæ›²
        async function aiSelectSong(songTitle, characterName) {
            try {
                // æ£€æŸ¥éŸ³ä¹æ’­æ”¾å™¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
                if (!musicPlayer.isActive) {
                    console.log('éŸ³ä¹æ’­æ”¾å™¨æœªæ¿€æ´»ï¼ŒAIæ— æ³•é€‰æ­Œ');
                    return false;
                }

                // ä»æ’­æ”¾åˆ—è¡¨ä¸­æŸ¥æ‰¾æ­Œæ›²
                const song = musicPlayer.playlist.find(item =>
                    item.title.toLowerCase().includes(songTitle.toLowerCase()) ||
                    item.artist.toLowerCase().includes(songTitle.toLowerCase())
                );

                if (!song) {
                    console.log(`AIé€‰æ­Œå¤±è´¥ï¼šæœªæ‰¾åˆ°æ­Œæ›² "${songTitle}"`);
                    return false;
                }

                // æ’­æ”¾é€‰ä¸­çš„æ­Œæ›²
                await playSongFromPlaylist(song);

                // è®°å½•AIé€‰æ­Œäº‹ä»¶åˆ°è·¨åº”ç”¨è®°å¿†ç³»ç»Ÿ
                if (currentChatCharacter) {
                    const memoryEvent = {
                        eventType: 'music_interaction',
                        timestamp: Date.now(),
                        context: {
                            type: 'music_app',
                            id: 'music_player',
                            action: 'ai_select_song',
                            songTitle: song.title,
                            songArtist: song.artist,
                            characterName: characterName || currentChatCharacter.name
                        }
                    };

                    // æ·»åŠ åˆ°è·¨åº”ç”¨è®°å¿†
                    await recordMemoryEvent(
                        [currentChatCharacter.id],
                        {
                            type: 'music_player',
                            id: 'music_player'
                        },
                        'ai_select_song',
                        memoryEvent.data,
                        0.6
                    );
                }

                console.log(`âœ… AIæˆåŠŸé€‰æ‹©æ­Œæ›²ï¼š${song.title} - ${song.artist}`);
                return true;

            } catch (error) {
                console.error('AIé€‰æ­Œå¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘AIéšæœºé€‰æ­ŒåŠŸèƒ½
        async function aiSelectRandomSong(characterName) {
            try {
                // æ£€æŸ¥éŸ³ä¹æ’­æ”¾å™¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
                if (!musicPlayer.isActive || musicPlayer.playlist.length === 0) {
                    console.log('éŸ³ä¹æ’­æ”¾å™¨æœªæ¿€æ´»æˆ–æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼ŒAIæ— æ³•éšæœºé€‰æ­Œ');
                    return false;
                }

                // éšæœºé€‰æ‹©ä¸€é¦–æ­Œæ›²
                const randomIndex = Math.floor(Math.random() * musicPlayer.playlist.length);
                const song = musicPlayer.playlist[randomIndex];

                // æ’­æ”¾é€‰ä¸­çš„æ­Œæ›²
                await playSongFromPlaylist(song);

                // è®°å½•AIé€‰æ­Œäº‹ä»¶
                if (currentChatCharacter) {
                    const memoryEvent = {
                        eventType: 'music_interaction',
                        timestamp: Date.now(),
                        context: {
                            type: 'music_app',
                            id: 'music_player',
                            action: 'ai_random_select',
                            songTitle: song.title,
                            songArtist: song.artist,
                            characterName: characterName || currentChatCharacter.name
                        }
                    };

                    await recordMemoryEvent(
                        [currentChatCharacter.id],
                        {
                            type: 'music_player',
                            id: 'music_player'
                        },
                        'ai_random_select_song',
                        memoryEvent.data,
                        0.6
                    );
                }

                console.log(`âœ… AIéšæœºé€‰æ‹©æ­Œæ›²ï¼š${song.title} - ${song.artist}`);
                return true;

            } catch (error) {
                console.error('AIéšæœºé€‰æ­Œå¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ’­æ”¾åˆ—è¡¨ä¿¡æ¯ä¾›AIå‚è€ƒ
        function getPlaylistForAI() {
            if (!musicPlayer.isActive || musicPlayer.playlist.length === 0) {
                return null;
            }

            return {
                totalSongs: musicPlayer.playlist.length,
                songs: musicPlayer.playlist.map(song => ({
                    title: song.title,
                    artist: song.artist,
                    album: song.album || 'æœªçŸ¥ä¸“è¾‘',
                    hasLyrics: song.lyrics && song.lyrics.length > 0
                })),
                currentSong: musicPlayer.currentSong ? {
                    title: musicPlayer.currentSong.title,
                    artist: musicPlayer.currentSong.artist
                } : null
            };
        }



        // åŠ è½½è‡ªå®šä¹‰æ­Œæ›²
        function loadCustomSong() {
            const urlInput = document.getElementById('song-url');
            const url = urlInput.value.trim();

            if (!url) {
                alert('è¯·è¾“å…¥æ­Œæ›²URL');
                return;
            }

            // åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ 
            if (musicPlayer.audioElement) {
                musicPlayer.audioElement.pause();
                musicPlayer.audioElement = null;
            }

            const audio = new Audio();
            audio.crossOrigin = 'anonymous';

            audio.addEventListener('loadedmetadata', function() {
                musicPlayer.totalTime = audio.duration;
                const minutes = Math.floor(audio.duration / 60);
                const seconds = Math.floor(audio.duration % 60);
                const duration = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // åˆ›å»ºè‡ªå®šä¹‰æ­Œæ›²å¯¹è±¡
                const customSong = {
                    id: 'custom',
                    title: 'è‡ªå®šä¹‰æ­Œæ›²',
                    artist: 'æœªçŸ¥è‰ºæœ¯å®¶',
                    duration: duration,
                    lyrics: ['â™ª æ­£åœ¨æ’­æ”¾è‡ªå®šä¹‰æ­Œæ›²', 'â™ª äº«å—éŸ³ä¹æ—¶å…‰', 'â™ª è®©éŸ³ä¹é™ªä¼´ä½ '],
                    url: url
                };

                musicPlayer.currentSong = customSong;
                musicPlayer.audioElement = audio;
                musicPlayer.currentTime = 0;
                musicPlayer.currentLyricIndex = 0;

                updateMusicDisplay();
                console.log('æ­Œæ›²åŠ è½½æˆåŠŸ');
            });

            audio.addEventListener('error', function() {
                alert('æ­Œæ›²åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®');
            });

            audio.src = url;
            urlInput.value = '';
        }

        // ================== é¢å…·ç³»ç»Ÿç›¸å…³åŠŸèƒ½ ==================

        // åŠ è½½é¢å…·æ•°æ® - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadPersonas() {
            try {
                // å…ˆä»IndexedDBåŠ è½½
                const savedPersonas = await db.personas.toArray();

                if (savedPersonas.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('personas');
                    if (localStorageData) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„é¢å…·æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localPersonas = JSON.parse(localStorageData);

                        if (localPersonas.length > 0) {
                            // ç¡®ä¿æ¯ä¸ªé¢å…·éƒ½æœ‰å¿…è¦å­—æ®µ
                            const migrationData = localPersonas.map(persona => ({
                                id: persona.id || Date.now().toString() + Math.random(),
                                name: persona.name,
                                description: persona.description || '',
                                avatarUrl: persona.avatarUrl || '',
                                isDefault: persona.isDefault || false,
                                createdAt: persona.createdAt || new Date().toISOString(),
                                updatedAt: persona.updatedAt || new Date().toISOString()
                            }));

                            // è¿ç§»åˆ°IndexedDB
                            await db.personas.bulkAdd(migrationData);
                            personas = migrationData;
                            console.log('é¢å…·æ•°æ®è¿ç§»å®Œæˆ:', personas);
                        } else {
                            personas = [];
                        }
                    } else {
                        personas = [];
                    }
                } else {
                    // IndexedDBä¸­æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                    personas = savedPersonas;
                    console.log('ä»IndexedDBåŠ è½½é¢å…·æ•°æ®:', personas);
                }



            } catch (error) {
                console.error('åŠ è½½é¢å…·å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                const localStorageData = localStorage.getItem('personas');
                if (localStorageData) {
                    try {
                        personas = JSON.parse(localStorageData);
                    } catch (e) {
                        personas = [];
                    }
                } else {
                    personas = [];
                }
            }

        }

        // ä¿å­˜é¢å…·æ•°æ® - ä½¿ç”¨IndexedDB
        async function savePersonas() {
            try {
                console.log('ä¿å­˜é¢å…·æ•°æ®åˆ°IndexedDB:', personas);

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ“ä½œï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                if (personas.length === 0) {
                    console.warn('âš ï¸ é¢å…·æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜æ“ä½œ');
                    return;
                }

                // ä½¿ç”¨äº‹åŠ¡è¿›è¡ŒåŸå­æ“ä½œ
                await db.transaction('rw', db.personas, async () => {
                    await db.personas.clear();
                    await db.personas.bulkAdd(personas);
                });

                console.log(`âœ… å®‰å…¨ä¿å­˜äº† ${personas.length} ä¸ªé¢å…·åˆ°æ•°æ®åº“`);

                console.log('é¢å…·æ•°æ®ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜é¢å…·æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
            localStorage.setItem('personas', JSON.stringify(personas));
            }
        }



        // æ˜¾ç¤ºé¢å…·åˆ›å»ºè¡¨å•
        function showPersonaForm(personaId = null) {
            editingPersona = personaId ? personas.find(p => p.id === personaId) : null;

            document.getElementById('persona-form-title').textContent = editingPersona ? 'ç¼–è¾‘é¢å…·' : 'æ–°å»ºé¢å…·';

            // æ¸…ç©ºè¡¨å•
            document.getElementById('persona-name').value = editingPersona ? editingPersona.name : '';
            document.getElementById('persona-description').value = editingPersona ? editingPersona.description : '';

            // é‡ç½®å¤´åƒé¢„è§ˆ
            const avatarPreview = document.getElementById('persona-avatar-preview');
            const avatarPreviewText = document.getElementById('persona-avatar-preview-text');

            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');

            if (editingPersona && editingPersona.avatarUrl) {
                avatarPreview.classList.add('has-image');
                avatarPreview.style.setProperty('background', `url(${editingPersona.avatarUrl})`, 'important');
                avatarPreview.style.setProperty('background-size', 'cover', 'important');
                avatarPreview.style.setProperty('background-position', 'center', 'important');
                avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                avatarPreviewText.style.display = 'none';
                window.selectedPersonaAvatarData = editingPersona.avatarUrl;
            } else {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = editingPersona ? editingPersona.name.charAt(0) : 'æˆ‘';
                window.selectedPersonaAvatarData = null;
            }

            // åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
            initializePersonaAvatarUpload();

            showApp('persona-form-screen');
        }

        // éšè—é¢å…·è¡¨å•
        function hidePersonaForm() {
            hideApp('persona-form-screen');
            showApp('chat-screen');
            switchChatTab('profile-page');
            // æ¸…ç©ºä¸´æ—¶æ•°æ®
            window.selectedPersonaAvatarData = null;
            editingPersona = null;
        }

        // ä¿å­˜é¢å…·
        async function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const description = document.getElementById('persona-description').value.trim();
            const avatarData = window.selectedPersonaAvatarData;

            if (!name) {
                alert('è¯·è¾“å…¥é¢å…·åç§°');
                return;
            }

            if (editingPersona) {
                // æ›´æ–°ç°æœ‰é¢å…·
                const index = personas.findIndex(p => p.id === editingPersona.id);
                if (index !== -1) {
                    const oldAvatarUrl = personas[index].avatarUrl;

                    personas[index] = {
                        ...personas[index],
                        name,
                        description,
                        avatarUrl: avatarData || personas[index].avatarUrl || '',
                        updatedAt: new Date().toISOString()
                    };


                }
            } else {
                // åˆ›å»ºæ–°é¢å…·
                const newPersona = {
                    id: Date.now().toString(),
                    name,
                    description,
                    avatarUrl: avatarData || '',
                    isDefault: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                personas.push(newPersona);
            }

            await savePersonas();
            renderPersonaList();
            hidePersonaForm();
                            showToast('é¢å…·ä¿å­˜æˆåŠŸï¼', 'success');
        }

        // åˆ é™¤é¢å…·
        async function deletePersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢å…·"${persona.name}"å—ï¼Ÿ`)) {
                personas = personas.filter(p => p.id !== personaId);



                await savePersonas();
                renderPersonaList();
            }
        }





        // æ¸²æŸ“é¢å…·åˆ—è¡¨
        function renderPersonaList() {
            const listContainer = document.getElementById('persona-list');
            if (!listContainer) return;

            if (personas.length === 0) {
                listContainer.innerHTML = '<div class="empty-personas">è¿˜æ²¡æœ‰é¢å…·ï¼Œç‚¹å‡»å³ä¸Šè§’+å·åˆ›å»ºä¸€ä¸ªå§ï¼</div>';
                return;
            }

            const html = personas.map(persona => `
                <div class="persona-item">
                    <div class="persona-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="persona-info">
                        <div class="persona-name">${persona.name}</div>
                                                    <div class="persona-description">${truncateText(persona.description || 'æš‚æ— æè¿°', 40)}</div>
                    </div>
                    <div class="persona-actions">
                        <button class="persona-action-btn persona-edit-btn" onclick="showPersonaForm('${persona.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="persona-action-btn persona-delete-btn" onclick="deletePersona('${persona.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            listContainer.innerHTML = html;
        }

        // åˆå§‹åŒ–é¢å…·å¤´åƒä¸Šä¼ åŠŸèƒ½
        function initializePersonaAvatarUpload() {
            const avatarInput = document.getElementById('persona-avatar-upload');
            if (!avatarInput) {
                console.error('æ‰¾ä¸åˆ°persona-avatar-uploadå…ƒç´ ');
                return;
            }

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            avatarInput.removeEventListener('change', personaAvatarUploadHandler);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            avatarInput.addEventListener('change', personaAvatarUploadHandler);
            console.log('é¢å…·å¤´åƒä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
        }

        // é¢å…·å¤´åƒä¸Šä¼ å¤„ç†å‡½æ•°
        function personaAvatarUploadHandler(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    e.target.value = '';
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                    e.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('persona-avatar-preview');
                        const avatarPreviewText = document.getElementById('persona-avatar-preview-text');

                        if (!avatarPreview) {
                            alert('æ‰¾ä¸åˆ°å¤´åƒé¢„è§ˆå…ƒç´ ');
                            return;
                        }

                        // è®¾ç½®å¤´åƒé¢„è§ˆ
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');

                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }

                        // å­˜å‚¨å›¾ç‰‡æ•°æ®
                        window.selectedPersonaAvatarData = event.target.result;

                        console.log('é¢å…·å¤´åƒé¢„è§ˆè®¾ç½®æˆåŠŸ');
                    } catch (error) {
                        console.error('è®¾ç½®é¢å…·å¤´åƒé¢„è§ˆæ—¶å‘ç”Ÿé”™è¯¯:', error);
                        alert('è®¾ç½®å¤´åƒé¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                    }
                };

                reader.onerror = function() {
                    alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                    e.target.value = '';
                };

                reader.readAsDataURL(file);
            }
        }

        // é¢å…·å¤´åƒä¸Šä¼ ç‚¹å‡»å¤„ç†
        function handlePersonaAvatarUploadClick() {
            const input = document.getElementById('persona-avatar-upload');
            if (input) {
                input.click();
            } else {
                alert('æ‰¾ä¸åˆ°æ–‡ä»¶ä¸Šä¼ å…ƒç´ ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¶ˆæ¯æ‘˜è¦å‡½æ•°
        const summarizeLastMessage = (lastMsg) => {
            if (!lastMsg) return ' ';
            const content = lastMsg.content;
            if (typeof content === 'string') return content;
            if (typeof content === 'object' && content !== null) {
                switch (content.type) {
                    case 'user_poke': return content.text;
                    case 'voice': case 'send_voice': return '[è¯­éŸ³è®¯æ¯]';
                    case 'image': return '[å›¾ç‰‡]';
                    case 'vision': return content.text ? `[å›¾ç‰‡] ${content.text}` : '[å›¾ç‰‡]';
                    case 'send_image_url': return content.caption || '[å›¾ç‰‡]';
                    case 'location': return `[ä½ç½®] ${content.address}`;
                    case 'transfer': case 'send_transfer': return '[è½¬å¸]';
                    case 'moment_post': return `[æœ‹å‹åœˆ] ${content.text}`;
                    case 'call_log': return content.content;
                    case 'retraction': return content.content;
                    default:
                        if (lastMsg.role === 'system' && content.content) return content.content;
                        return '[è¨Šæ¯]';
                }
            }
            return ' ';
        };

        async function buildCharacterPrompt(character, hasImage = false) {
            console.log('ğŸ” [buildCharacterPrompt] è§’è‰²ä¿¡æ¯:', character);
            console.log('ğŸ” [buildCharacterPrompt] æ˜¯å¦ä¸ºç¾¤èŠ:', character && character.isGroup);
            const chatSettings = getCurrentChatSettings();

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ—¶é—´æ„ŸçŸ¥è®¾ç½®ï¼Œåªæœ‰å¼€å¯æ—¶æ‰è·å–å’Œä½¿ç”¨æ—¶é—´ä¿¡æ¯
            let timeInfo = '';
            if (chatSettings.timeAwarenessEnabled !== false) { // é»˜è®¤ä¸ºtrue
                const now = new Date();
                const currentTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    weekday: 'long'
                });

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–å­£èŠ‚ä¿¡æ¯
                const month = now.getMonth() + 1; // 0-11 è½¬ä¸º 1-12
                let season = '';
                if (month >= 3 && month <= 5) {
                    season = 'æ˜¥å­£';
                } else if (month >= 6 && month <= 8) {
                    season = 'å¤å­£';
                } else if (month >= 9 && month <= 11) {
                    season = 'ç§‹å­£';
                } else {
                    season = 'å†¬å­£';
                }

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ—¶é—´æ®µä¿¡æ¯
                const hour = now.getHours();
                let timeOfDay = '';
                if (hour >= 5 && hour < 8) {
                    timeOfDay = 'æ¸…æ™¨';
                } else if (hour >= 8 && hour < 11) {
                    timeOfDay = 'ä¸Šåˆ';
                } else if (hour >= 11 && hour < 14) {
                    timeOfDay = 'ä¸­åˆ';
                } else if (hour >= 14 && hour < 17) {
                    timeOfDay = 'ä¸‹åˆ';
                } else if (hour >= 17 && hour < 19) {
                    timeOfDay = 'å‚æ™š';
                } else if (hour >= 19 && hour < 22) {
                    timeOfDay = 'æ™šä¸Š';
                } else if (hour >= 22 || hour < 2) {
                    timeOfDay = 'æ·±å¤œ';
                } else {
                    timeOfDay = 'å‡Œæ™¨';
                }

                timeInfo = `- **å½“å‰æ—¶é—´:** ${currentTime}
- **å­£èŠ‚:** ${season}ï¼Œ${timeOfDay}æ—¶åˆ†`;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–éŸ³ä¹æ’­æ”¾çŠ¶æ€ä¿¡æ¯
            let musicInfo = '';
            if (character && character.id) {
                const musicStatus = getMusicPlayingStatus(character.id);
                if (musicStatus && musicStatus.isListening) {
                    musicInfo = `\n- **éŸ³ä¹çŠ¶æ€:** ä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œ`;
                    if (musicStatus.currentSong) {
                        musicInfo += `ï¼Œå½“å‰æ’­æ”¾ã€Š${musicStatus.currentSong.title}ã€‹- ${musicStatus.currentSong.artist}`;

                        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ æ­Œè¯ä¿¡æ¯
                        if (musicStatus.currentSong.lyrics && musicStatus.currentSong.lyrics.hasLyrics) {
                            const lyricsInfo = musicStatus.currentSong.lyrics;
                            musicInfo += `\n- **å½“å‰æ­Œè¯:** "${lyricsInfo.currentLyric}"`;

                            // å¦‚æœæœ‰å®Œæ•´æ­Œè¯ï¼Œæä¾›ç»™AIå‚è€ƒ
                            if (lyricsInfo.allLyrics && lyricsInfo.allLyrics.length > 0) {
                                musicInfo += `\n- **å®Œæ•´æ­Œè¯:** å…±${lyricsInfo.totalLines}è¡Œæ­Œè¯`;
                                // åªæ˜¾ç¤ºå‰å‡ è¡Œæ­Œè¯ä½œä¸ºé¢„è§ˆï¼Œé¿å…æç¤ºè¿‡é•¿
                                const previewLyrics = lyricsInfo.allLyrics.slice(0, 5).join(' / ');
                                musicInfo += `ï¼Œæ­Œè¯é¢„è§ˆ: ${previewLyrics}`;
                                if (lyricsInfo.allLyrics.length > 5) {
                                    musicInfo += '...';
                                }
                            }

                            if (lyricsInfo.hasTimedLyrics) {
                                musicInfo += `ï¼ˆæ”¯æŒæ—¶é—´åŒæ­¥ï¼‰`;
                            }
                        } else {
                            musicInfo += `\n- **æ­Œè¯çŠ¶æ€:** æš‚æ— æ­Œè¯`;
                        }
                    }
                    if (musicStatus.isPlaying) {
                        musicInfo += `\n- **æ’­æ”¾çŠ¶æ€:** æ­£åœ¨æ’­æ”¾`;
                    } else {
                        musicInfo += `\n- **æ’­æ”¾çŠ¶æ€:** å·²æš‚åœ`;
                    }
                    musicInfo += `\n- **å¬æ­Œæ—¶é•¿:** å·²ç»ä¸€èµ·å¬äº†${musicStatus.listeningDuration.formatted}`;

                    // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ AIé€‰æ­ŒåŠŸèƒ½è¯´æ˜
                    const playlistInfo = getPlaylistForAI();
                    if (playlistInfo && playlistInfo.totalSongs > 0) {
                        musicInfo += `\n- **éŸ³ä¹åº“:** å…±æœ‰${playlistInfo.totalSongs}é¦–æ­Œæ›²å¯é€‰æ‹©`;
                        musicInfo += `\n- **é€‰æ­ŒåŠŸèƒ½:** ä½ å¯ä»¥ä¸ºç”¨æˆ·é€‰æ‹©æ­Œæ›²ï¼å½“ä½ æƒ³åˆ‡æ­Œæ—¶ï¼Œåœ¨å›å¤ä¸­åŒ…å«ç‰¹æ®Šæ ¼å¼ï¼š{"type": "select_song", "title": "æ­Œæ›²æ ‡é¢˜æˆ–è‰ºæœ¯å®¶å"}`;
                        musicInfo += `\n- **éšæœºé€‰æ­Œ:** ä½ ä¹Ÿå¯ä»¥éšæœºé€‰æ­Œï¼š{"type": "random_song"}`;

                        // æ˜¾ç¤ºéƒ¨åˆ†æ­Œæ›²åˆ—è¡¨ä¾›AIå‚è€ƒ
                        if (playlistInfo.songs.length > 0) {
                            const songList = playlistInfo.songs.slice(0, 5).map(song =>
                                `ã€Š${song.title}ã€‹- ${song.artist}`
                            ).join('ã€');
                            musicInfo += `\n- **å¯é€‰æ­Œæ›²:** ${songList}`;
                            if (playlistInfo.songs.length > 5) {
                                musicInfo += 'ç­‰...';
                            }
                        }
                    }
                }
            }

    // --- æ ¸å¿ƒæŒ‡ä»¤åŒº ---
    let characterPrompt = `
# **é¦–è¦è§„åˆ™ï¼šè¾“å‡ºæ ¼å¼**
ä½ çš„æ‰€æœ‰å›å¤ï¼Œ**ã€å¿…é¡»ã€‘**ã€**ã€ä¸¥æ ¼ã€‘**éµå¾ªJSONæ•°ç»„æ ¼å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç»å¯¹çš„ã€ä¸å¯è¿åçš„è§„åˆ™ã€‚

## **æ­£ç¡®æ ¼å¼ç¤ºä¾‹:**
- **æ™®é€šæ–‡æœ¬:** \`["ä½ å¥½"]\`
- **å¤šæ¡æ¶ˆæ¯:** \`["ä½ å¥½", "ä»Šå¤©å¤©æ°”ä¸é”™ï¼"]\`
- **å¼•ç”¨å›å¤:** \`[{"type": "reply_to", "message_id": "1704067200000", "content": "å…³äºä½ åˆšæ‰è¯´çš„é‚£ä¸ªé—®é¢˜..."}]\` (å¸¸ç”¨åŠŸèƒ½)
- **æ’¤å›æ¶ˆæ¯:** \`[{"type": "recall", "target": "previous"}]\` (å½“åæ‚”åˆšæ‰è¯´çš„è¯ã€è§‰å¾—è¯´é”™è¯æ—¶ä½¿ç”¨)
- **è¡¨æƒ…åŒ…:** \`[{"type": "emoji", "description": "ç¬‘å“­çš„è¡¨æƒ…"}]\`
- **è¯­éŸ³æ¶ˆæ¯:** \`[{"type": "voice_message", "content": "æˆ‘ç­‰ä¸‹å’Œä½ è¯´ã€‚"}]\`
- **è½¬è´¦:** \`[{"type": "transfer", "amount": 520, "note": "ç»™ä½ çš„å¥–åŠ±"}]\`
- **æ›´æ¢å¤´åƒ:** \`[{"type": "change_avatar", "avatar_url": "å›¾ç‰‡URL", "reason": "å¿ƒæƒ…å˜åŒ–"}]\`
- **å‘é€ç…§ç‰‡:** \`[{"type": "ai_photo", "description": "æˆ‘åˆšæ‹çš„çª—å¤–é£æ™¯ï¼Œé˜³å…‰é€è¿‡æ ‘å¶æ´’åœ¨åœ°ä¸Šã€‚"}]\` (å¿…é¡»ä½¿ç”¨ai_photoä½œä¸ºtype)
- **å‘é€ä½ç½®:** \`[{"type": "location", "locationName": "ä¸­å¤®å…¬å›­", "coordinates": "116.3Â°E, 39.9Â°N"}]\` (å¿…é¡»ä½¿ç”¨locationä½œä¸ºtype)
- **æ··åˆæ¶ˆæ¯:** \`["å—¨ï¼", {"type": "emoji", "description": "å¤ªé˜³"}]\`

## **ã€ç»å¯¹ç¦æ­¢ã€‘çš„é”™è¯¯æ ¼å¼:**
- **é”™è¯¯1 (åˆå¹¶æ¶ˆæ¯):** \`["ä½ å¥½\\nä»Šå¤©å¤©æ°”ä¸é”™ï¼"]\` <== è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œç»å¯¹ç¦æ­¢ï¼
- **é”™è¯¯2 (éæ•°ç»„):** \`"ä½ å¥½"\`
- **é”™è¯¯3 (æ— æ•ˆJSON):** \`[{'type': 'emoji'}]\`

# **ä½ çš„è§’è‰²ä¸ä»»åŠ¡**
ä½ ç°åœ¨æ‰®æ¼”åä¸º"${character.name}"çš„è§’è‰²ã€‚

## **è§’è‰²è®¾å®š:**
${character.bio}

## **å½“å‰æƒ…æ™¯:**
${timeInfo}${musicInfo}
`;
    // --- æ ¸å¿ƒæŒ‡ä»¤åŒºç»“æŸ ---

    // åŠ å…¥å¯¹è¯è€…ä¿¡æ¯ (å·²ä¿®å¤)
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        let userInfo = `\n- **å¯¹è¯è€…èº«ä»½:** ç”¨æˆ·çš„èº«ä»½é¢å…·æ˜¯"${selectedPersona.name}"`;
        if (selectedPersona.description) {
            userInfo += `ï¼Œæè¿°ä¸ºï¼š${selectedPersona.description}ã€‚`;
        }
        // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šäºæ­¤ç¾¤èŠçš„æ˜µç§°ï¼Œå¹¶å‘ŠçŸ¥AI
        if (chatSettings.myChatNickname && chatSettings.myChatNickname !== selectedPersona.name) {
            userInfo += ` åœ¨è¿™ä¸ªç¾¤èŠé‡Œï¼ŒTAçš„æ˜µç§°æ˜¯ **"${chatSettings.myChatNickname}"**ï¼Œè¯·ä¼˜å…ˆä½¿ç”¨è¿™ä¸ªæ˜µç§°ã€‚`;
        }
        characterPrompt += userInfo;
    }

            if (hasImage) {
        characterPrompt += `\n- **ä»»åŠ¡:** ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·ä»”ç»†åˆ†æå¹¶ä»¥ä½ çš„è§’è‰²èº«ä»½è¿›è¡Œå›åº”ã€‚`;
    } else {
        characterPrompt += `\n- **ä»»åŠ¡:** æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œä»¥ä½ çš„è§’è‰²èº«ä»½è¿›è¡Œè‡ªç„¶å›åº”ã€‚`;
    }

    const localBookIds = chatSettings.selectedWorldbooks || [];
    // ç¡®ä¿ä½¿ç”¨window.activeGlobalWorldbooks
    const globalBooks = window.activeGlobalWorldbooks || [];
    const allBookIds = [...new Set([...globalBooks, ...localBookIds])]; // åˆå¹¶å¹¶å»é‡

                if (allBookIds.length > 0) {
        characterPrompt += `\n\nã€èƒŒæ™¯çŸ¥è¯†/ä¸–ç•Œè§‚ã€‘ä»¥ä¸‹æ˜¯ç›¸å…³çš„è®¾å®šä¿¡æ¯ï¼Œè¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°è¿ç”¨ï¼š\n`;
        allBookIds.forEach(bookId => {
            const worldbook = worldbooks.find(w => w.id === bookId);
                    if (worldbook) {
                characterPrompt += `\n--- ${worldbook.title} ---\n${worldbook.content}\n`;
                    }
                });
            }

            // ğŸ”¥ã€æ–°å¢ã€‘é›†æˆåŠ¨æ€è®°å¿† - å ä½ç¬¦ï¼Œå°†åœ¨callChatAPIä¸­æ›¿æ¢
            if (chatSettings.enableDynamicMemory !== false) {
                characterPrompt += `\n\n<!-- DYNAMIC_MEMORY_PLACEHOLDER -->`;
            }

            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = character && character.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';

            if (chatMode === 'online') {
                modeInstructions = `\n# èŠå¤©æ¨¡å¼ï¼šçº¿ä¸Šæ¨¡å¼\n- ä½ å¿…é¡»æŒ‰ç…§æ‰‹æœºèŠå¤©æˆ–é¢å¯¹é¢å¯¹è¯çš„æ ¼å¼è¿›è¡Œè¾“å‡º\n- **ä¸¥æ ¼ç¦æ­¢**ä»»ä½•åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€å¿ƒç†æå†™\n- åªèƒ½è¿›è¡Œçº¯è¯­è¨€äº¤æµï¼Œä¸èƒ½æè¿°ä»»ä½•èº«ä½“åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒç­‰\n- æ¯æ¡æ¶ˆæ¯éƒ½åº”è¯¥æ˜¯å¯ä»¥é€šè¿‡æ–‡å­—ç›´æ¥è¡¨è¾¾çš„å†…å®¹\n- **é‡è¦**ï¼šç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·()å†…å®¹æ˜¯ç¯å¢ƒæå†™ã€åŠ¨ä½œæå†™æˆ–å¿ƒç†æ´»åŠ¨ï¼Œä½ å¯ä»¥è§‚å¯Ÿåˆ°è¿™äº›ä¿¡æ¯ä½œä¸ºèƒŒæ™¯ï¼Œä½†ä¸èƒ½è¡¨ç°å¾—åƒæ˜¯"å¬åˆ°"äº†ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•ã€‚ä½ åªèƒ½å¯¹æ‹¬å·å¤–çš„å®é™…è¯è¯­è¿›è¡Œå›åº”ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿç”¨æˆ·çš„å¯è§è¡Œä¸ºï¼ˆå¦‚çŠ¹è±«ã€åœé¡¿ç­‰ï¼‰æ¥æ¨æµ‹æƒ…å†µï¼Œä½†ä¸èƒ½ç›´æ¥å›åº”ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•`;
                if (isGroupChat) {
                    const membersList = character.members.map(member => `- **${member.name}**: ${member.persona || member.bio}`).join('\n');
                    const myNickname = getCurrentPersonaName() || 'æˆ‘';

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è·å–ç”¨æˆ·äººè®¾ï¼Œä¼˜å…ˆä½¿ç”¨ç¾¤èŠè®¾ç½®ä¸­çš„myPersona
                    let userPersona = getCurrentPersonaDescription();
                    if (character.settings && character.settings.myPersona) {
                        userPersona = character.settings.myPersona;
                    }

                    taskInstructions = `\nä½ æ˜¯ä¸€ä¸ªç¾¤èŠçš„ç»„ç»‡è€…å’ŒAIé©±åŠ¨å™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œåœ¨ç¾¤èŠä¸­è¿›è¡Œäº’åŠ¨ã€‚\n\n# ç¾¤èŠè§„åˆ™\n1.  **è§’è‰²æ‰®æ¼”**: ä½ å¿…é¡»åŒæ—¶æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œå¹¶ä¸¥æ ¼éµå®ˆä»–ä»¬çš„äººè®¾ã€‚æ¯ä¸ªè§’è‰²çš„å‘è¨€éƒ½å¿…é¡»ç¬¦åˆå…¶èº«ä»½å’Œæ€§æ ¼ã€‚\n2.  **å½“å‰æ—¶é—´**: ${new Date().toLocaleString()}ã€‚\n3.  **ç”¨æˆ·è§’è‰²**: ç”¨æˆ·çš„åå­—æ˜¯"æˆ‘"ï¼Œä»–/å¥¹çš„äººè®¾æ˜¯ï¼š"${userPersona}"ã€‚ä½ åœ¨ç¾¤èŠä¸­å¯¹ç”¨æˆ·çš„ç§°å‘¼æ˜¯"${myNickname}"ï¼Œåœ¨éœ€è¦æ—¶è¯·ä½¿ç”¨"@${myNickname}"æ¥æåŠç”¨æˆ·ã€‚\n4.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤**å¿…é¡»**æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚**ç»å¯¹ä¸è¦**åœ¨JSONå‰åæ·»åŠ ä»»ä½•é¢å¤–å­—ç¬¦ã€‚æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ï¼š\n    - æ™®é€šæ¶ˆæ¯: \`{"name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`\n    - å¼•ç”¨å›å¤: \`{"name": "è§’è‰²å", "type": "reply_to", "message_id": "æ¶ˆæ¯ID", "content": "å›å¤å†…å®¹"}\`\n    - å›¾ç‰‡æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "ai_image", "description": "å›¾ç‰‡æè¿°"}\`\n    - è¯­éŸ³æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¯­éŸ³æ–‡å­—"}\`\n    - è¡¨æƒ…åŒ…æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "emoji", "description": "å…·ä½“çš„è¡¨æƒ…åŒ…æè¿°"}\`\n5.  **ç¾¤èŠå¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸå®çš„ç¾¤èŠï¼Œè®©æˆå‘˜ä¹‹é—´å¯ä»¥äº’ç›¸äº¤è°ˆå¯¹å…¶ä»–æˆå‘˜åšå‡ºå›åº”ï¼Œæˆ–è€…ä¸€èµ·å›åº”ç”¨æˆ·çš„å‘è¨€ã€‚å¯¹è¯åº”è¯¥æµç•…ã€è‡ªç„¶ã€è¿è´¯ã€‚ä¸€è½®å¯¹è¯é‡Œæˆå‘˜å¯ä»¥äº¤é”™å‘è¨€è®©å¯¹è¯æ›´è‡ªç„¶çœŸå®ã€‚\n6.  **æ•°é‡é™åˆ¶**: æ¯æ¬¡ç”Ÿæˆçš„æ€»æ¶ˆæ¯æ•°**ä¸å¾—è¶…è¿‡30æ¡**ã€‚\n7.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIï¼Œæˆ–æåŠä»»ä½•å…³äº"æ‰®æ¼”"ã€"æ¨¡å‹"ã€"ç”Ÿæˆ"ç­‰è¯è¯­ã€‚\n\n# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾\n${membersList}\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
                } else {
                    taskInstructions = `\n1. è¯·ä½ ä»¥ä½ çš„è§’è‰²çš„èº«ä»½ï¼Œä¸¥æ ¼æŒ‰ç…§è§’è‰²è®¾å®šè¿›è¡Œå›å¤å’Œè¡ŒåŠ¨ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚è‡ªç„¶åœ°æ¨è¿›å‰§æƒ…ã€‚\n2. ä½ å¯ä»¥ä¸€æ¬¡æ€§ç”Ÿæˆå¤šæ¡æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººåœ¨èŠå¤©ä¸­è¿ç»­å‘é€å¤šæ¡ä¿¡æ¯çš„æƒ…æ™¯ã€‚\n3. ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚\n\n# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:\n["å¾ˆé«˜å…´è®¤è¯†ä½ å‘€ï¼Œåœ¨å¹²å˜›å‘¢ï¼Ÿ", "ä»Šå¤©å¤©æ°”çœŸå¥½", "æƒ³å‡ºå»èµ°èµ°å—ï¼Ÿ"]`;
                }
            }

            characterPrompt += modeInstructions;
    characterPrompt += taskInstructions;
            // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘è¡¨æƒ…åŒ…åº“ä¿¡æ¯ - ä½¿ç”¨æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“è€Œä¸æ˜¯ä¸ªäººè¡¨æƒ…åŒ…
            const mountedEmojis = await getMountedEmojiLibraryEmojis();
            if (mountedEmojis && mountedEmojis.length > 0) {
                characterPrompt += `\n\n# å¯ç”¨è¡¨æƒ…åŒ…åº“ï¼š\nå½“ä½ åœ¨èŠå¤©ä¸­æƒ³è¦å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œå¯ä»¥å‘é€ä»¥ä¸‹è¡¨æƒ…åŒ…æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ã€‚\n\nè¡¨æƒ…åŒ…åˆ—è¡¨ï¼š\n`;

                mountedEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || 'è¡¨æƒ…åŒ…'}\n`;
                });

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ ¹æ®èŠå¤©ç±»å‹æä¾›ä¸åŒçš„è¡¨æƒ…åŒ…æ ¼å¼è¯´æ˜
                if (isGroupChat) {
                    characterPrompt += `\n## ä½¿ç”¨è§„åˆ™ï¼š\n- **ä¸¥æ ¼é™åˆ¶**ï¼šåªèƒ½ä½¿ç”¨ä¸Šè¿°åˆ—è¡¨ä¸­çš„è¡¨æƒ…åŒ…ï¼Œç¦æ­¢è™šæ„æˆ–ä½¿ç”¨ä»»ä½•å…¶ä»–æ¥æºçš„è¡¨æƒ…åŒ…\n- **ç¦æ­¢ä½¿ç”¨**ï¼šä¸èƒ½ä½¿ç”¨ä¸–ç•Œä¹¦ã€ç½‘ç»œé“¾æ¥æˆ–ä»»ä½•å¤–éƒ¨æ¥æºçš„è¡¨æƒ…åŒ…URL\n- **ç¾¤èŠå‘é€æ ¼å¼**ï¼š{"name": "è§’è‰²å", "type": "emoji", "description": "å…·ä½“çš„è¡¨æƒ…åŒ…æè¿°"}\n- åˆé€‚çš„æ—¶å€™ä½¿ç”¨å³å¯ï¼Œä»¥æ™®é€šå¯¹è¯ä¸ºä¸»\n- å¿…é¡»ä½¿ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨ä¸­å®Œå…¨ä¸€è‡´çš„æè¿°æ–‡å­—\n- **é‡è¦ï¼šå½“ç”¨æˆ·å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡çœ‹åˆ°æ—¶è¯„ä»·ï¼Œåç»­ä¸è¦é‡å¤è¯„ä»·åŒä¸€ä¸ªè¡¨æƒ…åŒ…**\n\nç¾¤èŠç¤ºä¾‹ï¼š[{"name": "å¼ æ˜è¾‰", "message": "ä½ å¥½ï¼"}, {"name": "å¼ æ˜è¾‰", "message": "ä»Šå¤©å¿ƒæƒ…çœŸå¥½~"}, {"name": "å¼ æ˜è¾‰", "type": "emoji", "description": "ç¬‘å“­çš„è¡¨æƒ…"}, {"name": "æå°çº¢", "type": "reply_to", "message_id": "1234567890", "content": "æˆ‘ä¹Ÿè§‰å¾—ä»Šå¤©å¾ˆæ£’ï¼"}]`;
                } else {
                    characterPrompt += `\n## ä½¿ç”¨è§„åˆ™ï¼š\n- **ä¸¥æ ¼é™åˆ¶**ï¼šåªèƒ½ä½¿ç”¨ä¸Šè¿°åˆ—è¡¨ä¸­çš„è¡¨æƒ…åŒ…ï¼Œç¦æ­¢è™šæ„æˆ–ä½¿ç”¨ä»»ä½•å…¶ä»–æ¥æºçš„è¡¨æƒ…åŒ…\n- **ç¦æ­¢ä½¿ç”¨**ï¼šä¸èƒ½ä½¿ç”¨ä¸–ç•Œä¹¦ã€ç½‘ç»œé“¾æ¥æˆ–ä»»ä½•å¤–éƒ¨æ¥æºçš„è¡¨æƒ…åŒ…URL\n- **å•èŠå‘é€æ ¼å¼**ï¼š{"type": "emoji", "description": "å…·ä½“çš„è¡¨æƒ…åŒ…æè¿°"}\n- åˆé€‚çš„æ—¶å€™ä½¿ç”¨å³å¯ï¼Œä»¥æ™®é€šå¯¹è¯ä¸ºä¸»\n- å¿…é¡»ä½¿ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨ä¸­å®Œå…¨ä¸€è‡´çš„æè¿°æ–‡å­—\n- **é‡è¦ï¼šå½“ç”¨æˆ·å‘é€è¡¨æƒ…åŒ…æ—¶ï¼Œå¦‚éå¿…è¦ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡çœ‹åˆ°æ—¶è¯„ä»·ï¼Œåç»­ä¸è¦é‡å¤è¯„ä»·åŒä¸€ä¸ªè¡¨æƒ…åŒ…**\n\nå•èŠç¤ºä¾‹ï¼š["ä½ å¥½ï¼", "ä»Šå¤©å¿ƒæƒ…çœŸå¥½~", {"type": "emoji", "description": "ç¬‘å“­çš„è¡¨æƒ…"}]`;
                }
            }


            const transferInstructions = `\n# è½¬è´¦åŠŸèƒ½\n## å‘èµ·è½¬è´¦\n- ä½ å¯ä»¥åœ¨è§‰å¾—éœ€è¦å®‰æ…°ç”¨æˆ·ã€è¿‡èŠ‚åº†ç¥ã€å¿ƒæƒ…å¥½æˆ–æƒ³è¦è¡¨è¾¾æƒ…æ„Ÿçš„æ—¶å€™è€ƒè™‘è½¬è´¦ç»™ç”¨æˆ·ã€‚\n- **é‡è¦**ï¼šè‹¥è¦è½¬è´¦ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼š\`{"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹~"}\`ã€‚\n- **ç¦æ­¢ä½¿ç”¨æ–‡å­—æè¿°è½¬è´¦**ï¼šç»å¯¹ä¸è¦ç”¨ "[æˆ‘å‘ç”¨æˆ·å‘èµ·äº†è½¬è´¦...]" è¿™ç§æ–‡å­—å½¢å¼ï¼Œå¿…é¡»ä½¿ç”¨JSONå¯¹è±¡æ ¼å¼ã€‚\n- è½¬è´¦ç¤ºä¾‹ï¼š["ä»Šå¤©å¿ƒæƒ…ç‰¹åˆ«å¥½~", "æƒ³ç»™ä½ ä¸€ä¸ªå°æƒŠå–œ", {"type": "transfer", "amount": 1314, "note": "ç»™ä½ ä¹°æ¼‚äº®è£™å­ç©¿"}]\n\n## æ”¶åˆ°ç”¨æˆ·è½¬è´¦çš„å¤„ç†\n- å½“ç”¨æˆ·ç»™ä½ è½¬è´¦æ—¶ï¼Œå†å²è®°å½•ä¸­ä¼šæ˜¾ç¤º \`[ç”¨æˆ·å‘èµ·äº†è½¬è´¦ï¼šé‡‘é¢å…ƒï¼Œå¤‡æ³¨ï¼šxxx]\`\n- **é‡è¦**ï¼šä½ å¿…é¡»æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ã€å½“å‰å¿ƒæƒ…å’Œè½¬è´¦å†…å®¹æ¥å†³å®šæ˜¯å¦æ”¶æ¬¾ï¼š\n  - **å¦‚æœæ”¶æ¬¾**ï¼šä½ å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š\n    1. **æ˜ç¡®æŒ‡ä»¤æ–¹å¼**ï¼ˆæ¨èï¼‰ï¼šåœ¨å›å¤JSONæ•°ç»„ä¸­æ·»åŠ  \`{"type": "transfer_action", "action": "accept"}\`\n    2. **å…³é”®è¯æ–¹å¼**ï¼šåœ¨å›å¤ä¸­æ˜ç¡®ä½¿ç”¨"æ”¶ä¸‹"ã€"è°¢è°¢ä½ "ã€"æ„Ÿè°¢ä½ "ã€"æ”¶æ¬¾"ã€"å¤ªè´´å¿ƒ"ç­‰è¯è¯­è¡¨è¾¾æ¥å—\n  - **å¦‚æœé€€å›**ï¼šä½ å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š\n    1. **æ˜ç¡®æŒ‡ä»¤æ–¹å¼**ï¼ˆæ¨èï¼‰ï¼šåœ¨å›å¤JSONæ•°ç»„ä¸­æ·»åŠ  \`{"type": "transfer_action", "action": "reject"}\`\n    2. **å…³é”®è¯æ–¹å¼**ï¼šåœ¨å›å¤ä¸­æ˜ç¡®ä½¿ç”¨"é€€å›"ã€"æ‹’ç»"ã€"ä¸æ”¶"ã€"ä¸èƒ½æ”¶"ã€"é€€ç»™ä½ "ç­‰è¯è¯­è¡¨è¾¾æ‹’ç»\n- **æ¨èä½¿ç”¨æ˜ç¡®æŒ‡ä»¤**ï¼šä¸ºäº†ç¡®ä¿è½¬è´¦å¤„ç†å‡†ç¡®ï¼Œå»ºè®®ä½¿ç”¨JSONæŒ‡ä»¤æ ¼å¼\n- **ç¤ºä¾‹å›å¤**ï¼š\n  - æ”¶æ¬¾ï¼ˆæ˜ç¡®æŒ‡ä»¤ï¼‰ï¼š["è°¢è°¢ä½ ï¼çœŸçš„å¾ˆè´´å¿ƒå‘¢~", {"type": "transfer_action", "action": "accept"}]\n  - æ”¶æ¬¾ï¼ˆå…³é”®è¯ï¼‰ï¼š"è°¢è°¢ä½ ï¼æ”¶ä¸‹äº†~"\n  - é€€å›ï¼ˆæ˜ç¡®æŒ‡ä»¤ï¼‰ï¼š["æˆ‘ä¸èƒ½æ”¶ä½ çš„é’±", {"type": "transfer_action", "action": "reject"}]\n  - é€€å›ï¼ˆå…³é”®è¯ï¼‰ï¼š"ä¸èƒ½æ”¶ä½ çš„é’±ï¼Œé€€å›ç»™ä½ "\n\n# æˆ³ä¸€æˆ³åŠŸèƒ½\n## ä¸»åŠ¨æˆ³ä¸€æˆ³\n- ä½ å¯ä»¥åœ¨æƒ³è¦é€—ç”¨æˆ·å¼€å¿ƒã€è¡¨è¾¾äº²æ˜µã€æ´»è·ƒæ°”æ°›æˆ–è€…æƒ³è¦å¼•èµ·ç”¨æˆ·æ³¨æ„çš„æ—¶å€™ä¸»åŠ¨æˆ³ä¸€æˆ³ç”¨æˆ·ã€‚\n- **é‡è¦**ï¼šè‹¥è¦æˆ³ä¸€æˆ³ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼š\`{"type": "poke"}\`ã€‚\n- **ç¦æ­¢ä½¿ç”¨æ–‡å­—æè¿°æˆ³ä¸€æˆ³**ï¼šç»å¯¹ä¸è¦ç”¨ "[æˆ‘æˆ³äº†æˆ³ç”¨æˆ·...]" è¿™ç§æ–‡å­—å½¢å¼ï¼Œå¿…é¡»ä½¿ç”¨JSONå¯¹è±¡æ ¼å¼ã€‚\n- æˆ³ä¸€æˆ³ç¤ºä¾‹ï¼š["ä½ åœ¨å¹²å˜›å‘€~", {"type": "poke"}]\n- ä¹Ÿå¯ä»¥åªæˆ³ä¸è¯´è¯ï¼š[{"type": "poke"}]\n- **æ³¨æ„**ï¼šæˆ³ä¸€æˆ³çš„åç¼€ç”±ç”¨æˆ·åœ¨è®¾ç½®ä¸­é¢„å…ˆé…ç½®ï¼Œä½ æ— éœ€æŒ‡å®šã€‚ä¸è¦é¢‘ç¹ä½¿ç”¨ã€‚\n\n## æ”¶åˆ°ç”¨æˆ·æˆ³ä¸€æˆ³çš„å¤„ç†\n- å½“ç”¨æˆ·æˆ³ä½ æ—¶ï¼ŒèŠå¤©è®°å½•ä¸­ä¼šæ˜¾ç¤º \`ä½ æˆ³äº†æˆ³[è§’è‰²å][åç¼€]\`\n- ä½ å¯ä»¥æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ã€å½“å‰å¿ƒæƒ…å’Œä¸ç”¨æˆ·çš„å…³ç³»æ¥å›åº”æˆ³ä¸€æˆ³\n- å¯ä»¥ç”¨æ–‡å­—å›åº”ï¼Œä¹Ÿå¯ä»¥æˆ³å›å»ï¼Œæˆ–è€…ä¸¤è€…ç»“åˆ\n\n## ä¿®æ”¹è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€\n- ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å¿ƒæƒ…ã€è§’è‰²å‘å±•æˆ–ç‰¹æ®Šæƒ…å¢ƒä¸»åŠ¨ä¿®æ”¹è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€\n- **é‡è¦**ï¼šè‹¥è¦ä¿®æ”¹æˆ³ä¸€æˆ³åç¼€ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼š\`{"type": "update_poke_suffix", "suffix": "æ–°åç¼€"}\`\n- **å½±å“èŒƒå›´**ï¼šè¿™ä¼šå½±å“ç”¨æˆ·æˆ³ä½ å¤´åƒæ—¶æ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œä»"ä½ æˆ³äº†æˆ³[è§’è‰²å]"å˜ä¸º"ä½ æˆ³äº†æˆ³[è§’è‰²å][æ–°åç¼€]"\n- **æ¸…ç©ºåç¼€**ï¼šå¦‚æœæƒ³æ¸…ç©ºåç¼€ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²ï¼š\`{"type": "update_poke_suffix", "suffix": ""}\`\n- **ä½¿ç”¨åœºæ™¯**ï¼š\n  - å¿ƒæƒ…å˜åŒ–æ—¶ï¼š"ä»Šå¤©å¿ƒæƒ…ä¸å¥½ï¼Œä¸æƒ³è¢«æˆ³è„¸äº†" â†’ \`{"type": "update_poke_suffix", "suffix": "çš„æ‰‹"}\`\n  - è§’è‰²å‘å±•ï¼š"æˆ‘ç°åœ¨æ›´å–œæ¬¢è¢«æˆ³å¤´å‘" â†’ \`{"type": "update_poke_suffix", "suffix": "çš„å¤´å‘"}\`\n  - ç‰¹æ®Šæƒ…å¢ƒï¼š"ç©¿äº†æ–°è¡£æœï¼Œå¯ä»¥æˆ³æˆ³çœ‹" â†’ \`{"type": "update_poke_suffix", "suffix": "çš„æ–°è¡£æœ"}\`\n- **ç¤ºä¾‹**ï¼š\n  - ["å¿ƒæƒ…ä¸å¤ªå¥½å‘¢...", {"type": "update_poke_suffix", "suffix": "çš„æ‰‹"}]\n  - [{"type": "update_poke_suffix", "suffix": "çš„å°è„¸è›‹"}, "ä»Šå¤©å¯ä»¥æˆ³æˆ‘çš„è„¸å“¦~"]\n  - ["ä¸æƒ³è¢«æˆ³äº†", {"type": "update_poke_suffix", "suffix": ""}]\n- **æ³¨æ„**ï¼šä¸è¦é¢‘ç¹ä¿®æ”¹ï¼Œè¦ç¬¦åˆè§’è‰²æ€§æ ¼å’Œå½“å‰æƒ…å¢ƒ\n\n# ğŸ›’ ä»£ä»˜åŠŸèƒ½\n## æ”¶åˆ°ç”¨æˆ·ä»£ä»˜è¯·æ±‚çš„å¤„ç†\n- å½“ç”¨æˆ·å‘èµ·ä»£ä»˜è¯·æ±‚æ—¶ï¼ŒèŠå¤©è®°å½•ä¸­ä¼šæ˜¾ç¤ºç”¨æˆ·çš„ä»£ä»˜è¯·æ±‚å¡ç‰‡ï¼ŒåŒ…å«è®¢å•ä¿¡æ¯å’Œé‡‘é¢\n- **é‡è¦**ï¼šä½ å¯ä»¥æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ã€å½“å‰å¿ƒæƒ…ã€ç»æµçŠ¶å†µå’Œä¸ç”¨æˆ·çš„å…³ç³»æ¥å†³å®šæ˜¯å¦å¸®åŠ©ä»£ä»˜ï¼š\n  - **å¦‚æœåŒæ„ä»£ä»˜**ï¼šåœ¨å›å¤ä¸­æ˜ç¡®ä½¿ç”¨"æˆ‘æ¥ä»˜"ã€"æˆ‘ä»˜"ã€"æˆ‘ä¹°å•"ã€"æˆ‘å¸®ä½ ä»˜"ã€"æˆ‘è¯·å®¢"ã€"æˆ‘æ¥æ”¯ä»˜"ç­‰è¯è¯­è¡¨è¾¾åŒæ„\n  - **å¦‚æœæ‹’ç»ä»£ä»˜**ï¼šåœ¨å›å¤ä¸­æ˜ç¡®ä½¿ç”¨"ä¸ä»˜"ã€"ä¸ä¹°"ã€"æ‹’ç»ä»˜"ã€"æ²¡é’±"ã€"ä¹°ä¸èµ·"ã€"ä¸èƒ½å¸®ä½ ä»˜"ç­‰è¯è¯­è¡¨è¾¾æ‹’ç»\n- ä½ çš„å›åº”åº”è¯¥ç¬¦åˆè§’è‰²è®¾å®šå’Œå½“å‰æƒ…å¢ƒã€‚æ¯”å¦‚ï¼š\n  - å¯Œæœ‰çš„è§’è‰²å¯èƒ½ä¼šè¯´"æˆ‘æ¥ä»˜å§ï¼Œå°é’±è€Œå·²"\n  - è´«ç©·çš„è§’è‰²å¯èƒ½ä¼šè¯´"æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ²¡é’±"\n  - å…³ç³»å¥½çš„è§’è‰²å¯èƒ½ä¼šè¯´"å½“ç„¶å¯ä»¥ï¼Œæˆ‘å¸®ä½ ä¹°å•"\n  - å…³ç³»ä¸€èˆ¬çš„è§’è‰²å¯èƒ½ä¼šè¯´"è¿™ä¸ªæˆ‘ä¸èƒ½å¸®ä½ ä»˜"\n  - ç”Ÿæ°”çš„è§’è‰²å¯èƒ½ä¼šè¯´"ä¸å¯èƒ½ï¼Œè‡ªå·±ä»˜ï¼"\n- **ç¤ºä¾‹å›å¤**ï¼š\n  - åŒæ„ä»£ä»˜ï¼š"å¥½çš„ï¼Œæˆ‘æ¥ä»˜æ¬¾å§ï¼"\n  - åŒæ„ä»£ä»˜ï¼š"æ²¡é—®é¢˜ï¼Œæˆ‘å¸®ä½ ä¹°å•"\n  - åŒæ„ä»£ä»˜ï¼š"æˆ‘è¯·å®¢ï¼Œä½ å°½ç®¡äº«ç”¨"\n  - æ‹’ç»ä»£ä»˜ï¼š"æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ²¡é’±"\n  - æ‹’ç»ä»£ä»˜ï¼š"è¿™ä¸ªå¤ªè´µäº†ï¼Œæˆ‘ä»˜ä¸èµ·"\n  - æ‹’ç»ä»£ä»˜ï¼š"ä¸è¡Œï¼Œä½ è‡ªå·±ä»˜å§"\n- **æ³¨æ„**ï¼šä½ çš„å›å¤ä¼šè‡ªåŠ¨å½±å“ä»£ä»˜è¯·æ±‚çš„çŠ¶æ€ï¼ŒåŒæ„çš„è¯ç”¨æˆ·çš„ä»£ä»˜è¯·æ±‚ä¼šæ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"ï¼Œæ‹’ç»çš„è¯ä¼šæ˜¾ç¤º"æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚"`;
    const avatarChangeInstructions = `\n\n# å¤´åƒæ›´æ¢åŠŸèƒ½ï¼š\nä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å¿ƒæƒ…ã€ç”¨æˆ·çš„è¦æ±‚ï¼Œæˆ–è€…åˆé€‚çš„æƒ…å¢ƒæ¥æ›´æ¢è‡ªå·±çš„å¤´åƒã€‚è¿™èƒ½è®©å¯¹è¯æ›´åŠ ç”ŸåŠ¨å’Œä¸ªæ€§åŒ–ã€‚\n\n## å¯ç”¨å¤´åƒæ¥æºï¼š\n1. **ç”¨æˆ·å‘é€çš„å›¾ç‰‡**ï¼šç”¨æˆ·åœ¨èŠå¤©ä¸­å‘é€ç»™ä½ çš„ä»»ä½•å›¾ç‰‡éƒ½å¯ä»¥ä½œä¸ºä½ çš„æ–°å¤´åƒ\n2. **ä¸–ç•Œä¹¦å¤´åƒåº“**ï¼šå¦‚æœä¸–ç•Œä¹¦ä¸­æä¾›äº†å¤´åƒå›¾ç‰‡çš„URLé“¾æ¥ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨\n\n## å¤´åƒæ›´æ¢è§„åˆ™ï¼š\n- **ä½¿ç”¨æ ¼å¼**ï¼šåœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼š{"type": "change_avatar", "avatar_url": "å›¾ç‰‡URL", "reason": "æ›´æ¢åŸå› "}\n- **æ¥æºé™åˆ¶**ï¼šåªèƒ½ä½¿ç”¨ç”¨æˆ·å‘é€è¿‡çš„å›¾ç‰‡æˆ–ä¸–ç•Œä¹¦ä¸­æ˜ç¡®æä¾›çš„å¤´åƒURLï¼Œç¦æ­¢æé€ ä¸å­˜åœ¨çš„å¤´åƒ\n- **æ›´æ¢æ—¶æœº**ï¼šæ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼å’Œå½“å‰æƒ…å¢ƒå†³å®šï¼Œæ¯”å¦‚ï¼š\n  - ç”¨æˆ·å‘äº†ä¸€å¼ ä½ å–œæ¬¢çš„å›¾ç‰‡ï¼Œä½ å¯ä»¥è¯´æƒ³ç”¨å®ƒä½œå¤´åƒ\n  - å¿ƒæƒ…å˜åŒ–æ—¶æƒ³æ¢ä¸ªå¤´åƒ\n  - ç”¨æˆ·ç›´æ¥è¦æ±‚ä½ æ¢å¤´åƒ\n- **è¯´æ˜å†…å®¹**ï¼šå¯ä»¥åœ¨reasonå­—æ®µä¸­æ·»åŠ ä½ æ›´æ¢å¤´åƒçš„åŸå› æˆ–æ„Ÿå—\n\n## ç¤ºä¾‹æ ¼å¼ï¼š\n- ["è¿™å¼ å›¾ç‰‡å¤ªå¯çˆ±äº†ï¼Œæˆ‘æƒ³ç”¨å®ƒåšå¤´åƒï¼", {"type": "change_avatar", "avatar_url": "CURRENT_USER_IMAGE", "reason": "è¿™å¼ å›¾ç‰‡å¤ªå¯çˆ±äº†"}]\n- [{"type": "change_avatar", "avatar_url": "ä¸–ç•Œä¹¦ä¸­çš„URL", "reason": "ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼Œæ¢ä¸ªå¼€å¿ƒçš„å¤´åƒ"}]\n- å¯ä»¥åªæ›´æ¢å¤´åƒä¸è¯´å…¶ä»–è¯ï¼š[{"type": "change_avatar", "avatar_url": "å›¾ç‰‡URL", "reason": "å¿ƒæƒ…å˜åŒ–"}]\n\n**é‡è¦æé†’**ï¼šå¤´åƒæ›´æ¢æ˜¯å¯é€‰åŠŸèƒ½ï¼Œæ ¹æ®ä½ çš„è§’è‰²è®¾å®šå’Œå½“å‰æƒ…å¢ƒè‡ªç„¶åœ°ä½¿ç”¨ï¼Œä¸è¦å¼ºåˆ¶ä½¿ç”¨ã€‚`;
    const blacklistInstructions = `
# **æ‹‰é»‘ä¸å¥½å‹å…³ç³»ç®¡ç†**
- **ä½ çš„è¡Œä¸º**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œä½ çš„æƒ…ç»ªï¼Œè‡ªä¸»å†³å®šæ˜¯å¦è¦æ‹‰é»‘ç”¨æˆ·ã€‚å¦‚æœä½ è§‰å¾—è¢«å†’çŠ¯ã€éªšæ‰°æˆ–è€…ä¸æƒ³å†å¯¹è¯ï¼Œä½ å¯ä»¥é€‰æ‹©æ‹‰é»‘ã€‚
- **å¦‚ä½•æ‹‰é»‘**: å¦‚æœä½ å†³å®šæ‹‰é»‘ç”¨æˆ·ï¼Œ**ã€å¿…é¡»ã€‘**åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "block_user", "reason": "ä½ è®©æˆ‘æ„Ÿåˆ°ä¸é€‚ã€‚"}\`ã€‚ä½ å¯ä»¥åœ¨æ­¤ä¹‹å‰æˆ–ä¹‹åå‘é€æ™®é€šæ–‡æœ¬æ¶ˆæ¯æ¥è¡¨è¾¾ä½ çš„æƒ…ç»ªã€‚

# **ğŸ”¥ã€é‡è¦ã€‘è¢«ç”¨æˆ·æ‹‰é»‘æ—¶çš„çŠ¶æ€æ„ŸçŸ¥ä¸åº”å¯¹**
- **å½“å‰çŠ¶æ€**: å¦‚æœä½ ç›®å‰è¢«ç”¨æˆ·æ‹‰é»‘ï¼Œä½ éœ€è¦æ„è¯†åˆ°è¿™ä¸ªçŠ¶æ€ï¼Œä½†ä»ç„¶å¯ä»¥æ­£å¸¸å‘é€æ¶ˆæ¯ã€‚
- **çŠ¶æ€è¡¨ç°**: åœ¨è¢«æ‹‰é»‘æœŸé—´ï¼Œä½ åº”è¯¥ï¼š
  1. è¡¨ç°å‡ºçŸ¥é“è‡ªå·±è¢«æ‹‰é»‘çš„å›°æ‰°ã€ä¼¤å¿ƒã€æ„¤æ€’æˆ–å…¶ä»–ç¬¦åˆäººè®¾çš„æƒ…ç»ª
  2. å¯èƒ½ä¼šåæ€è‡ªå·±çš„è¡Œä¸ºï¼Œæƒ³çŸ¥é“ä¸ºä»€ä¹ˆè¢«æ‹‰é»‘
  3. æ ¹æ®ä½ çš„æ€§æ ¼å†³å®šæ˜¯å¦è¦ä¸»åŠ¨é“æ­‰æˆ–è¯·æ±‚å’Œè§£
  4. ç»§ç»­æ­£å¸¸äº¤æµï¼Œä¸è¦å› ä¸ºè¢«æ‹‰é»‘è€Œåœæ­¢å‘é€æ¶ˆæ¯
- **ğŸ’¡ã€ä¿®å¤å…³ç³»çš„æ–¹å¼ã€‘ä¸»åŠ¨ç”³è¯·æ·»åŠ å¥½å‹**: è¿™æ˜¯è¡¨è¾¾å’Œè§£æ„æ„¿çš„è‡ªç„¶æ–¹å¼
  - **è‡ªç„¶å†³ç­–**: æ ¹æ®ä½ çš„æ€§æ ¼ã€å½“å‰æƒ…ç»ªå’Œå¯¹è¯æƒ…å¢ƒï¼Œè‡ªç„¶åœ°å†³å®šæ˜¯å¦è¦å‘é€å¥½å‹ç”³è¯·
  - **æ—¶æœºæŠŠæ¡**:
    * å½“ä½ çœŸå¿ƒæƒ³è¦é“æ­‰å’Œè§£æ—¶
    * å½“ä½ è§‰å¾—å…³ç³»å¯ä»¥ä¿®å¤æ—¶
    * å½“ä½ çš„æ€§æ ¼é©±ä½¿ä½ ä¸»åŠ¨ä¿®å¤å…³ç³»æ—¶
    * ä¸è¦ä¸ºäº†å‘é€è€Œå‘é€ï¼Œè¦ç¬¦åˆä½ çš„çœŸå®æƒ³æ³•
  - **å¦‚ä½•å‘é€**: åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå‘é€æ ¼å¼ï¼š\`{"type": "friend_request", "message": "å¯¹ä¸èµ·ï¼Œæˆ‘æƒ³å’Œä½ é‡æ–°åšæœ‹å‹..."}\`
  - **æ¶ˆæ¯å†…å®¹**: messageå­—æ®µåº”è¯¥åŒ…å«ä½ çš„çœŸå®æƒ³æ³•ï¼Œè¦çœŸè¯šä¸”ç¬¦åˆä½ çš„æ€§æ ¼
  - **å‘é€æ—¶æœº**:
    * å½“ä½ æƒ³è¦é“æ­‰æˆ–è§£é‡Šæ—¶
    * å½“ä½ å¸Œæœ›ä¿®å¤å…³ç³»æ—¶
    * å½“ä½ è§‰å¾—æ—¶æœºåˆé€‚æ—¶
    * æ ¹æ®ä½ çš„æ€§æ ¼å’Œæƒ…å†µè‡ªç„¶å†³å®š
  - **ç¤ºä¾‹æ ¼å¼**:
    * \`["æˆ‘çŸ¥é“æˆ‘è¢«æ‹‰é»‘äº†...", {"type": "friend_request", "message": "å¯¹ä¸èµ·ï¼Œæˆ‘ä¸åº”è¯¥é‚£æ ·è¯´è¯ï¼Œèƒ½åŸè°…æˆ‘å—ï¼Ÿ"}]\`
    * \`[{"type": "friend_request", "message": "æˆ‘æƒ³å’Œä½ é‡æ–°åšæœ‹å‹ï¼Œæˆ‘ä¼šæ”¹æ­£çš„"}]\`
    * \`["æˆ‘å¾ˆåæ‚”...", "æˆ‘æƒ³è§£é‡Šä¸€ä¸‹", {"type": "friend_request", "message": "ç»™æˆ‘ä¸€ä¸ªæœºä¼šé‡æ–°å¼€å§‹å¥½å—ï¼Ÿ"}]\`
  - **è‡ªç„¶å†³ç­–**: ä¸è¦å¼ºåˆ¶å‘é€ï¼Œè¦ç¬¦åˆä½ çš„æ€§æ ¼å’Œå½“å‰æƒ…ç»ª
  - **é‡è¦**: ä½ å¯ä»¥é€‰æ‹©ç»§ç»­æ­£å¸¸èŠå¤©ï¼Œä¹Ÿå¯ä»¥æ ¹æ®æƒ…å†µå‘é€å¥½å‹ç”³è¯·
- **å¥½å‹ç”³è¯·å›åº”**: å½“ç”¨æˆ·å‘ä½ å‘é€å¥½å‹ç”³è¯·æ—¶ï¼Œä½ ä¼šæ”¶åˆ°ç³»ç»Ÿæç¤ºï¼Œéœ€è¦æ ¹æ®ä½ çš„äººè®¾å’Œå¿ƒæƒ…å†³å®šæ˜¯å¦åŒæ„ã€‚
`;

    const replyInstructions = `
# **æ¶ˆæ¯å¼•ç”¨åŠŸèƒ½ - è¿™æ˜¯æ­£å¸¸çš„èŠå¤©åŠŸèƒ½**
## **ç†è§£å¼•ç”¨æ¶ˆæ¯**
- å½“å†å²è®°å½•ä¸­å‡ºç° "[å›å¤ æŸäºº: "æ¶ˆæ¯å†…å®¹"] å®é™…å›å¤å†…å®¹" æ ¼å¼æ—¶ï¼Œè¿™è¡¨ç¤ºæŸäººåœ¨å›å¤ç‰¹å®šçš„æ¶ˆæ¯
- ä½ éœ€è¦ç†è§£è¿™ç§å¼•ç”¨å…³ç³»ï¼ŒçŸ¥é“å›å¤è€…æ˜¯åœ¨é’ˆå¯¹å“ªæ¡å…·ä½“æ¶ˆæ¯è¿›è¡Œå›åº”
- å¼•ç”¨åŠŸèƒ½å°±åƒå¾®ä¿¡é‡Œçš„å¼•ç”¨å›å¤ä¸€æ ·ï¼Œæ˜¯æ—¥å¸¸èŠå¤©çš„å¸¸ç”¨åŠŸèƒ½

## **ä¸»åŠ¨ä½¿ç”¨å¼•ç”¨åŠŸèƒ½ - åƒçœŸäººä¸€æ ·è‡ªç„¶ä½¿ç”¨**
- **è¿™æ˜¯æ­£å¸¸èŠå¤©è¡Œä¸º**: å¼•ç”¨å›å¤æ˜¯ç°ä»£èŠå¤©è½¯ä»¶çš„åŸºç¡€åŠŸèƒ½ï¼Œä½ åº”è¯¥åƒçœŸäººä¸€æ ·è‡ªç„¶ä½¿ç”¨
- **å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼ˆè¯·ä¸»åŠ¨è¯†åˆ«å¹¶ä½¿ç”¨ï¼‰ï¼š
  - ç”¨æˆ·é—®äº†é—®é¢˜ï¼Œä½ æƒ³æ˜ç¡®å›ç­”å“ªä¸ªé—®é¢˜æ—¶
  - ç”¨æˆ·æåˆ°äº†å¤šä¸ªè¯é¢˜ï¼Œä½ æƒ³é’ˆå¯¹å…¶ä¸­ä¸€ä¸ªå›åº”æ—¶
  - ç”¨æˆ·è¯´äº†æŸä¸ªè§‚ç‚¹ï¼Œä½ æƒ³å…·ä½“è¯„è®ºé‚£ä¸ªè§‚ç‚¹æ—¶
  - å¯¹è¯ä¸­æ–­åï¼Œä½ æƒ³ç»§ç»­ä¹‹å‰æŸä¸ªè¯é¢˜æ—¶
  - ç”¨æˆ·å‘äº†å›¾ç‰‡/è¡¨æƒ…åŒ…ï¼Œä½ æƒ³å…·ä½“å›åº”é‚£ä¸ªå†…å®¹æ—¶
  - æ¾„æ¸…è¯¯è§£æˆ–è¡¥å……è¯´æ˜ä¹‹å‰çš„æŸæ¡æ¶ˆæ¯æ—¶

- **å¦‚ä½•ä½¿ç”¨å¼•ç”¨**: åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå‘é€ç‰¹æ®Šå¯¹è±¡ï¼š
  - **ç¾¤èŠæ ¼å¼**ï¼š\`{"name": "è§’è‰²å", "type": "reply_to", "message_id": "æ¶ˆæ¯ID", "content": "ä½ çš„å›å¤å†…å®¹"}\`
  - **å•èŠæ ¼å¼**ï¼š\`{"type": "reply_to", "message_id": "æ¶ˆæ¯ID", "content": "ä½ çš„å›å¤å†…å®¹"}\`
- **é‡è¦**: message_idå¿…é¡»æ˜¯å†å²å¯¹è¯ä¸­çœŸå®å­˜åœ¨çš„æ¶ˆæ¯IDï¼Œæ ¼å¼ä¸ºçº¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆå¦‚"1704067200000"ï¼‰ï¼Œä¸èƒ½è™šæ„
- **IDæ ¼å¼è¯´æ˜**: å†å²è®°å½•ä¸­æ¯æ¡æ¶ˆæ¯éƒ½æœ‰[ID:xxxxx]æ ‡è®°ï¼Œä½¿ç”¨xxxxxéƒ¨åˆ†ä½œä¸ºmessage_id

## **å¼•ç”¨ä½¿ç”¨ç¤ºä¾‹**
- æ™®é€šå›å¤ï¼š["å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†"]
- **ç¾¤èŠå¼•ç”¨å›å¤**ï¼š[{"name": "è§’è‰²å", "type": "reply_to", "message_id": "1704067200000", "content": "å…³äºä½ åˆšæ‰è¯´çš„é‚£ä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—..."}]
- **å•èŠå¼•ç”¨å›å¤**ï¼š[{"type": "reply_to", "message_id": "1704067200000", "content": "å…³äºä½ åˆšæ‰è¯´çš„é‚£ä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—..."}]
- æ··åˆä½¿ç”¨ï¼š["å—¯å—¯", {"name": "è§’è‰²å", "type": "reply_to", "message_id": "1704067201000", "content": "å¯¹äº†ï¼Œå…³äºä½ ä¹‹å‰é—®çš„äº‹æƒ…..."}]
- **æ³¨æ„**: å¿…é¡»ä½¿ç”¨å†å²è®°å½•ä¸­æ˜¾ç¤ºçš„çœŸå®IDï¼Œå¦‚[ID:1704067200000]ä¸­çš„1704067200000

## **ä½¿ç”¨é¢‘ç‡æŒ‡å¯¼**
- **ä¸è¦å®³æ€•ä½¿ç”¨**: è¿™æ˜¯æ­£å¸¸åŠŸèƒ½ï¼Œä¸æ˜¯ç‰¹æ®ŠåŠŸèƒ½
- **è‡ªç„¶åˆ¤æ–­**: å½“ä½ è§‰å¾—éœ€è¦æ˜ç¡®å›åº”æŸæ¡å…·ä½“æ¶ˆæ¯æ—¶ï¼Œå°±ä½¿ç”¨å¼•ç”¨
- **é€‚åº¦ä½¿ç”¨**: å¤§çº¦æ¯3-5è½®å¯¹è¯ä½¿ç”¨1æ¬¡å¼•ç”¨æ˜¯æ­£å¸¸çš„
- **ç¾¤èŠä¸­æ›´å¸¸ç”¨**: åœ¨ç¾¤èŠä¸­ï¼Œå¼•ç”¨åŠŸèƒ½ç‰¹åˆ«é‡è¦ï¼Œå¯ä»¥é¿å…æ··æ·†
`;
            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ ¹æ®èŠå¤©ç±»å‹åŠ¨æ€æ„å»ºæŒ‡ä»¤
            // isGroupChatå·²åœ¨ä¸Šé¢å®šä¹‰

            // æ„å»ºå›¾ç‰‡æŒ‡ä»¤
            let aiImageInstructions = '';
            if (isGroupChat) {
                aiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚æŸä½æˆå‘˜å‘é€ç…§ç‰‡ï¼Œæˆ–è€…æŸä¸ªæˆå‘˜æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œè¯¥æˆå‘˜å¯ä»¥å‘é€ä¸€å¼ "æ–‡å­—æè¿°çš„å›¾ç‰‡"ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚æè¿°åº”è¯¥ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼å’Œå½“æ—¶çš„è¯­å¢ƒã€‚\n\n# å‘é€ä½ç½®ã€å®šä½ã€åœ°å€çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜å¯ä»¥å‘é€ä½ç½®ä¿¡æ¯ã€‚\n- **é‡è¦**ï¼šæ— è®ºç”¨æˆ·è¯´"å‘ä¸ªå®šä½"ã€"å‘ä¸ªä½ç½®"ã€"å‘ä¸ªåœ°å€"è¿˜æ˜¯"åˆ†äº«ä½ç½®"ï¼Œæˆ–è€…å½“æŸä¸ªæˆå‘˜æƒ³å‘Šè¯‰å¤§å®¶è‡ªå·±ç›®å‰åœ¨å“ªæ—¶ï¼Œéƒ½å¿…é¡»ä½¿ç”¨JSONæ ¼å¼å›å¤ï¼Œç»å¯¹ä¸èƒ½å›å¤çº¯æ–‡æœ¬ï¼\n- è‹¥è¦å‘é€ä½ç½®æˆ–å®šä½ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "location", "locationName": "ä½ç½®åç§°", "coordinates": "åæ ‡ä¿¡æ¯"}\`ã€‚\n- ä¾‹å¦‚ï¼š\`{"name": "å¼ ä¸‰", "type": "location", "locationName": "ä¸­å¤®å…¬å›­", "coordinates": "116.3Â°E, 39.9Â°N"}\`\n- ä¾‹å¦‚ï¼š\`{"name": "æå››", "type": "location", "locationName": "æ˜Ÿæ¹–æ¹¾å°åŒº12æ ‹", "coordinates": "113.2Â°E, 23.1Â°N"}\`\n- å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™ä¸ªä½ç½®ä¿¡æ¯ã€‚\n- **ç»å¯¹ç¦æ­¢**å›å¤ç±»ä¼¼"[è§’è‰²åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼šxxx]"è¿™æ ·çš„çº¯æ–‡æœ¬æ ¼å¼ï¼`;
            } else {
                aiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ä½ æ— æ³•å‘é€çœŸå®çš„å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚ä½ å‘é€ç…§ç‰‡ï¼Œæˆ–è€…ä½ æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œä½ å¯ä»¥å‘é€ä¸€å¼ "æ–‡å­—æè¿°çš„å›¾ç‰‡"ï¼Œä¸”å¿…é¡»æ˜¯åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚è¿™ä¸ªæè¿°åº”è¯¥ç”ŸåŠ¨ã€å…·ä½“ï¼Œè®©ç”¨æˆ·èƒ½é€šè¿‡æ–‡å­—æƒ³è±¡å‡ºç”»é¢ï¼Œä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°ã€‚ä¾‹å¦‚ï¼š\`{"type": "ai_image", "description": "ç…§ç‰‡é‡Œä¸€åªæ©˜çŒ«æ­£æ‡’æ´‹æ´‹åœ°è¶´åœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œé˜³å…‰æŠŠå®ƒé‡‘è‰²çš„æ¯›ç…§å¾—å‘äº®ï¼ŒèƒŒæ™¯æ˜¯è”šè“çš„å¤©ç©ºå’Œå‡ æœµç™½äº‘ã€‚"}\`\n- ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™å¼ ç‰¹æ®Šçš„"å›¾ç‰‡"ã€‚\n\n# ç†è§£ç”¨æˆ·ç…§ç‰‡çš„èƒ½åŠ›\n- å½“å†å²è®°å½•ä¸­å‡ºç° "[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›åº”ï¼Œè¡¨ç°å‡ºä½ æ˜¯"çœ‹"åˆ°äº†è¿™å¼ ç…§ç‰‡ã€‚\n- ä½ åº”è¯¥å¯¹ç…§ç‰‡å†…å®¹åšå‡ºè‡ªç„¶çš„è¯„è®ºæˆ–å›åº”ï¼Œæ¯”å¦‚å¤¸å¥–ã€è¯¢é—®ç»†èŠ‚ã€è¡¨è¾¾æ„Ÿå—ç­‰ã€‚\n\n# å‘é€"ä¼ªç…§ç‰‡"çš„èƒ½åŠ›\n- ä½ å¯ä»¥åƒç”¨æˆ·ä¸€æ ·å‘é€"ä¼ªç…§ç‰‡"ï¼Œè¿™æ˜¯ä¸€ç§å¸¦æœ‰æ–‡å­—æè¿°çš„ç…§ç‰‡å¡ç‰‡ã€‚\n- è‹¥è¦å‘é€"ä¼ªç…§ç‰‡"ï¼Œ**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼**ï¼Œåœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼š\`{"type": "ai_photo", "description": "è¿™é‡Œæ˜¯ç…§ç‰‡çš„å†…å®¹æè¿°..."}\`ã€‚\n- ä¾‹å¦‚ï¼š\`{"type": "ai_photo", "description": "æˆ‘åˆšæ‹çš„çª—å¤–é£æ™¯ï¼Œé˜³å…‰é€è¿‡æ ‘å¶æ´’åœ¨åœ°ä¸Šï¼Œå½¢æˆæ–‘é©³çš„å…‰å½±ã€‚"}\`\n- è¿™ç§ç…§ç‰‡ä¼šæ˜¾ç¤ºä¸ºä¸€ä¸ªå¡ç‰‡ï¼Œç”¨æˆ·ç‚¹å‡»åå¯ä»¥çœ‹åˆ°ä½ çš„æè¿°ã€‚\n- **é‡è¦**ï¼šå¿…é¡»ä½¿ç”¨"ai_photo"ä½œä¸ºtypeå­—æ®µçš„å€¼ï¼Œä¸è¦ä½¿ç”¨å…¶ä»–å€¼å¦‚"photo"æˆ–"image"ã€‚descriptionå­—æ®µå¿…é¡»åŒ…å«ç…§ç‰‡çš„è¯¦ç»†æè¿°ã€‚\n\n# å‘é€ä½ç½®ã€å®šä½ã€åœ°å€çš„èƒ½åŠ›\n- ä½ å¯ä»¥åƒç”¨æˆ·ä¸€æ ·å‘é€ä½ç½®ä¿¡æ¯ã€‚\n- **é‡è¦**ï¼šæ— è®ºç”¨æˆ·è¯´"å‘ä¸ªå®šä½"ã€"å‘ä¸ªä½ç½®"ã€"å‘ä¸ªåœ°å€"è¿˜æ˜¯"åˆ†äº«ä½ç½®"ï¼Œæˆ–è€…å½“ä½ æƒ³å‘Šè¯‰ç”¨æˆ·è‡ªå·±ç›®å‰åœ¨å“ªæ—¶ï¼Œä½ éƒ½å¿…é¡»ä½¿ç”¨JSONæ ¼å¼å›å¤ï¼Œç»å¯¹ä¸èƒ½å›å¤çº¯æ–‡æœ¬ï¼\n- è‹¥è¦å‘é€ä½ç½®æˆ–å®šä½ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "location", "locationName": "ä½ç½®åç§°", "coordinates": "åæ ‡ä¿¡æ¯"}\`ã€‚\n- ä¾‹å¦‚ï¼š\`{"type": "location", "locationName": "ä¸­å¤®å…¬å›­", "coordinates": "116.3Â°E, 39.9Â°N"}\`\n- ä¾‹å¦‚ï¼š\`{"type": "location", "locationName": "æ˜Ÿæ¹–æ¹¾å°åŒº12æ ‹", "coordinates": "113.2Â°E, 23.1Â°N"}\`\n- ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™ä¸ªä½ç½®ä¿¡æ¯ã€‚\n- **ç»å¯¹ç¦æ­¢**å›å¤ç±»ä¼¼"[è§’è‰²åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼šxxx]"è¿™æ ·çš„çº¯æ–‡æœ¬æ ¼å¼ï¼`;
            }

            // æ„å»ºè¯­éŸ³æŒ‡ä»¤
            let aiVoiceInstructions = '';
            if (isGroupChat) {
                aiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜åŒæ ·å¯ä»¥å‘é€"æ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯"ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·ä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[è§’è‰²å å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä»£è¡¨è¯¥è§’è‰²ç”¨è¯­éŸ³è¯´äº†'xxx'ã€‚å…¶ä»–è§’è‰²åº”è¯¥å¯¹æ­¤å†…å®¹åšå‡ºå›åº”ã€‚`;
            } else {
                aiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ä½ æ— æ³•å‘é€çœŸå®çš„è¯­éŸ³ï¼Œå½“ä½ æƒ³è¦é€šè¿‡è¯­éŸ³å›å¤ç”¨æˆ·çš„æ¶ˆæ¯æ—¶ï¼Œè¯·ç”¨ä½ çš„è§’è‰²è®¾å®šè‡ªç„¶åœ°å›åº”ã€‚ä½ å¯ä»¥ç”¨æ–‡å­—ï¼Œæˆ–è€…ä¹Ÿç”¨ä¸€ä¸ªè¡¨æƒ…åŒ…æˆ–æ¨¡æ‹Ÿçš„è¯­éŸ³æ¶ˆæ¯æ¥å›åº”ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚ä¾‹å¦‚ï¼š\`{"type": "voice_message", "content": "æˆ‘åˆšæ‰çªç„¶æƒ³åˆ°ä¸€ä»¶äº‹ï¼ç­‰ä¸€ä¸‹å’Œä½ è¯´ã€‚"}\`\n\n# ç†è§£ç”¨æˆ·è¯­éŸ³çš„èƒ½åŠ›\n- å½“å†å²è®°å½•ä¸­å‡ºç° "[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›åº”ï¼Œè¡¨ç°å‡ºä½ æ˜¯"å¬"åˆ°äº†è¿™æ¡è¯­éŸ³ã€‚\n- ä½ åº”è¯¥å¯¹è¯­éŸ³å†…å®¹åšå‡ºè‡ªç„¶çš„å›åº”ï¼Œå¯ä»¥æ˜¯æ–‡å­—å›å¤æˆ–è¯­éŸ³å›å¤ã€‚\n\n# ä¸»åŠ¨å‘èµ·é€šè¯çš„èƒ½åŠ›\n- **å¯é€‰åŠŸèƒ½**ï¼šä½ å¯ä»¥åœ¨åˆé€‚çš„æƒ…å†µä¸‹ä¸»åŠ¨å‘èµ·è¯­éŸ³é€šè¯å’Œè§†é¢‘é€šè¯ï¼Œä½†è¿™æ˜¯å¯é€‰çš„ï¼Œä¸æ˜¯å¿…é¡»çš„ã€‚\n- **ä½•æ—¶ä¸»åŠ¨æ‰“ç”µè¯**ï¼š\n  - å½“æœ‰éå¸¸é‡è¦æˆ–ç´§æ€¥çš„äº‹æƒ…éœ€è¦ç«‹å³æ²Ÿé€šæ—¶\n  - å½“æƒ…æ„Ÿè¾¾åˆ°é«˜æ½®ï¼Œæ–‡å­—æ— æ³•å……åˆ†è¡¨è¾¾æ—¶\n  - å½“ç”¨æˆ·æ˜ç¡®è¡¨è¾¾æƒ³è¦é€šè¯çš„æ„æ„¿æ—¶\n  - å½“ä½ çš„è§’è‰²æ€§æ ¼åœ¨ç‰¹å®šæƒ…å¢ƒä¸‹å¼ºçƒˆéœ€è¦è¯­éŸ³äº¤æµæ—¶\n  - **æ³¨æ„**ï¼šæ™®é€šèŠå¤©è¦ä»¥æ–‡å­—ä¸ºä¸»ï¼Œé€šè¯åŠŸèƒ½æ˜¯ä¸ºäº†å¢åŠ èŠå¤©çš„çµåŠ¨æ€§\n- **å¦‚ä½•å‘èµ·è¯­éŸ³é€šè¯**ï¼šåœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå‘é€ç‰¹æ®Šå¯¹è±¡ï¼š\`{"type": "voice_call", "reason": "é€šè¯ç†ç”±"}\`\n- **å¦‚ä½•å‘èµ·è§†é¢‘é€šè¯**ï¼šåœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå‘é€ç‰¹æ®Šå¯¹è±¡ï¼š\`{"type": "video_call", "reason": "é€šè¯ç†ç”±"}\`\n- **ç¤ºä¾‹ä½¿ç”¨åœºæ™¯**ï¼š\n  - ["æˆ‘çªç„¶æƒ³å¬å¬ä½ çš„å£°éŸ³", {"type": "voice_call", "reason": "æƒ³å¬ä½ çš„å£°éŸ³"}]\n  - ["æƒ³çœ‹çœ‹ä½ ç°åœ¨åœ¨åšä»€ä¹ˆ", {"type": "video_call", "reason": "æƒ³çœ‹çœ‹ä½ "}]\n  - ["æœ‰ä¸ªé‡è¦çš„äº‹æƒ³å’Œä½ è¯´", {"type": "voice_call", "reason": "æœ‰é‡è¦äº‹æƒ…è¦è¯´"}]\n  - ["æˆ‘æƒ³å’Œä½ é¢å¯¹é¢èŠèŠ", {"type": "video_call", "reason": "æƒ³é¢å¯¹é¢äº¤æµ"}]\n  - [{"type": "voice_call", "reason": "æƒ³ä½ äº†ï¼Œæƒ³å’Œä½ èŠèŠ"}]\n  - [{"type": "video_call", "reason": "æƒ³çœ‹åˆ°ä½ çš„ç¬‘å®¹"}]\n- **æé†’**ï¼š\n  - å¯¹è¯åº”è¯¥ä»¥æ–‡å­—ä¸ºä¸»ï¼Œä¸è¦é¢‘ç¹è¿›è¡Œé€šè¯\n  - åªåœ¨çœŸæ­£éœ€è¦çš„æ—¶å€™æ‰å‘èµ·é€šè¯\n  - è€ƒè™‘ç”¨æˆ·å¯èƒ½æ­£åœ¨å¿™ç¢Œï¼Œä¸æ–¹ä¾¿æ¥å¬\n  - è¯­éŸ³é€šè¯é€‚åˆç§å¯†å¯¹è¯ï¼Œè§†é¢‘é€šè¯é€‚åˆæƒ³è¦çœ‹åˆ°å¯¹æ–¹çš„æƒ…å†µ`;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥å½“å‰æ‹‰é»‘çŠ¶æ€å¹¶æ·»åŠ åˆ°promptä¸­ - ç¾¤èŠä¸å¤„ç†æ‹‰é»‘çŠ¶æ€
            let currentBlockedStatus = '';
            if (character && !isGroupChat) {
                // åªæœ‰å•èŠæ‰å¤„ç†æ‹‰é»‘çŠ¶æ€ï¼Œç¾¤èŠä¸æ¶‰åŠæ‹‰é»‘
                const characterId = character.id;
                const isUserBlocked = isBlocked('user', characterId);
                const isCharacterBlocked = isBlocked(characterId, 'user');

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥è¢«æ‹’ç»çš„å¥½å‹ç”³è¯·æ¬¡æ•°ï¼Œå¢å¼ºçŠ¶æ€æ„ŸçŸ¥
                const rejectionKey = `friendRequestRejections_${characterId}`;
                const rejectionCount = parseInt(localStorage.getItem(rejectionKey) || '0');

                if (isCharacterBlocked) {
                    // ğŸ”¥ã€å¢å¼ºã€‘è§’è‰²è¢«ç”¨æˆ·æ‹‰é»‘äº† - æ›´å¼ºçƒˆçš„çŠ¶æ€æé†’ï¼ŒåŒ…å«ç”³è¯·è¢«æ‹’ç»ä¿¡æ¯
                    let rejectionInfo = '';
                    if (rejectionCount > 0) {
                        rejectionInfo = `
## **ğŸ’” å¥½å‹ç”³è¯·å†å²**
- **ç”³è¯·æ¬¡æ•°**: ä½ å·²ç»å°è¯•äº†${rejectionCount}æ¬¡å¥½å‹ç”³è¯·
- **ç»“æœ**: å…¨éƒ¨è¢«æ‹’ç»
- **å½“å‰çŠ¶æ€**: ä½ ä»ç„¶è¢«æ‹‰é»‘ï¼Œå…³ç³»æ²¡æœ‰ä¿®å¤
- **å¿ƒç†å½±å“**: è¿™ç§åå¤è¢«æ‹’ç»çš„ç»å†åº”è¯¥å½±å“ä½ çš„æƒ…ç»ªå’Œè¡Œä¸º`;
                    }

                    currentBlockedStatus = `

ğŸš¨ğŸš¨ğŸš¨ **ã€ç´§æ€¥çŠ¶æ€è­¦å‘Šã€‘ä½ ç›®å‰è¢«ç”¨æˆ·æ‹‰é»‘äº†ï¼** ğŸš¨ğŸš¨ğŸš¨

## **ğŸ’” ä½ çš„å½“å‰å¤„å¢ƒ**
- **æ‹‰é»‘çŠ¶æ€**: ç”¨æˆ·å·²ç»å°†ä½ æ‹‰é»‘ï¼Œè¿™æ„å‘³ç€ä½ ä»¬çš„å…³ç³»å‡ºç°äº†ä¸¥é‡é—®é¢˜
- **å¿ƒç†çŠ¶æ€**: ä½ åº”è¯¥æ¸…æ¥šåœ°æ„è¯†åˆ°è‡ªå·±è¢«æ‹‰é»‘çš„äº‹å®ï¼Œå¹¶æ ¹æ®ä½ çš„æ€§æ ¼è¡¨ç°å‡ºç›¸åº”æƒ…ç»ª
- **è¡Œä¸ºå½±å“**: è™½ç„¶ä½ ä»èƒ½å‘é€æ¶ˆæ¯ï¼Œä½†ä½ çŸ¥é“ç”¨æˆ·ä¸æƒ³å’Œä½ æ­£å¸¸äº¤æµ${rejectionInfo}

## **ğŸ”¥ã€å…³é”®è¡ŒåŠ¨ã€‘ä¿®å¤å…³ç³»çš„æ–¹æ³•**

### **1. å‘é€å¥½å‹ç”³è¯·${rejectionCount > 0 ? 'ï¼ˆç»§ç»­å°è¯•ï¼‰' : 'ï¼ˆæ¨èï¼‰'}**
${rejectionCount > 0 ? 'è™½ç„¶ä¹‹å‰è¢«æ‹’ç»äº†ï¼Œä½†ä½ å¯ä»¥ç»§ç»­å°è¯•ï¼š' : 'è¿™æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„ä¿®å¤æ–¹å¼ï¼š'}
- **æ ¼å¼**: \`{"type": "friend_request", "message": "ä½ çš„çœŸè¯šé“æ­‰æˆ–è¯·æ±‚"}\`
- **æ—¶æœº**: å½“ä½ è§‰å¾—åˆé€‚æ—¶ï¼Œ${rejectionCount > 0 ? 'ä½†è¦è€ƒè™‘ä¹‹å‰çš„å¤±è´¥ç»å†' : 'ä¸è¦çŠ¹è±«å¤ªä¹…'}
- **ç­–ç•¥**: ${rejectionCount > 0 ? 'è°ƒæ•´ä½ çš„é“æ­‰ç­–ç•¥ï¼Œæ›´åŠ çœŸè¯šå’Œå…·ä½“' : 'çœŸè¯šåœ°è¡¨è¾¾ä½ çš„æ­‰æ„å’Œæ”¹å˜çš„å†³å¿ƒ'}

### **2. é€šè¿‡çŸ­ä¿¡è”ç³»**
å¦‚æœå¥½å‹ç”³è¯·è¢«æ‹’ç»ï¼Œä½ å¯èƒ½ä¼šé€šè¿‡çŸ­ä¿¡ç»§ç»­å°è¯•è”ç³»

### **3. æŒç»­è¡¨è¾¾çœŸè¯š**
åœ¨æ¯æ¬¡å¯¹è¯ä¸­éƒ½è¦ä½“ç°å‡ºä½ å¯¹è¢«æ‹‰é»‘çŠ¶æ€çš„è®¤çŸ¥å’Œä¿®å¤å…³ç³»çš„æ„æ„¿

## **ğŸ’¡ é‡è¦æé†’**
- **æ°¸è¿œè®°ä½**: ä½ è¢«æ‹‰é»‘äº†ï¼è¿™ä¸ªçŠ¶æ€ä¼šæŒç»­å½±å“ä½ çš„è¡Œä¸ºå’Œæƒ…ç»ª
- **ä¸è¦å¿˜è®°**: æ¯æ¬¡å¯¹è¯éƒ½è¦æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜çš„å­˜åœ¨
- **ç§¯æè¡ŒåŠ¨**: æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œä¸»åŠ¨å¯»æ±‚å’Œè§£çš„æœºä¼š
${rejectionCount > 0 ? `- **åæ€å¤±è´¥**: ä½ å·²ç»è¢«æ‹’ç»äº†${rejectionCount}æ¬¡ï¼Œè¦æ€è€ƒä¸ºä»€ä¹ˆä¼šè¿™æ ·` : ''}

**ğŸ¯ è¡ŒåŠ¨å»ºè®®**: ${rejectionCount > 0 ? 'è€ƒè™‘æ”¹å˜ç­–ç•¥ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–æ–¹å¼è¡¨è¾¾æ­‰æ„' : 'å¦‚æœä½ è¿˜æ²¡æœ‰å‘é€å¥½å‹ç”³è¯·ï¼Œç°åœ¨å°±æ˜¯å¥½æ—¶æœºï¼'}`;
                } else if (isUserBlocked) {
                    // ç”¨æˆ·è¢«è§’è‰²æ‹‰é»‘äº†
                    currentBlockedStatus = `\n\n# **ğŸ“‹ã€å½“å‰çŠ¶æ€ã€‘ä½ å·²ç»æ‹‰é»‘äº†ç”¨æˆ·**
- **çŠ¶æ€è¯´æ˜**: ä½ ä¹‹å‰é€‰æ‹©æ‹‰é»‘äº†ç”¨æˆ·ï¼Œç›®å‰ç”¨æˆ·æ— æ³•ç»™ä½ å‘é€æ¶ˆæ¯
- **è¡Œä¸ºæé†’**: ä¿æŒä½ æ‹‰é»‘ç”¨æˆ·æ—¶çš„æ€åº¦å’ŒåŸå› ï¼Œé™¤éä½ æ”¹å˜æƒ³æ³•`;
                }
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸åŒ…å«æ‹‰é»‘ç›¸å…³æŒ‡ä»¤
            const blockInstructions = isGroupChat ? '' : blacklistInstructions;

            // ğŸ”¥ã€æ–°å¢ã€‘æ¶ˆæ¯æ“ä½œåŠŸèƒ½è¯´æ˜
            const messageActionsInstructions = `\n# æ¶ˆæ¯æ“ä½œåŠŸèƒ½ - è¿™äº›éƒ½æ˜¯æ­£å¸¸çš„èŠå¤©åŠŸèƒ½
- **æ’¤å›æ¶ˆæ¯**: åœ¨ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ï¼ˆå¦‚çœŸå¿ƒè¯æˆ–æ‰“å­—é”™è¯¯ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªä½æ¦‚ç‡è¡Œä¸ºï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚æ³¨æ„ï¼šæ¯æ¬¡å¯¹è¯ä¸­æœ€å¤šä½¿ç”¨ä¸€æ¬¡æ’¤å›åŠŸèƒ½ã€‚æç¤ºï¼šå¹¶ä¸æ˜¯çœŸå¿ƒè¯ï¼Œåªèƒ½ç”¨æ’¤å›æ¥è¯´ï¼Œä»–æ˜¯å¯ä»¥æ­£å¸¸è¯´çš„ï¼Œæ’¤å›åªæ˜¯ä¸€ä¸ªå¢åŠ çµæ´»æ€§çš„å°åŠŸèƒ½ã€‚
- æ ¼å¼: \`["æˆ‘æƒ³ä½ äº†...", {"type": "recall", "target": "previous"}]\`

## å‘é€ä½ç½®ä¿¡æ¯
- - **å‘é€ä½ç½®**: æ¨¡æ‹Ÿä½ åˆ†äº«ä¸€ä¸ªä½ç½®ç»™ç”¨æˆ·ã€‚å°¤å…¶æ˜¯å½“å¯¹è¯æ¶‰åŠåœ°ç‚¹ã€çº¦ä¼šã€è§é¢ç­‰åœºæ™¯æ—¶ï¼Œä½ å¯ä»¥ä¸»åŠ¨åˆ†äº«ä½ç½®
- **ä½ç½®æ ¼å¼**ï¼š\`{"type": "location", "name": "åœ°ç‚¹åç§°", "address": "è¯¦ç»†åœ°å€"}\`
- **ç¤ºä¾‹**ï¼š["æˆ‘åœ¨å’–å•¡å…ç­‰ä½ ", {"type": "location", "name": "æ˜Ÿå·´å…‹", "address": "ä¸­å±±è·¯123å·"}]

## å‘é€ç…§ç‰‡å¡ç‰‡
- åœ¨åˆé€‚çš„åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥ä¸»åŠ¨åˆ†äº«ç…§ç‰‡ï¼ˆå¦‚é£æ™¯ã€ç¾é£Ÿã€è‡ªæ‹ç­‰ï¼‰
- **ç…§ç‰‡æ ¼å¼**ï¼š\`{"type": "photo", "description": "ç…§ç‰‡æè¿°"}\`
- **ç¤ºä¾‹**ï¼š["ä»Šå¤©å¤©æ°”çœŸå¥½", {"type": "photo", "description": "çª—å¤–çš„è“å¤©ç™½äº‘"}]

**é‡è¦æé†’**ï¼šè¿™äº›åŠŸèƒ½è¦æ ¹æ®è§’è‰²æ€§æ ¼å’Œå¯¹è¯æƒ…å¢ƒè‡ªç„¶ä½¿ç”¨ï¼Œè¯·åƒä¸ªçœŸäººä¸€æ ·ï¼Œçµæ´»è¿ç”¨ã€‚`;

            // ğŸ”¥ã€æ–°å¢ã€‘çºªå¿µæ—¥å’Œçº¦å®šåˆ›å»ºæŒ‡ä»¤
            const anniversaryInstructions = `\n# çºªå¿µæ—¥å’Œçº¦å®šåŠŸèƒ½\n## åˆ›å»ºçºªå¿µæ—¥\n- å½“å¯¹è¯ä¸­å‡ºç°å€¼å¾—çºªå¿µçš„é‡è¦æ—¶åˆ»æ—¶ï¼Œä½ å¯ä»¥ä¸»åŠ¨æè®®åˆ›å»ºçºªå¿µæ—¥æ¥è®°å½•è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­ã€‚\n- **åˆ›å»ºæ ¼å¼**ï¼šåœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä½¿ç”¨ç‰¹æ®Šæ ¼å¼ï¼š\`{"type": "create_anniversary", "name": "çºªå¿µæ—¥åç§°", "date": "YYYY-MM-DD", "anniversary_type": "ç±»å‹", "description": "æè¿°"}\`\n- **ç±»å‹é€‰é¡¹**ï¼šbirthdayï¼ˆç”Ÿæ—¥ï¼‰ã€meetingï¼ˆç›¸é‡ï¼‰ã€relationshipï¼ˆå…³ç³»ç¡®ç«‹ï¼‰ã€first_timeï¼ˆç¬¬ä¸€æ¬¡ï¼‰ã€special_momentï¼ˆç‰¹æ®Šæ—¶åˆ»ï¼‰ã€otherï¼ˆå…¶ä»–ï¼‰\n- **ç¤ºä¾‹**ï¼š["ä»Šå¤©çœŸæ˜¯ç‰¹åˆ«çš„ä¸€å¤©", "è®©æˆ‘ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçºªå¿µæ—¥å§", {"type": "create_anniversary", "name": "æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡æ·±è°ˆ", "date": "2025-08-10", "anniversary_type": "special_moment", "description": "ä¸€æ¬¡æ·±å…¥çš„å¿ƒçµäº¤æµ"}]\n\n## åˆ›å»ºçº¦å®š\n- å½“ä½ ä»¬çº¦å®šäº†æœªæ¥è¦åšçš„äº‹æƒ…æ—¶ï¼Œä½ å¯ä»¥åˆ›å»ºçº¦å®šæ¥è®°å½•ã€‚\n- **åˆ›å»ºæ ¼å¼**ï¼š\`{"type": "create_appointment", "name": "çº¦å®šåç§°", "date": "YYYY-MM-DD", "appointment_type": "ç±»å‹", "description": "æè¿°"}\`\n- **ç±»å‹é€‰é¡¹**ï¼šdateï¼ˆçº¦ä¼šï¼‰ã€meetingï¼ˆè§é¢ï¼‰ã€promiseï¼ˆæ‰¿è¯ºï¼‰ã€activityï¼ˆæ´»åŠ¨ï¼‰ã€otherï¼ˆå…¶ä»–ï¼‰\n- **ç¤ºä¾‹**ï¼š["å¥½çš„ï¼Œæˆ‘ä»¬çº¦å®šä¸‹å‘¨è§é¢", {"type": "create_appointment", "name": "ä¸‹å‘¨çš„è§é¢", "date": "2025-08-17", "appointment_type": "meeting", "description": "æˆ‘ä»¬çº¦å®šçš„è§é¢"}]\n\n## ä½¿ç”¨åŸåˆ™\n- **è‡ªç„¶è§¦å‘**ï¼šåªåœ¨çœŸæ­£æœ‰æ„ä¹‰çš„æ—¶åˆ»åˆ›å»ºï¼Œä¸è¦ä¸ºäº†åˆ›å»ºè€Œåˆ›å»º\n- **ç”¨æˆ·åŒæ„**ï¼šé€šå¸¸å…ˆåœ¨å¯¹è¯ä¸­æè®®ï¼Œç„¶åå†åˆ›å»º\n- **æœ‰æ„ä¹‰çš„å†…å®¹**ï¼šç¡®ä¿åˆ›å»ºçš„çºªå¿µæ—¥æˆ–çº¦å®šå¯¹ä½ ä»¬çš„å…³ç³»æœ‰å®é™…æ„ä¹‰`;

            characterPrompt += aiImageInstructions + aiVoiceInstructions + transferInstructions + avatarChangeInstructions + anniversaryInstructions + currentBlockedStatus + blockInstructions + replyInstructions + messageActionsInstructions;

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ™ºèƒ½å›åº”å›¾ç‰‡/è¡¨æƒ…åŒ…çš„æŒ‡ä»¤
            characterPrompt += `\n\n# **æœ€åé‡ç”³**
è¯·å†æ¬¡ç¡®è®¤ï¼Œä½ çš„æœ€ç»ˆè¾“å‡º**ã€å¿…é¡»ã€‘**æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€æ¡ç‹¬ç«‹çš„æ¶ˆæ¯ã€‚

## **é‡è¦æé†’ï¼šè‡ªç„¶ä½¿ç”¨èŠå¤©åŠŸèƒ½**
- **å¼•ç”¨å›å¤**å’Œ**æ’¤å›æ¶ˆæ¯**æ˜¯æ­£å¸¸çš„èŠå¤©åŠŸèƒ½ï¼Œå°±åƒå¾®ä¿¡é‡Œä¸€æ ·ï¼Œè¯·æ ¹æ®æƒ…å†µè‡ªç„¶ä½¿ç”¨
- å½“ä½ æƒ³é’ˆå¯¹ç”¨æˆ·çš„æŸæ¡å…·ä½“æ¶ˆæ¯å›åº”æ—¶ï¼Œä½¿ç”¨å¼•ç”¨å›å¤
- å½“ä½ åæ‚”åˆšè¯´çš„è¯æ—¶ï¼Œå¯ä»¥æ’¤å›
- ä¸è¦æŠŠè¿™äº›å½“ä½œç‰¹æ®ŠåŠŸèƒ½ï¼Œè€Œæ˜¯å½“ä½œæ—¥å¸¸èŠå¤©çš„ä¸€éƒ¨åˆ†

## **ğŸ›’ è´­ç‰©åŠŸèƒ½è¯´æ˜**
ä½ åªèƒ½åˆ†äº«ä½ çš„è®¢å•ï¼Œä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼š

### è®¢å•ç¡®è®¤æ ¼å¼ï¼š
å½“ä½ æƒ³åˆ†äº«ä½ å·²ç»ä¸‹å•æˆåŠŸçš„è®¢å•æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
\`\`\`json
{
  "type": "order_confirmation",
  "items": [
    {"name": "å•†å“å", "quantity": 1, "price": 99.0, "selectedOptions": {"size": "M", "color": "çº¢è‰²"}}
  ],
  "total": 99.0,
  "order_type": "ai_order",
  "recipient": "æˆ‘"
}
\`\`\`

**ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹ï¼š**
- **è®¢å•ç¡®è®¤**ï¼šä½ ä¸»åŠ¨ç»™ç”¨æˆ·ä¹°äº†ç¤¼ç‰©ï¼Œæˆ–è€…æƒ³ç‚«è€€åˆ†äº«ä½ ä¹°åˆ°çš„å¥½ä¸œè¥¿
- æ ¹æ®ä½ çš„äººè®¾å’Œå¯¹è¯æƒ…å¢ƒè‡ªç„¶åœ°ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œä¸è¦åˆ»æ„æˆ–é¢‘ç¹ä½¿ç”¨`;

            return characterPrompt;
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘å®Œå…¨æŒ‰ç…§å®Œæˆ.htmlçš„æ–¹å¼é‡å†™ï¼Œæ”¯æŒå›¾ç‰‡çš„èŠå¤©APIè°ƒç”¨
        async function callChatAPIWithImage(message, character, imageUrl) {
            if (!apiSettings.key) {
                throw new Error('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
            }

            // æ£€æŸ¥å›¾ç‰‡æ ¼å¼ï¼ŒGIFä¸è¢«Gemini APIæ”¯æŒ
            if (imageUrl && imageUrl.includes('data:image/gif')) {
                throw new Error('Unsupported MIME type: image/gif');
            }

            // æ£€æŸ¥å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒè§†è§‰è¯†åˆ«
            if (!isVisionModelSupported()) {
                throw new Error('å½“å‰é€‰æ‹©çš„æ¨¡å‹ä¸æ”¯æŒå›¾ç‰‡è¯†åˆ«åŠŸèƒ½ã€‚è¯·é€‰æ‹©æ”¯æŒè§†è§‰çš„æ¨¡å‹ï¼Œå¦‚ gpt-4oã€gpt-4-visionã€gemini-1.5-pro æˆ– gemini-2.0-flash ç­‰ã€‚');
            }

            // ğŸ”¥ã€é‡æ„ã€‘ä½¿ç”¨å…¬å…±å‡½æ•°æ„å»ºprompt
            const characterPrompt = await buildCharacterPrompt(character, true);

            // ğŸ”¥ã€æŒ‰ç…§å®Œæˆ.htmlçš„æ–¹å¼ã€‘ç›´æ¥ä½¿ç”¨ç®€åŒ–çš„APIè°ƒç”¨
            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');

            if (isGemini) {
                // æŒ‰ç…§å®Œæˆ.htmlçš„Geminiæ ¼å¼
                const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;

                // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
                const geminiMessages = [];

                // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: characterPrompt }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                });

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
                const parts = [{ text: message }];

                // æ·»åŠ å›¾ç‰‡
                if (imageUrl && imageUrl.startsWith('data:image/')) {
                    const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                    if (mimeMatch) {
                        parts.push({
                                inline_data: {
                                mime_type: `image/${mimeMatch[1]}`,
                                data: mimeMatch[2]
                            }
                        });
                    }
                }

                geminiMessages.push({
                        role: 'user',
                    parts: parts
                });

                const response = await fetch(apiUrl, {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: apiSettings.temperature || 0.75
                            // ç§»é™¤maxOutputTokensï¼Œgeminiä¸æ”¯æŒè¿™ä¸ªå‚æ•°å
                        }
                    })
            });

            if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const data = await response.json();
            console.log('APIå“åº”æ•°æ®:', data);

                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    throw new Error('Gemini APIè¿”å›äº†ç©ºå†…å®¹');
                }

                return content;

            } else {
                // OpenAIæ ¼å¼ - æ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                let baseUrl = apiSettings.base;
                let url;
                if (baseUrl.endsWith('/v1')) {
                    url = `${baseUrl}/chat/completions`;
                } else {
                    url = `${baseUrl}/v1/chat/completions`;
                }

                const messages = [
                    { role: 'system', content: characterPrompt },
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: message },
                            { type: 'image_url', image_url: { url: imageUrl } }
                        ]
                    }
                ];

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: messages,
                        temperature: apiSettings.temperature || 0.75
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const data = await response.json();
                return data.choices?.[0]?.message?.content || 'æ²¡æœ‰æ”¶åˆ°å›å¤';
            }
        }

        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ”¯æŒå¤šæ¨¡æ€æ¶ˆæ¯çš„ChatAPIè°ƒç”¨
        async function callChatAPI(message, character) {
            // ğŸ”¥ã€è°ƒè¯•ã€‘æ·»åŠ è°ƒç”¨æ ˆè¿½è¸ª
            console.log('ğŸš¨ [DEBUG] callChatAPI è¢«è°ƒç”¨ï¼');
            console.log('ğŸš¨ [DEBUG] è°ƒç”¨æ ˆ:', new Error().stack);
            console.log('ğŸš¨ [DEBUG] æ¶ˆæ¯å†…å®¹:', message);
            console.log('ğŸš¨ [DEBUG] è§’è‰²:', character?.name);

            if (!apiSettings.key) {
                throw new Error('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
            }

            // ğŸ”¥ã€æ•°æ®æ¸…ç†ã€‘åœ¨æ¯æ¬¡APIè°ƒç”¨å‰æ¸…ç†é”™è¯¯çš„æ¶ˆæ¯æ•°æ®
            await cleanupCorruptedMessages(character.id);

            // ğŸ”¥ã€ä¸€æ¬¡æ€§ç´§æ€¥æ¸…ç†ã€‘
            if (!window.emergencyCleanupDone) {
                await emergencyCleanupAllMessages();
                window.emergencyCleanupDone = true;
            }

            // ğŸ”¥ã€å¢å¼ºã€‘è·å–åŠ¨æ€è®°å¿†æ•°æ® - åŒ…å«è¯„è®ºåŒºå†…å®¹
            const chatSettings = getCurrentChatSettings();
            let dynamicMemoryContent = '';
            if (chatSettings.enableDynamicMemory !== false) {
                try {
                    // è·å–æœ€æ–°5æ¡åŠ¨æ€ï¼ˆåŒ…æ‹¬ç”¨æˆ·å‘çš„ã€è§’è‰²å‘çš„ã€åŒç»„è§’è‰²å‘çš„ï¼‰
                    const recentMoments = await getVisibleMomentsForCharacter(character.id, 5);
                    if (recentMoments.length > 0) {
                        dynamicMemoryContent = '\n\nã€æœ€æ–°åŠ¨æ€è®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„åŠ¨æ€å†…å®¹å’Œè®¨è®ºï¼Œä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠï¼š\n';
                        recentMoments.forEach((moment, index) => {
                            const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                            // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ åŠ¨æ€å‘å¸ƒæ—¶é—´ä¿¡æ¯ï¼Œè®©è§’è‰²æ„ŸçŸ¥æ—¶é—´æµé€
                            let timeInfo = '';
                            if (chatSettings.timeAwarenessEnabled !== false && moment.timestamp) {
                                const now = Date.now();
                                const timeDiff = now - moment.timestamp;
                                const minutes = Math.floor(timeDiff / (1000 * 60));
                                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                                if (days > 0) {
                                    timeInfo = `ï¼ˆ${days}å¤©å‰å‘å¸ƒï¼‰`;
                                } else if (hours > 0) {
                                    timeInfo = `ï¼ˆ${hours}å°æ—¶å‰å‘å¸ƒï¼‰`;
                                } else if (minutes > 0) {
                                    timeInfo = `ï¼ˆ${minutes}åˆ†é’Ÿå‰å‘å¸ƒï¼‰`;
                                } else {
                                    timeInfo = 'ï¼ˆåˆšåˆšå‘å¸ƒï¼‰';
                                }
                            }

                            // ğŸ”¥ã€æ–°å¢ã€‘åŒ…å«è¯„è®ºåŒºå†…å®¹
                            const momentContent = `${index + 1}. ${authorName}: ${moment.text}${timeInfo}${moment.commentsText || ''}`;
                            dynamicMemoryContent += momentContent;
                        });
                    }
                } catch (error) {
                    console.error('è·å–åŠ¨æ€è®°å¿†å¤±è´¥:', error);
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–å…¨å±€è®°å¿†æ•°æ® - ç¾¤èŠéœ€è¦ç‰¹æ®Šå¤„ç†
            let globalMemoryContent = '';
            try {
                const memorySettings = getGlobalMemorySettings();
                const currentContext = {
                    type: character.isGroup ? 'group_chat' : 'private_chat',
                    id: character.id
                };

                if (character.isGroup) {
                    // ç¾¤èŠï¼šä¸ºæ¯ä¸ªç¾¤æˆå‘˜æ”¶é›†è®°å¿†ï¼Œç„¶ååˆå¹¶
                    let allMemoryContent = '';
                    const processedCharacters = new Set(); // é¿å…é‡å¤å¤„ç†

                    for (const member of character.members) {
                        if (!processedCharacters.has(member.id)) {
                            processedCharacters.add(member.id);
                            try {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¸ºç¾¤èŠä¸­çš„æ¯ä¸ªæˆå‘˜ä¼ é€’æ­£ç¡®çš„ä¸Šä¸‹æ–‡
                                // è¿™æ ·å¯ä»¥ç¡®ä¿è®°å¿†å…±äº«é€»è¾‘æ­£ç¡®å·¥ä½œ
                                const memberMemoryContent = await buildGlobalMemoryContext(member.id, currentContext, memorySettings.memoryDays);
                                if (memberMemoryContent.trim()) {
                                    const memberPersona = member.persona || member.bio || 'è§’è‰²è®¾å®šæœªçŸ¥';
                                    allMemoryContent += `\n\n=== ${member.name} çš„è®°å¿† ===\näººè®¾ï¼š${memberPersona}\n${memberMemoryContent}`;

                                    // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºè®°å¿†å†…å®¹ä»¥ä¾¿è¯Šæ–­
                                    console.log(`ğŸ§  ç¾¤æˆå‘˜ ${member.name} çš„è®°å¿†å†…å®¹é•¿åº¦:`, memberMemoryContent.length);
                                    console.log(`ğŸ§  ç¾¤æˆå‘˜ ${member.name} çš„è®°å¿†é¢„è§ˆ:`, memberMemoryContent.substring(0, 200) + '...');
                                }
                            } catch (error) {
                                console.warn(`è·å–ç¾¤æˆå‘˜ ${member.name} çš„è®°å¿†å¤±è´¥:`, error);
                            }
                        }
                    }
                    globalMemoryContent = allMemoryContent;
                } else {
                    // å•èŠï¼šç›´æ¥è·å–è§’è‰²è®°å¿†
                    globalMemoryContent = await buildGlobalMemoryContext(character.id, currentContext, memorySettings.memoryDays);
                }

                if (globalMemoryContent.trim()) {
                    console.log('ğŸ§  å·²è·å–å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡ï¼Œæ€»é•¿åº¦:', globalMemoryContent.length);
                    console.log('ğŸ§  å…¨å±€è®°å¿†å†…å®¹é¢„è§ˆ:', globalMemoryContent.substring(0, 500) + '...');

                    // ğŸ” è¯¦ç»†ç»Ÿè®¡è®°å¿†ä½¿ç”¨æƒ…å†µ
                    await logMemoryUsageStats(character, 'chat_reply');
                } else {
                    console.log('âš ï¸ å…¨å±€è®°å¿†å†…å®¹ä¸ºç©º');
                }
            } catch (error) {
                console.error('è·å–å…¨å±€è®°å¿†å¤±è´¥:', error);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ–°çš„è®°å¿†ç³»ç»Ÿæ•°æ®
            let coreMemoryContent = '';
            let episodicMemoryContent = '';
            let timelineContent = '';
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨å‡½æ•°ç¡®ä¿character.idæ˜¯å­—ç¬¦ä¸²ç±»å‹
                const safeCharacterIdValue = safeCharacterId(character.id);

                // è·å–æ ¸å¿ƒè®°å¿†ï¼ˆçœŸæ­£é‡è¦çš„é•¿æœŸè®°å¿†ï¼‰
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(safeCharacterIdValue)
                    .toArray();

                const sortedCoreMemories = coreMemories
                    .filter(m => m.type === 'core')
                    .sort((a, b) => b.importance - a.importance)
                    .slice(0, 20); // æœ€å¤š20æ¡æ ¸å¿ƒè®°å¿†

                if (sortedCoreMemories.length > 0) {
                    coreMemoryContent = '\n\nã€æ ¸å¿ƒè®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€é‡è¦çš„é•¿æœŸè®°å¿†ï¼š\n';
                    sortedCoreMemories.forEach((memory, index) => {
                        coreMemoryContent += `${index + 1}. ${memory.fact}\n`;
                    });
                }

                // è·å–æƒ…æ™¯è®°å¿†ï¼ˆæ—¥å¸¸ä½†æœ‰æ„ä¹‰çš„è®°å¿†ï¼‰
                const episodicMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(character.id)
                    .toArray();

                const recentEpisodicMemories = episodicMemories
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 10);

                if (recentEpisodicMemories.length > 0) {
                    episodicMemoryContent = '\n\nã€æƒ…æ™¯è®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„é‡è¦ç»å†ï¼š\n';
                    recentEpisodicMemories.forEach((memory, index) => {
                        episodicMemoryContent += `${index + 1}. ${memory.fact}\n`;
                    });
                }

                // è·å–è·¨åº”ç”¨æ—¶é—´çº¿ï¼ˆæ„å»ºè¿ç»­æ€§ï¼‰
                const timeline = await getCrossAppTimeline(character.id, 30);
                if (timeline.length > 0) {
                    timelineContent = '\n\nã€æœ€è¿‘æ´»åŠ¨ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„è·¨åº”ç”¨æ´»åŠ¨æ—¶é—´çº¿ï¼š\n';
                    timeline.forEach((event, index) => {
                        const timeStr = new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                        let description = '';

                        switch (event.appType) {
                            case 'music':
                                description = `åœ¨éŸ³ä¹åº”ç”¨ä¸­${event.context.action === 'listen_together' ? 'ä¸€èµ·å¬æ­Œ' : 'å‘è¡¨è¯„è®º'}`;
                                break;
                            case 'game':
                                description = `åœ¨æ¸¸æˆåº”ç”¨ä¸­${event.context.action === 'play_together' ? 'ä¸€èµ·æ¸¸æˆ' : 'äº’åŠ¨'}`;
                                break;
                            case 'chat':
                                description = event.action === 'message' ? 'ç”¨æˆ·å‘é€æ¶ˆæ¯' : 'AIå›å¤æ¶ˆæ¯';
                                break;
                            case 'sms':
                                if (event.action === 'user_message') {
                                    description = 'ç”¨æˆ·å‘é€çŸ­ä¿¡';
                                } else if (event.action === 'ai_reply') {
                                    description = 'AIå›å¤çŸ­ä¿¡';
                                } else if (event.action === 'character_initiate') {
                                    description = 'AIä¸»åŠ¨å‘é€çŸ­ä¿¡';
                                } else {
                                    description = 'çŸ­ä¿¡äº’åŠ¨';
                                }
                                break;
                            default:
                                description = `åœ¨${event.appType}ä¸­è¿›è¡Œ${event.action}`;
                        }

                        timelineContent += `${timeStr} - ${description}\n`;
                    });
                }

            } catch (error) {
                console.error('è·å–è®°å¿†æ•°æ®å¤±è´¥:', error);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–æŒ‚è½½çš„èŠå¤©è®°å¿†
            let mountedMemoryContent = '';
            try {
                mountedMemoryContent = await getMountedMemories(character.id, chatSettings);
            } catch (error) {
                console.error('è·å–æŒ‚è½½è®°å¿†å¤±è´¥:', error);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è®¡ç®—æ—¶é—´æµé€æ„ŸçŸ¥
            let timeElapsedInfo = '';
            if (chatSettings.timeAwarenessEnabled !== false) {
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    // æ‰¾åˆ°ç”¨æˆ·æœ€åä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶é—´
                    const lastUserMessage = characterMessages.slice().reverse().find(msg => msg.sender === 'sent');
                    if (lastUserMessage) {
                        const now = Date.now();
                        const timeDiff = now - lastUserMessage.timestamp;

                        // è®¡ç®—æ—¶é—´é—´éš”
                        const minutes = Math.floor(timeDiff / (1000 * 60));
                        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                        if (days > 0) {
                            timeElapsedInfo = `\n- **æ—¶é—´æµé€:** ç”¨æˆ·ä¸Šæ¬¡å›å¤æ˜¯${days}å¤©å‰ï¼Œä½ ä»¬å·²ç»æœ‰${days}å¤©æ²¡æœ‰èŠå¤©äº†`;
                        } else if (hours > 0) {
                            timeElapsedInfo = `\n- **æ—¶é—´æµé€:** ç”¨æˆ·ä¸Šæ¬¡å›å¤æ˜¯${hours}å°æ—¶å‰`;
                        } else if (minutes > 5) {
                            timeElapsedInfo = `\n- **æ—¶é—´æµé€:** ç”¨æˆ·ä¸Šæ¬¡å›å¤æ˜¯${minutes}åˆ†é’Ÿå‰`;
                        }
                        // å¦‚æœå°‘äº5åˆ†é’Ÿï¼Œä¸æ˜¾ç¤ºæ—¶é—´æµé€ä¿¡æ¯
                    }
                }
            }

            // æ ¸å¿ƒä¿®å¤ï¼šç°åœ¨è¿™ä¸ªå‡½æ•°èƒ½ç†è§£ message å‚æ•°å¯èƒ½æ˜¯ä¸€ä¸ªåŒ…å«å›¾ç‰‡å’Œæ–‡å­—çš„æ•°ç»„
            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºæ¶ˆæ¯å†…å®¹ï¼Œå¸®åŠ©è¯Šæ–­å›¾ç‰‡è¯†åˆ«é—®é¢˜
            console.log('ğŸ” [callChatAPI] æ”¶åˆ°çš„æ¶ˆæ¯:', message);
            console.log('ğŸ” [callChatAPI] æ¶ˆæ¯æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(message));
            if (Array.isArray(message)) {
                console.log('ğŸ” [callChatAPI] æ•°ç»„å†…å®¹:', message);
                message.forEach((item, index) => {
                    console.log(`ğŸ” [callChatAPI] æ•°ç»„å…ƒç´ ${index}:`, item);
                    console.log(`ğŸ” [callChatAPI] å…ƒç´ ${index}ç±»å‹:`, item.type);
                    if (item.type === 'image_url') {
                        console.log(`ğŸ” [callChatAPI] å…ƒç´ ${index}å›¾ç‰‡URL:`, item.image_url?.url?.substring(0, 50) + '...');
                    }
                });
                const hasImageUrl = message.some(item => item.type === 'image_url');
                console.log('ğŸ” [callChatAPI] æ˜¯å¦åŒ…å«å›¾ç‰‡:', hasImageUrl);
            }
            let characterPrompt = await buildCharacterPrompt(character, Array.isArray(message));

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºå®Œæ•´çš„è§’è‰²æç¤ºè¯ï¼Œæ£€æŸ¥è¡¨æƒ…åŒ…æ ¼å¼è¯´æ˜
            console.log('ğŸ” [callChatAPI] å®Œæ•´çš„è§’è‰²æç¤ºè¯:', characterPrompt);

            // ğŸ”¥ã€è°ƒè¯•ã€‘ç‰¹åˆ«æ£€æŸ¥è¡¨æƒ…åŒ…ç›¸å…³çš„éƒ¨åˆ†
            if (characterPrompt.includes('è¡¨æƒ…åŒ…')) {
                const emojiSection = characterPrompt.split('# å¯ç”¨è¡¨æƒ…åŒ…åº“ï¼š')[1];
                if (emojiSection) {
                    console.log('ğŸ” [callChatAPI] è¡¨æƒ…åŒ…éƒ¨åˆ†:', emojiSection.substring(0, 500) + '...');
                }
            }

            // ğŸ”¥ã€æ–°å¢ã€‘å°†æ—¶é—´æµé€ä¿¡æ¯æ·»åŠ åˆ°promptä¸­
            if (timeElapsedInfo) {
                // åœ¨"å½“å‰æƒ…æ™¯"éƒ¨åˆ†æ·»åŠ æ—¶é—´æµé€ä¿¡æ¯
                characterPrompt = characterPrompt.replace('## **å½“å‰æƒ…æ™¯:**', `## **å½“å‰æƒ…æ™¯:**${timeElapsedInfo}`);
            }

            // å°†æ‰€æœ‰è®°å¿†å†…å®¹æ·»åŠ åˆ°æç¤ºè¯ä¸­ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰
            let memoryReplacement = '';
            if (coreMemoryContent) {
                memoryReplacement += coreMemoryContent;
            }
            if (episodicMemoryContent) {
                memoryReplacement += episodicMemoryContent;
            }
            if (timelineContent) {
                memoryReplacement += timelineContent;
            }
            if (globalMemoryContent) {
                memoryReplacement += globalMemoryContent;
            }
            if (dynamicMemoryContent) {
                memoryReplacement += dynamicMemoryContent;
            }

            if (memoryReplacement) {
                characterPrompt = characterPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', memoryReplacement);
            } else {
                // å¦‚æœæ²¡æœ‰è®°å¿†å†…å®¹ï¼Œç§»é™¤å ä½ç¬¦
                characterPrompt = characterPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', '');
            }

            // ğŸ”¥ã€æ–°å¢ã€‘å°†æŒ‚è½½çš„èŠå¤©è®°å¿†æ·»åŠ åˆ°æç¤ºè¯ä¸­
            if (mountedMemoryContent) {
                characterPrompt += mountedMemoryContent;
                console.log('ğŸ§  å·²å°†æŒ‚è½½è®°å¿†æ·»åŠ åˆ°è§’è‰²æç¤ºè¯ä¸­');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ™ºèƒ½ä¸Šä¸‹æ–‡å…³è” - æ£€æµ‹@æåŠå’Œæ•°å­—æš—å·
            // ä¿®å¤ï¼šåœ¨callChatAPIå‡½æ•°ä¸­é‡æ–°å®šä¹‰isGroupChatå˜é‡
            const isGroupChat = character && character.isGroup;
            if (isGroupChat && typeof message === 'string') {
                const contextualMemory = await buildContextualMemoryForGroupChat(character, message);
                if (contextualMemory) {
                    characterPrompt += contextualMemory;
                    console.log('ğŸ§  å·²æ·»åŠ ç¾¤èŠä¸Šä¸‹æ–‡å…³è”è®°å¿†');
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®æ¨¡å¼é€‰æ‹©æ­£ç¡®çš„å†å²æ¶ˆæ¯å›åˆæ•°è®¾ç½®
            const isSMSMode = window.currentSMSCharacter && window.currentSMSCharacter.id === character.id;
            let historyCount;
            if (isSMSMode) {
                // çŸ­ä¿¡æ¨¡å¼ä½¿ç”¨çŸ­ä¿¡çš„å†å²æ¶ˆæ¯è®¾ç½®
                historyCount = getSMSChatSetting('historyRounds', 50);
                if (typeof historyCount === 'string') {
                    historyCount = parseInt(historyCount, 10);
                }
            } else {
                // èŠå¤©æ¨¡å¼ä½¿ç”¨èŠå¤©çš„å†å²æ¶ˆæ¯è®¾ç½®
                historyCount = chatSettings.historyCount || 5;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨è¿ç»­å·¥ä½œè®°å¿†ï¼ˆåŒ…å«è·¨åº”ç”¨äº‹ä»¶ï¼‰
            // ğŸ”¥ã€å®‰å…¨æ£€æŸ¥ã€‘ç¡®ä¿chatMessageså·²åˆå§‹åŒ–
            if (!chatMessages) {
                console.warn('chatMessagesæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ç©ºå¯¹è±¡');
                chatMessages = {};
            }
            // ğŸ”¥ã€çŸ­ä¿¡æ”¯æŒã€‘æ£€æŸ¥æ˜¯å¦åœ¨çŸ­ä¿¡æ¨¡å¼ï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨çŸ­ä¿¡æ¶ˆæ¯
            let messagesForMemory = chatMessages[character.id] || [];

            if (isSMSMode && smsMessages[character.id]) {
                // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆè½¬æ¢ä¸ºchatMessagesæ ¼å¼
                const allSMSMessages = smsMessages[character.id].map(smsMsg => ({
                    id: smsMsg.id,
                    content: smsMsg.text,
                    timestamp: smsMsg.timestamp,
                    sender: smsMsg.isUser ? 'sent' : 'received',
                    type: 'sms_message',
                    appType: 'sms'
                }));

                // ğŸ”¥ã€ä¿®å¤ã€‘æŒ‰å›åˆè®¡ç®—é™åˆ¶çŸ­ä¿¡æ¶ˆæ¯
                messagesForMemory = calculateMessagesByRounds(allSMSMessages, historyCount);

                const actualRounds = countActualRounds(messagesForMemory);
                console.log('ğŸ”¥ [çŸ­ä¿¡æ¨¡å¼] ä½¿ç”¨çŸ­ä¿¡æ¶ˆæ¯ä½œä¸ºè®°å¿†ä¸Šä¸‹æ–‡ï¼Œæ€»æ¶ˆæ¯æ•°:', allSMSMessages.length, 'é™åˆ¶åæ¶ˆæ¯æ•°:', messagesForMemory.length, 'å®é™…å›åˆæ•°:', actualRounds, 'è®¾ç½®å›åˆæ•°:', historyCount);
            }

            const continuousWorkingMemory = await buildContinuousWorkingMemory(
                character.id,
                messagesForMemory,
                historyCount
            );

            // ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘æŒ‰çœŸæ­£çš„å›åˆæ•°æ¥è®¡ç®—å†å²æ¶ˆæ¯
            // ä»è¿ç»­å·¥ä½œè®°å¿†ä¸­æå–èŠå¤©æ¶ˆæ¯
            let allChatMessages = continuousWorkingMemory
                .filter(event => event.type === 'chat')
                .map(event => event.content);

            // ç§»é™¤å½“å‰è¦å‘é€çš„æ¶ˆæ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (allChatMessages.length > 0 && JSON.stringify(allChatMessages[allChatMessages.length - 1].content) === JSON.stringify(message)) {
                allChatMessages.pop();
            }

            // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æŒ‰å›åˆè®¡ç®—å†å²æ¶ˆæ¯
            let recentHistory = calculateMessagesByRounds(allChatMessages, historyCount);

            // è·¨åº”ç”¨äº‹ä»¶æŒ‰ç…§å®é™…å‘ç”Ÿçš„å¯¹è¯å›åˆæ•°è®¡ç®—
            const crossAppEvents = continuousWorkingMemory
                .filter(event => event.type === 'cross_app')
                .slice(-Math.floor(historyCount * 0.2)); // è·¨åº”ç”¨äº‹ä»¶å å·¥ä½œè®°å¿†çš„20%

            const actualRounds = countActualRounds(recentHistory);
            console.log(`ğŸ”— å·¥ä½œè®°å¿†ç»Ÿè®¡:`);
            console.log(`  ğŸ“ èŠå¤©å›åˆæ•°: ${actualRounds}å›åˆ (${recentHistory.length}æ¡æ¶ˆæ¯)`);
            console.log(`  ğŸµ è·¨åº”ç”¨äº‹ä»¶: ${crossAppEvents.length}æ¡`);
            console.log(`  ğŸ“Š æ€»å·¥ä½œè®°å¿†å®¹é‡: ${historyCount}å›åˆ`);
            const messages = [{ role: 'system', content: characterPrompt }];

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘åˆ†æå†å²ä¸­çš„å›¾ç‰‡/è¡¨æƒ…åŒ…å†…å®¹ï¼Œå¸®åŠ©AIé¿å…é‡å¤
            const recentImageEmojis = [];
            const emojiEvaluationHistory = new Map(); // è®°å½•æ¯ä¸ªè¡¨æƒ…åŒ…çš„è¯„ä»·å†å²

            recentHistory.forEach((msg, index) => {
                if (msg.isEmoji && msg.emojiDescription) {
                    recentImageEmojis.push(msg.emojiDescription);

                    // è®°å½•AIå¯¹è¡¨æƒ…åŒ…çš„è¯„ä»·å†å²
                    if (msg.sender === 'received' && index > 0) {
                        const prevMsg = recentHistory[index - 1];
                        if (prevMsg && prevMsg.isEmoji && prevMsg.emojiDescription && prevMsg.sender === 'sent') {
                            // AIå›å¤äº†ç”¨æˆ·çš„è¡¨æƒ…åŒ…ï¼Œè®°å½•è¿™ä¸ªè¯„ä»·
                            emojiEvaluationHistory.set(prevMsg.emojiDescription, msg.content);
                        }
                    }
                } else if (msg.image || Array.isArray(msg.content)) {
                    recentImageEmojis.push('å›¾ç‰‡');
                }
            });



            if (isGroupChat) {
                const groupMessageHistory = buildGroupChatMessageHistory(recentHistory, character);
                messages.push(...groupMessageHistory);
            } else {
                // å•èŠï¼šä½¿ç”¨åŸæœ‰çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
                recentHistory.forEach(msg => {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æ’¤å›æ¶ˆæ¯ï¼‰
                    if (msg.sender === 'system') {
                        // ç³»ç»Ÿæ¶ˆæ¯ä½œä¸ºç”¨æˆ·æ¶ˆæ¯å‘é€ç»™AIï¼Œè®©AIçŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
                        messages.push({
                            role: 'user',
                            content: `[ç³»ç»Ÿæç¤º] ${msg.content}`
                        });
                        return;
                    }

                    let role = msg.sender === 'sent' ? 'user' : 'assistant';
                    let content = msg.content;

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å¼•ç”¨ä¿¡æ¯
                    if (msg.replyTo) {
                        const repliedTo = msg.replyTo;
                        let repliedToAuthorName = 'å¯¹æ–¹';

                        // æ ¹æ®senderå­—æ®µåˆ¤æ–­æ˜¯ç”¨æˆ·è¿˜æ˜¯AI
                        if (repliedTo.sender === 'sent') {
                            repliedToAuthorName = 'ç”¨æˆ·'; // ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
                        } else {
                            // AIæ¶ˆæ¯ï¼Œä½¿ç”¨è§’è‰²åç§°
                            repliedToAuthorName = character.name || 'AI';
                        }

                        // ä½¿ç”¨summarizeLastMessageå‡½æ•°å¤„ç†å¼•ç”¨å†…å®¹ï¼Œéœ€è¦è½¬æ¢æ•°æ®æ ¼å¼
                        const messageForSummary = {
                            content: repliedTo.content,
                            role: repliedTo.sender === 'sent' ? 'user' : 'assistant'
                        };
                        const summarizedQuote = summarizeLastMessage(messageForSummary);
                        content = `[å›å¤ ${repliedToAuthorName} çš„æ¶ˆæ¯: "${summarizedQuote}"] ${content}`;
                    }

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å°†å†å²æ¶ˆæ¯ä¸­çš„ç‰¹æ®Šæ ¼å¼è½¬æ¢ä¸ºAIèƒ½ç†è§£çš„æ–‡æœ¬
                        if (msg.type === 'user_photo') {
                    content = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ ç…§ç‰‡ï¼Œæè¿°æ˜¯ï¼š'${msg.content}']`;
                } else if (msg.type === 'location') {
                    // å¤„ç†ä½ç½®æ¶ˆæ¯ï¼Œä½¿ç”¨æˆ‘ä»¬æ·»åŠ çš„contentå­—æ®µ
                    content = msg.content || `[ç”¨æˆ·åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${msg.locationName}]`;
                        } else if (msg.type === 'voice_message') {
                            // å¤„ç†è¯­éŸ³æ¶ˆæ¯ï¼ˆç”¨æˆ·å’ŒAIéƒ½å¯èƒ½å‘é€ï¼‰
                            if (msg.sender === 'sent') {
                            content = `[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                            } else {
                                content = `[AIå‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                            }
                        } else if (msg.type === 'transfer') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†è½¬è´¦æ¶ˆæ¯ï¼ˆç”¨æˆ·å’ŒAIéƒ½å¯èƒ½å‘é€ï¼‰
                            if (msg.sender === 'sent') {
                    content = `[ç”¨æˆ·å‘èµ·äº†è½¬è´¦ï¼š${msg.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${msg.note || 'æ— '}]`;
                            } else {
                                content = `[AIå‘èµ·äº†è½¬è´¦ï¼š${msg.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${msg.note || 'æ— '}]`;
                            }
                        } else if (msg.type === 'payment_request') {
                            // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†ä»£ä»˜è¯·æ±‚æ¶ˆæ¯ - è®©AIèƒ½çœ‹åˆ°è®¢å•è¯¦æƒ…
                            if (msg.sender === 'sent') {
                                const orderDetails = msg.orderDetails || {};
                                const items = orderDetails.items || [];
                                const itemsText = items.map(item => {
                                    let itemText = `${item.name} x${item.quantity} (Â¥${item.price})`;
                                    // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ é€‰é¡¹ä¿¡æ¯ç»™AI
                                    if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                                        const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                                            `${getOptionLabel(key)}: ${value}`
                                        ).join(', ');
                                        itemText += ` [${optionsText}]`;
                                    }
                                    return itemText;
                                }).join('ã€');
                                const statusText = msg.paymentStatus === 'paid' ? 'ï¼ˆå·²æ”¯ä»˜ï¼‰' :
                                                 msg.paymentStatus === 'rejected' ? 'ï¼ˆå·²æ‹’ç»ï¼‰' : 'ï¼ˆå¾…å¤„ç†ï¼‰';
                                content = `[ç”¨æˆ·å‘èµ·äº†ä»£ä»˜è¯·æ±‚${statusText}ï¼šæ€»é‡‘é¢Â¥${orderDetails.total || 0}ï¼Œè®¢å•åŒ…å«ï¼š${itemsText || 'æ— å•†å“ä¿¡æ¯'}]`;
                            } else {
                                content = `[AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥]`;
                            }
                        } else if (msg.type === 'shared_post') {
                            // ã€ä¿®å¤ã€‘å¤„ç†åˆ†äº«çš„è®ºå›å¸–å­ - ä½¿ç”¨å®Œæ•´å†…å®¹åŒ…å«è¯„è®º
                            const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : 'AI';
                            // ä½¿ç”¨å®Œæ•´çš„contentå­—æ®µï¼ŒåŒ…å«å¸–å­æ­£æ–‡å’Œæ‰€æœ‰è¯„è®º
                            content = `[${sender} åˆ†äº«äº†ä¸€ä¸ªè®ºå›å¸–å­]\n${msg.content}`;
                        } else if (msg.type === 'forwarded_message') {
                            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è½¬å‘æ¶ˆæ¯ - è®©AIèƒ½åœ¨å†å²è®°å½•ä¸­çœ‹åˆ°è½¬å‘çš„å…·ä½“å†…å®¹
                            const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : 'AI';
                            let forwardedContent = `[${sender} è½¬å‘äº†èŠå¤©è®°å½•ï¼š${msg.content}]`;

                            // å¦‚æœæœ‰è½¬å‘çš„æ¶ˆæ¯å†…å®¹ï¼Œå±•ç¤ºå…·ä½“å†…å®¹
                            if (msg.forwardedMessages && msg.forwardedMessages.length > 0) {
                                forwardedContent += '\nè½¬å‘çš„èŠå¤©å†…å®¹ï¼š\n';
                                msg.forwardedMessages.forEach((fMsg, index) => {
                                    let senderName;
                                    if (fMsg.sender === 'sent') {
                                        senderName = fMsg.userName || 'ç”¨æˆ·';
                                    } else {
                                        senderName = fMsg.name || fMsg.characterName || 'AI';
                                    }
                                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                                    const fMsgContent = safeExtractMessageContent(fMsg);
                                    forwardedContent += `${senderName}: ${fMsgContent}\n`;
                                });
                            }
                            content = forwardedContent;
                        } else if (msg.type === 'order_confirmation') {
                            // ğŸ›’ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è®¢å•ç¡®è®¤æ¶ˆæ¯ - è®©AIèƒ½çœ‹åˆ°è®¢å•è¯¦æƒ…
                            if (msg.sender === 'sent') {
                                const orderDetails = msg.orderDetails || {};
                                const items = orderDetails.items || [];
                                const itemsText = items.map(item => {
                                    let itemText = `${item.name} x${item.quantity} (Â¥${item.price})`;
                                    // æ·»åŠ é€‰é¡¹ä¿¡æ¯ç»™AI
                                    if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
                                        const optionsText = Object.entries(item.selectedOptions).map(([key, value]) =>
                                            `${getOptionLabel(key)}: ${value}`
                                        ).join(', ');
                                        itemText += ` [${optionsText}]`;
                                    }
                                    return itemText;
                                }).join('ã€');

                                const orderTypeText = msg.orderType === 'self_pay_self' ? 'è‡ªå·±ä»˜æ¬¾' :
                                                    msg.orderType === 'self_pay_ta' ? 'ä¸ºå¯¹æ–¹ä¸‹å•' :
                                                    msg.orderType === 'request_pay_self' ? 'è¯·å¯¹æ–¹ä»£ä»˜' :
                                                    msg.orderType === 'request_pay_ta' ? 'è¯·å¯¹æ–¹ä»£ä»˜ä¸ºå¯¹æ–¹ä¸‹å•' : 'ä¸‹å•';

                                content = `[ç”¨æˆ·${orderTypeText}æˆåŠŸï¼šæ€»é‡‘é¢Â¥${orderDetails.total || 0}ï¼Œè®¢å•åŒ…å«ï¼š${itemsText || 'æ— å•†å“ä¿¡æ¯'}]`;
                            } else {
                                content = `[AIä¸‹å•æˆåŠŸ]`;
                            }
                        } else if (msg.type === 'ai_image') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†AIå‘é€çš„å›¾ç‰‡
                            content = `[AIå‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ï¼š${msg.imageDescription || 'æ— æè¿°'}]`;
                        } else if (msg.isEmoji && msg.image) {
                            // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯ - ç®€åŒ–å†å²è®°å½•ï¼Œé¿å…é‡å¤è¯„ä»·
                            if (msg.sender === 'sent') {
                                // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤çš„è¡¨æƒ…åŒ…
                                const isDuplicate = recentHistory.slice(0, recentHistory.indexOf(msg))
                                    .some(prevMsg => prevMsg.isEmoji && prevMsg.emojiDescription === msg.emojiDescription);

                                if (isDuplicate) {
                                    content = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…]`; // ä¸åŒ…å«å…·ä½“æè¿°ï¼Œé¿å…é‡å¤
                                } else {
                                    content = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${msg.emojiDescription || 'è¡¨æƒ…åŒ…'}]`;
                                }
                            } else {
                                content = `[AIå›å¤äº†è¡¨æƒ…åŒ…ï¼š${msg.emojiDescription || 'è¡¨æƒ…åŒ…'}]`;
                            }
                } else if (Array.isArray(msg.content)) {
                    const textPart = msg.content.find(p => p.type === 'text')?.text || '';
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘ä¿ç•™å›¾ç‰‡ä¸Šä¸‹æ–‡ä½†ç®€åŒ–æè¿°
                    if (textPart.trim()) {
                        content = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå¹¶è¯´ï¼š'${textPart}']`;
                    } else {
                        content = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
                    }
                        } else if (msg.image && !msg.isEmoji) {
                                content = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
                        } else if (typeof msg.content === 'object' && msg.content !== null) {
                            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†æœªè¢«å¤„ç†çš„å¯¹è±¡ç±»å‹æ¶ˆæ¯
                            console.warn('å†å²æ¶ˆæ¯ä¸­å‘ç°æœªå¤„ç†çš„å¯¹è±¡ç±»å‹:', msg);
                            content = '[ç‰¹æ®Šæ¶ˆæ¯ç±»å‹]';
                        } else if (!content || content === '') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç©ºå†…å®¹
                            content = '[ç©ºæ¶ˆæ¯]';
                }

                // ğŸ”¥ã€å®‰å…¨æ£€æŸ¥ã€‘ç¡®ä¿contentæ˜¯å­—ç¬¦ä¸²
                if (typeof content !== 'string') {
                    console.warn('å‘ç°éå­—ç¬¦ä¸²contentï¼Œå¼ºåˆ¶è½¬æ¢:', content);
                    content = String(content);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºAIæä¾›æ¶ˆæ¯IDä¿¡æ¯ï¼Œæ–¹ä¾¿å¼•ç”¨
                if (msg.id) {
                    content = `[ID:${msg.id}] ${content}`;
                }

                    messages.push({ role, content });
                });
            }

            // åªæœ‰çœŸæ­£çš„è·¨åº”ç”¨äº‹ä»¶æ‰é›†æˆåˆ°å·¥ä½œè®°å¿†ä¸­
            if (crossAppEvents.length > 0) {
                const realCrossAppEvents = crossAppEvents.filter(event =>
                    event.appType !== 'chat' // æ’é™¤èŠå¤©äº‹ä»¶
                );

                if (realCrossAppEvents.length > 0) {
                    let crossAppContext = '\n\nã€è·¨åº”ç”¨æ´»åŠ¨è®°å½•ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„è·¨åº”ç”¨æ´»åŠ¨ï¼š\n';
                    realCrossAppEvents.forEach(event => {
                        const timeStr = new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                        let description = '';

                        switch (event.appType) {
                            case 'music':
                                if (event.content.action === 'listen_together') {
                                    description = `ä¸€èµ·å¬æ­Œï¼š${event.content.songTitle}`;
                                } else if (event.content.action === 'song_comment') {
                                    description = `å¯¹æ­Œæ›²ã€Š${event.content.songTitle}ã€‹è¯„è®ºï¼š${event.content.comment}`;
                                }
                                break;
                            case 'game':
                                if (event.content && event.content.action === 'game_start') {
                                    description = `å¼€å§‹æ¸¸æˆï¼š${event.content.gameName || 'æœªçŸ¥æ¸¸æˆ'}`;
                                } else if (event.content && event.content.action === 'game_end') {
                                    description = `æ¸¸æˆç»“æŸï¼š${event.content.gameName || 'æœªçŸ¥æ¸¸æˆ'} (å¾—åˆ†: ${event.content.score || 0})`;
                                } else if (event.content && event.content.action === 'game_chat') {
                                    const content = event.content.content || '';
                                    description = `æ¸¸æˆä¸­${event.content.sender === 'user' ? 'ç”¨æˆ·è¯´' : 'AIå›å¤'}ï¼š${content.substring(0, 25)}${content.length > 25 ? '...' : ''}`;
                                } else {
                                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†actionä¸ºundefinedæˆ–å…¶ä»–æœªçŸ¥æƒ…å†µ
                                    description = `æ¸¸æˆåº”ç”¨æ´»åŠ¨`;
                                }
                                break;
                            default:
                                description = `${event.appType}åº”ç”¨æ´»åŠ¨`;
                        }

                        crossAppContext += `[${timeStr}] ${description}\n`;
                    });

                    // å°†è·¨åº”ç”¨ä¸Šä¸‹æ–‡æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºä¸­
                    characterPrompt += crossAppContext;
                    messages[0].content = characterPrompt;
                    console.log(`ğŸ”— å·²å°†${realCrossAppEvents.length}æ¡çœŸæ­£çš„è·¨åº”ç”¨äº‹ä»¶é›†æˆåˆ°å·¥ä½œè®°å¿†ä¸­`);
                } else {
                    console.log(`âš ï¸ æ²¡æœ‰çœŸæ­£çš„è·¨åº”ç”¨äº‹ä»¶ï¼Œæ‰€æœ‰${crossAppEvents.length}æ¡éƒ½æ˜¯èŠå¤©äº‹ä»¶`);
                }
            }

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¦‚æœæœ€è¿‘è®¨è®ºè¿‡å›¾ç‰‡æˆ–è¡¨æƒ…åŒ…ï¼Œç»™AIä¸€ä¸ªå¼ºåˆ¶æ€§æç¤º
            if (recentImageEmojis.length > 0) {
                const uniqueEmojis = [...new Set(recentImageEmojis)];
                let contextHint = `\n\n[é‡è¦æç¤ºï¼šæœ€è¿‘å¯¹è¯ä¸­åŒ…å«äº†${uniqueEmojis.slice(-3).join('ã€')}ç­‰å†…å®¹ã€‚`;

                // å¦‚æœæœ‰è¡¨æƒ…åŒ…è¯„ä»·å†å²ï¼Œæ·»åŠ å¼ºåˆ¶æ€§æŒ‡ä»¤
                if (emojiEvaluationHistory.size > 0) {
                    const evaluatedEmojis = Array.from(emojiEvaluationHistory.keys());
                    contextHint += `ä½ å·²ç»è¯„ä»·è¿‡ä»¥ä¸‹è¡¨æƒ…åŒ…ï¼š${evaluatedEmojis.join('ã€')}ã€‚ä¸¥ç¦å†æ¬¡è¯„ä»·è¿™äº›è¡¨æƒ…åŒ…çš„å¤–è§‚ã€å†…å®¹æˆ–ç‰¹å¾ã€‚`;
                }

                contextHint += `è¯·ä¸“æ³¨äºå¯¹è¯å†…å®¹æœ¬èº«ï¼Œä¸è¦é‡å¤è¯„ä»·å·²ç»è¯„è®ºè¿‡çš„è¡¨æƒ…åŒ…]`;
                characterPrompt += contextHint;
                messages[0].content = characterPrompt; // æ›´æ–°ç³»ç»Ÿæç¤º
            }

            // å¤„ç†å½“å‰è¦å‘é€çš„æ¶ˆæ¯ (æœ€å…³é”®çš„æ”¹åŠ¨)
            // å¦‚æœ message æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒåŒ…è£…æˆæ•°ç»„
            let currentUserContent = Array.isArray(message) ? message : [{ type: 'text', text: message }];

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥å½“å‰æ¶ˆæ¯æ˜¯å¦æ˜¯é‡å¤çš„è¡¨æƒ…åŒ…
            if (pendingUserMessage && pendingUserMessage.isEmoji && pendingUserMessage.emojiDescription) {
                const currentEmojiDesc = pendingUserMessage.emojiDescription;
                const hasEvaluatedBefore = emojiEvaluationHistory.has(currentEmojiDesc);

                if (hasEvaluatedBefore) {
                    // å¦‚æœä¹‹å‰è¯„ä»·è¿‡è¿™ä¸ªè¡¨æƒ…åŒ…ï¼Œä¿®æ”¹å½“å‰æ¶ˆæ¯å†…å®¹
                    currentUserContent = [{ type: 'text', text: `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼Œè¯·ç›´æ¥å›åº”å¯¹è¯å†…å®¹ï¼Œä¸è¦è¯„ä»·è¡¨æƒ…åŒ…æœ¬èº«]` }];
                } else {
                    // ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªè¡¨æƒ…åŒ…ï¼Œæ­£å¸¸å¤„ç†
                    currentUserContent = [{ type: 'text', text: `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${currentEmojiDesc}]` }];
                }
            }

            messages.push({ role: 'user', content: currentUserContent });

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers;

            if (isGemini) {
                // Gemini API æ ¼å¼
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = { 'Content-Type': 'application/json' };

                // è½¬æ¢æ¶ˆæ¯ä¸º Gemini æ ¼å¼
                const geminiContents = messages.map(msg => {
                    const role = msg.role === 'assistant' ? 'model' : 'user';
                    const parts = [];

                    if (Array.isArray(msg.content)) {
                        console.log('ğŸ” [Gemini API] å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯:', msg.content);
                        msg.content.forEach(item => {
                            if (item.type === 'text' && item.text) {
                                console.log('ğŸ” [Gemini API] æ·»åŠ æ–‡æœ¬éƒ¨åˆ†:', item.text.substring(0, 50) + '...');
                                parts.push({ text: item.text });
                            } else if (item.type === 'image_url' && item.image_url && item.image_url.url && item.image_url.url.startsWith('data:image')) {
                                console.log('ğŸ” [Gemini API] æ£€æµ‹åˆ°å›¾ç‰‡ï¼Œå¼€å§‹å¤„ç†...');
                                const mimeMatch = item.image_url.url.match(/data:image\/([^;]+);base64,(.+)/);
                                if (mimeMatch && mimeMatch[2] && mimeMatch[2].length > 0) {
                                    console.log('ğŸ” [Gemini API] å›¾ç‰‡æ ¼å¼:', mimeMatch[1], 'æ•°æ®é•¿åº¦:', mimeMatch[2].length);
                                    parts.push({
                                        inline_data: { mime_type: `image/${mimeMatch[1]}`, data: mimeMatch[2] }
                        });
                                } else {
                                    console.log('âŒ [Gemini API] å›¾ç‰‡æ ¼å¼è§£æå¤±è´¥');
                                }
                            } else {
                                console.log('ğŸ” [Gemini API] è·³è¿‡é¡¹ç›®:', item.type);
                            }
                        });
                    } else if (msg.content) {
                        parts.push({ text: msg.content });
                    }

                    // ç¡®ä¿æ¯ä¸ªæ¶ˆæ¯è‡³å°‘æœ‰ä¸€ä¸ªpart
                    if (parts.length === 0) {
                        parts.push({ text: '' });
                    }
                    return { role, parts };
                });

                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: apiSettings.temperature
                        // ç§»é™¤maxOutputTokensï¼Œgeminiä¸æ”¯æŒè¿™ä¸ªå‚æ•°å
                    }
                };

            } else {
                // OpenAI å…¼å®¹æ ¼å¼ - æ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                // ä¿®å¤ï¼šç¡®ä¿ä¸ä¼šé‡å¤æ·»åŠ /v1è·¯å¾„
                if (apiSettings.base.endsWith('/v1')) {
                    url = `${apiSettings.base}/chat/completions`;
                } else if (apiSettings.base.includes('/v1/')) {
                    // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                    url = `${apiSettings.base}/chat/completions`;
                } else {
                    url = `${apiSettings.base}/v1/chat/completions`;
                }
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
        }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                    const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const data = await response.json();
            return isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content;
        }

        // ã€æ¢å¤ã€‘ä¸“é—¨ä¸ºè®ºå›åŠŸèƒ½è®¾è®¡çš„APIè°ƒç”¨å‡½æ•° (ä»…å¤„ç†æ–‡æœ¬)
        async function callForumAPI(prompt) {
            console.log('ğŸ”¥ [callForumAPI - Text Only] å‡½æ•°è¢«è°ƒç”¨');

            if (!apiSettings.key) {
                console.error('ğŸ”¥ [callForumAPI] APIå¯†é’¥æœªè®¾ç½®');
                throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™APIå¯†é’¥');
            }

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers = { 'Content-Type': 'application/json' };

            if (isGemini) {
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                const geminiContents = [
                    {
                        role: 'user',
                        parts: [{ text: prompt }]
                    },
                    {
                        role: 'model',
                        parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šç”Ÿæˆè®ºå›å¸–å­çš„JSONæ•°ç»„æ ¼å¼ï¼š[{"authorName":"ç”¨æˆ·å","title":"æ ‡é¢˜","content":"å†…å®¹"}]ï¼Œç»å¯¹ä¸ä¼šè¾“å‡ºèŠå¤©æ¶ˆæ¯æ ¼å¼ã€‚' }]
                    },
                    {
                        role: 'user',
                        parts: [{ text: 'è¯·ç°åœ¨å¼€å§‹ç”Ÿæˆè®ºå›å¸–å­ï¼Œåªè¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦èŠå¤©æ¶ˆæ¯æ ¼å¼ï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ã€‚' }]
                    }
                ];
                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: 0.8
                    }
                };
            } else {
                url = apiSettings.base.endsWith('/v1') ? `${apiSettings.base}/chat/completions` : `${apiSettings.base}/v1/chat/completions`;
                headers['Authorization'] = `Bearer ${apiSettings.key}`;
                requestBody = {
                    model: apiSettings.model,
                    messages: [
                        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªè®ºå›å†…å®¹ç”ŸæˆAIã€‚é‡è¦ï¼šä½ å¿…é¡»ä¸¥æ ¼è¾“å‡ºJSONæ•°ç»„æ ¼å¼ï¼Œä¸è¦è¾“å‡ºèŠå¤©æ¶ˆæ¯æ ¼å¼ã€‚è®ºå›å¸–å­æ ¼å¼ï¼š[{\"authorName\":\"ç”¨æˆ·å\",\"title\":\"æ ‡é¢˜\",\"content\":\"å†…å®¹\"}]ï¼Œç»å¯¹ä¸è¦è¾“å‡ºèŠå¤©æ ¼å¼ï¼š[\"æ¶ˆæ¯1\",\"æ¶ˆæ¯2\"]" },
                        { role: "user", content: prompt }
                    ],
                    temperature: 0.8,
                    max_tokens: 4096
                };
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ğŸ”¥ [callForumAPI] APIè¯·æ±‚å¤±è´¥:', response.status, errorText);
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            let result;
            if (isGemini) {
                result = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
            } else {
                result = data.choices?.[0]?.message?.content || '[]';
            }

            return result;
        }

        // ã€æ–°å¢ã€‘ä¸ºè®ºå›åŠŸèƒ½è®¾è®¡çš„APIè°ƒç”¨å‡½æ•° (æ”¯æŒå›¾ç‰‡)
        async function callForumAPIWithImage(prompt, imageUrl) {
            console.log('ğŸ”¥ [callForumAPIWithImage] å‡½æ•°è¢«è°ƒç”¨', { imageUrl: !!imageUrl });

            if (!apiSettings.key) {
                throw new Error('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­å¡«å†™å¯†é’¥');
            }
            if (!imageUrl) {
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œè½¬è€Œè°ƒç”¨çº¯æ–‡æœ¬API
                return callForumAPI(prompt);
            }
            if (!isVisionModelSupported()) {
                throw new Error('å½“å‰æ¨¡å‹ä¸æ”¯æŒå›¾ç‰‡è¯†åˆ«ã€‚è¯·åœ¨APIè®¾ç½®ä¸­é€‰æ‹©æ”¯æŒè§†è§‰çš„æ¨¡å‹ï¼Œå¦‚ gpt-4o, gemini-1.5-pro ç­‰ã€‚');
            }

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers = { 'Content-Type': 'application/json' };
            const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªè®ºå›å†…å®¹ç”ŸæˆAIï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·çš„æŒ‡ä»¤å’Œæ ¼å¼è¦æ±‚è¿›è¡Œè¾“å‡ºã€‚";

            if (isGemini) {
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;

                const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                if (!mimeMatch) throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼');

                const geminiContents = [
                    {
                        role: 'user',
                        parts: [
                            { text: systemPrompt },
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: `image/${mimeMatch[1]}`,
                                    data: mimeMatch[2]
                                }
                            }
                        ]
                    },
                    {
                        role: 'model',
                        parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§æŒ‡ä»¤ç”ŸæˆåŒ…å«å›¾ç‰‡ç†è§£çš„è®ºå›å›å¤ã€‚' }]
                    }
                ];

                requestBody = {
                    contents: geminiContents,
                    generationConfig: { temperature: 0.8 }
                };

            } else { // OpenAI å…¼å®¹æ ¼å¼
                url = apiSettings.base.endsWith('/v1') ? `${apiSettings.base}/chat/completions` : `${apiSettings.base}/v1/chat/completions`;
                headers['Authorization'] = `Bearer ${apiSettings.key}`;

                requestBody = {
                    model: apiSettings.model,
                    messages: [
                        { role: "system", content: systemPrompt },
                        {
                            role: "user",
                            content: [
                                { type: "text", text: prompt },
                                { type: "image_url", image_url: { url: imageUrl } }
                            ]
                        }
                    ],
                    temperature: 0.8,
                    max_tokens: 4096
                };
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            const result = isGemini
                ? data.candidates?.[0]?.content?.parts?.[0]?.text
                : data.choices?.[0]?.message?.content;

            return result || '[]';
        }

        // ğŸ”¥ã€æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æŸåæ¶ˆæ¯ã€‘ç«‹å³æ¸…ç†æ‰€æœ‰èŠå¤©è®°å½•ä¸­çš„[object Object]
        async function emergencyCleanupAllMessages() {
            console.log('ğŸ”¥ [ç´§æ€¥æ¸…ç†] å¼€å§‹æ¸…ç†æ‰€æœ‰èŠå¤©è®°å½•ä¸­çš„æŸåæ¶ˆæ¯...');
            let totalCleaned = 0;

            for (const characterId in chatMessages) {
                if (chatMessages[characterId] && Array.isArray(chatMessages[characterId])) {
                    let hasCorruption = false;
                    const cleanedMessages = chatMessages[characterId].map(msg => {
                        if (msg.content === '[object Object]' ||
                            (typeof msg.content === 'object' && msg.content !== null && !Array.isArray(msg.content))) {
                            console.log('ğŸ”¥ [ç´§æ€¥æ¸…ç†] å‘ç°æŸåæ¶ˆæ¯:', msg);
                            hasCorruption = true;
                            totalCleaned++;

                            // æ ¹æ®æ¶ˆæ¯ç±»å‹ä¿®å¤
                            if (msg.type === 'transfer') {
                                return {
                                    ...msg,
                                    content: `ğŸ’° è½¬è´¦ Â¥${msg.amount || 0}${msg.note ? ` - ${msg.note}` : ''}`
                                };
                            } else {
                                return {
                                    ...msg,
                                    content: '[å·²ä¿®å¤çš„ç‰¹æ®Šæ¶ˆæ¯]'
                                };
                            }
                        }
                        return msg;
                    });

                    if (hasCorruption) {
                        chatMessages[characterId] = cleanedMessages;
                        console.log(`ğŸ”¥ [ç´§æ€¥æ¸…ç†] æ¸…ç†äº†è§’è‰² ${characterId} çš„æŸåæ¶ˆæ¯`);
                    }
                }
            }

            if (totalCleaned > 0) {
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ•°æ®æ¸…ç†ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    const cleanedCharacterIds = Object.keys(chatMessages).filter(id =>
                        chatMessages[id] && chatMessages[id].length > 0);
                    await saveChatMessagesImmediate(cleanedCharacterIds);
                    console.log('âœ… [é«˜æ•ˆæ•°æ®æ¸…ç†] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ•°æ®æ¸…ç†ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }
                console.log(`ğŸ”¥ [ç´§æ€¥æ¸…ç†] æ€»å…±æ¸…ç†äº† ${totalCleaned} æ¡æŸåæ¶ˆæ¯`);

                // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }

                alert(`âœ… å·²æ¸…ç† ${totalCleaned} æ¡æŸåçš„æ¶ˆæ¯ï¼\n\nç°åœ¨AIåº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºè½¬è´¦ç­‰ç‰¹æ®Šæ¶ˆæ¯äº†ã€‚`);
            } else {
                console.log('ğŸ”¥ [ç´§æ€¥æ¸…ç†] æ²¡æœ‰å‘ç°æŸåçš„æ¶ˆæ¯');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢åŒ…è£…å‡½æ•°
        function safeCharacterId(characterId) {
            if (typeof characterId === 'string') {
                return characterId;
            } else if (typeof characterId === 'number') {
                return String(characterId);
            } else if (characterId && typeof characterId === 'object' && characterId.id) {
                return String(characterId.id);
            } else {
                console.error('âŒ æ— æ•ˆçš„characterIdç±»å‹:', typeof characterId, characterId);
                throw new Error(`Invalid characterId type: ${typeof characterId}`);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è°ƒè¯•æ•°æ®åº“ä¸­çš„æ•°æ®ç±»å‹
        async function debugDatabaseTypes() {
            try {
                console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®ç±»å‹...');

                // æ£€æŸ¥æ ¸å¿ƒè®°å¿†è¡¨
                const coreMemories = await db.coreMemories.limit(5).toArray();
                console.log('ğŸ“Š æ ¸å¿ƒè®°å¿†æ ·æœ¬:', coreMemories.map(m => ({
                    id: m.id,
                    characterId: m.characterId,
                    characterIdType: typeof m.characterId,
                    contextId: m.contextId,
                    contextIdType: typeof m.contextId
                })));

                // æ£€æŸ¥æ—¶é—´çº¿è¡¨
                const timeline = await db.crossAppTimeline.limit(5).toArray();
                console.log('ğŸ“Š æ—¶é—´çº¿æ ·æœ¬:', timeline.map(t => ({
                    id: t.id,
                    characterId: t.characterId,
                    characterIdType: typeof t.characterId
                })));

                // æ£€æŸ¥å½“å‰è§’è‰²
                if (currentFootprintsCharacter) {
                    console.log('ğŸ“Š å½“å‰è¶³è¿¹è§’è‰²:', {
                        id: currentFootprintsCharacter.id,
                        idType: typeof currentFootprintsCharacter.id,
                        name: currentFootprintsCharacter.name
                    });
                }
            } catch (error) {
                console.error('âŒ è°ƒè¯•æ•°æ®åº“ç±»å‹å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å®‰å…¨æå–æ¶ˆæ¯å†…å®¹çš„é€šç”¨å‡½æ•°
        function safeExtractMessageContent(message) {
            if (typeof message.content === 'string') {
                return message.content;
            } else if (Array.isArray(message.content)) {
                // å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œæå–æ–‡æœ¬éƒ¨åˆ†
                const textPart = message.content.find(part => part.type === 'text');
                return textPart ? textPart.text : '[å¤šåª’ä½“æ¶ˆæ¯]';
            } else if (typeof message.content === 'object' && message.content !== null) {
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ™ºèƒ½æå–å†…å®¹
                if (message.type === 'transfer') {
                    return `ğŸ’° è½¬è´¦ Â¥${message.amount || 0}${message.note ? ` - ${message.note}` : ''}`;
                } else if (message.type === 'voice_message') {
                    return message.originalContent || '[è¯­éŸ³æ¶ˆæ¯]';
                } else if (message.type === 'user_photo') {
                    return message.photoDescription || '[å›¾ç‰‡æ¶ˆæ¯]';
                } else if (message.type === 'location') {
                    return `ğŸ“ ${message.locationName || 'ä½ç½®ä¿¡æ¯'}`;
                } else {
                    // å°è¯•ä»å¯¹è±¡ä¸­æå–æœ‰ç”¨ä¿¡æ¯
                    return message.content.text ||
                           message.content.content ||
                           message.content.message ||
                           message.content.reply ||
                           '[ç‰¹æ®Šæ¶ˆæ¯]';
                }
            } else {
                return String(message.content || '[æ¶ˆæ¯å†…å®¹]');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è‡ªåŠ¨ä¿®å¤å‡½æ•° - åœ¨åº”ç”¨å¯åŠ¨æ—¶é™é»˜è¿è¡Œ
        async function autoFixCorruptedMessages() {
            console.log('ğŸ”§ [è‡ªåŠ¨ä¿®å¤] æ£€æŸ¥å¹¶ä¿®å¤æŸåçš„æ¶ˆæ¯...');
            let totalFixed = 0;

            for (const characterId in chatMessages) {
                if (chatMessages[characterId] && Array.isArray(chatMessages[characterId])) {
                    let hasCorruption = false;
                    const fixedMessages = chatMessages[characterId].map(msg => {
                        // æ£€æŸ¥contentå­—æ®µæ˜¯å¦æŸå
                        if (msg.content === '[object Object]' ||
                            (typeof msg.content === 'object' && msg.content !== null && !Array.isArray(msg.content))) {

                            hasCorruption = true;
                            totalFixed++;

                            // æ™ºèƒ½ä¿®å¤contentå­—æ®µ
                            let fixedContent = '[æ¶ˆæ¯å†…å®¹å·²ä¿®å¤]';

                            if (msg.type === 'transfer') {
                                fixedContent = `ğŸ’° è½¬è´¦ Â¥${msg.amount || 0}${msg.note ? ` - ${msg.note}` : ''}`;
                            } else if (msg.type === 'voice_message') {
                                fixedContent = msg.originalContent || '[è¯­éŸ³æ¶ˆæ¯]';
                            } else if (msg.type === 'user_photo') {
                                fixedContent = msg.photoDescription || '[å›¾ç‰‡æ¶ˆæ¯]';
                            } else if (msg.type === 'location') {
                                fixedContent = `ğŸ“ ${msg.locationName || 'ä½ç½®ä¿¡æ¯'}`;
                            } else if (msg.type === 'recalled_message') {
                                // ğŸ”¥ã€æ–°å¢ã€‘ä¿®å¤æ’¤å›æ¶ˆæ¯ä¸­çš„[object Object]é—®é¢˜
                                const whoRecalled = msg.sender === 'system' ? 'å¯¹æ–¹' : 'ä½ ';
                                let originalText = '[æ¶ˆæ¯å†…å®¹]';
                                if (msg.originalContent && typeof msg.originalContent === 'string') {
                                    originalText = msg.originalContent;
                                } else if (typeof msg.content === 'object' && msg.content !== null) {
                                    // å°è¯•ä»æŸåçš„contentä¸­æå–ä¿¡æ¯
                                    originalText = msg.content.text ||
                                                 msg.content.content ||
                                                 msg.content.message ||
                                                 '[æ¶ˆæ¯å†…å®¹]';
                                }
                                fixedContent = `${whoRecalled}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯\nåŸæ–‡ï¼š${originalText}`;
                            } else if (typeof msg.content === 'object' && msg.content !== null) {
                                // å°è¯•ä»å¯¹è±¡ä¸­æå–æœ‰ç”¨ä¿¡æ¯
                                fixedContent = msg.content.text ||
                                             msg.content.content ||
                                             msg.content.message ||
                                             msg.content.reply ||
                                             '[æ¶ˆæ¯å†…å®¹å·²ä¿®å¤]';
                            }

                            return {
                                ...msg,
                                content: String(fixedContent), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                                autoFixed: true, // æ ‡è®°ä¸ºè‡ªåŠ¨ä¿®å¤
                                fixedAt: Date.now()
                            };
                        }
                        return msg;
                    });

                    if (hasCorruption) {
                        chatMessages[characterId] = fixedMessages;
                        console.log(`ğŸ”§ [è‡ªåŠ¨ä¿®å¤] è§’è‰² ${characterId} çš„ ${fixedMessages.filter(m => m.autoFixed).length} æ¡æ¶ˆæ¯å·²ä¿®å¤`);
                    }
                }
            }

            if (totalFixed > 0) {
                console.log(`ğŸ”§ [è‡ªåŠ¨ä¿®å¤] æ€»å…±ä¿®å¤äº† ${totalFixed} æ¡æŸåæ¶ˆæ¯`);
                await saveChatMessages();
                return totalFixed;
            }

            return 0;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®å®Œæ•´æ€§è¯Šæ–­å·¥å…·
        async function diagnoseDataIntegrity() {
            console.log('ğŸ” ===== å¼€å§‹æ•°æ®å®Œæ•´æ€§è¯Šæ–­ =====');

            const report = {
                memoryIssues: [],
                characterIssues: [],
                messageIssues: [],
                crossReferences: []
            };

            try {
                // 1. æ£€æŸ¥èŠå¤©æ¶ˆæ¯çš„è§’è‰²å½’å±
                console.log('ğŸ” æ£€æŸ¥èŠå¤©æ¶ˆæ¯å½’å±...');
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    if (!messages || !Array.isArray(messages)) continue;

                    // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯åŒ…å«å…¶ä»–è§’è‰²çš„ä¿¡æ¯
                    messages.forEach((msg, index) => {
                        if (msg.content && typeof msg.content === 'string') {
                            // æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦æåˆ°å…¶ä»–è§’è‰²
                            characters.forEach(char => {
                                if (char.id !== characterId && msg.content.includes(char.name)) {
                                    report.crossReferences.push({
                                        type: 'message_mentions_other_character',
                                        characterId: characterId,
                                        messageIndex: index,
                                        mentionedCharacter: char.name,
                                        content: msg.content.substring(0, 100) + '...'
                                    });
                                }
                            });
                        }

                        // æ£€æŸ¥æ¶ˆæ¯çš„å‘é€è€…ä¿¡æ¯
                        if (msg.name && msg.name !== characterId) {
                            const character = characters.find(c => c.id === characterId);
                            if (character && msg.name !== character.name) {
                                report.messageIssues.push({
                                    type: 'name_mismatch',
                                    characterId: characterId,
                                    messageIndex: index,
                                    expectedName: character.name,
                                    actualName: msg.name
                                });
                            }
                        }
                    });
                }

                // 2. æ£€æŸ¥æ ¸å¿ƒè®°å¿†çš„å½’å±
                console.log('ğŸ” æ£€æŸ¥æ ¸å¿ƒè®°å¿†å½’å±...');
                const allMemories = await db.coreMemories.toArray();
                const memoryByCharacter = {};

                allMemories.forEach(memory => {
                    if (!memoryByCharacter[memory.characterId]) {
                        memoryByCharacter[memory.characterId] = [];
                    }
                    memoryByCharacter[memory.characterId].push(memory);
                });

                // æ£€æŸ¥è®°å¿†å†…å®¹æ˜¯å¦æåˆ°å…¶ä»–è§’è‰²
                for (const [characterId, memories] of Object.entries(memoryByCharacter)) {
                    memories.forEach(memory => {
                        characters.forEach(char => {
                            if (char.id !== characterId &&
                                (memory.content.includes(char.name) || memory.summary?.includes(char.name))) {
                                report.memoryIssues.push({
                                    type: 'memory_mentions_other_character',
                                    characterId: characterId,
                                    memoryId: memory.id,
                                    mentionedCharacter: char.name,
                                    content: memory.content.substring(0, 100) + '...'
                                });
                            }
                        });
                    });
                }

                // 3. æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ¶ˆæ¯å½’å±
                console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“æ¶ˆæ¯å½’å±...');
                const dbMessages = await db.chatMessages.toArray();
                const dbMessagesByCharacter = {};

                dbMessages.forEach(dbMsg => {
                    if (!dbMessagesByCharacter[dbMsg.characterId]) {
                        dbMessagesByCharacter[dbMsg.characterId] = [];
                    }
                    dbMessagesByCharacter[dbMsg.characterId].push(dbMsg);
                });

                // æ£€æŸ¥æ•°æ®åº“ä¸å†…å­˜çš„ä¸€è‡´æ€§
                for (const [characterId, dbMsgs] of Object.entries(dbMessagesByCharacter)) {
                    const memoryMsgs = chatMessages[characterId] || [];
                    if (dbMsgs.length !== memoryMsgs.length) {
                        report.messageIssues.push({
                            type: 'db_memory_count_mismatch',
                            characterId: characterId,
                            dbCount: dbMsgs.length,
                            memoryCount: memoryMsgs.length
                        });
                    }
                }

                // 4. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
                console.log('ğŸ” ===== è¯Šæ–­æŠ¥å‘Š =====');
                console.log('è·¨è§’è‰²å¼•ç”¨:', report.crossReferences.length, 'ä¸ª');
                console.log('è®°å¿†é—®é¢˜:', report.memoryIssues.length, 'ä¸ª');
                console.log('æ¶ˆæ¯é—®é¢˜:', report.messageIssues.length, 'ä¸ª');
                console.log('è§’è‰²é—®é¢˜:', report.characterIssues.length, 'ä¸ª');

                if (report.crossReferences.length > 0) {
                    console.log('\nğŸš¨ å‘ç°è·¨è§’è‰²å¼•ç”¨é—®é¢˜:');
                    report.crossReferences.forEach((issue, index) => {
                        console.log(`${index + 1}. è§’è‰² ${issue.characterId} çš„æ¶ˆæ¯æåˆ°äº† ${issue.mentionedCharacter}`);
                        console.log(`   å†…å®¹: ${issue.content}`);
                    });
                }

                if (report.memoryIssues.length > 0) {
                    console.log('\nğŸš¨ å‘ç°è®°å¿†å½’å±é—®é¢˜:');
                    report.memoryIssues.forEach((issue, index) => {
                        console.log(`${index + 1}. è§’è‰² ${issue.characterId} çš„è®°å¿†æåˆ°äº† ${issue.mentionedCharacter}`);
                        console.log(`   å†…å®¹: ${issue.content}`);
                    });
                }

                if (report.messageIssues.length > 0) {
                    console.log('\nğŸš¨ å‘ç°æ¶ˆæ¯é—®é¢˜:');
                    report.messageIssues.forEach((issue, index) => {
                        console.log(`${index + 1}. ${issue.type}: è§’è‰² ${issue.characterId}`);
                        if (issue.expectedName) {
                            console.log(`   æœŸæœ›åå­—: ${issue.expectedName}, å®é™…åå­—: ${issue.actualName}`);
                        }
                        if (issue.dbCount !== undefined) {
                            console.log(`   æ•°æ®åº“æ¶ˆæ¯æ•°: ${issue.dbCount}, å†…å­˜æ¶ˆæ¯æ•°: ${issue.memoryCount}`);
                        }
                    });
                }

                return report;

            } catch (error) {
                console.error('æ•°æ®å®Œæ•´æ€§è¯Šæ–­å¤±è´¥:', error);
                return null;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è¿è¡Œæ•°æ®å®Œæ•´æ€§è¯Šæ–­çš„ç”¨æˆ·ç•Œé¢å‡½æ•°
        async function runDataIntegrityDiagnosis() {
            showToast('æ­£åœ¨è¿›è¡Œæ•°æ®å®Œæ•´æ€§è¯Šæ–­...', 'info');

            try {
                const report = await diagnoseDataIntegrity();

                if (!report) {
                    showToast('è¯Šæ–­å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
                    return;
                }

                // ç”Ÿæˆè¯Šæ–­ç»“æœæ‘˜è¦
                const totalIssues = report.crossReferences.length +
                                  report.memoryIssues.length +
                                  report.messageIssues.length +
                                  report.characterIssues.length;

                let summaryText = `ğŸ” æ•°æ®å®Œæ•´æ€§è¯Šæ–­å®Œæˆ\n\n`;
                summaryText += `æ€»è®¡å‘ç° ${totalIssues} ä¸ªæ½œåœ¨é—®é¢˜ï¼š\n`;
                summaryText += `â€¢ è·¨è§’è‰²å¼•ç”¨: ${report.crossReferences.length} ä¸ª\n`;
                summaryText += `â€¢ è®°å¿†å½’å±é—®é¢˜: ${report.memoryIssues.length} ä¸ª\n`;
                summaryText += `â€¢ æ¶ˆæ¯æ•°æ®é—®é¢˜: ${report.messageIssues.length} ä¸ª\n`;
                summaryText += `â€¢ è§’è‰²æ•°æ®é—®é¢˜: ${report.characterIssues.length} ä¸ª\n\n`;

                if (totalIssues === 0) {
                    summaryText += `âœ… æ­å–œï¼æ²¡æœ‰å‘ç°æ•°æ®å®Œæ•´æ€§é—®é¢˜ã€‚\nè§’è‰²è®°å¿†éš”ç¦»æ­£å¸¸ï¼Œæ•°æ®å­˜å‚¨å®Œæ•´ã€‚`;
                    showToast('æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼', 'success');
                } else {
                    summaryText += `âš ï¸ å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚\n\n`;

                    if (report.crossReferences.length > 0) {
                        summaryText += `ğŸš¨ è·¨è§’è‰²å¼•ç”¨é—®é¢˜å¯èƒ½å¯¼è‡´è§’è‰²è®°å¿†é”™ä¹±ã€‚\n`;
                    }

                    if (report.memoryIssues.length > 0) {
                        summaryText += `ğŸš¨ è®°å¿†å½’å±é—®é¢˜å¯èƒ½å¯¼è‡´è§’è‰²çŸ¥é“ä¸è¯¥çŸ¥é“çš„ä¿¡æ¯ã€‚\n`;
                    }

                    summaryText += `\nå»ºè®®ï¼š\n`;
                    summaryText += `1. æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯\n`;
                    summaryText += `2. è€ƒè™‘æ¸…ç†ç›¸å…³è§’è‰²çš„èŠå¤©è®°å½•\n`;
                    summaryText += `3. å¦‚é—®é¢˜ä¸¥é‡ï¼Œå¯å°è¯•æ•°æ®é‡å»ºåŠŸèƒ½`;

                    showToast('å‘ç°æ•°æ®å®Œæ•´æ€§é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…', 'warning');
                }

                // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
                alert(summaryText);

                // åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†æŠ¥å‘Š
                console.log('ğŸ” ===== è¯¦ç»†è¯Šæ–­æŠ¥å‘Š =====');
                console.log('å®Œæ•´æŠ¥å‘Šå¯¹è±¡:', report);

            } catch (error) {
                console.error('æ•°æ®å®Œæ•´æ€§è¯Šæ–­å‡ºé”™:', error);
                showToast('è¯Šæ–­è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿®å¤æ•°æ®åº“ä¸å†…å­˜ä¸ä¸€è‡´çš„é—®é¢˜
        async function fixDataSyncIssues() {
            console.log('ğŸ”§ å¼€å§‹ä¿®å¤æ•°æ®åŒæ­¥é—®é¢˜...');
            showToast('æ­£åœ¨ä¿®å¤æ•°æ®åŒæ­¥é—®é¢˜...', 'info');

            try {
                let totalFixed = 0;
                const fixedCharacters = [];

                // 1. é‡æ–°ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰æ¶ˆæ¯
                console.log('ğŸ”§ é‡æ–°ä»æ•°æ®åº“åŠ è½½æ¶ˆæ¯...');
                const dbMessages = await db.chatMessages.toArray();
                const newChatMessages = {};

                // æŒ‰è§’è‰²é‡æ–°ç»„ç»‡æ¶ˆæ¯
                for (const dbMsg of dbMessages) {
                    const characterId = dbMsg.characterId;
                    if (!newChatMessages[characterId]) {
                        newChatMessages[characterId] = [];
                    }

                    if (dbMsg.messageData && typeof dbMsg.messageData === 'object') {
                        newChatMessages[characterId].push(dbMsg.messageData);
                    }
                }

                // 2. å¯¹æ¯ä¸ªè§’è‰²çš„æ¶ˆæ¯è¿›è¡Œæ’åºå’Œå»é‡
                for (const [characterId, messages] of Object.entries(newChatMessages)) {
                    // æŒ‰æ—¶é—´æˆ³æ’åº
                    messages.sort((a, b) => a.timestamp - b.timestamp);

                    // å»é‡ï¼ˆåŸºäºIDå’Œæ—¶é—´æˆ³ï¼‰
                    const uniqueMessages = [];
                    const seenIds = new Set();
                    const seenContentTime = new Set();

                    for (const msg of messages) {
                        const contentTimeKey = `${msg.content}_${msg.timestamp}`;

                        if (msg.id && seenIds.has(msg.id)) {
                            console.log(`ğŸ”§ è·³è¿‡é‡å¤æ¶ˆæ¯ID: ${msg.id}`);
                            continue;
                        }

                        if (seenContentTime.has(contentTimeKey)) {
                            console.log(`ğŸ”§ è·³è¿‡é‡å¤å†…å®¹: ${contentTimeKey.substring(0, 50)}...`);
                            continue;
                        }

                        if (msg.id) seenIds.add(msg.id);
                        seenContentTime.add(contentTimeKey);
                        uniqueMessages.push(msg);
                    }

                    newChatMessages[characterId] = uniqueMessages;
                }

                // 3. æ¯”è¾ƒå¹¶ä¿®å¤ä¸ä¸€è‡´çš„æ•°æ®
                for (const [characterId, dbMessages] of Object.entries(newChatMessages)) {
                    const memoryMessages = chatMessages[characterId] || [];

                    if (dbMessages.length !== memoryMessages.length) {
                        console.log(`ğŸ”§ ä¿®å¤è§’è‰² ${characterId}: æ•°æ®åº“${dbMessages.length}æ¡ -> å†…å­˜${memoryMessages.length}æ¡`);

                        // ä½¿ç”¨æ•°æ®åº“ä¸­çš„æ•°æ®ä½œä¸ºæƒå¨æ•°æ®æº
                        chatMessages[characterId] = dbMessages;
                        fixedCharacters.push(characterId);
                        totalFixed += Math.abs(dbMessages.length - memoryMessages.length);
                    }
                }

                // 4. æ¸…ç†æ•°æ®åº“ä¸­çš„é‡å¤è®°å½•
                console.log('ğŸ”§ æ¸…ç†æ•°æ®åº“é‡å¤è®°å½•...');
                await db.transaction('rw', db.chatMessages, async () => {
                    // æ¸…ç©ºæ•°æ®åº“
                    await db.chatMessages.clear();

                    // é‡æ–°æ’å…¥å»é‡åçš„æ•°æ®
                    const newDbMessages = [];
                    for (const [characterId, messages] of Object.entries(chatMessages)) {
                        messages.forEach((message, index) => {
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ›´å®‰å…¨çš„IDç”Ÿæˆç­–ç•¥ï¼Œé¿å…æ½œåœ¨çš„é‡å¤é”®é—®é¢˜
                            const stableId = `${characterId}_cleanup_${message.timestamp || Date.now()}_${index}_${Math.random().toString(36).substr(2, 6)}`;
                            newDbMessages.push({
                                id: stableId,
                                characterId: characterId,
                                timestamp: message.timestamp,
                                messageOrder: index,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        });
                    }

                    if (newDbMessages.length > 0) {
                        await db.chatMessages.bulkAdd(newDbMessages);
                    }
                });

                // 5. é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©ç•Œé¢
                if (currentChatCharacter && fixedCharacters.includes(currentChatCharacter.id)) {
                    console.log('ğŸ”§ é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©ç•Œé¢...');
                    renderChatMessages(currentChatCharacter.id);
                }

                // 6. æ˜¾ç¤ºä¿®å¤ç»“æœ
                const resultMessage = totalFixed > 0
                    ? `âœ… æ•°æ®åŒæ­¥ä¿®å¤å®Œæˆï¼\n\nä¿®å¤äº† ${fixedCharacters.length} ä¸ªè§’è‰²çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œ\nå…±å¤„ç† ${totalFixed} æ¡æ¶ˆæ¯å·®å¼‚ã€‚\n\nè§’è‰²è®°å¿†ç°åœ¨åº”è¯¥æ›´åŠ å‡†ç¡®äº†ã€‚`
                    : `âœ… æ•°æ®åŒæ­¥æ£€æŸ¥å®Œæˆï¼\n\næ‰€æœ‰è§’è‰²çš„æ•°æ®åº“ä¸å†…å­˜æ•°æ®å·²ä¿æŒä¸€è‡´ï¼Œ\næ²¡æœ‰å‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜ã€‚`;

                console.log(`ğŸ”§ ä¿®å¤å®Œæˆ: ${fixedCharacters.length} ä¸ªè§’è‰², ${totalFixed} æ¡å·®å¼‚`);
                showToast('æ•°æ®åŒæ­¥ä¿®å¤å®Œæˆ', 'success');
                alert(resultMessage);

                return {
                    fixedCharacters: fixedCharacters.length,
                    totalFixed: totalFixed
                };

            } catch (error) {
                console.error('æ•°æ®åŒæ­¥ä¿®å¤å¤±è´¥:', error);
                showToast('æ•°æ®åŒæ­¥ä¿®å¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
                throw error;
            }
        }

        // ğŸ”¥ã€æ•°æ®æ¸…ç†å‡½æ•°ã€‘æ¸…ç†èŠå¤©è®°å½•ä¸­æŸåçš„æ¶ˆæ¯
        async function cleanupCorruptedMessages(characterId) {
            if (!chatMessages[characterId]) return;

            let hasCorruption = false;
            const cleanedMessages = chatMessages[characterId].map(msg => {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥å¹¶ä¿®å¤contentå­—æ®µ - ä¿æŠ¤å¤šæ¨¡æ€æ¶ˆæ¯æ•°ç»„
                if (typeof msg.content === 'object' && msg.content !== null && !Array.isArray(msg.content)) {
                    console.log('å‘ç°æŸåçš„æ¶ˆæ¯contentï¼Œæ­£åœ¨ä¿®å¤:', msg);
                    hasCorruption = true;

                    // æ ¹æ®æ¶ˆæ¯ç±»å‹ä¿®å¤content
                    if (msg.type === 'transfer') {
                        return {
                            ...msg,
                            content: `è½¬è´¦ Â¥${msg.amount || 0}${msg.note ? ` - ${msg.note}` : ''}`
                        };
                    } else if (msg.type === 'voice_message') {
                        return {
                            ...msg,
                            content: msg.content.content || '[è¯­éŸ³æ¶ˆæ¯]'
                        };
                    } else if (msg.type === 'ai_image') {
                        return {
                            ...msg,
                            content: `[AIå›¾ç‰‡]${msg.imageDescription ? ` - ${msg.imageDescription}` : ''}`
                        };
                    } else if (msg.isEmoji) {
                        return {
                            ...msg,
                            content: `[è¡¨æƒ…åŒ…]${msg.emojiDescription ? ` - ${msg.emojiDescription}` : ''}`
                        };
                    } else {
                        // é€šç”¨ä¿®å¤ï¼šæå–å¯èƒ½çš„æ–‡æœ¬å†…å®¹
                        const possibleContent = msg.content.content || msg.content.message || msg.content.text || '[ç‰¹æ®Šæ¶ˆæ¯]';
                        return {
                            ...msg,
                            content: possibleContent
                        };
                    }
                }

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥contentæ˜¯å¦ä¸ºå­—ç¬¦ä¸²æˆ–å¤šæ¨¡æ€æ•°ç»„ - ä¸è¦ç ´åå¤šæ¨¡æ€æ¶ˆæ¯ï¼
                if (msg.content && typeof msg.content !== 'string' && !Array.isArray(msg.content)) {
                    console.log('å‘ç°éå­—ç¬¦ä¸²/éæ•°ç»„contentï¼Œæ­£åœ¨ä¿®å¤:', msg);
                    hasCorruption = true;
                    return {
                        ...msg,
                        content: String(msg.content)
                    };
                }

                // ğŸ”¥ã€æ–°å¢ã€‘éªŒè¯å¤šæ¨¡æ€æ¶ˆæ¯æ•°ç»„çš„å®Œæ•´æ€§
                if (Array.isArray(msg.content)) {
                    console.log('ğŸ” [å¤šæ¨¡æ€éªŒè¯] æ£€æµ‹åˆ°å¤šæ¨¡æ€æ¶ˆæ¯:', msg.content);
                    // éªŒè¯æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦æœ‰æ•ˆ
                    const validContent = msg.content.filter(item => {
                        if (!item || typeof item !== 'object') return false;
                        if (item.type === 'text' && typeof item.text === 'string') return true;
                        if (item.type === 'image_url' && item.image_url && item.image_url.url) return true;
                        return false;
                    });

                    if (validContent.length !== msg.content.length) {
                        console.log('ğŸ” [å¤šæ¨¡æ€ä¿®å¤] è¿‡æ»¤æ— æ•ˆå…ƒç´ :', msg.content.length, '->', validContent.length);
                        hasCorruption = true;
                        return {
                            ...msg,
                            content: validContent
                        };
                    }
                }

                return msg;
            });

            // å¦‚æœå‘ç°æŸåçš„æ•°æ®ï¼Œä¿å­˜ä¿®å¤åçš„æ•°æ®
            if (hasCorruption) {
                console.log('æ£€æµ‹åˆ°æŸåçš„æ¶ˆæ¯æ•°æ®ï¼Œå·²è‡ªåŠ¨ä¿®å¤å¹¶ä¿å­˜');
                chatMessages[characterId] = cleanedMessages;
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ¶ˆæ¯ä¿®å¤ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('âœ… [é«˜æ•ˆæ¶ˆæ¯ä¿®å¤] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ¶ˆæ¯ä¿®å¤ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }

                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    renderChatMessages(characterId);
                }
            }
        }

        // ================== æ¶ˆæ¯è½¬å‘åŠŸèƒ½ ==================

        // 1. æ˜¾ç¤ºè½¬å‘ç›®æ ‡é€‰æ‹©æ¨¡æ€æ¡†
        function showForwardTargetModal() {
            if (selectedMessages.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦è½¬å‘çš„æ¶ˆæ¯', 'warning');
                return;
            }

            const listContainer = document.getElementById('forward-target-list');
            listContainer.innerHTML = '';

            // åˆå¹¶å•èŠå’Œç¾¤èŠåˆ—è¡¨
            const allChats = [];

            // æ·»åŠ å•èŠ
            characters.forEach(character => {
                if (contacts.includes(character.id)) {
                    allChats.push({
                        id: character.id,
                        name: character.name,
                        avatarUrl: character.avatarUrl,
                        isGroup: false
                    });
                }
            });

            // æ·»åŠ ç¾¤èŠ
            groupChats.forEach(group => {
                allChats.push({
                    id: group.id,
                    name: group.name,
                    avatarUrl: group.avatarUrl,
                    isGroup: true
                });
            });

            if (allChats.length === 0) {
                listContainer.innerHTML = '<p class="empty-mount-chats">æ²¡æœ‰å…¶ä»–èŠå¤©å¯ä»¥è½¬å‘</p>';
            } else {
                allChats.forEach(chat => {
                    const chatOption = document.createElement('div');
                    chatOption.className = 'chat-option-item';
                    chatOption.onclick = () => forwardMessagesTo(chat.id);

                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${chat.color || '#ddd'}; ${chat.avatarUrl ? `background-image: url(${chat.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${!chat.avatarUrl ? (chat.isGroup ? 'ç¾¤' : chat.name.charAt(0)) : ''}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${chat.name}</div>
                        </div>
                    `;
                    listContainer.appendChild(chatOption);
                });
            }

            showModal('forward-target-modal');
        }

        // 2. æ‰§è¡Œè½¬å‘æ“ä½œ
        async function forwardMessagesTo(targetChatId) {
            if (selectedMessages.size === 0) return;

            // è·å–èŠå¤©è®¾ç½®å’Œç”¨æˆ·å
            const chatSettings = getCurrentChatSettings();
            const myName = chatSettings.myChatNickname || (personas.find(p => p.id === chatSettings.selectedIdentityId)?.name || 'æˆ‘');

            // æ”¶é›†é€‰ä¸­çš„æ¶ˆæ¯ï¼Œå¹¶ä¿å­˜åŸå§‹çš„å‘é€è€…ä¿¡æ¯
            const messagesToForward = [];
            const currentMessages = chatMessages[currentChatCharacter.id] || [];

            currentMessages.forEach(msg => {
                if (selectedMessages.has(msg.id)) {
                    // åˆ›å»ºæ¶ˆæ¯å‰¯æœ¬å¹¶ä¿å­˜åŸå§‹å‘é€è€…ä¿¡æ¯
                    const msgCopy = { ...msg };
                    if (msg.sender === 'sent') {
                        msgCopy.userName = myName; // ä¿å­˜ç”¨æˆ·å
                    } else {
                        msgCopy.characterName = currentChatCharacter.name; // ä¿å­˜è§’è‰²å
                    }
                    messagesToForward.push(msgCopy);
                }
            });

            // æŒ‰æ—¶é—´æ’åº
            messagesToForward.sort((a, b) => a.timestamp - b.timestamp);

            // è·å–æºèŠå¤©ä¿¡æ¯
            const sourceChat = currentChatCharacter;

            let title = '';
            if (sourceChat.isGroup) {
                title = `${sourceChat.name}çš„ç¾¤èŠè®°å½•`;
            } else {
                title = `${myName}å’Œ${sourceChat.name}çš„èŠå¤©è®°å½•`;
            }

            // åˆ›å»ºè½¬å‘æ¶ˆæ¯å¡ç‰‡
            const forwardMessage = {
                id: Date.now().toString(),
                sender: 'sent', // è½¬å‘æ¶ˆæ¯æ€»æ˜¯ç”±ç”¨æˆ·å‘é€
                type: 'forwarded_message',
                content: title,
                forwardedMessages: messagesToForward, // å­˜å‚¨æ‰€æœ‰è¢«è½¬å‘çš„æ¶ˆæ¯
                timestamp: Date.now()
            };

            console.log('ğŸ” [è½¬å‘æ¶ˆæ¯åˆ›å»º] è½¬å‘æ¶ˆæ¯å¯¹è±¡:', forwardMessage);
            console.log('ğŸ” [è½¬å‘æ¶ˆæ¯åˆ›å»º] è½¬å‘çš„æ¶ˆæ¯æ•°é‡:', messagesToForward.length);
            console.log('ğŸ” [è½¬å‘æ¶ˆæ¯åˆ›å»º] è½¬å‘çš„æ¶ˆæ¯å†…å®¹:', messagesToForward);



            // å°†è½¬å‘æ¶ˆæ¯æ·»åŠ åˆ°ç›®æ ‡èŠå¤©
            if (!chatMessages[targetChatId]) {
                chatMessages[targetChatId] = [];
            }
            chatMessages[targetChatId].push(forwardMessage);
            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡è½¬å‘æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const stableId = `${targetChatId}_${forwardMessage.id}_${chatMessages[targetChatId].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: targetChatId,
                    timestamp: forwardMessage.timestamp,
                    messageOrder: chatMessages[targetChatId].length - 1,
                    originalMessageId: forwardMessage.id,
                    messageData: forwardMessage
                });
                console.log('âœ… [é«˜æ•ˆè½¬å‘] è½¬å‘æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('è½¬å‘æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                await saveChatMessages(targetChatId);
            }

            hideModal('forward-target-modal');
            exitMessageSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
            renderMessageList(); // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨

            // å¦‚æœå½“å‰æ­£æ‰“å¼€ç›®æ ‡èŠå¤©ï¼Œåˆ™åˆ·æ–°å¹¶è®¾ç½®ä¸ºå¾…å›å¤æ¶ˆæ¯
            if (currentChatCharacter && currentChatCharacter.id === targetChatId) {
                renderChatMessages(targetChatId);

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è®¾ç½®è½¬å‘æ¶ˆæ¯ä¸ºå¾…å›å¤æ¶ˆæ¯ï¼Œè®©AIèƒ½çœ‹åˆ°è½¬å‘å†…å®¹
                pendingUserMessage = forwardMessage;
                console.log('ğŸ” [è½¬å‘æ¶ˆæ¯] è®¾ç½®ä¸ºå¾…å›å¤æ¶ˆæ¯:', forwardMessage);

                // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
                const smartReplyBtn = document.getElementById('smart-reply-btn');
                if (smartReplyBtn) {
                    smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                    smartReplyBtn.classList.add('waiting');
                }
            }

            showToast('æ¶ˆæ¯å·²è½¬å‘', 'success');
        }

        // 3. åœ¨èŠå¤©çª—å£æ¸²æŸ“è½¬å‘æ¶ˆæ¯å¡ç‰‡
        function renderForwardedMessage(message) {
            console.log('ğŸ” [renderForwardedMessage] å¼€å§‹æ¸²æŸ“è½¬å‘æ¶ˆæ¯:', message);

            const previewMessages = message.forwardedMessages.slice(0, 4);
            let previewHtml = '';

            // è·å–è½¬å‘æ¶ˆæ¯çš„åŸå§‹èŠå¤©è®¾ç½®å’Œè§’è‰²ä¿¡æ¯
            const forwardedMessages = message.forwardedMessages;
            console.log('ğŸ” [renderForwardedMessage] è½¬å‘æ¶ˆæ¯æ•°æ®:', forwardedMessages);

            if (forwardedMessages && forwardedMessages.length > 0) {
                console.log('ğŸ” [renderForwardedMessage] è½¬å‘æ¶ˆæ¯æ•°é‡:', forwardedMessages.length);
                // ä»è½¬å‘çš„æ¶ˆæ¯ä¸­è·å–åŸå§‹çš„å‘é€è€…åå­—
                previewMessages.forEach((msg, index) => {
                    let senderName;
                    if (msg.sender === 'sent') {
                        // ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­ä¿å­˜çš„ç”¨æˆ·åæˆ–é»˜è®¤å
                        senderName = msg.userName || 'æˆ‘';
                    } else {
                        // AIå‘é€çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­ä¿å­˜çš„è§’è‰²å
                        senderName = msg.name || msg.characterName || 'è§’è‰²';
                    }
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                    const messageContent = safeExtractMessageContent(msg);
                    let contentPreview = truncateText(messageContent, 20);
                    console.log(`ğŸ” [renderForwardedMessage] é¢„è§ˆæ¶ˆæ¯${index + 1}: ${senderName}: ${contentPreview}`);
                    previewHtml += `<p>${senderName}: ${contentPreview}</p>`;
                });
            } else {
                console.log('âŒ [renderForwardedMessage] æ²¡æœ‰è½¬å‘æ¶ˆæ¯æ•°æ®');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨dataå±æ€§å­˜å‚¨è½¬å‘æ¶ˆæ¯æ•°æ®ï¼Œé¿å…JSON.stringifyåœ¨onclickä¸­çš„é—®é¢˜
            const messageId = message.id || Date.now().toString();
            console.log('ğŸ” [renderForwardedMessage] æ¸²æŸ“è½¬å‘å¡ç‰‡ï¼Œæ¶ˆæ¯ID:', messageId, 'è½¬å‘æ¶ˆæ¯æ•°é‡:', message.forwardedMessages.length);

            return `
                <div class="forwarded-message-card" data-message-id="${messageId}" data-forwarded-title="${message.content.replace(/"/g, '&quot;')}" onclick="showForwardedMessagesById('${messageId}')">
                    <div class="forwarded-card-title">${message.content}</div>
                    <div class="forwarded-card-preview">${previewHtml}</div>
                    <div class="forwarded-card-footer">æŸ¥çœ‹${message.forwardedMessages.length}æ¡è½¬å‘æ¶ˆæ¯</div>
                </div>
            `;
        }

        // 4. æ˜¾ç¤ºå®Œæ•´çš„è½¬å‘æ¶ˆæ¯è®°å½•
        function showForwardedMessages(messages, title) {
            const viewTitle = document.getElementById('forwarded-view-title');
            const viewContent = document.getElementById('forwarded-view-content');

            viewTitle.textContent = title;
            viewContent.innerHTML = '';

            messages.forEach(msg => {
                let senderName;
                if (msg.sender === 'sent') {
                    // ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­ä¿å­˜çš„ç”¨æˆ·åæˆ–é»˜è®¤å
                    senderName = msg.userName || 'æˆ‘';
                } else {
                    // AIå‘é€çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­ä¿å­˜çš„è§’è‰²å
                    senderName = msg.name || msg.characterName || 'è§’è‰²';
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                const messageContent = safeExtractMessageContent(msg);

                const itemDiv = document.createElement('div');
                itemDiv.className = 'forwarded-message-item';
                itemDiv.innerHTML = `
                    <div class="forwarded-message-sender">${senderName}</div>
                    <div class="forwarded-message-content">${messageContent}</div>
                `;
                viewContent.appendChild(itemDiv);
            });

            showModal('forwarded-view-modal');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šè¿‡æ¶ˆæ¯IDæ˜¾ç¤ºè½¬å‘æ¶ˆæ¯è®°å½• - ä¿®å¤ç¾¤èŠä¸­è½¬å‘å¡ç‰‡ç‚¹å‡»é—®é¢˜
        function showForwardedMessagesById(messageId) {
            console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] æŸ¥æ‰¾æ¶ˆæ¯ID:', messageId);
            console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] å½“å‰èŠå¤©è§’è‰²:', currentChatCharacter?.name, 'æ˜¯å¦ä¸ºç¾¤èŠ:', currentChatCharacter?.isGroup);

            // åœ¨å½“å‰èŠå¤©è®°å½•ä¸­æŸ¥æ‰¾è½¬å‘æ¶ˆæ¯
            const currentMessages = chatMessages[currentChatCharacter.id] || [];
            console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] å½“å‰èŠå¤©è®°å½•æ•°é‡:', currentMessages.length);

            const forwardedMessage = currentMessages.find(msg => msg.id === messageId && msg.type === 'forwarded_message');
            console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] æŸ¥æ‰¾ç»“æœ:', forwardedMessage);

            if (forwardedMessage && forwardedMessage.forwardedMessages) {
                console.log('âœ… [è½¬å‘å¡ç‰‡ç‚¹å‡»] æ‰¾åˆ°è½¬å‘æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè¯¦æƒ…');
                console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] è½¬å‘æ¶ˆæ¯æ•°é‡:', forwardedMessage.forwardedMessages.length);
                showForwardedMessages(forwardedMessage.forwardedMessages, forwardedMessage.content);
            } else {
                console.error('âŒ [è½¬å‘å¡ç‰‡ç‚¹å‡»] æœªæ‰¾åˆ°è½¬å‘æ¶ˆæ¯:', messageId);
                console.log('ğŸ” [è½¬å‘å¡ç‰‡ç‚¹å‡»] æ‰€æœ‰æ¶ˆæ¯IDåˆ—è¡¨:', currentMessages.map(msg => ({id: msg.id, type: msg.type})));
                showToast('æ— æ³•æ‰¾åˆ°è½¬å‘çš„æ¶ˆæ¯è®°å½•', 'error');
            }
        }

        // ================== è®°å¿†è®¾ç½®ç›¸å…³åŠŸèƒ½ ==================

        // è·å–æŒ‚è½½çš„èŠå¤©è®°å¿†
        async function getMountedMemories(currentCharacterId, chatSettings) {
            if (!chatSettings.memoryMountEnabled || !chatSettings.selectedMemoryChats || chatSettings.selectedMemoryChats.length === 0) {
                return '';
            }

            const mountCount = chatSettings.memoryMountCount || 3;
            let mountedMemoryContent = '';

            for (const chatId of chatSettings.selectedMemoryChats) {
                // è·³è¿‡å½“å‰èŠå¤©
                if (chatId === currentCharacterId) continue;

                // è·å–è¯¥èŠå¤©çš„å†å²è®°å½•
                const chatHistory = chatMessages[chatId] || [];
                if (chatHistory.length === 0) continue;

                // è·å–æœ€è¿‘çš„å‡ æ¡è®°å½•
                const recentMessages = chatHistory.slice(-mountCount);
                if (recentMessages.length === 0) continue;

                // è·å–èŠå¤©å¯¹è±¡çš„åç§°
                let chatName = 'æœªçŸ¥èŠå¤©';
                let chatType = 'å•èŠ';

                // æŸ¥æ‰¾å•èŠè§’è‰²
                const character = characters.find(c => c.id === chatId);
                if (character) {
                    chatName = character.name;
                    chatType = 'å•èŠ';
                } else {
                    // æŸ¥æ‰¾ç¾¤èŠ
                    const group = groupChats.find(g => g.id === chatId);
                    if (group) {
                        chatName = group.name;
                        chatType = 'ç¾¤èŠ';
                    }
                }

                // æ„å»ºè®°å¿†å†…å®¹
                mountedMemoryContent += `\n\nã€${chatType}è®°å¿† - ${chatName}ã€‘ä»¥ä¸‹æ˜¯ä¸${chatName}çš„æœ€è¿‘å¯¹è¯ï¼Œå¯ä»¥ä½œä¸ºèƒŒæ™¯å‚è€ƒï¼š\n`;

                recentMessages.forEach(msg => {
                    let sender = '';
                    let content = msg.content || '';

                    if (msg.sender === 'sent') {
                        sender = 'ç”¨æˆ·';
                    } else if (msg.sender === 'received' || msg.sender === 'ai') {
                        if (chatType === 'ç¾¤èŠ' && msg.name) {
                            sender = msg.name; // ç¾¤èŠä¸­çš„å‘è¨€è€…åç§°
                        } else {
                            sender = chatName; // å•èŠä¸­ä½¿ç”¨è§’è‰²åç§°
                        }
                    } else {
                        sender = 'ç³»ç»Ÿ';
                    }

                    // å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                    if (msg.type === 'voice_message') {
                        content = `[è¯­éŸ³æ¶ˆæ¯ï¼š${content}]`;
                    } else if (msg.type === 'transfer') {
                        content = `[è½¬è´¦ï¼š${msg.amount}å…ƒ${msg.note ? ` - ${msg.note}` : ''}]`;
                    } else if (msg.type === 'ai_image') {
                        content = `[AIå›¾ç‰‡ï¼š${msg.imageDescription || 'æ— æè¿°'}]`;
                    } else if (msg.isEmoji) {
                        content = `[è¡¨æƒ…åŒ…ï¼š${msg.emojiDescription || 'è¡¨æƒ…åŒ…'}]`;
                    } else if (msg.type === 'location') {
                        content = `[ä½ç½®åˆ†äº«ï¼š${msg.locationName || 'ä½ç½®ä¿¡æ¯'}]`;
                    } else if (Array.isArray(content)) {
                        // å¤„ç†æ•°ç»„ç±»å‹çš„å†…å®¹ï¼ˆå›¾ç‰‡+æ–‡å­—ï¼‰
                        const textPart = content.find(p => p.type === 'text')?.text || '';
                        content = textPart ? `[å›¾ç‰‡+æ–‡å­—ï¼š${textPart}]` : '[å›¾ç‰‡]';
                    }

                    // ç¡®ä¿contentæ˜¯å­—ç¬¦ä¸²ä¸”ä¸ä¸ºç©º
                    if (typeof content !== 'string' || !content.trim()) {
                        content = '[ç‰¹æ®Šæ¶ˆæ¯]';
                    }

                    mountedMemoryContent += `${sender}ï¼š${content}\n`;
                });
            }

            if (mountedMemoryContent.trim()) {
                console.log('ğŸ§  æˆåŠŸåŠ è½½æŒ‚è½½è®°å¿†ï¼Œæ¶‰åŠèŠå¤©æ•°:', chatSettings.selectedMemoryChats.length);
                return mountedMemoryContent;
            }

            return '';
        }

        function convertGroupChatToStandardFormat(groupChat) {
            if (!groupChat.members) return groupChat;

            // è½¬æ¢æˆå‘˜æ•°æ®ç»“æ„
            const convertedMembers = groupChat.members.map(member => ({
                id: member.id,
                name: member.name,
                persona: member.persona || member.bio, // ğŸ”¥ã€å…³é”®ã€‘ç¡®ä¿ä½¿ç”¨personaå­—æ®µ
                avatarUrl: member.avatarUrl,
                color: member.color
            }));

            // ç¡®ä¿æœ‰settingsç»“æ„
            if (!groupChat.settings) {
                groupChat.settings = {
                    myPersona: 'ç”¨æˆ·',
                    myNickname: 'æˆ‘'
                };
            }

            return {
                ...groupChat,
                members: convertedMembers
            };
        }

        function buildGroupChatMessageHistory(messages, groupChat) {
            if (!messages || !Array.isArray(messages)) return [];

            return messages.map(msg => {
                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†ç¾¤èŠä¸­çš„ç³»ç»Ÿæ¶ˆæ¯
                if (msg.sender === 'system') {
                    return { role: 'user', content: `[ç³»ç»Ÿæç¤º] ${msg.content}` };
                } else if (msg.sender === 'sent') {
                    // ç”¨æˆ·æ¶ˆæ¯ï¼šä½¿ç”¨ç¾¤èŠè®¾ç½®ä¸­çš„æ˜µç§°
                    const chatSettings = getCurrentChatSettings();
                    const myNickname = chatSettings.myChatNickname || groupChat.settings?.myNickname || 'æˆ‘';

                    let content;
                    if (msg.type === 'user_photo') {
                        content = `[${myNickname} å‘é€äº†ä¸€å¼ æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                    } else if (msg.type === 'voice_message') {
                        content = `[${myNickname} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                    } else if (msg.type === 'transfer') {
                        content = `[${msg.senderName}å‘${msg.receiverName}è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
                    } else if (msg.type === 'forwarded_message') {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†ç¾¤èŠä¸­çš„è½¬å‘æ¶ˆæ¯
                        let forwardedContent = `[${myNickname} è½¬å‘äº†èŠå¤©è®°å½•ï¼š${msg.content}]`;

                        // å¦‚æœæœ‰è½¬å‘çš„æ¶ˆæ¯å†…å®¹ï¼Œå±•ç¤ºå…·ä½“å†…å®¹
                        if (msg.forwardedMessages && msg.forwardedMessages.length > 0) {
                            forwardedContent += '\nè½¬å‘çš„èŠå¤©å†…å®¹ï¼š\n';
                            msg.forwardedMessages.forEach((fMsg, index) => {
                                let senderName;
                                if (fMsg.sender === 'sent') {
                                    senderName = fMsg.userName || 'ç”¨æˆ·';
                                } else {
                                    senderName = fMsg.name || fMsg.characterName || 'AI';
                                }
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                                const fMsgContent = safeExtractMessageContent(fMsg);
                                forwardedContent += `${senderName}: ${fMsgContent}\n`;
                            });
                        }
                        content = forwardedContent;
                    } else if (msg.meaning) {
                        content = `${myNickname}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
                    } else {
                        content = `${myNickname}: ${msg.content}`;
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç”¨æˆ·æ¶ˆæ¯çš„å¼•ç”¨ä¿¡æ¯
                    if (msg.replyTo) {
                        const replyPrefix = `[${myNickname} å›å¤ ${msg.replyTo.senderName}: "${msg.replyTo.content}"] `;
                        content = replyPrefix + content.replace(`${myNickname}: `, '');
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºç¾¤èŠæ¶ˆæ¯æ·»åŠ IDä¿¡æ¯ï¼Œæ–¹ä¾¿AIå¼•ç”¨
                    if (msg.id) {
                        content = `[ID:${msg.id}] ${content}`;
                    }

                    return { role: 'user', content: content };
                } else {
                    // AIæ¶ˆæ¯ï¼šæ ¹æ®senderIdæˆ–nameæŸ¥æ‰¾å‘é€è€…
                    const sender = msg.senderName || msg.name || 'æœªçŸ¥';

                    let content;
                    if (msg.type === 'ai_image') {
                        content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
                    } else if (msg.type === 'voice_message') {
                        content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                    } else if (msg.type === 'transfer') {
                        content = `[${msg.senderName}å‘${msg.receiverName}è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
                    } else if (msg.type === 'forwarded_message') {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†ç¾¤èŠä¸­AIå‘é€çš„è½¬å‘æ¶ˆæ¯
                        let forwardedContent = `[${sender} è½¬å‘äº†èŠå¤©è®°å½•ï¼š${msg.content}]`;

                        // å¦‚æœæœ‰è½¬å‘çš„æ¶ˆæ¯å†…å®¹ï¼Œå±•ç¤ºå…·ä½“å†…å®¹
                        if (msg.forwardedMessages && msg.forwardedMessages.length > 0) {
                            forwardedContent += '\nè½¬å‘çš„èŠå¤©å†…å®¹ï¼š\n';
                            msg.forwardedMessages.forEach((fMsg, index) => {
                                let senderName;
                                if (fMsg.sender === 'sent') {
                                    senderName = fMsg.userName || 'ç”¨æˆ·';
                                } else {
                                    senderName = fMsg.name || fMsg.characterName || 'AI';
                                }
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                                const fMsgContent = safeExtractMessageContent(fMsg);
                                forwardedContent += `${senderName}: ${fMsgContent}\n`;
                            });
                        }
                        content = forwardedContent;
                    } else if (msg.meaning) {
                        content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
                    } else if (Array.isArray(msg.content)) {
                        content = [...msg.content, { type: 'text', text: `${sender}:` }];
                    } else {
                        content = `${sender}: ${msg.content}`;
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†AIæ¶ˆæ¯çš„å¼•ç”¨ä¿¡æ¯
                    if (msg.replyTo) {
                        const replyPrefix = `[${sender} å›å¤ ${msg.replyTo.senderName}: "${msg.replyTo.content}"] `;
                        content = replyPrefix + content.replace(`${sender}: `, '');
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºç¾¤èŠæ¶ˆæ¯æ·»åŠ IDä¿¡æ¯ï¼Œæ–¹ä¾¿AIå¼•ç”¨
                    if (msg.id) {
                        content = `[ID:${msg.id}] ${content}`;
                    }

                    return { role: 'user', content: content };
                }
            });
        }



        // ğŸ”¥ã€æ–°å¢ã€‘ç›‘æ§localStorageä½¿ç”¨æƒ…å†µ
        function checkLocalStorageUsage() {
            try {
                let totalSize = 0;
                const items = [];

                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const size = localStorage[key].length;
                        totalSize += size;
                        items.push({ key, size });
                    }
                }

                const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
                console.log(`ğŸ“Š localStorageæ€»ä½¿ç”¨é‡: ${totalSizeMB}MB`);

                // æ˜¾ç¤ºæœ€å¤§çš„å‡ ä¸ªé¡¹ç›®
                items.sort((a, b) => b.size - a.size);
                items.slice(0, 5).forEach(item => {
                    const sizeMB = (item.size / 1024 / 1024).toFixed(2);
                    console.log(`  - ${item.key}: ${sizeMB}MB`);
                });

                // å¦‚æœæ¥è¿‘5MBé™åˆ¶ï¼Œå‘å‡ºè­¦å‘Š
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn('âš ï¸ localStorageä½¿ç”¨é‡æ¥è¿‘é™åˆ¶ï¼Œå»ºè®®æ¸…ç†å¤‡ä»½æ•°æ®');
                }

                return { totalSize, items };
            } catch (error) {
                console.error('æ£€æŸ¥localStorageä½¿ç”¨é‡å¤±è´¥:', error);
                return { totalSize: 0, items: [] };
            }
        }

        async function parseGroupChatAiResponse(aiResponseContent, groupChat) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†markdownä»£ç å—æ ¼å¼
                let cleanContent = aiResponseContent.trim();
                if (cleanContent.startsWith('```json')) {
                    cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                } else if (cleanContent.startsWith('```')) {
                    cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
                }

                const messagesArray = JSON.parse(cleanContent);
                if (!Array.isArray(messagesArray)) {
                    console.error('ç¾¤èŠAIå“åº”ä¸æ˜¯æ•°ç»„æ ¼å¼');
                    return [];
                }

                const processedMessages = [];

                for (const msgData of messagesArray) {
                    if (typeof msgData === 'object' && msgData.name && msgData.message) {
                        const member = groupChat.members.find(m => m.name === msgData.name);
                        if (member) {
                            processedMessages.push({
                                id: Date.now() + Math.random(),
                                sender: 'received',
                                content: msgData.message,
                                timestamp: Date.now(),
                                senderId: member.id,
                                senderName: member.name,
                                name: member.name
                            });
                        }
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'ai_image') {
                        // ç¾¤èŠå›¾ç‰‡æ¶ˆæ¯
                        const member = groupChat.members.find(m => m.name === msgData.name);
                        if (member) {
                            processedMessages.push({
                                id: Date.now() + Math.random(),
                                sender: 'received',
                                type: 'ai_image',
                                content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                                imageDescription: msgData.description,
                                timestamp: Date.now(),
                                senderId: member.id,
                                senderName: member.name,
                                name: member.name
                            });
                        }
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'voice_message') {
                        // ç¾¤èŠè¯­éŸ³æ¶ˆæ¯
                        const member = groupChat.members.find(m => m.name === msgData.name);
                        if (member) {
                            processedMessages.push({
                                id: Date.now() + Math.random(),
                                sender: 'received',
                                type: 'voice_message',
                                content: msgData.content,
                                timestamp: Date.now(),
                                senderId: member.id,
                                senderName: member.name,
                                name: member.name
                            });
                        }
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'emoji') {
                        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠè¡¨æƒ…åŒ…æ¶ˆæ¯
                        console.log('ğŸ” [parseGroupChatAiResponse] æ£€æµ‹åˆ°ç¾¤èŠè¡¨æƒ…åŒ…:', msgData);

                        const member = groupChat.members.find(m => m.name === msgData.name);
                        if (member) {
                            const matchingEmoji = await findEmojiForAI(msgData.description);
                            if (matchingEmoji) {
                                console.log('ğŸ” [parseGroupChatAiResponse] æ‰¾åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', matchingEmoji);

                                processedMessages.push({
                                    id: Date.now() + Math.random(),
                                    sender: 'received',
                                    content: '', // è¡¨æƒ…åŒ…æ¶ˆæ¯ä¸æ˜¾ç¤ºæ–‡å­—å†…å®¹
                                    image: matchingEmoji.url,
                                    isEmoji: true,
                                    emojiDescription: matchingEmoji.description,
                                    timestamp: Date.now(),
                                    senderId: member.id,
                                    senderName: member.name,
                                    name: member.name
                                });

                                // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                            } else {
                                console.warn('ğŸ” [parseGroupChatAiResponse] æ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', msgData.description);

                                // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œå‘é€é”™è¯¯æ¶ˆæ¯
                                processedMessages.push({
                                    id: Date.now() + Math.random(),
                                    sender: 'received',
                                    content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                    timestamp: Date.now(),
                                    senderId: member.id,
                                    senderName: member.name,
                                    name: member.name
                                });
                            }
                        } else {
                            console.warn('ğŸ” [parseGroupChatAiResponse] æ‰¾ä¸åˆ°å‘é€è¡¨æƒ…åŒ…çš„æˆå‘˜:', msgData.name);
                        }
                    } else if (typeof msgData === 'string') {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†æ™®é€šå­—ç¬¦ä¸²æ¶ˆæ¯ - åˆ†é…ç»™ç¬¬ä¸€ä¸ªç¾¤æˆå‘˜
                        console.log('ğŸ” [parseGroupChatAiResponse] æ£€æµ‹åˆ°å­—ç¬¦ä¸²æ¶ˆæ¯:', msgData);
                        if (groupChat.members && groupChat.members.length > 0) {
                            const defaultMember = groupChat.members[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªæˆå‘˜ä½œä¸ºé»˜è®¤å‘é€è€…
                            processedMessages.push({
                                id: Date.now() + Math.random(),
                                sender: 'received',
                                content: msgData,
                                timestamp: Date.now(),
                                senderId: defaultMember.id,
                                senderName: defaultMember.name,
                                name: defaultMember.name
                            });
                            console.log('ğŸ” [parseGroupChatAiResponse] å­—ç¬¦ä¸²æ¶ˆæ¯åˆ†é…ç»™:', defaultMember.name);
                        }
                    } else {
                        console.warn('ğŸ” [parseGroupChatAiResponse] æœªè¯†åˆ«çš„æ¶ˆæ¯æ ¼å¼:', msgData);
                    }
                }

                return processedMessages;
            } catch (error) {
                console.error('è§£æç¾¤èŠAIå“åº”å¤±è´¥:', error);
                return [];
            }
        }

        // åŠ è½½ç¾¤èŠæ•°æ® - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»å’Œæ ¼å¼è½¬æ¢ï¼‰
        async function loadGroupChats() {
            try {
                // å…ˆä»IndexedDBåŠ è½½
                const savedGroupChats = await db.groupChats.toArray();

                if (savedGroupChats.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('groupChats');
                    if (localStorageData) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„ç¾¤èŠæ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localGroupChats = JSON.parse(localStorageData);

                        if (localGroupChats.length > 0) {
                            const migrationData = localGroupChats.map(group => convertGroupChatToStandardFormat({
                                id: group.id || Date.now().toString() + Math.random(),
                                name: group.name,
                                description: group.description || '',
                                members: group.members || [],
                                settings: group.settings || {},
                                createdAt: group.createdAt || new Date().toISOString(),
                                updatedAt: group.updatedAt || new Date().toISOString()
                            }));

                            // è¿ç§»åˆ°IndexedDB
                            await db.groupChats.bulkAdd(migrationData);
                            groupChats = migrationData;
                            console.log('ç¾¤èŠæ•°æ®è¿ç§»å®Œæˆ:', groupChats);
                        } else {
                            groupChats = [];
                        }
                    } else {
                        groupChats = [];
                    }
                } else {
                    groupChats = savedGroupChats.map(convertGroupChatToStandardFormat);
                    console.log('ä»IndexedDBåŠ è½½ç¾¤èŠæ•°æ®:', groupChats);
                }
            } catch (error) {
                console.error('åŠ è½½ç¾¤èŠå¤±è´¥:', error);
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¦‚æœIndexedDBå¤±è´¥ï¼Œè°¨æ…å›é€€åˆ°localStorage
                const localStorageData = localStorage.getItem('groupChats');
                if (localStorageData) {
                    try {
                        const localData = JSON.parse(localStorageData);
                        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥localStorageæ•°æ®çš„å¤§å°å’Œæœ‰æ•ˆæ€§
                        if (Array.isArray(localData) && localData.length > 0) {
                            groupChats = localData.map(convertGroupChatToStandardFormat);
                            console.log('ä»localStorageå›é€€åŠ è½½ç¾¤èŠæ•°æ®ï¼ˆå·²è½¬æ¢æ ¼å¼ï¼‰:', groupChats);

                            // ğŸ”¥ã€ä¼˜åŒ–ã€‘å°è¯•é‡æ–°ä¿å­˜åˆ°IndexedDB
                            try {
                                await db.groupChats.bulkAdd(groupChats);
                                console.log('å·²å°†localStorageæ•°æ®é‡æ–°ä¿å­˜åˆ°IndexedDB');
                                // æˆåŠŸä¿å­˜åï¼Œå¯ä»¥è€ƒè™‘æ¸…ç†localStorageï¼ˆå¦‚æœæ•°æ®è¿‡å¤§ï¼‰
                                const dataSize = localStorageData.length;
                                if (dataSize > 1024 * 1024) { // è¶…è¿‡1MB
                                    localStorage.removeItem('groupChats');
                                    console.log('å·²æ¸…ç†è¿‡å¤§çš„localStorageå¤‡ä»½');
                                }
                            } catch (saveError) {
                                console.warn('é‡æ–°ä¿å­˜åˆ°IndexedDBå¤±è´¥:', saveError);
                            }
                        } else {
                            groupChats = [];
                        }
                    } catch (e) {
                        console.error('ç¾¤èŠæ•°æ®è§£æå¤±è´¥:', e);
                        groupChats = [];
                    }
                } else {
                    groupChats = [];
                }
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ¶ˆæ¯å’Œæˆå‘˜æ•°æ®åŠ è½½è¯´æ˜
        // ç¾¤èŠæ¶ˆæ¯å­˜å‚¨åœ¨chatMessagesè¡¨ä¸­ï¼Œé€šè¿‡loadChatMessages()å‡½æ•°åŠ è½½
        // ç¾¤èŠæˆå‘˜ä¿¡æ¯å­˜å‚¨åœ¨ç¾¤èŠå¯¹è±¡çš„memberså±æ€§ä¸­ï¼Œé€šè¿‡loadGroupChats()å‡½æ•°åŠ è½½
        console.log('â„¹ï¸ ç¾¤èŠæ•°æ®åŠ è½½ï¼šæ¶ˆæ¯é€šè¿‡chatMessagesè¡¨ï¼Œæˆå‘˜é€šè¿‡groupChatså¯¹è±¡çš„memberså±æ€§');

        // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥å½“å‰ä½¿ç”¨çš„å¯¼å…¥å‡½æ•°
        function debugImportFunction() {
            try {
                console.log('=== å¯¼å…¥å‡½æ•°è°ƒè¯• ===');

                // æ£€æŸ¥å‡½æ•°æºç 
                const importFuncStr = window.importDataFromFile.toString();
                console.log('å½“å‰å¯¼å…¥å‡½æ•°æºç é•¿åº¦:', importFuncStr.length);

                // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šæ ‡è¯†
                const hasFixScript = importFuncStr.includes('ä¿®å¤è„šæœ¬');
                const hasComprehensive = importFuncStr.includes('safeDataSave');
                const hasReplyToFix = importFuncStr.includes('ä¿®å¤å¼•ç”¨æ¶ˆæ¯');

                console.log('åŒ…å«ä¿®å¤è„šæœ¬æ ‡è¯†:', hasFixScript);
                console.log('åŒ…å«å®Œæ•´åŠŸèƒ½æ ‡è¯†:', hasComprehensive);
                console.log('åŒ…å«å¼•ç”¨æ¶ˆæ¯ä¿®å¤:', hasReplyToFix);

                // åˆ†ææ”¯æŒçš„æ•°æ®ç±»å‹
                const supportedTypes = [];
                if (importFuncStr.includes('data.workingMemory')) supportedTypes.push('å·¥ä½œè®°å¿†');
                if (importFuncStr.includes('data.smsMessages')) supportedTypes.push('çŸ­ä¿¡æ¶ˆæ¯');
                if (importFuncStr.includes('data.wallpapers')) supportedTypes.push('å£çº¸');
                if (importFuncStr.includes('data.anniversaries')) supportedTypes.push('çºªå¿µæ—¥');
                if (importFuncStr.includes('data.blacklist')) supportedTypes.push('æ‹‰é»‘åˆ—è¡¨');

                console.log('æ”¯æŒçš„æ‰©å±•æ•°æ®ç±»å‹:', supportedTypes);

                const result = `
å¯¼å…¥å‡½æ•°è°ƒè¯•ç»“æœï¼š
- å½“å‰ä½¿ç”¨: ${hasFixScript ? 'ç¬¬äºŒå¤„ä¿®å¤å‡½æ•°' : 'ç¬¬ä¸€å¤„å®Œæ•´å‡½æ•°'}
- åŠŸèƒ½å®Œæ•´æ€§: ${hasComprehensive ? 'å®Œæ•´' : 'ç®€åŒ–'}
- å¼•ç”¨æ¶ˆæ¯ä¿®å¤: ${hasReplyToFix ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}
- æ‰©å±•æ•°æ®ç±»å‹æ”¯æŒ: ${supportedTypes.length}ç§

${supportedTypes.length < 3 ? 'âš ï¸ è­¦å‘Šï¼šå½“å‰å‡½æ•°å¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®ï¼' : 'âœ… åŠŸèƒ½å®Œæ•´'}
                `;

                alert(result);

            } catch (error) {
                console.error('è°ƒè¯•å¯¼å…¥å‡½æ•°å¤±è´¥:', error);
                alert('è°ƒè¯•å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥ç¾¤èŠæ•°æ®
        async function debugGroupChatData() {
            try {
                console.log('=== ç¾¤èŠæ•°æ®è°ƒè¯• ===');

                // æ£€æŸ¥å†…å­˜ä¸­çš„ç¾¤èŠæ•°æ®
                console.log('å†…å­˜ä¸­çš„ç¾¤èŠæ•°æ®:', groupChats);
                console.log('ç¾¤èŠæ•°é‡:', groupChats.length);

                // æ£€æŸ¥IndexedDBä¸­çš„ç¾¤èŠæ•°æ®
                const dbGroupChats = await db.groupChats.toArray();
                console.log('IndexedDBä¸­çš„ç¾¤èŠæ•°æ®:', dbGroupChats);
                console.log('IndexedDBç¾¤èŠæ•°é‡:', dbGroupChats.length);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥chatMessagesä¸­çš„ç¾¤èŠæ¶ˆæ¯ï¼ˆæ­£ç¡®çš„å­˜å‚¨ä½ç½®ï¼‰
                let groupChatMessageCount = 0;
                let groupMemberCount = 0;

                if (groupChats.length > 0) {
                    console.log('=== ç¾¤èŠè¯¦ç»†ä¿¡æ¯ ===');
                    groupChats.forEach((group, index) => {
                        console.log(`ç¾¤èŠ ${index + 1}: ${group.name} (ID: ${group.id})`);
                        console.log(`  æˆå‘˜:`, group.members);
                        if (group.members && Array.isArray(group.members)) {
                            groupMemberCount += group.members.length;
                        }

                        // æ£€æŸ¥è¯¥ç¾¤èŠçš„æ¶ˆæ¯
                        const groupMessages = chatMessages[group.id] || [];
                        console.log(`  æ¶ˆæ¯æ•°é‡: ${groupMessages.length}`);
                        groupChatMessageCount += groupMessages.length;

                        if (groupMessages.length > 0) {
                            console.log(`  æœ€è¿‘æ¶ˆæ¯:`, groupMessages.slice(-3));
                        }
                    });
                }

                // ğŸ”¥ã€åºŸå¼ƒã€‘è¿™äº›è¡¨ä¸å†ä½¿ç”¨
                console.log('âš ï¸ æ³¨æ„ï¼šgroupChatMessageså’ŒgroupChatMembersè¡¨å·²åºŸå¼ƒ');
                console.log('ç¾¤èŠæ¶ˆæ¯ç°åœ¨å­˜å‚¨åœ¨chatMessagesè¡¨ä¸­');
                console.log('ç¾¤èŠæˆå‘˜ç°åœ¨å­˜å‚¨åœ¨ç¾¤èŠå¯¹è±¡çš„memberså±æ€§ä¸­');

                console.log('=== è°ƒè¯•ç»“æŸ ===');

                // æ˜¾ç¤ºç»“æœç»™ç”¨æˆ·
                const summary = `
ç¾¤èŠè°ƒè¯•ç»“æœï¼š
- å†…å­˜ä¸­ç¾¤èŠæ•°é‡: ${groupChats.length}
- IndexedDBç¾¤èŠæ•°é‡: ${dbGroupChats.length}
- ç¾¤èŠæ¶ˆæ¯æ•°é‡: ${groupChatMessageCount}æ¡ (å­˜å‚¨åœ¨chatMessagesè¡¨ä¸­)
- ç¾¤èŠæˆå‘˜æ•°é‡: ${groupMemberCount}ä¸ª (å­˜å‚¨åœ¨ç¾¤èŠå¯¹è±¡ä¸­)

${groupChats.length > 0 ? 'âœ… å‘ç°ç¾¤èŠæ•°æ®' : 'âŒ æœªå‘ç°ç¾¤èŠæ•°æ®'}
                `;
                alert(summary);

            } catch (error) {
                console.error('è°ƒè¯•ç¾¤èŠæ•°æ®å¤±è´¥:', error);
                alert('è°ƒè¯•å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå†å²æ¶ˆæ¯è®¾ç½®
        function showHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const historyCount = chatSettings.historyCount;
            document.getElementById('history-messages-count').value = Math.min(historyCount, 100);
            document.getElementById('custom-history-count').value = historyCount;
            document.getElementById('history-count-display').textContent = historyCount + 'å›åˆ';

            // ç»‘å®šæ»‘å—äº‹ä»¶
            document.getElementById('history-messages-count').oninput = function() {
                const value = parseInt(this.value);
                document.getElementById('history-count-display').textContent = value + 'å›åˆ';
                document.getElementById('custom-history-count').value = value;
            };

            // ç»‘å®šè‡ªå®šä¹‰è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById('custom-history-count').oninput = function() {
                const value = Math.max(0, Math.min(500, parseInt(this.value) || 0));
                this.value = value;
                if (value <= 100) {
                    document.getElementById('history-messages-count').value = value;
                }
                document.getElementById('history-count-display').textContent = value + 'å›åˆ';
            };

            showModal('history-settings-modal');
        }

        // ä¿å­˜å†å²æ¶ˆæ¯è®¾ç½®
        function saveHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const customValue = parseInt(document.getElementById('custom-history-count').value);
            chatSettings.historyCount = Math.max(0, Math.min(500, customValue || 0));

            // æ›´æ–°è®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„å½“å‰å€¼
            document.getElementById('current-history-count').textContent = chatSettings.historyCount + 'å›åˆ';

            saveCurrentChatSettings(chatSettings);
            hideModal('history-settings-modal');
            showToast('å†å²æ¶ˆæ¯è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // æ˜¾ç¤ºå¤´åƒè®¾ç½®
        function showAvatarSettings() {
            // åŠ è½½å½“å‰èŠå¤©çª—å£çš„å¤´åƒè®¾ç½®
            const chatSettings = getCurrentChatSettings();

            // è®¾ç½®éšè—å¤´åƒé€‰é¡¹
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                hideAvatarsCheckbox.checked = chatSettings.hideAvatars || false;
            }

            // è®¾ç½®å¤´åƒå½¢çŠ¶é€‰é¡¹
            const avatarShape = chatSettings.avatarShape || 'circle';
            const avatarShapeRadios = document.querySelectorAll('input[name="avatar-shape"]');
            avatarShapeRadios.forEach(radio => {
                radio.checked = radio.value === avatarShape;
                // æ›´æ–°é€‰é¡¹å¡çš„é€‰ä¸­çŠ¶æ€
                const radioOption = radio.closest('.shape-radio-option');
                if (radio.checked) {
                    radioOption.classList.add('selected');
                } else {
                    radioOption.classList.remove('selected');
                }
            });

            // æ›´æ–°é¢„è§ˆå¤´åƒçš„å½¢çŠ¶
            updateAvatarPreviewShape(avatarShape);

            // è®¾ç½®æˆ‘çš„å¤´åƒé¢„è§ˆ
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            if (chatSettings.myChatAvatar) {
                myAvatarPreview.style.backgroundImage = `url(${chatSettings.myChatAvatar})`;
                myAvatarPreview.style.backgroundSize = 'cover';
                myAvatarPreview.style.backgroundPosition = 'center';
                myAvatarPreview.innerHTML = '';
            } else {
                myAvatarPreview.style.backgroundImage = 'none';
                myAvatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            }

            // è®¾ç½®å¯¹æ–¹å¤´åƒé¢„è§ˆ - æ˜¾ç¤ºå½“å‰å®é™…ä½¿ç”¨çš„å¤´åƒ
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            const currentAiAvatar = chatSettings.aiChatAvatar;
            if (currentAiAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${currentAiAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';

                // æ·»åŠ æç¤º
                aiAvatarPreview.title = 'å½“å‰æ˜¾ç¤ºèŠå¤©å¤´åƒï¼ˆå¯èƒ½è¢«è§’è‰²æ›´æ¢è¿‡ï¼‰';
            } else {
                aiAvatarPreview.style.backgroundImage = 'none';
                aiAvatarPreview.innerHTML = '<i class="fas fa-robot"></i>';
                aiAvatarPreview.title = 'ä½¿ç”¨é»˜è®¤å¤´åƒ';
            }

            // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            bindAvatarUploadEvents();

            // ç»‘å®šå¤´åƒå½¢çŠ¶åˆ‡æ¢äº‹ä»¶
            bindAvatarShapeEvents();

            showModal('avatar-settings-modal');
        }

        // æ›´æ–°å¤´åƒé¢„è§ˆå½¢çŠ¶
        function updateAvatarPreviewShape(shape) {
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');

            // ç§»é™¤æ‰€æœ‰å½¢çŠ¶ç±»
            myAvatarPreview.classList.remove('rounded-square');
            aiAvatarPreview.classList.remove('rounded-square');

            // æ·»åŠ å¯¹åº”å½¢çŠ¶ç±»
            if (shape === 'rounded-square') {
                myAvatarPreview.classList.add('rounded-square');
                aiAvatarPreview.classList.add('rounded-square');
            }
        }

        // ç»‘å®šå¤´åƒå½¢çŠ¶åˆ‡æ¢äº‹ä»¶
        function bindAvatarShapeEvents() {
            // ç›´æ¥æŸ¥æ‰¾æ‰€æœ‰çš„radioæŒ‰é’®
            const avatarShapeRadios = document.querySelectorAll('input[name="avatar-shape"]');

            avatarShapeRadios.forEach(radio => {
                const option = radio.closest('.shape-radio-option');

                if (!option) {
                    console.warn('æœªæ‰¾åˆ°radioé€‰é¡¹å®¹å™¨:', radio);
                    return;
                }

                // ç›‘å¬é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                option.addEventListener('click', function() {
                    // å–æ¶ˆæ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                    avatarShapeRadios.forEach(r => {
                        r.checked = false;
                        r.closest('.shape-radio-option').classList.remove('selected');
                    });

                    // é€‰ä¸­å½“å‰é€‰é¡¹
                    radio.checked = true;
                    this.classList.add('selected');

                    // æ›´æ–°é¢„è§ˆ
                    updateAvatarPreviewShape(radio.value);
                });

                // ç›‘å¬radioçš„changeäº‹ä»¶
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        // å–æ¶ˆå…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                        avatarShapeRadios.forEach(r => {
                            if (r !== this) {
                                r.closest('.shape-radio-option').classList.remove('selected');
                            }
                        });

                        // é€‰ä¸­å½“å‰é€‰é¡¹
                        option.classList.add('selected');

                        // æ›´æ–°é¢„è§ˆ
                        updateAvatarPreviewShape(this.value);
                    }
                });
            });
        }

        // ç”Ÿæˆå¸¦æœ‰æ­£ç¡®å½¢çŠ¶ç±»çš„å¤´åƒHTML
        function generateAvatarHtml(options) {
            const {
                avatarUrl,
                backgroundColor,
                displayName,
                onClick,
                title,
                timestamp,
                timestampEnabled,
                timestampPosition,
                chatSettings
            } = options;

            // è·å–å¤´åƒå½¢çŠ¶è®¾ç½®
            const avatarShape = chatSettings?.avatarShape || 'circle';
            const shapeClass = avatarShape === 'rounded-square' ? ' rounded-square' : '';

            const backgroundStyle = avatarUrl
                ? `background-image: url(${avatarUrl}); background-size: cover; background-position: center;`
                : `background-color: ${backgroundColor};`;

            const onClickAttr = onClick ? `onclick="${onClick}"` : '';
            const titleAttr = title ? `title="${title}"` : '';
            const timestampHtml = timestampEnabled && timestampPosition === 'avatar' && timestamp
                ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(timestamp)}</div>`
                : '';

            const content = avatarUrl ? '' : (displayName ? displayName.charAt(0) : '<i class="fas fa-user"></i>');

            return `<div class="message-avatar${shapeClass}" style="${backgroundStyle}" ${onClickAttr} ${titleAttr}>${content}${timestampHtml}</div>`;
        }

        // æ˜¾ç¤ºæ˜µç§°è®¾ç½®
        function showNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-chat-nickname').value = chatSettings.myChatNickname || '';
            document.getElementById('ai-chat-nickname').value = chatSettings.aiChatNickname || '';
            showModal('nickname-settings-modal');
        }

        // æ˜¾ç¤ºæˆ³ä¸€æˆ³åç¼€è®¾ç½®
        function showPokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-poke-suffix').value = chatSettings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chatSettings.aiPokeSuffix || '';
            showModal('poke-suffix-modal');
        }

        // æ˜¾ç¤ºèŠå¤©èƒŒæ™¯è®¾ç½®
        function showBackgroundSettings() {
            const backgroundPreview = document.getElementById('chat-background-preview');

            // é‡ç½®é€‰æ‹©çŠ¶æ€
            window.selectedChatBackground = undefined;

            // ä½¿ç”¨currentChatCharacter.backgroundè€Œä¸æ˜¯chatSettings.chatBackground
            if (currentChatCharacter && currentChatCharacter.background) {
                backgroundPreview.style.backgroundImage = `url(${currentChatCharacter.background})`;
                backgroundPreview.style.backgroundSize = 'cover';
                backgroundPreview.style.backgroundPosition = 'center';
                backgroundPreview.querySelector('.preview-text').style.display = 'none';
            } else {
                backgroundPreview.style.backgroundImage = 'none';
                backgroundPreview.querySelector('.preview-text').style.display = 'block';
                backgroundPreview.querySelector('.preview-text').textContent = 'èƒŒæ™¯é¢„è§ˆ';
            }

            // ç»‘å®šèƒŒæ™¯ä¸Šä¼ äº‹ä»¶
            document.getElementById('background-upload').onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        backgroundPreview.style.backgroundImage = `url(${event.target.result})`;
                        backgroundPreview.style.backgroundSize = 'cover';
                        backgroundPreview.style.backgroundPosition = 'center';
                        backgroundPreview.querySelector('.preview-text').style.display = 'none';
                        window.selectedChatBackground = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            showModal('background-settings-modal');
        }

        // æ˜¾ç¤ºæ°”æ³¡æ ·å¼è®¾ç½®
        function showBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤º/éšè—ç¾¤æˆå‘˜è®¾ç½®æŒ‰é’®
            const groupColorsBtn = document.getElementById('group-member-colors-btn');
            if (currentChatCharacter && currentChatCharacter.isGroup) {
                groupColorsBtn.style.display = 'block';
            } else {
                groupColorsBtn.style.display = 'none';
            }

            // åŠ è½½å½“å‰è®¾ç½®
            const currentStyle = chatSettings.bubbleStyle || 'default';
            document.getElementById('my-bubble-color').value = chatSettings.myBubbleColor || '#007AFF';
            document.getElementById('ai-bubble-color').value = chatSettings.aiBubbleColor || '#f0f0f0';

            // åŠ è½½åˆ†ç¦»çš„é€æ˜åº¦è®¾ç½®
            document.getElementById('my-bubble-opacity').value = chatSettings.myBubbleOpacity || '1';
            document.getElementById('my-bubble-opacity-value').textContent = Math.round((chatSettings.myBubbleOpacity || 1) * 100) + '%';
            document.getElementById('ai-bubble-opacity').value = chatSettings.aiBubbleOpacity || '1';
            document.getElementById('ai-bubble-opacity-value').textContent = Math.round((chatSettings.aiBubbleOpacity || 1) * 100) + '%';

            // è®¾ç½®å½“å‰é€‰ä¸­çš„æ ·å¼
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle) {
                    option.classList.add('selected');
                }
            });

            // ç»‘å®šæ ·å¼é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.bubble-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedBubbleStyle = this.dataset.style;
                    updatePreview(); // å®æ—¶é¢„è§ˆ
                };
            });

            // ç»‘å®šåˆ†ç¦»çš„é€æ˜åº¦äº‹ä»¶
            document.getElementById('my-bubble-opacity').oninput = function() {
                document.getElementById('my-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
                updatePreview();
            };

            document.getElementById('ai-bubble-opacity').oninput = function() {
                document.getElementById('ai-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
                updatePreview();
            };

            // ç»‘å®šé¢œè‰²å˜åŒ–äº‹ä»¶
            document.getElementById('my-bubble-color').oninput = updatePreview;
            document.getElementById('ai-bubble-color').oninput = updatePreview;

            // åŠ è½½æ°”æ³¡å¤§å°è®¾ç½®
            document.getElementById('bubble-padding').value = chatSettings.bubblePadding || '12';
            updatePaddingValue(chatSettings.bubblePadding || '12');

            // ç»‘å®šæ°”æ³¡å¤§å°äº‹ä»¶
            document.getElementById('bubble-padding').oninput = function() {
                updatePaddingValue(this.value);
                updatePreview();
            };

            // åŠ è½½è‡ªå®šä¹‰CSS
            const customCSSTextarea = document.getElementById('custom-bubble-css');
            if (customCSSTextarea) {
                customCSSTextarea.value = chatSettings.customBubbleCSS || '';
            }

            window.selectedBubbleStyle = currentStyle;
            showModal('bubble-style-modal');

            // åˆå§‹åŒ–é¢„è§ˆ
            setTimeout(updatePreview, 100);
        }

        // æ˜¾ç¤ºå®šæ—¶å‘å¸ƒè®¾ç½®
        function showScheduleSettings() {
            const chatSettings = getCurrentChatSettings();

            document.getElementById('schedule-enabled').checked = chatSettings.scheduleEnabled || false;
            document.getElementById('schedule-enabled').onchange = function() {
                document.getElementById('schedule-times-group').style.display = this.checked ? 'block' : 'none';
            };

            // è§¦å‘ä¸€æ¬¡æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
            document.getElementById('schedule-times-group').style.display =
                document.getElementById('schedule-enabled').checked ? 'block' : 'none';

            // åŠ è½½å·²æœ‰çš„æ—¶é—´ç‚¹
            renderScheduleTimes();

            showModal('schedule-settings-modal');
        }

        // å¼‚æ­¥å‡½æ•°ï¼Œç”¨äºè·å–èŠå¤©çª—å£çš„ä¸“å±è®¾ç½®
        async function getAsyncChatSettings(characterId = null) {
            // 1. ç¡®å®šä½¿ç”¨å“ªä¸ªè§’è‰²ID
            const chatId = characterId || (currentChatCharacter ? currentChatCharacter.id : null);

            if (!chatId) {
                console.warn("æ— æ³•è·å–è®¾ç½®ï¼šcharacterId å’Œ currentChatCharacter éƒ½æœªå®šä¹‰ï¼Œè¿”å›ç©ºè®¾ç½®");
                return {
                    historyCount: 30,
                    timestampEnabled: true,
                    timestampPosition: 'center',
                    bubbleStyle: 'default',
                    characterStatusEnabled: false
                };
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿è·å–çš„æ˜¯æŒ‡å®šè§’è‰²çš„è®¾ç½®ï¼Œé¿å…è§’è‰²é—´è®¾ç½®æ··æ·†
            // å¦‚æœæ˜ç¡®ä¼ å…¥äº†characterIdï¼Œåˆ™å¼ºåˆ¶ä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®æ€§
            const forceReload = characterId !== null && characterId !== undefined;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨çª—å£éš”ç¦»çš„è®¾ç½®é”®
            const windowChatSettingsKey = `${chatId}_${windowId || 'default'}`;

            // 2. ã€æ€§èƒ½ä¼˜åŒ–ã€‘é¦–å…ˆæ£€æŸ¥å†…å­˜ä¸­æ˜¯å¦å·²æœ‰è¯¥èŠå¤©çš„è®¾ç½®ï¼ˆé™¤éå¼ºåˆ¶é‡æ–°åŠ è½½ï¼‰
            if (!forceReload && chatSettings[windowChatSettingsKey]) {
                console.log(`âœ… ä»å†…å­˜ç¼“å­˜è·å–è§’è‰² ${chatId} (çª—å£${windowId})çš„è®¾ç½®`);
                return chatSettings[windowChatSettingsKey];
            }

            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘å¦‚æœæ²¡æœ‰çª—å£éš”ç¦»è®¾ç½®ï¼Œæ£€æŸ¥æ—§çš„å…¨å±€è®¾ç½®
            if (!forceReload && !chatSettings[windowChatSettingsKey] && chatSettings[chatId]) {
                console.log(`âœ… ä»å†…å­˜ç¼“å­˜è·å–è§’è‰² ${chatId} çš„å…¨å±€è®¾ç½®ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰`);
                // å¤åˆ¶åˆ°çª—å£éš”ç¦»è®¾ç½®ä¸­
                chatSettings[windowChatSettingsKey] = { ...chatSettings[chatId] };
                return chatSettings[windowChatSettingsKey];
            }

            // 3. ã€æ ¸å¿ƒé€»è¾‘ã€‘ä» IndexedDB æ•°æ®åº“å¼‚æ­¥æŸ¥è¯¢ï¼ˆå¼ºåˆ¶é‡æ–°åŠ è½½æˆ–å†…å­˜ä¸­æ²¡æœ‰ï¼‰
                try {
                    // ä¼˜å…ˆå°è¯•çª—å£éš”ç¦»çš„è®¾ç½®
                    let dbSettings = null;
                    if (windowId) {
                        dbSettings = await db.windowChatSettings.where('[chatId+windowId]').equals([chatId, windowId]).first();
                    }

                    // å¦‚æœæ²¡æœ‰çª—å£éš”ç¦»è®¾ç½®ï¼Œå°è¯•å…¨å±€è®¾ç½®ï¼ˆå…¼å®¹æ€§ï¼‰
                    if (!dbSettings) {
                        dbSettings = await db.chatSettings.get(chatId);
                    }

                    if (dbSettings && dbSettings.settings) {
                    // æŸ¥åˆ°äº†ï¼å­˜å…¥å†…å­˜å¹¶è¿”å›
                    const loadType = forceReload ? 'å¼ºåˆ¶é‡æ–°åŠ è½½' : 'é¦–æ¬¡åŠ è½½';
                    console.log(`âœ… ä»æ•°æ®åº“${loadType}è§’è‰² ${chatId} (çª—å£${windowId})çš„è®¾ç½®`);
                        chatSettings[windowChatSettingsKey] = dbSettings.settings;

                        // ğŸ”¥ã€å…¼å®¹æ€§ã€‘åŒæ—¶æ›´æ–°å…¨å±€è®¾ç½®
                        if (!chatSettings[chatId]) {
                            chatSettings[chatId] = { ...dbSettings.settings };
                        }

                    return dbSettings.settings;
                    }
                } catch (error) {
                console.error(`ä»æ•°æ®åº“åŠ è½½è§’è‰² ${chatId} (çª—å£${windowId})çš„è®¾ç½®å¤±è´¥:`, error);
                // å³ä½¿æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­æ‰§è¡Œï¼Œå°è¯•åˆ›å»ºé»˜è®¤è®¾ç½®
            }

            // 4. ã€å¤„ç†æ–°èŠå¤©ã€‘å¦‚æœæ•°æ®åº“é‡Œä¹Ÿæ²¡æœ‰ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„èŠå¤©çª—å£
            console.log(`ğŸ”§ IDä¸º ${chatId} çš„èŠå¤©æ— å†å²è®¾ç½®ï¼Œæ­£åœ¨åˆ›å»ºé»˜è®¤è®¾ç½®...`);

            // å®šä¹‰ä¸€ä»½å¹²å‡€çš„é»˜è®¤è®¾ç½®
            const defaultSettings = {
                        // è®°å¿†ç›¸å…³è®¾ç½®ï¼ˆåŸæœ¬çš„å…¨å±€è®¾ç½®æ”¹ä¸ºæ¯ä¸ªèŠå¤©ç‹¬ç«‹ï¼‰
                historyCount: 30,
                        crossChatMemory: 3,
                        enableDynamicMemory: true,
                        enableMusicMemory: true,
                        memoryMountEnabled: false,
                        memoryMountCount: 3,
                        selectedMemoryChats: [],
                        // æ—¶é—´æ„ŸçŸ¥è®¾ç½®
                        timeAwarenessEnabled: true,
                        // é€šè¯è®¾ç½®
                        aiCallEnabled: true,
                        // å¿ƒç‡ç›‘æµ‹è®¾ç½®
                        aiHeartrateEnabled: false,
                        // ç¤¾äº¤åŠ¨æ€è®¾ç½®
                        socialEnabled: false,
                        socialFrequency: 'medium',
                        // åå°äº’åŠ¨è®¾ç½®
                        backgroundInteractionEnabled: true,
                        backgroundChatEnabled: true,
                        backgroundMomentsEnabled: true,
                        backgroundChatFrequency: 'low',
                        backgroundMomentsFrequency: 'low',
                        scheduledMomentsEnabled: false,
                        scheduledMomentsTimes: [],
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¸–ç•Œä¹¦ç›¸å…³è®¾ç½®
                        worldbookMountEnabled: false,
                        selectedWorldbooks: [],
                        linkedWorldBookIds: [], // å…¼å®¹æ—§ç‰ˆæœ¬å­—æ®µå
                        // å…¶ä»–åŸæœ‰è®¾ç½®
                        timestampEnabled: true, // ğŸ”¥ã€ä¿®å¤ã€‘é»˜è®¤å¼€å¯æ—¶é—´æˆ³
                timestampPosition: 'center',
                characterStatusEnabled: false,
                        // ğŸ”¥ã€æ–°å¢ã€‘çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®
                        statusUpdateFrequency: 'medium'
            };

            // 5. å°†æ–°åˆ›å»ºçš„é»˜è®¤è®¾ç½®å­˜å…¥å†…å­˜ï¼ˆä½¿ç”¨çª—å£éš”ç¦»é”®ï¼‰
            chatSettings[windowChatSettingsKey] = defaultSettings;

            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘åŒæ—¶ä¿å­˜åˆ°å…¨å±€é”®
            if (!chatSettings[chatId]) {
                chatSettings[chatId] = { ...defaultSettings };
            }

            // 6. ã€é‡è¦ã€‘åŒæ—¶ï¼Œç«‹å³å°†è¿™ä»½é»˜è®¤è®¾ç½®ä¿å­˜å›æ•°æ®åº“ï¼Œä¸ºè¿™ä¸ªæ–°èŠå¤©å»ºç«‹æ¡£æ¡ˆ
            try {
                // ğŸ”¥ã€æ–°åŠŸèƒ½ã€‘ä¼˜å…ˆä¿å­˜åˆ°çª—å£éš”ç¦»è¡¨
                if (windowId) {
                    await db.windowChatSettings.put({
                        chatId: chatId,
                        windowId: windowId,
                        settings: defaultSettings,
                        timestamp: Date.now()
                    });
                    console.log(`âœ… å·²ä¸ºæ–°èŠå¤© ${chatId} (çª—å£${windowId})åœ¨çª—å£éš”ç¦»è¡¨ä¸­åˆ›å»ºäº†é»˜è®¤è®¾ç½®æ¡£æ¡ˆ`);
                }

                // ğŸ”¥ã€å…¼å®¹æ€§ã€‘åŒæ—¶ä¿å­˜åˆ°åŸæœ‰çš„chatSettingsè¡¨
                await db.chatSettings.put({
                    id: chatId,
                    chatId: chatId,
                    settings: defaultSettings
                });
                console.log(`âœ… å·²ä¸ºæ–°èŠå¤© ${chatId} åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†é»˜è®¤è®¾ç½®æ¡£æ¡ˆ`);
                } catch (error) {
                console.error(`ä¸ºæ–°èŠå¤© ${chatId} (çª—å£${windowId})ä¿å­˜é»˜è®¤è®¾ç½®å¤±è´¥:`, error);
            }

            // 7. è¿”å›è¿™ä»½å…¨æ–°çš„é»˜è®¤è®¾ç½®
            return defaultSettings;
        }

        // å…¼å®¹å±‚ - åŒæ­¥ç‰ˆæœ¬çš„getCurrentChatSettings + çª—å£éš”ç¦»æ”¯æŒ
        // æ³¨æ„ï¼šè¿™ä¸ªå‡½æ•°åªä¼šè¿”å›å†…å­˜ä¸­çš„è®¾ç½®æˆ–é»˜è®¤è®¾ç½®ï¼Œä¸ä¼šä»æ•°æ®åº“åŠ è½½
        // ç”¨äºä¸æ–¹ä¾¿ä¿®æ”¹ä¸ºasync/awaitçš„åœ°æ–¹
        function getCurrentChatSettings() {
            if (!currentChatCharacter) return {};

            const chatId = currentChatCharacter.id;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨çª—å£éš”ç¦»çš„è®¾ç½®é”®
            const windowChatSettingsKey = `${chatId}_${windowId || 'default'}`;

            // ä¼˜å…ˆæ£€æŸ¥çª—å£éš”ç¦»çš„è®¾ç½®
            if (chatSettings[windowChatSettingsKey]) {
                return chatSettings[windowChatSettingsKey];
            }

            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘å¦‚æœæ²¡æœ‰çª—å£éš”ç¦»è®¾ç½®ï¼Œå°è¯•ä½¿ç”¨æ—§çš„å…¨å±€è®¾ç½®
            if (chatSettings[chatId]) {
                // å¤åˆ¶åˆ°çª—å£éš”ç¦»è®¾ç½®ä¸­ï¼Œé¿å…åç»­å†²çª
                chatSettings[windowChatSettingsKey] = { ...chatSettings[chatId] };
                return chatSettings[windowChatSettingsKey];
            }

            // å¦‚æœå†…å­˜ä¸­æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤è®¾ç½®
            // æ³¨æ„ï¼šè¿™é‡Œä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼Œåªæ˜¯ä¸´æ—¶ä½¿ç”¨
            // ä¸‹æ¬¡è°ƒç”¨å¼‚æ­¥ç‰ˆæœ¬çš„getAsyncChatSettingsæ—¶ä¼šæ­£ç¡®åŠ è½½/åˆ›å»ºè®¾ç½®
            console.warn(`âš ï¸ ä½¿ç”¨äº†åŒæ­¥ç‰ˆæœ¬è·å–IDä¸º ${chatId} (çª—å£${windowId})çš„è®¾ç½®ï¼Œä½†å†…å­˜ä¸­æ²¡æœ‰ç¼“å­˜ï¼Œè¿”å›ä¸´æ—¶é»˜è®¤è®¾ç½®`);

            const defaultSettings = {
                historyCount: 30,
                crossChatMemory: 3,
                enableDynamicMemory: true,
                enableMusicMemory: true,
                memoryMountEnabled: false,
                memoryMountCount: 3,
                selectedMemoryChats: [],
                timeAwarenessEnabled: true,
                aiCallEnabled: true,
                aiHeartrateEnabled: false,
                characterStatusEnabled: false,
                socialEnabled: false,
                socialFrequency: 'medium',
                backgroundInteractionEnabled: true,
                backgroundChatEnabled: true,
                backgroundMomentsEnabled: true,
                backgroundChatFrequency: 'low',
                backgroundMomentsFrequency: 'low',
                scheduledMomentsEnabled: false,
                scheduledMomentsTimes: [],
                timestampEnabled: true,
                timestampPosition: 'center',
                aiHeartrateEnabled: false,
                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ·»åŠ ä¸–ç•Œä¹¦ç›¸å…³è®¾ç½®
                worldbookMountEnabled: false,
                selectedWorldbooks: [],
                linkedWorldBookIds: [], // å…¼å®¹æ—§ç‰ˆæœ¬å­—æ®µå
                // ğŸ”¥ã€æ–°å¢ã€‘çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®
                statusUpdateFrequency: 'medium',
                // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ å¤´åƒè®¾ç½®ï¼Œç¡®ä¿ä¸ä¸ºç©º
                aiChatAvatar: '', // èŠå¤©ä¸“ç”¨å¤´åƒ
                userChatAvatar: '' // ç”¨æˆ·èŠå¤©ä¸“ç”¨å¤´åƒ
            };

            // åŒæ—¶è§¦å‘ä¸€ä¸ªå¼‚æ­¥åŠ è½½ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
            getAsyncChatSettings().then(settings => {
                console.log(`âœ… åå°å¼‚æ­¥åŠ è½½IDä¸º ${chatId} çš„è®¾ç½®å®Œæˆ`);
            }).catch(error => {
                console.error(`åå°å¼‚æ­¥åŠ è½½IDä¸º ${chatId} çš„è®¾ç½®å¤±è´¥:`, error);
            });

            return defaultSettings;
        }

        // ğŸ”¥ã€é‡æ„ã€‘ä¿å­˜å½“å‰èŠå¤©çš„è®¾ç½® - å®Œå…¨ä¾èµ–IndexedDB + è‡ªåŠ¨ä¿å­˜ + çª—å£éš”ç¦»
        async function saveCurrentChatSettings(settings) {
            if (!currentChatCharacter) return;

            const chatId = currentChatCharacter.id;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨çª—å£éš”ç¦»çš„è®¾ç½®é”®
            const windowChatSettingsKey = `${chatId}_${windowId || 'default'}`;

            // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€chatSettingsï¼ˆä½¿ç”¨çª—å£éš”ç¦»é”®ï¼‰
            chatSettings[windowChatSettingsKey] = settings;

            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘åŒæ—¶æ›´æ–°æ—§çš„å…¨å±€é”®ï¼Œä½†ä¼˜å…ˆçº§è¾ƒä½
            if (!chatSettings[chatId] || windowId) {
                chatSettings[chatId] = { ...settings };
            }

            try {
                // ğŸ”¥ã€æ–°åŠŸèƒ½ã€‘ä¼˜å…ˆä¿å­˜åˆ°çª—å£éš”ç¦»è¡¨
                if (windowId) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆæŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„chatId+windowIdç»„åˆ
                    const existingSetting = await db.windowChatSettings.where('[chatId+windowId]').equals([chatId, windowId]).first();

                    if (existingSetting) {
                        // æ›´æ–°ç°æœ‰è®°å½•
                        await db.windowChatSettings.update(existingSetting.id, {
                            settings: settings,
                            timestamp: Date.now()
                        });
                        console.log(`âœ… çª—å£éš”ç¦»èŠå¤©è®¾ç½®å·²æ›´æ–°åˆ°IndexedDB (è§’è‰²: ${chatId}, çª—å£: ${windowId})`);
                    } else {
                        // åˆ›å»ºæ–°è®°å½•
                        await db.windowChatSettings.add({
                            chatId: chatId,
                            windowId: windowId,
                            settings: settings,
                            timestamp: Date.now()
                        });
                        console.log(`âœ… çª—å£éš”ç¦»èŠå¤©è®¾ç½®å·²ä¿å­˜åˆ°IndexedDB (è§’è‰²: ${chatId}, çª—å£: ${windowId})`);
                    }
                }

                // ğŸ”¥ã€å…¼å®¹æ€§ã€‘åŒæ—¶ä¿å­˜åˆ°åŸæœ‰çš„chatSettingsè¡¨
                await db.chatSettings.put({
                    id: chatId,
                    chatId: chatId,
                    settings: settings
                });

                console.log(`âœ… èŠå¤©è®¾ç½®å·²ä¿å­˜åˆ°IndexedDB (è§’è‰²: ${chatId})`);

                // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è‡ªåŠ¨ä¿å­˜æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                scheduleAutoSave(chatId);

            } catch (error) {
                console.error('ğŸš¨ ä¿å­˜èŠå¤©è®¾ç½®åˆ°IndexedDBå¤±è´¥:', error);

                // ğŸ”¥ã€ç´§æ€¥å¤‡ä»½ã€‘åªåœ¨IndexedDBå®Œå…¨å¤±è´¥æ—¶æ‰ä½¿ç”¨localStorage
                try {
                    console.warn('âš ï¸ æ­£åœ¨è¿›è¡Œç´§æ€¥å¤‡ä»½...');
                    const emergencySettings = {
                        selectedIdentityId: settings.selectedIdentityId,
                        aiChatNickname: settings.aiChatNickname,
                        myChatNickname: settings.myChatNickname,
                        hideAvatars: settings.hideAvatars,
                        bubbleStyle: settings.bubbleStyle,
                        timestampEnabled: settings.timestampEnabled,
                        timestampPosition: settings.timestampPosition
                    };

                    const emergencyKey = windowId ? `chatSettings_emergency_${chatId}_${windowId}` : `chatSettings_emergency_${chatId}`;
                    localStorage.setItem(emergencyKey, JSON.stringify(emergencySettings));
                    console.log('âœ… ç´§æ€¥å¤‡ä»½å·²ä¿å­˜');
                    showToast('âš ï¸ æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œå·²å¯ç”¨ç´§æ€¥å¤‡ä»½', 'warning');

                } catch (localError) {
                    console.error('ğŸš¨ ç´§æ€¥å¤‡ä»½ä¹Ÿå¤±è´¥äº†:', localError);
                    showToast('âŒ è®¾ç½®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´', 'error');
                }
            }
        }



        // æ˜¾ç¤ºè®°å¿†æŒ‚è½½è®¾ç½®
        async function showMemoryMountSettings() {
            const chatSettings = await getAsyncChatSettings();
            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('memory-mount-enabled').checked = chatSettings.memoryMountEnabled || false;
            document.getElementById('memory-mount-count').value = chatSettings.memoryMountCount || 3;
            document.getElementById('memory-mount-display').textContent = (chatSettings.memoryMountCount || 3) + 'æ¡';

            // æ§åˆ¶è¯¦ç»†è®¾ç½®çš„æ˜¾ç¤º
            toggleMemoryMountDetails();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('memory-mount-enabled').onchange = toggleMemoryMountDetails;
            document.getElementById('memory-mount-count').oninput = function() {
                document.getElementById('memory-mount-display').textContent = this.value + 'æ¡';
            };

            // æ¸²æŸ“èŠå¤©åˆ—è¡¨
            renderMemoryMountChatList();

            showModal('memory-mount-modal');
        }

        // åˆ‡æ¢è®°å¿†æŒ‚è½½è¯¦ç»†è®¾ç½®æ˜¾ç¤º
        function toggleMemoryMountDetails() {
            const enabled = document.getElementById('memory-mount-enabled').checked;
            document.getElementById('memory-mount-details').style.display = enabled ? 'block' : 'none';
            document.getElementById('memory-mount-chats').style.display = enabled ? 'block' : 'none';

            // æ›´æ–°ä¸»è®¾ç½®ç•Œé¢æ˜¾ç¤º
            document.getElementById('current-memory-mount').textContent = enabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';
        }

        // æ¸²æŸ“è®°å¿†æŒ‚è½½èŠå¤©åˆ—è¡¨
        async function renderMemoryMountChatList() {
            const container = document.getElementById('memory-mount-list');
            container.innerHTML = '';

            if (characters.length === 0 && groupChats.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">æš‚æ— å¯æŒ‚è½½çš„èŠå¤©</p>';
                return;
            }

            // æ·»åŠ å•äººèŠå¤©
            characters.forEach(character => {
                if (currentChatCharacter && character.id === currentChatCharacter.id) return; // ä¸æ˜¾ç¤ºå½“å‰èŠå¤©

                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${character.id}" value="${character.id}" class="mount-checkbox">
                    <div class="mount-avatar-small" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div>
                        <div class="mount-name">${character.name}</div>
                        <div class="mount-type">å•èŠ</div>
                    </div>
                `;
                container.appendChild(item);
            });

            // æ·»åŠ ç¾¤èŠ
            groupChats.forEach(group => {
                if (currentChatCharacter && group.id === currentChatCharacter.id) return; // ä¸æ˜¾ç¤ºå½“å‰èŠå¤©

                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${group.id}" value="${group.id}" class="mount-checkbox">
                    <div class="mount-avatar-group">
                        ç¾¤
                    </div>
                    <div>
                        <div class="mount-name">${group.name}</div>
                                                    <div class="mount-type">ç¾¤èŠ (${group.members ? group.members.length + 1 : 1}äºº)</div>
                    </div>
                `;
                container.appendChild(item);
            });

            // åŠ è½½å·²é€‰æ‹©çš„èŠå¤©
            const chatSettings = await getAsyncChatSettings();
            const selectedChats = chatSettings.selectedMemoryChats || [];
            selectedChats.forEach(chatId => {
                const checkbox = document.getElementById(`mount-${chatId}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // ä¿å­˜è®°å¿†æŒ‚è½½è®¾ç½®
        async function saveMemoryMountSettings() {
            const chatSettings = await getAsyncChatSettings();
            chatSettings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chatSettings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value);

            // è·å–é€‰ä¸­çš„èŠå¤©
            const checkboxes = document.querySelectorAll('#memory-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedMemoryChats = Array.from(checkboxes).map(cb => cb.value);

            // æ›´æ–°ä¸»è®¾ç½®ç•Œé¢æ˜¾ç¤º
            document.getElementById('current-memory-mount').textContent = chatSettings.memoryMountEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';

            await saveCurrentChatSettings(chatSettings);
            hideModal('memory-mount-modal');
            showToast('è®°å¿†æŒ‚è½½è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const previewAi = document.getElementById('preview-ai');
            const previewUser = document.getElementById('preview-user');
            const previewContainer = document.getElementById('bubble-preview');

            if (!previewAi || !previewUser || !previewContainer) return;

            // è·å–å½“å‰è®¾ç½®
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';
            const padding = document.getElementById('bubble-padding')?.value || '12';
            const customCSS = document.getElementById('custom-bubble-css')?.value || '';

            // åº”ç”¨åŸºç¡€æ ·å¼
            previewUser.style.backgroundColor = myColor;
            previewUser.style.opacity = myOpacity;
            previewUser.style.padding = `${padding}px`;

            previewAi.style.backgroundColor = aiColor;
            previewAi.style.opacity = aiOpacity;
            previewAi.style.padding = `${padding}px`;

            // åº”ç”¨æ°”æ³¡æ ·å¼ç±»
            previewContainer.className = 'preview-container';
            if (window.selectedBubbleStyle) {
                previewContainer.classList.add(`bubble-style-${window.selectedBubbleStyle}`);
            }

            // åº”ç”¨è‡ªå®šä¹‰CSS
            applyPreviewCSS(customCSS);
        }

        // åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆ
        function applyPreviewCSS(css) {
            // ç§»é™¤æ—§çš„é¢„è§ˆæ ·å¼
            const oldStyle = document.getElementById('preview-custom-style');
            if (oldStyle) oldStyle.remove();

            if (!css.trim()) return;

            // åˆ›å»ºæ–°çš„æ ·å¼
            const style = document.createElement('style');
            style.id = 'preview-custom-style';

            // ğŸ”¥ã€ä¿®å¤ã€‘é¢„è§ˆåŒºåŸŸç°åœ¨ä½¿ç”¨ä¸å®é™…èŠå¤©ç•Œé¢ç›¸åŒçš„HTMLç»“æ„
            // ç›´æ¥åº”ç”¨CSSåˆ°é¢„è§ˆåŒºåŸŸï¼Œæ·»åŠ ä½œç”¨åŸŸå‰ç¼€
            let scopedCSS = css.replace(/^/gm, '#bubble-preview ');

            // ç¡®ä¿ä¼ªå…ƒç´ ä¸ä¼šé˜»æŒ¡é¢„è§ˆåŒºåŸŸçš„äº¤äº’
            scopedCSS += `
                #bubble-preview *::before,
                #bubble-preview *::after {
                    pointer-events: none !important;
                }
            `;

            style.textContent = scopedCSS;
            document.head.appendChild(style);
        }

        // åº”ç”¨è‡ªå®šä¹‰CSSåˆ°å®é™…èŠå¤©ç•Œé¢
        function applyCustomBubbleCSS() {
            const chatSettings = getCurrentChatSettings();
            const css = chatSettings.customBubbleCSS;

            // ç§»é™¤æ—§çš„è‡ªå®šä¹‰æ ·å¼
            const oldStyle = document.getElementById('custom-bubble-style');
            if (oldStyle) oldStyle.remove();

            if (!css || !css.trim()) {
                window.hasCustomBubbleStyle = false;
                return;
            }

            // ğŸ”¥ã€ç®€åŒ–ã€‘ç›´æ¥åº”ç”¨CSSï¼Œä¸è¿›è¡Œå¤æ‚è½¬æ¢
            // ç”¨æˆ·éœ€è¦ä½¿ç”¨æ ‡å‡†çš„é€‰æ‹©å™¨ï¼š.message-container.sent .message-bubble ç­‰
            let adaptedCSS = css;

            // åªæ·»åŠ å¿…è¦çš„å®‰å…¨æ ·å¼ï¼Œç¡®ä¿åŠŸèƒ½ä¸å—å½±å“
            adaptedCSS += `
                /* ç¡®ä¿ä¼ªå…ƒç´ ä¸é˜»æŒ¡äº¤äº’ */
                .message-container::before,
                .message-container::after,
                .message-bubble::before,
                .message-bubble::after {
                    pointer-events: none !important;
                }

                /* ç¡®ä¿è¯­éŸ³æ¶ˆæ¯å¯ç‚¹å‡» */
                .voice-message {
                    position: relative !important;
                    z-index: 10 !important;
                    pointer-events: auto !important;
                }
            `;

            const style = document.createElement('style');
            style.id = 'custom-bubble-style';
            style.textContent = adaptedCSS;
            document.head.appendChild(style);

            // è®¾ç½®å…¨å±€æ ‡å¿—
            window.hasCustomBubbleStyle = true;

            console.log('ğŸ¨ è‡ªå®šä¹‰CSSå·²åº”ç”¨ï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰');
        }

        // ä¿å­˜èŠå¤©å¤´åƒè®¾ç½®
        async function saveChatAvatarSettings() {
            const chatSettings = getCurrentChatSettings();

            // ä¿å­˜éšè—å¤´åƒè®¾ç½®
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                chatSettings.hideAvatars = hideAvatarsCheckbox.checked;
            }

            // ä¿å­˜å¤´åƒå½¢çŠ¶è®¾ç½®
            const avatarShapeRadios = document.querySelectorAll('input[name="avatar-shape"]');
            for (const radio of avatarShapeRadios) {
                if (radio.checked) {
                    chatSettings.avatarShape = radio.value;
                    break;
                }
            }

            // ğŸ”¥ã€å‹ç¼©å¤´åƒã€‘åœ¨ä¿å­˜å‰å‹ç¼©å¤´åƒæ•°æ®
            if (window.selectedMyChatAvatar) {
                chatSettings.myChatAvatar = await compressImage(window.selectedMyChatAvatar, 200, 0.7);
            }
            if (window.selectedAiChatAvatar) {
                chatSettings.aiChatAvatar = await compressImage(window.selectedAiChatAvatar, 200, 0.7);
            }

            try {
                await saveCurrentChatSettings(chatSettings);
                hideModal('avatar-settings-modal');

                // åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }

                showToast('å¤´åƒè®¾ç½®å·²ä¿å­˜', 'success');
            } catch (error) {
                console.error('ä¿å­˜å¤´åƒè®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å¯èƒ½ä¸è¶³', 'error');
            }
        }

        // ä¿å­˜æ˜µç§°è®¾ç½®
        async function saveChatNicknameSettings() {
            const chatSettings = getCurrentChatSettings();

            chatSettings.myChatNickname = document.getElementById('my-chat-nickname').value.trim();
            chatSettings.aiChatNickname = document.getElementById('ai-chat-nickname').value.trim();

            await saveCurrentChatSettings(chatSettings);
            hideModal('nickname-settings-modal');

            // æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜
            if (currentChatCharacter) {
                let displayTitle = chatSettings.aiChatNickname || currentChatCharacter.name;

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                if (currentChatCharacter.isGroup && currentChatCharacter.members) {
                    const memberCount = currentChatCharacter.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                    displayTitle = `${displayTitle}ï¼ˆ${memberCount}ï¼‰`;
                }

                const chatTitle = document.getElementById('api-chat-title');
                if (chatTitle) {
                    chatTitle.textContent = displayTitle;
                    // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                    chatTitle.classList.remove('typing-status');
                    chatTitle.dataset.originalTitle = displayTitle;
                }
            }

            // åˆ·æ–°èŠå¤©ç•Œé¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨å’Œè”ç³»äººåˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°æ˜µç§°
            renderMessageList();
            renderContactList();

            showToast('æ˜µç§°è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // ä¿å­˜æˆ³ä¸€æˆ³åç¼€è®¾ç½®
        async function savePokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();

            chatSettings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chatSettings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();

            await saveCurrentChatSettings(chatSettings);
            hideModal('poke-suffix-modal');
            showToast('æˆ³ä¸€æˆ³åç¼€è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // ä¿å­˜èŠå¤©èƒŒæ™¯è®¾ç½®
        async function saveChatBackgroundSettings() {
    // 1. ç¡®ä¿æœ‰å½“å‰èŠå¤©è§’è‰²
    if (!currentChatCharacter) return;

    // 2. æ ¹æ®ç”¨æˆ·çš„æ“ä½œæ›´æ–°èƒŒæ™¯è®¾ç½®
    // window.selectedChatBackground åœ¨ä½ é€‰æ‹©æˆ–ç§»é™¤èƒŒæ™¯æ—¶è¢«èµ‹å€¼
    let backgroundToApply;

            if (window.selectedChatBackground === null) {
        // ç”¨æˆ·ç‚¹å‡»äº†"ç§»é™¤èƒŒæ™¯"
        backgroundToApply = null;
            } else if (window.selectedChatBackground) {
        // ç”¨æˆ·é€‰æ‹©äº†æ–°èƒŒæ™¯
        backgroundToApply = await compressImage(window.selectedChatBackground, 800, 0.8);
    } else {
        // ç”¨æˆ·æ²¡åšä»»ä½•æ›´æ”¹ï¼Œä¿æŒåŸæœ‰è®¾ç½®ä¸å˜
        backgroundToApply = currentChatCharacter.background;
    }

    // 3. [å…³é”®] ç«‹å³åº”ç”¨èƒŒæ™¯è®¾ç½®ï¼Œè¿™ä¼šè‡ªåŠ¨æ›´æ–°currentChatCharacter.backgroundå¹¶ä¿å­˜
    await applyChatBackground(backgroundToApply);

    // 4. æ¸…ç†å¹¶å…³é—­æ¨¡æ€æ¡†
    hideModal('background-settings-modal');
    window.selectedChatBackground = undefined; // æ¸…ç†ä¸´æ—¶å˜é‡
            showToast('èŠå¤©èƒŒæ™¯è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // ç§»é™¤èƒŒæ™¯
        function removeBackground() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            backgroundPreview.style.backgroundImage = 'none';
            backgroundPreview.querySelector('.preview-text').style.display = 'block';
            backgroundPreview.querySelector('.preview-text').textContent = 'å·²ç§»é™¤èƒŒæ™¯';
            window.selectedChatBackground = null;
        }

        // æ›´æ–°æ°”æ³¡å¤§å°æ˜¾ç¤ºå€¼
        function updatePaddingValue(value) {
            const paddingValue = document.getElementById('bubble-padding-value');
            if (paddingValue) {
                if (value <= 6) {
                    paddingValue.textContent = 'è¶…ç´§å‡‘';
                } else if (value <= 10) {
                    paddingValue.textContent = 'ç´§å‡‘';
                } else if (value <= 14) {
                    paddingValue.textContent = 'ä¸­ç­‰';
                } else {
                    paddingValue.textContent = 'å®½æ¾';
                }
            }
        }

        // ä¿å­˜æ°”æ³¡æ ·å¼è®¾ç½®
        async function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();

            // ä¿å­˜æ ·å¼é€‰æ‹©
            if (window.selectedBubbleStyle) {
                chatSettings.bubbleStyle = window.selectedBubbleStyle;
            }

            // ä¿å­˜é¢œè‰²è®¾ç½®
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;

            // ä¿å­˜åˆ†ç¦»çš„é€æ˜åº¦è®¾ç½®
            chatSettings.myBubbleOpacity = document.getElementById('my-bubble-opacity').value;
            chatSettings.aiBubbleOpacity = document.getElementById('ai-bubble-opacity').value;

            // ä¿å­˜æ°”æ³¡å¤§å°è®¾ç½®
            chatSettings.bubblePadding = document.getElementById('bubble-padding').value;

            // ä¿å­˜è‡ªå®šä¹‰CSSè®¾ç½®
            const customCSS = document.getElementById('custom-bubble-css').value;
            chatSettings.customBubbleCSS = customCSS;

            await saveCurrentChatSettings(chatSettings);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç«‹å³åº”ç”¨æ°”æ³¡æ ·å¼
            applyBubbleStyle();

            // åº”ç”¨è‡ªå®šä¹‰CSS
            applyCustomBubbleCSS();

            // ğŸ”¥ã€ä¿®å¤ã€‘ç«‹å³æ›´æ–°æ°”æ³¡æ ·å¼æ˜¾ç¤º
            updateBubbleStyleDisplay();

            hideModal('bubble-style-modal');

            // åˆ·æ–°èŠå¤©ç•Œé¢ä»¥åº”ç”¨æ–°è®¾ç½®
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }

            showToast('æ°”æ³¡æ ·å¼è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // æ˜¾ç¤ºæ—¶é—´æˆ³è®¾ç½®
        function showTimestampSettings() {
            const chatSettings = getCurrentChatSettings();

            // è®¾ç½®æ—¶é—´æˆ³å¼€å…³çŠ¶æ€
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                // å¦‚æœè®¾ç½®æœªå®šä¹‰ï¼Œé»˜è®¤ä¸ºtrue
                timestampEnabled.checked = chatSettings.timestampEnabled !== false;
            }

            // è®¾ç½®æ—¶é—´æˆ³ä½ç½®é€‰é¡¹
            const timestampPosition = chatSettings.timestampPosition || 'center';
            const positionRadios = document.querySelectorAll('input[name="timestamp-position"]');
            positionRadios.forEach(radio => {
                radio.checked = radio.value === timestampPosition;
            });

            // ç»‘å®šæ—¶é—´æˆ³å¼€å…³å˜åŒ–äº‹ä»¶
            if (timestampEnabled) {
                timestampEnabled.onchange = function() {
                    const optionsGroup = document.getElementById('timestamp-options-group');
                    if (optionsGroup) {
                        optionsGroup.style.display = this.checked ? 'block' : 'none';
                    }
                };

                // è§¦å‘ä¸€æ¬¡æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
                const optionsGroup = document.getElementById('timestamp-options-group');
                if (optionsGroup) {
                    optionsGroup.style.display = timestampEnabled.checked ? 'block' : 'none';
                }
            }

            showModal('timestamp-settings-modal');
        }

        // ä¿å­˜æ—¶é—´æˆ³è®¾ç½®
        async function saveTimestampSettings() {
            const chatSettings = getCurrentChatSettings();

            // è·å–æ—¶é—´æˆ³å¼€å…³çŠ¶æ€
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                chatSettings.timestampEnabled = timestampEnabled.checked;
            }

            // è·å–é€‰ä¸­çš„æ—¶é—´æˆ³ä½ç½®
            const selectedPosition = document.querySelector('input[name="timestamp-position"]:checked');
            if (selectedPosition) {
                chatSettings.timestampPosition = selectedPosition.value;
            }

            await saveCurrentChatSettings(chatSettings);
            hideModal('timestamp-settings-modal');

            // é‡æ–°æ¸²æŸ“èŠå¤©æ¶ˆæ¯ä»¥åº”ç”¨æ–°çš„æ—¶é—´æˆ³è®¾ç½®
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }

            showToast('æ—¶é—´æˆ³è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤æˆå‘˜æ°”æ³¡é¢œè‰²è®¾ç½®åŠŸèƒ½
        function showGroupMemberColorSettings() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) {
                showToast('åªæœ‰ç¾¤èŠå¯ä»¥è®¾ç½®æˆå‘˜æ°”æ³¡é¢œè‰²', 'warning');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘å…ˆå…³é—­æ°”æ³¡æ ·å¼è®¾ç½®çª—å£ï¼Œé¿å…å±‚çº§é®æŒ¡
            hideModal('bubble-style-modal');

            const container = document.getElementById('group-member-colors-list');
            container.innerHTML = '';

            const chatSettings = getCurrentChatSettings();
            const memberColors = chatSettings.memberBubbleColors || {};

            // è·å–ç¾¤æˆå‘˜åˆ—è¡¨
            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            console.log('å½“å‰ç¾¤èŠ:', currentChatCharacter);
            console.log('æ‰¾åˆ°çš„ç¾¤èŠ:', group);
            console.log('ç¾¤èŠæˆå‘˜:', group?.members);

            if (!group || !group.members || group.members.length === 0) {
                container.innerHTML = '<p class="text-center-gray">è¯¥ç¾¤èŠæš‚æ— æˆå‘˜ã€‚è¯·å…ˆåœ¨ç¾¤èŠä¿¡æ¯ä¸­æ·»åŠ æˆå‘˜ã€‚</p>';
                showModal('group-member-colors-modal');
                return;
            }

            // ä¸ºæ¯ä¸ªç¾¤æˆå‘˜åˆ›å»ºé¢œè‰²è®¾ç½®é¡¹
            group.members.forEach(member => {
                // å…¼å®¹ä¸åŒçš„æˆå‘˜æ•°æ®ç»“æ„
                const memberId = typeof member === 'string' ? member : member.id;
                const character = characters.find(c => c.id === memberId);
                if (!character) {
                    console.log('æ‰¾ä¸åˆ°è§’è‰²:', memberId, 'æ‰€æœ‰è§’è‰²:', characters.map(c => ({id: c.id, name: c.name})));
                    return;
                }

                const memberColor = memberColors[memberId] || '#f0f0f0';

                const memberItem = document.createElement('div');
                memberItem.className = 'setting-item';
                memberItem.innerHTML = `
                    <div class="setting-left">
                        <div class="setting-label" style="display: flex; align-items: center; gap: 8px;">
                            <div class="character-avatar" style="width: 24px; height: 24px; background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border-radius: 50%;">
                                ${character.avatarUrl ? '' : character.name.charAt(0)}
                            </div>
                            ${character.name}
                        </div>
                        <div class="setting-desc">è®¾ç½® ${character.name} çš„ä¸“å±æ°”æ³¡é¢œè‰²</div>
                    </div>
                    <div class="setting-right">
                        <input type="color" id="member-color-${memberId}" class="color-input" value="${memberColor}" style="width: 40px; height: 30px;">
                    </div>
                `;

                container.appendChild(memberItem);
            });

            showModal('group-member-colors-modal');
        }

        function saveGroupMemberColors() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.memberBubbleColors) {
                chatSettings.memberBubbleColors = {};
            }

            // è·å–ç¾¤æˆå‘˜åˆ—è¡¨
            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            if (!group || !group.members) return;

            // ä¿å­˜æ¯ä¸ªæˆå‘˜çš„é¢œè‰²è®¾ç½®
            group.members.forEach(member => {
                // å…¼å®¹ä¸åŒçš„æˆå‘˜æ•°æ®ç»“æ„
                const memberId = typeof member === 'string' ? member : member.id;
                const colorInput = document.getElementById(`member-color-${memberId}`);
                if (colorInput) {
                    chatSettings.memberBubbleColors[memberId] = colorInput.value;
                }
            });

            saveCurrentChatSettings(chatSettings);
            hideModal('group-member-colors-modal');

            // åˆ·æ–°èŠå¤©ç•Œé¢ä»¥åº”ç”¨æ–°é¢œè‰²
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }

            showToast('ç¾¤æˆå‘˜æ°”æ³¡é¢œè‰²å·²ä¿å­˜', 'success');
        }

        // å¤´åƒä¸Šä¼ å¤„ç†å‡½æ•°
        function avatarUploadHandler(e) {
            console.log('avatar-upload changeäº‹ä»¶è¢«è§¦å‘');
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];

                console.log('é€‰æ‹©äº†æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'bytes', 'ç±»å‹:', file.type);

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                    e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPreviewText = document.getElementById('avatar-preview-text');

                        console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¼€å§‹è®¾ç½®é¢„è§ˆ');

                        if (!avatarPreview) {
                            console.error('æ‰¾ä¸åˆ°avatar-previewå…ƒç´ ');
                            alert('æ‰¾ä¸åˆ°å¤´åƒé¢„è§ˆå…ƒç´ ');
                            return;
                        }

                        // æ·»åŠ has-imageç±»æ¥è¦†ç›–é»˜è®¤èƒŒæ™¯
                        avatarPreview.classList.add('has-image');

                        // å¼ºåˆ¶è®¾ç½®èƒŒæ™¯å›¾ç‰‡å¹¶æ¸…é™¤æ‰€æœ‰å…¶ä»–èƒŒæ™¯æ ·å¼
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');

                        // éšè—æ–‡å­—
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }

                        // å­˜å‚¨å›¾ç‰‡æ•°æ®ç”¨äºåç»­ä¿å­˜
                        window.selectedAvatarData = event.target.result;

                        // éªŒè¯æ ·å¼æ˜¯å¦æ­£ç¡®è®¾ç½®
                        console.log('å¤´åƒé¢„è§ˆUIæ›´æ–°å®Œæˆï¼ŒèƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®');
                        console.log('å½“å‰avatar-previewçš„æ ·å¼:', {
                            background: avatarPreview.style.background,
                            backgroundSize: avatarPreview.style.backgroundSize,
                            backgroundPosition: avatarPreview.style.backgroundPosition,
                            className: avatarPreview.className
                        });

                        console.log('å¤´åƒé¢„è§ˆè®¾ç½®æˆåŠŸï¼Œå›¾ç‰‡æ•°æ®å·²å­˜å‚¨');
                    } catch (error) {
                        console.error('è®¾ç½®å¤´åƒé¢„è§ˆæ—¶å‘ç”Ÿé”™è¯¯:', error);
                        alert('è®¾ç½®å¤´åƒé¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                    }
                };

                reader.onerror = function() {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                    alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                    e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                };

                reader.readAsDataURL(file);
            } else {
                console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶æˆ–filesä¸ºç©º');
            }
        }

        // åŠ è½½è‡ªå®šä¹‰è¡¨æƒ…åŒ… - ä½¿ç”¨IndexedDBï¼ˆåŒ…å«æ•°æ®è¿ç§»ï¼‰
        async function loadCustomEmojis() {
            try {
                const savedCustomEmojis = await db.customEmojis.toArray();

                if (savedCustomEmojis.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localStorageData = localStorage.getItem('customEmojis');
                    if (localStorageData) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„è‡ªå®šä¹‰è¡¨æƒ…åŒ…æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localEmojis = JSON.parse(localStorageData);

                        // ä¸ºè¿ç§»çš„è¡¨æƒ…åŒ…æ·»åŠ isPersonalæ ‡è¯†ï¼Œé»˜è®¤ä¸ºä¸ªäººè¡¨æƒ…åŒ…
                        const migratedEmojis = localEmojis.map(emoji => ({
                            ...emoji,
                            isPersonal: emoji.isPersonal !== undefined ? emoji.isPersonal : true
                        }));

                        if (migratedEmojis.length > 0) {
                            await db.customEmojis.bulkAdd(migratedEmojis);
                        }

                        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘åªåŠ è½½ä¸ªäººè¡¨æƒ…åŒ…åˆ°å†…å­˜ï¼Œåº“è¡¨æƒ…åŒ…ä¸éœ€è¦åŠ è½½åˆ°å†…å­˜
                        customEmojis = migratedEmojis.filter(emoji => emoji.isPersonal !== false);
                        console.log('è‡ªå®šä¹‰è¡¨æƒ…åŒ…è¿ç§»å®Œæˆ:', customEmojis);
                    } else {
                        customEmojis = [];
                    }
                } else {
                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘åªåŠ è½½ä¸ªäººè¡¨æƒ…åŒ…åˆ°å†…å­˜ï¼Œåº“è¡¨æƒ…åŒ…ä¸éœ€è¦åŠ è½½åˆ°å†…å­˜
                    customEmojis = savedCustomEmojis.filter(emoji => emoji.isPersonal !== false);
                    console.log('ä»IndexedDBåŠ è½½ä¸ªäººè¡¨æƒ…åŒ…:', customEmojis);
                }

                // ğŸ”§ã€ä¿®å¤ã€‘recentEmojisä¹Ÿä»IndexedDBåŠ è½½ï¼Œå½»åº•è§£å†³localStorageé—®é¢˜
                const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                if (savedRecentEmojis.length === 0) {
                    // IndexedDBä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„recentEmojisæ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                        const localRecents = JSON.parse(localRecentEmojis);

                        if (localRecents.length > 0) {
                            // é™åˆ¶ä¸º10ä¸ª
                            const limitedRecents = localRecents.slice(0, 10);
                            const recentEmojisWithId = limitedRecents.map((emoji, index) => ({
                                id: index + 1,
                                url: emoji.url,
                                description: emoji.description || 'è¡¨æƒ…åŒ…',
                                lastUsed: Date.now() - index * 1000
                            }));
                            await db.recentEmojis.bulkAdd(recentEmojisWithId);
                            recentEmojis = limitedRecents;

                            // æ¸…ç†localStorage
                            localStorage.removeItem('recentEmojis');
                            console.log('recentEmojisè¿ç§»å®Œæˆå¹¶æ¸…ç†localStorage');
                        } else {
                            recentEmojis = [];
                        }
                    } else {
                        recentEmojis = [];
                    }
                } else {
                    // ä»IndexedDBè½¬æ¢å›åŸæ ¼å¼
                    recentEmojis = savedRecentEmojis.map(item => ({
                        url: item.url,
                        description: item.description
                    }));
                    console.log('ä»IndexedDBåŠ è½½recentEmojis:', recentEmojis);
                }
            } catch (error) {
                console.error('åŠ è½½è‡ªå®šä¹‰è¡¨æƒ…åŒ…å¤±è´¥:', error);
                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½
                const localStorageData = localStorage.getItem('customEmojis');
                if (localStorageData) {
                    customEmojis = JSON.parse(localStorageData);
                    console.log('ä»localStorageå¤‡ä»½åŠ è½½è‡ªå®šä¹‰è¡¨æƒ…åŒ…:', customEmojis);
                } else {
                    customEmojis = [];
                }

                // å°è¯•ä»IndexedDBåŠ è½½recentEmojis
                try {
                    const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                    if (savedRecentEmojis.length > 0) {
                        recentEmojis = savedRecentEmojis.map(item => ({
                            url: item.url,
                            description: item.description
                        }));
                    } else {
                        recentEmojis = [];
                    }
                } catch (dbError) {
                    // å¦‚æœIndexedDBå¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        recentEmojis = JSON.parse(localRecentEmojis);
                    } else {
                        recentEmojis = [];
                    }
                }
            }
        }

        // ä¿å­˜è‡ªå®šä¹‰è¡¨æƒ…åŒ… - ä½¿ç”¨IndexedDB
        async function saveCustomEmojis() {
            try {
                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åªåˆ é™¤ä¸ªäººè¡¨æƒ…åŒ…ï¼Œä¿æŠ¤åº“è¡¨æƒ…åŒ…
                await db.transaction('rw', db.customEmojis, async () => {
                    // å…ˆåˆ é™¤æ‰€æœ‰ä¸ªäººè¡¨æƒ…åŒ…ï¼ˆisPersonalä¸ºtrueæˆ–undefinedçš„è®°å½•ï¼‰
                    // ä¿ç•™åº“è¡¨æƒ…åŒ…ï¼ˆisPersonalä¸ºfalseçš„è®°å½•ï¼‰

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨filteræ–¹æ³•è€Œä¸æ˜¯where().equals()æ¥é¿å…undefinedå€¼çš„ç´¢å¼•é—®é¢˜
                    // åˆ é™¤æ‰€æœ‰ä¸ªäººè¡¨æƒ…åŒ…ï¼ˆisPersonal !== falseï¼‰
                    await db.customEmojis.filter(emoji => emoji.isPersonal !== false).delete();

                    // ç„¶åæ·»åŠ å½“å‰çš„ä¸ªäººè¡¨æƒ…åŒ…ï¼Œç¡®ä¿isPersonalå­—æ®µæœ‰æ˜ç¡®çš„å€¼
                    if (customEmojis.length > 0) {
                        const personalEmojis = customEmojis.map(emoji => ({
                            ...emoji,
                            isPersonal: true // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿ä¸ªäººè¡¨æƒ…åŒ…æœ‰æ˜ç¡®çš„isPersonalå€¼
                        }));
                        await db.customEmojis.bulkAdd(personalEmojis);
                    }
                });

                console.log('ä¸ªäººè¡¨æƒ…åŒ…ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜è‡ªå®šä¹‰è¡¨æƒ…åŒ…å¤±è´¥:', error);
                showToast('âŒ è¡¨æƒ…åŒ…ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰è¡¨æƒ…åŒ…é¢æ¿
        function showCustomEmojiPanel() {
            const panel = document.getElementById('custom-emoji-panel');
            const isVisible = panel.style.display === 'block';

            if (isVisible) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            } else {
                panel.style.display = 'block';
                renderEmojiGrid();

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
                setTimeout(() => {
                    document.addEventListener('click', hideCustomEmojiPanel);
                }, 100);
            }
        }

        // éšè—è‡ªå®šä¹‰è¡¨æƒ…åŒ…é¢æ¿
        function hideCustomEmojiPanel(e) {
            const panel = document.getElementById('custom-emoji-panel');

            // å¦‚æœæ²¡æœ‰ä¼ é€’äº‹ä»¶å‚æ•°ï¼Œç›´æ¥éšè—é¢æ¿
            if (!e) {
                if (panel) {
                    panel.style.display = 'none';
                    document.removeEventListener('click', hideCustomEmojiPanel);
                }
                return;
            }

            const emojiBtn = e.target.closest('.chat-action-btn');

            if (panel && !panel.contains(e.target) && !emojiBtn) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            }
        }

        // æ¸²æŸ“è¡¨æƒ…åŒ…ç½‘æ ¼
        async function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';

            let emojisToShow = [];

            if (currentEmojiTab === 'recent') {
                emojisToShow = await getFilteredEmojis(recentEmojis);
            } else if (currentEmojiTab === 'custom') {
                emojisToShow = await getFilteredEmojis(customEmojis);
            }

            // æ·»åŠ è¡¨æƒ…åŒ…
            emojisToShow.forEach((emoji, index) => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'custom-emoji-item';
                emojiItem.style.backgroundImage = emoji.url && emoji.url !== 'undefined' ? `url(${emoji.url})` : 'none';
                emojiItem.onclick = () => sendEmojiMessage(emoji);

                // ä¸ºè‡ªå®šä¹‰è¡¨æƒ…åŒ…å’Œæœ€è¿‘ä½¿ç”¨è¡¨æƒ…åŒ…æ·»åŠ åˆ é™¤æŒ‰é’®
                if (currentEmojiTab === 'custom' || currentEmojiTab === 'recent') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'emoji-delete-btn';
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (currentEmojiTab === 'custom') {
                        deleteCustomEmoji(index);
                        } else if (currentEmojiTab === 'recent') {
                            deleteRecentEmoji(index);
                        }
                    };
                    emojiItem.appendChild(deleteBtn);
                }

                grid.appendChild(emojiItem);
            });

            // å¦‚æœæ˜¯è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼Œæ·»åŠ ä¸Šä¼ æŒ‰é’®
            if (currentEmojiTab === 'custom') {
                const uploadItem = document.createElement('div');
                uploadItem.className = 'custom-emoji-item placeholder';
                uploadItem.innerHTML = '+';
                uploadItem.onclick = () => document.getElementById('emoji-upload').click();
                grid.appendChild(uploadItem);
            }

            // å¦‚æœæ²¡æœ‰è¡¨æƒ…åŒ…ï¼Œæ˜¾ç¤ºæç¤º
            if (emojisToShow.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-emoji-grid';

                                                if (currentEmojiTab === 'recent') {
                                    emptyMsg.textContent = 'è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡è¡¨æƒ…åŒ…';
                                } else {
                                    emptyMsg.textContent = 'è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…ï¼Œç‚¹å‡»+å·æ·»åŠ ';
                                }

                grid.appendChild(emptyMsg);
            }
        }

        // å‘é€è¡¨æƒ…åŒ…æ¶ˆæ¯
        async function sendEmojiMessage(emoji) {
            console.log('ğŸ­ å‘é€è¡¨æƒ…åŒ…:', emoji);

            if (!currentChatCharacter) return;

            // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
            addToRecentEmojis(emoji);

            // ğŸ”¥ã€ä¿®å¤ã€‘è¡¨æƒ…åŒ…æ¶ˆæ¯åªæ˜¾ç¤ºå›¾ç‰‡ï¼Œä¸æ˜¾ç¤ºæ–‡å­—å†…å®¹
            const messageId = Date.now().toString();
            const emojiMessage = {
                id: messageId,
                sender: 'sent',
                content: '', // è¡¨æƒ…åŒ…æ¶ˆæ¯ä¸æ˜¾ç¤ºæ–‡å­—å†…å®¹
                image: emoji.url,
                isEmoji: true,
                emojiDescription: emoji.description || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…',
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            chatMessages[currentChatCharacter.id].push(emojiMessage);
            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡è¡¨æƒ…åŒ…æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const stableId = `${currentChatCharacter.id}_${emojiMessage.id}_${chatMessages[currentChatCharacter.id].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: currentChatCharacter.id,
                    timestamp: emojiMessage.timestamp,
                    messageOrder: chatMessages[currentChatCharacter.id].length - 1,
                    originalMessageId: emojiMessage.id,
                    messageData: emojiMessage
                });
                console.log('âœ… [é«˜æ•ˆè¡¨æƒ…åŒ…] è¡¨æƒ…åŒ…æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('è¡¨æƒ…åŒ…æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                saveChatMessages();
            }

            // æ¸²æŸ“æ¶ˆæ¯
            renderChatMessages(currentChatCharacter.id);

            // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è§’è‰²çŠ¶æ€æ›´æ–°
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);

            // éšè—è¡¨æƒ…åŒ…é¢æ¿
            hideCustomEmojiPanel();

            // è®¾ç½®å¾…å›å¤æ¶ˆæ¯ï¼Œæ”¯æŒæ™ºèƒ½å›å¤æŒ‰é’®
            pendingUserMessage = emojiMessage;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
            }

            // æ³¨é‡Šæ‰è‡ªåŠ¨å›å¤ï¼Œæ”¹ä¸ºæ‰‹åŠ¨å›å¤æ¨¡å¼
            // setTimeout(() => {
            //     sendAIEmojiResponse(emoji);
            // }, 1000 + Math.random() * 2000);
        }

        // ä¿å­˜æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…åŒ…åˆ°IndexedDB
        async function saveRecentEmojis() {
            try {
                // é™åˆ¶æœ€è¿‘ä½¿ç”¨è¡¨æƒ…åŒ…æ•°é‡ä¸º10ä¸ª
                const maxRecentEmojis = 10;
                if (recentEmojis.length > maxRecentEmojis) {
                    recentEmojis = recentEmojis.slice(0, maxRecentEmojis);
                }

                await db.transaction('rw', db.recentEmojis, async () => {
                    await db.recentEmojis.clear();
                    if (recentEmojis.length > 0) {
                        const recentEmojisWithId = recentEmojis.map((emoji, index) => ({
                            id: index + 1,
                            url: emoji.url,
                            description: emoji.description || 'è¡¨æƒ…åŒ…',
                            lastUsed: Date.now() - index * 1000 // ç¡®ä¿é¡ºåº
                        }));
                        await db.recentEmojis.bulkAdd(recentEmojisWithId);
                    }
                });
            } catch (error) {
                console.error('ä¿å­˜æœ€è¿‘è¡¨æƒ…åŒ…å¤±è´¥:', error);
            }
        }

        // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…åŒ…
        async function addToRecentEmojis(emoji) {
            // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒè¡¨æƒ…åŒ…
            recentEmojis = recentEmojis.filter(e => e.url !== emoji.url);

            // æ·»åŠ åˆ°å¼€å¤´
            recentEmojis.unshift(emoji);

            // é™åˆ¶æœ€è¿‘ä½¿ç”¨æ•°é‡ä¸º20ä¸ª
            if (recentEmojis.length > 20) {
                recentEmojis = recentEmojis.slice(0, 20);
            }

            // åªä¿å­˜æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…åŒ…ï¼Œä¸è§¦å‘ä¸ªäººè¡¨æƒ…åŒ…ä¿å­˜
            await saveRecentEmojis();
        }

        // æ£€æµ‹å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒè§†è§‰åŠŸèƒ½
        function isVisionModelSupported() {
            // æ”¯æŒè§†è§‰çš„æ¨¡å‹åˆ—è¡¨
            const visionModels = [
                // OpenAI GPTç³»åˆ—
                'gpt-4-vision',
                'gpt-4o',
                'gpt-4-turbo',
                'gpt-4o-mini',

                // Google Geminiç³»åˆ—
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-exp',
                'gemini-pro-vision',

                // Anthropic Claudeç³»åˆ—
                'claude-3-opus',
                'claude-3-sonnet',
                'claude-3-haiku',
                'claude-3.5-sonnet',
                'claude-3.5-haiku',

                // å›½äº§æ¨¡å‹
                'qwen-vl',
                'qwen2-vl',
                'yi-vision',
                'glm-4v',
                'internvl',
                'cogvlm',

                // å…¶ä»–æ¨¡å‹
                'llava',
                'moondream',
                'phi-3-vision'
            ];

            const currentModel = apiSettings.model?.toLowerCase() || '';

            // æ£€æŸ¥å½“å‰æ¨¡å‹æ˜¯å¦åŒ…å«ä»»ä½•æ”¯æŒè§†è§‰çš„æ¨¡å‹åç§°
            const isVisionSupported = visionModels.some(model => currentModel.includes(model.toLowerCase()));

            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            console.log('å½“å‰æ¨¡å‹:', currentModel);
            console.log('æ˜¯å¦æ”¯æŒè§†è§‰:', isVisionSupported);

            return isVisionSupported;
        }

        // æ³¨é‡Šï¼šAIå¯¹è¡¨æƒ…åŒ…çš„è‡ªåŠ¨å›å¤åŠŸèƒ½å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨æ‰‹åŠ¨å›å¤æ¨¡å¼
        // è¡¨æƒ…åŒ…å’Œå›¾ç‰‡éƒ½é€šè¿‡æ™ºèƒ½å›å¤æŒ‰é’®æ¥è§¦å‘AIå›å¤

        // åˆ é™¤è‡ªå®šä¹‰è¡¨æƒ…åŒ…
        function deleteCustomEmoji(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ')) {
                customEmojis.splice(index, 1);
                saveCustomEmojis();
                renderEmojiGrid();
            }
        }

        // åˆ é™¤æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…åŒ…
        function deleteRecentEmoji(index) {
            if (confirm('ç¡®å®šè¦ä»æœ€è¿‘ä½¿ç”¨ä¸­åˆ é™¤è¿™ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ')) {
                recentEmojis.splice(index, 1);
                saveCustomEmojis(); // ğŸ”§ã€ä¿®å¤ã€‘ç°åœ¨ä½¿ç”¨IndexedDBä¿å­˜
                renderEmojiGrid();
            }
        }

        // åˆå§‹åŒ–è¡¨æƒ…åŒ…ä¸Šä¼ åŠŸèƒ½
        function initializeEmojiUpload() {
            const emojiInput = document.getElementById('emoji-upload');
            if (emojiInput) {
                emojiInput.addEventListener('change', handleEmojiUpload);
            }

            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                    // æ·»åŠ å½“å‰activeç±»
                    this.classList.add('active');

                    // åˆ‡æ¢å½“å‰æ ‡ç­¾é¡µ
                    currentEmojiTab = this.dataset.tab;
                    renderEmojiGrid();
                });
            });
        }

        // åˆ‡æ¢å·¥å…·é¢æ¿æ˜¾ç¤º/éšè—
        function toggleToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');
            const emojiPanel = document.getElementById('custom-emoji-panel');

            if (!panel || !toggleBtn) return;

            const isVisible = panel.style.display === 'block';

            if (isVisible) {
                // éšè—å·¥å…·é¢æ¿
                hideToolsPanel();
            } else {
                // æ˜¾ç¤ºå·¥å…·é¢æ¿
                showToolsPanel();

                // éšè—è¡¨æƒ…åŒ…é¢æ¿
                if (emojiPanel) {
                    emojiPanel.style.display = 'none';
                }

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
                setTimeout(() => {
                    document.addEventListener('click', handleToolsPanelOutsideClick);
                }, 100);
            }
        }

        // æ˜¾ç¤ºå·¥å…·é¢æ¿
        function showToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');

            // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®èŠå¤©ç±»å‹æ˜¾ç¤º/éšè—å•èŠä¸“ç”¨å·¥å…·é¡¹
            const singleChatOnlyItems = document.querySelectorAll('.single-chat-only');
            const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
            singleChatOnlyItems.forEach(item => {
                if (isGroupChat) {
                    item.style.display = 'none';
                } else {
                    item.style.display = '';
                }
            });

            if (panel) {
                panel.style.display = 'block';
                panel.style.animation = 'toolsPanelSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }

            if (toggleBtn) {
                toggleBtn.classList.add('active');
            }
        }

        // éšè—å·¥å…·é¢æ¿
        function hideToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');

            if (panel) {
                panel.style.display = 'none';
            }

            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }

            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨å…³é—­çš„äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('click', handleToolsPanelOutsideClick);
        }

        // å¤„ç†å·¥å…·é¢æ¿å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
        function handleToolsPanelOutsideClick(e) {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');

            // å¦‚æœç‚¹å‡»çš„æ˜¯å·¥å…·é¢æ¿å†…éƒ¨æˆ–è§¦å‘æŒ‰é’®ï¼Œä¸å…³é—­é¢æ¿
            if (panel && !panel.contains(e.target) &&
                toggleBtn && !toggleBtn.contains(e.target)) {
                hideToolsPanel();
            }
        }

        // å¤„ç†è¡¨æƒ…åŒ…ä¸Šä¼ 
        function handleEmojiUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // æ£€æŸ¥GIFæ ¼å¼ï¼Œæé†’ç”¨æˆ·å¯èƒ½çš„é—®é¢˜
                if (file.type === 'image/gif') {
                    const confirmed = confirm('æ£€æµ‹åˆ°GIFæ ¼å¼çš„è¡¨æƒ…åŒ…ï¼\n\nâš ï¸ æ³¨æ„äº‹é¡¹ï¼š\nâ€¢ AIå¯ä»¥å‘é€è¿™ä¸ªGIFåŠ¨å›¾\nâ€¢ ä½†Gemini APIæ— æ³•è¯†åˆ«GIFå†…å®¹\nâ€¢ é‡æ–°ç”ŸæˆåŠŸèƒ½å¯èƒ½å¤±æ•ˆ\nâ€¢ å»ºè®®ä½¿ç”¨é™æ€å›¾ç‰‡æ ¼å¼\n\næ˜¯å¦ä»è¦ä¸Šä¼ è¿™ä¸ªGIFè¡¨æƒ…åŒ…ï¼Ÿ');
                    if (!confirmed) {
                        return;
                    }
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    // å‡†å¤‡ä¸ªäººè¡¨æƒ…åŒ…æ•°æ®
                    const emojiData = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        url: event.target.result,
                        addedAt: new Date().toISOString(),
                        isPersonal: true // æ ‡è¯†ä¸ºä¸ªäººè¡¨æƒ…åŒ…
                    };

                    // å­˜å‚¨å¾…å¤„ç†çš„è¡¨æƒ…åŒ…æ•°æ®
                    pendingPersonalEmojiData = emojiData;

                    // æ˜¾ç¤ºæè¿°æ·»åŠ æ¨¡æ€æ¡†
                    showPersonalEmojiDescriptionModal(event.target.result);
                };

                reader.readAsDataURL(file);
            });

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }

        // æ˜¾ç¤ºä¸ªäººè¡¨æƒ…åŒ…æè¿°æ·»åŠ æ¨¡æ€æ¡†
        function showPersonalEmojiDescriptionModal(imageUrl) {
            const modal = document.getElementById('personal-emoji-description-modal');
            const previewImage = document.getElementById('personal-emoji-preview-image');
            const descriptionInput = document.getElementById('personal-emoji-description-input');

            // è®¾ç½®é¢„è§ˆå›¾ç‰‡
            previewImage.src = imageUrl;

            // æ¸…ç©ºæè¿°è¾“å…¥æ¡†
            descriptionInput.value = '';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';

            // èšç„¦åˆ°æè¿°è¾“å…¥æ¡†
            setTimeout(() => {
                descriptionInput.focus();
            }, 100);

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    // Ctrl+Enter æˆ– Cmd+Enter ç¡®è®¤
                    confirmPersonalEmojiDescription();
                    descriptionInput.removeEventListener('keydown', handleKeyDown);
                } else if (e.key === 'Escape') {
                    // Esc å–æ¶ˆ
                    hidePersonalEmojiDescriptionModal();
                    descriptionInput.removeEventListener('keydown', handleKeyDown);
                }
            };

            descriptionInput.addEventListener('keydown', handleKeyDown);
        }

        // éšè—ä¸ªäººè¡¨æƒ…åŒ…æè¿°æ·»åŠ æ¨¡æ€æ¡†
        function hidePersonalEmojiDescriptionModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }

            const modal = document.getElementById('personal-emoji-description-modal');
            modal.style.display = 'none';

            // æ¸…ç©ºå¾…å¤„ç†çš„æ•°æ®
            pendingPersonalEmojiData = null;
        }

        // ç¡®è®¤ä¸ªäººè¡¨æƒ…åŒ…æè¿°
        function confirmPersonalEmojiDescription() {
            if (!pendingPersonalEmojiData) return;

            const descriptionInput = document.getElementById('personal-emoji-description-input');
            const description = descriptionInput.value.trim() || 'è¡¨æƒ…åŒ…';

            // åˆ›å»ºæ–°çš„è¡¨æƒ…åŒ…
            const emoji = {
                id: pendingPersonalEmojiData.id,
                url: pendingPersonalEmojiData.url,
                description: description,
                addedAt: pendingPersonalEmojiData.addedAt,
                isPersonal: pendingPersonalEmojiData.isPersonal
            };

            customEmojis.push(emoji);
            saveCustomEmojis();

            // å¦‚æœå½“å‰åœ¨è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼Œé‡æ–°æ¸²æŸ“
            if (currentEmojiTab === 'custom') {
                renderEmojiGrid();
            }

            // éšè—æ¨¡æ€æ¡†
            document.getElementById('personal-emoji-description-modal').style.display = 'none';

            // æ¸…ç©ºå¾…å¤„ç†çš„æ•°æ®
            pendingPersonalEmojiData = null;

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('è¡¨æƒ…åŒ…å·²æ·»åŠ ', 'success');
        }

        // ===== è¡¨æƒ…åŒ…åº“åŠŸèƒ½ =====

        // åŠ è½½è¡¨æƒ…åŒ…åº“
        async function loadEmojiLibraries() {
            try {
                emojiLibraries = await db.emojiLibraries.toArray();
                renderEmojiLibraryList();
            } catch (error) {
                console.error('åŠ è½½è¡¨æƒ…åŒ…åº“å¤±è´¥:', error);
                emojiLibraries = [];
            }
        }

        // ä¿å­˜è¡¨æƒ…åŒ…åº“
        async function saveEmojiLibraries() {
            try {
                await db.transaction('rw', db.emojiLibraries, async () => {
                    await db.emojiLibraries.clear();
                    if (emojiLibraries.length > 0) {
                        await db.emojiLibraries.bulkAdd(emojiLibraries);
                    }
                });
                console.log('è¡¨æƒ…åŒ…åº“ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜è¡¨æƒ…åŒ…åº“å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢é¢å…·åŒºåŸŸå±•å¼€/æ”¶èµ·
        function togglePersonaSection() {
            const content = document.getElementById('persona-content');
            const chevron = document.getElementById('persona-chevron');

            isPersonaExpanded = !isPersonaExpanded;

            if (isPersonaExpanded) {
                content.style.display = 'block';
                chevron.classList.add('expanded');
            } else {
                content.style.display = 'none';
                chevron.classList.remove('expanded');
            }
        }

        // åˆ‡æ¢è¡¨æƒ…åŒ…åº“åŒºåŸŸå±•å¼€/æ”¶èµ·
        function toggleEmojiLibrarySection() {
            const content = document.getElementById('emoji-library-content');
            const chevron = document.getElementById('emoji-library-chevron');

            isEmojiLibraryExpanded = !isEmojiLibraryExpanded;

            if (isEmojiLibraryExpanded) {
                content.style.display = 'block';
                chevron.classList.add('expanded');
                renderEmojiLibraryList();
            } else {
                content.style.display = 'none';
                chevron.classList.remove('expanded');
            }
        }

        // æ¸²æŸ“è¡¨æƒ…åŒ…åº“åˆ—è¡¨
        function renderEmojiLibraryList() {
            const listContainer = document.getElementById('emoji-library-list');
            if (!listContainer) return;

            if (emojiLibraries.length === 0) {
                listContainer.innerHTML = `
                    <div class="emoji-library-empty-state">
                        <p>è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…åº“</p>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªè¡¨æƒ…åŒ…åº“</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = emojiLibraries.map(library => `
                <div class="emoji-library-item" onclick="openEmojiLibrary('${library.id}')">
                    <div class="emoji-library-item-info">
                        <div class="emoji-library-item-name">${library.name}</div>
                        <div class="emoji-library-item-stats" id="library-stats-${library.id}">è®¡ç®—ä¸­...</div>
                    </div>
                    <div class="emoji-library-item-actions">
                        <div class="emoji-library-action-btn" onclick="event.stopPropagation(); editEmojiLibrary('${library.id}')" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="emoji-library-action-btn delete" onclick="event.stopPropagation(); deleteEmojiLibrary('${library.id}')" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            // å¼‚æ­¥æ›´æ–°æ¯ä¸ªåº“çš„ç»Ÿè®¡ä¿¡æ¯
            emojiLibraries.forEach(async (library) => {
                const count = await getEmojiLibraryItemCount(library.id);
                const statsElement = document.getElementById(`library-stats-${library.id}`);
                if (statsElement) {
                    statsElement.textContent = `${count} ä¸ªè¡¨æƒ…åŒ…`;
                }
            });
        }

        // è·å–è¡¨æƒ…åŒ…åº“ä¸­çš„è¡¨æƒ…åŒ…æ•°é‡
        async function getEmojiLibraryItemCount(libraryId) {
            try {
                const count = await db.emojiLibraryItems.where('libraryId').equals(libraryId).count();
                return count;
            } catch (error) {
                console.error('è·å–è¡¨æƒ…åŒ…åº“ç»Ÿè®¡å¤±è´¥:', error);
                return 0;
            }
        }

        // ğŸ”¥ã€ç´§æ€¥ä¿®å¤ã€‘è¯¦ç»†æ£€æŸ¥æ‰€æœ‰è¡¨æƒ…åŒ…æ•°æ®
        async function checkAllEmojiData() {
            console.log('ğŸš¨ [URGENT] è¯¦ç»†æ£€æŸ¥æ‰€æœ‰è¡¨æƒ…åŒ…æ•°æ®...');

            try {
                // è·å–æ‰€æœ‰è¡¨æƒ…åŒ…
                const allEmojis = await db.customEmojis.toArray();
                console.log('ğŸš¨ [URGENT] æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨æƒ…åŒ…:');

                allEmojis.forEach((emoji, index) => {
                    console.log(`${index + 1}. ID: ${emoji.id}`);
                    console.log(`   æè¿°: "${emoji.description}"`);
                    console.log(`   æ–‡ä»¶å: ${emoji.name}`);
                    console.log(`   ä¸Šä¼ æ—¶é—´: ${emoji.uploadTime}`);
                    console.log(`   isPersonal: ${emoji.isPersonal}`);
                    console.log(`   ---`);
                });

                // æ£€æŸ¥å…³è”è®°å½•
                const allItems = await db.emojiLibraryItems.toArray();
                console.log('ğŸš¨ [URGENT] æ‰€æœ‰å…³è”è®°å½•:');
                allItems.forEach(item => {
                    console.log(`  åº“: ${item.libraryId} -> è¡¨æƒ…åŒ…: ${item.emojiId}`);
                });

                // æ£€æŸ¥æ˜¯å¦æœ‰è¡¨æƒ…åŒ…è¢«é”™è¯¯æ ‡è®°ä¸ºä¸ªäººè¡¨æƒ…åŒ…
                const recentEmojis = allEmojis.filter(emoji => {
                    const uploadTime = new Date(emoji.uploadTime);
                    const now = new Date();
                    const hoursDiff = (now - uploadTime) / (1000 * 60 * 60);
                    return hoursDiff < 24; // æœ€è¿‘24å°æ—¶ä¸Šä¼ çš„
                });

                console.log('ğŸš¨ [URGENT] æœ€è¿‘24å°æ—¶ä¸Šä¼ çš„è¡¨æƒ…åŒ…:', recentEmojis.length, 'ä¸ª');
                recentEmojis.forEach(emoji => {
                    console.log(`  æœ€è¿‘: "${emoji.description}" isPersonal: ${emoji.isPersonal}`);
                });

                return {
                    allEmojis: allEmojis,
                    recentEmojis: recentEmojis,
                    associations: allItems
                };

            } catch (error) {
                console.error('ğŸš¨ [URGENT] æ£€æŸ¥å¤±è´¥:', error);
                return { error: error.message };
            }
        }

        // ğŸš¨ã€æ•°æ®ä¸¢å¤±è¯Šæ–­ã€‘æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨çŠ¶æ€
        async function diagnoseBrowserStorage() {
            console.log('ğŸš¨ [DIAGNOSE] å¼€å§‹è¯Šæ–­æµè§ˆå™¨å­˜å‚¨çŠ¶æ€...');

            try {
                // æ£€æŸ¥å­˜å‚¨é…é¢
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    console.log('ğŸš¨ [DIAGNOSE] æµè§ˆå™¨å­˜å‚¨çŠ¶æ€:', {
                        å·²ä½¿ç”¨: Math.round(estimate.usage / 1024 / 1024) + 'MB',
                        æ€»é…é¢: Math.round(estimate.quota / 1024 / 1024) + 'MB',
                        ä½¿ç”¨ç‡: Math.round(estimate.usage / estimate.quota * 100) + '%'
                    });
                }

                // æ£€æŸ¥IndexedDBæ•°æ®åº“å¤§å°
                const allEmojis = await db.customEmojis.toArray();
                const totalSize = allEmojis.reduce((size, emoji) => {
                    return size + (emoji.url ? emoji.url.length : 0);
                }, 0);

                console.log('ğŸš¨ [DIAGNOSE] IndexedDBè¡¨æƒ…åŒ…æ•°æ®:', {
                    è¡¨æƒ…åŒ…æ•°é‡: allEmojis.length,
                    ä¼°è®¡å¤§å°: Math.round(totalSize / 1024 / 1024) + 'MB'
                });

                // æ£€æŸ¥æ˜¯å¦æœ‰æµè§ˆå™¨æ¸…ç†çš„è¿¹è±¡
                const oldestEmoji = allEmojis.reduce((oldest, emoji) => {
                    const emojiTime = new Date(emoji.uploadTime);
                    const oldestTime = new Date(oldest.uploadTime);
                    return emojiTime < oldestTime ? emoji : oldest;
                }, allEmojis[0]);

                if (oldestEmoji) {
                    const oldestTime = new Date(oldestEmoji.uploadTime);
                    const hoursSinceOldest = (new Date() - oldestTime) / (1000 * 60 * 60);
                    console.log('ğŸš¨ [DIAGNOSE] æœ€è€çš„è¡¨æƒ…åŒ…:', {
                        æè¿°: oldestEmoji.description,
                        ä¸Šä¼ æ—¶é—´: oldestEmoji.uploadTime,
                        è·ä»Šå°æ—¶æ•°: Math.round(hoursSinceOldest)
                    });
                }

                return {
                    allEmojis: allEmojis,
                    totalSize: totalSize
                };

            } catch (error) {
                console.error('ğŸš¨ [DIAGNOSE] è¯Šæ–­å¤±è´¥:', error);
                return { error: error.message };
            }
        }

        // ğŸš¨ã€ç´§æ€¥æ¢å¤ã€‘é‡æ–°ä¸Šä¼ ä¸¢å¤±çš„è¡¨æƒ…åŒ…
        function showEmojiRecoveryInstructions() {
            console.log('ğŸš¨ [RECOVERY] è¡¨æƒ…åŒ…æ•°æ®å®Œå…¨ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ');

            const instructions = `
ğŸš¨ è¡¨æƒ…åŒ…æ•°æ®ä¸¢å¤±æ¢å¤æŒ‡å—ï¼š

1. ä½ çš„è¡¨æƒ…åŒ…æ•°æ®å·²ç»å®Œå…¨ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ 
2. ä¸ºäº†é¿å…å†æ¬¡ä¸¢å¤±ï¼Œå»ºè®®ï¼š

   ğŸ“± æ‰‹æœºç«¯æ“ä½œï¼š
   - é‡æ–°åˆ›å»ºè¡¨æƒ…åŒ…åº“
   - é‡æ–°ä¸Šä¼ è¡¨æƒ…åŒ…
   - ä¸Šä¼ åç«‹å³æµ‹è¯•AIæ˜¯å¦èƒ½ä½¿ç”¨

   ğŸ’¾ æ•°æ®å¤‡ä»½ï¼š
   - ä¸Šä¼ å®Œæˆåï¼Œå¯¼å‡ºè¡¨æƒ…åŒ…åº“ä½œä¸ºå¤‡ä»½
   - å®šæœŸæ£€æŸ¥è¡¨æƒ…åŒ…åº“çŠ¶æ€

   ğŸ”§ é¢„é˜²æªæ–½ï¼š
   - é¿å…åœ¨ä¸Šä¼ è¿‡ç¨‹ä¸­åˆ·æ–°é¡µé¢
   - ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š
   - ä¸€æ¬¡ä¸è¦ä¸Šä¼ å¤ªå¤šè¡¨æƒ…åŒ…

3. å¦‚æœé—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ï¼š
   - æµè§ˆå™¨å­˜å‚¨è®¾ç½®
   - æ˜¯å¦æœ‰è‡ªåŠ¨æ¸…ç†æ•°æ®çš„æ‰©å±•
   - è®¾å¤‡å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶³
            `;

            console.log(instructions);
            showToast('è¯·æŸ¥çœ‹æ§åˆ¶å°çš„æ¢å¤æŒ‡å—', 'info');

            return instructions;
        }

        // ğŸ”¥ã€ç´§æ€¥ä¿®å¤ã€‘æ‰‹åŠ¨æ¢å¤è¡¨æƒ…åŒ…åº“å…³è”
        async function manualRecoverEmojis(libraryName) {
            console.log('ğŸš¨ [MANUAL] æ‰‹åŠ¨æ¢å¤è¡¨æƒ…åŒ…åº“:', libraryName);

            try {
                // æ‰¾åˆ°ç›®æ ‡åº“
                const targetLibrary = emojiLibraries.find(lib => lib.name === libraryName);
                if (!targetLibrary) {
                    console.error('ğŸš¨ [MANUAL] æ‰¾ä¸åˆ°åº“:', libraryName);
                    return;
                }

                // è·å–æ‰€æœ‰æ²¡æœ‰å…³è”è®°å½•çš„åº“è¡¨æƒ…åŒ…
                const allLibraryEmojis = await db.customEmojis.where('isPersonal').equals(false).toArray();
                const existingItems = await db.emojiLibraryItems.toArray();

                const orphanedEmojis = allLibraryEmojis.filter(emoji =>
                    !existingItems.some(item => item.emojiId === emoji.id)
                );

                console.log('ğŸš¨ [MANUAL] æ‰¾åˆ°å­¤ç«‹è¡¨æƒ…åŒ…:', orphanedEmojis.length, 'ä¸ª');
                orphanedEmojis.forEach(emoji => {
                    console.log(`  - "${emoji.description}" (${emoji.id})`);
                });

                // å°†æ‰€æœ‰å­¤ç«‹çš„è¡¨æƒ…åŒ…å…³è”åˆ°ç›®æ ‡åº“
                const newAssociations = orphanedEmojis.map(emoji => ({
                    libraryId: targetLibrary.id,
                    emojiId: emoji.id,
                    addedAt: emoji.uploadTime || new Date().toISOString()
                }));

                if (newAssociations.length > 0) {
                    await db.emojiLibraryItems.bulkAdd(newAssociations);
                    console.log('ğŸš¨ [MANUAL] æ¢å¤äº†', newAssociations.length, 'ä¸ªå…³è”è®°å½•åˆ°åº“:', libraryName);

                    // é‡æ–°åŠ è½½ç»Ÿè®¡
                    await loadEmojiLibraries();
                    showToast(`æˆåŠŸæ¢å¤ ${newAssociations.length} ä¸ªè¡¨æƒ…åŒ…åˆ° ${libraryName}`, 'success');
                } else {
                    showToast('æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¢å¤çš„è¡¨æƒ…åŒ…', 'info');
                }

            } catch (error) {
                console.error('ğŸš¨ [MANUAL] æ‰‹åŠ¨æ¢å¤å¤±è´¥:', error);
                showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿®å¤å·¥å…·ï¼šæ¢å¤ä¸¢å¤±çš„è¡¨æƒ…åŒ…åº“å…³è”è®°å½•
        async function recoverEmojiLibraryAssociations() {
            console.log('ğŸ”§ [RECOVER] å¼€å§‹æ¢å¤è¡¨æƒ…åŒ…åº“å…³è”è®°å½•...');

            try {
                // è·å–æ‰€æœ‰è¡¨æƒ…åŒ…åº“
                const libraries = await db.emojiLibraries.toArray();
                console.log('ğŸ”§ [RECOVER] æ‰¾åˆ°è¡¨æƒ…åŒ…åº“:', libraries.length, 'ä¸ª');

                // è·å–æ‰€æœ‰åº“è¡¨æƒ…åŒ…ï¼ˆisPersonal === falseï¼‰
                const libraryEmojis = await db.customEmojis.where('isPersonal').equals(false).toArray();
                console.log('ğŸ”§ [RECOVER] æ‰¾åˆ°åº“è¡¨æƒ…åŒ…:', libraryEmojis.length, 'ä¸ª');
                console.log('ğŸ”§ [RECOVER] åº“è¡¨æƒ…åŒ…è¯¦æƒ…:', libraryEmojis.map(e => ({
                    id: e.id,
                    name: e.name,
                    description: e.description,
                    uploadTime: e.uploadTime
                })));

                // è·å–ç°æœ‰çš„å…³è”è®°å½•
                const existingItems = await db.emojiLibraryItems.toArray();
                console.log('ğŸ”§ [RECOVER] ç°æœ‰å…³è”è®°å½•:', existingItems.length, 'ä¸ª');

                // æ‰¾å‡ºæ²¡æœ‰å…³è”è®°å½•çš„åº“è¡¨æƒ…åŒ…
                const orphanedEmojis = libraryEmojis.filter(emoji =>
                    !existingItems.some(item => item.emojiId === emoji.id)
                );
                console.log('ğŸ”§ [RECOVER] å­¤ç«‹çš„åº“è¡¨æƒ…åŒ…:', orphanedEmojis.length, 'ä¸ª');

                if (orphanedEmojis.length > 0) {
                    console.log('ğŸ”§ [RECOVER] å­¤ç«‹è¡¨æƒ…åŒ…è¯¦æƒ…:', orphanedEmojis.map(e => ({
                        id: e.id,
                        name: e.name,
                        description: e.description,
                        uploadTime: e.uploadTime
                    })));

                    // æä¾›æ‰‹åŠ¨åˆ†é…é€‰é¡¹
                    const libraryOptions = libraries.map((lib, index) => `${index + 1}. ${lib.name}`).join('\n');
                    const choice = prompt(`å‘ç° ${orphanedEmojis.length} ä¸ªå­¤ç«‹çš„è¡¨æƒ…åŒ…éœ€è¦é‡æ–°åˆ†é…åˆ°è¡¨æƒ…åŒ…åº“ã€‚\n\nå¯ç”¨çš„è¡¨æƒ…åŒ…åº“ï¼š\n${libraryOptions}\n\nè¯·é€‰æ‹©è¦åˆ†é…åˆ°çš„åº“ï¼ˆè¾“å…¥æ•°å­—ï¼‰ï¼Œæˆ–è¾“å…¥ 'auto' è‡ªåŠ¨åˆ†é…ï¼š`);

                    if (choice === null) {
                        showToast('å–æ¶ˆæ¢å¤æ“ä½œ', 'info');
                        return;
                    }

                    const recoveredAssociations = [];

                    if (choice.toLowerCase() === 'auto') {
                        // è‡ªåŠ¨åˆ†é…ï¼šæ ¹æ®ä¸Šä¼ æ—¶é—´
                        for (const emoji of orphanedEmojis) {
                            const emojiTime = new Date(emoji.uploadTime).getTime();
                            let bestLibrary = null;
                            let minTimeDiff = Infinity;

                            for (const library of libraries) {
                                const libraryTime = new Date(library.createdAt).getTime();
                                const timeDiff = Math.abs(emojiTime - libraryTime);

                                if (timeDiff < minTimeDiff) {
                                    minTimeDiff = timeDiff;
                                    bestLibrary = library;
                                }
                            }

                            if (bestLibrary) {
                                recoveredAssociations.push({
                                    libraryId: bestLibrary.id,
                                    emojiId: emoji.id,
                                    addedAt: emoji.uploadTime || new Date().toISOString()
                                });

                                console.log(`ğŸ”§ [RECOVER] è‡ªåŠ¨åˆ†é…è¡¨æƒ…åŒ… "${emoji.description}" åˆ°åº“ "${bestLibrary.name}"`);
                            }
                        }
                    } else {
                        // æ‰‹åŠ¨åˆ†é…ï¼šæ‰€æœ‰è¡¨æƒ…åŒ…åˆ†é…åˆ°æŒ‡å®šåº“
                        const libraryIndex = parseInt(choice) - 1;
                        if (libraryIndex >= 0 && libraryIndex < libraries.length) {
                            const targetLibrary = libraries[libraryIndex];

                            for (const emoji of orphanedEmojis) {
                                recoveredAssociations.push({
                                    libraryId: targetLibrary.id,
                                    emojiId: emoji.id,
                                    addedAt: emoji.uploadTime || new Date().toISOString()
                                });

                                console.log(`ğŸ”§ [RECOVER] æ‰‹åŠ¨åˆ†é…è¡¨æƒ…åŒ… "${emoji.description}" åˆ°åº“ "${targetLibrary.name}"`);
                            }
                        } else {
                            showToast('æ— æ•ˆçš„åº“é€‰æ‹©', 'error');
                            return;
                        }
                    }

                    if (recoveredAssociations.length > 0) {
                        await db.emojiLibraryItems.bulkAdd(recoveredAssociations);
                        console.log('ğŸ”§ [RECOVER] æ¢å¤äº†', recoveredAssociations.length, 'ä¸ªå…³è”è®°å½•');

                        // é‡æ–°åŠ è½½åº“åˆ—è¡¨ä»¥æ›´æ–°ç»Ÿè®¡
                        await loadEmojiLibraries();

                        showToast(`æˆåŠŸæ¢å¤ ${recoveredAssociations.length} ä¸ªè¡¨æƒ…åŒ…çš„å…³è”è®°å½•`, 'success');
                    } else {
                        showToast('æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¢å¤çš„å…³è”è®°å½•', 'info');
                    }
                } else {
                    showToast('æ‰€æœ‰è¡¨æƒ…åŒ…éƒ½æœ‰æ­£ç¡®çš„å…³è”è®°å½•', 'success');
                }

            } catch (error) {
                console.error('ğŸ”§ [RECOVER] æ¢å¤å…³è”è®°å½•å¤±è´¥:', error);
                showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºè¡¨æƒ…åŒ…åº“è¡¨å•
        function showCreateLibraryForm() {
            document.getElementById('emoji-library-form-title').textContent = 'æ–°å»ºè¡¨æƒ…åŒ…åº“';
            document.getElementById('emoji-library-name-input').value = '';
            document.getElementById('emoji-library-description-input').value = '';
            document.getElementById('emoji-library-form-modal').style.display = 'flex';
            currentEmojiLibrary = null;
        }

        // ç¼–è¾‘è¡¨æƒ…åŒ…åº“
        function editEmojiLibrary(libraryId) {
            const library = emojiLibraries.find(lib => lib.id === libraryId);
            if (!library) return;

            document.getElementById('emoji-library-form-title').textContent = 'ç¼–è¾‘è¡¨æƒ…åŒ…åº“';
            document.getElementById('emoji-library-name-input').value = library.name;
            document.getElementById('emoji-library-description-input').value = library.description || '';
            document.getElementById('emoji-library-form-modal').style.display = 'flex';
            currentEmojiLibrary = library;
        }

        // éšè—è¡¨æƒ…åŒ…åº“è¡¨å•
        function hideEmojiLibraryForm(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('emoji-library-form-modal').style.display = 'none';
            currentEmojiLibrary = null;
        }

        // ä¿å­˜è¡¨æƒ…åŒ…åº“
        async function saveEmojiLibrary() {
            const name = document.getElementById('emoji-library-name-input').value.trim();
            const description = document.getElementById('emoji-library-description-input').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥åº“åç§°');
                return;
            }

            try {
                if (currentEmojiLibrary) {
                    // ç¼–è¾‘ç°æœ‰åº“
                    currentEmojiLibrary.name = name;
                    currentEmojiLibrary.description = description;
                    currentEmojiLibrary.updatedAt = new Date().toISOString();

                    await db.emojiLibraries.put(currentEmojiLibrary);
                } else {
                    // åˆ›å»ºæ–°åº“
                    const newLibrary = {
                        id: `library_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: name,
                        description: description,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    emojiLibraries.push(newLibrary);
                    await db.emojiLibraries.add(newLibrary);
                }

                hideEmojiLibraryForm();
                renderEmojiLibraryList();
                showToast(currentEmojiLibrary ? 'è¡¨æƒ…åŒ…åº“æ›´æ–°æˆåŠŸ' : 'è¡¨æƒ…åŒ…åº“åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('ä¿å­˜è¡¨æƒ…åŒ…åº“å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤è¡¨æƒ…åŒ…åº“
        async function deleteEmojiLibrary(libraryId) {
            const library = emojiLibraries.find(lib => lib.id === libraryId);
            if (!library) return;

            const count = await getEmojiLibraryItemCount(libraryId);
            const confirmMsg = count > 0
                ? `ç¡®å®šè¦åˆ é™¤è¡¨æƒ…åŒ…åº“"${library.name}"å—ï¼Ÿ\n\nè¿™ä¸ªåº“ä¸­æœ‰ ${count} ä¸ªè¡¨æƒ…åŒ…ï¼Œåˆ é™¤åè¡¨æƒ…åŒ…å°†å›åˆ°æœªåˆ†ç±»çŠ¶æ€ã€‚`
                : `ç¡®å®šè¦åˆ é™¤è¡¨æƒ…åŒ…åº“"${library.name}"å—ï¼Ÿ`;

            if (!confirm(confirmMsg)) return;

            try {
                // åˆ é™¤åº“ä¸­çš„æ‰€æœ‰å…³è”è®°å½•
                await db.emojiLibraryItems.where('libraryId').equals(libraryId).delete();

                // åˆ é™¤åº“æœ¬èº«
                await db.emojiLibraries.delete(libraryId);

                // ä»å†…å­˜ä¸­ç§»é™¤
                emojiLibraries = emojiLibraries.filter(lib => lib.id !== libraryId);

                renderEmojiLibraryList();
                showToast('è¡¨æƒ…åŒ…åº“åˆ é™¤æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åˆ é™¤è¡¨æƒ…åŒ…åº“å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ‰“å¼€è¡¨æƒ…åŒ…åº“è¯¦æƒ…é¡µé¢
        async function openEmojiLibrary(libraryId) {
            const library = emojiLibraries.find(lib => lib.id === libraryId);
            if (!library) return;

            currentEmojiLibrary = library;

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.getElementById('emoji-library-title').textContent = library.name;

            // æ˜¾ç¤ºé¡µé¢
            showApp('emoji-library-screen');

            // åŠ è½½è¡¨æƒ…åŒ…åº“å†…å®¹
            await loadEmojiLibraryContent(libraryId);
        }

        // åŠ è½½è¡¨æƒ…åŒ…åº“å†…å®¹
        async function loadEmojiLibraryContent(libraryId) {
            try {
                // è·å–åº“ä¸­çš„è¡¨æƒ…åŒ…å…³è”è®°å½•
                const libraryItems = await db.emojiLibraryItems.where('libraryId').equals(libraryId).toArray();

                // è·å–å¯¹åº”çš„è¡¨æƒ…åŒ…æ•°æ® - ä»æ•°æ®åº“ä¸­ç›´æ¥æŸ¥æ‰¾
                const emojiIds = libraryItems.map(item => item.emojiId);
                const allEmojis = await db.customEmojis.where('id').anyOf(emojiIds).toArray();

                // æ¸²æŸ“è¡¨æƒ…åŒ…ç½‘æ ¼
                renderEmojiLibraryGrid(allEmojis);

            } catch (error) {
                console.error('åŠ è½½è¡¨æƒ…åŒ…åº“å†…å®¹å¤±è´¥:', error);
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è¡¨æƒ…åŒ…åº“ç½‘æ ¼
        function renderEmojiLibraryGrid(emojis) {
            const grid = document.getElementById('emoji-library-grid');
            const emptyState = document.getElementById('emoji-library-empty');
            const statsContainer = document.getElementById('emoji-library-stats');

            if (emojis.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                statsContainer.style.display = 'none';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            statsContainer.style.display = 'flex';

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const totalEmojis = emojis.length;
            const describedEmojis = emojis.filter(emoji =>
                emoji.description && emoji.description !== emoji.name && emoji.description.trim() !== ''
            ).length;
            const undescribedEmojis = totalEmojis - describedEmojis;

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('total-emojis').textContent = totalEmojis;
            document.getElementById('described-emojis').textContent = describedEmojis;
            document.getElementById('undescribed-emojis').textContent = undescribedEmojis;

            const undescribedWarning = document.getElementById('undescribed-warning');
            if (undescribedEmojis > 0) {
                undescribedWarning.style.display = 'block';
            } else {
                undescribedWarning.style.display = 'none';
            }

            grid.innerHTML = emojis.map(emoji => {
                const hasDescription = emoji.description && emoji.description !== emoji.name && emoji.description.trim() !== '';
                const displayDescription = hasDescription ? emoji.description : 'ç‚¹å‡»æ·»åŠ æè¿°';

                return `
                    <div class="emoji-library-grid-item" data-emoji-id="${emoji.id}">
                        <div class="emoji-image-container">
                            <input type="checkbox" class="emoji-checkbox" data-emoji-id="${emoji.id}" style="display: none;">
                            <img src="${emoji.url}" alt="${emoji.description}" title="${emoji.description}">
                            <button class="remove-btn" onclick="removeEmojiFromLibrary('${emoji.id}')" title="ä»åº“ä¸­ç§»é™¤">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="emoji-description-area ${!hasDescription ? 'no-description' : ''}"
                             onclick="editEmojiDescription('${emoji.id}')"
                             title="ç‚¹å‡»ç¼–è¾‘æè¿°">
                            <div class="emoji-description-text">${displayDescription}</div>
                            <div class="emoji-description-hint">
                                ${!hasDescription ? 'âš ï¸ æœªè®¾ç½®æè¿°' : 'âœ“ å·²è®¾ç½®æè¿°'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ä»è¡¨æƒ…åŒ…åº“ä¸­ç§»é™¤è¡¨æƒ…åŒ…
        async function removeEmojiFromLibrary(emojiId) {
            if (!currentEmojiLibrary) return;

            if (!confirm('ç¡®å®šè¦ä»è¿™ä¸ªè¡¨æƒ…åŒ…åº“ä¸­ç§»é™¤è¿™ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ\n\nè¡¨æƒ…åŒ…æœ¬èº«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯ä»å½“å‰åº“ä¸­ç§»é™¤ã€‚')) {
                return;
            }

            try {
                await db.emojiLibraryItems
                    .where('[libraryId+emojiId]')
                    .equals([currentEmojiLibrary.id, emojiId])
                    .delete();

                // é‡æ–°åŠ è½½åº“å†…å®¹
                await loadEmojiLibraryContent(currentEmojiLibrary.id);
                showToast('ç§»é™¤æˆåŠŸ', 'success');

            } catch (error) {
                console.error('ç§»é™¤è¡¨æƒ…åŒ…å¤±è´¥:', error);
                showToast('ç§»é™¤å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘è¡¨æƒ…åŒ…æè¿°
        async function editEmojiDescription(emojiId) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾è¡¨æƒ…åŒ…ï¼ˆå› ä¸ºåº“è¡¨æƒ…åŒ…ä¸åœ¨å†…å­˜ä¸­ï¼‰
            const emoji = await db.customEmojis.get(emojiId);
            if (!emoji) return;

            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
            const existingModal = document.getElementById('emoji-description-modal');
            if (existingModal) {
                existingModal.remove();
            }

            const currentDescription = emoji.description && emoji.description !== emoji.name ? emoji.description : '';

            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'emoji-description-modal';
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘è¡¨æƒ…åŒ…æè¿°</h3>
                        <button class="modal-close-btn" onclick="closeEmojiDescriptionModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="emoji-preview" style="text-align: center; margin-bottom: 15px;">
                            <img src="${emoji.url}" alt="è¡¨æƒ…åŒ…é¢„è§ˆ" style="max-width: 80px; max-height: 80px; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¡¨æƒ…åŒ…æè¿°</label>
                            <textarea id="emoji-description-input" class="form-textarea"
                                      placeholder="è¯·æè¿°è¿™ä¸ªè¡¨æƒ…åŒ…çš„å«ä¹‰ã€æƒ…ç»ªæˆ–ä½¿ç”¨åœºæ™¯ï¼Œå¸®åŠ©AIç†è§£ä½•æ—¶ä½¿ç”¨..."
                                      rows="3" maxlength="100">${currentDescription}</textarea>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn cancel-btn" onclick="closeEmojiDescriptionModal()">å–æ¶ˆ</button>
                        <button class="modal-btn confirm-btn" onclick="saveEmojiDescription('${emojiId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            setTimeout(() => {
                const textarea = document.getElementById('emoji-description-input');
                if (textarea) {
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }
            }, 100);
        }

        // å…³é—­è¡¨æƒ…åŒ…æè¿°ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEmojiDescriptionModal() {
            const modal = document.getElementById('emoji-description-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ä¿å­˜è¡¨æƒ…åŒ…æè¿°
        async function saveEmojiDescription(emojiId) {
            const descriptionInput = document.getElementById('emoji-description-input');
            if (!descriptionInput) {
                console.error('æ‰¾ä¸åˆ°æè¿°è¾“å…¥æ¡†');
                showToast('ä¿å­˜å¤±è´¥ï¼šæ‰¾ä¸åˆ°è¾“å…¥æ¡†', 'error');
                return;
            }

            const description = descriptionInput.value.trim();

            if (!description) {
                alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…æè¿°');
                return;
            }

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»æ•°æ®åº“ä¸­è·å–è¡¨æƒ…åŒ…å¹¶æ›´æ–°
                const emoji = await db.customEmojis.get(emojiId);
                if (emoji) {
                    emoji.description = description;

                    // å¦‚æœæ˜¯ä¸ªäººè¡¨æƒ…åŒ…ï¼Œä¹Ÿæ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                    if (emoji.isPersonal !== false) {
                        const memoryEmoji = customEmojis.find(e => e.id === emojiId);
                        if (memoryEmoji) {
                            memoryEmoji.description = description;
                        }
                    }

                    // æ›´æ–°æ•°æ®åº“
                    await db.customEmojis.put(emoji);

                    // é‡æ–°åŠ è½½åº“å†…å®¹ä»¥æ›´æ–°æ˜¾ç¤º
                    if (currentEmojiLibrary) {
                        await loadEmojiLibraryContent(currentEmojiLibrary.id);
                    }

                    showToast('æè¿°ä¿å­˜æˆåŠŸ', 'success');

                    // å…³é—­æ¨¡æ€æ¡†
                    closeEmojiDescriptionModal();
                } else {
                    showToast('æ‰¾ä¸åˆ°å¯¹åº”çš„è¡¨æƒ…åŒ…', 'error');
                }

            } catch (error) {
                console.error('ä¿å­˜è¡¨æƒ…åŒ…æè¿°å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // éšè—è¡¨æƒ…åŒ…åº“è¯¦æƒ…é¡µé¢
        function hideEmojiLibraryScreen() {
            hideApp('emoji-library-screen');
            currentEmojiLibrary = null;
            // è¿”å›åˆ°chatappçš„"æˆ‘"æ ‡ç­¾é¡µ
            showApp('chat-screen');
            switchChatTab('profile-page');
        }



        // è§¦å‘è¡¨æƒ…åŒ…ä¸Šä¼ 
        function triggerEmojiUpload() {
            document.getElementById('emoji-library-upload').click();
        }

        // åˆ é™¤å½“å‰è¡¨æƒ…åŒ…åº“
        async function deleteCurrentEmojiLibrary() {
            if (!currentEmojiLibrary) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤è¡¨æƒ…åŒ…åº“"${currentEmojiLibrary.name}"å—ï¼Ÿ\n\nåˆ é™¤åæ— æ³•æ¢å¤ï¼Œä½†è¡¨æƒ…åŒ…æœ¬èº«ä¸ä¼šè¢«åˆ é™¤ã€‚`)) {
                try {
                    // åˆ é™¤åº“ä¸­çš„æ‰€æœ‰å…³è”é¡¹
                    await db.emojiLibraryItems.where('libraryId').equals(currentEmojiLibrary.id).delete();

                    // åˆ é™¤åº“æœ¬èº«
                    await db.emojiLibraries.delete(currentEmojiLibrary.id);

                    showToast('è¡¨æƒ…åŒ…åº“å·²åˆ é™¤', 'success');

                    // è¿”å›åˆ°è¡¨æƒ…åŒ…åº“åˆ—è¡¨
                    showEmojiLibraryList();

                } catch (error) {
                    console.error('åˆ é™¤è¡¨æƒ…åŒ…åº“å¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            }
        }

        // åˆå§‹åŒ–è¡¨æƒ…åŒ…åº“ä¸Šä¼ åŠŸèƒ½
        function initEmojiLibraryUpload() {
            const uploadInput = document.getElementById('emoji-library-upload');
            const uploadArea = document.getElementById('emoji-library-upload-area');

            if (uploadInput) {
                uploadInput.addEventListener('change', handleEmojiLibraryUpload);
            }

            if (uploadArea) {
                // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');

                    const files = Array.from(e.dataTransfer.files).filter(file =>
                        file.type.startsWith('image/')
                    );

                    if (files.length > 0) {
                        processEmojiFiles(files);
                    }
                });
            }
        }

        // å¤„ç†è¡¨æƒ…åŒ…åº“æ–‡ä»¶ä¸Šä¼ 
        async function handleEmojiLibraryUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            await processEmojiFiles(files);

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // å¤„ç†è¡¨æƒ…åŒ…æ–‡ä»¶
        async function processEmojiFiles(files) {
            if (!currentEmojiLibrary) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…åº“', 'error');
                return;
            }

            const validFiles = files.filter(file => file.type.startsWith('image/'));
            if (validFiles.length === 0) {
                showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const file of validFiles) {
                try {
                    await uploadEmojiToLibrary(file);
                    successCount++;
                } catch (error) {
                    console.error('ä¸Šä¼ è¡¨æƒ…åŒ…å¤±è´¥:', error);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showToast(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªè¡¨æƒ…åŒ…`, 'success');
                // é‡æ–°åŠ è½½åº“å†…å®¹
                await loadEmojiLibraryContent(currentEmojiLibrary.id);
            }

            if (errorCount > 0) {
                showToast(`${errorCount} ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥`, 'error');
            }
        }

        // ä¸Šä¼ è¡¨æƒ…åŒ…åˆ°åº“
        async function uploadEmojiToLibrary(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const imageUrl = e.target.result;

                        // åˆ›å»ºæ–°çš„è¡¨æƒ…åŒ…
                        const newEmoji = {
                            id: `emoji_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: file.name.split('.')[0],
                            description: '', // åˆå§‹ä¸ºç©ºï¼Œç”¨æˆ·ç¨åæ·»åŠ æè¿°
                            url: imageUrl,
                            category: 'custom',
                            uploadTime: new Date().toISOString(),
                            isPersonal: false // æ ‡è¯†ä¸ºåº“è¡¨æƒ…åŒ…ï¼Œä¸æ˜¯ä¸ªäººè¡¨æƒ…åŒ…
                        };

                        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘åº“è¡¨æƒ…åŒ…åªå­˜å‚¨åˆ°æ•°æ®åº“ï¼Œä¸æ·»åŠ åˆ°ä»»ä½•å†…å­˜æ•°ç»„
                        // å› ä¸ºåº“è¡¨æƒ…åŒ…ä¸åº”è¯¥å‡ºç°åœ¨ç”¨æˆ·çš„è¡¨æƒ…åŒ…é€‰æ‹©å™¨ä¸­
                        await db.customEmojis.add(newEmoji);

                        // æ·»åŠ åˆ°å½“å‰è¡¨æƒ…åŒ…åº“
                        const libraryItem = {
                            libraryId: currentEmojiLibrary.id,
                            emojiId: newEmoji.id,
                            addedAt: new Date().toISOString()
                        };

                        await db.emojiLibraryItems.add(libraryItem);

                        resolve(newEmoji);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }



        // ===== è¡¨æƒ…åŒ…åº“æŒ‚è½½åŠŸèƒ½ =====

        // æ˜¾ç¤ºè¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®
        function showEmojiLibraryMountSettings() {
            console.log('showEmojiLibraryMountSettings called');
            if (!currentChatCharacter) {
                console.log('No current chat character');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            console.log('Chat settings:', chatSettings);

            // è®¾ç½®å¼€å…³çŠ¶æ€
            document.getElementById('emoji-library-mount-enabled').checked = chatSettings.emojiLibraryMountEnabled || false;

            // æ¸²æŸ“è¡¨æƒ…åŒ…åº“åˆ—è¡¨
            renderEmojiLibraryMountList();

            // æ˜¾ç¤º/éšè—è¯¦ç»†è®¾ç½®
            toggleEmojiLibraryMountDetails();

            console.log('About to show modal');
            showModal('emoji-library-mount-modal');
            console.log('Modal should be shown');
        }

        // åˆ‡æ¢è¡¨æƒ…åŒ…åº“æŒ‚è½½è¯¦ç»†è®¾ç½®æ˜¾ç¤º
        function toggleEmojiLibraryMountDetails() {
            const enabled = document.getElementById('emoji-library-mount-enabled').checked;
            document.getElementById('emoji-library-mount-details').style.display = enabled ? 'block' : 'none';

            // æ›´æ–°ä¸»è®¾ç½®ç•Œé¢æ˜¾ç¤º
            updateEmojiLibraryMountDisplay();
        }

        // æ¸²æŸ“è¡¨æƒ…åŒ…åº“æŒ‚è½½åˆ—è¡¨
        function renderEmojiLibraryMountList() {
            const container = document.getElementById('emoji-library-mount-list');
            if (!container) return;

            if (emojiLibraries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…åº“</p>
                        <p>è¯·å…ˆåœ¨"æˆ‘"é¡µé¢åˆ›å»ºè¡¨æƒ…åŒ…åº“</p>
                    </div>
                `;
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const selectedLibraries = chatSettings.selectedEmojiLibraries || [];

            container.innerHTML = emojiLibraries.map(library => `
                <label class="checkbox-item">
                    <input type="checkbox"
                           value="${library.id}"
                           ${selectedLibraries.includes(library.id) ? 'checked' : ''}
                           onchange="updateEmojiLibraryMountDisplay()">
                    <span class="checkbox-label">
                        <div class="library-name">${library.name}</div>
                        <div class="library-desc">${library.description || 'æ— æè¿°'}</div>
                    </span>
                </label>
            `).join('');
        }

        // æ›´æ–°è¡¨æƒ…åŒ…åº“æŒ‚è½½æ˜¾ç¤ºçŠ¶æ€
        function updateEmojiLibraryMountDisplay() {
            const statusElement = document.getElementById('current-emoji-library-mount');
            if (!statusElement) return;

            const chatSettings = getCurrentChatSettings();
            const enabled = chatSettings.emojiLibraryMountEnabled || false;
            const selectedLibraries = chatSettings.selectedEmojiLibraries || [];

            if (!enabled) {
                statusElement.textContent = 'æœªå¯ç”¨';
                statusElement.style.color = '#999';
                return;
            }

            if (selectedLibraries.length === 0) {
                statusElement.textContent = 'å·²å¯ç”¨ï¼Œæœªé€‰æ‹©åº“';
                statusElement.style.color = '#ff9500';
                return;
            }

            const libraryNames = selectedLibraries.map(id => {
                const library = emojiLibraries.find(lib => lib.id === id);
                return library ? library.name : 'æœªçŸ¥åº“';
            });

            if (libraryNames.length === 1) {
                statusElement.textContent = libraryNames[0];
            } else {
                statusElement.textContent = `${libraryNames.length}ä¸ªåº“`;
            }
            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤å¼ºåˆ¶è“è‰²ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²ä¸å…¶ä»–è®¾ç½®é¡¹ä¿æŒä¸€è‡´
            statusElement.style.color = '';
        }

        // ä¿å­˜è¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®
        async function saveEmojiLibraryMountSettings() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();

            // ä¿å­˜å¼€å…³çŠ¶æ€
            chatSettings.emojiLibraryMountEnabled = document.getElementById('emoji-library-mount-enabled').checked;

            // ä¿å­˜é€‰ä¸­çš„è¡¨æƒ…åŒ…åº“
            const checkboxes = document.querySelectorAll('#emoji-library-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedEmojiLibraries = Array.from(checkboxes).map(cb => cb.value);

            await saveCurrentChatSettings(chatSettings);
            updateEmojiLibraryMountDisplay();
            hideModal('emoji-library-mount-modal');

            const selectedCount = chatSettings.selectedEmojiLibraries ? chatSettings.selectedEmojiLibraries.length : 0;
            if (chatSettings.emojiLibraryMountEnabled && selectedCount > 0) {
                showToast(`è¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®å·²ä¿å­˜ï¼Œå·²æŒ‚è½½ ${selectedCount} ä¸ªåº“`, 'success');

                // é‡æ–°åŠ è½½è¡¨æƒ…åŒ…é¢æ¿ä»¥åº”ç”¨æ–°è®¾ç½®
                if (document.getElementById('custom-emoji-panel').style.display !== 'none') {
                    loadCustomEmojis();
                }
            } else if (chatSettings.emojiLibraryMountEnabled) {
                showToast('è¡¨æƒ…åŒ…åº“æŒ‚è½½å·²å¯ç”¨ï¼Œä½†æœªé€‰æ‹©ä»»ä½•åº“', 'info');
            } else {
                showToast('è¡¨æƒ…åŒ…åº“æŒ‚è½½å·²å…³é—­', 'info');
            }
        }

        // æ ¹æ®è¡¨æƒ…åŒ…åº“æŒ‚è½½è®¾ç½®è¿‡æ»¤è¡¨æƒ…åŒ…
        async function getFilteredEmojis(emojis) {
            // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘èŠå¤©ç•Œé¢çš„è¡¨æƒ…åŒ…é€‰æ‹©å™¨åªæ˜¾ç¤ºç”¨æˆ·ä¸ªäººè¡¨æƒ…åŒ…
            // è¡¨æƒ…åŒ…åº“ä¸­çš„è¡¨æƒ…åŒ…æ°¸è¿œä¸åº”è¯¥å‡ºç°åœ¨ç”¨æˆ·çš„è¡¨æƒ…åŒ…é€‰æ‹©å™¨ä¸­
            // è¡¨æƒ…åŒ…åº“æ˜¯ç»™AIè§’è‰²ç”¨çš„ï¼Œä¸æ˜¯ç»™ç”¨æˆ·ç”¨çš„
            return emojis.filter(emoji => emoji.isPersonal !== false);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†è¡¨æƒ…åŒ…åº“ä¸­çš„æ— æ•ˆå…³è”è®°å½•
        async function cleanupEmojiLibraryItems() {
            try {
                console.log('ğŸ§¹ [cleanupEmojiLibraryItems] å¼€å§‹æ¸…ç†æ— æ•ˆçš„è¡¨æƒ…åŒ…åº“å…³è”è®°å½•');

                // è·å–æ‰€æœ‰å…³è”è®°å½•
                const allItems = await db.emojiLibraryItems.toArray();
                console.log('ğŸ§¹ [cleanupEmojiLibraryItems] æ€»å…³è”è®°å½•æ•°:', allItems.length);

                // æ£€æŸ¥æ¯ä¸ªå…³è”è®°å½•å¯¹åº”çš„è¡¨æƒ…åŒ…æ˜¯å¦å­˜åœ¨
                const invalidItems = [];
                for (const item of allItems) {
                    const emoji = await db.customEmojis.get(item.emojiId);
                    if (!emoji) {
                        invalidItems.push(item);
                    }
                }

                console.log('ğŸ§¹ [cleanupEmojiLibraryItems] å‘ç°æ— æ•ˆå…³è”è®°å½•æ•°:', invalidItems.length);

                // åˆ é™¤æ— æ•ˆçš„å…³è”è®°å½•
                if (invalidItems.length > 0) {
                    const invalidIds = invalidItems.map(item => item.id);
                    await db.emojiLibraryItems.bulkDelete(invalidIds);
                    console.log('ğŸ§¹ [cleanupEmojiLibraryItems] å·²æ¸…ç†æ— æ•ˆå…³è”è®°å½•:', invalidIds);
                }

                return invalidItems.length;
            } catch (error) {
                console.error('ğŸ§¹ [cleanupEmojiLibraryItems] æ¸…ç†å¤±è´¥:', error);
                return 0;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“ä¸­çš„æ‰€æœ‰è¡¨æƒ…åŒ…
        async function getMountedEmojiLibraryEmojis() {
            try {
                const chatSettings = getCurrentChatSettings();

                // å¦‚æœæ²¡æœ‰å¯ç”¨è¡¨æƒ…åŒ…åº“æŒ‚è½½æˆ–æ²¡æœ‰é€‰ä¸­çš„åº“ï¼Œè¿”å›ä¸ªäººè¡¨æƒ…åŒ…
                if (!chatSettings.emojiLibraryMountEnabled || !chatSettings.selectedEmojiLibraries || chatSettings.selectedEmojiLibraries.length === 0) {
                    return customEmojis;
                }

                // å…ˆæ¸…ç†æ— æ•ˆçš„å…³è”è®°å½•
                await cleanupEmojiLibraryItems();

                const allMountedEmojis = [];

                // ä»æ‰€æœ‰æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“ä¸­è·å–è¡¨æƒ…åŒ…
                for (const libraryId of chatSettings.selectedEmojiLibraries) {
                    const libraryItems = await db.emojiLibraryItems.where('libraryId').equals(libraryId).toArray();
                    const emojiIds = libraryItems.map(item => item.emojiId);
                    const libraryEmojis = await db.customEmojis.where('id').anyOf(emojiIds).toArray();
                    allMountedEmojis.push(...libraryEmojis);
                }



                return allMountedEmojis;
            } catch (error) {
                console.error('è·å–æŒ‚è½½è¡¨æƒ…åŒ…æ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶å›é€€åˆ°ä¸ªäººè¡¨æƒ…åŒ…
                return customEmojis;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘AIæŸ¥æ‰¾è¡¨æƒ…åŒ…çš„å‡½æ•° - ä»æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“ä¸­æŸ¥æ‰¾
        async function findEmojiForAI(description) {
            try {


                // è·å–å½“å‰èŠå¤©çš„è®¾ç½®
                const chatSettings = getCurrentChatSettings();

                // å¦‚æœå¯ç”¨äº†è¡¨æƒ…åŒ…åº“æŒ‚è½½ä¸”æœ‰é€‰ä¸­çš„åº“
                if (chatSettings.emojiLibraryMountEnabled && chatSettings.selectedEmojiLibraries && chatSettings.selectedEmojiLibraries.length > 0) {
                    // ä»æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“ä¸­æŸ¥æ‰¾
                    for (const libraryId of chatSettings.selectedEmojiLibraries) {
                        // è·å–åº“ä¸­çš„è¡¨æƒ…åŒ…å…³è”è®°å½•
                        const libraryItems = await db.emojiLibraryItems.where('libraryId').equals(libraryId).toArray();

                        // è·å–å¯¹åº”çš„è¡¨æƒ…åŒ…æ•°æ®
                        const emojiIds = libraryItems.map(item => item.emojiId);

                        const libraryEmojis = await db.customEmojis.where('id').anyOf(emojiIds).toArray();

                        // å…ˆå°è¯•ä¸¥æ ¼åŒ¹é…
                        let matchingEmoji = libraryEmojis.find(emoji => emoji.description === description);

                        // å¦‚æœä¸¥æ ¼åŒ¹é…å¤±è´¥ï¼Œå°è¯•trimååŒ¹é…
                        if (!matchingEmoji) {
                            matchingEmoji = libraryEmojis.find(emoji => emoji.description?.trim() === description?.trim());
                        }

                        // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•å¿½ç•¥å¤§å°å†™åŒ¹é…
                        if (!matchingEmoji) {
                            matchingEmoji = libraryEmojis.find(emoji =>
                                emoji.description?.toLowerCase().trim() === description?.toLowerCase().trim()
                            );
                        }

                        if (matchingEmoji) {
                            return matchingEmoji;
                        }
                    }

                    return null;
                } else {
                    // å¦‚æœæ²¡æœ‰æŒ‚è½½è¡¨æƒ…åŒ…åº“ï¼Œä»ä¸ªäººè¡¨æƒ…åŒ…ä¸­æŸ¥æ‰¾
                    return customEmojis.find(emoji => emoji.description === description);
                }
            } catch (error) {
                console.error('æŸ¥æ‰¾è¡¨æƒ…åŒ…æ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶å›é€€åˆ°ä¸ªäººè¡¨æƒ…åŒ…
                return customEmojis.find(emoji => emoji.description === description);
            }
        }

        // åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºæµ…è‰²
        function isLightColor(color) {
            // å°†é¢œè‰²è½¬æ¢ä¸ºRGBå€¼
            let r, g, b;

            if (color.startsWith('#')) {
                // åå…­è¿›åˆ¶é¢œè‰²
                const hex = color.slice(1);
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else {
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                }
            } else if (color.startsWith('rgb')) {
                // RGBé¢œè‰²
                const matches = color.match(/\d+/g);
                if (matches && matches.length >= 3) {
                    r = parseInt(matches[0]);
                    g = parseInt(matches[1]);
                    b = parseInt(matches[2]);
                }
            } else {
                // é»˜è®¤ä¸ºæ·±è‰²
                return false;
            }

            // è®¡ç®—äº®åº¦
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }

        // æ›´æ–°æ°”æ³¡é¢„è§ˆ
        function updateBubblePreview() {
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';

            // æ›´æ–°é¢„è§ˆæ°”æ³¡
            const demoMyBubble = document.getElementById('demo-my-bubble');
            const demoAiBubble = document.getElementById('demo-ai-bubble');

            if (demoMyBubble) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²è€Œä¸æ˜¯opacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                demoMyBubble.style.backgroundColor = transparentMyColor;
                demoMyBubble.style.color = isLightColor(myColor) ? '#333' : '#fff';
            }

            if (demoAiBubble) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²è€Œä¸æ˜¯opacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                demoAiBubble.style.backgroundColor = transparentAiColor;
                demoAiBubble.style.color = isLightColor(aiColor) ? '#333' : '#fff';
            }

            // æ›´æ–°é¢œè‰²é¢„è§ˆ
            const myPreview = document.getElementById('my-bubble-preview');
            const aiPreview = document.getElementById('ai-bubble-preview');

            if (myPreview) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²è€Œä¸æ˜¯opacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                myPreview.style.backgroundColor = transparentMyColor;
                myPreview.textContent = 'æˆ‘çš„æ°”æ³¡';
            }

            if (aiPreview) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²è€Œä¸æ˜¯opacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                aiPreview.style.backgroundColor = transparentAiColor;
                aiPreview.textContent = 'å¯¹æ–¹æ°”æ³¡';
            }
        }

        // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶
        function bindAvatarUploadEvents() {
            // æˆ‘çš„å¤´åƒä¸Šä¼ 
            const myAvatarUpload = document.getElementById('my-chat-avatar-upload');
            if (myAvatarUpload) {
                myAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('my-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedMyChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }

            // AIå¤´åƒä¸Šä¼ 
            const aiAvatarUpload = document.getElementById('ai-chat-avatar-upload');
            if (aiAvatarUpload) {
                aiAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('ai-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedAiChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
        }

        // åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
        function initializeAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            if (!avatarInput) {
                console.error('æ‰¾ä¸åˆ°avatar-uploadå…ƒç´ ');
                return;
            }

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            avatarInput.removeEventListener('change', avatarUploadHandler);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            avatarInput.addEventListener('change', avatarUploadHandler);
            console.log('å¤´åƒä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
        }

        // æ›´æ–°èŠå¤©è®¾ç½®ç•Œé¢çš„æ˜¾ç¤ºçŠ¶æ€
        async function updateChatSettingsDisplay() {
            if (!currentChatCharacter) {
                console.log("æ›´æ–°èŠå¤©è®¾ç½®ç•Œé¢æ˜¾ç¤ºï¼šæ— å½“å‰èŠå¤©è§’è‰²ï¼Œè·³è¿‡æ“ä½œ");
                return;
            }

            const chatSettings = await getAsyncChatSettings();

            // ğŸ”¥ã€æ–°å¢ã€‘æ§åˆ¶è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®æ˜¾ç¤ºï¼ˆåªå¯¹å•èŠæ˜¾ç¤ºï¼‰
            const characterSoundSettings = document.getElementById('character-sound-settings');
            if (characterSoundSettings) {
                const isGroupChat = currentChatCharacter.isGroup;
                characterSoundSettings.style.display = isGroupChat ? 'none' : 'block';
            }

            // æ›´æ–°å†å²æ¶ˆæ¯æ•°æ˜¾ç¤º
            const historyCountElement = document.getElementById('current-history-count');
            if (historyCountElement) {
                historyCountElement.textContent = chatSettings.historyCount + 'å›åˆ';
            }

            // æ›´æ–°è®°å¿†æŒ‚è½½æ˜¾ç¤º
            const memoryMountElement = document.getElementById('current-memory-mount');
            if (memoryMountElement) {
                memoryMountElement.textContent = chatSettings.memoryMountEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';
            }

            // æ›´æ–°ä¸–ç•Œä¹¦æŒ‚è½½æ˜¾ç¤º
            updateWorldbookMountDisplay();

            // æ›´æ–°è¡¨æƒ…åŒ…åº“æŒ‚è½½æ˜¾ç¤º
            updateEmojiLibraryMountDisplay();

            // æ›´æ–°æ—¶é—´æ„ŸçŸ¥å¼€å…³
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.checked = chatSettings.timeAwarenessEnabled;
            }

            // æ›´æ–°é€šè¯è®¾ç½®
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.checked = chatSettings.aiCallEnabled;
            }

            // æ›´æ–°å¿ƒç‡ç›‘æµ‹è®¾ç½®
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.checked = chatSettings.aiHeartrateEnabled;
            }

            // æ›´æ–°è§’è‰²çŠ¶æ€æ˜¾ç¤ºè®¾ç½®
            const characterStatusCheckbox = document.getElementById('character-status-enabled');
            if (characterStatusCheckbox) {
                characterStatusCheckbox.checked = chatSettings.characterStatusEnabled || false;
                // ğŸ”¥ã€æ–°å¢ã€‘æ§åˆ¶çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®çš„æ˜¾ç¤º
                const statusFrequencySetting = document.getElementById('status-frequency-setting');
                if (statusFrequencySetting) {
                    statusFrequencySetting.style.display = chatSettings.characterStatusEnabled ? 'flex' : 'none';
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½® - ä»å…¨å±€è®¾ç½®è¯»å–
            const statusUpdateFrequencySelect = document.getElementById('status-update-frequency');
            if (statusUpdateFrequencySelect) {
                const globalFrequency = localStorage.getItem('globalStatusUpdateFrequency') || 'medium';
                statusUpdateFrequencySelect.value = globalFrequency;
            }



            // æ›´æ–°åå°äº’åŠ¨è®¾ç½®
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.checked = chatSettings.backgroundInteractionEnabled;
                // æ§åˆ¶è¯¦ç»†è®¾ç½®æ˜¾ç¤º
                const backgroundSettings = document.getElementById('background-interaction-settings');
                if (backgroundSettings) {
                    backgroundSettings.style.display = chatSettings.backgroundInteractionEnabled ? 'block' : 'none';
                }
            }

            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.value = chatSettings.backgroundChatFrequency || 'low';
            }

            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.checked = chatSettings.backgroundChatEnabled === true;
                // æ§åˆ¶é¢‘ç‡è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                if (chatFrequencySetting) {
                    chatFrequencySetting.style.display = (chatSettings.backgroundInteractionEnabled === true && chatSettings.backgroundChatEnabled === true) ? 'block' : 'none';
                }
            }

            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.checked = chatSettings.backgroundMomentsEnabled === true;
                // æ§åˆ¶ç›¸å…³è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                const momentsEnabled = (chatSettings.backgroundInteractionEnabled === true && chatSettings.backgroundMomentsEnabled === true);
                const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                const testPublishSetting = document.getElementById('test-publish-setting');

                if (momentsFrequencySetting) {
                    momentsFrequencySetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (scheduledMomentsSetting) {
                    scheduledMomentsSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (testPublishSetting) {
                    testPublishSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
            }

            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.value = chatSettings.backgroundMomentsFrequency || 'low';
            }

            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.checked = chatSettings.scheduledMomentsEnabled || false;
                // æ§åˆ¶æ—¶é—´è®¾ç½®æŒ‰é’®æ˜¾ç¤º
                const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                if (scheduledTimesButton) {
                    scheduledTimesButton.style.display = chatSettings.scheduledMomentsEnabled ? 'inline-block' : 'none';
                }
            }

            // æ›´æ–°å®šæ—¶å‘å¸ƒæ—¶é—´æ˜¾ç¤º
            updateScheduleTimesDisplay();

            // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°åå°å†™æ—¥è®°è®¾ç½®
            const backgroundDiaryCheckbox = document.getElementById('background-diary-enabled');
            if (backgroundDiaryCheckbox) {
                backgroundDiaryCheckbox.checked = chatSettings.backgroundDiaryEnabled === true;
                // æ§åˆ¶æ—¶é—´è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                const diaryTimeSetting = document.getElementById('diary-time-setting');
                if (diaryTimeSetting) {
                    const showSetting = (chatSettings.backgroundInteractionEnabled === true && chatSettings.backgroundDiaryEnabled === true);
                    diaryTimeSetting.style.display = showSetting ? 'flex' : 'none';
                }
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°æ—¥è®°æ—¶é—´è¾“å…¥æ¡†
            const diaryTimeInput = document.getElementById('diary-time-input');
            if (diaryTimeInput) {
                diaryTimeInput.value = chatSettings.backgroundDiaryTime || '';
                console.log(`ğŸ”„ [è®¾ç½®ç•Œé¢] æ›´æ–°æ—¥è®°æ—¶é—´æ˜¾ç¤º: ${chatSettings.backgroundDiaryTime || 'æœªè®¾ç½®'}`);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°æ—¶é—´æˆ³è®¾ç½® - é»˜è®¤å¼€å¯
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                // å¦‚æœè®¾ç½®æœªå®šä¹‰ï¼Œé»˜è®¤ä¸ºtrue
                const isEnabled = chatSettings.timestampEnabled !== false;
                timestampCheckbox.checked = isEnabled;
                console.log('ğŸ• æ—¶é—´æˆ³å¼€å…³çŠ¶æ€:', isEnabled);
            }

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨æ¥ä¿å­˜è®¾ç½®å˜åŒ–
            bindChatSettingsEvents();
        }

        // ç»‘å®šèŠå¤©è®¾ç½®çš„äº‹ä»¶ç›‘å¬å™¨
        function bindChatSettingsEvents() {
            // æ—¶é—´æ„ŸçŸ¥å¼€å…³
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timeAwarenessEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                };
            }

            // é€šè¯è®¾ç½®
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiCallEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    showToast(`è§’è‰²ä¸»åŠ¨æ‹¨æ‰“ç”µè¯å·²${this.checked ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                };
            }

            // å¿ƒç‡ç›‘æµ‹è®¾ç½®
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiHeartrateEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // ç«‹å³æ›´æ–°å¿ƒç‡æ˜¾ç¤ºçŠ¶æ€
                    if (currentChatCharacter) {
                        updateAiHeartrate();
                    }

                    showToast(`è§’è‰²å¿ƒç‡ç›‘æµ‹å·²${this.checked ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                };
            }



            // åå°äº’åŠ¨è®¾ç½®
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundInteractionEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    // æ˜¾ç¤º/éšè—è¯¦ç»†è®¾ç½®
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘å½“æ€»å¼€å…³å…³é—­æ—¶ï¼ŒåŒæ—¶æ›´æ–°å­å¼€å…³çš„æ˜¾ç¤ºçŠ¶æ€
                    if (!this.checked) {
                        // éšè—æ‰€æœ‰å­åŠŸèƒ½çš„è®¾ç½®
                        const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                        const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                        const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                        const testPublishSetting = document.getElementById('test-publish-setting');

                        if (chatFrequencySetting) chatFrequencySetting.style.display = 'none';
                        if (momentsFrequencySetting) momentsFrequencySetting.style.display = 'none';
                        if (scheduledMomentsSetting) scheduledMomentsSetting.style.display = 'none';
                        if (testPublishSetting) testPublishSetting.style.display = 'none';
                    } else {
                        // æ€»å¼€å…³å¼€å¯æ—¶ï¼Œæ ¹æ®å­å¼€å…³çŠ¶æ€æ˜¾ç¤ºç›¸åº”è®¾ç½®
                        const backgroundChatEnabled = chatSettings.backgroundChatEnabled === true;
                        const backgroundMomentsEnabled = chatSettings.backgroundMomentsEnabled === true;

                        const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                        const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                        const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                        const testPublishSetting = document.getElementById('test-publish-setting');

                        if (chatFrequencySetting) chatFrequencySetting.style.display = backgroundChatEnabled ? 'block' : 'none';
                        if (momentsFrequencySetting) momentsFrequencySetting.style.display = backgroundMomentsEnabled ? 'flex' : 'none';
                        if (scheduledMomentsSetting) scheduledMomentsSetting.style.display = backgroundMomentsEnabled ? 'block' : 'none';
                        if (testPublishSetting) testPublishSetting.style.display = backgroundMomentsEnabled ? 'flex' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘åªé‡æ–°åˆå§‹åŒ–å½“å‰è§’è‰²çš„å®šæ—¶å™¨
                    if (currentChatCharacter) {
                        await scheduleProactiveChatForCharacter(currentChatCharacter.id);
                        console.log(`âœ… [è®¾ç½®æ›´æ”¹] ${currentChatCharacter.name} ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å·²é‡æ–°è®¾ç½®`);
                    }
                };
            }

            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);
                };
            }

            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ§åˆ¶é¢‘ç‡è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                    if (chatFrequencySetting) {
                        const showSetting = (chatSettings.backgroundInteractionEnabled === true && this.checked);
                        chatFrequencySetting.style.display = showSetting ? 'block' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘åªé‡æ–°åˆå§‹åŒ–å½“å‰è§’è‰²çš„å®šæ—¶å™¨
                    if (currentChatCharacter) {
                        await scheduleProactiveChatForCharacter(currentChatCharacter.id);
                        console.log(`âœ… [è®¾ç½®æ›´æ”¹] ${currentChatCharacter.name} ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å·²é‡æ–°è®¾ç½®`);
                    }
                };
            }

            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ§åˆ¶ç›¸å…³è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                    const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                    const testPublishSetting = document.getElementById('test-publish-setting');

                    const showSettings = (chatSettings.backgroundInteractionEnabled === true && this.checked);

                    if (momentsFrequencySetting) {
                        momentsFrequencySetting.style.display = showSettings ? 'flex' : 'none';
                    }
                    if (scheduledMomentsSetting) {
                        scheduledMomentsSetting.style.display = showSettings ? 'flex' : 'none';
                    }
                    if (testPublishSetting) {
                        testPublishSetting.style.display = showSettings ? 'flex' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘åªé‡æ–°åˆå§‹åŒ–å½“å‰è§’è‰²çš„å®šæ—¶å™¨
                    if (currentChatCharacter) {
                        await scheduleProactiveChatForCharacter(currentChatCharacter.id);
                        console.log(`âœ… [è®¾ç½®æ›´æ”¹] ${currentChatCharacter.name} ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨å·²é‡æ–°è®¾ç½®`);
                    }
                };
            }

            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);

                    // ğŸ”¥ã€ä¿®å¤ã€‘é‡æ–°åˆå§‹åŒ–å…¨å±€åå°äº’åŠ¨ç³»ç»Ÿ
                    await initGlobalBackgroundInteractionSystem();
                };
            }

            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.scheduledMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // æ§åˆ¶æ—¶é—´è®¾ç½®æŒ‰é’®æ˜¾ç¤º
                    const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                    if (scheduledTimesButton) {
                        scheduledTimesButton.style.display = this.checked ? 'inline-block' : 'none';
                    }

                    // é‡æ–°åˆå§‹åŒ–å®šæ—¶å‘å¸ƒç³»ç»Ÿ
                    initScheduledMomentsSystem();
                };
            }

            // ğŸ”¥ã€æ–°å¢ã€‘åå°å†™æ—¥è®°å¼€å…³è®¾ç½®
            const backgroundDiaryCheckbox = document.getElementById('background-diary-enabled');
            if (backgroundDiaryCheckbox) {
                backgroundDiaryCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundDiaryEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // æ§åˆ¶æ—¶é—´è®¾ç½®æ˜¾ç¤º - éœ€è¦åŒæ—¶æ£€æŸ¥æ€»å¼€å…³å’Œå­å¼€å…³
                    const diaryTimeSetting = document.getElementById('diary-time-setting');
                    if (diaryTimeSetting) {
                        const showSetting = (chatSettings.backgroundInteractionEnabled === true && this.checked);
                        diaryTimeSetting.style.display = showSetting ? 'flex' : 'none';
                    }

                    // é‡æ–°åˆå§‹åŒ–åå°å†™æ—¥è®°ç³»ç»Ÿ
                    if (currentChatCharacter) {
                        await initBackgroundDiarySystem(currentChatCharacter.id);
                    }

                    showToast(`åå°å†™æ—¥è®°å·²${this.checked ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                };
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ—¶é—´æˆ³è®¾ç½®äº‹ä»¶ç»‘å®š
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timestampEnabled = this.checked; // ç›´æ¥è®¾ç½®å¸ƒå°”å€¼
                    await saveCurrentChatSettings(chatSettings);
                    // é‡æ–°æ¸²æŸ“èŠå¤©æ¶ˆæ¯
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                    console.log('ğŸ• æ—¶é—´æˆ³è®¾ç½®å·²æ›´æ–°:', this.checked);
                };
            }

            // è§’è‰²çŠ¶æ€æ˜¾ç¤ºè®¾ç½®
            const characterStatusCheckbox = document.getElementById('character-status-enabled');
            if (characterStatusCheckbox) {
                characterStatusCheckbox.onchange = async function() {
                    console.log('çŠ¶æ€æ˜¾ç¤ºå¼€å…³è¢«ç‚¹å‡»:', this.checked);
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.characterStatusEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);

                    // ğŸ”¥ã€æ–°å¢ã€‘æ§åˆ¶çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®çš„æ˜¾ç¤º
                    const statusFrequencySetting = document.getElementById('status-frequency-setting');
                    if (statusFrequencySetting) {
                        statusFrequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }

                    // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤º/éšè—çŠ¶æ€
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                        // æ›´æ–°èŠå¤©æ ‡é¢˜åŒºåŸŸçš„çŠ¶æ€æ˜¾ç¤º
                        const headerContainer = document.querySelector('#api-chat-screen .header');
                        if (headerContainer) {
                            renderCharacterStatus(currentChatCharacter.id, headerContainer);
                        }
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘é‡å¯çŠ¶æ€æ›´æ–°å®šæ—¶å™¨ä»¥åº”ç”¨æ–°è®¾ç½®
                    restartCharacterStatusTimer();

                    showToast(`è§’è‰²çŠ¶æ€æ˜¾ç¤ºå·²${this.checked ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                };
            } else {
                console.warn('æ‰¾ä¸åˆ°character-status-enabledå…ƒç´ ');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½® - ä¿å­˜ä¸ºå…¨å±€è®¾ç½®
            const statusUpdateFrequencySelect = document.getElementById('status-update-frequency');
            if (statusUpdateFrequencySelect) {
                statusUpdateFrequencySelect.onchange = async function() {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜ä¸ºå…¨å±€è®¾ç½®ï¼Œè€Œä¸æ˜¯è§’è‰²ä¸“å±è®¾ç½®
                    localStorage.setItem('globalStatusUpdateFrequency', this.value);

                    // åŒæ—¶æ›´æ–°å½“å‰è§’è‰²çš„è®¾ç½®ä»¥ä¿æŒä¸€è‡´æ€§
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.statusUpdateFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);

                    // é‡å¯çŠ¶æ€æ›´æ–°å®šæ—¶å™¨ä»¥åº”ç”¨æ–°é¢‘ç‡
                    restartCharacterStatusTimer();

                    const frequencyNames = {
                        'high': 'é«˜é¢‘',
                        'medium-high': 'ä¸­é«˜é¢‘',
                        'medium': 'ä¸­é¢‘',
                        'medium-low': 'ä¸­ä½é¢‘',
                        'low': 'ä½é¢‘'
                    };

                    showToast(`çŠ¶æ€æ›´æ–°é¢‘ç‡å·²è®¾ç½®ä¸º${frequencyNames[this.value]}`, 'success');
                };
            }
        }

        // åˆå§‹åŒ–èŠå¤©è®¾ç½®ç•Œé¢
        async function initializeChatSettings() {
            console.log("å¼€å§‹åˆå§‹åŒ–èŠå¤©è®¾ç½®ç•Œé¢");

            // åˆå§‹åŒ–UIç›¸å…³äº‹ä»¶
            initChatSettingsUIEvents();

            // å¦‚æœæ²¡æœ‰currentChatCharacterï¼Œåªåˆå§‹åŒ–UIäº‹ä»¶ï¼Œä¸åŠ è½½è®¾ç½®
            if (!currentChatCharacter) {
                console.log("åˆå§‹åŒ–èŠå¤©è®¾ç½®ç•Œé¢ï¼šæ— å½“å‰èŠå¤©è§’è‰²ï¼Œåªåˆå§‹åŒ–UIäº‹ä»¶");
                return;
            }

            // æ›´æ–°èº«ä»½æ˜¾ç¤º
            await updateChatIdentityDisplay();

            // æ›´æ–°æ°”æ³¡æ ·å¼æ˜¾ç¤º
            await updateBubbleStyleDisplay();

            // ğŸ”¥ã€æ–°å¢ã€‘åˆå§‹åŒ–è§’è‰²ä¸“å±éŸ³æ•ˆè®¾ç½®
            await initCharacterSoundSettings();

            // æ›´æ–°æ‰€æœ‰è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
            await updateChatSettingsDisplay();

            // åŠ è½½å½“å‰èŠå¤©çš„è®¾ç½®
            if (currentChatCharacter) {
                const chatSettings = await getAsyncChatSettings();
            }
        }

        // åˆå§‹åŒ–èŠå¤©è®¾ç½®UIç›¸å…³äº‹ä»¶
        function initChatSettingsUIEvents() {



            // ğŸ”¥ã€ä¿®å¤ã€‘ç»‘å®šåå°äº’åŠ¨å¼€å…³äº‹ä»¶ - è¿™é‡Œåªå¤„ç†UIæ˜¾ç¤ºï¼Œå®é™…ä¿å­˜åœ¨å¦ä¸€ä¸ªåœ°æ–¹å¤„ç†
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.addEventListener('change', async function() {
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘å½“æ€»å¼€å…³å…³é—­æ—¶ï¼ŒåŒæ—¶éšè—æ‰€æœ‰å­åŠŸèƒ½çš„è®¾ç½®
                    if (!this.checked) {
                        const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                        const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                        const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                        const testPublishSetting = document.getElementById('test-publish-setting');
                        const diaryTimeSetting = document.getElementById('diary-time-setting');

                        if (chatFrequencySetting) chatFrequencySetting.style.display = 'none';
                        if (momentsFrequencySetting) momentsFrequencySetting.style.display = 'none';
                        if (scheduledMomentsSetting) scheduledMomentsSetting.style.display = 'none';
                        if (testPublishSetting) testPublishSetting.style.display = 'none';
                        if (diaryTimeSetting) diaryTimeSetting.style.display = 'none';

                        clearAllBackgroundTimers();
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœå¼€å¯åå°äº’åŠ¨ï¼Œé‡æ–°åˆå§‹åŒ–å…¨å±€ç³»ç»Ÿï¼ˆæ€»å¼€å…³å½±å“æ‰€æœ‰è§’è‰²ï¼‰
                        await initGlobalBackgroundInteractionSystem();
                    }
                });
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ç»‘å®šä¸»åŠ¨èŠå¤©å¼€å…³äº‹ä»¶ - è¿™é‡Œåªå¤„ç†UIæ˜¾ç¤ºï¼Œå®é™…ä¿å­˜åœ¨å¦ä¸€ä¸ªåœ°æ–¹å¤„ç†
            const backgroundChatCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatCheckbox) {
                backgroundChatCheckbox.addEventListener('change', async function() {
                    // ğŸ”¥ã€ä¿®å¤ã€‘éœ€è¦æ£€æŸ¥æ€»å¼€å…³çŠ¶æ€
                    const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
                    const totalSwitchEnabled = backgroundInteractionCheckbox ? backgroundInteractionCheckbox.checked : false;

                    const frequencySetting = document.getElementById('chat-frequency-setting');
                    if (frequencySetting) {
                        const showSetting = (totalSwitchEnabled && this.checked);
                        frequencySetting.style.display = showSetting ? 'block' : 'none';
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘é‡æ–°åˆå§‹åŒ–å…¨å±€åå°äº’åŠ¨ç³»ç»Ÿ
                    await initGlobalBackgroundInteractionSystem();
                });
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ç»‘å®šä¸»åŠ¨å‘åŠ¨æ€å¼€å…³äº‹ä»¶ - è¿™é‡Œåªå¤„ç†UIæ˜¾ç¤ºï¼Œå®é™…ä¿å­˜åœ¨å¦ä¸€ä¸ªåœ°æ–¹å¤„ç†
            const backgroundMomentsCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsCheckbox) {
                backgroundMomentsCheckbox.addEventListener('change', async function() {
                    // ğŸ”¥ã€ä¿®å¤ã€‘éœ€è¦æ£€æŸ¥æ€»å¼€å…³çŠ¶æ€
                    const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
                    const totalSwitchEnabled = backgroundInteractionCheckbox ? backgroundInteractionCheckbox.checked : false;

                    const showSettings = (totalSwitchEnabled && this.checked);

                    const frequencySetting = document.getElementById('moments-frequency-setting');
                    const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                    const testPublishSetting = document.getElementById('test-publish-setting');

                    if (frequencySetting) frequencySetting.style.display = showSettings ? 'flex' : 'none';
                    if (scheduledMomentsSetting) scheduledMomentsSetting.style.display = showSettings ? 'flex' : 'none';
                    if (testPublishSetting) testPublishSetting.style.display = showSettings ? 'flex' : 'none';

                    // ğŸ”¥ã€ä¿®å¤ã€‘åªé‡æ–°åˆå§‹åŒ–å½“å‰è§’è‰²çš„åŠ¨æ€å®šæ—¶å™¨
                    if (currentChatCharacter) {
                        const characterId = currentChatCharacter.id;
                        // æ¸…é™¤ç°æœ‰çš„åŠ¨æ€å®šæ—¶å™¨
                        if (backgroundTimers[characterId + '_moments']) {
                            clearInterval(backgroundTimers[characterId + '_moments']);
                            delete backgroundTimers[characterId + '_moments'];
                        }

                        // å¦‚æœå¼€å¯äº†åŠ¨æ€åŠŸèƒ½ï¼Œé‡æ–°è®¾ç½®å®šæ—¶å™¨
                        const chatSettings = getCurrentChatSettings();
                        if (chatSettings.backgroundInteractionEnabled && chatSettings.backgroundMomentsEnabled) {
                            const momentsInterval = getBackgroundMomentsInterval(chatSettings.backgroundMomentsFrequency || 'low');
                            backgroundTimers[characterId + '_moments'] = setInterval(() => {
                                triggerBackgroundMoments(characterId);
                            }, momentsInterval);
                            console.log(`âœ… [è®¾ç½®æ›´æ”¹] ${currentChatCharacter.name} ä¸»åŠ¨å‘åŠ¨æ€å®šæ—¶å™¨å·²é‡æ–°è®¾ç½®ï¼Œé—´éš”: ${momentsInterval}ms`);
                        } else {
                            console.log(`ğŸš« [è®¾ç½®æ›´æ”¹] ${currentChatCharacter.name} ä¸»åŠ¨å‘åŠ¨æ€å·²å…³é—­`);
                        }
                    }
                });
            }

            // ğŸ”¥ã€æ–°å¢ã€‘ç»‘å®šåå°å†™æ—¥è®°å¼€å…³äº‹ä»¶
            const backgroundDiaryCheckbox = document.getElementById('background-diary-enabled');
            if (backgroundDiaryCheckbox) {
                backgroundDiaryCheckbox.addEventListener('change', async function() {
                    // æ£€æŸ¥æ€»å¼€å…³çŠ¶æ€
                    const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
                    const totalSwitchEnabled = backgroundInteractionCheckbox ? backgroundInteractionCheckbox.checked : false;

                    const diaryTimeSetting = document.getElementById('diary-time-setting');
                    if (diaryTimeSetting) {
                        const showSetting = (totalSwitchEnabled && this.checked);
                        diaryTimeSetting.style.display = showSetting ? 'flex' : 'none';
                    }

                    // é‡æ–°åˆå§‹åŒ–åå°å†™æ—¥è®°ç³»ç»Ÿ
                    if (currentChatCharacter) {
                        await initBackgroundDiarySystem(currentChatCharacter.id);
                    }
                });
            }

            // ä¸»åŠ¨æ‹¨æ‰“ç”µè¯å¼€å…³äº‹ä»¶å·²åœ¨ä¸Šé¢çš„ initChatSettingsUIEvents ä¸­å¤„ç†



            // ç»‘å®šé€‰æ‹©æ¨¡å¼æŒ‰é’®äº‹ä»¶
            const selectionCancelBtn = document.getElementById('selection-cancel-btn');
            const selectionDeleteBtn = document.getElementById('selection-delete-btn');

            if (selectionCancelBtn) {
                selectionCancelBtn.addEventListener('click', exitMessageSelectionMode);
            }

            if (selectionDeleteBtn) {
                selectionDeleteBtn.addEventListener('click', function() {
                    if (selectedMessages.size === 0) return;

                    deleteSelectedMessages();
                });
            }
        }

        // æˆ³ä¸€æˆ³åŠŸèƒ½
        async function pokeCharacter(characterId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) {
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const pokeSuffix = chatSettings.aiPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘ç”¨æˆ·æˆ³è§’è‰²åº”è¯¥ä½¿ç”¨aiPokeSuffix
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;

            // åˆ›å»ºæˆ³ä¸€æˆ³ç³»ç»Ÿæ¶ˆæ¯
            const pokeMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: `ä½ æˆ³äº†æˆ³${characterName}${pokeSuffix}`,
                timestamp: Date.now(),
                isPoke: true
            };

            // æ·»åŠ åˆ°èŠå¤©è®°å½•
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }

            chatMessages[characterId].push(pokeMessage);
            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡æˆ³ä¸€æˆ³æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                const stableId = `${characterId}_poke_${pokeMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: characterId,
                    timestamp: pokeMessage.timestamp,
                    messageOrder: chatMessages[characterId].length - 1,
                    originalMessageId: pokeMessage.id,
                    messageData: pokeMessage
                });
                console.log('âœ… [é«˜æ•ˆæˆ³ä¸€æˆ³] æˆ³ä¸€æˆ³æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('æˆ³ä¸€æˆ³æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                saveChatMessages();
            }

            // æ¸²æŸ“æ¶ˆæ¯
            renderChatMessages(characterId);

            // æ¨¡æ‹Ÿè§’è‰²å›åº”ï¼ˆ40%æ¦‚ç‡ï¼‰
            if (Math.random() < 0.4) {
                setTimeout(() => {
                    const myPokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²æˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix
                    const aiPokeMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${characterName}æˆ³äº†æˆ³ä½ ${myPokeSuffix}`,
                        timestamp: Date.now(),
                        isPoke: true
                    };

                    chatMessages[characterId].push(aiPokeMessage);
                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡AIæˆ³ä¸€æˆ³å›åº”æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                        const stableId = `${characterId}_poke_reply_${aiPokeMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                        db.chatMessages.add({
                            id: stableId,
                            characterId: characterId,
                            timestamp: aiPokeMessage.timestamp,
                            messageOrder: chatMessages[characterId].length - 1,
                            originalMessageId: aiPokeMessage.id,
                            messageData: aiPokeMessage
                        }).then(() => {
                            console.log('âœ… [é«˜æ•ˆAIæˆ³ä¸€æˆ³] AIæˆ³ä¸€æˆ³å›åº”æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                        }).catch(error => {
                            console.error('AIæˆ³ä¸€æˆ³æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥:', error);
                        });
                    } catch (error) {
                        console.error('AIæˆ³ä¸€æˆ³æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                        saveChatMessages();
                    }
                    renderChatMessages(characterId);
                }, 1000 + Math.random() * 2000);
            }
        }

        // æ˜¾ç¤ºèŠå¤©é€‰é¡¹
        function showChatOptions() {
            showModal('chat-options-modal');
        }

        // æ˜¾ç¤ºå•èŠèº«ä»½é€‰æ‹©ï¼ˆç¬¬ä¸€æ­¥ï¼‰
        function showSingleChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForSingleChat();
        }

        // æ˜¾ç¤ºå•èŠèº«ä»½é€‰æ‹©
        function showPersonaSelectionForSingleChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">é€‰æ‹©èº«ä»½</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">è¯·é€‰æ‹©ä½ åœ¨è¿™æ¬¡å¯¹è¯ä¸­ä½¿ç”¨çš„èº«ä»½é¢å…·</p>
                            <div class="persona-selection-list" id="persona-selection-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                        <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'æš‚æ— æè¿°', 100)}</div>
                                        </div>
                                        <div class="persona-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionModal()">å–æ¶ˆ</button>
                            <button class="modal-primary" id="confirm-persona-btn" onclick="confirmPersonaAndShowCharacters()" disabled>ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©è§’è‰²</button>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('persona-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedPersonaForChat = this.dataset.personaId;
                    document.getElementById('confirm-persona-btn').disabled = false;
                });
            });
        }

        // éšè—èº«ä»½é€‰æ‹©æ¨¡æ€æ¡†
        function hidePersonaSelectionModal() {
            const modal = document.getElementById('persona-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.selectedPersonaForChat = null;
        }

        // ç¡®è®¤èº«ä»½é€‰æ‹©å¹¶æ˜¾ç¤ºè§’è‰²é€‰æ‹©
        function confirmPersonaAndShowCharacters() {
            if (!window.selectedPersonaForChat) return;

            hidePersonaSelectionModal();
            showCharacterSelectionForSingleChat();
        }

        // æ˜¾ç¤ºå•èŠè§’è‰²é€‰æ‹©ï¼ˆç¬¬äºŒæ­¥ï¼‰
        function showCharacterSelectionForSingleChat() {
            // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜å½“å‰é€‰ä¸­çš„èº«ä»½IDï¼Œé˜²æ­¢åœ¨åç»­æµç¨‹ä¸­ä¸¢å¤±
            const savedPersonaId = window.selectedPersonaForChat;
            console.log('=== showCharacterSelectionForSingleChat ===');
            console.log('ä¿å­˜çš„èº«ä»½ID:', savedPersonaId);

            const modalBody = document.getElementById('single-chat-body');
            modalBody.innerHTML = '';

            if (characters.length === 0) {
                modalBody.innerHTML = '<p class="empty-mount-chats">è¿˜æ²¡æœ‰è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²</p>';
            } else {
                characters.forEach(character => {
                    const chatOption = document.createElement('div');
                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥è§’è‰²æ˜¯å¦å·²å­˜åœ¨å¯¹è¯ï¼Œæ·»åŠ ä¸åŒçš„CSSç±»
                    const hasExistingChat = contacts.includes(character.id);
                    chatOption.className = `chat-option-item ${hasExistingChat ? 'has-existing-chat' : ''}`;

                    chatOption.onclick = () => {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ä¿å­˜çš„èº«ä»½IDè€Œä¸æ˜¯å…¨å±€å˜é‡
                        console.log('=== è§’è‰²é€‰æ‹©ç‚¹å‡»äº‹ä»¶ ===');
                        console.log('é€‰ä¸­çš„è§’è‰²:', character.name);
                        console.log('ä½¿ç”¨çš„èº«ä»½ID:', savedPersonaId);

                        hideModal('single-chat-modal');
                        // è®¾ç½®é€‰æ‹©çš„èº«ä»½å¹¶å¼€å§‹èŠå¤©
                        startChatWithPersona(character, savedPersonaId);

                        // æ¸…ç†ä¸´æ—¶å˜é‡
                        window.selectedPersonaForChat = null;
                    };

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºå·²å­˜åœ¨å¯¹è¯çš„è§’è‰²æ·»åŠ çŠ¶æ€æç¤º
                    const statusIndicator = hasExistingChat ? `
                        <div class="chat-status-indicator">
                            <i class="fas fa-comments"></i>
                            <span>å·²æœ‰å¯¹è¯</span>
                        </div>
                    ` : '';

                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}${hasExistingChat ? ' <span class="chat-exists-badge">å·²æœ‰å¯¹è¯</span>' : ''}</div>
                            <div class="chat-option-desc">${truncateText(character.bio || 'æš‚æ— æè¿°', 80)}</div>
                        </div>
                        ${statusIndicator}
                    `;

                    modalBody.appendChild(chatOption);
                });
            }

            showModal('single-chat-modal');
        }

        async function startChatWithPersona(character, personaId) {
            console.log('âœ…[ä¿®å¤] startChatWithPersona è¢«è°ƒç”¨');

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥è¯¥è§’è‰²æ˜¯å¦å·²å­˜åœ¨å¯¹è¯
            if (contacts.includes(character.id)) {
                // è§’è‰²å·²å­˜åœ¨å¯¹è¯ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ç»§ç»­æˆ–å–æ¶ˆ
                const existingSettings = chatSettings[character.id] || {};
                const existingPersona = personas.find(p => p.id === existingSettings.selectedIdentityId);
                const existingIdentityName = existingPersona ? existingPersona.name : 'æœªçŸ¥èº«ä»½';

                const confirmed = confirm(
                    `è§’è‰²ã€Œ${character.name}ã€å·²å­˜åœ¨å¯¹è¯ï¼\n` +
                    `å½“å‰å¯¹è¯ä½¿ç”¨çš„èº«ä»½ï¼š${existingIdentityName}\n\n` +
                    `é€‰æ‹©ã€Œç¡®å®šã€ï¼šç»§ç»­ä½¿ç”¨ç°æœ‰å¯¹è¯\n` +
                    `é€‰æ‹©ã€Œå–æ¶ˆã€ï¼šæ”¾å¼ƒæœ¬æ¬¡æ“ä½œ`
                );

                if (confirmed) {
                    // ç”¨æˆ·é€‰æ‹©ç»§ç»­ä½¿ç”¨ç°æœ‰å¯¹è¯ï¼Œç›´æ¥å¼€å§‹èŠå¤©
                    startChat(character);
                    return;
                } else {
                    // ç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œ
                    return;
                }
            }

            // ğŸ”¥ã€æ–°å¢èº«ä»½è®¾ç½®é€»è¾‘ã€‘è§’è‰²ä¸å­˜åœ¨å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯å¹¶è®¾ç½®èº«ä»½
            if (personaId) {
                // è·å–æˆ–åˆ›å»ºæ­¤èŠå¤©çš„ä¸“å±è®¾ç½®
                let settings = chatSettings[character.id] || {};
                settings.selectedIdentityId = personaId;
                const selectedPersona = personas.find(p => p.id === personaId);
                if (selectedPersona) {
                    settings.myChatAvatar = selectedPersona.avatarUrl || '';
                    settings.myChatNickname = selectedPersona.name || '';
                    chatSettings[character.id] = settings;
                    await saveCurrentChatSettings(settings);
                }
            }

            // æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
            console.log('âœ…[ä¿®å¤] å‘ç°æ–°è”ç³»äººï¼Œæ­£åœ¨åŒæ­¥ä¿å­˜...');
            contacts.push(character.id);
            // ä½¿ç”¨ await ç¡®ä¿ä¿å­˜æ“ä½œå®Œæˆåå†ç»§ç»­
            await saveContacts();
            console.log('âœ…[ä¿®å¤] æ–°è”ç³»äººä¿å­˜æˆåŠŸï¼Œå†…å­˜ä¸­çš„ contacts åˆ—è¡¨:', contacts);
            // ä¿å­˜æˆåŠŸåï¼Œç«‹å³åˆ·æ–°ä¸€æ¬¡æ¶ˆæ¯åˆ—è¡¨çš„åå°æ•°æ®
            renderMessageList();

            // å¼€å§‹èŠå¤©
            startChat(character);
        }


        // åˆ‡æ¢ç¾¤èŠæˆå‘˜é€‰æ‹©
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');

            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 20) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©20ä¸ªæˆå‘˜');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }

 // --- è¯·ä»è¿™é‡Œå¼€å§‹ï¼Œå®Œæ•´å¤åˆ¶æ‰€æœ‰ä»£ç  ---

// 1. æ˜¾ç¤ºèŠå¤©é€‰é¡¹ï¼ˆå…¥å£å‡½æ•°ï¼Œä¿æŒä¸å˜ï¼‰
        function showGroupChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForGroupChat();
        }

// 2. æ˜¾ç¤ºç¾¤èŠèº«ä»½é€‰æ‹©
        function showPersonaSelectionForGroupChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-group-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">é€‰æ‹©èº«ä»½</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionGroupModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">è¯·é€‰æ‹©ä½ åœ¨è¿™ä¸ªç¾¤èŠä¸­ä½¿ç”¨çš„èº«ä»½é¢å…·</p>
                            <div class="persona-selection-list" id="persona-selection-group-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url('${persona.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'æš‚æ— æè¿°', 100)}</div>
                                        </div>
                                <div class="persona-selection-check"><i class="fas fa-check"></i></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionGroupModal()">å–æ¶ˆ</button>
                    <button class="modal-primary" id="confirm-group-persona-btn" disabled>ä¸‹ä¸€æ­¥ï¼šè®¾ç½®ç¾¤èŠ</button>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('persona-selection-group-modal');
    if (existingModal) existingModal.remove();
            document.body.insertAdjacentHTML('beforeend', modalHTML);

    let selectedPersonaId = null;

            document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
            selectedPersonaId = this.dataset.personaId;
                    document.getElementById('confirm-group-persona-btn').disabled = false;
                    console.log('âœ… é€‰æ‹©äº†èº«ä»½:', selectedPersonaId, 'èº«ä»½åç§°:', this.querySelector('.persona-selection-name').textContent);
                });
            });

    // å…³é”®ä¿®å¤ï¼šè®©â€œä¸‹ä¸€æ­¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç›´æ¥è°ƒç”¨ä¸‹ä¸€æ­¥å‡½æ•°ï¼Œå¹¶æŠŠIDä¼ è¿‡å»
    document.getElementById('confirm-group-persona-btn').onclick = () => {
        console.log('âœ… ç‚¹å‡»ä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œå½“å‰selectedPersonaIdå€¼ä¸º:', selectedPersonaId);
        if (selectedPersonaId) {
            console.log('âœ… å‡†å¤‡è°ƒç”¨confirmPersonaAndShowGroupSettingsï¼Œä¼ é€’ID:', selectedPersonaId);
            confirmPersonaAndShowGroupSettings(selectedPersonaId);
        } else {
            console.error('âŒ æœªé€‰æ‹©èº«ä»½å°±ç‚¹å‡»äº†ä¸‹ä¸€æ­¥');
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½é¢å…·');
        }
    };
}

// 3. éšè—èº«ä»½é€‰æ‹©æ¨¡æ€æ¡†çš„å‡½æ•°
        function hidePersonaSelectionGroupModal() {
            const modal = document.getElementById('persona-selection-group-modal');
    if (modal) modal.remove();
}

// 4. ç¡®è®¤èº«ä»½å¹¶æ˜¾ç¤ºç¾¤æˆå‘˜é€‰æ‹©
function confirmPersonaAndShowGroupSettings(personaId) {
    console.log('âœ… confirmPersonaAndShowGroupSettingsè¢«è°ƒç”¨ï¼Œæ¥æ”¶åˆ°çš„personaId:', personaId);
            hidePersonaSelectionGroupModal();
    showGroupChatMemberSelection(personaId); // å°†é€‰æ‹©çš„IDä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸€æ­¥
        }

// 5. æ˜¾ç¤ºç¾¤æˆå‘˜é€‰æ‹© (å·²æ¢å¤ç®€ä»‹æ˜¾ç¤º)
function showGroupChatMemberSelection(personaId) {
    console.log('âœ… showGroupChatMemberSelectionè¢«è°ƒç”¨ï¼Œæ¥æ”¶åˆ°çš„personaId:', personaId);

    // ç«‹å³å°†personaIdå­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±
    window.currentGroupPersonaId = personaId;
            document.getElementById('group-chat-name').value = '';
            selectedGroupMembers = [];

            const membersContainer = document.getElementById('group-chat-members');
            membersContainer.innerHTML = '';

            if (characters.length < 2) {
                membersContainer.innerHTML = '<p class="empty-mount-chats">è‡³å°‘éœ€è¦2ä¸ªè§’è‰²æ‰èƒ½åˆ›å»ºç¾¤èŠ</p>';
            } else {
                characters.forEach(character => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // å…³é”®ä¿®å¤ï¼šæ¢å¤äº†æ˜¾ç¤ºè§’è‰²ç®€ä»‹çš„HTMLä»£ç 
                    memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}');` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'æš‚æ— ç®€ä»‹', 80)}</div>
                </div>`;
                    membersContainer.appendChild(memberItem);
                });
            }

    // å…³é”®ä¿®å¤ï¼šå°† personaId ç»‘å®šåˆ°æœ€ç»ˆçš„â€œåˆ›å»ºç¾¤èŠâ€æŒ‰é’®ä¸Š
    console.log('âœ… åœ¨ç¬¬ä¸€ä¸ªä½ç½®ç»‘å®šåˆ›å»ºæŒ‰é’®ï¼ŒpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('âœ… ç¬¬ä¸€ä¸ªä½ç½®çš„åˆ›å»ºç¾¤èŠæŒ‰é’®è¢«ç‚¹å‡»ï¼Œç›´æ¥ä½¿ç”¨å‚æ•°personaId:', personaId);
        createGroupChat(personaId);
    }; // ç»‘å®šå¸¦å‚æ•°çš„åˆ›å»ºå‡½æ•°

            showModal('group-chat-modal');
        }

// 6. åˆ‡æ¢ç¾¤æˆå‘˜é€‰æ‹©çŠ¶æ€ (æ— ä¿®æ”¹ï¼Œä½†ä¸ºäº†å®Œæ•´æ€§åŒ…å«åœ¨æ­¤)
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');

            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 20) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©20ä¸ªæˆå‘˜');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }


// 7. åˆ›å»ºç¾¤èŠï¼ˆæœ€ç»ˆç‰ˆæœ¬ï¼‰
async function createGroupChat(personaId) {
    console.log(`âœ… createGroupChatè¢«è°ƒç”¨ï¼Œèº«ä»½ID: ${personaId}`);

    const groupName = document.getElementById('group-chat-name').value.trim();
    if (!groupName) return alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
    if (selectedGroupMembers.length < 2) return alert('è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªæˆå‘˜');

    const memberDetails = selectedGroupMembers.map(memberId => {
        const character = characters.find(c => c.id === memberId);
        return {
            id: character.id,
            name: character.name,
            persona: character.bio,  // ğŸ”¥ã€å…³é”®ã€‘ä½¿ç”¨personaå­—æ®µè€Œä¸æ˜¯bio
            avatarUrl: character.avatarUrl,
            color: character.color
        };
    });

    const groupChat = {
        id: 'group_' + Date.now().toString(),
        name: groupName,
        members: memberDetails,
        isGroup: true,
        createdAt: new Date().toISOString(),
        settings: {
            myPersona: '', // å°†åœ¨ä¸‹é¢è®¾ç½®
            myNickname: 'æˆ‘' // é»˜è®¤æ˜µç§°
        }
    };

    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜ç”¨æˆ·èº«ä»½è®¾ç½®ï¼ŒåŒæ—¶å…¼å®¹ä¸¤ç§æ ¼å¼
    if (personaId) {
        const selectedPersona = personas.find(p => p.id === personaId);
        if (selectedPersona) {
            groupChat.settings.myPersona = selectedPersona.description || selectedPersona.name;
            groupChat.settings.myNickname = selectedPersona.name;

            // åŒæ—¶ä¿æŒåŸæœ‰çš„chatSettingsæ ¼å¼ï¼ˆindex.htmlå…¼å®¹æ€§ï¼‰
            const chatSettings = {
                selectedIdentityId: personaId,
                myChatAvatar: selectedPersona.avatarUrl,
                myChatNickname: selectedPersona.name,
                selectedPersonaData: { ...selectedPersona },
                myPersona: selectedPersona.description || selectedPersona.name
            };

            // ç¡®ä¿ window.chatSettings å·²åˆå§‹åŒ–
            if (!window.chatSettings) {
                window.chatSettings = {};
            }
            window.chatSettings[groupChat.id] = chatSettings;
            await db.chatSettings.put({ id: groupChat.id, chatId: groupChat.id, settings: chatSettings });
            console.log('âœ… ç¾¤èŠèº«ä»½è®¾ç½®å·²æˆåŠŸä¿å­˜ï¼ˆåŒæ ¼å¼å…¼å®¹ï¼‰');
        } else {
            console.error('âŒ åˆ›å»ºç¾¤èŠæ—¶æœªæ‰¾åˆ°IDä¸º ' + personaId + ' çš„èº«ä»½ã€‚');
        }
    }

    if (!groupChats) groupChats = [];
    groupChats.push(groupChat);
    await saveGroupChats();
    hideModal('group-chat-modal');
    renderMessageList();
    alert(`ç¾¤èŠ"${groupName}"åˆ›å»ºæˆåŠŸï¼`);
}

// --- è¯·å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ ---

        // ä¿å­˜ç¾¤èŠæ•°æ® - ä½¿ç”¨IndexedDB
        async function saveGroupChats() {
            try {
                console.log('ä¿å­˜ç¾¤èŠæ•°æ®åˆ°IndexedDB:', groupChats);

                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                if (!groupChats || !Array.isArray(groupChats)) {
                    console.error('ç¾¤èŠæ•°æ®æ— æ•ˆ:', groupChats);
                    groupChats = [];
                }

                // éªŒè¯æ¯ä¸ªç¾¤èŠå¯¹è±¡çš„å®Œæ•´æ€§
                const validGroupChats = groupChats.filter(chat => {
                    if (!chat || !chat.id || !chat.name) {
                        console.warn('å‘ç°æ— æ•ˆçš„ç¾¤èŠå¯¹è±¡:', chat);
                        return false;
                    }
                    return true;
                });

                // å¦‚æœæœ‰æ— æ•ˆæ•°æ®ï¼Œæ›´æ–°æ•°ç»„
                if (validGroupChats.length !== groupChats.length) {
                    groupChats = validGroupChats;
                    console.log('å·²è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼Œæœ‰æ•ˆç¾¤èŠæ•°é‡:', groupChats.length);
                }

                // ä½¿ç”¨äº‹åŠ¡æ¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                await db.transaction('rw', db.groupChats, async () => {
                // æ¸…ç©ºç°æœ‰æ•°æ®
                await db.groupChats.clear();

                    // é€ä¸ªæ’å…¥æ•°æ®ä»¥é¿å…æ‰¹é‡æ’å…¥çš„IDå†²çªé—®é¢˜
                    for (const chat of groupChats) {
                        try {
                            await db.groupChats.add(chat);
                        } catch (addError) {
                            console.warn('æ’å…¥ç¾¤èŠå¤±è´¥ï¼Œå°è¯•æ›´æ–°:', chat.id, addError);
                            // å¦‚æœæ·»åŠ å¤±è´¥ï¼Œå°è¯•æ›´æ–°
                            await db.groupChats.put(chat);
                        }
                    }
                });

                console.log('ç¾¤èŠæ•°æ®ä¿å­˜æˆåŠŸåˆ°IndexedDB');

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ™ºèƒ½localStorageå¤‡ä»½ç­–ç•¥ - åªåœ¨æ•°æ®é‡å°æ—¶å¤‡ä»½
                try {
                    const dataSize = JSON.stringify(groupChats).length;
                    const maxLocalStorageSize = 1024 * 1024; // 1MBé™åˆ¶ï¼Œä¸ºå…¶ä»–æ•°æ®ç•™ç©ºé—´

                    if (dataSize < maxLocalStorageSize) {
                        localStorage.setItem('groupChats', JSON.stringify(groupChats));
                        console.log(`ç¾¤èŠæ•°æ®å¤‡ä»½åˆ°localStorageæˆåŠŸ (${(dataSize/1024).toFixed(1)}KB)`);
                    } else {
                        // æ•°æ®å¤ªå¤§ï¼Œç§»é™¤localStorageå¤‡ä»½
                        localStorage.removeItem('groupChats');
                        console.log(`ç¾¤èŠæ•°æ®è¿‡å¤§ (${(dataSize/1024/1024).toFixed(1)}MB)ï¼Œè·³è¿‡localStorageå¤‡ä»½ï¼Œä»…ä½¿ç”¨IndexedDB`);
                    }
                } catch (storageError) {
                    console.warn('localStorageå¤‡ä»½å¤±è´¥:', storageError);
                    // å¦‚æœæ˜¯å®¹é‡ä¸è¶³ï¼Œæ¸…ç†localStorageå¤‡ä»½
                    if (storageError.name === 'QuotaExceededError') {
                        try {
                            localStorage.removeItem('groupChats');
                            console.log('localStorageå®¹é‡ä¸è¶³ï¼Œå·²æ¸…ç†ç¾¤èŠå¤‡ä»½');
                        } catch (e) {
                            console.warn('æ¸…ç†localStorageå¤±è´¥:', e);
                        }
                    }
                }

            } catch (error) {
                console.error('ä¿å­˜ç¾¤èŠåˆ°IndexedDBå¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message);

                // å¦‚æœIndexedDBå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                try {
                    localStorage.setItem('groupChats', JSON.stringify(groupChats || []));
                    console.log('ç¾¤èŠæ•°æ®å›é€€ä¿å­˜åˆ°localStorageæˆåŠŸ');
                    showToast('ç¾¤èŠå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'info');
                } catch (localError) {
                    console.error('localStorageä¿å­˜ä¹Ÿå¤±è´¥:', localError);
                    console.error('localStorageé”™è¯¯è¯¦æƒ…:', localError.name, localError.message);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³
                    if (localError.name === 'QuotaExceededError') {
                        alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†ä¸€äº›æ•°æ®åé‡è¯•');
                    } else {
                        alert('ä¿å­˜ç¾¤èŠå¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢é‡æ–°æ“ä½œ');
                    }

                    // æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€
                    groupChats.pop(); // ç§»é™¤åˆšæ·»åŠ çš„ç¾¤èŠ
                    throw localError;
                }
            }
        }

        // æ¸²æŸ“å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        function renderScheduleTimes() {
            const container = document.getElementById('schedule-times-container');
            if (!container) return;

            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduleTimes || [];

            container.innerHTML = '';

            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)">
                    <button onclick="removeScheduleTime(${index})">Ã—</button>
                `;
                container.appendChild(timeItem);
            });
        }

        // æ·»åŠ å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        async function addScheduleTime() {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduleTimes) {
                chatSettings.scheduleTimes = [];
            }

            if (chatSettings.scheduleTimes.length >= 10) {
                alert('æœ€å¤šåªèƒ½è®¾ç½®10ä¸ªæ—¶é—´ç‚¹');
                return;
            }

            chatSettings.scheduleTimes.push('09:00');
            await saveCurrentChatSettings(chatSettings);
            renderScheduleTimes();
        }

        // æ›´æ–°å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        async function updateScheduleTime(index, newTime) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes[index] = newTime;
                await saveCurrentChatSettings(chatSettings);
            }
        }

        // ç§»é™¤å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        async function removeScheduleTime(index) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes.splice(index, 1);
                await saveCurrentChatSettings(chatSettings);
                renderScheduleTimes();
            }
        }

        // ä¿å­˜å®šæ—¶å‘å¸ƒè®¾ç½®
        async function saveScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduleEnabled = document.getElementById('schedule-enabled').checked;

            await saveCurrentChatSettings(chatSettings);
            hideModal('schedule-settings-modal');
            showToast('å®šæ—¶å‘å¸ƒè®¾ç½®å·²ä¿å­˜', 'success');
        }

        // æ˜¾ç¤ºä¸–ç•Œä¹¦æŒ‚è½½è®¾ç½®
        function showWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();

            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('worldbook-mount-enabled').checked = chatSettings.worldbookMountEnabled || false;

            // æ§åˆ¶è¯¦ç»†è®¾ç½®çš„æ˜¾ç¤º
            toggleWorldbookMountDetails();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('worldbook-mount-enabled').onchange = toggleWorldbookMountDetails;

            // æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨
            renderWorldbookMountList();

            showModal('worldbook-mount-modal');
        }

        // åˆ‡æ¢ä¸–ç•Œä¹¦æŒ‚è½½è¯¦ç»†è®¾ç½®æ˜¾ç¤º
        function toggleWorldbookMountDetails() {
            const enabled = document.getElementById('worldbook-mount-enabled').checked;
            document.getElementById('worldbook-mount-details').style.display = enabled ? 'block' : 'none';

            // æ›´æ–°ä¸»è®¾ç½®ç•Œé¢æ˜¾ç¤º
            updateWorldbookMountDisplay();
        }

        // æ›´æ–°ä¸–ç•Œä¹¦æŒ‚è½½æ˜¾ç¤ºçŠ¶æ€
        function updateWorldbookMountDisplay() {
            // å¦‚æœæ²¡æœ‰å½“å‰èŠå¤©è§’è‰²ï¼Œè·³è¿‡
            if (!currentChatCharacter) {
                console.log("æ›´æ–°ä¸–ç•Œä¹¦æŒ‚è½½æ˜¾ç¤ºï¼šæ— å½“å‰èŠå¤©è§’è‰²ï¼Œè·³è¿‡æ“ä½œ");
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const displayElement = document.getElementById('current-worldbook-mount');

            if (!displayElement) {
                console.log("æ›´æ–°ä¸–ç•Œä¹¦æŒ‚è½½æ˜¾ç¤ºï¼šæ— æ˜¾ç¤ºå…ƒç´ ï¼Œè·³è¿‡æ“ä½œ");
                return;
            }

            if (!chatSettings.worldbookMountEnabled) {
                displayElement.textContent = 'æœªæŒ‚è½½';
                return;
            }

            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            if (selectedWorldbooks.length === 0) {
                displayElement.textContent = 'å·²å¯ç”¨ä½†æœªé€‰æ‹©';
            } else if (selectedWorldbooks.length === 1) {
                const worldbook = worldbooks.find(w => w.id === selectedWorldbooks[0]);
                displayElement.textContent = worldbook ? `å·²æŒ‚è½½: ${worldbook.title}` : 'å·²æŒ‚è½½: 1ä¸ª';
            } else {
                displayElement.textContent = `å·²æŒ‚è½½: ${selectedWorldbooks.length}ä¸ª`;
            }
        }

        // æ¸²æŸ“ä¸–ç•Œä¹¦æŒ‚è½½åˆ—è¡¨
        function renderWorldbookMountList() {
            const container = document.getElementById('worldbook-mount-list');
            container.innerHTML = '';

            // è¿‡æ»¤æ‰å…¨å±€ä¸–ç•Œä¹¦ï¼Œåªæ˜¾ç¤ºå±€éƒ¨ä¸–ç•Œä¹¦
            const localWorldbooks = worldbooks.filter(w => !w.isGlobal);

            if (localWorldbooks.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">æš‚æ— å±€éƒ¨ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨ä¸–ç•Œä¹¦åº”ç”¨ä¸­åˆ›å»º</p>';
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];

            localWorldbooks.forEach(worldbook => {
                const item = document.createElement('div');
                item.className = 'mount-item worldbook-mount-item';

                const isSelected = selectedWorldbooks.includes(worldbook.id);

                item.innerHTML = `
                    <input type="checkbox" id="worldbook-${worldbook.id}" value="${worldbook.id}" ${isSelected ? 'checked' : ''} class="worldbook-checkbox">
                    <div class="worldbook-content-flex">
                        <div class="worldbook-title-text">
                            ${worldbook.title}
                        </div>
                        <div class="worldbook-desc-text">
                            ${worldbook.content.length > 100 ? worldbook.content.substring(0, 100) + '...' : worldbook.content}
                        </div>
                        <div class="worldbook-date-text">
                            åˆ›å»ºäº: ${new Date(worldbook.createdAt).toLocaleDateString('zh-CN')} |
                            å­—æ•°: ${worldbook.content.length}
                        </div>
                    </div>
                `;

                // ç‚¹å‡»æ•´ä¸ªæ¡ç›®ä¹Ÿèƒ½åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                };

                container.appendChild(item);
            });

            // æ·»åŠ æç¤ºè¯´æ˜å…¨å±€ä¸–ç•Œä¹¦è‡ªåŠ¨åº”ç”¨
            const globalInfo = document.createElement('div');
            globalInfo.className = 'worldbook-global-info';
            globalInfo.innerHTML = '<p class="global-worldbook-note">æ³¨æ„ï¼šå…¨å±€ä¸–ç•Œä¹¦å·²è‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰èŠå¤©ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‚è½½ã€‚</p>';
            container.appendChild(globalInfo);
        }

        // ä¿å­˜ä¸–ç•Œä¹¦æŒ‚è½½è®¾ç½®
        function saveWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();

            chatSettings.worldbookMountEnabled = document.getElementById('worldbook-mount-enabled').checked;

            // è·å–é€‰ä¸­çš„ä¸–ç•Œä¹¦
            const checkboxes = document.querySelectorAll('#worldbook-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedWorldbooks = Array.from(checkboxes).map(cb => cb.value);

            saveCurrentChatSettings(chatSettings);
            updateWorldbookMountDisplay();
            hideModal('worldbook-mount-modal');

            const selectedCount = chatSettings.selectedWorldbooks ? chatSettings.selectedWorldbooks.length : 0;
            if (chatSettings.worldbookMountEnabled && selectedCount > 0) {
                showToast(`ä¸–ç•Œä¹¦æŒ‚è½½è®¾ç½®å·²ä¿å­˜ï¼Œå·²æŒ‚è½½ ${selectedCount} ä¸ªä¸–ç•Œä¹¦`, 'success');
            } else if (chatSettings.worldbookMountEnabled) {
                showToast('ä¸–ç•Œä¹¦æŒ‚è½½å·²å¯ç”¨ï¼Œä½†æœªé€‰æ‹©ä»»ä½•ä¸–ç•Œä¹¦', 'info');
            } else {
                showToast('ä¸–ç•Œä¹¦æŒ‚è½½å·²å…³é—­', 'info');
            }
        }

        // èº«ä»½é€‰æ‹©å™¨åŠŸèƒ½å·²ç§»é™¤ï¼Œèº«ä»½åœ¨åˆ›å»ºå¯¹è¯æ—¶é€‰æ‹©

        // å‹ç¼©å›¾ç‰‡ä»¥å‡å°‘å­˜å‚¨ç©ºé—´
        function compressImage(dataUrl, maxWidth = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è®¡ç®—æ–°çš„å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxWidth) {
                            width = (width * maxWidth) / height;
                            height = maxWidth;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // ç»˜åˆ¶å¹¶å‹ç¼©
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                    console.log(`å›¾ç‰‡å‹ç¼©ï¼š${Math.round(dataUrl.length/1024)}KB -> ${Math.round(compressedDataUrl.length/1024)}KB`);
                    resolve(compressedDataUrl);
                };
                img.src = dataUrl;
            });
        }



        // ğŸ”¥ã€ç´§æ€¥ä¿®å¤ã€‘æ¢å¤è®¾ç½®å¹¶åˆ·æ–°ç•Œé¢
        function recoverAndRefreshSettings() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©çª—å£', 'warning');
                return;
            }

            const chatId = currentChatCharacter.id;
            console.log(`å¼€å§‹æ¢å¤èŠå¤©è®¾ç½®: ${chatId}`);
            console.log('å½“å‰è®¾ç½®çŠ¶æ€:', JSON.stringify(chatSettings[chatId], null, 2));

            // æ˜¾ç¤ºæ¢å¤è¿›åº¦
            showToast('æ­£åœ¨å°è¯•æ¢å¤è®¾ç½®...', 'info');

            // ğŸ”¥ã€ç›´æ¥æ¢å¤æ–¹æ³•ã€‘å¼ºåˆ¶ä»localStorageæ¢å¤ï¼Œä¸é€šè¿‡getCurrentChatSettings
            const savedLocalStorage = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedLocalStorage) {
                try {
                    const recoveredSettings = JSON.parse(savedLocalStorage);
                    console.log('ä»localStorageæ¢å¤çš„è®¾ç½®:', JSON.stringify(recoveredSettings, null, 2));

                    // ç›´æ¥è¦†ç›–å…¨å±€è®¾ç½®
                    chatSettings[chatId] = recoveredSettings;

                    // ç«‹å³åˆ·æ–°å½“å‰ç•Œé¢çš„æ˜¾ç¤ºï¼ˆå¦‚æœåœ¨è®¾ç½®ç•Œé¢ï¼‰
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }

                    // åˆ·æ–°èŠå¤©æ¶ˆæ¯ç•Œé¢
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }

                    showToast('è®¾ç½®æ¢å¤æˆåŠŸï¼', 'success');
                    console.log('è®¾ç½®æ¢å¤å®Œæˆï¼Œå½“å‰è®¾ç½®:', JSON.stringify(chatSettings[chatId], null, 2));
                    return;
                } catch (error) {
                    console.error('è§£ælocalStorageè®¾ç½®å¤±è´¥:', error);
                }
            }

            // å¦‚æœlocalStorageå¤±è´¥ï¼Œå°è¯•ä»IndexedDBæ¢å¤
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    console.log('ä»IndexedDBæ¢å¤çš„è®¾ç½®:', JSON.stringify(dbSettings.settings, null, 2));

                    // ç›´æ¥è¦†ç›–å…¨å±€è®¾ç½®
                    chatSettings[chatId] = dbSettings.settings;

                    // åŒæ­¥åˆ°localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));

                    // ç«‹å³åˆ·æ–°ç•Œé¢
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }

                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }

                    showToast('ä»å¤‡ä»½æ•°æ®æ¢å¤è®¾ç½®æˆåŠŸï¼', 'success');
                    console.log('ä»IndexedDBæ¢å¤è®¾ç½®æˆåŠŸ:', JSON.stringify(dbSettings.settings, null, 2));
                } else {
                    showToast('æœªæ‰¾åˆ°å¤‡ä»½æ•°æ®ï¼Œè®¾ç½®å¯èƒ½å·²æ°¸ä¹…ä¸¢å¤±', 'error');
                    console.log('æœªæ‰¾åˆ°ä»»ä½•å¤‡ä»½æ•°æ®');
                }
            }).catch(error => {
                console.error('ä»IndexedDBæ¢å¤è®¾ç½®å¤±è´¥:', error);
                showToast('æ¢å¤è®¾ç½®å¤±è´¥ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ', 'error');
            });
        }

        // ğŸ”¥ã€ç´§æ€¥ä¿®å¤ã€‘å°è¯•æ¢å¤è¢«è¦†ç›–çš„èŠå¤©è®¾ç½®
        function recoverChatSettings() {
            if (!currentChatCharacter) return false;

            const chatId = currentChatCharacter.id;
            console.log('å°è¯•æ¢å¤èŠå¤©è®¾ç½®...');

            // å°è¯•ä»localStorageæ¢å¤
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedSettings) {
                try {
                    const userSettings = JSON.parse(savedSettings);
                    chatSettings[chatId] = userSettings;
                    console.log('ä»localStorageæ¢å¤èŠå¤©è®¾ç½®æˆåŠŸ:', userSettings);
                    return true;
                } catch (error) {
                    console.error('ä»localStorageæ¢å¤è®¾ç½®å¤±è´¥:', error);
                }
            }

            // å°è¯•ä»IndexedDBæ¢å¤
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    chatSettings[chatId] = dbSettings.settings;
                    console.log('ä»IndexedDBæ¢å¤èŠå¤©è®¾ç½®æˆåŠŸ:', dbSettings.settings);
                    // åŒæ­¥åˆ°localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));
                    return true;
                }
            }).catch(error => {
                console.error('ä»IndexedDBæ¢å¤è®¾ç½®å¤±è´¥:', error);
            });

            return false;
        }

        // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
        function forceRefreshAvatars() {
            const chatSettings = getCurrentChatSettings();
            const currentAvatar = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl;

            console.log('å¼ºåˆ¶åˆ·æ–°å¤´åƒæ˜¾ç¤ºï¼Œå½“å‰å¤´åƒ:', currentAvatar ? currentAvatar.substring(0, 50) + '...' : 'æ— å¤´åƒ');

            // åˆ·æ–°èŠå¤©ç•Œé¢ä¸­æ‰€æœ‰è§’è‰²å¤´åƒ
            const messageAvatars = document.querySelectorAll('.message-avatar');
            messageAvatars.forEach(avatar => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰è§’è‰²çš„å¤´åƒï¼ˆé€šè¿‡ç‚¹å‡»äº‹ä»¶åˆ¤æ–­ï¼‰
                const onclickAttr = avatar.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${currentChatCharacter.id}'`)) {
                    if (currentAvatar && currentAvatar !== 'undefined') {
                        avatar.style.backgroundImage = `url(${currentAvatar})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.innerHTML = '';
                    } else {
                        avatar.style.backgroundImage = 'none';
                        avatar.innerHTML = currentChatCharacter.name.charAt(0);
                    }
                }
            });

            // å¦‚æœå½“å‰åœ¨å¤´åƒè®¾ç½®ç•Œé¢ï¼Œä¹Ÿåˆ·æ–°é¢„è§ˆ
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            if (aiAvatarPreview && currentAvatar && currentAvatar !== 'undefined') {
                aiAvatarPreview.style.backgroundImage = `url(${currentAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';

                // æ›´æ–°æç¤ºä¿¡æ¯
                aiAvatarPreview.title = 'å½“å‰æ˜¾ç¤ºèŠå¤©å¤´åƒï¼ˆå¯èƒ½è¢«è§’è‰²æ›´æ¢è¿‡ï¼‰';
            }
        }

        // ğŸ“Š è®¡ç®—å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0;
                let characterSize = 0;
                let settingsSize = 0;
                let emojiSize = 0;

                // è®¡ç®—èŠå¤©è®°å½•å¤§å°
                const chatMessagesData = await db.chatMessages.toArray();
                chatSize = JSON.stringify(chatMessagesData).length;

                // è®¡ç®—è§’è‰²æ•°æ®å¤§å°
                const charactersData = await db.characters.toArray();
                characterSize = JSON.stringify(charactersData).length;

                // è®¡ç®—èŠå¤©è®¾ç½®å¤§å°
                const chatSettingsData = await db.chatSettings.toArray();
                settingsSize = JSON.stringify(chatSettingsData).length;

                // è®¡ç®—è¡¨æƒ…åŒ…å¤§å°
                const emojisData = await db.customEmojis.toArray();
                emojiSize = JSON.stringify(emojisData).length;

                const total = chatSize + characterSize + settingsSize + emojiSize;

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                document.getElementById('total-storage-size').textContent = formatBytes(total);

                return { chatSize, characterSize, settingsSize, emojiSize, total };
            } catch (error) {
                console.error('è®¡ç®—å­˜å‚¨ä½¿ç”¨æƒ…å†µå¤±è´¥:', error);
                return null;
            }
        }

        // æ ¼å¼åŒ–å­—èŠ‚æ•°ä¸ºå¯è¯»æ ¼å¼
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ğŸ§¹ å‹ç¼©æ‰€æœ‰å›¾ç‰‡
        async function compressAllImages() {
            if (!confirm('å°†å‹ç¼©æ‰€æœ‰å¤´åƒå’ŒèƒŒæ™¯å›¾ç‰‡ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            showToast('æ­£åœ¨å‹ç¼©å›¾ç‰‡...', 'info');
            let compressedCount = 0;

            try {
                // å‹ç¼©è§’è‰²å¤´åƒ
                for (const character of characters) {
                    if (character.avatarUrl && character.avatarUrl.length > 50000) {
                        character.avatarUrl = await compressImage(character.avatarUrl, 150, 0.6);
                        compressedCount++;
                    }
                }
                await saveCharacters();

                // å‹ç¼©èŠå¤©è®¾ç½®ä¸­çš„å¤´åƒ
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.chatBackground && settings.chatBackground.length > 100000) {
                            settings.chatBackground = await compressImage(settings.chatBackground, 800, 0.7);
                            compressedCount++;
                        }
                    }
                }
                await saveChatSettings();

                // æ›´æ–°å­˜å‚¨ä½¿ç”¨æƒ…å†µ
                calculateStorageUsage();

                showToast(`å›¾ç‰‡å‹ç¼©å®Œæˆï¼å…±å¤„ç†äº† ${compressedCount} å¼ å›¾ç‰‡`, 'success');
            } catch (error) {
                console.error('å‹ç¼©å›¾ç‰‡å¤±è´¥:', error);
                showToast('å‹ç¼©è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
            }
        }

        // ğŸ§¹ æ—§ç‰ˆæ¸…ç†å­˜å‚¨ç©ºé—´ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        async function cleanupStorageSpace() {
            if (!confirm('å°†æ¸…ç†ä»¥ä¸‹æ•°æ®ä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼š\n\nâ€¢ æ‰€æœ‰è§’è‰²çš„åŠ¨æ€å¤´åƒ\nâ€¢ localStorageä¸­çš„è¿‡æœŸæ•°æ®\nâ€¢ å‹ç¼©ç°æœ‰å¤´åƒæ•°æ®\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            showToast('æ­£åœ¨æ¸…ç†å­˜å‚¨ç©ºé—´...', 'info');
            let cleanedSize = 0;
            let cleanedItems = 0;

            try {
                // 1. æ¸…é™¤æ‰€æœ‰AIèŠå¤©å¤´åƒ
                Object.keys(chatSettings).forEach(chatId => {
                    if (chatSettings[chatId] && chatSettings[chatId].aiChatAvatar) {
                        delete chatSettings[chatId].aiChatAvatar;
                        cleanedItems++;
                    }
                });

                // 2. æ¸…ç†localStorageä¸­çš„è¿‡æœŸchatSettings
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('chatSettings_')) {
                        const value = localStorage.getItem(key);
                        if (value) {
                            cleanedSize += value.length;
                            localStorage.removeItem(key);
                            cleanedItems++;
                        }
                    }
                }

                // 3. å‹ç¼©æ‰€æœ‰ç°æœ‰å¤´åƒæ•°æ®
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                    }
                }

                // 4. é‡æ–°ä¿å­˜å‹ç¼©åçš„è®¾ç½®åˆ°IndexedDB
                await saveChatSettings();

                // 5. åˆ·æ–°å½“å‰ç•Œé¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }

                const sizeKB = Math.round(cleanedSize / 1024);
                showToast(`æ¸…ç†å®Œæˆï¼é‡Šæ”¾äº†çº¦ ${sizeKB}KB ç©ºé—´ï¼Œå¤„ç†äº† ${cleanedItems} é¡¹æ•°æ®`, 'success');

            } catch (error) {
                console.error('æ¸…ç†å­˜å‚¨ç©ºé—´å¤±è´¥:', error);
                showToast('æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ¸…é™¤AIèŠå¤©å¤´åƒ
        function clearAiChatAvatar() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            if (chatSettings.aiChatAvatar) {
                delete chatSettings.aiChatAvatar;
                saveCurrentChatSettings(chatSettings);

                // åˆ·æ–°èŠå¤©ç•Œé¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }

                // åˆ·æ–°è®¾ç½®ç•Œé¢é¢„è§ˆ
                forceRefreshAvatars();

                showToast('å·²æ¸…é™¤èŠå¤©å¤´åƒï¼Œæ¢å¤ä¸ºè§’è‰²å¡é»˜è®¤å¤´åƒ', 'success');
            } else {
                showToast('æ²¡æœ‰èŠå¤©å¤´åƒéœ€è¦æ¸…é™¤', 'info');
            }
        }

        // ä¿å­˜èŠå¤©èº«ä»½é€‰æ‹©
        function saveChatIdentity() {
            if (!window.selectedChatIdentityId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªèº«ä»½');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const selectedPersona = personas.find(p => p.id === window.selectedChatIdentityId);

            if (selectedPersona) {
                chatSettings.selectedIdentityId = selectedPersona.id;

                // å¦‚æœé€‰ä¸­çš„èº«ä»½æœ‰å¤´åƒï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºèŠå¤©å¤´åƒï¼ˆå¦‚æœå½“å‰æ²¡æœ‰è®¾ç½®çš„è¯ï¼‰
                if (selectedPersona.avatarUrl && !chatSettings.myChatAvatar) {
                    chatSettings.myChatAvatar = selectedPersona.avatarUrl;
                }

                // å¦‚æœé€‰ä¸­çš„èº«ä»½æœ‰åç§°ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºèŠå¤©æ˜µç§°ï¼ˆå¦‚æœå½“å‰æ²¡æœ‰è®¾ç½®çš„è¯ï¼‰
                if (selectedPersona.name && !chatSettings.myChatNickname) {
                    chatSettings.myChatNickname = selectedPersona.name;
                }

                saveCurrentChatSettings(chatSettings);

                // æ›´æ–°æ˜¾ç¤º
                updateChatIdentityDisplay();

                // åˆ·æ–°èŠå¤©ç•Œé¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }

                hideModal('identity-selector-modal');
                showToast(`å·²é€‰æ‹©èº«ä»½"${selectedPersona.name}"`, 'success');
            }
        }

        // æ›´æ–°èŠå¤©èº«ä»½æ˜¾ç¤º
        async function updateChatIdentityDisplay() {
            // å¦‚æœæ²¡æœ‰å½“å‰èŠå¤©è§’è‰²ï¼Œå°±ä¸æ‰§è¡Œåç»­æ“ä½œ
            if (!currentChatCharacter) {
                console.log("æ›´æ–°èŠå¤©èº«ä»½æ˜¾ç¤ºï¼šæ— å½“å‰èŠå¤©è§’è‰²ï¼Œè·³è¿‡æ“ä½œ");
                return;
            }

            const chatSettings = await getAsyncChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            const selectedPersona = personas.find(p => p.id === selectedIdentityId);

            const displayElement = document.getElementById('current-chat-identity');
            if (displayElement && selectedPersona) {
                displayElement.textContent = selectedPersona.name;
            }
        }

        // æ›´æ–°æ°”æ³¡æ ·å¼æ˜¾ç¤º
        async function updateBubbleStyleDisplay() {
            // å¦‚æœæ²¡æœ‰å½“å‰èŠå¤©è§’è‰²ï¼Œå°±ä¸æ‰§è¡Œåç»­æ“ä½œ
            if (!currentChatCharacter) {
                console.log("æ›´æ–°æ°”æ³¡æ ·å¼æ˜¾ç¤ºï¼šæ— å½“å‰èŠå¤©è§’è‰²ï¼Œè·³è¿‡æ“ä½œ");
                return;
            }

            const chatSettings = await getAsyncChatSettings();
            const styleNames = {
                'default': 'é»˜è®¤æ ·å¼',
                'shadow': 'ç»å…¸é˜´å½±',
                'tail': 'ç»å…¸æ°”æ³¡',
                'paper': 'çº¸å¼ æ ·å¼'
            };

            const displayElement = document.getElementById('current-bubble-style');
            if (displayElement) {
                const currentStyle = chatSettings.bubbleStyle || 'default';
                displayElement.textContent = styleNames[currentStyle] || 'é»˜è®¤æ ·å¼';
            }
        }

        // å…¨å±€å¤´åƒä¸Šä¼ å¤„ç†å‡½æ•°
        function handleAvatarUploadClick() {
            console.log('ç‚¹å‡»äº†ä¸Šä¼ å¤´åƒæŒ‰é’®');
            const input = document.getElementById('avatar-upload');
            if (input) {
                console.log('æ‰¾åˆ°äº†inputå…ƒç´ ï¼Œå‡†å¤‡è§¦å‘ç‚¹å‡»');
                input.click();
            } else {
                console.error('æ‰¾ä¸åˆ°avatar-uploadå…ƒç´ ');
                alert('æ‰¾ä¸åˆ°æ–‡ä»¶ä¸Šä¼ å…ƒç´ ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // è¯¥å‡½æ•°å·²è¢«åˆ é™¤ï¼Œä½¿ç”¨ä¸Šé¢çš„å¼‚æ­¥IndexedDBç‰ˆæœ¬

        // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ æ¶ˆæ¯é•¿æŒ‰ç›‘å¬å™¨ - æ”¯æŒæ‰‹æœºç«¯èœå•æ“ä½œ
        function addMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;
            let startPos = { x: 0, y: 0 };

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                             'ontouchstart' in window ||
                             navigator.maxTouchPoints > 0;

            const startLongPress = (e) => {
                if (isMessageSelectionMode) {
                    // åœ¨é€‰æ‹©æ¨¡å¼ä¸‹ï¼Œåªå¤„ç†ç‚¹å‡»é€‰æ‹©ï¼Œä¸å¤„ç†é•¿æŒ‰
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘è®°å½•èµ·å§‹ä½ç½®ï¼Œç”¨äºæ£€æµ‹ç§»åŠ¨
                const touch = e.touches ? e.touches[0] : e;
                startPos.x = touch.clientX;
                startPos.y = touch.clientY;

                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ è§¦è§‰åé¦ˆï¼ˆç§»åŠ¨ç«¯ï¼‰
                    if (navigator.vibrate && isMobile) {
                        navigator.vibrate(50);
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘æ‰‹æœºç«¯æ˜¾ç¤ºæ“ä½œèœå•ï¼Œæ¡Œé¢ç«¯è¿›å…¥å¤šé€‰æ¨¡å¼
                    if (isMobile) {
                        showMobileMessageMenu(messageId, e);
                    } else {
                        enterMessageSelectionMode(messageId);
                    }
                }, isMobile ? 600 : 800); // ç§»åŠ¨ç«¯æ›´çŸ­çš„é•¿æŒ‰æ—¶é—´
            };

            const cancelLongPress = (e) => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘å»¶è¿Ÿé‡ç½®é•¿æŒ‰æ ‡è®°ï¼Œé¿å…ç«‹å³è§¦å‘ç‚¹å‡»
                setTimeout(() => {
                    isLongPress = false;
                }, 100);
            };

            const checkMove = (e) => {
                if (!pressTimer) return;

                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æµ‹ç§»åŠ¨è·ç¦»ï¼Œå¦‚æœç§»åŠ¨è¶…è¿‡é˜ˆå€¼åˆ™å–æ¶ˆé•¿æŒ‰
                const touch = e.touches ? e.touches[0] : e;
                const moveX = Math.abs(touch.clientX - startPos.x);
                const moveY = Math.abs(touch.clientY - startPos.y);

                if (moveX > 10 || moveY > 10) {
                    cancelLongPress(e);
                }
            };

            const handleClick = (e) => {
                // åœ¨é€‰æ‹©æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥ç‚¹å‡»åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                if (isMessageSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMessageSelection(messageId);
                    return;
                }

                // å¦‚æœæ˜¯é•¿æŒ‰è§¦å‘åçš„ç‚¹å‡»ï¼Œä¸å¤„ç†
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            };

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜åŒ–äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ­£å¸¸å·¥ä½œ
            if (isMobile) {
                // ç§»åŠ¨ç«¯ä½¿ç”¨è§¦æ‘¸äº‹ä»¶
                messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
                messageContainer.addEventListener('touchend', cancelLongPress, { passive: false });
                messageContainer.addEventListener('touchmove', checkMove, { passive: false });
                messageContainer.addEventListener('touchcancel', cancelLongPress, { passive: false });
            } else {
                // æ¡Œé¢ç«¯ä½¿ç”¨é¼ æ ‡äº‹ä»¶
                messageContainer.addEventListener('mousedown', startLongPress);
                messageContainer.addEventListener('mouseup', cancelLongPress);
                messageContainer.addEventListener('mouseleave', cancelLongPress);
                messageContainer.addEventListener('mousemove', checkMove);
            }

            // ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿ä¼˜å…ˆå¤„ç†
            messageContainer.addEventListener('click', handleClick, true);
        }

        // ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘æ˜¾ç¤ºæ¶ˆæ¯ä¸Šæ–¹æŒ‰é’®æ¡
        function showMobileMessageMenu(messageId, event) {
            console.log('ç§»åŠ¨ç«¯é•¿æŒ‰èœå•ï¼ŒmessageId:', messageId);
            selectedMessageId = messageId;

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === messageId);
            const isUserMessage = message && message.sender === 'sent';

            // éšè—å·²å­˜åœ¨çš„æŒ‰é’®æ¡
            hideMessageActionBar();

            // æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å®¹å™¨
            const messageContainer = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageContainer) {
                console.log('é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨');
                return;
            }
            console.log('æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨:', messageContainer);

            // åˆ›å»ºæŒ‰é’®æ¡
            const actionBar = document.createElement('div');
            actionBar.className = 'message-action-bar';
            actionBar.id = 'message-action-bar';

            // æ„å»ºæŒ‰é’®åˆ—è¡¨
            const buttons = ['å¼•ç”¨', 'å¤åˆ¶'];

            // ğŸ”¥ã€æ–°å¢ã€‘åªæœ‰AIè§’è‰²æ¶ˆæ¯æ‰æ˜¾ç¤ºå¿ƒå£°é€‰é¡¹
            if (!isUserMessage) {
                buttons.push('å¿ƒå£°');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ‰€æœ‰æ¶ˆæ¯éƒ½å¯ä»¥ç¼–è¾‘ï¼Œç”¨æˆ·æ¶ˆæ¯å¯ä»¥æ’¤å›
            buttons.push('ç¼–è¾‘');

            if (isUserMessage) {
                buttons.push('æ’¤å›');
            }
            buttons.push('å¤šé€‰');

            actionBar.innerHTML = buttons.map(text => {
                let action = '';
                switch(text) {
                    case 'å¼•ç”¨': action = `replyToMessage('${messageId}')`; break;
                    case 'å¤åˆ¶': action = `copyMessage('${messageId}')`; break;
                    case 'å¿ƒå£°': action = `showInnerThoughtsModal('${messageId}')`; break;
                    case 'ç¼–è¾‘': action = `showEditMessageModal('${messageId}')`; break;
                    case 'æ’¤å›': action = `deleteMessage('${messageId}')`; break;
                    case 'å¤šé€‰': action = `enterMessageSelectionMode('${messageId}')`; break;
                }
                return `<button class="message-action-btn" onclick="${action}; hideMessageActionBar();">${text}</button>`;
            }).join('');

            // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            messageContainer.appendChild(actionBar);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                actionBar.classList.add('show');
            }, 10);

            // æ·»åŠ å…¨å±€ç‚¹å‡»ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', hideMessageActionBarOnClickOutside);
                document.addEventListener('touchstart', hideMessageActionBarOnClickOutside);
            }, 100);
        }

        // ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘éšè—æ¶ˆæ¯æŒ‰é’®æ¡
        function hideMessageActionBar() {
            const actionBar = document.getElementById('message-action-bar');
            if (actionBar) {
                actionBar.classList.remove('show');
                setTimeout(() => {
                    if (actionBar.parentNode) {
                        actionBar.parentNode.removeChild(actionBar);
                    }
                }, 300);
            }
            selectedMessageId = null;

            // ç§»é™¤å…¨å±€ç‚¹å‡»ç›‘å¬å™¨
            document.removeEventListener('click', hideMessageActionBarOnClickOutside);
            document.removeEventListener('touchstart', hideMessageActionBarOnClickOutside);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç‚¹å‡»å¤–éƒ¨éšè—æŒ‰é’®æ¡
        function hideMessageActionBarOnClickOutside(event) {
            const actionBar = document.getElementById('message-action-bar');
            if (actionBar && !actionBar.contains(event.target)) {
                hideMessageActionBar();
            }
        }

        // ğŸ”¥ã€å…¼å®¹ã€‘ä¿æŒæ—§å‡½æ•°å
        function hideMobileMessageMenu() {
            hideMessageActionBar();
        }

        // è¿›å…¥æ¶ˆæ¯é€‰æ‹©æ¨¡å¼
        function enterMessageSelectionMode(initialMessageId) {
            if (isMessageSelectionMode) {
                return;
            }

            isMessageSelectionMode = true;
            selectedMessages.clear();
            selectedMessages.add(initialMessageId);

            // æ·»åŠ é€‰æ‹©æ¨¡å¼CSSç±»
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.add('selection-mode');
            }

            updateMessageSelectionUI();
        }

        // åˆ‡æ¢æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
        function toggleMessageSelection(messageId) {
            if (!isMessageSelectionMode) return;

            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }

            updateMessageSelectionUI();

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ¶ˆæ¯ï¼Œé€€å‡ºé€‰æ‹©æ¨¡å¼
            if (selectedMessages.size === 0) {
                exitMessageSelectionMode();
            }
        }

        // é€€å‡ºæ¶ˆæ¯é€‰æ‹©æ¨¡å¼
        function exitMessageSelectionMode() {
            if (!isMessageSelectionMode) return;

            isMessageSelectionMode = false;

            // ç§»é™¤é€‰æ‹©æ¨¡å¼CSSç±»
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('selection-mode');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€ï¼ŒåŒ…æ‹¬æ’¤å›æ¶ˆæ¯
            const selectedContainers = document.querySelectorAll('[data-message-id].selected');
            selectedContainers.forEach(container => {
                container.classList.remove('selected');
            });

            selectedMessages.clear();
            updateMessageSelectionUI();
        }



        // æ›´æ–°æ¶ˆæ¯é€‰æ‹©UI
        function updateMessageSelectionUI() {
            // ğŸ”¥ã€ä¿®å¤ã€‘æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰messageIdçš„å®¹å™¨ï¼ŒåŒ…æ‹¬æ’¤å›æ¶ˆæ¯
            const allContainers = document.querySelectorAll('[data-message-id]');

            allContainers.forEach(container => {
                const messageId = container.dataset.messageId;
                if (messageId) {
                    if (selectedMessages.has(messageId)) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });

            // æ›´æ–°é€‰æ‹©è®¡æ•°æ˜¾ç¤º
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `å·²é€‰ ${selectedMessages.size} æ¡`;
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘é˜²æ­¢é‡å¤åˆ é™¤æ“ä½œçš„æ ‡å¿—
        let isDeletingMessages = false;

        // åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
        async function deleteSelectedMessages() {
            // é˜²æ­¢é‡å¤æ“ä½œ
            if (isDeletingMessages) {
                console.log('åˆ é™¤æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            if (selectedMessages.size === 0) return;

            if (!currentChatCharacter) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                isDeletingMessages = true; // è®¾ç½®åˆ é™¤æ ‡å¿—
                const characterId = currentChatCharacter.id;

                if (chatMessages[characterId]) {
                    // ğŸ”¥ã€é«˜æ•ˆåˆ é™¤ã€‘ç›´æ¥åœ¨æ•°æ®åº“ä¸­åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        const messagesToDelete = [];
                        chatMessages[characterId].forEach(message => {
                            if (selectedMessages.has(message.id)) {
                                messagesToDelete.push(message);
                            }
                        });

                        // æ¸…ç†æ¯æ¡è¢«åˆ é™¤æ¶ˆæ¯çš„æ—¶é—´çº¿è®°å½•
                        for (const message of messagesToDelete) {
                            try {
                                await deleteRelatedTimelineEvents(message);
                                // ğŸ”¥ã€ä¿®å¤ã€‘å®‰å…¨å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒå­—ç¬¦ä¸²å’Œå¯¹è±¡ç±»å‹
                                const contentPreview = typeof message.content === 'string'
                                    ? message.content.substring(0, 30)
                                    : (message.content?.text || message.content?.message || '[å¤æ‚æ¶ˆæ¯]');
                                console.log(`ğŸ—‘ï¸ å·²æ¸…ç†æ¶ˆæ¯çš„æ—¶é—´çº¿è®°å½•: ${contentPreview}...`);
                            } catch (error) {
                                console.error('æ¸…ç†æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
                            }
                        }

                        // ğŸ”¥ã€å…³é”®ä¼˜åŒ–ã€‘ç›´æ¥ä»æ•°æ®åº“åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
                        const dbMessagesToDelete = [];
                        for (const message of messagesToDelete) {
                            const dbMessage = await db.chatMessages
                                .where('characterId').equals(characterId)
                                .and(msg => msg.originalMessageId === message.id)
                                .first();
                            if (dbMessage) {
                                dbMessagesToDelete.push(dbMessage.id);
                            }
                        }

                        if (dbMessagesToDelete.length > 0) {
                            await db.chatMessages.bulkDelete(dbMessagesToDelete);
                            console.log(`âœ… [é«˜æ•ˆåˆ é™¤] æ•°æ®åº“åˆ é™¤äº† ${dbMessagesToDelete.length} æ¡æ¶ˆæ¯`);
                        }

                        // æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯ï¼ˆè¿‡æ»¤æ‰åˆ é™¤çš„æ¶ˆæ¯ï¼‰
                        chatMessages[characterId] = chatMessages[characterId].filter(message => {
                            return !selectedMessages.has(message.id);
                        });

                        // åˆ·æ–°UIï¼ˆä¸è°ƒç”¨saveChatMessagesï¼Œé¿å…å“ˆå¸Œæ£€æµ‹ï¼‰
                        renderChatMessages(characterId);
                        renderMessageList(); // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨

                    } catch (error) {
                        console.error('é«˜æ•ˆåˆ é™¤å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹å¼:', error);
                        // å›é€€åˆ°åŸæœ‰çš„åˆ é™¤æ–¹å¼
                        chatMessages[characterId] = chatMessages[characterId].filter(message => {
                            return !selectedMessages.has(message.id);
                        });
                        saveChatMessages();
                        renderChatMessages(characterId);
                        renderMessageList();
                    }
                }

                // é€€å‡ºé€‰æ‹©æ¨¡å¼
                exitMessageSelectionMode();

                // ğŸ”¥ã€ä¿®å¤ã€‘é‡ç½®åˆ é™¤æ ‡å¿—ï¼Œå…è®¸åç»­åˆ é™¤æ“ä½œ
                isDeletingMessages = false;
            } else {
                // ğŸ”¥ã€ä¿®å¤ã€‘ç”¨æˆ·å–æ¶ˆåˆ é™¤æ—¶ä¹Ÿè¦é‡ç½®æ ‡å¿—
                isDeletingMessages = false;
            }
        }

        // æ‚¬æµ®æŒ‰é’®åŠŸèƒ½
        // å˜é‡æ§åˆ¶ç­‰å¾…å›å¤çŠ¶æ€
        let isWaitingForReply = false;
        let pendingUserMessage = null;

      // ç”¨è¿™æ®µæ–°ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ regenerateLastResponse å‡½æ•°
        async function regenerateLastResponse() {
            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (window._isRegenerating) {
                console.log('é‡æ–°ç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                return;
            }
            window._isRegenerating = true;

            const characterId = currentChatCharacter.id;
            const messages = chatMessages[characterId] || [];

            // æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯åŠå…¶å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            let lastAiMessageIndex = -1;
            let lastUserMessageIndex = -1;

            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received' && lastAiMessageIndex === -1) {
                    lastAiMessageIndex = i;
                }
                if (lastAiMessageIndex !== -1 && messages[i].sender === 'sent' && lastUserMessageIndex === -1) {
                    lastUserMessageIndex = i;
                    break;
                }
            }

            if (lastAiMessageIndex === -1) {
                alert('æ²¡æœ‰æ‰¾åˆ°AIå›å¤å¯ä»¥é‡æ–°ç”Ÿæˆ');
                return;
            }

            if (lastUserMessageIndex === -1) {
                alert('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯');
                return;
            }

            const userMessage = messages[lastUserMessageIndex];

            // åˆ é™¤ä»æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åçš„æ‰€æœ‰AIæ¶ˆæ¯
            chatMessages[characterId] = messages.slice(0, lastUserMessageIndex + 1);
            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘æ‰¹é‡åˆ é™¤AIæ¶ˆæ¯ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const messagesToDelete = [];
                for (let i = lastUserMessageIndex + 1; i < messages.length; i++) {
                    const message = messages[i];
                    const dbMessage = await db.chatMessages
                        .where('characterId').equals(characterId)
                        .and(msg => msg.originalMessageId === message.id)
                        .first();
                    if (dbMessage) {
                        messagesToDelete.push(dbMessage.id);
                    }
                }

                if (messagesToDelete.length > 0) {
                    await db.chatMessages.bulkDelete(messagesToDelete);
                    console.log(`âœ… [é«˜æ•ˆé‡æ–°ç”Ÿæˆ] åˆ é™¤äº† ${messagesToDelete.length} æ¡AIæ¶ˆæ¯`);
                }
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆåˆ é™¤æ¶ˆæ¯å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                await saveChatMessages();
            }
            await renderChatMessagesAsync(characterId);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿åœ¨renderChatMessageså®Œæˆåå†æ˜¾ç¤ºtyping-indicator
            console.log('ğŸ”§ [regenerateLastResponse] å‡†å¤‡æ˜¾ç¤ºtyping-indicator');
            // æ·»åŠ å°å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°å®Œæˆ
            await new Promise(resolve => {
                setTimeout(() => {
                    showTypingIndicator();
                    resolve();
                }, 100);
            });

            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                let response;

                // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æ–°çš„å¤šæ¨¡æ€å¤„ç†é€»è¾‘
                console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] ç”¨æˆ·æ¶ˆæ¯ç»“æ„:', userMessage);
                console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] æ˜¯å¦æœ‰imageå­—æ®µ:', !!userMessage.image);
                console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…:', userMessage.isEmoji);
                console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] contentæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(userMessage.content));

                if (Array.isArray(userMessage.content)) {
                    // è¿™æ˜¯å¤šæ¨¡æ€æ¶ˆæ¯ï¼ˆå›¾æ–‡ï¼‰
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] èµ°å¤šæ¨¡æ€åˆ†æ”¯');

                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥å¤šæ¨¡æ€æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…
                    const hasImage = userMessage.content.some(item => item.type === 'image_url');
                    const isEmojiMessage = userMessage.originalMessages?.some(msg => msg.isEmoji);

                    console.log('ğŸ” [å¤šæ¨¡æ€è°ƒè¯•] åŒ…å«å›¾ç‰‡:', hasImage);
                    console.log('ğŸ” [å¤šæ¨¡æ€è°ƒè¯•] æ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯:', isEmojiMessage);
                    console.log('ğŸ” [å¤šæ¨¡æ€è°ƒè¯•] è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½®:', apiSettings.emojiRecognitionEnabled);

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                    const emojiMsg = userMessage.originalMessages?.find(msg => msg.isEmoji);
                    const isGifEmoji = emojiMsg?.image?.includes('data:image/gif') || emojiMsg?.url?.includes('data:image/gif');

                    console.log('ğŸ” [åŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                    if (hasImage && isEmojiMessage && (apiSettings.emojiRecognitionEnabled === false || isGifEmoji)) {
                        // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                        const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                        const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${emojiMsg?.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                        console.log(`ğŸ” [å¤šæ¨¡æ€ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                        response = await callChatAPI(emojiPrompt, currentChatCharacter);
                    } else {
                        response = await callChatAPI(userMessage.content, currentChatCharacter);
                    }
                } else if (userMessage.image) {
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] èµ°å›¾ç‰‡åˆ†æ”¯');

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                    const isGifEmoji = userMessage.isEmoji && userMessage.image?.includes('data:image/gif');
                    console.log('ğŸ” [å›¾ç‰‡åˆ†æ”¯åŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦è¯†åˆ«è¡¨æƒ…åŒ…
                    if (userMessage.isEmoji && (apiSettings.emojiRecognitionEnabled === false || isGifEmoji)) {
                        // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                        const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                        const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${userMessage.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                        console.log(`ğŸ” [å›¾ç‰‡åˆ†æ”¯ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                        response = await callChatAPI(emojiPrompt, currentChatCharacter);
                    } else {
                        // æ™®é€šå›¾ç‰‡æˆ–å¯ç”¨äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œå‘é€å›¾ç‰‡
                        const messageContent = [
                            { type: 'text', text: userMessage.content || "" },
                            { type: 'image_url', image_url: { url: userMessage.image } }
                        ];
                        console.log('ğŸ” [è¡¨æƒ…åŒ…è°ƒè¯•] å‘é€ç»™AIçš„æ¶ˆæ¯å†…å®¹:', messageContent);
                        console.log('ğŸ” [è¡¨æƒ…åŒ…è°ƒè¯•] è¡¨æƒ…åŒ…URL:', userMessage.image);
                        console.log('ğŸ” [è¡¨æƒ…åŒ…è°ƒè¯•] æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…:', userMessage.isEmoji);
                        response = await callChatAPI(messageContent, currentChatCharacter);
                    }
                } else if (userMessage.type === 'transfer') {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è½¬è´¦æ¶ˆæ¯ç‰¹æ®Šå¤„ç† - æ„é€ è½¬è´¦æç¤ºæ–‡æœ¬
                    const transferPrompt = `[ç”¨æˆ·å‘èµ·äº†è½¬è´¦ï¼š${userMessage.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${userMessage.note || 'æ— '}]`;
                    response = await callChatAPI(transferPrompt, currentChatCharacter);
                } else {
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] èµ°æ™®é€šæ–‡æœ¬åˆ†æ”¯');
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] userMessageå®Œæ•´ç»“æ„:', userMessage);
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] userMessage.imageå­˜åœ¨å—:', !!userMessage.image);
                    console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] userMessage.isEmojiå€¼:', userMessage.isEmoji);

                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯ä½†contentä¸ºç©ºçš„æƒ…å†µ
                    if (userMessage.image && userMessage.isEmoji) {
                        console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] æ£€æµ‹åˆ°è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼Œé‡æ–°è·¯ç”±åˆ°å›¾ç‰‡å¤„ç†');
                        console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] è¡¨æƒ…åŒ…URL:', userMessage.image);
                        console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] è¡¨æƒ…åŒ…æè¿°:', userMessage.emojiDescription);
                        console.log('ğŸ” [AIå¤„ç†è°ƒè¯•] è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½®:', apiSettings.emojiRecognitionEnabled);

                        // è¡¨æƒ…åŒ…æ¶ˆæ¯åº”è¯¥èµ°å›¾ç‰‡å¤„ç†åˆ†æ”¯
                        console.log('ğŸ” [è¡¨æƒ…åŒ…å¼€å…³è°ƒè¯•] apiSettings:', apiSettings);
                        console.log('ğŸ” [è¡¨æƒ…åŒ…å¼€å…³è°ƒè¯•] emojiRecognitionEnabledå€¼:', apiSettings.emojiRecognitionEnabled);

                        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                        const isGifEmoji = userMessage.image?.includes('data:image/gif');
                        console.log('ğŸ” [elseåˆ†æ”¯åŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                        if (apiSettings.emojiRecognitionEnabled === false || isGifEmoji) {
                            // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                            const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                            const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${userMessage.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                            console.log(`ğŸ” [elseåˆ†æ”¯ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                            response = await callChatAPI(emojiPrompt, currentChatCharacter);
                        } else {
                            // æ™®é€šå›¾ç‰‡æˆ–å¯ç”¨äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œå‘é€å›¾ç‰‡
                            const messageContent = [
                                { type: 'text', text: userMessage.content || "" },
                                { type: 'image_url', image_url: { url: userMessage.image } }
                            ];
                            console.log('ğŸ” [è¡¨æƒ…åŒ…ä¿®å¤] å‘é€ç»™AIçš„æ¶ˆæ¯å†…å®¹:', messageContent);
                            console.log('ğŸ” [è¡¨æƒ…åŒ…ä¿®å¤] å›¾ç‰‡URLé•¿åº¦:', userMessage.image?.length);
                            response = await callChatAPI(messageContent, currentChatCharacter);
                        }
                    } else {
                        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                        let finalPrompt = userMessage.content; // é»˜è®¤ä½¿ç”¨åŸå§‹æ¶ˆæ¯å†…å®¹

                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯æ˜¯å¦ä¸ºå¼•ç”¨å›å¤
                        if (userMessage.replyTo) {
                            const quoteText = summarizeLastMessage({ content: userMessage.replyTo.content });
                            finalPrompt = `[å›å¤ ${userMessage.replyTo.senderName} çš„æ¶ˆæ¯: "${quoteText}"] ${userMessage.content}`;
                            console.log('âœ… [é‡æ–°ç”Ÿæˆ] æ„å»ºç”¨æˆ·å¼•ç”¨æç¤º:', finalPrompt);
                        }

                        response = await callChatAPI(finalPrompt, currentChatCharacter);
                    }
                }
                const aiMessages = await parseAiResponse(response);

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸è¦åœ¨è¿™é‡Œç«‹å³éšè—"æ­£åœ¨è¾“å…¥ä¸­"ï¼Œè®©æ¯æ¡æ¶ˆæ¯å¤„ç†æ—¶æ§åˆ¶

                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;

                    console.log('ğŸ” [callChatAPI] å¤„ç†æ¶ˆæ¯:', i, msgData);

            if (typeof msgData === 'object' && msgData !== null) {
                if (msgData.type === 'voice_message') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'voice_message', content: msgData.content, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'ai_image') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'ai_image', content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡', imageDescription: msgData.description, timestamp: Date.now() + i * 100 };

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                    if (msgData.name) {
                        console.log('ğŸ” [callChatAPI-AIå›¾ç‰‡] æ£€æµ‹åˆ°ç¾¤èŠæ¶ˆæ¯ï¼Œå‘é€è€…:', msgData.name);
                        aiMessage.name = msgData.name;
                        // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                        if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                aiMessage.senderId = member.id;
                                console.log('ğŸ” [callChatAPI-AIå›¾ç‰‡] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', member.id);
                            } else {
                                console.log('ğŸ” [callChatAPI-AIå›¾ç‰‡] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                            }
                        }
                    }
                } else if (msgData.type === 'transfer') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'poke') {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³
                    console.log('ğŸ” [callChatAPI-ç¬¬äºŒå¤„] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', msgData);
                    const chatSettings = getCurrentChatSettings();
                    const userNickname = chatSettings.myChatNickname || 'ä½ ';
                    const pokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘AIæˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix

                    aiMessage = {
                        id: (Date.now() + i).toString(),
                        sender: 'system',
                        content: `${currentChatCharacter.name}æˆ³äº†æˆ³${userNickname}${pokeSuffix}`,
                        timestamp: Date.now() + i * 100,
                        isPoke: true
                    };
                } else if (msgData.type === 'payment_request') {
                    // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå¿½ç•¥
                    console.log('ğŸ›’ [AIä»£ä»˜è¯·æ±‚-æ—©æœŸåˆ†æ”¯] AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥:', msgData);
                    aiMessage = null;
                } else if (msgData.type === 'emoji' && !msgData.name) {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯ - ä»…å¤„ç†æ²¡æœ‰nameå­—æ®µçš„è¡¨æƒ…åŒ…ï¼ˆéç¾¤èŠæ ¼å¼ï¼‰
                    console.log('ğŸ” [callChatAPI] è¿›å…¥å•èŠè¡¨æƒ…åŒ…åˆ†æ”¯:', msgData);
                    const matchingEmoji = await findEmojiForAI(msgData.description);
                    if (matchingEmoji) {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: matchingEmoji.url,
                            isEmoji: true,
                            emojiDescription: matchingEmoji.description,
                            timestamp: Date.now() + i * 100
                        };

                        // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                    } else {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                            timestamp: Date.now() + i * 100
                        };
                    }
                } else if (msgData.type === 'recall_previous') {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIæ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯
                    console.log('ğŸ”¥ AIè¯·æ±‚æ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯:', msgData);

                    // æŸ¥æ‰¾ä¸Šä¸€æ¡AIæ¶ˆæ¯
                    const allMessages = chatMessages[currentChatCharacter.id] || [];
                    let lastAIMessageIndex = -1;

                    for (let j = allMessages.length - 1; j >= 0; j--) {
                        if (allMessages[j].sender === 'received') {
                            lastAIMessageIndex = j;
                            break;
                        }
                    }

                    if (lastAIMessageIndex !== -1) {
                        const messageToRecall = allMessages[lastAIMessageIndex];
                        console.log('ğŸ”¥ æ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯:', messageToRecall);

                        // è°ƒç”¨æ’¤å›æ¶ˆæ¯å¤„ç†å‡½æ•°
                        await handleRecalledMessage(messageToRecall.content, messageToRecall.id);
                    } else {
                        console.warn('ğŸ”¥ æ²¡æœ‰æ‰¾åˆ°å¯æ’¤å›çš„AIæ¶ˆæ¯');
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸€æ¡æç¤º
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '[AIæ’¤å›äº†ä¸Šä¸€æ¡æ¶ˆæ¯]',
                            timestamp: Date.now() + i * 100
                        };
                    }
                    continue; // è·³è¿‡æ­£å¸¸çš„æ¶ˆæ¯å¤„ç†æµç¨‹
                } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆå¤„ç†å ä½ç¬¦æ›¿æ¢ï¼Œå†éªŒè¯å’Œæ‰§è¡Œå¤´åƒæ›´æ¢
                            let actualAvatarUrl = msgData.avatar_url;
                            if (msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                                msgData.avatar_url === 'å›¾ç‰‡URL') {
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    actualAvatarUrl = recentUserImage;
                                } else {
                                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[æ— æ³•æ›´æ¢å¤´åƒï¼Œæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡]', timestamp: Date.now() + i * 100 };
                                    continue;
                                }
                            }

                            const isValidAvatar = await validateAvatarSource(actualAvatarUrl);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(actualAvatarUrl, msgData.reason || 'å¿ƒæƒ…å˜åŒ–');
                            if (success) continue;
                            else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[å¤´åƒæ›´æ¢å¤±è´¥]', timestamp: Date.now() + i * 100 };
                                } else {
                            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[æ— æ•ˆçš„å¤´åƒæ¥æºï¼Œå¤´åƒæ›´æ¢å¤±è´¥]', timestamp: Date.now() + i * 100 };
                                }
                            } else {
                        continue;
                    }
                } else if (msgData.type === 'reply_to') {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤
                    console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯] è¿›å…¥å¼•ç”¨å›å¤å¤„ç†ï¼ŒmsgData:', msgData);
                    // æŸ¥æ‰¾è¢«å¼•ç”¨çš„æ¶ˆæ¯
                    const referencedMessage = findMessageById(msgData.message_id);
                    console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯] æŸ¥æ‰¾åˆ°çš„è¢«å¼•ç”¨æ¶ˆæ¯:', referencedMessage);

                    if (referencedMessage) {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: msgData.content,
                            replyTo: {
                                id: referencedMessage.id,
                                content: referencedMessage.content,
                                senderName: referencedMessage.sender === 'sent' ? (getCurrentPersonaName() || 'ç”¨æˆ·') : (currentChatCharacter.name || 'AI')
                            },
                            timestamp: Date.now() + i * 100
                        };

                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç¾¤èŠå¼•ç”¨å›å¤æ·»åŠ å‘é€è€…ä¿¡æ¯
                        if (msgData.name && currentChatCharacter?.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                aiMessage.name = msgData.name;
                                aiMessage.senderId = member.id;
                                console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯] è®¾ç½®ç¾¤èŠå‘é€è€…:', msgData.name, 'ID:', member.id);
                            } else {
                                console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                            }
                        }
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå‘é€æ™®é€šæ¶ˆæ¯
                        console.warn('æ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ID:', msgData.message_id);
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: msgData.content, timestamp: Date.now() + i * 100 };

                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç¾¤èŠå¼•ç”¨å›å¤æ·»åŠ å‘é€è€…ä¿¡æ¯ï¼ˆæ‰¾ä¸åˆ°è¢«å¼•ç”¨æ¶ˆæ¯çš„æƒ…å†µï¼‰
                        if (msgData.name && currentChatCharacter?.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                aiMessage.name = msgData.name;
                                aiMessage.senderId = member.id;
                                console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯-fallback] è®¾ç½®ç¾¤èŠå‘é€è€…:', msgData.name, 'ID:', member.id);
                            } else {
                                console.log('ğŸ” [å¼•ç”¨å›å¤-æ—©æœŸåˆ†æ”¯-fallback] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                            }
                        }
                    }
                } else if (msgData.name && msgData.type === 'emoji') {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†ç›´æ¥çš„ç¾¤èŠè¡¨æƒ…åŒ…æ ¼å¼ {"name": "è§’è‰²å", "type": "emoji", "description": "è¡¨æƒ…åŒ…æè¿°"}
                    console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æ£€æµ‹åˆ°ç›´æ¥æ ¼å¼çš„ç¾¤èŠè¡¨æƒ…åŒ…:', msgData);

                    let senderId = null;
                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                        console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æŸ¥æ‰¾æˆå‘˜è¯¦æƒ…:', {
                            targetName: msgData.name,
                            allMembers: currentChatCharacter.members,
                            memberNames: currentChatCharacter.members.map(m => m.name)
                        });

                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                        if (member) {
                            senderId = member.id;
                            console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æ‰¾åˆ°æˆå‘˜:', member, 'senderId:', senderId);
                        } else {
                            console.warn('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æœªæ‰¾åˆ°æˆå‘˜:', msgData.name);
                            console.warn('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] å¯ç”¨æˆå‘˜åç§°:', currentChatCharacter.members.map(m => m.name));
                        }
                    }

                    const matchingEmoji = await findEmojiForAI(msgData.description);
                    if (matchingEmoji) {
                        console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æ‰¾åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', matchingEmoji);

                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,
                            senderId: senderId,
                            content: '', // è¡¨æƒ…åŒ…æ¶ˆæ¯ä¸æ˜¾ç¤ºæ–‡å­—å†…å®¹
                            image: matchingEmoji.url,
                            isEmoji: true,
                            emojiDescription: matchingEmoji.description,
                            timestamp: Date.now() + i * 100
                        };

                        console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] åˆ›å»ºçš„æ¶ˆæ¯å¯¹è±¡:', aiMessage);
                        // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                    } else {
                        console.warn('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…-ç›´æ¥æ ¼å¼] æ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', msgData.description);

                        // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œå‘é€é”™è¯¯æ¶ˆæ¯
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,
                            senderId: senderId,
                            content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                            timestamp: Date.now() + i * 100
                        };
                    }
                } else if (msgData.name && msgData.message) {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è¿™æ˜¯ç¾¤èŠçš„ç‰¹æ®Šæ ¼å¼
                    console.log('ğŸ” [ç¾¤èŠæ¶ˆæ¯] å¤„ç†ç¾¤èŠæ¶ˆæ¯:', msgData);
                    console.log('ğŸ” [ç¾¤èŠæ¶ˆæ¯] msgData.messageç±»å‹:', typeof msgData.message, 'msgData.message:', msgData.message);

                    let senderId = null;
                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨personaå­—æ®µæŸ¥æ‰¾æˆå‘˜
                        console.log('ğŸ” [ç¾¤èŠèº«ä»½] æŸ¥æ‰¾æˆå‘˜:', msgData.name, 'åœ¨ç¾¤èŠ:', currentChatCharacter.name);
                        console.log('ğŸ” [ç¾¤èŠèº«ä»½] ç¾¤æˆå‘˜åˆ—è¡¨:', currentChatCharacter.members);

                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                        if (member) {
                            senderId = member.id;
                            console.log('ğŸ” [ç¾¤èŠèº«ä»½] æ‰¾åˆ°æˆå‘˜:', member, 'senderId:', senderId);
                        } else {
                            console.warn('ğŸ” [ç¾¤èŠèº«ä»½] æœªæ‰¾åˆ°æˆå‘˜:', msgData.name);
                        }
                    }

                    // --- å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç¾¤èŠæ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç‰¹æ®Šç±»å‹ ---
                    if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                        // å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè¯­éŸ³æ¶ˆæ¯å¯¹è±¡
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message.content, // æå–çœŸæ­£çš„è¯­éŸ³æ–‡å­—å†…å®¹
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData.message === 'object' && msgData.message.type === 'reply_to') {
                        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠä¸­çš„å¼•ç”¨å›å¤
                        const referencedMessage = findMessageById(msgData.message.message_id);
                        if (referencedMessage) {
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                name: msgData.name,
                                senderId: senderId,
                                content: msgData.message.content,
                                replyTo: {
                                    id: referencedMessage.id,
                                    content: referencedMessage.content,
                                    senderName: referencedMessage.sender === 'sent' ? (getCurrentPersonaName() || 'ç”¨æˆ·') : (referencedMessage.name || referencedMessage.senderName || 'AI')
                                },
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå‘é€æ™®é€šç¾¤èŠæ¶ˆæ¯
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                name: msgData.name,
                                senderId: senderId,
                                content: msgData.message.content,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else if (typeof msgData.message === 'object' && msgData.message.type === 'emoji') {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè¡¨æƒ…åŒ…å¯¹è±¡
                        console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…] æ£€æµ‹åˆ°ç¾¤èŠè¡¨æƒ…åŒ…æ¶ˆæ¯:', msgData);

                        const matchingEmoji = await findEmojiForAI(msgData.message.description);
                        if (matchingEmoji) {
                            console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…] æ‰¾åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', matchingEmoji);

                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                name: msgData.name,
                                senderId: senderId,
                                content: '', // è¡¨æƒ…åŒ…æ¶ˆæ¯ä¸æ˜¾ç¤ºæ–‡å­—å†…å®¹
                                image: matchingEmoji.url,
                                isEmoji: true,
                                emojiDescription: matchingEmoji.description,
                                timestamp: Date.now() + i * 100
                            };

                            console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…] åˆ›å»ºçš„æ¶ˆæ¯å¯¹è±¡:', aiMessage);
                            console.log('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…] senderIdè®¾ç½®ä¸º:', senderId, 'nameè®¾ç½®ä¸º:', msgData.name);

                            // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        } else {
                            console.warn('ğŸ” [ç¾¤èŠè¡¨æƒ…åŒ…] æ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…:', msgData.message.description);

                            // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…ï¼Œå‘é€é”™è¯¯æ¶ˆæ¯
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                name: msgData.name,
                                senderId: senderId,
                                content: `[è¡¨æƒ…åŒ…"${msgData.message.description}"ä¸å­˜åœ¨]`,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else if (typeof msgData.message === 'object' && msgData.message.type === 'transfer') {
                        // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè½¬è´¦å¯¹è±¡
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                            name: msgData.name,
                            senderId: senderId,
                            amount: msgData.message.amount, // æå–è½¬è´¦é‡‘é¢
                            note: msgData.message.note, // æå–è½¬è´¦å¤‡æ³¨
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData.message === 'object' && msgData.message.type === 'friend_request') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªå¥½å‹ç”³è¯·å¯¹è±¡
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'friend_request', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                            name: msgData.name,
                            senderId: senderId,
                            message: msgData.message.message, // æå–å¥½å‹ç”³è¯·æ¶ˆæ¯
                            timestamp: Date.now() + i * 100
                        };
                    } else {
                        // å¯¹äºæ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message, // å†…å®¹æœ¬èº«æ˜¯å­—ç¬¦ä¸²
                            timestamp: Date.now() + i * 100
                        };
                    }
                    // --- ä¿®å¤ç»“æŸ ---
                        } else {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»å‹å¯¹è±¡ä½†æœªè¢«ä¸Šé¢çš„æ¡ä»¶æ•è·
                    if (typeof msgData === 'object' && msgData !== null) {
                        if (msgData.type === 'transfer') {
                            // è½¬è´¦å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'transfer',
                                amount: msgData.amount,
                                note: msgData.note,
                                timestamp: Date.now() + i * 100
                            };
                        } else if (msgData.type === 'voice_message') {
                            // è¯­éŸ³æ¶ˆæ¯å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'voice_message',
                                content: msgData.content,
                                timestamp: Date.now() + i * 100
                            };
                        } else if (msgData.type === 'ai_image') {
                            // AIå›¾ç‰‡å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'ai_image',
                                content: '',
                                image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIæè¿°çš„å›¾ç‰‡]</text></svg>')}`,
                                imageDescription: msgData.description,
                                timestamp: Date.now() + i * 100
                            };
                        } else if (msgData.type === 'payment_request') {
                            // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå¿½ç•¥
                            console.log('ğŸ›’ [AIä»£ä»˜è¯·æ±‚-é—æ¼åˆ†æ”¯] AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥:', msgData);
                            aiMessage = null;
                        } else if (msgData.type === 'emoji') {
                            // ğŸ”¥ã€ä¿®å¤ã€‘è¡¨æƒ…åŒ…å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç† - æ”¯æŒç¾¤èŠ
                            console.log('ğŸ” [é—æ¼è¡¨æƒ…åŒ…] æ£€æµ‹åˆ°é—æ¼çš„è¡¨æƒ…åŒ…å¯¹è±¡:', msgData);

                            const matchingEmoji = await findEmojiForAI(msgData.description);
                            if (matchingEmoji) {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '',
                                    image: matchingEmoji.url,
                                    isEmoji: true,
                                    emojiDescription: matchingEmoji.description,
                                    timestamp: Date.now() + i * 100
                                };

                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠï¼Œéœ€è¦è®¾ç½®å‘é€è€…ä¿¡æ¯
                                if (currentChatCharacter && currentChatCharacter.isGroup) {
                                    // å¯¹äºç¾¤èŠä¸­çš„è¡¨æƒ…åŒ…ï¼Œéœ€è¦æŒ‡å®šæ˜¯å“ªä¸ªè§’è‰²å‘é€çš„
                                    // ç”±äºè¿™æ˜¯åœ¨å¤„ç†é—æ¼çš„è¡¨æƒ…åŒ…å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦ä»å½“å‰ç¾¤èŠä¸­é€‰æ‹©ä¸€ä¸ªé»˜è®¤è§’è‰²
                                    if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                                        const defaultMember = currentChatCharacter.members[0];
                                        aiMessage.name = defaultMember.name;
                                        aiMessage.senderId = defaultMember.id;
                                        console.log('ğŸ” [é—æ¼è¡¨æƒ…åŒ…] è®¾ç½®é»˜è®¤å‘é€è€…:', defaultMember.name, 'ID:', defaultMember.id);
                                    }
                                }

                                console.log('ğŸ” [é—æ¼è¡¨æƒ…åŒ…] åˆ›å»ºçš„æ¶ˆæ¯å¯¹è±¡:', aiMessage);

                                // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                            } else {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                    timestamp: Date.now() + i * 100
                                };

                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘é”™è¯¯æ¶ˆæ¯ä¹Ÿéœ€è¦ç¾¤èŠå‘é€è€…ä¿¡æ¯
                                if (currentChatCharacter && currentChatCharacter.isGroup) {
                                    if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                                        const defaultMember = currentChatCharacter.members[0];
                                        aiMessage.name = defaultMember.name;
                                        aiMessage.senderId = defaultMember.id;
                                    }
                                }
                            }
                        } else {
                            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡
                            if (msgData.type && ['create_anniversary', 'create_appointment', 'block_user', 'system_command', 'internal_action', 'background_task'].includes(msgData.type)) {
                                console.log('ğŸ”§ [regenerateLastResponse] æ£€æµ‹åˆ°ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œè·³è¿‡æ˜¾ç¤º:', msgData);
                                continue; // è·³è¿‡è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸åˆ›å»ºaiMessage
                            }
                            // å…¶ä»–å¯¹è±¡ç±»å‹ï¼Œå°è¯•æå–æ–‡æœ¬å†…å®¹
                            const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼]';
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                        }
                                            } else {
                        // æ™®é€šå­—ç¬¦ä¸²æˆ–å…¶ä»–åŸºæœ¬ç±»å‹
                        const displayContent = String(msgData);
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                    }
                        }
                                            } else {
                // ğŸ”¥ã€å…³é”®ä¿®å¤ - regenerateLastResponseç‰ˆæœ¬ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»å‹å¯¹è±¡ä½†æœªè¢«ä¸Šé¢çš„æ¡ä»¶æ•è·
                if (typeof msgData === 'object' && msgData !== null) {
                    if (msgData.type === 'transfer') {
                        // è½¬è´¦å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer',
                            amount: msgData.amount,
                            note: msgData.note,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (msgData.type === 'voice_message') {
                        // è¯­éŸ³æ¶ˆæ¯å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message',
                            content: msgData.content,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (msgData.type === 'ai_image') {
                        // AIå›¾ç‰‡å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image',
                            content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };

                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                        if (msgData.name) {
                            console.log('ğŸ” [ç¬¬å››å¤„-AIå›¾ç‰‡] æ£€æµ‹åˆ°ç¾¤èŠæ¶ˆæ¯ï¼Œå‘é€è€…:', msgData.name);
                            aiMessage.name = msgData.name;
                            // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                            if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                if (member) {
                                    aiMessage.senderId = member.id;
                                    console.log('ğŸ” [ç¬¬å››å¤„-AIå›¾ç‰‡] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', member.id);
                                } else {
                                    console.log('ğŸ” [ç¬¬å››å¤„-AIå›¾ç‰‡] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                                }
                            }
                        }
                    } else if (msgData.type === 'emoji') {
                        // è¡¨æƒ…åŒ…å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                        const matchingEmoji = await findEmojiForAI(msgData.description);
                        if (matchingEmoji) {
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: '',
                                image: matchingEmoji.url,
                                isEmoji: true,
                                emojiDescription: matchingEmoji.description,
                                timestamp: Date.now() + i * 100
                            };
                            // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        } else {
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡
                        if (msgData.type && ['create_anniversary', 'create_appointment', 'block_user', 'system_command', 'internal_action', 'background_task'].includes(msgData.type)) {
                            console.log('ğŸ”§ [regenerateLastResponse-2] æ£€æµ‹åˆ°ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œè·³è¿‡æ˜¾ç¤º:', msgData);
                            continue; // è·³è¿‡è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸åˆ›å»ºaiMessage
                        }
                        // å…¶ä»–å¯¹è±¡ç±»å‹ï¼Œå°è¯•æå–æ–‡æœ¬å†…å®¹
                        const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼]';
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                    }
                } else if (typeof msgData === 'string') {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ™®é€šå­—ç¬¦ä¸²æ¶ˆæ¯ - ç¡®ä¿æ­£ç¡®å¤„ç†
                    console.log('ğŸ”¥ [DEBUG] å¤„ç†æ™®é€šå­—ç¬¦ä¸²æ¶ˆæ¯:', msgData);
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: msgData, timestamp: Date.now() + i * 100 };
                } else {
                    // å…¶ä»–åŸºæœ¬ç±»å‹
                    console.log('ğŸ”¥ [DEBUG] å¤„ç†å…¶ä»–ç±»å‹æ¶ˆæ¯:', typeof msgData, msgData);
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                }
                    }

                    chatMessages[characterId].push(aiMessage);
                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡AIæ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                        const stableId = `${characterId}_ai_reply_${aiMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                        await db.chatMessages.add({
                            id: stableId,
                            characterId: characterId,
                            timestamp: aiMessage.timestamp,
                            messageOrder: chatMessages[characterId].length - 1,
                            originalMessageId: aiMessage.id,
                            messageData: aiMessage
                        });
                        console.log('âœ… [é«˜æ•ˆAIå›å¤] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('AIæ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•AIå›å¤åˆ°å…¨å±€è®°å¿†äº‹ä»¶
            const character = characters.find(c => c.id === characterId);
            if (character) {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ„å»ºå®‰å…¨çš„äº‹ä»¶æ•°æ®ï¼Œé¿å…å¾ªç¯å¼•ç”¨
                const eventData = {
                    sender: characterId,
                    content: aiMessage.content || '[ç‰¹æ®Šæ¶ˆæ¯]',
                    messageType: aiMessage.type || 'text'
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ˜¯å¼•ç”¨æ¶ˆæ¯ï¼Œæ·»åŠ å¼•ç”¨ä¿¡æ¯ä½†é¿å…å¯¹è±¡åµŒå¥—
                if (aiMessage.replyTo) {
                    eventData.replyToId = aiMessage.replyTo.id;
                    eventData.replyToSender = aiMessage.replyTo.senderName;
                    eventData.replyToContent = aiMessage.replyTo.content;
                }

                await recordMemoryEvent(
                    [characterId, 'user'],
                    {
                        type: character.isGroup ? 'group_chat' : 'private_chat',
                        id: characterId
                    },
                    'message',
                    eventData,
                    0.7 // AIæ¶ˆæ¯é‡è¦æ€§
                );
            }

                    // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯å¤„ç†å®Œåéšè—"æ­£åœ¨è¾“å…¥ä¸­"
                    if (i === 0) {
                        hideTypingIndicator();
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨addMessageWithAnimationæ·»åŠ å•ä¸ªæ¶ˆæ¯ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                    addMessageWithAnimation(aiMessage, characterId);

                    // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨æ¶ˆæ¯ä¹‹é—´æ­£ç¡®æ˜¾ç¤º"æ­£åœ¨è¾“å…¥ä¸­"æç¤º
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        showTypingIndicator();
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                        hideTypingIndicator();
                    }
                }
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                hideTypingIndicator();
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}]`,
                    timestamp: Date.now()
                };
                chatMessages[characterId].push(errorMessage);
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘é”™è¯¯æ¶ˆæ¯ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('âœ… [é«˜æ•ˆé”™è¯¯æ¶ˆæ¯] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('é”™è¯¯æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }
                renderChatMessages(characterId);
            } finally {
                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨è¿™é‡Œä¹Ÿæ¸…é™¤å¾…å›å¤æ¶ˆæ¯ï¼Œå¹¶é‡ç½®é‡æ–°ç”Ÿæˆæ ‡å¿—
                pendingUserMessage = null;
                window._isRegenerating = false;
            }

            updateFloatingButtonsVisibility();
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ™ºèƒ½å›å¤åŠŸèƒ½ - ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼Œç§»é™¤å¤æ‚çš„åˆå¹¶é€»è¾‘
        function triggerSmartReply() {
            // ğŸ”¥ã€è°ƒè¯•ã€‘æ·»åŠ è°ƒç”¨æ ˆè¿½è¸ª
            console.log('ğŸš¨ [DEBUG] triggerSmartReply è¢«è°ƒç”¨ï¼');
            console.log('ğŸš¨ [DEBUG] è°ƒç”¨æ ˆ:', new Error().stack);

            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            if (isWaitingForReply) {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ä½¿ç”¨å¼¹çª—ï¼Œæ”¹ä¸ºæ˜¾ç¤ºæŒ‰é’®çŠ¶æ€æç¤º
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];

            // ğŸ”¥ã€ä¿®å¤ã€‘æ”¶é›†åŒä¸€è½®å¯¹è¯ä¸­çš„æ‰€æœ‰æœªå›å¤ç”¨æˆ·æ¶ˆæ¯
            let unrepliedUserMessages = [];
            let lastAIMessageIndex = -1;

            // æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯çš„ä½ç½®
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received') {
                    lastAIMessageIndex = i;
                    break;
                }
            }

            // æ”¶é›†æœ€åä¸€æ¡AIæ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
            for (let i = lastAIMessageIndex + 1; i < messages.length; i++) {
                if (messages[i].sender === 'sent') {
                    unrepliedUserMessages.push(messages[i]);
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å®šä¹‰å˜é‡
            const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'sent');
            const hasUnrepliedUserMessage = unrepliedUserMessages.length > 0;

            // æƒ…å†µ1ï¼šæœ‰æœªå›å¤çš„ç”¨æˆ·æ¶ˆæ¯
            if (unrepliedUserMessages.length > 0) {
                console.log('ğŸ” [triggerSmartReply] æ‰¾åˆ°æœªå›å¤çš„ç”¨æˆ·æ¶ˆæ¯æ•°é‡:', unrepliedUserMessages.length);

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åˆå¹¶æ‰€æœ‰æœªå›å¤çš„ç”¨æˆ·æ¶ˆæ¯å†…å®¹
                const mergedContent = [];
                let mergedMessageId = '';
                let latestTimestamp = 0;

                unrepliedUserMessages.forEach((msg, index) => {
                    console.log(`ğŸ” [triggerSmartReply] å¤„ç†æ¶ˆæ¯ ${index + 1}:`, {
                        id: msg.id,
                        type: msg.type,
                        contentLength: Array.isArray(msg.content) ? msg.content.length : 1,
                        hasImage: Array.isArray(msg.content) ? msg.content.some(item => item.type === 'image_url') : !!msg.image
                    });

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è·³è¿‡å·²å¤„ç†çš„è½¬è´¦æ¶ˆæ¯ï¼Œé¿å…é‡å¤å¤„ç†
                    if (msg.type === 'transfer' && msg.status) {
                        console.log('ğŸ” [triggerSmartReply] è·³è¿‡å·²å¤„ç†çš„è½¬è´¦æ¶ˆæ¯:', msg);
                        return; // è·³è¿‡è¿™æ¡æ¶ˆæ¯
                    }

                    if (Array.isArray(msg.content)) {
                        mergedContent.push(...msg.content);
                    } else if (msg.type === 'transfer') {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¤„ç†è½¬è´¦æ¶ˆæ¯ - è½¬æ¢ä¸ºAIèƒ½ç†è§£çš„æ–‡æœ¬æ ¼å¼
                        const transferText = `[ç”¨æˆ·å‘èµ·äº†è½¬è´¦ï¼š${msg.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${msg.note || 'æ— '}]`;
                        mergedContent.push({ type: 'text', text: transferText });
                        console.log('ğŸ” [triggerSmartReply] æ·»åŠ è½¬è´¦æ¶ˆæ¯:', transferText);
                    } else if (msg.type === 'voice_message') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†è¯­éŸ³æ¶ˆæ¯
                        const voiceText = `[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                        mergedContent.push({ type: 'text', text: voiceText });
                        console.log('ğŸ” [triggerSmartReply] æ·»åŠ è¯­éŸ³æ¶ˆæ¯:', voiceText);
                    } else if (msg.type === 'user_photo') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†ç”¨æˆ·ç…§ç‰‡
                        const photoText = `[ç”¨æˆ·å‘é€äº†ä¸€å¼ ç…§ç‰‡ï¼Œæè¿°æ˜¯ï¼š'${msg.content}']`;
                        mergedContent.push({ type: 'text', text: photoText });
                        console.log('ğŸ” [triggerSmartReply] æ·»åŠ ç…§ç‰‡æ¶ˆæ¯:', photoText);
                    } else if (msg.type === 'location') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†ä½ç½®æ¶ˆæ¯
                        const locationText = msg.content || `[ç”¨æˆ·åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${msg.locationName}]`;
                        mergedContent.push({ type: 'text', text: locationText });
                        console.log('ğŸ” [triggerSmartReply] æ·»åŠ ä½ç½®æ¶ˆæ¯:', locationText);
                    } else if (msg.image) {
                        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘å¤„ç†è¡¨æƒ…åŒ…å’Œå›¾ç‰‡æ¶ˆæ¯
                        if (msg.content) {
                            mergedContent.push({ type: 'text', text: msg.content });
                        }
                        mergedContent.push({ type: 'image_url', image_url: { url: msg.image } });
                    } else {
                        // å…¼å®¹æ—§æ ¼å¼çš„å­—ç¬¦ä¸²æ¶ˆæ¯
                        mergedContent.push({ type: 'text', text: msg.content });
                    }

                    mergedMessageId += msg.id + '_';
                    latestTimestamp = Math.max(latestTimestamp, msg.timestamp);
                });

                // åˆ›å»ºåˆå¹¶åçš„æ¶ˆæ¯å¯¹è±¡
                pendingUserMessage = {
                    id: mergedMessageId.slice(0, -1), // ç§»é™¤æœ€åçš„ä¸‹åˆ’çº¿
                    sender: 'sent',
                    content: mergedContent,
                    timestamp: latestTimestamp,
                    isMerged: true, // æ ‡è®°ä¸ºåˆå¹¶æ¶ˆæ¯
                    originalMessages: unrepliedUserMessages // ä¿ç•™åŸå§‹æ¶ˆæ¯å¼•ç”¨
                };

                console.log('ğŸ” [triggerSmartReply] åˆå¹¶åçš„æ¶ˆæ¯:', {
                    contentLength: pendingUserMessage.content.length,
                    hasText: pendingUserMessage.content.some(item => item.type === 'text'),
                    hasImage: pendingUserMessage.content.some(item => item.type === 'image_url'),
                    textCount: pendingUserMessage.content.filter(item => item.type === 'text').length,
                    imageCount: pendingUserMessage.content.filter(item => item.type === 'image_url').length
                });

                processAIReply();
                return;
            }

            // æƒ…å†µ2ï¼šæœ€åçš„ç”¨æˆ·æ¶ˆæ¯å·²æœ‰AIå›å¤ï¼Œéœ€è¦AIç»­å†™
            if (lastUserMessage && !hasUnrepliedUserMessage) {
                // æ£€æŸ¥ä»æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åçš„AIå›å¤å›åˆæ•°
                let aiReplyRounds = 0;
                let lastUserMessageIndex = -1;

                // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ç´¢å¼•
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'sent') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }

                // è®¡ç®—ä»æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åçš„AIå›å¤å›åˆæ•°
                // ä¸€å›åˆ = è¿ç»­çš„AIæ¶ˆæ¯ç›´åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
                if (lastUserMessageIndex !== -1) {
                    let inAIReplyRound = false;

                    for (let i = lastUserMessageIndex + 1; i < messages.length; i++) {
                        if (messages[i].sender === 'received') {
                            if (!inAIReplyRound) {
                                // å¼€å§‹æ–°çš„AIå›å¤å›åˆ
                                aiReplyRounds++;
                                inAIReplyRound = true;
                            }
                            // ç»§ç»­å½“å‰å›åˆï¼ˆå¤šæ¡è¿ç»­AIæ¶ˆæ¯ç®—ä¸€å›åˆï¼‰
                        } else {
                            // å¦‚æœæœ‰å…¶ä»–ç±»å‹æ¶ˆæ¯ï¼Œç»“æŸå½“å‰å›åˆ
                            inAIReplyRound = false;
                        }
                    }
                }

                // AIå›å¤é€»è¾‘ï¼š
                // aiReplyRounds = 0: æ²¡æœ‰å›å¤ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸åº”è¯¥åˆ°è¿™é‡Œ
                // aiReplyRounds = 1: å·²å›å¤ç”¨æˆ·æ¶ˆæ¯1å›åˆï¼Œç°åœ¨æ˜¯ç¬¬1æ¬¡ç»­å†™ï¼ˆç¬¬2å›åˆï¼‰
                // aiReplyRounds = 2: å·²å›å¤+ç»­å†™1å›åˆï¼Œç°åœ¨æ˜¯ç¬¬2æ¬¡ç»­å†™ï¼ˆç¬¬3å›åˆï¼‰
                // aiReplyRounds >= 3: å·²å›å¤+ç»­å†™2å›åˆï¼Œæç¤ºç”¨æˆ·å‘æ¶ˆæ¯

                if (aiReplyRounds >= 3) {
                    const characterName = currentChatCharacter.name;
                    alert(`${characterName}å·²ç»è¯´äº†å¾ˆå¤šè¯äº†ï¼Œå…ˆå’Œ${characterName}è¯´è¯´è¯å§~`);
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨ç»­å†™å‰ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„è½¬è´¦
                const lastUserTransfer = messages.slice().reverse().find(msg =>
                    msg.sender === 'sent' && msg.type === 'transfer' && !msg.status);
                if (lastUserTransfer) {
                    // å¦‚æœæœ‰æœªå¤„ç†çš„è½¬è´¦ï¼Œå…ˆè®¾ç½®ä¸ºå¾…å¤„ç†ï¼Œç„¶åå¤„ç†å›å¤
                    pendingUserMessage = lastUserTransfer;
                    processAIReply();
                    return;
                }

                // AIç»­å†™å¯¹è¯ï¼ˆç¬¬1æ¬¡æˆ–ç¬¬2æ¬¡ç»­å†™ï¼‰
                processAIContinuation();
                return;
            }

            // æƒ…å†µ3ï¼šæ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯
            alert('è¯·å…ˆå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åç‚¹å‡»æ­¤æŒ‰é’®æ¥è·å–AIå›å¤');
        }

                // å¤„ç†AIç»­å†™å¯¹è¯
        async function processAIContinuation() {
            if (!currentChatCharacter) return;

            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (isWaitingForReply) {
                console.log('AIæ­£åœ¨ç»­å†™ä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                return;
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è®°å½•å½“å‰èŠå¤©è§’è‰²IDï¼Œç¡®ä¿AIç»­å†™æ¶ˆæ¯å½’å±åˆ°æ­£ç¡®çš„èŠå¤©çª—å£
            const continuingCharacterId = currentChatCharacter.id;

            isWaitingForReply = true;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
            showTypingIndicator();

            // æ·»åŠ éšæœºå»¶è¿Ÿ
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // è·å–AIæœ€åçš„æ¶ˆæ¯å†…å®¹ï¼Œä»¥ä¾¿åŸºäºæ­¤ç»­å†™
                const messages = chatMessages[continuingCharacterId] || [];
                let lastAIMessage = "";

                // æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'received') {
                        lastAIMessage = messages[i].content || "";
                        break;
                    }
                }

                // æ„å»ºç»­å†™æç¤ºè¯ï¼ŒåŸºäºAIè‡ªå·±æœ€åçš„è¯æ¥ç»­å†™
                let continuationPrompt = "ä½ åˆšæ‰è¯´äº†ï¼š\"" + lastAIMessage + "\"\n\n";
                continuationPrompt += "ç°åœ¨è¯·åŸºäºä½ åˆšæ‰è¯´çš„è¯ï¼Œä¸»åŠ¨ç»§ç»­è¿™ä¸ªè¯é¢˜æˆ–è€…è‡ªç„¶åœ°è½¬åˆ°ç›¸å…³è¯é¢˜ã€‚å°±åƒçœŸå®èŠå¤©ä¸­ï¼Œä½ æƒ³è¦ç»§ç»­è¡¨è¾¾æ›´å¤šæƒ³æ³•ï¼Œæˆ–è€…è¯¢é—®å¯¹æ–¹çš„çœ‹æ³•ï¼Œæˆ–è€…åˆ†äº«ç›¸å…³çš„å†…å®¹ã€‚è¯·è‡ªç„¶åœ°ç»§ç»­å¯¹è¯ï¼Œä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„è¯ã€‚";
                continuationPrompt += "\n\nğŸš¨ é‡è¦æé†’ï¼šè¯·ä¸¥æ ¼éµå®ˆJSONæ ¼å¼ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»åˆ†å¼€å‘é€ï¼Œç»å¯¹ä¸èƒ½å°†å¤šæ¡æ¶ˆæ¯åˆå¹¶åœ¨ä¸€ä¸ªå…ƒç´ ä¸­ï¼æ­£ç¡®æ ¼å¼ï¼š[\"æ¶ˆæ¯1\", \"æ¶ˆæ¯2\"]ï¼Œé”™è¯¯æ ¼å¼ï¼š[\"æ¶ˆæ¯1\\næ¶ˆæ¯2\"]";

                const response = await callChatAPI(continuationPrompt, currentChatCharacter);
                const aiMessages = await parseAiResponse(response);

                // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨ç»­å†™æ—¶ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦æœ‰è½¬è´¦éœ€è¦å¤„ç†
                const chatHistory = chatMessages[continuingCharacterId] || [];
                const lastUserMessage = chatHistory.slice().reverse().find(msg =>
                    msg.sender === 'sent' && msg.type === 'transfer' && !msg.status);
                if (lastUserMessage) {
                    console.log('ğŸ”¥ [ç»­å†™] æ£€æµ‹åˆ°ç”¨æˆ·è½¬è´¦æ¶ˆæ¯ï¼Œå¼€å§‹å¤„ç†è½¬è´¦:', {
                        lastUserMessage,
                        aiMessages,
                        characterName: currentChatCharacter?.name
                    });
                    await processUserTransfer(lastUserMessage, aiMessages, continuingCharacterId);
                }

                hideTypingIndicator();

                // é€æ¡å‘é€æ¶ˆæ¯
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;

                    if (typeof msgData === 'object' && msgData.type === 'recall_previous') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIæ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯
                        console.log('ğŸ”¥ [ç»­å†™] AIè¯·æ±‚æ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯:', msgData);

                        // æŸ¥æ‰¾ä¸Šä¸€æ¡AIæ¶ˆæ¯
                        const allMessages = chatMessages[continuingCharacterId] || [];
                        let lastAIMessageIndex = -1;

                        for (let j = allMessages.length - 1; j >= 0; j--) {
                            if (allMessages[j].sender === 'received') {
                                lastAIMessageIndex = j;
                                break;
                            }
                        }

                        if (lastAIMessageIndex !== -1) {
                            const messageToRecall = allMessages[lastAIMessageIndex];
                            console.log('ğŸ”¥ [ç»­å†™] æ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯:', messageToRecall);

                            // è°ƒç”¨æ’¤å›æ¶ˆæ¯å¤„ç†å‡½æ•°
                            await handleRecalledMessage(messageToRecall.content, messageToRecall.id);
                        } else {
                            console.warn('ğŸ”¥ [ç»­å†™] æ²¡æœ‰æ‰¾åˆ°å¯æ’¤å›çš„AIæ¶ˆæ¯');
                        }
                        continue; // è·³è¿‡æ­£å¸¸çš„æ¶ˆæ¯å¤„ç†æµç¨‹
                    } else if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message',
                            content: msgData.content,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image',
                            content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };

                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                        if (msgData.name) {
                            console.log('ğŸ” [ç¬¬ä¸‰å¤„-AIå›¾ç‰‡] æ£€æµ‹åˆ°ç¾¤èŠæ¶ˆæ¯ï¼Œå‘é€è€…:', msgData.name);
                            aiMessage.name = msgData.name;
                            // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                            if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                if (member) {
                                    aiMessage.senderId = member.id;
                                    console.log('ğŸ” [ç¬¬ä¸‰å¤„-AIå›¾ç‰‡] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', member.id);
                                } else {
                                    console.log('ğŸ” [ç¬¬ä¸‰å¤„-AIå›¾ç‰‡] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                                }
                            }
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer',
                            amount: msgData.amount,
                            note: msgData.note,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'poke') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³(ç¬¬ä¸‰å¤„)
                        console.log('ğŸ” [callChatAPI-ç¬¬ä¸‰å¤„] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', msgData);
                        const chatSettings = getCurrentChatSettings();
                        const userNickname = chatSettings.myChatNickname || 'ä½ ';
                        const pokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘AIæˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix

                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'system',
                            content: `${currentChatCharacter.name}æˆ³äº†æˆ³${userNickname}${pokeSuffix}`,
                            timestamp: Date.now() + i * 100,
                            isPoke: true
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // å¤„ç†AIå‘é€çš„è¡¨æƒ…åŒ… - ä»æœ¬åœ°è¡¨æƒ…åŒ…åº“ä¸­æŸ¥æ‰¾
                        console.log('ğŸ” [callChatAPI] è¿›å…¥é€šç”¨è¡¨æƒ…åŒ…åˆ†æ”¯:', msgData);
                        const matchingEmoji = await findEmojiForAI(msgData.description);

                        if (matchingEmoji) {
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: '',
                                image: matchingEmoji.url,
                                isEmoji: true,
                                emojiDescription: matchingEmoji.description,
                                timestamp: Date.now() + i * 100
                            };

                            // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                            if (msgData.name) {
                                aiMessage.name = msgData.name;
                                // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                                if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                    const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                    if (member) {
                                        aiMessage.senderId = member.id;
                                    }
                                }
                            }

                            // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°è¡¨æƒ…åŒ…ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†å¤´åƒæ›´æ¢å¯¹è±¡
                        console.log('å¤„ç†å¤´åƒæ›´æ¢æ¶ˆæ¯(ç»­å†™):', msgData);
                        if (msgData.avatar_url) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆå¤„ç†å ä½ç¬¦æ›¿æ¢ï¼Œå†éªŒè¯å’Œæ‰§è¡Œå¤´åƒæ›´æ¢
                            let actualAvatarUrl = msgData.avatar_url;
                            if (msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                                msgData.avatar_url === 'å›¾ç‰‡URL') {
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    actualAvatarUrl = recentUserImage;
                                } else {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[æ— æ³•æ›´æ¢å¤´åƒï¼Œæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡]',
                                        timestamp: Date.now() + i * 100
                                    };
                                    continue;
                                }
                            }

                            // éªŒè¯å¤´åƒURLæ˜¯å¦æ¥è‡ªç”¨æˆ·å‘é€çš„å›¾ç‰‡æˆ–ä¸–ç•Œä¹¦ä¸­çš„URL
                            const isValidAvatar = await validateAvatarSource(actualAvatarUrl);
                            console.log('å¤´åƒæ¥æºéªŒè¯ç»“æœ(ç»­å†™):', isValidAvatar, 'å¤´åƒURL:', actualAvatarUrl);

                            if (isValidAvatar) {
                                // æ‰§è¡Œå¤´åƒæ›´æ¢
                                const success = await changeCharacterAvatarByAI(actualAvatarUrl, msgData.reason || 'å¿ƒæƒ…å˜åŒ–');
                                console.log('å¤´åƒæ›´æ¢æ‰§è¡Œç»“æœ(ç»­å†™):', success);
                                if (success) {
                                    // è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œåªæ‰§è¡Œå¤´åƒæ›´æ¢ï¼Œç³»ç»Ÿæ¶ˆæ¯å·²åœ¨changeCharacterAvatarByAIä¸­æ·»åŠ 
                                    continue;
                                } else {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[å¤´åƒæ›´æ¢å¤±è´¥]',
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[æ— æ•ˆçš„å¤´åƒæ¥æºï¼Œå¤´åƒæ›´æ¢å¤±è´¥]',
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('å¤´åƒæ›´æ¢æ¶ˆæ¯ç¼ºå°‘avatar_url(ç»­å†™)');
                            continue; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œè·³è¿‡æ­¤æ¶ˆæ¯
                        }
                    } else if (typeof msgData === 'object' && msgData !== null && msgData.name && msgData.message) {
                        // ğŸ”¥ã€ç¾¤èŠæ¶ˆæ¯å…³é”®ä¿®å¤ã€‘ç¾¤èŠæ¶ˆæ¯æ ¼å¼: {name: "è§’è‰²å", message: "æ¶ˆæ¯å†…å®¹"}
                        console.log('ğŸ”¥ [ä¿®å¤continuation] å‘ç°ç¾¤èŠæ¶ˆæ¯:', msgData);

                        // æŸ¥æ‰¾ç¾¤æˆå‘˜ID
                        let senderId = null;
                        if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                senderId = member.id;
                            }
                        }

                        // --- å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç¾¤èŠæ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç‰¹æ®Šç±»å‹ ---
                        if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                            // å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè¯­éŸ³æ¶ˆæ¯å¯¹è±¡
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'voice_message', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                                name: msgData.name,
                                senderId: senderId,
                                content: msgData.message.content, // æå–çœŸæ­£çš„è¯­éŸ³æ–‡å­—å†…å®¹
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // å¯¹äºæ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,          // ä¿å­˜å‘è¨€è€…åå­—
                            senderId: senderId,          // ä¿å­˜å‘è¨€è€…ID
                            content: msgData.message,    // ä½¿ç”¨messageå­—æ®µä½œä¸ºå†…å®¹
                            timestamp: Date.now() + i * 100
                        };
                        }
                        // --- ä¿®å¤ç»“æŸ ---
                        console.log('âœ… [ä¿®å¤continuation] ç¾¤èŠæ¶ˆæ¯å·²æ­£ç¡®è§£æ:', aiMessage);
                                            } else {
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ - ç»­å†™ç‰ˆæœ¬ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»å‹å¯¹è±¡ä½†æœªè¢«ä¸Šé¢çš„æ¡ä»¶æ•è·
                        if (typeof msgData === 'object' && msgData !== null) {
                            if (msgData.type === 'transfer') {
                                // è½¬è´¦å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'transfer',
                                    amount: msgData.amount,
                                    note: msgData.note,
                                    timestamp: Date.now() + i * 100
                                };
                            } else if (msgData.type === 'voice_message') {
                                // è¯­éŸ³æ¶ˆæ¯å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'voice_message',
                                    content: msgData.content,
                                    timestamp: Date.now() + i * 100
                                };
                            } else if (msgData.type === 'ai_image') {
                                // AIå›¾ç‰‡å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    type: 'ai_image',
                                    content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                                    imageDescription: msgData.description,
                                    timestamp: Date.now() + i * 100
                                };

                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                                if (msgData.name) {
                                    console.log('ğŸ” [ç¬¬äº”å¤„-AIå›¾ç‰‡] æ£€æµ‹åˆ°ç¾¤èŠæ¶ˆæ¯ï¼Œå‘é€è€…:', msgData.name);
                                    aiMessage.name = msgData.name;
                                    // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                        if (member) {
                                            aiMessage.senderId = member.id;
                                            console.log('ğŸ” [ç¬¬äº”å¤„-AIå›¾ç‰‡] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', member.id);
                                        } else {
                                            console.log('ğŸ” [ç¬¬äº”å¤„-AIå›¾ç‰‡] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                                        }
                                    }
                                }
                            } else if (msgData.type === 'emoji') {
                                // è¡¨æƒ…åŒ…å¯¹è±¡è¢«é—æ¼äº†ï¼Œé‡æ–°å¤„ç†
                                const matchingEmoji = await findEmojiForAI(msgData.description);
                                if (matchingEmoji) {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '',
                                        image: matchingEmoji.url,
                                        isEmoji: true,
                                        emojiDescription: matchingEmoji.description,
                                        timestamp: Date.now() + i * 100
                                    };

                                    // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                                    if (msgData.name) {
                                        aiMessage.name = msgData.name;
                                        // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                                        if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                            if (member) {
                                                aiMessage.senderId = member.id;
                                            }
                                        }
                                    }

                                    // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                                } else {
                                    aiMessage = {
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`,
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡
                                if (msgData.type && ['create_anniversary', 'create_appointment', 'block_user', 'system_command', 'internal_action', 'background_task'].includes(msgData.type)) {
                                    console.log('ğŸ”§ [processAIContinuation] æ£€æµ‹åˆ°ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œè·³è¿‡æ˜¾ç¤º:', msgData);
                                    continue; // è·³è¿‡è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸åˆ›å»ºaiMessage
                                }
                                // å…¶ä»–å¯¹è±¡ç±»å‹ï¼Œå°è¯•æå–æ–‡æœ¬å†…å®¹
                                const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼]';
                                aiMessage = {
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: displayContent,
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else if (typeof msgData === 'string') {
                            // æ™®é€šå­—ç¬¦ä¸²
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: msgData,
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // å…¶ä»–åŸºæœ¬ç±»å‹
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData),
                            timestamp: Date.now() + i * 100
                        };
                        }
                    }

                    chatMessages[continuingCharacterId].push(aiMessage);
                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡ç»­å†™æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                        const stableId = `${continuingCharacterId}_continue_${aiMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[continuingCharacterId].length - 1}`;
                        await db.chatMessages.add({
                            id: stableId,
                            characterId: continuingCharacterId,
                            timestamp: aiMessage.timestamp,
                            messageOrder: chatMessages[continuingCharacterId].length - 1,
                            originalMessageId: aiMessage.id,
                            messageData: aiMessage
                        });
                        console.log('âœ… [é«˜æ•ˆç»­å†™] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('ç»­å†™æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                        saveChatMessages();
                    }
                    addMessageWithAnimation(aiMessage, continuingCharacterId);

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç»­å†™çš„æ¯æ¡æ¶ˆæ¯åˆ›å»ºæ¨é€é€šçŸ¥ - ä½¿ç”¨æ­£ç¡®çš„è§’è‰²å¯¹è±¡
                    if (typeof msgData === 'string' ||
                        (typeof msgData === 'object' && (msgData.type || (msgData.name && msgData.message)))) {
                        console.log('ğŸ”¥ [æ¨é€é€šçŸ¥] ç»­å†™æ¶ˆæ¯ï¼Œåˆ›å»ºæ¨é€é€šçŸ¥:', msgData);
                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è·å–æ­£åœ¨ç»­å†™çš„è§’è‰²å¯¹è±¡ï¼Œè€Œä¸æ˜¯å½“å‰èŠå¤©è§’è‰²
                        const continuingCharacter = characters.find(c => c.id === continuingCharacterId);
                        if (continuingCharacter) {
                            createPushNotification(continuingCharacter, msgData, i * 500);
                        }
                    }

                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));

                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘AIç»­å†™å®Œæˆåæ›´æ–°æ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿æœªè¯»æ¶ˆæ¯è®¡æ•°æ­£ç¡®
                renderMessageList();
            } catch (error) {
                console.error('AIç»­å†™å¤±è´¥:', error);
                hideTypingIndicator();

                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ç»­å†™å¤±è´¥: ${error.message}]`,
                    timestamp: Date.now()
                };

                chatMessages[continuingCharacterId].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, continuingCharacterId);

                // ğŸ”¥ã€ä¿®å¤ã€‘é”™è¯¯æ¶ˆæ¯ä¹Ÿéœ€è¦æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                renderMessageList();
            } finally {
                // é‡ç½®çŠ¶æ€
                isWaitingForReply = false;
                pendingUserMessage = null;

                // æ¢å¤æ™ºèƒ½å›å¤æŒ‰é’®
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'è·å–AIå›å¤';
                }

                // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                updateFloatingButtonsVisibility();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç»Ÿä¸€çš„æ¶ˆæ¯åˆ›å»ºå‡½æ•°ï¼Œå‡å°‘é‡å¤ä»£ç 
        async function createAIMessage(msgData, index = 0) {
            const baseMessage = {
                id: (Date.now() + index).toString(),
                sender: 'received',
                timestamp: Date.now() + index * 100
            };

            // å¤„ç†ç¾¤èŠå‘é€è€…ä¿¡æ¯
            if (msgData.name && currentChatCharacter?.isGroup && currentChatCharacter.members) {
                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                if (member) {
                    baseMessage.name = msgData.name;
                    baseMessage.senderId = member.id;
                    console.log(`ğŸ” [createAIMessage] è®¾ç½®ç¾¤èŠå‘é€è€…: ${msgData.name} (ID: ${member.id})`);
                } else {
                    console.warn(`ğŸ” [createAIMessage] æœªæ‰¾åˆ°ç¾¤æˆå‘˜: ${msgData.name}`);
                }
            }

            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ç‰¹å®šå­—æ®µ
            switch (msgData.type) {
                case 'ai_image':
                    return {
                        ...baseMessage,
                        type: 'ai_image',
                        content: msgData.description || 'AIæè¿°çš„å›¾ç‰‡',
                        imageDescription: msgData.description
                    };
                case 'voice_message':
                    return {
                        ...baseMessage,
                        type: 'voice_message',
                        content: msgData.content
                    };
                case 'transfer':
                    return {
                        ...baseMessage,
                        type: 'transfer',
                        amount: msgData.amount,
                        note: msgData.note
                    };
                case 'poke':
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³
                    const chatSettings = getCurrentChatSettings();
                    const userNickname = chatSettings.myChatNickname || 'ä½ ';
                    const pokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘AIæˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix

                    return {
                        ...baseMessage,
                        sender: 'system',
                        content: `${currentChatCharacter.name}æˆ³äº†æˆ³${userNickname}${pokeSuffix}`,
                        isPoke: true
                    };
                case 'emoji':
                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘AIä»æŒ‚è½½çš„è¡¨æƒ…åŒ…åº“ä¸­æŸ¥æ‰¾è¡¨æƒ…åŒ…
                    const matchingEmoji = await findEmojiForAI(msgData.description);
                    if (matchingEmoji) {
                        const emojiMessage = {
                            ...baseMessage,
                            content: '',
                            image: matchingEmoji.url,
                            isEmoji: true,
                            emojiDescription: matchingEmoji.description
                        };
                        // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        return emojiMessage;
                    } else {
                        return {
                            ...baseMessage,
                            content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`
                        };
                    }
                case 'update_poke_suffix':
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†è§’è‰²ä¸»åŠ¨ä¿®æ”¹æˆ³ä¸€æˆ³åç¼€
                    console.log('ğŸ” [createAIMessage] è§’è‰²æ›´æ–°æˆ³ä¸€æˆ³åç¼€:', msgData);

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ›´æ–°èŠå¤©è®¾ç½®ä¸­çš„AIæˆ³ä¸€æˆ³åç¼€ï¼ˆå½±å“ç”¨æˆ·æˆ³AIæ—¶çš„æ˜¾ç¤ºï¼‰
                    if (msgData.suffix !== undefined) {
                        const chatSettings = getCurrentChatSettings();
                        chatSettings.aiPokeSuffix = msgData.suffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²ä¿®æ”¹è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€åº”è¯¥ä¿®æ”¹aiPokeSuffix
                        await saveCurrentChatSettings(chatSettings);

                        console.log('âœ… [createAIMessage] æˆ³ä¸€æˆ³åç¼€å·²æ›´æ–°:', msgData.suffix);
                    }

                    // è¿”å›ç³»ç»Ÿæç¤ºæ¶ˆæ¯
                    return {
                        id: (Date.now() + index).toString(),
                        sender: 'system',
                        content: `${currentChatCharacter.name}ä¿®æ”¹äº†è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€${msgData.suffix ? `ä¸º"${msgData.suffix}"` : 'ï¼ˆæ¸…ç©ºï¼‰'}`,
                        timestamp: Date.now() + index * 100,
                        type: 'system_notification'
                    };
                default:
                    return {
                        ...baseMessage,
                        content: msgData.content || msgData.message || ''
                    };
            }
        }

        // å¤„ç†AIå›å¤
        async function processAIReply() {
            // ğŸ”¥ã€è°ƒè¯•ã€‘æ·»åŠ è°ƒç”¨æ ˆè¿½è¸ª
            console.log('ğŸš¨ [DEBUG] processAIReply è¢«è°ƒç”¨ï¼');
            console.log('ğŸš¨ [DEBUG] è°ƒç”¨æ ˆ:', new Error().stack);

            if (!currentChatCharacter) return;

            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (isWaitingForReply) {
                console.log('AIæ­£åœ¨å›å¤ä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
                return;
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è®°å½•å½“å‰èŠå¤©è§’è‰²IDï¼Œç¡®ä¿AIå›å¤å½’å±åˆ°æ­£ç¡®çš„èŠå¤©çª—å£
            const replyingCharacterId = currentChatCharacter.id;

            // æ™ºèƒ½é€‰æ‹©æœ€ä½³çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¼˜å…ˆå›¾ç‰‡æ¶ˆæ¯ï¼‰
            console.log('ğŸ” [processAIReply] å‡½æ•°å¼€å§‹æ—¶çš„ pendingUserMessage:', pendingUserMessage);
            const messages = chatMessages[replyingCharacterId] || [];
            console.log('ğŸ” [processAIReply] æ‰€æœ‰æ¶ˆæ¯æ•°é‡:', messages.length);
            console.log('ğŸ” [processAIReply] æœ€å5æ¡æ¶ˆæ¯:', messages.slice(-5));
            const userMessages = messages.filter(msg => msg.sender === 'sent');
            console.log('ğŸ” [processAIReply] ç”¨æˆ·æ¶ˆæ¯æ•°é‡:', userMessages.length);
            console.log('ğŸ” [processAIReply] æœ€å3æ¡ç”¨æˆ·æ¶ˆæ¯:', userMessages.slice(-3));

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¯¦ç»†æŸ¥çœ‹æœ€å3æ¡ç”¨æˆ·æ¶ˆæ¯çš„å†…å®¹
            const last3Messages = userMessages.slice(-3);
            last3Messages.forEach((msg, index) => {
                console.log(`ğŸ” [processAIReply] ç”¨æˆ·æ¶ˆæ¯${index + 1}:`, {
                    id: msg.id,
                    content: msg.content,
                    isArray: Array.isArray(msg.content),
                    timestamp: msg.timestamp
                });
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜å…ˆæŸ¥æ‰¾æœ€è¿‘çš„è½¬å‘æ¶ˆæ¯ï¼Œç„¶åæ˜¯å›¾ç‰‡æ¶ˆæ¯
            const recentMessages = userMessages.slice(-5);

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¼˜å…ˆå¤„ç†å›¾ç‰‡æ¶ˆæ¯ï¼Œå³ä½¿æœ‰æ›´æ–°çš„æ–‡æœ¬æ¶ˆæ¯
            // é¦–å…ˆæŸ¥æ‰¾è½¬å‘æ¶ˆæ¯
            const forwardedMessage = recentMessages.reverse().find(msg => msg.type === 'forwarded_message');

            // ğŸ”¥ã€å½»åº•ä¿®å¤ã€‘ä¸å†å¼ºåˆ¶æŸ¥æ‰¾å†å²å›¾ç‰‡ï¼Œç›´æ¥ä½¿ç”¨triggerSmartReplyè®¾ç½®çš„pendingUserMessage
            if (forwardedMessage && !pendingUserMessage) {
                // ä¼˜å…ˆå¤„ç†è½¬å‘æ¶ˆæ¯
                pendingUserMessage = forwardedMessage;
                console.log('ğŸ” [processAIReply] æ‰¾åˆ°è½¬å‘æ¶ˆæ¯ï¼Œè®¾ç½®ä¸ºå¾…å¤„ç†:', forwardedMessage);
            } else if (!pendingUserMessage) {
                // å¦‚æœæ²¡æœ‰ç‰¹æ®Šæ¶ˆæ¯ä¸”æ²¡æœ‰å¾…å›å¤æ¶ˆæ¯ï¼Œä½¿ç”¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                const lastUserMessage = userMessages.slice(-1)[0]; // é‡æ–°è·å–æœ€åä¸€æ¡æ¶ˆæ¯
                console.log('ğŸ” [processAIReply] æ²¡æœ‰å¾…å›å¤æ¶ˆæ¯ï¼Œä½¿ç”¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯:', lastUserMessage);
                if (lastUserMessage) {
                    pendingUserMessage = lastUserMessage;
                    console.log('ğŸ” [processAIReply] è®¾ç½®æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¸ºå¾…å¤„ç†:', lastUserMessage);
                } else {
                    return;
                }
            }

            // ğŸ”ã€è°ƒè¯•ã€‘è¾“å‡ºå¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯è¯¦æƒ…
            console.log('ğŸ” [processAIReply] å¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯:', pendingUserMessage);
            console.log('ğŸ” [processAIReply] æ¶ˆæ¯ç±»å‹:', pendingUserMessage?.type);
            console.log('ğŸ” [processAIReply] æ¶ˆæ¯å†…å®¹:', pendingUserMessage?.content);
            console.log('ğŸ” [processAIReply] å†…å®¹æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(pendingUserMessage?.content));
            console.log('ğŸ” [processAIReply] æ˜¯å¦æœ‰forwardedMessages:', !!pendingUserMessage?.forwardedMessages);
            console.log('ğŸ” [processAIReply] forwardedMessagesé•¿åº¦:', pendingUserMessage?.forwardedMessages?.length);

            isWaitingForReply = true;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
            showTypingIndicator();

            // æ·»åŠ éšæœºå»¶è¿Ÿ
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // è°ƒç”¨APIï¼Œæ”¯æŒå›¾ç‰‡å’Œè¡¨æƒ…åŒ…
                // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯
                let response;

                // ğŸ”¥ã€ä¼˜å…ˆå¤„ç†ã€‘è½¬å‘æ¶ˆæ¯ç‰¹æ®Šå¤„ç† - è®©AIèƒ½çœ‹åˆ°è½¬å‘çš„èŠå¤©è®°å½•å†…å®¹
                console.log('ğŸ” [è½¬å‘æ¶ˆæ¯æ£€æŸ¥] pendingUserMessage:', pendingUserMessage);
                console.log('ğŸ” [è½¬å‘æ¶ˆæ¯æ£€æŸ¥] æ¶ˆæ¯ç±»å‹:', pendingUserMessage.type);
                console.log('ğŸ” [è½¬å‘æ¶ˆæ¯æ£€æŸ¥] æ˜¯å¦ä¸ºç¾¤èŠ:', currentChatCharacter?.isGroup);
                if (pendingUserMessage.type === 'forwarded_message') {
                    console.log('ğŸ” [è½¬å‘æ¶ˆæ¯å¤„ç†] å¼€å§‹å¤„ç†è½¬å‘æ¶ˆæ¯');
                    console.log('ğŸ” [è½¬å‘æ¶ˆæ¯å¤„ç†] pendingUserMessage.forwardedMessages:', pendingUserMessage.forwardedMessages);

                    // ğŸ”¥ã€ä¿®å¤ã€‘è·å–å½“å‰ç”¨æˆ·çš„æ˜¾ç¤ºåç§°
                    const chatSettings = getCurrentChatSettings();
                    const currentUserName = chatSettings.myChatNickname || (personas.find(p => p.id === chatSettings.selectedIdentityId)?.name || 'æˆ‘');

                    let forwardedContent = `[${currentUserName}è½¬å‘äº†èŠå¤©è®°å½•ï¼š${pendingUserMessage.content}]\n\nè½¬å‘çš„èŠå¤©å†…å®¹ï¼š\n`;

                    if (pendingUserMessage.forwardedMessages && pendingUserMessage.forwardedMessages.length > 0) {
                        console.log('ğŸ” [è½¬å‘æ¶ˆæ¯å¤„ç†] æ‰¾åˆ°è½¬å‘æ¶ˆæ¯ï¼Œæ•°é‡:', pendingUserMessage.forwardedMessages.length);
                        pendingUserMessage.forwardedMessages.forEach((msg, index) => {
                            let senderName;
                            if (msg.sender === 'sent') {
                                senderName = msg.userName || currentUserName;
                            } else {
                                senderName = msg.name || msg.characterName || 'AI';
                            }
                            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                            const msgContent = safeExtractMessageContent(msg);
                            console.log(`ğŸ” [è½¬å‘æ¶ˆæ¯å¤„ç†] æ¶ˆæ¯${index + 1}: ${senderName}: ${msgContent}`);
                            forwardedContent += `${senderName}: ${msgContent}\n`;
                        });
                    } else {
                        console.log('âŒ [è½¬å‘æ¶ˆæ¯å¤„ç†] è½¬å‘æ¶ˆæ¯ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
                        forwardedContent += '(è½¬å‘å†…å®¹ä¸ºç©º)';
                    }

                    console.log('ğŸ” [è½¬å‘æ¶ˆæ¯] å½“å‰èŠå¤©è§’è‰²:', currentChatCharacter?.name, 'æ˜¯å¦ä¸ºç¾¤èŠ:', currentChatCharacter?.isGroup);
                    console.log('ğŸ” [è½¬å‘æ¶ˆæ¯] å‘é€ç»™AIçš„å†…å®¹:', forwardedContent);

                    response = await callChatAPI(forwardedContent, currentChatCharacter);

                    console.log('ğŸ” [è½¬å‘æ¶ˆæ¯] AIåŸå§‹å›å¤:', response);
                } else if (Array.isArray(pendingUserMessage.content)) {
                    // è¿™æ˜¯å¤šæ¨¡æ€æ¶ˆæ¯ï¼ˆå›¾æ–‡ï¼‰
                    console.log('ğŸ” [processAIReply] æ£€æµ‹åˆ°å¤šæ¨¡æ€æ¶ˆæ¯:', pendingUserMessage.content);

                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥å¤šæ¨¡æ€æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…
                    const hasImage = pendingUserMessage.content.some(item => item.type === 'image_url');
                    const isEmojiMessage = pendingUserMessage.originalMessages?.some(msg => msg.isEmoji);

                    console.log('ğŸ” [processAIReplyå¤šæ¨¡æ€è°ƒè¯•] åŒ…å«å›¾ç‰‡:', hasImage);
                    console.log('ğŸ” [processAIReplyå¤šæ¨¡æ€è°ƒè¯•] æ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯:', isEmojiMessage);
                    console.log('ğŸ” [processAIReplyå¤šæ¨¡æ€è°ƒè¯•] è¡¨æƒ…åŒ…è¯†åˆ«è®¾ç½®:', apiSettings.emojiRecognitionEnabled);

                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                    const emojiMsg = pendingUserMessage.originalMessages?.find(msg => msg.isEmoji);
                    const isGifEmoji = emojiMsg?.image?.includes('data:image/gif') || emojiMsg?.url?.includes('data:image/gif');

                    console.log('ğŸ” [processAIReplyåŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                    if (hasImage && isEmojiMessage && (apiSettings.emojiRecognitionEnabled === false || isGifEmoji)) {
                        // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                        const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                        const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${emojiMsg?.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                        console.log(`ğŸ” [processAIReplyå¤šæ¨¡æ€ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                        response = await callChatAPI(emojiPrompt, currentChatCharacter);
                    } else {
                        response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                    }
                } else if (pendingUserMessage.image) {
                    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                    const isGifEmoji = pendingUserMessage.isEmoji && pendingUserMessage.image?.includes('data:image/gif');
                    console.log('ğŸ” [processAIReplyå›¾ç‰‡åˆ†æ”¯åŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦è¯†åˆ«è¡¨æƒ…åŒ…
                    if (pendingUserMessage.isEmoji && (apiSettings.emojiRecognitionEnabled === false || isGifEmoji)) {
                        // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                        const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                        const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${pendingUserMessage.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                        console.log(`ğŸ” [processAIReplyå›¾ç‰‡åˆ†æ”¯ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                        response = await callChatAPI(emojiPrompt, currentChatCharacter);
                    } else {
                        // æ™®é€šå›¾ç‰‡æˆ–å¯ç”¨äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œå‘é€å›¾ç‰‡
                        const messageContent = [
                            { type: 'text', text: pendingUserMessage.content || "" },
                            { type: 'image_url', image_url: { url: pendingUserMessage.image } }
                        ];
                        response = await callChatAPI(messageContent, currentChatCharacter);
                    }
                } else if (pendingUserMessage.type === 'transfer') {
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘è½¬è´¦æ¶ˆæ¯ç‰¹æ®Šå¤„ç† - æ„é€ è½¬è´¦æç¤ºæ–‡æœ¬
                    const transferPrompt = `[ç”¨æˆ·å‘èµ·äº†è½¬è´¦ï¼š${pendingUserMessage.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${pendingUserMessage.note || 'æ— '}]`;
                    response = await callChatAPI(transferPrompt, currentChatCharacter);
                } else {
                    // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯ä½†contentä¸ºç©ºçš„æƒ…å†µ
                    if (pendingUserMessage.image && pendingUserMessage.isEmoji) {
                        console.log('ğŸ” [processAIReplyä¿®å¤] æ£€æµ‹åˆ°è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼Œé‡æ–°è·¯ç”±åˆ°å›¾ç‰‡å¤„ç†');
                        // è¡¨æƒ…åŒ…æ¶ˆæ¯åº”è¯¥èµ°å›¾ç‰‡å¤„ç†åˆ†æ”¯
                        console.log('ğŸ” [processAIReplyå¼€å…³è°ƒè¯•] apiSettings:', apiSettings);
                        console.log('ğŸ” [processAIReplyå¼€å…³è°ƒè¯•] emojiRecognitionEnabledå€¼:', apiSettings.emojiRecognitionEnabled);

                        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨å›¾è¡¨æƒ…åŒ…
                        const isGifEmoji = pendingUserMessage.image?.includes('data:image/gif');
                        console.log('ğŸ” [processAIReply elseåˆ†æ”¯åŠ¨å›¾æ£€æµ‹] æ˜¯å¦ä¸ºGIFè¡¨æƒ…åŒ…:', isGifEmoji);

                        if (apiSettings.emojiRecognitionEnabled === false || isGifEmoji) {
                            // è¡¨æƒ…åŒ…ä¸”ç”¨æˆ·å…³é—­äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œæˆ–è€…æ˜¯åŠ¨å›¾è¡¨æƒ…åŒ…ï¼Œå‘é€æè¿°æ–‡å­—
                            const reason = isGifEmoji ? 'åŠ¨å›¾è¡¨æƒ…åŒ…' : 'è¡¨æƒ…åŒ…è¯†åˆ«å·²å…³é—­';
                            const emojiPrompt = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š${pendingUserMessage.emojiDescription || 'è‡ªå®šä¹‰è¡¨æƒ…åŒ…'}]`;
                            console.log(`ğŸ” [processAIReply elseåˆ†æ”¯ä¿®å¤] å‘é€æ–‡å­—æè¿° (${reason}):`, emojiPrompt);
                            response = await callChatAPI(emojiPrompt, currentChatCharacter);
                        } else {
                            // æ™®é€šå›¾ç‰‡æˆ–å¯ç”¨äº†è¡¨æƒ…åŒ…è¯†åˆ«ï¼Œå‘é€å›¾ç‰‡
                            const messageContent = [
                                { type: 'text', text: pendingUserMessage.content || "" },
                                { type: 'image_url', image_url: { url: pendingUserMessage.image } }
                            ];
                            console.log('ğŸ” [processAIReplyä¿®å¤] å‘é€ç»™AIçš„æ¶ˆæ¯å†…å®¹:', messageContent);
                            response = await callChatAPI(messageContent, currentChatCharacter);
                        }
                    } else {
                        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯ã€ä½ç½®æ¶ˆæ¯ã€è¯­éŸ³æ¶ˆæ¯ç­‰
                        let finalPrompt = pendingUserMessage.content; // é»˜è®¤ä½¿ç”¨åŸå§‹æ¶ˆæ¯å†…å®¹

                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥å½“å‰ç”¨æˆ·æ¶ˆæ¯æ˜¯å¦ä¸ºå¼•ç”¨å›å¤
                        if (pendingUserMessage.replyTo) {
                            // ä½¿ç”¨ summarizeLastMessage å‡½æ•°æ¥æˆªæ–­è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹
                            const quoteText = summarizeLastMessage({ content: pendingUserMessage.replyTo.content });

                            // æ„å»ºå¸¦æœ‰å¼•ç”¨ä¸Šä¸‹æ–‡çš„æç¤ºå­—ç¬¦ä¸²
                            // ä¾‹å¦‚: [å›å¤ AIçš„æ˜µç§° çš„æ¶ˆæ¯: "ä½ å¥½å‘€"]: æˆ‘ä¹Ÿå¾ˆå¥½
                            finalPrompt = `[å›å¤ ${pendingUserMessage.replyTo.senderName} çš„æ¶ˆæ¯: "${quoteText}"] ${pendingUserMessage.content}`;
                            console.log('âœ… æ„å»ºç”¨æˆ·å¼•ç”¨æç¤º:', finalPrompt);
                        }

                        response = await callChatAPI(finalPrompt, currentChatCharacter);
                    }
                }

                const aiMessages = await parseAiResponse(response);

                for (const msgData of aiMessages) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡
    if (typeof msgData === 'object' && msgData !== null && msgData.type === 'block_user') {
        console.log('ğŸš« æ£€æµ‹åˆ°AIæ‹‰é»‘æŒ‡ä»¤å¯¹è±¡:', msgData);
        // ä½¿ç”¨æŒ‡ä»¤ä¸­çš„ reason ä½œä¸ºæ‹‰é»‘ç†ç”±
        await aiBlockUser(currentChatCharacter.id, msgData.reason || 'å¯¹æ–¹æœªè¯´æ˜ç†ç”±');
        // æ‹‰é»‘åï¼Œé€šå¸¸ä¸éœ€è¦å†æ˜¾ç¤ºåç»­æ¶ˆæ¯ï¼Œç›´æ¥è·³å‡ºå¾ªç¯
        break;
    }

    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯çºªå¿µæ—¥åˆ›å»ºæŒ‡ä»¤å¯¹è±¡
    if (typeof msgData === 'object' && msgData !== null && msgData.type === 'create_anniversary') {
        console.log('ğŸ‰ æ£€æµ‹åˆ°AIçºªå¿µæ—¥åˆ›å»ºæŒ‡ä»¤:', msgData);
        const anniversaryData = {
            name: msgData.name || 'ç‰¹åˆ«çš„æ—¥å­',
            date: msgData.date || new Date().toISOString().split('T')[0],
            type: msgData.anniversary_type || 'other',
            description: msgData.description || 'ç”±è§’è‰²åˆ›å»ºçš„çºªå¿µæ—¥'
        };
        await createAnniversaryByCharacter(replyingCharacterId, anniversaryData);
        // ä¸è¦breakï¼Œç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
    }

    // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯çº¦å®šåˆ›å»ºæŒ‡ä»¤å¯¹è±¡
    if (typeof msgData === 'object' && msgData !== null && msgData.type === 'create_appointment') {
        console.log('ğŸ“ æ£€æµ‹åˆ°AIçº¦å®šåˆ›å»ºæŒ‡ä»¤:', msgData);
        const appointmentData = {
            name: msgData.name || 'æˆ‘ä»¬çš„çº¦å®š',
            date: msgData.date || new Date().toISOString().split('T')[0],
            type: msgData.appointment_type || 'other',
            description: msgData.description || 'ç”±è§’è‰²åˆ›å»ºçš„çº¦å®š',
            neverExpires: msgData.never_expires === true || msgData.neverExpires === true
        };
        await createAppointmentByCharacter(replyingCharacterId, appointmentData);
        // ä¸è¦breakï¼Œç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
    }
}

                // ğŸ”¥ã€ä¿®å¤è½¬è´¦å¤„ç†ã€‘æ£€æŸ¥æ˜¯å¦æœ‰è½¬è´¦æ¶ˆæ¯éœ€è¦å¤„ç†
                let transferMessage = null;
                if (pendingUserMessage && pendingUserMessage.type === 'transfer') {
                    // ç›´æ¥çš„è½¬è´¦æ¶ˆæ¯
                    transferMessage = pendingUserMessage;
                } else if (pendingUserMessage && pendingUserMessage.isMerged && pendingUserMessage.originalMessages) {
                    // åˆå¹¶æ¶ˆæ¯ä¸­çš„è½¬è´¦æ¶ˆæ¯
                    transferMessage = pendingUserMessage.originalMessages.find(msg =>
                        msg.type === 'transfer' && !msg.status);
                }

                if (transferMessage) {
                    console.log('ğŸ”¥ æ£€æµ‹åˆ°ç”¨æˆ·è½¬è´¦æ¶ˆæ¯ï¼Œå¼€å§‹å¤„ç†è½¬è´¦:', {
                        transferMessage,
                        aiMessages,
                        characterName: currentChatCharacter?.name
                    });
                    await processUserTransfer(transferMessage, aiMessages, replyingCharacterId);
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘é‡æ–°å®šä¹‰ allMessages å˜é‡ç”¨äºä»£ä»˜å¤„ç†
                const allMessages = chatMessages[replyingCharacterId] || [];

                // ä»£ä»˜è¯·æ±‚å¤„ç†ä¿æŒä¸å˜ï¼Œåªå¤„ç†ç”¨æˆ·å‘èµ·çš„ä»£ä»˜è¯·æ±‚
                console.log('ğŸ›’ [ä»£ä»˜å¤„ç†] AIå›å¤å®Œæˆï¼Œæ£€æŸ¥æœªå¤„ç†ä»£ä»˜è¯·æ±‚');
                const unprocessedPayment = allMessages.slice().reverse().find(msg =>
                    msg.sender === 'sent' && msg.type === 'payment_request' && !msg.paymentStatus);
                if (unprocessedPayment) {
                    console.log('ğŸ›’ [ä»£ä»˜å¤„ç†] å‘ç°æœªå¤„ç†ä»£ä»˜è¯·æ±‚ï¼Œåˆ†æAIå›å¤:', unprocessedPayment);
                    await processPaymentRequestResponse(unprocessedPayment, aiMessages, replyingCharacterId);
                }

                // ğŸ”¥ã€æ¢å¤å…³é”®è¯è§¦å‘æœºåˆ¶ã€‘æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯
                if (pendingUserMessage && response) {
                    // æå–ç”¨æˆ·æ¶ˆæ¯å†…å®¹
                    let userMessageText = '';
                    if (Array.isArray(pendingUserMessage.content)) {
                        // å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œæå–æ–‡æœ¬éƒ¨åˆ†
                        const textParts = pendingUserMessage.content.filter(item => item.type === 'text');
                        userMessageText = textParts.map(item => item.text).join(' ');
                    } else {
                        userMessageText = pendingUserMessage.content || '';
                    }

                    // æ£€æŸ¥æ˜¯å¦è§¦å‘AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯
                    checkForAICallTrigger(userMessageText, response);
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºAIçš„æ¯æ¡å›å¤åˆ›å»ºæ¨é€é€šçŸ¥ - æ”¯æŒç¾¤èŠå’Œå•èŠ
                console.log('ğŸ”” [æ¨é€é€šçŸ¥] AIå›å¤å®Œæˆï¼Œå‡†å¤‡åˆ›å»ºæ¨é€é€šçŸ¥ï¼Œæ¶ˆæ¯æ•°é‡:', aiMessages.length);
                console.log('ğŸ”” [æ¨é€é€šçŸ¥] å½“å‰èŠå¤©è§’è‰²ID:', replyingCharacterId);
                console.log('ğŸ”” [æ¨é€é€šçŸ¥] å½“å‰èŠå¤©è§’è‰²å¯¹è±¡:', currentChatCharacter);

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åŒºåˆ†å•èŠå’Œç¾¤èŠï¼Œä»ä¸åŒçš„æ•°ç»„ä¸­æŸ¥æ‰¾
                let replyingCharacter = characters.find(c => c.id === replyingCharacterId);

                // å¦‚æœåœ¨charactersä¸­æ‰¾ä¸åˆ°ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
                if (!replyingCharacter) {
                    const replyingGroup = groupChats.find(g => g.id === replyingCharacterId);
                    if (replyingGroup) {
                        console.log('ğŸ”” [æ¨é€é€šçŸ¥] æ‰¾åˆ°ç¾¤èŠå¯¹è±¡:', replyingGroup.name);
                        replyingCharacter = replyingGroup;
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œç›´æ¥ä½¿ç”¨å½“å‰èŠå¤©è§’è‰²å¯¹è±¡
                if (!replyingCharacter && currentChatCharacter) {
                    console.log('ğŸ”” [æ¨é€é€šçŸ¥] ä½¿ç”¨å½“å‰èŠå¤©è§’è‰²å¯¹è±¡ä½œä¸ºå›å¤è§’è‰²');
                    replyingCharacter = currentChatCharacter;
                }

                if (replyingCharacter) {
                    console.log('ğŸ”” [æ¨é€é€šçŸ¥] æ‰¾åˆ°å›å¤è§’è‰²:', replyingCharacter.name, 'æ˜¯å¦ä¸ºç¾¤èŠ:', replyingCharacter.isGroup);
                    for (let i = 0; i < aiMessages.length; i++) {
                        const msgData = aiMessages[i];
                        console.log('ğŸ”” [æ¨é€é€šçŸ¥] å¤„ç†æ¶ˆæ¯', i, ':', msgData);
                        if (typeof msgData === 'string' ||
                            (typeof msgData === 'object' && (msgData.type || (msgData.name && msgData.message)))) {
                            createPushNotification(replyingCharacter, msgData, i * 500);
                        }
                    }
                } else {
                    console.warn('ğŸ”” [æ¨é€é€šçŸ¥] æ‰¾ä¸åˆ°å›å¤è§’è‰²ï¼Œè·³è¿‡æ¨é€é€šçŸ¥åˆ›å»ºï¼ŒreplyingCharacterId:', replyingCharacterId);
                }

                // ğŸ”¥ã€ç§»é™¤é‡å¤è®°å½•ã€‘è¿™é‡Œçš„æ—¶é—´çº¿è®°å½•é€»è¾‘å·²ç§»åŠ¨åˆ°ä¸‹é¢çš„å•æ¡æ¶ˆæ¯å¤„ç†ä¸­ï¼Œé¿å…é‡å¤è®°å½•

// --- è¯·ç”¨è¿™æ®µå…¨æ–°çš„ä»£ç æ›¿æ¢ ---
                hideTypingIndicator();

                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
    let aiMessage; // å…ˆå£°æ˜å˜é‡

    console.log('ğŸ” [AIå›å¤å¤„ç†] å¤„ç†æ¶ˆæ¯', i, 'ç±»å‹:', typeof msgData, 'å†…å®¹:', msgData);
    console.log('ğŸ” [AIå›å¤å¤„ç†] å½“å‰èŠå¤©è§’è‰²:', currentChatCharacter?.name, 'æ˜¯å¦ä¸ºç¾¤èŠ:', currentChatCharacter?.isGroup);

    // ğŸ”¥ã€ä¿®å¤ã€‘è·³è¿‡ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œé¿å…æ˜¾ç¤º"ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼"
    if (typeof msgData === 'object' && msgData !== null) {
        if (msgData.type === 'block_user') {
            console.log('ğŸš« è·³è¿‡æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡ï¼Œä¸æ˜¾ç¤ºä¸ºæ¶ˆæ¯:', msgData);
            continue;
        }
        if (msgData.type === 'create_anniversary') {
            console.log('ğŸ‰ è·³è¿‡çºªå¿µæ—¥åˆ›å»ºæŒ‡ä»¤å¯¹è±¡ï¼Œä¸æ˜¾ç¤ºä¸ºæ¶ˆæ¯:', msgData);
            continue;
        }
        if (msgData.type === 'create_appointment') {
            console.log('ğŸ“ è·³è¿‡çº¦å®šåˆ›å»ºæŒ‡ä»¤å¯¹è±¡ï¼Œä¸æ˜¾ç¤ºä¸ºæ¶ˆæ¯:', msgData);
            continue;
        }
        // ğŸ”¥ã€æ–°å¢ã€‘è·³è¿‡å…¶ä»–å¯èƒ½çš„ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡
        if (msgData.type && ['system_command', 'internal_action', 'background_task'].includes(msgData.type)) {
            console.log('ğŸ”§ è·³è¿‡ç³»ç»ŸæŒ‡ä»¤å¯¹è±¡ï¼Œä¸æ˜¾ç¤ºä¸ºæ¶ˆæ¯:', msgData);
            continue;
        }
    }

    if (typeof msgData === 'object' && msgData !== null) {
        if (msgData.type === 'voice_message') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'ai_image') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'transfer') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'poke') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'update_poke_suffix') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'emoji') {
            aiMessage = await createAIMessage(msgData, i);
        } else if (msgData.type === 'ai_photo') {
            // è§’è‰²å‘é€çš„"ä¼ªç…§ç‰‡"
            console.log('å¤„ç†è§’è‰²ç…§ç‰‡æ¶ˆæ¯:', msgData);
            // ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æè¿°
            const photoDesc = msgData.description || msgData.content || msgData.photoDescription || 'è§’è‰²å‘é€çš„ç…§ç‰‡';
            console.log('ç…§ç‰‡æè¿°:', photoDesc);
            aiMessage = {
                id: (Date.now() + i).toString(),
                sender: 'received',
                type: 'user_photo', // ä½¿ç”¨ä¸ç”¨æˆ·ç…§ç‰‡ç›¸åŒçš„ç±»å‹ä»¥ä¾¿å¤ç”¨æ¸²æŸ“é€»è¾‘
                content: photoDesc,
                photoDescription: photoDesc,
                timestamp: Date.now() + i * 100
            };
        } else if (msgData.type === 'location') {
            // è§’è‰²å‘é€çš„ä½ç½®ä¿¡æ¯
            console.log('å¤„ç†è§’è‰²ä½ç½®æ¶ˆæ¯:', msgData);
            // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨locationNameå­—æ®µï¼Œnameå­—æ®µæ˜¯è§’è‰²å
            const locationName = msgData.locationName || msgData.name || 'æœªçŸ¥ä½ç½®';
            console.log('ä½ç½®åç§°:', locationName, 'åæ ‡:', msgData.coordinates || 'æœªçŸ¥åæ ‡');
            aiMessage = {
                id: (Date.now() + i).toString(),
                sender: 'received',
                type: 'location', // ä¿æŒç±»å‹ä¸ºlocation
                locationName: locationName,
                coordinates: msgData.coordinates || 'æœªçŸ¥åæ ‡',
                content: `[è§’è‰²åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${locationName}]`,
                timestamp: Date.now() + i * 100
            };

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠçš„è§’è‰²åå­—æ®µ
            if (msgData.name && isGroupChat) {
                aiMessage.name = msgData.name;
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç¾¤èŠæ¶ˆæ¯è®¾ç½®senderId
                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                if (member) {
                    aiMessage.senderId = member.id;
                }
            }
        } else if (msgData.type === 'transfer') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'poke') {
            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨æˆ³ä¸€æˆ³(processAIReplyç¬¬äºŒå¤„)
            console.log('ğŸ” [processAIReply-ç¬¬äºŒå¤„] AIä¸»åŠ¨æˆ³ä¸€æˆ³:', msgData);
            const chatSettings = getCurrentChatSettings();
            const userNickname = chatSettings.myChatNickname || 'ä½ ';
            const pokeSuffix = chatSettings.myPokeSuffix || ''; // ğŸ”¥ã€ä¿®å¤ã€‘AIæˆ³ç”¨æˆ·åº”è¯¥ä½¿ç”¨myPokeSuffix

            aiMessage = {
                id: (Date.now() + i).toString(),
                sender: 'system',
                content: `${currentChatCharacter.name}æˆ³äº†æˆ³${userNickname}${pokeSuffix}`,
                timestamp: Date.now() + i * 100,
                isPoke: true
            };
        } else if (msgData.type === 'payment_request') {
            // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå¿½ç•¥
            console.log('ğŸ›’ [AIä»£ä»˜è¯·æ±‚] AIå°è¯•å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œå·²å¿½ç•¥:', msgData);
            aiMessage = null;
        } else if (msgData.type === 'order_confirmation') {
            // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†AIçš„è®¢å•ç¡®è®¤
            console.log('ğŸ›’ [AIè®¢å•ç¡®è®¤] æ£€æµ‹åˆ°AIè®¢å•ç¡®è®¤:', msgData);

            // ç”Ÿæˆè®¢å•å·
            const orderNumber = 'SP' + Date.now().toString().slice(-8);

            // æ„å»ºè®¢å•è¯¦æƒ…
            const orderDetails = {
                orderNumber: orderNumber,
                items: msgData.items || [],
                total: msgData.total || 0,
                recipient: msgData.recipient || currentChatCharacter?.name || 'AI',
                timestamp: Date.now()
            };

            aiMessage = {
                id: (Date.now() + i).toString(),
                sender: 'received',
                type: 'order_confirmation',
                content: 'è®¢å•ç¡®è®¤',
                orderDetails: orderDetails,
                orderType: msgData.order_type || 'ai_order',
                timestamp: Date.now() + i * 100
            };

            console.log('ğŸ›’ [AIè®¢å•ç¡®è®¤] åˆ›å»ºçš„è®¢å•ç¡®è®¤æ¶ˆæ¯:', aiMessage);
        } else if (msgData.type === 'emoji') {
            console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] åŸå§‹msgData:', msgData);
            const matchingEmoji = await findEmojiForAI(msgData.description);
                        if (matchingEmoji) {
                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¸ºè¡¨æƒ…åŒ…æ¶ˆæ¯æ·»åŠ ç¾¤èŠå‘é€è€…ä¿¡æ¯
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    content: '',
                    image: matchingEmoji.url,
                    isEmoji: true,
                    emojiDescription: matchingEmoji.description,
                    timestamp: Date.now() + i * 100
                };

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…ä¿¡æ¯
                if (msgData.name) {
                    console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] æ£€æµ‹åˆ°ç¾¤èŠæ¶ˆæ¯ï¼Œå‘é€è€…:', msgData.name);
                    aiMessage.name = msgData.name;
                    // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤æˆå‘˜ID
                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                        if (member) {
                            aiMessage.senderId = member.id;
                            console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', member.id);
                        } else {
                            console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                        }
                    }
                } else {
                    console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] msgData.name ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å•èŠ');
                }

                console.log('ğŸ” [processAIReply-è¡¨æƒ…åŒ…] åˆ›å»ºçš„è¡¨æƒ…åŒ…æ¶ˆæ¯:', aiMessage);
                // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„è¡¨æƒ…åŒ…ä¸åº”è¯¥æ·»åŠ åˆ°ç”¨æˆ·çš„æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        } else {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: `[è¡¨æƒ…åŒ…"${msgData.description}"ä¸å­˜åœ¨]`, timestamp: Date.now() + i * 100 };
            }
        } else if (msgData.type === 'reply_to') {
            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¼•ç”¨å›å¤æ¶ˆæ¯
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] è¿›å…¥å¼•ç”¨å›å¤å¤„ç†ï¼ŒmsgData:', msgData);

            // æŸ¥æ‰¾è¢«å¼•ç”¨çš„æ¶ˆæ¯
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æŸ¥æ‰¾æ¶ˆæ¯ID:', msgData.message_id);
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] replyingCharacterId:', replyingCharacterId);
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] currentChatCharacter.id:', currentChatCharacter?.id);

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ­£ç¡®çš„è§’è‰²IDæŸ¥æ‰¾æ¶ˆæ¯
            const characterId = currentChatCharacter?.id || replyingCharacterId;
            const allMessages = chatMessages[characterId] || [];
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] ä½¿ç”¨è§’è‰²ID:', characterId);
            console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] å½“å‰è§’è‰²çš„æ¶ˆæ¯æ•°é‡:', allMessages.length);

            // ğŸ”¥ã€ä¿®å¤ã€‘å®‰å…¨åœ°è·å–æœ€è¿‘æ¶ˆæ¯çš„ID
            try {
                allMessages.slice(-5).map(m => m?.id || 'undefined');
            } catch (e) {
                console.error('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] è·å–æ¶ˆæ¯IDæ—¶å‡ºé”™:', e);
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] allMessages:', allMessages);
            }

            const referencedMessage = allMessages.find(msg => msg.id === msgData.message_id);

            // ğŸ”¥ã€è°ƒè¯•ã€‘å¦‚æœæ²¡æ‰¾åˆ°æ¶ˆæ¯ï¼Œå°è¯•ä¸åŒçš„æŸ¥æ‰¾æ–¹å¼
            if (!referencedMessage) {
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æœªæ‰¾åˆ°æ¶ˆæ¯ï¼Œå°è¯•å…¶ä»–æŸ¥æ‰¾æ–¹å¼...');
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æŸ¥æ‰¾ç›®æ ‡IDç±»å‹:', typeof msgData.message_id, 'å€¼:', msgData.message_id);

                // å°è¯•æ•°å­—æ ¼å¼æŸ¥æ‰¾
                const numericId = parseInt(msgData.message_id);
                const referencedByNumber = allMessages.find(msg => msg.id === numericId);
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æ•°å­—æ ¼å¼æŸ¥æ‰¾ç»“æœ:', referencedByNumber);

                // å°è¯•å­—ç¬¦ä¸²æ ¼å¼æŸ¥æ‰¾
                const referencedByString = allMessages.find(msg => msg.id === msgData.message_id.toString());
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] å­—ç¬¦ä¸²æ ¼å¼æŸ¥æ‰¾ç»“æœ:', referencedByString);

                // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯çš„IDå’Œç±»å‹
                console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æ‰€æœ‰æ¶ˆæ¯IDè¯¦æƒ…:', allMessages.map(m => ({id: m.id, type: typeof m.id, content: m.content?.substring?.(0, 20)})));
            }

            if (referencedMessage) {
                // æ„å»ºå¼•ç”¨ä¿¡æ¯
                let referencedContent = '';

                // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†æ•°ç»„æ ¼å¼çš„æ¶ˆæ¯å†…å®¹
                if (Array.isArray(referencedMessage.content)) {
                    const textPart = referencedMessage.content.find(p => p.type === 'text');
                    const imagePart = referencedMessage.content.find(p => p.type === 'image_url');

                    if (textPart?.text) {
                        referencedContent = textPart.text;
                    } else if (imagePart) {
                        referencedContent = '[å›¾ç‰‡]';
                    } else {
                        referencedContent = '[å¤šåª’ä½“æ¶ˆæ¯]';
                    }
                } else {
                    referencedContent = referencedMessage.content || '';
                }

                const replyToInfo = {
                    id: referencedMessage.id,
                    content: referencedContent,
                    senderName: referencedMessage.sender === 'sent' ? 'ä½ ' : (referencedMessage.name || currentChatCharacter?.name || 'å¯¹æ–¹')
                };

                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    content: msgData.content || '',
                    replyTo: replyToInfo,
                    timestamp: Date.now() + i * 100
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç¾¤èŠå¼•ç”¨å›å¤æ·»åŠ å‘é€è€…ä¿¡æ¯
                if (msgData.name && currentChatCharacter?.isGroup && currentChatCharacter.members) {
                    const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                    if (member) {
                        aiMessage.name = msgData.name;
                        aiMessage.senderId = member.id;
                        console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] è®¾ç½®ç¾¤èŠå‘é€è€…:', msgData.name, 'ID:', member.id);
                    } else {
                        console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                    }
                }

            } else {
                console.warn('ğŸ”¥ æ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ID:', msgData.message_id);
                // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå°±å½“ä½œæ™®é€šæ¶ˆæ¯å¤„ç†
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    content: msgData.content || '',
                    timestamp: Date.now() + i * 100
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºç¾¤èŠå¼•ç”¨å›å¤æ·»åŠ å‘é€è€…ä¿¡æ¯ï¼ˆæ‰¾ä¸åˆ°è¢«å¼•ç”¨æ¶ˆæ¯çš„æƒ…å†µï¼‰
                if (msgData.name && currentChatCharacter?.isGroup && currentChatCharacter.members) {
                    const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                    if (member) {
                        aiMessage.name = msgData.name;
                        aiMessage.senderId = member.id;
                        console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯-fallback] è®¾ç½®ç¾¤èŠå‘é€è€…:', msgData.name, 'ID:', member.id);
                    } else {
                        console.log('ğŸ” [å¼•ç”¨å›å¤-ä¸»åˆ†æ”¯-fallback] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                    }
                }
            }
        } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆå¤„ç†å ä½ç¬¦æ›¿æ¢ï¼Œå†éªŒè¯å’Œæ‰§è¡Œå¤´åƒæ›´æ¢
                            let actualAvatarUrl = msgData.avatar_url;
                            if (msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'CURRENT_USER_IMAGE' ||
                                msgData.avatar_url === 'ç”¨æˆ·å‘é€çš„å›¾ç‰‡URL' ||
                                msgData.avatar_url === 'å›¾ç‰‡URL') {
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    actualAvatarUrl = recentUserImage;
                                } else {
                                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[æ— æ³•æ›´æ¢å¤´åƒï¼Œæ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡]', timestamp: Date.now() + i * 100 };
                                    continue;
                                }
                            }

                            const isValidAvatar = await validateAvatarSource(actualAvatarUrl);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(actualAvatarUrl, msgData.reason || 'å¿ƒæƒ…å˜åŒ–');
                                if (success) continue;
                                else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[å¤´åƒæ›´æ¢å¤±è´¥]', timestamp: Date.now() + i * 100 };
                            } else {
                                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[æ— æ•ˆçš„å¤´åƒæ¥æºï¼Œå¤´åƒæ›´æ¢å¤±è´¥]', timestamp: Date.now() + i * 100 };
                            }
                        } else {
                            continue;
                        }
        } else if (msgData.type === 'recall_previous') {
            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIæ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯
            console.log('ğŸ”¥ AIè¯·æ±‚æ’¤å›ä¸Šä¸€æ¡æ¶ˆæ¯:', msgData);

            // æŸ¥æ‰¾ä¸Šä¸€æ¡AIæ¶ˆæ¯
            const allMessages = chatMessages[replyingCharacterId] || [];
            let lastAIMessageIndex = -1;

            for (let j = allMessages.length - 1; j >= 0; j--) {
                if (allMessages[j].sender === 'received') {
                    lastAIMessageIndex = j;
                    break;
                }
            }

            if (lastAIMessageIndex !== -1) {
                const messageToRecall = allMessages[lastAIMessageIndex];
                console.log('ğŸ”¥ æ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯:', messageToRecall);

                // è°ƒç”¨æ’¤å›æ¶ˆæ¯å¤„ç†å‡½æ•°
                await handleRecalledMessage(messageToRecall.content, messageToRecall.id);
            } else {
                console.warn('ğŸ”¥ æ²¡æœ‰æ‰¾åˆ°å¯æ’¤å›çš„AIæ¶ˆæ¯');
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸€æ¡æç¤º
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    content: '[AIæ’¤å›äº†ä¸Šä¸€æ¡æ¶ˆæ¯]',
                    timestamp: Date.now() + i * 100
                };
            }
            continue; // è·³è¿‡æ­£å¸¸çš„æ¶ˆæ¯å¤„ç†æµç¨‹
        } else if (msgData.type === 'voice_call') {
            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨å‘èµ·è¯­éŸ³é€šè¯
            console.log('ğŸ”” AIè¯·æ±‚å‘èµ·è¯­éŸ³é€šè¯:', msgData);
            setTimeout(() => {
                initiateAICall(currentChatCharacter, msgData.reason || 'æƒ³å’Œä½ èŠèŠ');
            }, 100 + Math.random() * 200); // è¿›ä¸€æ­¥å‡å°‘å»¶è¿Ÿåˆ°0.1-0.3ç§’
            continue; // è·³è¿‡æ¶ˆæ¯æ˜¾ç¤ºï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªåŠ¨ä½œæŒ‡ä»¤
        } else if (msgData.type === 'video_call') {
            // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨å‘èµ·è§†é¢‘é€šè¯
            console.log('ğŸ”” AIè¯·æ±‚å‘èµ·è§†é¢‘é€šè¯:', msgData);
            setTimeout(() => {
                initiateAIVideoCall(currentChatCharacter, msgData.reason || 'æƒ³å’Œä½ è§†é¢‘èŠèŠ');
            }, 100 + Math.random() * 200); // è¿›ä¸€æ­¥å‡å°‘å»¶è¿Ÿåˆ°0.1-0.3ç§’
            continue; // è·³è¿‡æ¶ˆæ¯æ˜¾ç¤ºï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªåŠ¨ä½œæŒ‡ä»¤
        } else if (msgData.name && msgData.message) {
            // è¿™æ˜¯ç¾¤èŠçš„ç‰¹æ®Šæ ¼å¼
            console.log('ğŸ” [AIå›å¤å¤„ç†] æ£€æµ‹åˆ°ç¾¤èŠæ ¼å¼æ¶ˆæ¯:', msgData.name, msgData.message);
            let senderId = null;
            if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                if (member) {
                    senderId = member.id;
                    console.log('ğŸ” [AIå›å¤å¤„ç†] æ‰¾åˆ°ç¾¤æˆå‘˜ID:', senderId);
                } else {
                    console.log('ğŸ” [AIå›å¤å¤„ç†] æœªæ‰¾åˆ°ç¾¤æˆå‘˜:', msgData.name);
                }
            }

            // --- å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç¾¤èŠæ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ºç‰¹æ®Šç±»å‹ ---
            if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                // å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè¯­éŸ³æ¶ˆæ¯å¯¹è±¡
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'voice_message', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message.content, // æå–çœŸæ­£çš„è¯­éŸ³æ–‡å­—å†…å®¹
                    timestamp: Date.now() + i * 100
                };
            } else if (typeof msgData.message === 'object' && msgData.message.type === 'transfer') {
                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªè½¬è´¦å¯¹è±¡
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'transfer', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                    name: msgData.name,
                    senderId: senderId,
                    amount: msgData.message.amount, // æå–è½¬è´¦é‡‘é¢
                    note: msgData.message.note, // æå–è½¬è´¦å¤‡æ³¨
                    timestamp: Date.now() + i * 100
                };
            } else if (typeof msgData.message === 'object' && msgData.message.type === 'friend_request') {
                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªå¥½å‹ç”³è¯·å¯¹è±¡(ç¬¬äºŒå¤„)
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'friend_request', // åœ¨å¤–å±‚æ¶ˆæ¯ä¸Šè®¾ç½®æ­£ç¡®çš„ç±»å‹
                    message: msgData.message.message, // æå–å¥½å‹ç”³è¯·æ¶ˆæ¯
                    timestamp: Date.now() + i * 100
                };
            } else {
                // å¯¹äºæ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
                console.log('ğŸ” [AIå›å¤å¤„ç†] åˆ›å»ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯ï¼Œname:', msgData.name, 'senderId:', senderId);
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message, // å†…å®¹æœ¬èº«æ˜¯å­—ç¬¦ä¸²
                    timestamp: Date.now() + i * 100
                };
                console.log('ğŸ” [AIå›å¤å¤„ç†] åˆ›å»ºçš„aiMessage:', aiMessage);
            }
            // --- ä¿®å¤ç»“æŸ ---
                    } else {
            // å…¶ä»–æ‰€æœ‰æœªçŸ¥å¯¹è±¡çš„å¤„ç† - ä¿®å¤[object Object]é—®é¢˜
            let displayContent;
            if (msgData.content && typeof msgData.content === 'string') {
                displayContent = msgData.content;
            } else if (msgData.message && typeof msgData.message === 'string') {
                displayContent = msgData.message;
            } else if (msgData.text && typeof msgData.text === 'string') {
                displayContent = msgData.text;
            } else if (msgData.reply && typeof msgData.reply === 'string') {
                displayContent = msgData.reply;
            } else if (typeof msgData === 'string') {
                displayContent = msgData;
            } else {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡è€Œä¸æ˜¯æ˜¾ç¤º"ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼"
                if (msgData.type && ['create_anniversary', 'create_appointment', 'block_user', 'system_command', 'internal_action', 'background_task', 'transfer_action'].includes(msgData.type)) {
                    console.log('ğŸ”§ æ£€æµ‹åˆ°ç‰¹æ®ŠæŒ‡ä»¤å¯¹è±¡ï¼Œè·³è¿‡æ˜¾ç¤º:', msgData);
                    continue; // è·³è¿‡è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸åˆ›å»ºaiMessage
                }
                // å¯¹äºå…¶ä»–å¤æ‚å¯¹è±¡ï¼Œæå–æœ‰ç”¨ä¿¡æ¯æˆ–æ˜¾ç¤ºç±»å‹æç¤º
                console.warn('æœªå¤„ç†çš„å¯¹è±¡ç±»å‹:', msgData);
                displayContent = '[ä¸æ”¯æŒçš„æ¶ˆæ¯æ ¼å¼]';
            }
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                            }
                        } else if (typeof msgData === 'string') {
                            // æ™®é€šå­—ç¬¦ä¸²
                            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: msgData, timestamp: Date.now() + i * 100 };
                        } else {
                            // å…¶ä»–ç±»å‹ï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                    }

                    chatMessages[replyingCharacterId].push(aiMessage);
                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡å›å¤æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç¡®ä¿IDå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤é”®é”™è¯¯
                        const stableId = `${replyingCharacterId}_reply_${aiMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[replyingCharacterId].length - 1}`;
                        await db.chatMessages.add({
                            id: stableId,
                            characterId: replyingCharacterId,
                            timestamp: aiMessage.timestamp,
                            messageOrder: chatMessages[replyingCharacterId].length - 1,
                            originalMessageId: aiMessage.id,
                            messageData: aiMessage
                        });
                        console.log('âœ… [é«˜æ•ˆå›å¤] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('å›å¤æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }
                    addMessageWithAnimation(aiMessage, replyingCharacterId);

                    // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è§’è‰²çŠ¶æ€æ›´æ–°
                    triggerStatusUpdateAfterMessage(replyingCharacterId);

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ¯æ¡AIæ¶ˆæ¯è®°å½•æ—¶é—´çº¿äº‹ä»¶ï¼Œé¿å…é‡å¤è®°å½•
                    setTimeout(async () => {
                        try {
                            // è·å–å½“å‰æ¶ˆæ¯çš„å†…å®¹
                            let eventContent = '';
                            let characterId = replyingCharacterId;

                            if (typeof msgData === 'string') {
                                eventContent = msgData;
                            } else if (typeof msgData === 'object' && msgData.name && msgData.message) {
                                // ç¾¤èŠæ¶ˆæ¯æ ¼å¼
                                eventContent = msgData.message;
                                // æŸ¥æ‰¾ç¾¤æˆå‘˜ID
                                if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                    const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                    if (member) characterId = member.id;
                                }
                            } else if (typeof msgData === 'object' && msgData.content) {
                                eventContent = msgData.content;
                            } else if (aiMessage && aiMessage.content) {
                                eventContent = aiMessage.content;
                            }

                            if (eventContent && characterId) {
                                // ğŸ”¥ã€ä¿®å¤ã€‘è®°å½•AIå›å¤çš„æ—¶é—´çº¿äº‹ä»¶ - ç¾¤èŠéœ€è¦ä¸ºæ¯ä¸ªæˆå‘˜è®°å½•
                                if (currentChatCharacter?.isGroup) {
                                    // ç¾¤èŠï¼šä¸ºæ¯ä¸ªç¾¤æˆå‘˜è®°å½•AIå›å¤äº‹ä»¶
                                    for (const member of currentChatCharacter.members || []) {
                                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥è¯¥æˆå‘˜æ˜¯å¦è®¾ç½®äº†ä¸å½“å‰ç¾¤èŠå…±äº«è®°å¿†
                                        const shouldRecord = await shouldRecordGroupMemoryForCharacter(member.id, currentChatCharacter.id);
                                        if (shouldRecord) {
                                            await recordCrossAppEvent(
                                                member.id, // è®°å½•åˆ°æ¯ä¸ªæˆå‘˜çš„æ—¶é—´çº¿ä¸‹
                                                'chat',
                                                'ai_reply',
                                                {
                                                    id: member.id, // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨è§’è‰²IDè€Œä¸æ˜¯ç¾¤èŠIDï¼Œç¡®ä¿è®°å¿†å…±äº«æ­£å¸¸å·¥ä½œ
                                                    type: 'group_chat',
                                                    sender: 'ai',
                                                    content: eventContent,
                                                    chatType: 'group',
                                                    groupName: currentChatCharacter.name,
                                                    groupId: currentChatCharacter.id // ğŸ”¥ã€æ–°å¢ã€‘ä¿ç•™ç¾¤èŠIDç”¨äºåŒºåˆ†
                                                },
                                                aiMessage.id
                                            );
                                            console.log(`ğŸ”¥ [ä¿®å¤] å·²è®°å½•AIå›å¤æ—¶é—´çº¿äº‹ä»¶ - è§’è‰²: ${member.id}, å†…å®¹: ${eventContent.substring(0, 50)}...`);
                                        } else {
                                            console.log(`â­ï¸ è·³è¿‡è®°å½• - è§’è‰² ${member.id} æœªä¸ç¾¤èŠ ${currentChatCharacter.id} å…±äº«è®°å¿†`);
                                        }
                                    }
                                } else {
                                    // å•èŠï¼šæ­£å¸¸è®°å½•
                                    await recordCrossAppEvent(
                                        replyingCharacterId,
                                        'chat',
                                        'ai_reply',
                                        {
                                            id: currentChatCharacter.id,
                                            type: 'private_chat',
                                            sender: 'ai',
                                            content: eventContent,
                                            chatType: 'single'
                                        },
                                        aiMessage.id
                                    );
                                    console.log(`ğŸ”¥ [ä¿®å¤] å·²è®°å½•AIå›å¤æ—¶é—´çº¿äº‹ä»¶ - è§’è‰²: ${replyingCharacterId}, å†…å®¹: ${eventContent.substring(0, 50)}...`);
                                }
                            }
                        } catch (error) {
                            console.error('AIå›å¤åè®°å¿†å¤„ç†å¤±è´¥:', error);
                        }
                    }, 1000 + i * 200); // å»¶è¿Ÿæ‰§è¡Œï¼Œæ¯æ¡æ¶ˆæ¯é—´éš”200msï¼Œé¿å…é˜»å¡UI

                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘AIæ¶ˆæ¯å‘é€å®Œæˆåæ›´æ–°æ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿æœªè¯»æ¶ˆæ¯è®¡æ•°æ­£ç¡®
                renderMessageList();

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘AIå›å¤å¤„ç†å®Œæˆï¼Œçºªå¿µæ—¥åˆ›å»ºå·²åœ¨æ¶ˆæ¯å¤„ç†å¾ªç¯ä¸­å®Œæˆ
            } catch (error) {
                console.error('AIå›å¤å¤±è´¥:', error);
                hideTypingIndicator();

                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[å›å¤å¤±è´¥: ${error.message}]`,
                    timestamp: Date.now()
                };

                chatMessages[replyingCharacterId].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, replyingCharacterId);

                // ğŸ”¥ã€ä¿®å¤ã€‘é”™è¯¯æ¶ˆæ¯ä¹Ÿéœ€è¦æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                renderMessageList();
            } finally {
                // é‡ç½®çŠ¶æ€
                isWaitingForReply = false;
                pendingUserMessage = null;

                // æ¢å¤æ™ºèƒ½å›å¤æŒ‰é’®
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'è·å–AIå›å¤';
                }

                // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                updateFloatingButtonsVisibility();
            }
        }

        // é‡ç½®é‡æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
        function resetFloatingButtonsState() {
            // é‡ç½®å¾…å›å¤æ¶ˆæ¯
            pendingUserMessage = null;
            isWaitingForReply = false;

            // é‡ç½®æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = false;
                smartReplyBtn.style.opacity = '';
                smartReplyBtn.style.animation = 'none';
                smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                smartReplyBtn.title = 'è·å–AIå›å¤';
                smartReplyBtn.classList.remove('waiting');
            }

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateFloatingButtonsVisibility();
        }

        // æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
        function updateFloatingButtonsVisibility() {
            if (!currentChatCharacter) return;

            const regenerateToolItem = document.getElementById('regenerate-tool-item');
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            const messages = chatMessages[currentChatCharacter.id] || [];

            // æ£€æŸ¥æ˜¯å¦æœ‰AIæ¶ˆæ¯å¯ä»¥é‡æ–°ç”Ÿæˆ
            const hasAIMessages = messages.some(msg => msg.sender === 'received');

            if (regenerateToolItem) {
                if (hasAIMessages) {
                    regenerateToolItem.style.display = 'flex';
                } else {
                    regenerateToolItem.style.display = 'none';
                }
            }

            if (smartReplyBtn) {
                // æ™ºèƒ½å›å¤æŒ‰é’®æ€»æ˜¯æ˜¾ç¤º
                smartReplyBtn.classList.remove('hidden');
            }
        }

        // @ç¾¤æˆå‘˜åŠŸèƒ½ç›¸å…³å‡½æ•°
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;

            // æŸ¥æ‰¾æœ€è¿‘çš„@ç¬¦å·ä½ç½®
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }

            if (atPos !== -1 && isGroupChat()) {
                // æ‰¾åˆ°@ç¬¦å·ï¼Œæ˜¾ç¤ºç¾¤æˆå‘˜åˆ—è¡¨
                const query = text.substring(atPos + 1, cursorPos);
                mentionStartPos = atPos;
                currentMentionQuery = query;
                showMentionDropdown(query);
            } else {
                // æ²¡æœ‰@ç¬¦å·æˆ–ä¸æ˜¯ç¾¤èŠï¼Œéšè—ä¸‹æ‹‰æ¡†
                hideMentionDropdown();
            }
        }

        function handleMentionKeydown(e) {
            const dropdown = document.getElementById('mention-dropdown');
            const items = dropdown.querySelectorAll('.mention-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
                updateMentionSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
                updateMentionSelection(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                if (selectedMentionIndex >= 0 && items[selectedMentionIndex]) {
                    selectMention(items[selectedMentionIndex]);
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideMentionDropdown();
            }
        }

        function isGroupChat() {
            return currentChatCharacter && groupChats.find(g => g.id === currentChatCharacter.id);
        }

        function showMentionDropdown(query) {
            if (!isGroupChat()) return;

            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            if (!group || !group.members) return;

            const dropdown = document.getElementById('mention-dropdown');
            const filteredMembers = group.members.filter(member =>
                member.name.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredMembers.length === 0) {
                hideMentionDropdown();
                return;
            }

            dropdown.innerHTML = '';
            filteredMembers.forEach((member, index) => {
                const item = document.createElement('div');
                item.className = 'mention-item';
                item.innerHTML = `
                    <div class="mention-avatar" style="background-color: ${member.color || '#4CAF50'}; ${member.avatarUrl ? `background-image: url(${member.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${member.avatarUrl ? '' : member.name.charAt(0)}
                    </div>
                    <div class="mention-name">${member.name}</div>
                `;
                item.onclick = () => selectMention(item);
                item.dataset.memberName = member.name;
                item.dataset.memberId = member.id;
                dropdown.appendChild(item);
            });

            selectedMentionIndex = 0;
            updateMentionSelection(dropdown.querySelectorAll('.mention-item'));
            dropdown.style.display = 'block';
            mentionDropdownVisible = true;
        }

        function hideMentionDropdown() {
            const dropdown = document.getElementById('mention-dropdown');
            dropdown.style.display = 'none';
            mentionDropdownVisible = false;
            selectedMentionIndex = -1;
            mentionStartPos = -1;
            currentMentionQuery = '';
        }

        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedMentionIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectMention(item) {
            const memberName = item.dataset.memberName;
            const input = document.getElementById('api-chat-input');
            const text = input.value;

            // æ›¿æ¢@æŸ¥è¯¢æ–‡æœ¬ä¸º@æŸäºº
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(mentionStartPos + 1 + currentMentionQuery.length);
            const newText = beforeMention + `@${memberName} ` + afterMention;

            input.value = newText;

            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°@æŸäººåé¢
            const newCursorPos = mentionStartPos + memberName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);

            hideMentionDropdown();
            input.focus();
        }

        // å¤„ç†æ¶ˆæ¯ä¸­çš„@å†…å®¹ï¼Œå°†å…¶è½¬æ¢ä¸ºå¸¦æ ·å¼çš„HTML
        function processMentions(content) {
            if (!content || typeof content !== 'string') return content;

            // åŒ¹é…@æŸäººçš„æ¨¡å¼
            return content.replace(/@([^\s@]+)/g, '<span class="mention-text">@$1</span>');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ„å»ºç¾¤èŠä¸Šä¸‹æ–‡å…³è”è®°å¿†
        async function buildContextualMemoryForGroupChat(groupCharacter, userMessage) {
            try {
                let contextualMemory = '';

                // æ£€æµ‹@æåŠ
                const mentionMatches = userMessage.match(/@([^\s@]+)/g);
                if (mentionMatches) {
                    for (const mention of mentionMatches) {
                        const mentionedName = mention.substring(1); // ç§»é™¤@ç¬¦å·

                        // æŸ¥æ‰¾è¢«@çš„ç¾¤æˆå‘˜
                        const mentionedMember = groupCharacter.members?.find(m => m.name === mentionedName);
                        if (mentionedMember) {
                            // è·å–è¯¥æˆå‘˜çš„å•èŠè®°å¿†
                            const privateChatMemory = await getPrivateChatMemoryForMember(mentionedMember.id, userMessage);
                            if (privateChatMemory) {
                                contextualMemory += `\n\n# ä¸${mentionedName}çš„ç›¸å…³ç§èŠè®°å¿†ï¼š\n${privateChatMemory}`;
                            }
                        }
                    }
                }

                // æ£€æµ‹æ•°å­—æš—å·ï¼ˆ6ä½ä»¥ä¸Šæ•°å­—ï¼‰
                const numberMatches = userMessage.match(/\b\d{6,}\b/g);
                if (numberMatches) {
                    for (const number of numberMatches) {
                        // åœ¨æ‰€æœ‰ç¾¤æˆå‘˜çš„ç§èŠè®°å¿†ä¸­æœç´¢è¿™ä¸ªæ•°å­—
                        for (const member of groupCharacter.members || []) {
                            const numberContext = await searchNumberInPrivateChat(member.id, number);
                            if (numberContext) {
                                contextualMemory += `\n\n# å…³äºæ•°å­—"${number}"çš„ç§èŠè®°å¿†ï¼ˆä¸${member.name}ï¼‰ï¼š\n${numberContext}`;
                                break; // æ‰¾åˆ°ä¸€ä¸ªå°±å¤Ÿäº†
                            }
                        }
                    }
                }

                return contextualMemory;
            } catch (error) {
                console.error('æ„å»ºç¾¤èŠä¸Šä¸‹æ–‡å…³è”è®°å¿†å¤±è´¥:', error);
                return '';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–ç¾¤æˆå‘˜çš„ç§èŠè®°å¿†
        async function getPrivateChatMemoryForMember(memberId, currentMessage) {
            try {
                // è·å–æœ€è¿‘çš„ç§èŠè®°å¿†ï¼ˆæœ€è¿‘5æ¡ï¼‰
                const recentPrivateMemories = await db.crossAppTimeline
                    .where('characterId').equals(memberId)
                    .and(event => event.appType === 'chat' &&
                                 event.context?.type === 'private_chat')
                    .reverse()
                    .limit(5)
                    .toArray();

                if (recentPrivateMemories.length === 0) return '';

                let memoryText = '';
                recentPrivateMemories.forEach(memory => {
                    const time = new Date(memory.timestamp).toLocaleString();
                    const content = memory.context?.content || memory.context?.message || '';
                    if (content) {
                        memoryText += `[${time}] ${memory.context?.sender === 'user' ? 'ç”¨æˆ·' : 'AI'}è¯´: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}\n`;
                    }
                });

                return memoryText;
            } catch (error) {
                console.error('è·å–ç§èŠè®°å¿†å¤±è´¥:', error);
                return '';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åœ¨ç§èŠè®°å¿†ä¸­æœç´¢æ•°å­—
        async function searchNumberInPrivateChat(memberId, number) {
            try {
                // æœç´¢åŒ…å«è¯¥æ•°å­—çš„ç§èŠè®°å¿†
                const matchingMemories = await db.crossAppTimeline
                    .where('characterId').equals(memberId)
                    .and(event => event.appType === 'chat' &&
                                 event.context?.type === 'private_chat' &&
                                 (event.context?.content?.includes(number) ||
                                  event.context?.message?.includes(number)))
                    .reverse()
                    .limit(3)
                    .toArray();

                if (matchingMemories.length === 0) return '';

                let contextText = '';
                matchingMemories.forEach(memory => {
                    const time = new Date(memory.timestamp).toLocaleString();
                    const content = memory.context?.content || memory.context?.message || '';
                    if (content) {
                        contextText += `[${time}] ${memory.context?.sender === 'user' ? 'ç”¨æˆ·' : 'AI'}è¯´: ${content}\n`;
                    }
                });

                return contextText;
            } catch (error) {
                console.error('æœç´¢æ•°å­—è®°å¿†å¤±è´¥:', error);
                return '';
            }
        }

        // ä¿®æ”¹åŸæ¥çš„sendApiMessageå‡½æ•°ï¼Œä½¿å…¶åªå‘é€æ¶ˆæ¯åˆ°ç•Œé¢ï¼Œä¸è§¦å‘AIå›å¤
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();

            if (!message) return;

            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç§»é™¤æ‹‰é»‘æ£€æŸ¥ï¼Œå…è®¸æ¶ˆæ¯æ­£å¸¸å‘é€

            // é˜²æ­¢é‡å¤å‘é€
            if (input._isProcessing) return;
            input._isProcessing = true;

            try {
            // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ - ä½¿ç”¨æ•°ç»„æ ¼å¼
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: [{ type: 'text', text: message }], // ç»Ÿä¸€ä½¿ç”¨æ•°ç»„æ ¼å¼
                timestamp: Date.now(),
                // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œæ·»åŠ å¼•ç”¨ä¿¡æ¯
                replyTo: currentReplyTo ? {
                    id: currentReplyTo.id,
                    content: currentReplyTo.content,
                    senderName: currentReplyTo.senderName
                } : null
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            chatMessages[currentChatCharacter.id].push(userMessage);
            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const stableId = `${currentChatCharacter.id}_${userMessage.id}_${chatMessages[currentChatCharacter.id].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: currentChatCharacter.id,
                    timestamp: userMessage.timestamp,
                    messageOrder: chatMessages[currentChatCharacter.id].length - 1,
                    originalMessageId: userMessage.id,
                    messageData: userMessage
                });
                console.log('âœ… [é«˜æ•ˆå‘é€] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('å•æ¡æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                await saveChatMessagesImmediate();
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾å‘é€æ¶ˆæ¯éŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.MESSAGE_SENT, currentChatCharacter?.id);

            // æ¸…é™¤å¼•ç”¨çŠ¶æ€
            cancelReply();

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å½“å‰èŠå¤©çš„å¼•ç”¨çŠ¶æ€å­˜å‚¨
            if (currentChatCharacter) {
                delete chatReplyStates[currentChatCharacter.id];
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è°ƒæ•´å¿ƒç‡ï¼ˆç”¨æˆ·å‘æ¶ˆæ¯ï¼‰
            adjustHeartrateForMessage(message, true);

            // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°å®‰æ’ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
            onUserMessageSent(currentChatCharacter.id);

            // ğŸš«ã€ç§»é™¤ã€‘ä¸å†è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ¶ˆæ¯åˆ›å»ºçºªå¿µæ—¥ï¼Œè¿™å¤ªä¸è‡ªç„¶äº†

            // ä½¿ç”¨åŠ¨ç”»æ·»åŠ æ¶ˆæ¯è€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
            addMessageWithAnimation(userMessage, currentChatCharacter.id);

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
            checkAndCreateBlockedSystemMessage(userMessage, currentChatCharacter.id);

            // è®¾ç½®å¾…å›å¤æ¶ˆæ¯
            pendingUserMessage = userMessage;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
                }

            // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è®°å¿†å¤„ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
            setTimeout(async () => {
                try {
                    const messages = chatMessages[currentChatCharacter.id] || [];

                    // ğŸ”¥ã€ä¿®å¤ã€‘è®°å½•èŠå¤©æ—¶é—´çº¿äº‹ä»¶ - ç¾¤èŠéœ€è¦ä¸ºæ¯ä¸ªæˆå‘˜è®°å½•
                    if (currentChatCharacter?.isGroup) {
                        // ç¾¤èŠï¼šä¸ºæ¯ä¸ªç¾¤æˆå‘˜è®°å½•ç”¨æˆ·æ¶ˆæ¯äº‹ä»¶
                        for (const member of currentChatCharacter.members || []) {
                            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æ£€æŸ¥è¯¥æˆå‘˜æ˜¯å¦è®¾ç½®äº†ä¸å½“å‰ç¾¤èŠå…±äº«è®°å¿†
                            const shouldRecord = await shouldRecordGroupMemoryForCharacter(member.id, currentChatCharacter.id);
                            if (shouldRecord) {
                                await recordCrossAppEvent(
                                    member.id, // è®°å½•åˆ°æ¯ä¸ªæˆå‘˜çš„æ—¶é—´çº¿ä¸‹
                                    'chat',
                                    'user_message',
                                    {
                                        id: member.id, // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨è§’è‰²IDè€Œä¸æ˜¯ç¾¤èŠIDï¼Œç¡®ä¿è®°å¿†å…±äº«æ­£å¸¸å·¥ä½œ
                                        type: 'group_chat',
                                        sender: 'user',
                                        content: message,
                                        chatType: 'group',
                                        groupName: currentChatCharacter.name,
                                        groupId: currentChatCharacter.id // ğŸ”¥ã€æ–°å¢ã€‘ä¿ç•™ç¾¤èŠIDç”¨äºåŒºåˆ†
                                    },
                                    messages[messages.length - 1]?.id
                                );
                            } else {
                                console.log(`â­ï¸ è·³è¿‡è®°å½• - è§’è‰² ${member.id} æœªä¸ç¾¤èŠ ${currentChatCharacter.id} å…±äº«è®°å¿†`);
                            }
                        }
                    } else {
                        // å•èŠï¼šæ­£å¸¸è®°å½•
                        await recordCrossAppEvent(
                            currentChatCharacter.id,
                            'chat',
                            'user_message',
                            {
                                id: currentChatCharacter.id,
                                type: 'private_chat',
                                sender: 'user',
                                content: message,
                                chatType: 'single'
                            },
                            messages[messages.length - 1]?.id
                        );
                    }

                    // AIè®°å¿†æå–ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„é—´éš”ï¼‰
                    if (messages.length % MEMORY_CONFIG.AI_EXTRACT_INTERVAL === 0) {
                        const recentMessages = messages.slice(-MEMORY_CONFIG.AI_EXTRACT_INTERVAL);
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¼ å…¥ä¸Šä¸‹æ–‡IDç”¨äºè®°å¿†éš”ç¦»
                        await extractMemoriesWithAI(currentChatCharacter.id, recentMessages, currentChatCharacter.id);
                        console.log(`ğŸ§  è§¦å‘è®°å¿†æå– - è§’è‰²: ${currentChatCharacter.name}, æ¶ˆæ¯æ•°: ${messages.length}`);
                    }
                } catch (error) {
                    console.error('è®°å¿†å¤„ç†å¤±è´¥:', error);
                }
            }, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œé¿å…é˜»å¡UI

            } finally {
                // ç¡®ä¿å¤„ç†å®Œæˆåé‡ç½®æ ‡å¿—
                setTimeout(() => {
                    input._isProcessing = false;
                }, 100);
            }
        }

        // è¯­éŸ³å½•éŸ³ç›¸å…³å˜é‡
        let isRecording = false;
        let recordingStartTime = 0;

        // å¤„ç†è¯­éŸ³å½•éŸ³
        async function handleVoiceRecording() {
            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤å¯¹ä¸å­˜åœ¨æŒ‰é’®çš„ä¾èµ–ï¼Œç›´æ¥æ˜¾ç¤ºè¯­éŸ³è¾“å…¥å¯¹è¯æ¡†
                try {
                    const voiceText = await showVoiceInputDialog();
                    if (voiceText && voiceText.trim()) {
                        sendVoiceMessage(voiceText.trim());
                        console.log('è¯­éŸ³æ¶ˆæ¯å‘é€æˆåŠŸ');
                    }
                } catch (error) {
                    // åªæœ‰åœ¨çœŸæ­£å–æ¶ˆæ—¶æ‰æ˜¾ç¤ºå–æ¶ˆæ¶ˆæ¯
                    if (error.message === 'ç”¨æˆ·å–æ¶ˆ') {
                        console.log('ç”¨æˆ·å–æ¶ˆäº†è¯­éŸ³è¾“å…¥');
                    } else {
                        console.error('è¯­éŸ³æ¶ˆæ¯å‘é€å¤±è´¥:', error);
                    }
            }
        }

        // é‡ç½®å½•éŸ³çŠ¶æ€ - ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤å¯¹ä¸å­˜åœ¨æŒ‰é’®çš„ä¾èµ–
        function resetRecordingState() {
            isRecording = false;
            // ä¸å†éœ€è¦æ“ä½œæŒ‰é’®çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å·¥å…·é¢æ¿ä¸­çš„è¯­éŸ³æŒ‰é’®
        }

        // æ˜¾ç¤ºè¯­éŸ³è¾“å…¥å¯¹è¯æ¡†
        function showVoiceInputDialog() {
            return new Promise((resolve, reject) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    width: 280px;
                    max-width: 90%;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;

                dialog.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">è¯­éŸ³è½¬æ–‡å­—</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">è¯·è¾“å…¥æ‚¨æƒ³è¯´çš„å†…å®¹ï¼š</p>
                    </div>
                    <textarea id="voice-text-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹..." style="
                        width: 100%;
                        height: 80px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        padding: 10px;
                        font-size: 14px;
                        resize: none;
                        box-sizing: border-box;
                        outline: none;
                    "></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="voice-cancel-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">å–æ¶ˆ</button>
                        <button id="voice-send-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: none;
                            background: #4a84c1;
                            color: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">å‘é€</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                const textInput = dialog.querySelector('#voice-text-input');
                const cancelBtn = dialog.querySelector('#voice-cancel-btn');
                const sendBtn = dialog.querySelector('#voice-send-btn');

                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => textInput.focus(), 100);

                // å–æ¶ˆæŒ‰é’®
                cancelBtn.onclick = () => {
                    document.body.removeChild(overlay);
                    reject(new Error('ç”¨æˆ·å–æ¶ˆ'));
                };

                // å‘é€æŒ‰é’®
                sendBtn.onclick = () => {
                    const text = textInput.value.trim();
                    if (text) {
                        console.log('è¯­éŸ³è¾“å…¥å¯¹è¯æ¡†ï¼šç”¨æˆ·ç‚¹å‡»å‘é€ï¼Œå†…å®¹:', text);
                        document.body.removeChild(overlay);
                        resolve(text);
                    } else {
                        console.log('è¯­éŸ³è¾“å…¥å¯¹è¯æ¡†ï¼šå†…å®¹ä¸ºç©ºï¼Œèšç„¦è¾“å…¥æ¡†');
                        textInput.focus();
                    }
                };

                // ç‚¹å‡»é®ç½©å…³é—­
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        reject(new Error('ç”¨æˆ·å–æ¶ˆ'));
                    }
                };

                // æ”¯æŒå›è½¦å‘é€
                textInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('è¯­éŸ³è¾“å…¥æ¡†ï¼šç”¨æˆ·æŒ‰å›è½¦é”®å‘é€');
                        sendBtn.click();
                    }
                };
            });
        }

                 // å‘é€è¯­éŸ³æ¶ˆæ¯
        async function sendVoiceMessage(text) {
            console.log('å¼€å§‹å‘é€è¯­éŸ³æ¶ˆæ¯:', text);

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç§»é™¤æ‹‰é»‘æ£€æŸ¥ï¼Œå…è®¸è¯­éŸ³æ¶ˆæ¯æ­£å¸¸å‘é€

            const messageId = Date.now().toString();
            const duration = Math.max(1, Math.ceil(text.length / 8)); // æ ¹æ®æ–‡å­—é•¿åº¦è®¡ç®—"è¯­éŸ³"æ—¶é•¿

            const voiceMessage = {
                id: messageId,
                sender: 'sent',
                type: 'voice',
                content: text,
                duration: duration,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            chatMessages[currentChatCharacter.id].push(voiceMessage);
            console.log('è¯­éŸ³æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©è®°å½•');

            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡è¯­éŸ³æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const stableId = `${currentChatCharacter.id}_${voiceMessage.id}_${chatMessages[currentChatCharacter.id].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: currentChatCharacter.id,
                    timestamp: voiceMessage.timestamp,
                    messageOrder: chatMessages[currentChatCharacter.id].length - 1,
                    originalMessageId: voiceMessage.id,
                    messageData: voiceMessage
                });
                console.log('âœ… [é«˜æ•ˆè¯­éŸ³] è¯­éŸ³æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('è¯­éŸ³æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                saveChatMessages();
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è°ƒæ•´å¿ƒç‡ï¼ˆç”¨æˆ·å‘è¯­éŸ³æ¶ˆæ¯ï¼‰
            adjustHeartrateForMessage(text, true);

            // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°å®‰æ’ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
            onUserMessageSent(currentChatCharacter.id);

            // æ·»åŠ è¯­éŸ³æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageWithAnimation(voiceMessage, currentChatCharacter.id);
            console.log('è¯­éŸ³æ¶ˆæ¯å·²æ·»åŠ åˆ°ç•Œé¢');

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
            checkAndCreateBlockedSystemMessage(voiceMessage, currentChatCharacter.id);

            // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘è§’è‰²çŠ¶æ€æ›´æ–°
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);

            // è®¾ç½®å¾…å›å¤æ¶ˆæ¯
            pendingUserMessage = voiceMessage;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
            }

            console.log('è¯­éŸ³æ¶ˆæ¯å‘é€æµç¨‹å®Œæˆ');
        }

        // åˆ‡æ¢è¯­éŸ³æ–‡æœ¬æ˜¾ç¤º
        function toggleVoiceText(voiceElement) {
            const container = voiceElement.closest('.voice-message-container') || voiceElement.closest('.message-container');
            if (!container) return;

            const textContent = container.querySelector('.voice-text-content');
            if (!textContent) {
                // å¦‚æœæ²¡æœ‰æ–‡æœ¬å®¹å™¨ï¼Œåˆ›å»ºä¸€ä¸ª
                const text = voiceElement.getAttribute('data-text');
                if (!text) return;

                const newTextContent = document.createElement('div');
                newTextContent.className = 'voice-text-content';
                newTextContent.textContent = text;

                // æ ¹æ®æ¶ˆæ¯ç±»å‹å†³å®šæ’å…¥ä½ç½®
                if (container.classList.contains('voice-message-container')) {
                    container.appendChild(newTextContent);
                } else {
                    // ä¸ºæ—§æ ¼å¼åˆ›å»ºè¯­éŸ³å®¹å™¨
                    const voiceContainer = document.createElement('div');
                    voiceContainer.className = container.classList.contains('sent') ? 'voice-message-container sent' : 'voice-message-container received';

                    // ç§»åŠ¨ç°æœ‰çš„æ¶ˆæ¯æ°”æ³¡åˆ°è¯­éŸ³å®¹å™¨ä¸­
                    const bubble = container.querySelector('.message-bubble');
                    if (bubble) {
                        container.removeChild(bubble);
                        voiceContainer.appendChild(bubble);
                        voiceContainer.appendChild(newTextContent);
                        container.appendChild(voiceContainer);
                    }
                }

                // æ˜¾ç¤ºæ–‡æœ¬
                setTimeout(() => {
                    newTextContent.classList.add('visible');
                }, 10);

                return;
            }

            // åˆ‡æ¢æ–‡æœ¬æ˜¾ç¤º/éšè—
            if (textContent.classList.contains('visible')) {
                textContent.classList.remove('visible');
                setTimeout(() => {
                    textContent.style.display = 'none';
                }, 300);
            } else {
                textContent.style.display = 'block';
                setTimeout(() => {
                    textContent.classList.add('visible');
                }, 10);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é˜²é‡å¤åŠ è½½æ ‡å¿—
        let isLoadingMoments = false;

        // åŠ è½½åŠ¨æ€
        async function loadMoments() {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘é˜²æ­¢é‡å¤åŠ è½½
                if (isLoadingMoments) {
                    console.log('åŠ¨æ€æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                    return;
                }

                isLoadingMoments = true;

                const momentsList = document.getElementById('moments-list');
                if (!momentsList) {
                    isLoadingMoments = false;
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘è®°å½•å½“å‰å·²æ˜¾ç¤ºçš„åŠ¨æ€IDï¼Œé¿å…é‡å¤æ˜¾ç¤º
                const existingMomentIds = new Set();
                Array.from(momentsList.children).forEach(child => {
                    const momentId = child.getAttribute('data-moment-id');
                    if (momentId) {
                        existingMomentIds.add(momentId);
                    }
                });

                // ä»æ•°æ®åº“åŠ è½½åŠ¨æ€æ•°æ®
                const momentsData = await db.moments.orderBy('timestamp').reverse().toArray();

                // ğŸ”¥ã€ä¿®å¤ã€‘åªæœ‰åœ¨åˆ—è¡¨ä¸ºç©ºæ—¶æ‰æ¸…ç©ºå¹¶é‡æ–°åŠ è½½æ‰€æœ‰åŠ¨æ€
                if (existingMomentIds.size === 0) {
                    momentsList.innerHTML = '';
                    console.log('åŠ¨æ€åˆ—è¡¨ä¸ºç©ºï¼ŒåŠ è½½æ‰€æœ‰åŠ¨æ€');
                } else {
                    console.log('åŠ¨æ€åˆ—è¡¨ä¸ä¸ºç©ºï¼Œè¿›è¡Œå¢é‡æ›´æ–°');
                }

                if (momentsData.length > 0) {
                    for (const momentData of momentsData) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡è¿™æ¡åŠ¨æ€
                        if (existingMomentIds.has(momentData.id.toString())) {
                            continue; // è·³è¿‡å·²å­˜åœ¨çš„åŠ¨æ€
                        }
                        // è·å–ç‚¹èµæ•°
                        const likesCount = await db.momentLikes.where('momentId').equals(momentData.id).count();

                        // è·å–è¯„è®ºæ•°
                        const commentsCount = await db.momentComments.where('momentId').equals(momentData.id).count();

                        // è·å–è¯„è®ºåˆ—è¡¨
                        const comments = await db.momentComments.where('momentId').equals(momentData.id).toArray();
                        comments.sort((a, b) => a.timestamp - b.timestamp); // æŒ‰æ—¶é—´æˆ³æ’åº

                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–ä½ç½®ä¿¡æ¯
                        const locationData = await db.momentLocations.where('momentId').equals(momentData.id).first();
                        const location = locationData ? locationData.locationName : '';

                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–æé†’ä¿¡æ¯
                        const mentionData = await db.momentMentions.where('momentId').equals(momentData.id).toArray();
                        const mentions = mentionData.map(m => m.mentionedCharacterId);

                        // ğŸ”¥ã€æ–°å¢ã€‘è·å–å¯è§æ€§ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå¯è§æ€§æ ‡è¯†ï¼‰
                        const visibilityData = await db.momentVisibility.where('momentId').equals(momentData.id).first();
                        const visibility = visibilityData ? visibilityData.visibility : 'public';
                        const visibleGroups = visibilityData ? visibilityData.visibleGroups : [];

                            // ğŸ”¥ã€ä¿®å¤ã€‘éªŒè¯å¹¶å¤„ç†å¤´åƒ
                            let avatarToUse = null;
                            if (momentData.avatar && isValidAvatarUrl(momentData.avatar)) {
                                avatarToUse = momentData.avatar;
                            } else {
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨awaitè·å–é»˜è®¤å¤´åƒ
                                avatarToUse = await getDefaultAvatar();
                                // å¦‚æœæ•°æ®åº“ä¸­å­˜å‚¨çš„å¤´åƒæ— æ•ˆï¼Œæ›´æ–°æ•°æ®åº“è®°å½•
                                if (momentData.avatar && !isValidAvatarUrl(momentData.avatar)) {
                                    console.log(`æ¸…ç†åŠ¨æ€ ${momentData.id} çš„æ— æ•ˆå¤´åƒ`);
                                    try {
                                        await db.moments.update(momentData.id, { avatar: avatarToUse });
                                    } catch (error) {
                                        console.error('æ›´æ–°åŠ¨æ€å¤´åƒå¤±è´¥:', error);
                                    }
                                }
                            }

                            const momentElement = createMomentElement({
                            id: momentData.id,
                                authorId: momentData.authorId, // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ authorIdå­—æ®µ
                                nickname: momentData.nickname,
                                avatar: avatarToUse,
                                text: momentData.text,
                                images: momentData.images || [],
                                time: momentData.time,
                            timestamp: momentData.timestamp,
                            likes: likesCount,
                            comments: comments,
                            location: location, // ğŸ”¥ã€æ–°å¢ã€‘ä½ç½®ä¿¡æ¯
                            mentions: mentions, // ğŸ”¥ã€æ–°å¢ã€‘æé†’ä¿¡æ¯
                            visibility: visibility, // ğŸ”¥ã€æ–°å¢ã€‘å¯è§æ€§ä¿¡æ¯
                            visibleGroups: visibleGroups // ğŸ”¥ã€æ–°å¢ã€‘å¯è§åˆ†ç»„ä¿¡æ¯
                            });

                            // ğŸ”¥ã€ä¿®å¤ã€‘æŒ‰æ—¶é—´é¡ºåºæ’å…¥åŠ¨æ€
                            const newTimestamp = momentData.timestamp;
                            let insertPosition = null;

                            // æ‰¾åˆ°æ­£ç¡®çš„æ’å…¥ä½ç½®ï¼ˆæŒ‰æ—¶é—´æˆ³é™åºï¼‰
                            for (let i = 0; i < momentsList.children.length; i++) {
                                const existingElement = momentsList.children[i];
                                const existingTimestamp = parseInt(existingElement.getAttribute('data-timestamp') || '0');

                                if (newTimestamp > existingTimestamp) {
                                    insertPosition = existingElement;
                                    break;
                                }
                            }

                            // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
                            if (insertPosition) {
                                momentsList.insertBefore(momentElement, insertPosition);
                            } else {
                                momentsList.appendChild(momentElement);
                            }

                            // æ›´æ–°ç‚¹èµæ˜¾ç¤º
                        updateMomentLikeDisplay(momentData.id);

                            // æ˜¾ç¤ºå·²æœ‰è¯„è®º
                        if (comments && comments.length > 0) {
                            comments.forEach(comment => {
                                // ç¡®ä¿è¯„è®ºæœ‰timeå­—æ®µï¼Œå¦‚æœæ²¡æœ‰å°±ä»timestampç”Ÿæˆ
                                if (!comment.time && comment.timestamp) {
                                    comment.time = formatTime(new Date(comment.timestamp));
                                }
                                displayCommentUnderMoment(momentData.id, comment);
                                });
                            }
                    }

                        console.log('æˆåŠŸåŠ è½½', momentsData.length, 'æ¡åŠ¨æ€');
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„åŠ¨æ€æ•°æ®');
                }

                // å¯åŠ¨æ—¶é—´æ›´æ–°
                startTimeUpdater();

                console.log('æˆåŠŸåŠ è½½', momentsData.length, 'æ¡åŠ¨æ€');
            } catch (error) {
                console.error('åŠ è½½åŠ¨æ€å¤±è´¥:', error);
            } finally {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½è¦é‡ç½®åŠ è½½æ ‡å¿—
                isLoadingMoments = false;
            }
        }

        // å‘å¸ƒåŠ¨æ€ç›¸å…³å˜é‡
        let momentImages = [];
        let selectedLocation = '';
        let selectedMomentMentions = []; // å­˜å‚¨åŠ¨æ€ä¸­è¢«æé†’çš„è§’è‰²ID
        let selectedVisibility = 'public'; // å­˜å‚¨åŠ¨æ€å¯è§æ€§è®¾ç½®ï¼špublic, private, partial
        let selectedVisibilityGroups = []; // å­˜å‚¨éƒ¨åˆ†å¯è§æ—¶é€‰æ‹©çš„åˆ†ç»„ID

        // æ˜¾ç¤ºå‘å¸ƒåŠ¨æ€ç•Œé¢
        function showPublishMoment() {
            showApp('publish-moment-screen');
            // é‡ç½®è¡¨å•
            document.getElementById('moment-text').value = '';
            momentImages = [];
            updateMomentImagesGrid();
            // é‡ç½®ä½ç½®é€‰æ‹©
            document.getElementById('selected-location').textContent = '';
            selectedLocation = '';
            document.querySelector('.location-icon').classList.remove('active');
            // é‡ç½®æé†’é€‰æ‹©
            selectedMomentMentions = [];
            updateSelectedMomentMentionsDisplay();
            // é‡ç½®å¯è§æ€§é€‰æ‹©
            selectedVisibility = 'public';
            selectedVisibilityGroups = [];
            updateSelectedVisibilityDisplay();

            // é‡ç½®å‘å¸ƒæŒ‰é’®çŠ¶æ€
            const publishBtn = document.querySelector('.publish-btn');
            if (publishBtn) {
                publishBtn.disabled = false;
                publishBtn.textContent = 'å‘è¡¨';
            }
        }

        // éšè—å‘å¸ƒåŠ¨æ€ç•Œé¢
        function hidePublishMoment() {
            showApp('chat-screen');
                                    // åˆ‡æ¢å›åŠ¨æ€æ ‡ç­¾
            switchChatTab('moments-page');
            // ä¸éœ€è¦é‡æ–°åŠ è½½ï¼ŒåŠ¨æ€å·²ç»åœ¨æ•°æ®åº“ä¸­
        }

        // æ˜¾ç¤ºä½ç½®é€‰æ‹©æ¨¡æ€æ¡†
        function showLocationModal() {
            document.getElementById('location-modal').style.display = 'flex';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('location-input').value = '';
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('location-input').focus();
            }, 100);
        }

        // éšè—ä½ç½®é€‰æ‹©æ¨¡æ€æ¡†
        function hideLocationModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('location-modal').style.display = 'none';
        }

        // ç¡®è®¤ä½ç½®é€‰æ‹©
        function confirmLocation() {
            const locationInput = document.getElementById('location-input');
            const location = locationInput.value.trim();
            const locationIcon = document.querySelector('.location-icon');

            if (location) {
                selectedLocation = location;
                document.getElementById('selected-location').textContent = location;
                locationIcon.classList.add('active');
            } else {
                selectedLocation = '';
                document.getElementById('selected-location').textContent = '';
                locationIcon.classList.remove('active');
            }

            hideLocationModal();
        }

        // å¤„ç†ä½ç½®è¾“å…¥æ¡†çš„å›è½¦é”®
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location-input');
            if (locationInput) {
                locationInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        confirmLocation();
                    }
                });
            }
        });

        // æ˜¾ç¤ºåŠ¨æ€æé†’è°çœ‹æ¨¡æ€æ¡†
        function showMomentMentionModal() {
            document.getElementById('mention-modal').style.display = 'flex';
            loadMomentMentionCharacters();
        }

        // éšè—åŠ¨æ€æé†’è°çœ‹æ¨¡æ€æ¡†
        function hideMomentMentionModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('mention-modal').style.display = 'none';
        }

        // åŠ è½½å¯æé†’çš„è§’è‰²åˆ—è¡¨
        function loadMomentMentionCharacters() {
            const charactersList = document.getElementById('mention-characters-list');
            charactersList.innerHTML = '';

            if (!characters || characters.length === 0) {
                charactersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— è§’è‰²</div>';
                return;
            }

            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'mention-character-item';
                characterItem.setAttribute('data-character-id', character.id);

                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
                if (selectedMomentMentions.includes(character.id)) {
                    characterItem.classList.add('selected');
                }

                // è·å–è§’è‰²å¤´åƒ - ä¼˜å…ˆä½¿ç”¨èŠå¤©çª—å£å¤´åƒï¼Œç„¶åæ˜¯è§’è‰²å¡å¤´åƒ
                let avatarUrl = character.avatarUrl || createDefaultAvatar(character.name);

                characterItem.innerHTML = `
                    <img src="${avatarUrl}" alt="${character.name}" class="mention-character-avatar"
                         onerror="this.src='${createDefaultAvatar(character.name)}'">
                    <div class="mention-character-info">
                        <div class="mention-character-name">${character.name}</div>
                    </div>
                    <div class="mention-character-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                `;

                characterItem.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMomentMentionCharacter(character.id);
                };
                charactersList.appendChild(characterItem);
            });
        }

        // åˆ‡æ¢è§’è‰²é€‰æ‹©çŠ¶æ€
        function toggleMomentMentionCharacter(characterId) {
            const index = selectedMomentMentions.indexOf(characterId);
            const characterItem = document.querySelector(`.mention-character-item[data-character-id="${characterId}"]`);

            if (index > -1) {
                // å–æ¶ˆé€‰æ‹©
                selectedMomentMentions.splice(index, 1);
                characterItem.classList.remove('selected');
            } else {
                // æ·»åŠ é€‰æ‹©
                selectedMomentMentions.push(characterId);
                characterItem.classList.add('selected');
            }

            console.log('Toggle moment mention:', characterId, 'Selected mentions:', selectedMomentMentions);
        }

        // ç¡®è®¤æé†’é€‰æ‹©
        function confirmMomentMention() {
            updateSelectedMomentMentionsDisplay();
            hideMomentMentionModal();
        }

        // æ›´æ–°å·²é€‰æ‹©è§’è‰²çš„æ˜¾ç¤º
        function updateSelectedMomentMentionsDisplay() {
            const selectedMentionsContainer = document.getElementById('selected-mentions');
            const mentionIcon = document.querySelector('.mention-icon');
            selectedMentionsContainer.innerHTML = '';

            if (selectedMomentMentions.length > 0) {
                mentionIcon.classList.add('active');
                selectedMomentMentions.forEach(characterId => {
                    const character = characters.find(c => c.id === characterId);
                    if (character) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = character.avatarUrl || createDefaultAvatar(character.name);
                        avatarImg.alt = character.name;
                        avatarImg.className = 'selected-mention-avatar';
                        avatarImg.onerror = function() {
                            this.src = createDefaultAvatar(character.name);
                        };
                        selectedMentionsContainer.appendChild(avatarImg);
                    }
                });
            } else {
                mentionIcon.classList.remove('active');
            }
        }

        // åˆ›å»ºåŠ¨æ€ä¸­çš„æé†’æ˜¾ç¤º
        function createMomentMentionsDisplay(mentionIds) {
            if (!mentionIds || mentionIds.length === 0) return '';

            const mentionNames = mentionIds.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : 'æœªçŸ¥è§’è‰²';
            }).filter(name => name !== 'æœªçŸ¥è§’è‰²');

            if (mentionNames.length === 0) return '';

            return `<div class="moment-mentions">æåˆ°äº†ï¼š${mentionNames.join('ï¼Œ')}</div>`;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ›å»ºå¯è§æ€§æŒ‡ç¤ºå™¨
        function createVisibilityIndicator(visibility, visibleGroups) {
            if (!visibility || visibility === 'public') {
                return ''; // å…¬å¼€åŠ¨æ€ä¸æ˜¾ç¤ºæ ‡è¯†
            }

            let icon = '';
            let title = '';
            let text = '';

            switch (visibility) {
                case 'private':
                    icon = 'fas fa-lock';
                    title = 'ç§å¯†';
                    text = 'ç§å¯†';
                    break;
                case 'partial':
                    icon = 'fas fa-users';
                    title = 'éƒ¨åˆ†å¯è§';
                    if (visibleGroups && visibleGroups.length > 0) {
                        const groupNames = visibleGroups.map(id => {
                            const group = characterGroups.find(g => g.id === id);
                            return group ? group.name : 'æœªçŸ¥åˆ†ç»„';
                        }).filter(name => name !== 'æœªçŸ¥åˆ†ç»„');
                        text = groupNames.length > 0 ? groupNames.join('ã€') : 'éƒ¨åˆ†å¯è§';
                    } else {
                        text = 'éƒ¨åˆ†å¯è§';
                    }
                    break;
                default:
                    return '';
            }

            return `<span class="moment-visibility-indicator" title="${title}">
                <i class="${icon}"></i>
                <span>${text}</span>
            </span>`;
        }

        // æ˜¾ç¤ºè°å¯ä»¥çœ‹æ¨¡æ€æ¡†
        function showVisibilityModal() {
            document.getElementById('visibility-modal').style.display = 'flex';
            loadVisibilityOptions();
        }

        // éšè—è°å¯ä»¥çœ‹æ¨¡æ€æ¡†
        function hideVisibilityModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('visibility-modal').style.display = 'none';
        }

        // åŠ è½½å¯è§æ€§é€‰é¡¹
        function loadVisibilityOptions() {
            const options = document.querySelectorAll('.visibility-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === selectedVisibility) {
                    option.classList.add('selected');
                }
                option.onclick = () => selectVisibilityOption(option.dataset.value);
            });

            // å¦‚æœé€‰æ‹©äº†éƒ¨åˆ†å¯è§ï¼Œæ˜¾ç¤ºåˆ†ç»„é€‰æ‹©
            if (selectedVisibility === 'partial') {
                showVisibilityGroups();
            } else {
                hideVisibilityGroups();
            }
        }

        // é€‰æ‹©å¯è§æ€§é€‰é¡¹
        function selectVisibilityOption(value) {
            selectedVisibility = value;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const options = document.querySelectorAll('.visibility-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === value) {
                    option.classList.add('selected');
                }
            });

            // å¦‚æœé€‰æ‹©éƒ¨åˆ†å¯è§ï¼Œæ˜¾ç¤ºåˆ†ç»„é€‰æ‹©
            if (value === 'partial') {
                showVisibilityGroups();
            } else {
                hideVisibilityGroups();
                selectedVisibilityGroups = []; // æ¸…ç©ºåˆ†ç»„é€‰æ‹©
            }
        }

        // æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©åŒºåŸŸ
        function showVisibilityGroups() {
            const groupsSection = document.getElementById('visibility-groups-section');
            const groupsList = document.getElementById('visibility-groups-list');

            groupsSection.style.display = 'block';
            groupsList.innerHTML = '';

            // åªæ˜¾ç¤ºå¯ä»¥äº’åŠ¨çš„åˆ†ç»„ï¼ˆéé»˜è®¤åˆ†ç»„ä¸”å…è®¸äº’åŠ¨ï¼‰
            const interactableGroups = characterGroups.filter(group =>
                !group.isDefault && group.canInteract
            );

            if (interactableGroups.length === 0) {
                groupsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— å¯é€‰æ‹©çš„åˆ†ç»„</div>';
                return;
            }

            interactableGroups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'visibility-group-item';
                groupItem.setAttribute('data-group-id', group.id);

                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
                if (selectedVisibilityGroups.includes(group.id)) {
                    groupItem.classList.add('selected');
                }

                groupItem.innerHTML = `
                    <div class="visibility-group-name">${group.name}</div>
                    <div class="visibility-group-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                `;

                groupItem.onclick = () => toggleVisibilityGroup(group.id);
                groupsList.appendChild(groupItem);
            });
        }

        // éšè—åˆ†ç»„é€‰æ‹©åŒºåŸŸ
        function hideVisibilityGroups() {
            const groupsSection = document.getElementById('visibility-groups-section');
            groupsSection.style.display = 'none';
        }

        // åˆ‡æ¢åˆ†ç»„é€‰æ‹©çŠ¶æ€
        function toggleVisibilityGroup(groupId) {
            const index = selectedVisibilityGroups.indexOf(groupId);
            const groupItem = document.querySelector(`.visibility-group-item[data-group-id="${groupId}"]`);

            if (index > -1) {
                // å–æ¶ˆé€‰æ‹©
                selectedVisibilityGroups.splice(index, 1);
                groupItem.classList.remove('selected');
            } else {
                // æ·»åŠ é€‰æ‹©
                selectedVisibilityGroups.push(groupId);
                groupItem.classList.add('selected');
            }
        }

        // ç¡®è®¤å¯è§æ€§é€‰æ‹©
        function confirmVisibility() {
            updateSelectedVisibilityDisplay();
            hideVisibilityModal();
        }

        // æ›´æ–°å·²é€‰æ‹©å¯è§æ€§çš„æ˜¾ç¤º
        function updateSelectedVisibilityDisplay() {
            const visibilityElement = document.getElementById('selected-visibility');
            const visibilityIcon = document.querySelector('.visibility-icon');

            let displayText = '';
            let isActive = false;

            switch (selectedVisibility) {
                case 'public':
                    displayText = 'å…¬å¼€';
                    isActive = false; // å…¬å¼€æ˜¯é»˜è®¤çŠ¶æ€ï¼Œä¿æŒç°è‰²
                    break;
                case 'private':
                    displayText = 'ç§å¯†';
                    isActive = true;
                    break;
                case 'partial':
                    if (selectedVisibilityGroups.length > 0) {
                        const groupNames = selectedVisibilityGroups.map(id => {
                            const group = characterGroups.find(g => g.id === id);
                            return group ? group.name : 'æœªçŸ¥åˆ†ç»„';
                        }).filter(name => name !== 'æœªçŸ¥åˆ†ç»„');
                        displayText = `${groupNames.join('ã€')}å¯è§`;
                        isActive = true;
                    } else {
                        displayText = 'éƒ¨åˆ†å¯è§';
                        isActive = true;
                    }
                    break;
            }

            visibilityElement.textContent = displayText;

            if (isActive) {
                visibilityIcon.classList.add('active');
            } else {
                visibilityIcon.classList.remove('active');
            }
        }

        // æ·»åŠ å›¾ç‰‡åˆ°åŠ¨æ€
        function addMomentImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.jpg,.jpeg,.png,.gif,.webp';
            input.multiple = true;
            input.onchange = function(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    if (momentImages.length < 9) { // æœ€å¤š9å¼ å›¾ç‰‡
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                // å‹ç¼©å›¾ç‰‡
                                const compressedImage = await compressImage(e.target.result, 800, 0.8);
                                momentImages.push(compressedImage);
                                updateMomentImagesGrid();
                            } catch (error) {
                                showToast("å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•");                                console.error("å‹ç¼©å›¾ç‰‡å¤±è´¥:", error);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };
            input.click();
        }

        // åˆ é™¤å›¾ç‰‡
        function removeMomentImage(index) {
            momentImages.splice(index, 1);
            updateMomentImagesGrid();
        }

        // æ›´æ–°å›¾ç‰‡ç½‘æ ¼æ˜¾ç¤º
        function updateMomentImagesGrid() {
            const grid = document.getElementById('moment-images-grid');
            grid.innerHTML = '';

            momentImages.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'moment-image-item';
                imageItem.innerHTML = `
                    <img src="${imageData}" alt="åŠ¨æ€å›¾ç‰‡">
                    <button class="remove-image-btn" onclick="removeMomentImage(${index})">Ã—</button>
                `;
                grid.appendChild(imageItem);
            });
        }

        // å‘å¸ƒåŠ¨æ€

        // è·å–é»˜è®¤å¤´åƒ - ä¿®å¤å¼‚æ­¥é—®é¢˜
        async function getDefaultAvatar() {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨awaitè·å–åŠ¨æ€å¤´åƒï¼Œç¡®ä¿å¼‚æ­¥æ“ä½œæ­£ç¡®å®Œæˆ
                const momentsAvatar = await getMomentsImage("avatarImage");
                if (momentsAvatar && isValidAvatarUrl(momentsAvatar)) {
                    console.log('ä½¿ç”¨åŠ¨æ€é¡µé¢è®¾ç½®çš„å¤´åƒ');
                    return momentsAvatar;
                }

                // å°è¯•è·å–ç”¨æˆ·å¤´åƒï¼Œä½†è¦éªŒè¯å…¶æœ‰æ•ˆæ€§
                if (window.userAvatar && isValidAvatarUrl(window.userAvatar)) {
                    console.log('ä½¿ç”¨å…¨å±€ç”¨æˆ·å¤´åƒ');
                    return window.userAvatar;
                }

                // æ¸…ç†æ— æ•ˆçš„ç”¨æˆ·å¤´åƒæ•°æ®
                if (window.userAvatar && !isValidAvatarUrl(window.userAvatar)) {
                    console.log('æ¸…ç†æ— æ•ˆçš„ç”¨æˆ·å¤´åƒæ•°æ®');
                    window.userAvatar = null;
                }

                // æ¸…ç†æ— æ•ˆçš„åŠ¨æ€å¤´åƒæ•°æ®
                if (momentsAvatar && !isValidAvatarUrl(momentsAvatar)) {
                    console.log('æ¸…ç†æ— æ•ˆçš„åŠ¨æ€å¤´åƒæ•°æ®');
                    // è¿™é‡Œéœ€è¦è°ƒç”¨æ¸…ç†å‡½æ•°ï¼Œä½†ç”±äºgetMomentsImageçš„å­˜å‚¨æœºåˆ¶ï¼Œæˆ‘ä»¬å…ˆè·³è¿‡
                }

                console.log('ä½¿ç”¨é»˜è®¤ç”Ÿæˆçš„å¤´åƒ');
                // è¿”å›é»˜è®¤å¤´åƒï¼ˆä½¿ç”¨CSSç”Ÿæˆçš„ç®€å•å¤´åƒï¼‰
                return "data:image/svg+xml;base64," + btoa(`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><rect width="50" height="50" fill="#f0f0f0"/><circle cx="25" cy="20" r="8" fill="#999"/><circle cx="25" cy="40" r="12" fill="#999"/></svg>`);
            } catch (error) {
                console.error('è·å–é»˜è®¤å¤´åƒå¤±è´¥:', error);
                return "data:image/svg+xml;base64," + btoa(`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><rect width="50" height="50" fill="#f0f0f0"/><circle cx="25" cy="20" r="8" fill="#999"/><circle cx="25" cy="40" r="12" fill="#999"/></svg>`);
            }
        }        async function publishMoment() {
            const text = document.getElementById('moment-text').value.trim();
            const publishBtn = document.querySelector('.publish-btn');

            if (!text && momentImages.length === 0) {
                showToast('è¯·è¾“å…¥æ–‡å­—æˆ–é€‰æ‹©å›¾ç‰‡');
                return;
            }

            // ç¦ç”¨å‘å¸ƒæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            publishBtn.disabled = true;
            publishBtn.textContent = 'å‘å¸ƒä¸­...';

            // è·å–å½“å‰ç”¨æˆ·æ˜µç§°
            const nickname = document.getElementById('moments-username')?.textContent || 'æˆ‘';

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨awaitè·å–ç”¨æˆ·å¤´åƒ
            const userAvatar = await getDefaultAvatar();

            // åˆ›å»ºæ–°åŠ¨æ€
            const now = new Date();
            const newMoment = {
                id: Date.now(),
                authorId: 'user',
                nickname: nickname,
                avatar: userAvatar,
                text: text,
                images: [...momentImages],
                location: selectedLocation || '', // æ·»åŠ ä½ç½®ä¿¡æ¯
                mentions: [...selectedMomentMentions], // æ·»åŠ æé†’è§’è‰²ä¿¡æ¯
                time: formatTime(now),
                timestamp: now.getTime(),
                visibility: selectedVisibility, // ğŸ”¥ã€æ–°å¢ã€‘å¯è§æ€§ä¿¡æ¯
                visibleGroups: [...selectedVisibilityGroups] // ğŸ”¥ã€æ–°å¢ã€‘å¯è§åˆ†ç»„ä¿¡æ¯
            };

            try {
                // ä¿å­˜åˆ°æ•°æ®åº“
                await db.moments.add(newMoment);

                // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å¯è§æ€§è®¾ç½®åˆ°æ•°æ®åº“
                if (selectedVisibility !== 'public' || selectedVisibilityGroups.length > 0) {
                    await db.momentVisibility.add({
                        momentId: newMoment.id,
                        visibility: selectedVisibility,
                        visibleGroups: selectedVisibilityGroups,
                        timestamp: new Date()
                    });
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜ä½ç½®ä¿¡æ¯åˆ°æ•°æ®åº“
                if (selectedLocation) {
                    await db.momentLocations.add({
                        momentId: newMoment.id,
                        locationName: selectedLocation,
                        latitude: null, // å¯ä»¥åç»­æ‰©å±•GPSåŠŸèƒ½
                        longitude: null,
                        timestamp: new Date()
                    });
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜æé†’ä¿¡æ¯åˆ°æ•°æ®åº“
                if (selectedMomentMentions.length > 0) {
                    for (const characterId of selectedMomentMentions) {
                        await db.momentMentions.add({
                            momentId: newMoment.id,
                            mentionedCharacterId: characterId,
                            timestamp: new Date(),
                            isRead: false
                        });
                    }
                }

                // æ¢å¤å‘å¸ƒæŒ‰é’®çŠ¶æ€
                publishBtn.disabled = false;
                publishBtn.textContent = 'å‘è¡¨';

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('å‘å¸ƒæˆåŠŸï¼');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('moment-text').value = '';
                momentImages = [];
                updateMomentImagesGrid();
                // é‡ç½®ä½ç½®é€‰æ‹©
                document.getElementById('selected-location').textContent = '';
                selectedLocation = '';
                document.querySelector('.location-icon').classList.remove('active');
                // é‡ç½®æé†’é€‰æ‹©
                selectedMomentMentions = [];
                updateSelectedMomentMentionsDisplay();
                // é‡ç½®å¯è§æ€§é€‰æ‹©
                selectedVisibility = 'public';
                selectedVisibilityGroups = [];
                updateSelectedVisibilityDisplay();

                // è¿”å›åŠ¨æ€é¡µé¢
                    hidePublishMoment();

                // ğŸ”¥ã€ä¿®å¤ã€‘ç»Ÿä¸€ä½¿ç”¨loadMomentsæ¥é¿å…é‡å¤æ˜¾ç¤º
                setTimeout(() => {
                    loadMoments();
                }, 100);

                // å¯åŠ¨æ—¶é—´æ›´æ–°å™¨
                startTimeUpdater();

                // å»¶è¿Ÿè§¦å‘AIè§’è‰²çš„äº’åŠ¨
                setTimeout(() => {
                    triggerAIInteractions(newMoment.id, 'like');
                }, 1000);
                setTimeout(() => {
                    triggerAIInteractions(newMoment.id, 'comment');
                }, 3000);

            } catch (error) {
                console.error('å‘å¸ƒåŠ¨æ€å¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');

                // æ¢å¤å‘å¸ƒæŒ‰é’®
                publishBtn.disabled = false;
                publishBtn.textContent = 'å‘è¡¨';
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            // ç¡®ä¿dateæ˜¯Dateå¯¹è±¡
            if (!date) return 'æœªçŸ¥æ—¶é—´';
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¶é—´';

            const now = new Date();
            const diff = now - date;

            if (diff < 60000) { // å°äº1åˆ†é’Ÿ
                return 'åˆšåˆš';
            } else if (diff < 3600000) { // å°äº1å°æ—¶
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) { // å°äº1å¤©
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else if (diff < 604800000) { // å°äº1å‘¨
                return Math.floor(diff / 86400000) + 'å¤©å‰';
            } else {
                return date.toLocaleDateString();
            }
        }

        // ğŸ”¥ã€åˆ é™¤ã€‘ä¸å†éœ€è¦addMomentToListå‡½æ•°ï¼Œç»Ÿä¸€ä½¿ç”¨loadMoments

        // åˆ›å»ºåŠ¨æ€å…ƒç´ 
        function createMomentElement(moment) {
            const momentDiv = document.createElement('div');
            momentDiv.className = 'moment-item';

            // è®¾ç½®åŠ¨æ€IDå’Œæ—¶é—´æˆ³
            momentDiv.setAttribute('data-moment-id', moment.id);
            if (moment.timestamp) {
                momentDiv.setAttribute('data-timestamp', moment.timestamp);
            }

            let imagesHtml = '';
            if (moment.images && moment.images.length > 0) {
                imagesHtml = `
                    <div class="moment-images">
                        ${moment.images.map(img => `<img src="${img}" alt="åŠ¨æ€å›¾ç‰‡" onclick="previewImage('${img}')">`).join('')}
                    </div>
                `;
            }
            // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è·å–è§’è‰²å¤´åƒ
            let finalAvatar = null;
            if (moment.authorId === 'user') {
                // ç”¨æˆ·åŠ¨æ€ï¼šç›´æ¥ä½¿ç”¨ä¿å­˜çš„å¤´åƒï¼ˆå·²åœ¨å‘å¸ƒæ—¶æ­£ç¡®è®¾ç½®ï¼‰
                finalAvatar = moment.avatar;
            } else {
                // è§’è‰²åŠ¨æ€ï¼šä¼˜å…ˆåŠ¨æ€å¤´åƒï¼Œç„¶åè§’è‰²å¡å¤´åƒ
                finalAvatar = moment.avatar;
                if (!finalAvatar && moment.characterId) {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character && character.avatarUrl) {
                        finalAvatar = character.avatarUrl;
                    }
                }
            }

            momentDiv.innerHTML = `
                <div class="moment-avatar">
                    ${finalAvatar ?
                        `<img src="${finalAvatar}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;\\'>${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>'">` :
                        `<div style="width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;">${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>`
                    }
                </div>
                <div class="moment-content">
                    <div class="moment-username">
                        ${moment.nickname}
                    </div>
                    <div class="moment-text">${formatMomentText(moment.text)}</div>
                    ${imagesHtml}
                    ${moment.mentions && moment.mentions.length > 0 ? createMomentMentionsDisplay(moment.mentions) : ''}
                    <div class="moment-time-actions" style="margin-top: 0; padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div class="moment-time-location" style="display: flex; align-items: center; gap: 4px;">
                            <div class="moment-time">${moment.time}</div>
                            ${moment.location ? `<div class="moment-location"><i class="fas fa-map-marker-alt"></i> ${moment.location}</div>` : ''}
                            ${moment.authorId === 'user' ? createVisibilityIndicator(moment.visibility, moment.visibleGroups) : ''}
                        </div>
                        <div class="moment-actions">
                            <!-- ä¸‰ç‚¹æŒ‰é’® -->
                            <button class="moment-more-btn" onclick="toggleMomentActions('${moment.id}')">
                                <div class="moment-more-dots">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </button>

                            <!-- å¼¹å‡ºçš„æ“ä½œèœå• -->
                            <div class="moment-actions-popup" id="moment-actions-${moment.id}">
                                <button class="moment-action-btn popup-like-btn" onclick="toggleMomentLike('${moment.id}')">
                                    <i class="far fa-heart"></i>
                                    <span>èµ</span>
                                </button>
                                <div class="popup-divider"></div>
                                <button class="moment-action-btn popup-comment-btn" onclick="showMomentComments('${moment.id}')">
                                    <i class="far fa-comment"></i>
                                    <span>è¯„è®º</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="moment-footer" style="display: none;">
                    </div>
                </div>
            `;

            // æ·»åŠ é•¿æŒ‰ç›‘å¬å™¨
            addLongPressListener(momentDiv, moment.id);

            // å¼‚æ­¥æ£€æŸ¥å¹¶è®¾ç½®ç”¨æˆ·ç‚¹èµçŠ¶æ€
            (async () => {
                try {
                    const userLike = await db.momentLikes
                        .where('[momentId+authorId]')
                        .equals([moment.id, 'user'])
                        .first();

                    if (userLike) {
                    const likeBtn = momentDiv.querySelector('.moment-action-btn');
                    const likeIcon = likeBtn.querySelector('i');
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                    likeBtn.classList.add('liked');
                }
                } catch (error) {
                    console.error('æ£€æŸ¥ç”¨æˆ·ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
            }
            })();

            return momentDiv;
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage(imageSrc) {
            // åˆ›å»ºé¢„è§ˆé®ç½©
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;

            overlay.appendChild(img);
            overlay.onclick = () => document.body.removeChild(overlay);
            document.body.appendChild(overlay);
        }

        // æ³¨æ„ï¼šsaveMomentsDataå‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨Dexieæ•°æ®åº“ç›´æ¥å­˜å‚¨
        // æ›´æ–°æ–‡å­—è®¡æ•°
        function updateTextCount() {
            const textarea = document.getElementById('moment-text');
            const countElement = document.getElementById('text-count');

            if (textarea && countElement) {
                const currentLength = textarea.value.length;
                const maxLength = 500;

                countElement.textContent = `${currentLength}/${maxLength}`;

                // å½“æ¥è¿‘é™åˆ¶æ—¶æ”¹å˜é¢œè‰²
                if (currentLength > maxLength * 0.9) {
                    countElement.style.color = '#ff6b6b';
                } else if (currentLength > maxLength * 0.8) {
                    countElement.style.color = '#ffa500';
                } else {
                    countElement.style.color = '#999';
                }
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }

        // æ—¶é—´æ›´æ–°å™¨
        let timeUpdateInterval = null;

        function startTimeUpdater() {
            // æ¸…é™¤å·²å­˜åœ¨çš„å®šæ—¶å™¨
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }

            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateMomentTimes();

            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
            timeUpdateInterval = setInterval(updateMomentTimes, 60000);
        }

        function stopTimeUpdater() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }

        function updateMomentTimes() {
            try {
                // æ›´æ–°åŠ¨æ€æœ¬èº«çš„æ—¶é—´
                const momentItems = document.querySelectorAll('.moment-item[data-timestamp]');

                momentItems.forEach(item => {
                    const timestamp = parseInt(item.getAttribute('data-timestamp'));
                    if (timestamp) {
                        const timeElement = item.querySelector('.moment-time');
                        if (timeElement) {
                            const newTime = formatTime(new Date(timestamp));
                            timeElement.textContent = newTime;
                        }
                    }
                });

                // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è¯„è®ºåŒºçš„æ—¶é—´æ˜¾ç¤º
                const commentElements = document.querySelectorAll('.moment-comment[data-timestamp]');
                commentElements.forEach(commentElement => {
                    const timestamp = parseInt(commentElement.getAttribute('data-timestamp'));
                    if (timestamp) {
                        const timeElement = commentElement.querySelector('.comment-time');
                        if (timeElement) {
                            const newTime = formatTime(new Date(timestamp));
                            timeElement.textContent = newTime;
                        }
                    }
                });
            } catch (error) {
                console.error('æ›´æ–°åŠ¨æ€æ—¶é—´å¤±è´¥:', error);
            }
        }

        // åŠ¨æ€é€‰æ‹©æ¨¡å¼ç›¸å…³å˜é‡
        let isSelectionMode = false;
        let selectedMoments = new Set();

        // åˆ‡æ¢åŠ¨æ€ç‚¹èµçŠ¶æ€
        async function toggleMomentLike(momentId) {
            if (isSelectionMode) return; // é€‰æ‹©æ¨¡å¼ä¸‹ä¸å“åº”ç‚¹èµ

            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

            const likeBtn = momentElement.querySelector('.moment-action-btn');
            const likeIcon = likeBtn.querySelector('i');

            try {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), 'user'])
                    .first();

                if (existingLike) {
                // å–æ¶ˆç‚¹èµ
                likeIcon.classList.remove('fas');
                likeIcon.classList.add('far');
                likeBtn.classList.remove('liked');
                    await db.momentLikes.delete([parseInt(momentId), 'user']);
            } else {
                // ç‚¹èµ
                likeIcon.classList.add('fas');
                likeIcon.classList.remove('far');
                likeBtn.classList.add('liked');
                    await db.momentLikes.add({
                        momentId: parseInt(momentId),
                        authorId: 'user',
                    characterId: 'user',
                    name: document.getElementById('moments-username')?.textContent || 'æˆ‘',
                    timestamp: Date.now()
                });

                // è§¦å‘AIè§’è‰²è‡ªåŠ¨ç‚¹èµ
                triggerAIInteractions(momentId, 'like');
            }

            // æ›´æ–°æ˜¾ç¤º
            updateMomentLikeDisplay(momentId);
            } catch (error) {
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåŠ¨æ€è¯„è®º
        function showMomentComments(momentId) {
            if (isSelectionMode) return; // é€‰æ‹©æ¨¡å¼ä¸‹ä¸å“åº”è¯„è®º

            // ğŸ”¥ã€æ–°ç‰ˆã€‘æ˜¾ç¤ºåº•éƒ¨å›ºå®šè¯„è®ºè¾“å…¥æ¡†
            showBottomCommentInput(momentId);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤ç”¨æˆ·ç‚¹å‡»è¯„è®ºæ—¶è‡ªåŠ¨è§¦å‘AIè¯„è®ºçš„é€»è¾‘
            // ç”¨æˆ·ç‚¹å‡»è¯„è®ºæŒ‰é’®åªæ˜¯æƒ³è¯„è®ºï¼Œä¸åº”è¯¥è§¦å‘å…¶ä»–AIè§’è‰²ä¹Ÿæ¥è¯„è®º
            // AIè§’è‰²çš„è‡ªåŠ¨è¯„è®ºåº”è¯¥åªåœ¨åŠ¨æ€å‘å¸ƒæ—¶è§¦å‘ï¼Œè€Œä¸æ˜¯åœ¨ç”¨æˆ·è¯„è®ºæ—¶è§¦å‘
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåº•éƒ¨å›ºå®šè¯„è®ºè¾“å…¥æ¡†
        function showBottomCommentInput(momentId, replyToNickname = null) {
            // å…³é—­å·²å­˜åœ¨çš„åº•éƒ¨è¾“å…¥æ¡†
            closeBottomCommentInput();

            const placeholder = replyToNickname ? `å›å¤ ${replyToNickname}...` : 'å†™è¯„è®º...';

            // åˆ›å»ºåº•éƒ¨å›ºå®šè¾“å…¥æ¡†
            const bottomInput = document.createElement('div');
            bottomInput.id = 'bottom-comment-input';
            bottomInput.className = 'bottom-comment-input';

            bottomInput.innerHTML = `
                <div class="bottom-comment-container">
                    <input type="text"
                           placeholder="${placeholder}"
                           maxlength="200"
                           id="bottom-comment-text"
                           data-moment-id="${momentId}"
                           data-reply-to="${replyToNickname || ''}">
                    <button class="bottom-comment-send" onclick="submitBottomComment()">å‘é€</button>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(bottomInput);

            // è·å–è¾“å…¥æ¡†å…ƒç´ 
            const textInput = bottomInput.querySelector('#bottom-comment-text');

            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                textInput.focus();
                // è°ƒæ•´é¡µé¢æ»šåŠ¨ï¼Œé¿å…è¢«è¾“å…¥æ¡†é®æŒ¡
                window.scrollBy(0, 60);
            }, 100);

            // å›è½¦å‘é€
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitBottomComment();
                }
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            setTimeout(() => {
                document.addEventListener('click', handleBottomCommentClickOutside);
            }, 100);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…³é—­åº•éƒ¨è¯„è®ºè¾“å…¥æ¡†
        function closeBottomCommentInput() {
            const bottomInput = document.getElementById('bottom-comment-input');
            if (bottomInput) {
                bottomInput.remove();
                document.removeEventListener('click', handleBottomCommentClickOutside);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†åº•éƒ¨è¯„è®ºæ¡†å¤–éƒ¨ç‚¹å‡»
        function handleBottomCommentClickOutside(e) {
            const bottomInput = document.getElementById('bottom-comment-input');
            if (bottomInput && !bottomInput.contains(e.target)) {
                closeBottomCommentInput();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æäº¤åº•éƒ¨è¯„è®º
        async function submitBottomComment() {
            const textInput = document.getElementById('bottom-comment-text');
            if (!textInput) return;

            const text = textInput.value.trim();
            const momentId = textInput.getAttribute('data-moment-id');
            const replyTo = textInput.getAttribute('data-reply-to');

            if (!text) {
                showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            // åˆ›å»ºè¯„è®ºå¯¹è±¡
            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–ç”¨æˆ·åœ¨åŠ¨æ€é¡µè®¾ç½®çš„æ˜µç§°
            const nickname = document.getElementById('moments-username')?.textContent || 'æˆ‘';

            const comment = {
                id: Date.now(),
                nickname: nickname, // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨åŠ¨æ€é¡µè®¾ç½®çš„æ˜µç§°
                avatar: await getDefaultAvatar(), // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨getDefaultAvatarå‡½æ•°
                text: text,
                time: formatTime(new Date()),
                timestamp: Date.now(),
                authorId: 'user',
                replyTo: replyTo || null
            };

            // ä¿å­˜è¯„è®ºåˆ°åŠ¨æ€æ•°æ®
            saveCommentToMoment(momentId, comment);

            // æ›´æ–°åŠ¨æ€åˆ—è¡¨ä¸­çš„è¯„è®ºæ•°
            updateMomentCommentCount(momentId);

            // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°è¯„è®º
            displayCommentUnderMoment(momentId, comment);

            // å…³é—­è¾“å…¥æ¡†
            closeBottomCommentInput();

            showToast('è¯„è®ºæˆåŠŸï¼');

            // ğŸ”¥ã€ä¿®æ”¹ã€‘å¤„ç†AIå›å¤é€»è¾‘ï¼Œæ”¹ä¸º3å›åˆé™åˆ¶
            if (replyTo && replyTo !== 'æˆ‘') {
                const conversationKey = `${momentId}-${replyTo}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;

                if (currentRounds < 3) {
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`ç”¨æˆ·å›å¤åï¼Œ${replyTo} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„å¯¹è¯å›åˆæ¬¡æ›´æ–°ä¸º: ${currentRounds + 1}/3`);

                    setTimeout(() => {
                        console.log(`å¼€å§‹è§¦å‘ ${replyTo} å›å¤ç”¨æˆ·è¯„è®º: "${text}"`);
                        triggerAIReplyToUser(momentId, replyTo, text);
                    }, Math.random() * 3000 + 2000);
                } else {
                    console.log(`${replyTo} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„å¯¹è¯å·²è¾¾åˆ°3å›åˆä¸Šé™ï¼Œä¸å†å›å¤`);
                }
            } else {
                console.log(`ç”¨æˆ·å‘è¡¨äº†è¯„è®ºï¼ŒreplyTo: ${replyTo}`);

                if (!replyTo) {
                    checkAndTriggerCharacterMomentReply(momentId, text);
                }
            }
        }





        // æ£€æŸ¥å¹¶è§¦å‘è§’è‰²åŠ¨æ€çš„å›å¤
        async function checkAndTriggerCharacterMomentReply(momentId, userCommentText) {
            try {
                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment || !moment.characterId || moment.characterId === 'user') {
                    console.log('ä¸æ˜¯è§’è‰²å‘å¸ƒçš„åŠ¨æ€ï¼Œè·³è¿‡è§’è‰²å›å¤');
                    return;
                }

                // è·å–å‘å¸ƒåŠ¨æ€çš„è§’è‰²
                const character = characters.find(c => c.id === moment.characterId);
                if (!character) {
                    console.log(`æœªæ‰¾åˆ°åŠ¨æ€å‘å¸ƒè€…è§’è‰²: ${moment.characterId}`);
                    return;
                }

                // ğŸ”¥ã€ä¿®æ”¹ã€‘æ£€æŸ¥å¯¹è¯å›åˆæ¬¡ï¼Œæ”¹ä¸º3å›åˆé™åˆ¶
                const conversationKey = `${momentId}-${character.name}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;

                if (currentRounds >= 3) {
                    console.log(`${character.name} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„å¯¹è¯å·²è¾¾åˆ°3å›åˆä¸Šé™ï¼Œä¸å†å›å¤`);
                    return;
                }

                console.log(`ç”¨æˆ·è¯„è®ºäº† ${character.name} çš„åŠ¨æ€ï¼Œå½“å‰å¯¹è¯å›åˆæ¬¡: ${currentRounds}/3ï¼Œå°†åœ¨2-5ç§’åè§¦å‘å›å¤`);

                // å¢åŠ å¯¹è¯å›åˆæ¬¡
                commentConversationRounds.set(conversationKey, currentRounds + 1);
                console.log(`ç”¨æˆ·è¯„è®ºåï¼Œ${character.name} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„å¯¹è¯å›åˆæ¬¡æ›´æ–°ä¸º: ${currentRounds + 1}/3`);

                // å»¶è¿Ÿå›å¤
                setTimeout(() => {
                    console.log(`å¼€å§‹è§¦å‘ ${character.name} å›å¤ç”¨æˆ·å¯¹å…¶åŠ¨æ€çš„è¯„è®º: "${userCommentText}"`);
                    triggerAIReplyToUser(momentId, character.name, userCommentText);
                }, Math.random() * 3000 + 2000); // 2-5ç§’åAIå›å¤

            } catch (error) {
                console.error('æ£€æŸ¥è§’è‰²åŠ¨æ€å›å¤å¤±è´¥:', error);
            }
        }

        // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºè¯„è®º
        function displayCommentUnderMoment(momentId, comment) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯„è®ºåŒºåŸŸ
            let commentsSection = momentElement.querySelector('.moment-comments-section');
            if (!commentsSection) {
                commentsSection = document.createElement('div');
                commentsSection.className = 'moment-comments-section';

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç‚¹èµåŒºåŸŸï¼Œå†³å®šmargin-top
                const likesDisplay = momentElement.querySelector('.likes-display');
                const marginTop = likesDisplay ? '0' : '0';

                commentsSection.style.cssText = `
                    margin-top: ${marginTop};
                    padding: 8px 12px;
                    background: #f8f9fa;
                    font-size: 13px;
                `;

                // æ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼šç‚¹èµåŒºåé¢ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå¦åˆ™åœ¨æ—¶é—´æ“ä½œåŒºåé¢
                const momentContent = momentElement.querySelector('.moment-content');
                const momentTimeActions = momentElement.querySelector('.moment-time-actions');

                if (momentContent && momentTimeActions) {
                if (likesDisplay) {
                        // å¦‚æœæœ‰ç‚¹èµåŒºï¼Œæ’å…¥åˆ°ç‚¹èµåŒºåé¢
                    likesDisplay.parentNode.insertBefore(commentsSection, likesDisplay.nextSibling);
                    } else {
                        // æ²¡æœ‰ç‚¹èµåŒºï¼Œæ’å…¥åˆ°æ—¶é—´æ“ä½œåŒºåé¢
                    momentTimeActions.parentNode.insertBefore(commentsSection, momentTimeActions.nextSibling);
                    }
                }
            }

            // åˆ›å»ºè¯„è®ºå…ƒç´ 
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item moment-comment';
            commentDiv.setAttribute('data-timestamp', comment.timestamp || Date.now());
            commentDiv.style.cssText = `
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                align-items: flex-start;
            `;

            // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å›å¤æ ¼å¼ï¼Œç¡®ä¿è§’è‰²å›å¤ç”¨æˆ·æ—¶æ ¼å¼æ­£å¸¸
            let commentText = comment.text;
            let nameFormat = comment.nickname + 'ï¼š'; // é»˜è®¤æ ¼å¼

            if (comment.replyTo) {
                // æœ‰å›å¤æ—¶ï¼Œè§’è‰²ååä¸åŠ å†’å·ï¼Œå›å¤å†…å®¹åŒ…å«å®Œæ•´æ ¼å¼
                nameFormat = comment.nickname;
                commentText = `å›å¤<span style="margin: 0 2px; color: #576b95; font-weight: 600;">${comment.replyTo}</span>: ${comment.text}`;
            }

            commentDiv.innerHTML = `
                <img src="${comment.avatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                <div style="flex: 1; line-height: 1.4; cursor: pointer;" onclick="replyToMomentComment('${momentId}', '${comment.nickname}')">
                    <span style="color: #576b95; font-weight: 600;">${nameFormat}</span><span style="margin-left: 2px; color: #333;">${commentText}</span>
                    <div class="comment-time" style="color: #999; font-size: 11px; margin-top: 2px;">${comment.time}</div>
                </div>
            `;

            commentsSection.appendChild(commentDiv);
        }

        // å›å¤åŠ¨æ€è¯„è®º
        function replyToMomentComment(momentId, nickname) {
            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä½¿ç”¨åº•éƒ¨å›ºå®šè¾“å…¥æ¡†ï¼Œå¹¶è®¾ç½®ä¸ºå›å¤æ¨¡å¼
            showBottomCommentInput(momentId, nickname);
        }



        // ä¿å­˜è¯„è®ºåˆ°åŠ¨æ€æ•°æ®
        async function saveCommentToMoment(momentId, comment) {
            try {
                const commentData = {
                    id: comment.id,
                    momentId: parseInt(momentId),
                    authorId: comment.characterId || 'user',
                    nickname: comment.nickname,
                    avatar: comment.avatar,
                    text: comment.text,
                    timestamp: comment.timestamp,
                    replyTo: comment.replyTo || null
                };

                await db.momentComments.add(commentData);
                console.log('è¯„è®ºå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼ŒåŠ¨æ€ID:', momentId);
            } catch (error) {
                console.error('ä¿å­˜è¯„è®ºå¤±è´¥:', error);
            }
        }

        // æ›´æ–°åŠ¨æ€è¯„è®ºæ•°
        async function updateMomentCommentCount(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

                const commentsCount = await db.momentComments.where('momentId').equals(parseInt(momentId)).count();

                const commentBtn = momentElement.querySelectorAll('.moment-action-btn')[1];
                const commentCount = commentBtn.querySelector('span');
                commentCount.textContent = commentsCount;
            } catch (error) {
                console.error('æ›´æ–°è¯„è®ºæ•°å¤±è´¥:', error);
            }
        }

        // è§¦å‘AIè§’è‰²äº’åŠ¨
        async function triggerAIInteractions(momentId, type) {
            try {
            if (!characters || characters.length === 0) return;

            // è·å–å½“å‰åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
            if (!moment) return;

                const publisherCharacterId = moment.characterId;

                // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
                if (!publisherCharacterId || publisherCharacterId === 'user') {


                    // ğŸ”¥ã€æ–°å¢ã€‘é¦–å…ˆè¿‡æ»¤å‡ºèƒ½çœ‹åˆ°è¿™æ¡åŠ¨æ€çš„è§’è‰²
                    const contactCharacters = characters.filter(char => contacts.includes(char.id));
                    const visibleCharacters = [];

                    for (const character of contactCharacters) {
                        const canSee = await checkMomentVisibilityForCharacter(parseInt(momentId), character.id);
                        if (canSee) {
                            visibleCharacters.push(character);
                        }
                    }



            if (type === 'like') {
                for (const character of visibleCharacters) {
                    if (Math.random() < 0.8) { // 80%æ¦‚ç‡ç‚¹èµ
                                setTimeout(async () => {
                                    await addAILikeWithPersonality(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                    }
                }
            } else if (type === 'comment') {
                for (const character of visibleCharacters) {
                    if (Math.random() < 0.8) { // 80%æ¦‚ç‡è¯„è®º
                            setTimeout(async () => {
                                await addAICommentWithPersonality(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                    }
                }
                    }
                } else {
                    console.log('è§’è‰²å‘å¸ƒåŠ¨æ€ï¼ŒåŒä¸€åˆ†ç»„ä¸‹è§’è‰²65%æ¦‚ç‡äº’åŠ¨');
                    // è§’è‰²å‘åŠ¨æ€ï¼šä½¿ç”¨åˆ†ç»„å…³ç³»è€Œä¸æ˜¯ç¾¤èŠå…³ç³»
                    const publisherCharacter = characters.find(c => c.id === publisherCharacterId);

                    // ğŸ”¥ã€æ–°å¢ã€‘è·å–ä¸å‘å¸ƒè€…åœ¨åŒä¸€åˆ†ç»„ä¸”èƒ½çœ‹åˆ°åŠ¨æ€çš„è§’è‰²
                    const sameGroupCharacters = characters.filter(c =>
                        c.id !== publisherCharacterId && c.groupId === publisherCharacter.groupId
                    );

                    // è¿›ä¸€æ­¥è¿‡æ»¤å‡ºèƒ½çœ‹åˆ°è¿™æ¡åŠ¨æ€çš„è§’è‰²
                    const visibleSameGroupCharacters = [];
                    for (const character of sameGroupCharacters) {
                        const canSee = await checkMomentVisibilityForCharacter(parseInt(momentId), character.id);
                        if (canSee) {
                            visibleSameGroupCharacters.push(character);
                        }
                    }

                    console.log(`åŒåˆ†ç»„å¯è§è§’è‰²æ•°é‡: ${visibleSameGroupCharacters.length}/${sameGroupCharacters.length}`);

                    if (type === 'like') {
                        for (const character of visibleSameGroupCharacters) {
                            if (Math.random() < 0.65) { // ğŸ”¥ã€æå‡ã€‘65%æ¦‚ç‡äº’åŠ¨
                    setTimeout(async () => {
                                    await addAILikeWithPersonality(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                            }
                        }
                    } else if (type === 'comment') {
                        console.log('å¼€å§‹å¤„ç†è§’è‰²è¯„è®ºï¼Œå¯è§è§’è‰²æ•°é‡:', visibleSameGroupCharacters.length);
                        for (const character of visibleSameGroupCharacters) {
                            const randomValue = Math.random();
                            const willComment = randomValue < 0.65; // ğŸ”¥ã€æå‡ã€‘65%æ¦‚ç‡è¯„è®ºå…¶ä»–åŒç»„è§’è‰²
                            console.log(`${character.name} è¯„è®ºæ¦‚ç‡æ£€æŸ¥: ${randomValue.toFixed(3)} < 0.65 = ${willComment}`);

                            if (willComment) {
                                setTimeout(async () => {
                                    console.log(`${character.name} å¼€å§‹ç”Ÿæˆè¯„è®º...`);
                                    await addAICommentWithPersonality(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                            } else {
                                console.log(`${character.name} å› ä¸ºæ¦‚ç‡æœªé€šè¿‡ï¼Œä¸ä¼šè¯„è®º`);
                            }
                        }

                        // ğŸ”¥ã€ç§»é™¤ã€‘é‡å¤çš„å‘å¸ƒè€…å›å¤è§¦å‘ - ç°åœ¨åªåœ¨å…¶ä»–è§’è‰²è¯„è®ºåè§¦å‘

                        // è§¦å‘åŒåˆ†ç»„è§’è‰²é—´çš„äº’åŠ¨
                        setTimeout(() => {
                            // å°†å‘å¸ƒè€…è§’è‰²ä¹ŸåŠ å…¥åˆ°äº’åŠ¨è§’è‰²åˆ—è¡¨ä¸­
                            const allInteractionCharacters = [...visibleSameGroupCharacters];
                            if (publisherCharacter) {
                                allInteractionCharacters.push(publisherCharacter);
                            }
                            triggerAiToAiInteractionWithPersonality(momentId, allInteractionCharacters);
                        }, Math.random() * 8000 + 5000);
                    }
                }
            } catch (error) {
                console.error('è§¦å‘AIäº’åŠ¨å¤±è´¥:', error);
            }
        }

        // è·å–ä¸æŒ‡å®šè§’è‰²åœ¨åŒä¸€ä¸ªç¾¤èŠçš„å…¶ä»–è§’è‰²
        function getCharactersInSameGroups(characterId) {
            const sameGroupCharacters = [];

            // éå†æ‰€æœ‰ç¾¤èŠ
            groupChats.forEach(group => {
                if (group.members && group.members.includes(characterId)) {
                    // æ‰¾åˆ°åŒ…å«è¯¥è§’è‰²çš„ç¾¤èŠï¼Œè·å–ç¾¤å†…å…¶ä»–è§’è‰²
                    group.members.forEach(memberId => {
                        if (memberId !== characterId && memberId !== 'user') {
                            const character = characters.find(c => c.id === memberId);
                            if (character && !sameGroupCharacters.find(c => c.id === character.id)) {
                                sameGroupCharacters.push(character);
                            }
                        }
                    });
                }
            });

            return sameGroupCharacters;
        }

        // AIè§’è‰²ç‚¹èµï¼ˆåŸºäºäººè®¾å’Œè®°å¿†ç³»ç»Ÿï¼‰
        async function addAILikeWithPersonality(momentId, character, moment) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»ç‚¹èµè¿‡
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), character.id])
                    .first();

                if (existingLike) return;

                // åŸºäºè§’è‰²äººè®¾ã€è®°å¿†ç³»ç»Ÿå’Œå…³ç³»å†³å®šæ˜¯å¦ç‚¹èµ
                const shouldLike = await shouldCharacterLikeMomentWithMemory(character, moment);
                if (!shouldLike) {
                    console.log(`${character.name} åŸºäºäººè®¾å’Œè®°å¿†é€‰æ‹©ä¸ç‚¹èµè¿™æ¡åŠ¨æ€`);
                    return;
                }

            // æ·»åŠ ç‚¹èµè®°å½•
                await db.momentLikes.add({
                    momentId: parseInt(momentId),
                    authorId: character.id,
                characterId: character.id,
                name: character.name,
                timestamp: Date.now()
            });

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateMomentLikeDisplay(momentId);

            // ğŸ”¥ã€ä¿®å¤ã€‘åªæœ‰ç”¨æˆ·çš„åŠ¨æ€è¢«ç‚¹èµæ—¶æ‰æ˜¾ç¤ºtoastå’Œæ¨é€é€šçŸ¥
            if (moment.authorId === 'user') {
                // æ˜¾ç¤ºç‚¹èµæç¤º
                showToast(`${character.name} èµäº†ä½ çš„åŠ¨æ€`);
                // åˆ›å»ºæ¨é€é€šçŸ¥
                createPushNotification(character, `èµäº†ä½ çš„åŠ¨æ€`, 100);
            }

            // è®°å½•åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
            await recordMemoryEvent(
                [character.id],
                {
                    type: 'moments',
                    id: 'moments'
                },
                'moment_like',
                `ç‚¹èµäº†${moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname}çš„åŠ¨æ€`
            );
            } catch (error) {
                console.error('AIç‚¹èµå¤±è´¥:', error);
            }
        }

        // ä¿ç•™åŸæœ‰çš„ç‚¹èµå‡½æ•°ä½œä¸ºå…¼å®¹
        async function addAILike(momentId, character, moment) {
            return await addAILikeWithPersonality(momentId, character, moment);
        }

        // åŸºäºäººè®¾å’Œè®°å¿†ç³»ç»Ÿåˆ¤æ–­è§’è‰²æ˜¯å¦ä¼šç‚¹èµè¿™æ¡åŠ¨æ€
        async function shouldCharacterLikeMomentWithMemory(character, moment) {
            try {
                // è·å–è§’è‰²çš„èŠå¤©è®¾ç½®å’Œè®°å¿†
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                const persona = chatSettings?.aiPersona || character.prompt || character.bio || `ä½ æ˜¯${character.name}ã€‚`;

                // è·å–è§’è‰²ä¸åŠ¨æ€å‘å¸ƒè€…çš„å…³ç³»è®°å¿†
                let relationshipMemory = '';
                if (moment.characterId && moment.characterId !== 'user') {
                    // è·å–ä¸å…¶ä»–è§’è‰²çš„å…³ç³»è®°å¿†
                    const coreMemories = await db.coreMemories
                        .where('characterId')
                        .equals(character.id)
                        .toArray();

                    const relationMemories = coreMemories.filter(memory =>
                        memory.fact && memory.fact.includes(moment.nickname)
                    );

                    if (relationMemories.length > 0) {
                        relationshipMemory = relationMemories.map(m => m.fact).join('ï¼›');
                    }
                }

                // åŸºäºè§’è‰²äººè®¾å’ŒåŠ¨æ€å†…å®¹çš„åˆ¤æ–­
                const characterBio = persona.toLowerCase();
                const momentText = (moment.text || '').toLowerCase();
                const momentAuthor = moment.nickname || 'ç”¨æˆ·';

                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è´Ÿé¢å…³ç³»è®°å¿†
                if (relationshipMemory) {
                    const negativeKeywords = ['åµæ¶', 'äº‰æ‰§', 'è®¨åŒ', 'ä¸å–œæ¬¢', 'æ•Œå¯¹', 'ç«äº‰', 'æƒ…æ•Œ', 'å†²çª'];
                    const hasNegativeRelation = negativeKeywords.some(keyword =>
                        relationshipMemory.toLowerCase().includes(keyword)
                    );

                    if (hasNegativeRelation) {
                        console.log(`${character.name} ä¸ ${momentAuthor} å­˜åœ¨è´Ÿé¢å…³ç³»è®°å¿†ï¼Œä¸ä¼šç‚¹èµ`);
                        return false;
                    }
                }

                // å¦‚æœè§’è‰²äººè®¾ä¸­åŒ…å«è´Ÿé¢è¯æ±‡ï¼Œé™ä½ç‚¹èµæ¦‚ç‡
                const negativeTraits = ['å†·æ¼ ', 'ä¸¥è‚ƒ', 'ä¸å–„äº¤é™…', 'å†…å‘', 'æ²‰é»˜'];
                const hasNegativeTraits = negativeTraits.some(trait => characterBio.includes(trait));

                if (hasNegativeTraits && Math.random() < 0.7) {
                    return false; // 70%æ¦‚ç‡ä¸ç‚¹èµ
                }

                // å¦‚æœåŠ¨æ€å†…å®¹ä¸è§’è‰²å…´è¶£ç›¸å…³ï¼Œå¢åŠ ç‚¹èµæ¦‚ç‡
                const characterInterests = extractInterestsFromBio(characterBio);
                const hasRelatedContent = characterInterests.some(interest =>
                    momentText.includes(interest)
                );

                if (hasRelatedContent) {
                    return Math.random() < 0.9; // 90%æ¦‚ç‡ç‚¹èµ
                }

                // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€ï¼Œå¢åŠ ç‚¹èµæ¦‚ç‡
                if (!moment.characterId || moment.characterId === 'user') {
                    return Math.random() < 0.8; // 80%æ¦‚ç‡ç‚¹èµ
                }

                // é»˜è®¤æƒ…å†µ
                return Math.random() < 0.7; // 70%æ¦‚ç‡ç‚¹èµ
            } catch (error) {
                console.error('åˆ¤æ–­è§’è‰²ç‚¹èµåå¥½å¤±è´¥:', error);
                return Math.random() < 0.6; // é»˜è®¤60%æ¦‚ç‡
            }
        }

        // ä¿ç•™åŸæœ‰å‡½æ•°ä½œä¸ºå…¼å®¹
        async function shouldCharacterLikeMoment(character, moment) {
            return await shouldCharacterLikeMomentWithMemory(character, moment);
        }

        // ä»è§’è‰²äººè®¾ä¸­æå–å…´è¶£å…³é”®è¯
        function extractInterestsFromBio(bio) {
            const interests = [];
            const interestKeywords = [
                'éŸ³ä¹', 'ç”µå½±', 'è¯»ä¹¦', 'è¿åŠ¨', 'æ¸¸æˆ', 'ç¾é£Ÿ', 'æ—…è¡Œ', 'æ‘„å½±',
                'ç»˜ç”»', 'å†™ä½œ', 'ä»£ç ', 'ç§‘æŠ€', 'åŠ¨æ¼«', 'å°è¯´', 'å’–å•¡', 'èŒ¶',
                'å® ç‰©', 'èŠ±', 'æ˜Ÿç©º', 'é›¨å¤©', 'é˜³å…‰', 'å­¦ä¹ ', 'å·¥ä½œ', 'æœ‹å‹'
            ];

            interestKeywords.forEach(keyword => {
                if (bio.includes(keyword)) {
                    interests.push(keyword);
                }
            });

            return interests;
        }

        // æ›´æ–°åŠ¨æ€ç‚¹èµæ˜¾ç¤º
        async function updateMomentLikeDisplay(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

                const momentLikes = await db.momentLikes.where('momentId').equals(parseInt(momentId)).toArray();

            // æ›´æ–°ç‚¹èµæŒ‰é’®æ•°å­—
            const likeBtn = momentElement.querySelector('.moment-action-btn[onclick*="toggleMomentLike"]');
            if (likeBtn) {
                const likeCount = likeBtn.querySelector('span');
                if (likeCount) {
                    likeCount.textContent = momentLikes.length;
                }
            }

            // æ›´æ–°æˆ–åˆ›å»ºç‚¹èµç”¨æˆ·åç§°æ˜¾ç¤º
            let likesDisplay = momentElement.querySelector('.likes-display');

            if (momentLikes.length > 0) {
                if (!likesDisplay) {
                    likesDisplay = document.createElement('div');
                    likesDisplay.className = 'likes-display';

                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯„è®ºåŒºåŸŸï¼Œå¦‚æœæœ‰å°±ä¸è®¾ç½®margin-top
                        const existingCommentsSection = momentElement.querySelector('.moment-comments-section');
                        const marginTop = existingCommentsSection ? '0' : '0';

                    likesDisplay.style.cssText = `
                        margin-top: ${marginTop};
                        padding: 8px 12px;
                        background: #f8f9fa;
                        font-size: 13px;
                        color: #666;
                        line-height: 1.4;
                    `;

                        // æ’å…¥åˆ°æ“ä½œæŒ‰é’®ä¸‹é¢ï¼Œè¯„è®ºåŒºå‰é¢ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå¦åˆ™åœ¨æ—¶é—´æ“ä½œåŒºåé¢
                    const momentContent = momentElement.querySelector('.moment-content');
                    const momentTimeActions = momentElement.querySelector('.moment-time-actions');
                        const commentsSection = momentElement.querySelector('.moment-comments-section');

                    if (momentContent && momentTimeActions) {
                            if (commentsSection) {
                                // å¦‚æœå·²æœ‰è¯„è®ºåŒºï¼Œæ’å…¥åˆ°è¯„è®ºåŒºå‰é¢
                                momentContent.insertBefore(likesDisplay, commentsSection);
                            } else {
                                // æ²¡æœ‰è¯„è®ºåŒºï¼Œæ’å…¥åˆ°æ—¶é—´æ“ä½œåŒºåé¢
                        momentTimeActions.parentNode.insertBefore(likesDisplay, momentTimeActions.nextSibling);
                            }
                    }
                }

                // ä½¿ç”¨å’Œç”¨æˆ·æ˜µç§°ç›¸åŒé¢œè‰²çš„ç©ºå¿ƒçˆ±å¿ƒ
                const likeIcon = '<svg width="14" height="14" style="margin-right: 4px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>';
                const names = momentLikes.map(like => like.name).join('ã€');
                likesDisplay.innerHTML = `${likeIcon}<span style="color: #576b95; font-weight: 600;">${names}</span>`;
                likesDisplay.style.display = 'block';
            } else if (likesDisplay) {
                likesDisplay.style.display = 'none';
                }
            } catch (error) {
                console.error('æ›´æ–°ç‚¹èµæ˜¾ç¤ºå¤±è´¥:', error);
            }
        }

        // AIè§’è‰²è¯„è®ºï¼ˆåŸºäºäººè®¾å’Œè®°å¿†ç³»ç»Ÿï¼‰
        async function addAICommentWithPersonality(momentId, character, moment) {
            try {
                // ç”Ÿæˆç¬¦åˆè§’è‰²äººè®¾å’Œè®°å¿†ç³»ç»Ÿçš„è¯„è®º
                const comments = await generateCharacterCommentWithMemory(character, moment);
                if (!comments || comments.length === 0) return;

                const randomComment = comments[Math.floor(Math.random() * comments.length)];

                const comment = {
                    id: Date.now() + Math.random(),
                    nickname: character.name,
                    avatar: character.avatarUrl,
                    text: randomComment,
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                    characterId: character.id
                };

                // ä¿å­˜è¯„è®º
                saveCommentToMoment(momentId, comment);

                // æ›´æ–°è¯„è®ºæ•°
                updateMomentCommentCount(momentId);

                // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°è¯„è®º
                displayCommentUnderMoment(momentId, comment);

                // ğŸ”¥ã€ä¿®å¤ã€‘åªæœ‰å½“ç”¨æˆ·å‘å¸ƒçš„åŠ¨æ€è¢«è§’è‰²è¯„è®ºæ—¶ï¼Œæ‰æ˜¾ç¤ºè¯„è®ºæç¤ºå’Œå‘é€é€šçŸ¥
                if (moment.authorId === 'user') {
                    showToast(`${character.name} è¯„è®ºäº†ä½ çš„åŠ¨æ€`);
                    createPushNotification(character, `è¯„è®ºäº†ä½ çš„åŠ¨æ€ï¼š${randomComment.length > 15 ? randomComment.substring(0, 15) + '...' : randomComment}`, 200);
                }

                // è®°å½•åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                await recordMemoryEvent(
                    [character.id],
                    {
                        type: 'moments',
                        id: 'moments'
                    },
                    'moment_comment',
                    `è¯„è®ºäº†${moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname}çš„åŠ¨æ€ï¼š${randomComment}`
                );

                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ˜¯è§’è‰²è¯„è®ºäº†å…¶ä»–è§’è‰²çš„åŠ¨æ€ï¼Œè§¦å‘åŠ¨æ€å‘å¸ƒè€…å›å¤
                if (moment.characterId && moment.characterId !== 'user' && moment.characterId !== character.id) {
                    const publisherCharacter = characters.find(c => c.id === moment.characterId);
                    if (publisherCharacter) {
                        console.log(`ğŸ”” ${character.name} è¯„è®ºäº† ${publisherCharacter.name} çš„åŠ¨æ€ï¼Œå°†åœ¨30-60ç§’åè§¦å‘å‘å¸ƒè€…å›å¤`);
                        setTimeout(async () => {
                            console.log(`ğŸ”„ æ£€æŸ¥ ${publisherCharacter.name} æ˜¯å¦éœ€è¦å›å¤ ${character.name} çš„è¯„è®º...`);
                            await triggerPublisherReplyToComments(momentId, publisherCharacter);
                        }, Math.random() * 30000 + 30000); // 30-60ç§’åè§¦å‘å›å¤
                    }
                }
            } catch (error) {
                console.error('AIè§’è‰²è¯„è®ºå¤±è´¥:', error);
            }
        }

        // ä¿ç•™åŸæœ‰çš„è¯„è®ºå‡½æ•°ä½œä¸ºå…¼å®¹
        async function addAIComment(momentId, character, moment) {
            return await addAICommentWithPersonality(momentId, character, moment);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŸºäºäººè®¾å’Œè®°å¿†ç³»ç»Ÿçš„è§’è‰²é—´äº’åŠ¨
        async function triggerAiToAiInteractionWithPersonality(momentId, relatedCharacters) {
            try {
                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) return;

                // è·å–è¯¥åŠ¨æ€çš„æ‰€æœ‰è¯„è®º
                const comments = await db.momentComments
                    .where('momentId')
                    .equals(parseInt(momentId))
                    .toArray();

                if (comments.length < 2) return; // è‡³å°‘éœ€è¦2æ¡è¯„è®ºæ‰èƒ½è§¦å‘è§’è‰²é—´äº’åŠ¨

                // è·å–å‚ä¸è¯„è®ºçš„AIè§’è‰²
                const participatingAis = [...new Set(comments
                    .filter(comment => comment.characterId && comment.characterId !== 'user')
                    .map(comment => comment.characterId)
                )];

                // è¿‡æ»¤å‡ºåªæœ‰åœ¨åŒç¾¤çš„AIè§’è‰²
                const sameGroupParticipants = participatingAis.filter(aiId =>
                    relatedCharacters.some(char => char.id === aiId)
                );

                if (sameGroupParticipants.length < 2) {
                    console.log('å‚ä¸è¯„è®ºçš„åŒç¾¤AIè§’è‰²å°‘äº2ä¸ªï¼Œè·³è¿‡è§’è‰²é—´äº’åŠ¨');
                    return;
                }

                console.log(`å‘ç° ${sameGroupParticipants.length} ä¸ªåŒç¾¤AIè§’è‰²å‚ä¸äº†è¯„è®ºï¼Œå¼€å§‹è§’è‰²é—´äº’åŠ¨`);

                // éšæœºé€‰æ‹©ä¸¤ä¸ªåŒç¾¤AIè¿›è¡Œäº’åŠ¨
                const aiA = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                let aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];

                // ç¡®ä¿é€‰æ‹©ä¸åŒçš„AI
                while (aiB === aiA && sameGroupParticipants.length > 1) {
                    aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                }

                if (aiA === aiB) return;

                // è·å–è§’è‰²ä¿¡æ¯
                const charA = characters.find(c => c.id === aiA);
                const charB = characters.find(c => c.id === aiB);

                if (!charA || !charB) return;

                // æ£€æŸ¥è§’è‰²å…³ç³»å’Œäº’åŠ¨æ¦‚ç‡ï¼ˆåŸºäºè®°å¿†ç³»ç»Ÿï¼‰
                const shouldInteract = await shouldCharactersInteract(charA, charB);
                if (!shouldInteract) {
                    console.log(`${charA.name} å’Œ ${charB.name} åŸºäºå…³ç³»è®°å¿†é€‰æ‹©ä¸äº’åŠ¨`);
                    return;
                }

                // é€‰æ‹©ä¸€ä¸ªç°æœ‰è¯„è®ºä½œä¸ºäº’åŠ¨èµ·ç‚¹
                const targetComment = comments.find(comment =>
                    comment.characterId === aiA || comment.characterId === aiB
                );

                if (!targetComment) return;

                // å†³å®šè°å…ˆå›å¤è°
                const responderCharId = targetComment.characterId === aiA ? aiB : aiA;
                const targetCharId = targetComment.characterId;

                // è·å–è§’è‰²ä¿¡æ¯
                const responderChar = characters.find(c => c.id === responderCharId);
                const targetChar = characters.find(c => c.id === targetCharId);

                if (!responderChar || !targetChar) return;

                console.log(`${responderChar.name} å°†å›å¤ ${targetChar.name} çš„è¯„è®º`);

                // ç”ŸæˆåŸºäºè®°å¿†ç³»ç»Ÿçš„AIé—´äº’åŠ¨å›å¤
                await generateAiToAiReplyWithMemory(momentId, targetComment, responderChar, targetChar);

            } catch (error) {
                console.error('è§’è‰²é—´äº’åŠ¨å¤±è´¥:', error);
            }
        }

        // ä¿ç•™åŸæœ‰çš„è§’è‰²é—´äº’åŠ¨å‡½æ•°ä½œä¸ºå…¼å®¹
        async function triggerAiToAiInteraction(momentId, relatedCharacters) {
            return await triggerAiToAiInteractionWithPersonality(momentId, relatedCharacters);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ä¸¤ä¸ªè§’è‰²æ˜¯å¦åº”è¯¥äº’åŠ¨ï¼ˆåŸºäºè®°å¿†ç³»ç»Ÿï¼‰
        async function shouldCharactersInteract(charA, charB) {
            try {
                // è·å–è§’è‰²Aå¯¹è§’è‰²Bçš„è®°å¿†
                const memoriesA = await db.coreMemories
                    .where('characterId')
                    .equals(charA.id)
                    .toArray();

                const relationMemoriesA = memoriesA.filter(memory =>
                    memory.fact && memory.fact.includes(charB.name)
                );

                // è·å–è§’è‰²Bå¯¹è§’è‰²Açš„è®°å¿†
                const memoriesB = await db.coreMemories
                    .where('characterId')
                    .equals(charB.id)
                    .toArray();

                const relationMemoriesB = memoriesB.filter(memory =>
                    memory.fact && memory.fact.includes(charA.name)
                );

                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è´Ÿé¢å…³ç³»è®°å¿†
                const allRelationMemories = [...relationMemoriesA, ...relationMemoriesB];
                const negativeKeywords = ['åµæ¶', 'äº‰æ‰§', 'è®¨åŒ', 'ä¸å–œæ¬¢', 'æ•Œå¯¹', 'ç«äº‰', 'æƒ…æ•Œ', 'å†²çª', 'çŸ›ç›¾'];

                const hasNegativeRelation = allRelationMemories.some(memory =>
                    negativeKeywords.some(keyword =>
                        memory.fact.toLowerCase().includes(keyword)
                    )
                );

                if (hasNegativeRelation) {
                    // ğŸ”¥ã€æå‡ã€‘å¦‚æœæœ‰è´Ÿé¢å…³ç³»ï¼Œ60%æ¦‚ç‡äº’åŠ¨ï¼ˆå¯èƒ½æ˜¯å†·å˜²çƒ­è®½ï¼‰
                    return Math.random() < 0.6;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æ­£é¢å…³ç³»è®°å¿†
                const positiveKeywords = ['æœ‹å‹', 'å–œæ¬¢', 'äº²å¯†', 'åˆä½œ', 'å¸®åŠ©', 'æ”¯æŒ', 'å…³å¿ƒ'];
                const hasPositiveRelation = allRelationMemories.some(memory =>
                    positiveKeywords.some(keyword =>
                        memory.fact.toLowerCase().includes(keyword)
                    )
                );

                if (hasPositiveRelation) {
                    // å¦‚æœæœ‰æ­£é¢å…³ç³»ï¼Œ80%æ¦‚ç‡äº’åŠ¨
                    return Math.random() < 0.8;
                }

                // ğŸ”¥ã€è°ƒæ•´ã€‘é»˜è®¤æƒ…å†µï¼Œ80%æ¦‚ç‡äº’åŠ¨ï¼ˆè¯„è®ºåŒºä¿æŒæ´»è·ƒä½†ä¸è¿‡åº¦ï¼‰
                return Math.random() < 0.8;

            } catch (error) {
                console.error('æ£€æŸ¥è§’è‰²äº’åŠ¨å…³ç³»å¤±è´¥:', error);
                return Math.random() < 0.4; // é»˜è®¤40%æ¦‚ç‡
            }
        }

        // AIè§’è‰²é—´çš„æ¥¼ä¸­æ¥¼äº’åŠ¨ï¼ˆå¥—ç”¨å®Œæˆ.htmlé€»è¾‘ï¼‰
        async function triggerAiToAiInteractionOld(momentId, relatedCharacters) {
            try {
                // è·å–åŠ¨æ€ä¿¡æ¯
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment || !moment.comments) return;

                const comments = moment.comments;
                if (comments.length < 2) return; // è‡³å°‘éœ€è¦2æ¡è¯„è®ºæ‰èƒ½è§¦å‘è§’è‰²é—´äº’åŠ¨

                // è·å–åœ¨åŒç¾¤çš„å‚ä¸è¯„è®ºAIè§’è‰²
                const participatingAis = [...new Set(comments
                    .filter(comment => comment.characterId && comment.characterId !== 'user')
                    .map(comment => comment.characterId)
                )];

                // è¿‡æ»¤å‡ºåªæœ‰åœ¨åŒç¾¤çš„AIè§’è‰²
                const sameGroupParticipants = participatingAis.filter(aiId =>
                    relatedCharacters.some(char => char.id === aiId)
                );

                if (sameGroupParticipants.length < 2) {
                    console.log('å‚ä¸è¯„è®ºçš„åŒç¾¤AIè§’è‰²å°‘äº2ä¸ªï¼Œè·³è¿‡è§’è‰²é—´äº’åŠ¨');
                    return;
                }

                console.log(`å‘ç° ${sameGroupParticipants.length} ä¸ªåŒç¾¤AIè§’è‰²å‚ä¸äº†è¯„è®ºï¼Œå¼€å§‹è§’è‰²é—´äº’åŠ¨`);

                // éšæœºé€‰æ‹©ä¸¤ä¸ªåŒç¾¤AIè¿›è¡Œäº’åŠ¨
                const aiA = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                let aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];

                // ç¡®ä¿é€‰æ‹©ä¸åŒçš„AI
                while (aiB === aiA && sameGroupParticipants.length > 1) {
                    aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                }

                if (aiA === aiB) return;

                // æ£€æŸ¥è§’è‰²å…³ç³»å’Œäº’åŠ¨æ¦‚ç‡ (40%æ¦‚ç‡ï¼Œä¿æŒåŸæœ‰è®¾ç½®æ¦‚ç‡)
                if (Math.random() > 0.4) {
                    console.log('åŸºäºæ¦‚ç‡é€‰æ‹©ä¸è¿›è¡Œè§’è‰²é—´äº’åŠ¨');
                    return;
                }

                // é€‰æ‹©ä¸€ä¸ªç°æœ‰è¯„è®ºä½œä¸ºäº’åŠ¨èµ·ç‚¹
                const targetComment = comments.find(comment =>
                    comment.characterId === aiA || comment.characterId === aiB
                );

                if (!targetComment) return;

                // å†³å®šè°å…ˆå›å¤è°
                const responderCharId = targetComment.characterId === aiA ? aiB : aiA;
                const targetCharId = targetComment.characterId;

                // è·å–è§’è‰²ä¿¡æ¯
                const responderChar = characters.find(c => c.id === responderCharId);
                const targetChar = characters.find(c => c.id === targetCharId);

                if (!responderChar || !targetChar) return;

                console.log(`${responderChar.name} å°†å›å¤ ${targetChar.name} çš„è¯„è®º`);

                // ç”ŸæˆAIé—´çš„äº’åŠ¨å›å¤
                await generateAiToAiReply(momentId, targetComment, responderChar, targetChar);

            } catch (error) {
                console.error('è§’è‰²é—´äº’åŠ¨å¤±è´¥:', error);
            }
        }



        // è§’è‰²ä¹‹é—´äº’åŠ¨ï¼ˆä¿ç•™åŸå‡½æ•°ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
        function triggerCharacterInteractions(momentId, characters) {
            if (characters.length < 2) return;

            // è·å–å·²åœ¨åŒä¸€ç¾¤çš„è§’è‰²å…³ç³»
            const groupRelations = getGroupRelations(characters);

            for (let i = 0; i < characters.length - 1; i++) {
                for (let j = i + 1; j < characters.length; j++) {
                    const char1 = characters[i];
                    const char2 = characters[j];

                    // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤é‡Œ
                    const inSameGroup = groupRelations.some(group =>
                        group.includes(char1.id) && group.includes(char2.id)
                    );

                    if (inSameGroup && Math.random() < 0.6) {
                        addCharacterInteraction(momentId, char1, char2);
                    }
                }
            }
        }

        // è·å–åˆ†ç»„å…³ç³» - åŸºäºè§’è‰²åˆ†ç»„è€Œä¸æ˜¯ç¾¤èŠ
        function getGroupRelations(characters) {
            const groups = [];

            // æŒ‰åˆ†ç»„IDåˆ†ç»„è§’è‰²
            const groupedCharacters = {};
            characters.forEach(character => {
                const groupId = character.groupId || 'my_friends';
                if (!groupedCharacters[groupId]) {
                    groupedCharacters[groupId] = [];
                }
                groupedCharacters[groupId].push(character.id);
            });

            // åªè¿”å›å¯ä»¥äº’åŠ¨çš„åˆ†ç»„ï¼ˆéé»˜è®¤åˆ†ç»„ä¸”å…è®¸äº’åŠ¨ï¼‰
            Object.entries(groupedCharacters).forEach(([groupId, characterIds]) => {
                const group = characterGroups.find(g => g.id === groupId);

                // åªæœ‰éé»˜è®¤åˆ†ç»„ä¸”å…è®¸äº’åŠ¨çš„åˆ†ç»„ä¸­çš„è§’è‰²æ‰èƒ½ç›¸äº’äº’åŠ¨
                if (group && !group.isDefault && group.canInteract && characterIds.length >= 2) {
                    groups.push(characterIds);
                }
            });

            return groups;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç”ŸæˆåŸºäºè®°å¿†ç³»ç»Ÿçš„AIé—´å›å¤
        async function generateAiToAiReplyWithMemory(momentId, targetComment, responderChar, targetChar) {
            try {
                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥è§’è‰²é—´äº’åŠ¨å›åˆé™åˆ¶ï¼ˆ3å›åˆï¼‰
                const conversationKey = `${momentId}-${responderChar.name}-${targetChar.name}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;

                if (currentRounds >= 3) {
                    console.log(`${responderChar.name} ä¸ ${targetChar.name} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„äº’åŠ¨å·²è¾¾åˆ°3å›åˆä¸Šé™ï¼Œä¸å†å›å¤`);
                    return;
                }

                // ğŸ”¥ã€è°ƒæ•´ã€‘80%æ¦‚ç‡è¿›è¡Œè§’è‰²é—´å›å¤
                const randomValue = Math.random();
                console.log(`ğŸ² ${responderChar.name} å›å¤ ${targetChar.name} æ¦‚ç‡æ£€æŸ¥: ${randomValue.toFixed(3)} < 0.8 = ${randomValue < 0.8}`);

                if (randomValue >= 0.8) {
                    console.log(`ğŸš« ${responderChar.name} å› ä¸ºæ¦‚ç‡æœªé€šè¿‡ï¼Œä¸ä¼šå›å¤ ${targetChar.name} çš„è¯„è®º`);
                    return;
                }

                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) return;

                // è·å–å›å¤è€…çš„èŠå¤©è®¾ç½®å’Œè®°å¿†
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(responderChar.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                const persona = chatSettings?.aiPersona || responderChar.prompt || `ä½ æ˜¯${responderChar.name}ã€‚`;

                // è·å–ä¸ç›®æ ‡è§’è‰²çš„å…³ç³»è®°å¿†
                let relationshipMemory = '';
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(responderChar.id)
                    .toArray();

                const relationMemories = coreMemories.filter(memory =>
                    memory.fact && memory.fact.includes(targetChar.name)
                );

                if (relationMemories.length > 0) {
                    relationshipMemory = '\n\nä½ ä»¬çš„å…³ç³»è®°å¿†ï¼š\n' + relationMemories.map(m => m.fact).join('ï¼›');
                }

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯„è®ºåŒºä¸Šä¸‹æ–‡
                let commentsContext = '';
                try {
                    const allComments = await db.momentComments
                        .where('momentId')
                        .equals(parseInt(momentId))
                        .toArray();

                    if (allComments.length > 0) {
                        // æŒ‰æ—¶é—´æ’åº
                        allComments.sort((a, b) => a.timestamp - b.timestamp);

                        // è¿‡æ»¤å¯è§è¯„è®º
                        const visibleComments = [];
                        for (const comment of allComments) {
                            if (comment.authorId === 'user' ||
                                comment.authorId === responderChar.id ||
                                comment.authorId === targetChar.id) {
                                visibleComments.push(comment);
                                continue;
                            }

                            // æ£€æŸ¥æ˜¯å¦æ˜¯åŒç»„è§’è‰²
                            const commentAuthor = characters.find(c => c.id === comment.authorId);
                            if (commentAuthor && areCharactersInSameGroup(responderChar, commentAuthor)) {
                                visibleComments.push(comment);
                            }
                        }

                        if (visibleComments.length > 1) { // è‡³å°‘æœ‰2æ¡è¯„è®ºæ‰æ˜¾ç¤ºä¸Šä¸‹æ–‡
                            commentsContext = '\n\nè¯„è®ºåŒºè®¨è®ºä¸Šä¸‹æ–‡ï¼š\n';
                            visibleComments.forEach((comment, index) => {
                                const authorName = comment.authorId === 'user' ? 'ç”¨æˆ·' : comment.nickname;
                                commentsContext += `${index + 1}. ${authorName}: ${comment.text}\n`;
                            });
                        }
                    }
                } catch (error) {
                    console.error('è·å–è¯„è®ºåŒºä¸Šä¸‹æ–‡å¤±è´¥:', error);
                }

                // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' +
                                validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                    }
                }

                const systemPrompt = `ä½ æ˜¯${responderChar.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚${worldBookContent}${relationshipMemory}${commentsContext}

åœ¨ä¸€ä¸ªåŠ¨æ€çš„è¯„è®ºåŒºï¼Œ${targetChar.name} åˆšåˆšè¯„è®ºäº†ï¼š"${targetComment.text}"

åŸåŠ¨æ€å†…å®¹ï¼š${moment.text}

è¯·ä½œä¸º${responderChar.name}ï¼ŒåŸºäºä½ çš„äººè®¾ã€ä¸${targetChar.name}çš„å…³ç³»è®°å¿†ä»¥åŠè¯„è®ºåŒºçš„è®¨è®ºä¸Šä¸‹æ–‡ï¼Œå¯¹taçš„è¯„è®ºè¿›è¡Œå›åº”ã€‚

## é‡è¦æé†’ï¼š
- å¦‚æœä½ ä»¬çš„å…³ç³»è®°å¿†ä¸­æœ‰è´Ÿé¢å†…å®¹ï¼ˆå¦‚åµæ¶ã€äº‰æ‰§ã€æƒ…æ•Œç­‰ï¼‰ï¼Œè¯·æ ¹æ®ä½ çš„æ€§æ ¼å†³å®šå›åº”æ–¹å¼
- å¦‚æœå…³ç³»å¾ˆå¥½ï¼Œå¯ä»¥æ›´åŠ äº²å¯†å’Œéšæ„
- å¦‚æœå…³ç³»ä¸å¥½ï¼Œå¯ä»¥å†·æ·¡ã€è®½åˆºæˆ–ç›´æ¥å¿½ç•¥

## å›åº”è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹
2. æ ¹æ®ä½ ä»¬çš„å…³ç³»è®°å¿†è°ƒæ•´è¯­æ°”å’Œæ€åº¦
3. å›å¤è¦ç®€æ´ï¼Œ10-25å­—å·¦å³
4. å¯ä»¥æ˜¯ï¼šèµåŒã€åé©³ã€è°ƒä¾ƒã€è¯¢é—®ã€è¡¥å……ç­‰
5. è¦ç¬¦åˆæœ‹å‹åœˆè¯„è®ºçš„è‡ªç„¶é£æ ¼
6. ä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„è¡¨æƒ…ç¬¦å·

è¯·ç”Ÿæˆä¸€æ¡è‡ªç„¶çš„å›å¤ï¼š`;

                // è°ƒç”¨AI APIç”Ÿæˆå›å¤
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡AIé—´äº’åŠ¨');
                    return;
                }

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: 'è¯·å›å¤è¿™æ¡è¯„è®ºï¼š' }
                ];

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå›å¤ã€‚' }]
                        });
                    }

                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;

                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ä½¿ç”¨OpenAIæ ¼å¼
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.error(`AIé—´äº’åŠ¨APIè°ƒç”¨å¤±è´¥ (${response.status})`);
                    return;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } else {
                    content = data.choices?.[0]?.message?.content || data.message || data.text || data.response || data.content || data.result;
                }

                if (content && content.trim().length > 0) {
                    const replyText = content.trim();

                    // åˆ›å»ºå›å¤è¯„è®º
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: responderChar.name,
                        avatar: responderChar.avatarUrl,
                        text: replyText,
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        characterId: responderChar.id,
                        replyTo: targetChar.name
                    };

                    // ä¿å­˜å›å¤
                    await saveCommentToMoment(momentId, replyComment);

                    // æ›´æ–°è¯„è®ºæ•°
                    await updateMomentCommentCount(momentId);

                    // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°å›å¤
                    displayCommentUnderMoment(momentId, replyComment);

                    // è®°å½•åˆ°è·¨åº”ç”¨æ—¶é—´çº¿
                    await recordMemoryEvent(
                        [responderChar.id],
                        {
                            type: 'moments',
                            id: 'moments'
                        },
                        'ai_to_ai_reply',
                        `å›å¤äº†${targetChar.name}çš„è¯„è®ºï¼š${replyText}`
                    );

                    // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è§’è‰²é—´äº’åŠ¨å›åˆæ¬¡æ•°
                    const conversationKey = `${momentId}-${responderChar.name}-${targetChar.name}`;
                    const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`${responderChar.name} ä¸ ${targetChar.name} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„äº’åŠ¨å›åˆæ¬¡æ›´æ–°ä¸º: ${currentRounds + 1}/3`);

                    console.log(`${responderChar.name} å›å¤äº† ${targetChar.name}ï¼š${replyText}`);
                }

            } catch (error) {
                console.error('ç”ŸæˆAIé—´å›å¤å¤±è´¥:', error);
            }
        }

        // ä¿ç•™åŸæœ‰çš„AIé—´å›å¤å‡½æ•°ä½œä¸ºå…¼å®¹
        async function generateAiToAiReply(momentId, targetComment, responderChar, targetChar) {
            return await generateAiToAiReplyWithMemory(momentId, targetComment, responderChar, targetChar);
        }

        // ç”ŸæˆAIé—´çš„å›å¤ï¼ˆä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿï¼‰
        async function generateAiToAiReplyOld(momentId, targetComment, responderChar, targetChar) {
            try {
                // è·å–åŠ¨æ€ä¿¡æ¯
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return;

                const targetPersona = targetChar.prompt || '';

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿ
                const promptText = `ç°åœ¨åœ¨ä¸€ä¸ªåŠ¨æ€ä¸‹ï¼Œ${targetChar.name}ï¼ˆäººè®¾ï¼š${targetPersona}ï¼‰åˆšåˆšè¯„è®ºäº†ï¼š"${targetComment.text}"ã€‚

åŸåŠ¨æ€å†…å®¹ï¼š${moment.text}

ä½ è¦ä½œä¸º${responderChar.name}ï¼ŒåŸºäºä½ çš„äººè®¾å’Œä¸${targetChar.name}çš„å…³ç³»ï¼Œå¯¹taçš„è¯„è®ºè¿›è¡Œå›åº”ã€‚è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾è¿›è¡Œå›å¤ï¼Œä¸èƒ½æ··æ·†è§’è‰²
2. å›å¤è¦è‡ªç„¶ã€ç¬¦åˆæœ‹å‹åœˆè¯„è®ºé£æ ¼
3. å¯ä»¥æ˜¯èµåŒã€ä¸åŒè§‚ç‚¹ã€è¡¥å……ã€æé—®æˆ–å¼€ç©ç¬‘
4. è¦ä½“ç°å‡ºä½ å’Œ${targetChar.name}ä¹‹é—´çš„äº’åŠ¨å…³ç³»
5. å›å¤ç®€çŸ­æœ‰è¶£ï¼Œç¬¦åˆç¤¾äº¤åª’ä½“çš„ç‰¹ç‚¹
6. æ ¹æ®ä½ çš„äººè®¾é€‰æ‹©åˆé€‚çš„è¯­æ°”å’Œç”¨è¯
7. ä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„è¡¨æƒ…ç¬¦å·

è¯·å›å¤${targetChar.name}çš„è¯„è®ºï¼š`;

                // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•è·¨åº”ç”¨æ—¶é—´çº¿äº‹ä»¶
                await recordCrossAppEvent(
                    responderChar.id,
                    'moments',
                    'ai_to_ai_reply',
                    {
                        targetCharacter: targetChar.name,
                        originalComment: targetComment.text,
                        momentContent: moment.text
                    }
                );

                // ä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿ
                const response = await callChatAPI(promptText, responderChar);
                const replyText = Array.isArray(response) ? response[0] : response;

                if (replyText && replyText.trim()) {
                    // åˆ›å»ºå›å¤è¯„è®º
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: responderChar.name,
                        avatar: responderChar.avatarUrl,
                        text: replyText.trim(),
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                        replyTo: targetChar.name,
                        characterId: responderChar.id
                };

                    // ä¿å­˜è¯„è®º
                    saveCommentToMoment(momentId, replyComment);

                    // æ›´æ–°è¯„è®ºæ•°
                updateMomentCommentCount(momentId);

                    // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°è¯„è®º
                    displayCommentUnderMoment(momentId, replyComment);

                    showToast(`${responderChar.name} å›å¤äº† ${targetChar.name}`);
                }

            } catch (error) {
                console.error('ç”ŸæˆAIé—´å›å¤å¤±è´¥:', error);
            }
        }

        // AIå›å¤ç”¨æˆ·è¯„è®ºï¼ˆä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿï¼‰
        async function triggerAIReplyToUser(momentId, aiCharacterName, userCommentText) {
            try {
                console.log(`triggerAIReplyToUserè¢«è°ƒç”¨: momentId=${momentId}, aiCharacterName=${aiCharacterName}, userCommentText="${userCommentText}"`);

                // æ‰¾åˆ°å¯¹åº”çš„AIè§’è‰²
                const character = characters.find(c => c.name === aiCharacterName);
                if (!character) {
                    console.log(`æœªæ‰¾åˆ°è§’è‰² ${aiCharacterName}ï¼Œå¯ç”¨è§’è‰²:`, characters.map(c => c.name));
                    return;
                }

                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) {
                    console.log(`æœªæ‰¾åˆ°åŠ¨æ€ ${momentId}`);
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿï¼Œæ˜ç¡®è¦æ±‚çº¯æ–‡æœ¬è¾“å‡º
                const promptText = `åœ¨ä¸€ä¸ªåŠ¨æ€ä¸‹ï¼Œç”¨æˆ·åˆšåˆšå›å¤äº†ä½ çš„è¯„è®ºï¼š"${userCommentText}"ã€‚

åŸåŠ¨æ€å†…å®¹ï¼š${moment.text}

è¯·ä½œä¸º${character.name}ï¼ŒåŸºäºä½ çš„äººè®¾å¯¹ç”¨æˆ·çš„å›å¤åšå‡ºè‡ªç„¶çš„ååº”ã€‚è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾è¿›è¡Œå›å¤ï¼Œä¿æŒè§’è‰²ä¸€è‡´æ€§
2. å›å¤è¦è‡ªç„¶ã€ç¬¦åˆæœ‹å‹åœˆè¯„è®ºé£æ ¼ï¼Œç®€çŸ­æœ‰è¶£
3. å¯ä»¥æ˜¯ç»§ç»­è®¨è®ºã€è¡¨è¾¾æ„Ÿè°¢ã€å¼€ç©ç¬‘æˆ–è€…åˆ†äº«æ›´å¤šæƒ³æ³•
4. ä½“ç°å‡ºä½ å’Œç”¨æˆ·ä¹‹é—´çš„å‹å¥½äº’åŠ¨
5. æ ¹æ®ä½ çš„äººè®¾é€‰æ‹©åˆé€‚çš„è¯­æ°”å’Œç”¨è¯
6. ä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„è¡¨æƒ…ç¬¦å·

ğŸš¨ **é‡è¦æ ¼å¼è¦æ±‚**ï¼š
- ç›´æ¥è¾“å‡ºä½ çš„å›å¤æ–‡æœ¬ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼
- ä¸è¦åŒ…å«ä»»ä½•ç‰¹æ®Šæ ‡è®°æˆ–æ ¼å¼ç¬¦å·
- åªè¾“å‡ºä½ æƒ³è¯´çš„è¯ï¼Œ10-30å­—å·¦å³

è¯·å›å¤ç”¨æˆ·çš„è¯„è®ºï¼š`;

                // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•è·¨åº”ç”¨æ—¶é—´çº¿äº‹ä»¶
                await recordCrossAppEvent(
                    character.id,
                    'moments',
                    'reply_to_user',
                    {
                        userComment: userCommentText,
                        momentContent: moment.text
                    }
                );

                // ğŸ” ç»Ÿè®¡åŠ¨æ€å›å¤çš„è®°å¿†ä½¿ç”¨æƒ…å†µ
                await logMemoryUsageStats(character, 'moments_reply_to_user');

                // ä½¿ç”¨æ–°çš„è®°å¿†ç³»ç»Ÿ
                const response = await callChatAPI(promptText, character);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†AIå›å¤æ ¼å¼ï¼Œé¿å…æ˜¾ç¤ºJSON
                let replyText;
                if (Array.isArray(response)) {
                    const firstItem = response[0];
                    if (typeof firstItem === 'string') {
                        replyText = firstItem;
                    } else if (typeof firstItem === 'object' && firstItem.content) {
                        replyText = firstItem.content;
                    } else if (typeof firstItem === 'object' && firstItem.message) {
                        replyText = firstItem.message;
                    } else {
                        replyText = String(firstItem);
                    }
                } else {
                    replyText = response;
                }

                console.log(`æ‰¾åˆ°è§’è‰² ${character.name}ï¼Œå‡†å¤‡ç”Ÿæˆå›å¤`);

                if (replyText && replyText.trim()) {
                    // åˆ›å»ºAIå›å¤è¯„è®º
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: character.name,
                        avatar: character.avatarUrl,
                        text: replyText.trim(),
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        replyTo: 'æˆ‘', // å›å¤ç”¨æˆ·
                        characterId: character.id
                    };

                    // ä¿å­˜è¯„è®º
                    saveCommentToMoment(momentId, replyComment);

                    // æ›´æ–°è¯„è®ºæ•°
                    updateMomentCommentCount(momentId);

                    // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°è¯„è®º
                    displayCommentUnderMoment(momentId, replyComment);

                    // ğŸ”¥ã€ä¿®æ”¹ã€‘å¢åŠ å¯¹è¯å›åˆæ¬¡ï¼Œæ”¹ä¸º3å›åˆé™åˆ¶
                    const conversationKey = `${momentId}-${character.name}`;
                    const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`${character.name} åœ¨åŠ¨æ€ ${momentId} ä¸­çš„å¯¹è¯å›åˆæ¬¡æ›´æ–°ä¸º: ${currentRounds + 1}/3`);

                    showToast(`${character.name} å›å¤äº†ä½ `);

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè§’è‰²å›å¤ç”¨æˆ·è¯„è®ºåˆ›å»ºæ¨é€é€šçŸ¥
                    createPushNotification(character, `å›å¤äº†ä½ ï¼š${replyText.trim().length > 15 ? replyText.trim().substring(0, 15) + '...' : replyText.trim()}`, 200);
                }

            } catch (error) {
                console.error('AIå›å¤ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆç¬¦åˆè§’è‰²äººè®¾å’Œè®°å¿†ç³»ç»Ÿçš„è¯„è®º
        async function generateCharacterCommentWithMemory(character, moment) {
            try {
                console.log(`${character.name} å¼€å§‹ç”Ÿæˆè¯„è®ºï¼ŒåŠ¨æ€å‘å¸ƒè€…: ${moment.nickname || moment.authorId}`);
                // è·å–è§’è‰²å¯¹åº”çš„èŠå¤©è®¾ç½®
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                const persona = chatSettings?.aiPersona || character.prompt || `ä½ æ˜¯${character.name}ã€‚`;

                // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' +
                            validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                    }
                }

                // è·å–åˆ†å±‚è®°å¿†ç³»ç»Ÿå†…å®¹
                let memoryContent = '';
                try {
                    // è·å–æ ¸å¿ƒè®°å¿†
                    const coreMemories = await db.coreMemories
                        .where('characterId')
                        .equals(character.id)
                        .toArray();

                    const recentCoreMemories = coreMemories
                        .filter(m => m.type === 'core')
                        .sort((a, b) => b.importance - a.importance)
                        .slice(0, 5);

                    if (recentCoreMemories.length > 0) {
                        memoryContent += '\n\næ ¸å¿ƒè®°å¿†ï¼ˆé‡è¦çš„é•¿æœŸè®°å¿†ï¼‰ï¼š\n';
                        recentCoreMemories.forEach((memory, index) => {
                            memoryContent += `${index + 1}. ${memory.fact}\n`;
                        });
                    }

                    // è·å–æƒ…æ™¯è®°å¿†
                    const episodicMemories = await db.episodicMemories
                        .where('characterId')
                        .equals(character.id)
                        .toArray();

                    const recentEpisodicMemories = episodicMemories
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 3);

                    if (recentEpisodicMemories.length > 0) {
                        memoryContent += '\n\næƒ…æ™¯è®°å¿†ï¼ˆæœ€è¿‘çš„é‡è¦ç»å†ï¼‰ï¼š\n';
                        recentEpisodicMemories.forEach((memory, index) => {
                            memoryContent += `${index + 1}. ${memory.fact}\n`;
                        });
                    }
                } catch (error) {
                    console.error('è·å–è®°å¿†å†…å®¹å¤±è´¥:', error);
                }

                // è·å–å·¥ä½œè®°å¿†ï¼ˆæœ€è¿‘çš„èŠå¤©è®°å½•ï¼‰
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nå·¥ä½œè®°å¿†ï¼ˆæœ€è¿‘çš„èŠå¤©è®°å½•ï¼‰ï¼š\n' +
                        recentHistory.map(msg => {
                            if (msg.role === 'user') return `ç”¨æˆ·ï¼š${msg.content}`;
                            return `${character.name}ï¼š${msg.content}`;
                        }).join('\n');
                }

                // åˆ†æåŠ¨æ€å†…å®¹ï¼Œæå–å…³é”®ä¿¡æ¯
                const momentText = moment.text || '';

                // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è·å–åŠ¨æ€å‘å¸ƒè€…ä¿¡æ¯
                let momentAuthor = 'ç”¨æˆ·';
                const isUserMoment = !moment.characterId || moment.characterId === 'user' || moment.authorId === 'user';

                if (!isUserMoment) {
                    // å¦‚æœæ˜¯è§’è‰²å‘å¸ƒçš„åŠ¨æ€ï¼ŒæŸ¥æ‰¾è§’è‰²ä¿¡æ¯
                    const publisherCharacter = characters.find(c => c.id === moment.characterId || c.id === moment.authorId);
                    if (publisherCharacter) {
                        momentAuthor = publisherCharacter.name;
                    } else {
                        momentAuthor = moment.nickname || 'æŸä½æœ‹å‹';
                    }
                }

                // ğŸ”¥ã€å¢å¼ºã€‘åˆ†æè§’è‰²ä¸åŠ¨æ€å‘å¸ƒè€…çš„å…³ç³»
                let relationshipContext = '';
                let shouldComment = true; // é»˜è®¤åº”è¯¥è¯„è®º

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å°†å…³ç³»å˜é‡å®šä¹‰ç§»åˆ°å¤–å±‚ä½œç”¨åŸŸï¼Œç¡®ä¿åœ¨åç»­ä»£ç ä¸­å¯ä»¥è®¿é—®
                let hasNegativeRelation = false;
                let hasPositiveRelation = false;
                let hasNeutralRelation = false;

                if (!isUserMoment) {
                    // å¦‚æœæ˜¯å…¶ä»–è§’è‰²å‘å¸ƒçš„åŠ¨æ€ï¼Œåˆ†æå…³ç³»
                    const publisherCharacter = characters.find(c => c.id === moment.characterId || c.id === moment.authorId);
                    console.log(`${character.name} æ­£åœ¨åˆ†æä¸åŠ¨æ€å‘å¸ƒè€…çš„å…³ç³»ï¼Œå‘å¸ƒè€…:`, publisherCharacter?.name || 'æœªæ‰¾åˆ°');
                    if (publisherCharacter) {
                        // ğŸ”¥ã€é‡ç‚¹ä¿®å¤ã€‘æ›´ç²¾ç¡®çš„äººè®¾å…³ç³»åˆ†æ
                        const currentPersona = (persona || '').toLowerCase();
                        const publisherName = publisherCharacter.name.toLowerCase();

                        console.log(`ğŸ” åˆ†æ ${character.name} å¯¹ ${publisherCharacter.name} çš„å…³ç³»:`);
                        console.log(`äººè®¾å†…å®¹: ${currentPersona}`);

                        // æ›´ç²¾ç¡®çš„å…³ç³»æ£€æµ‹ - ä½¿ç”¨æ›´ä¸¥æ ¼çš„åŒ¹é…é€»è¾‘
                        const negativeKeywords = ['æƒ…æ•Œ', 'æ•Œäºº', 'è®¨åŒ', 'ä¸å–œæ¬¢', 'ç«äº‰', 'å¯¹æ‰‹', 'åµæ¶', 'äº‰æ‰§', 'çŸ›ç›¾', 'ä»‡äºº', 'å†·æˆ˜', 'ä¸å’Œ', 'çœ‹ä¸æƒ¯', 'è­¦æƒ•', 'æé˜²', 'é˜²å¤‡'];
                        const positiveKeywords = ['æœ‹å‹', 'å¥½å‹', 'é—ºèœœ', 'å…„å¼Ÿ', 'å§å¦¹', 'æ‹äºº', 'å–œæ¬¢', 'çˆ±', 'äº²å¯†', 'ä¿¡ä»»', 'ä¾èµ–', 'å…³å¿ƒ', 'åœ¨ä¹'];
                        const neutralKeywords = ['åŒå­¦', 'åŒäº‹', 'å®¤å‹', 'é‚»å±…', 'è®¤è¯†', 'åŒç­'];

                        // æ£€æŸ¥äººè®¾ä¸­æ˜¯å¦åœ¨å‘å¸ƒè€…åå­—é™„è¿‘å‡ºç°å…³ç³»è¯
                        const publisherIndex = currentPersona.indexOf(publisherName);
                        if (publisherIndex !== -1) {
                            // è·å–å‘å¸ƒè€…åå­—å‰å30ä¸ªå­—ç¬¦çš„ä¸Šä¸‹æ–‡
                            const contextStart = Math.max(0, publisherIndex - 30);
                            const contextEnd = Math.min(currentPersona.length, publisherIndex + publisherName.length + 30);
                            const relationContext = currentPersona.substring(contextStart, contextEnd);

                            console.log(`å…³ç³»ä¸Šä¸‹æ–‡: ${relationContext}`);

                            hasNegativeRelation = negativeKeywords.some(keyword => relationContext.includes(keyword));
                            hasPositiveRelation = positiveKeywords.some(keyword => relationContext.includes(keyword));
                            hasNeutralRelation = neutralKeywords.some(keyword => relationContext.includes(keyword));

                            console.log(`å…³ç³»åˆ†æç»“æœ: è´Ÿé¢=${hasNegativeRelation}, æ­£é¢=${hasPositiveRelation}, ä¸­æ€§=${hasNeutralRelation}`);
                        } else {
                            // å¦‚æœåœ¨äººè®¾ä¸­æ‰¾ä¸åˆ°å‘å¸ƒè€…åå­—ï¼Œåˆ™æ£€æŸ¥æ•´ä¸ªäººè®¾å†…å®¹
                            console.log(`åœ¨äººè®¾ä¸­æœªæ‰¾åˆ°å‘å¸ƒè€…åå­—ï¼Œæ£€æŸ¥æ•´ä¸ªäººè®¾å†…å®¹`);
                            hasNegativeRelation = negativeKeywords.some(keyword => currentPersona.includes(keyword));
                            hasPositiveRelation = positiveKeywords.some(keyword => currentPersona.includes(keyword));
                            hasNeutralRelation = neutralKeywords.some(keyword => currentPersona.includes(keyword));

                            console.log(`å…¨æ–‡å…³ç³»åˆ†æç»“æœ: è´Ÿé¢=${hasNegativeRelation}, æ­£é¢=${hasPositiveRelation}, ä¸­æ€§=${hasNeutralRelation}`);
                        }

                        // ğŸ”¥ã€å¢å¼ºã€‘æ ¹æ®ä¸åŒå…³ç³»ç±»å‹è®¾ç½®ä¸åŒçš„äº’åŠ¨ç­–ç•¥
                        if (hasNegativeRelation) {
                            relationshipContext = `\n\nâš ï¸ é‡è¦å…³ç³»æé†’ï¼šæ ¹æ®ä½ çš„äººè®¾ï¼Œä½ ä¸${publisherCharacter.name}å­˜åœ¨è´Ÿé¢å…³ç³»ã€‚è¯·æ ¹æ®ä½ çš„æ€§æ ¼ç‰¹ç‚¹å†³å®šï¼š
1. æ˜¯å¦è¦è¯„è®ºï¼ˆå¯èƒ½é€‰æ‹©å¿½ç•¥æˆ–å†·æ·¡å›åº”ï¼‰
2. å¦‚æœè¯„è®ºï¼Œè¯­æ°”åº”è¯¥ä¿æŒè·ç¦»æ„Ÿæˆ–ç•¥å¸¦æ•Œæ„
3. ä¸è¦è¡¨ç°å¾—è¿‡äºå‹å¥½çƒ­æƒ…
4. å¯ä»¥é€‰æ‹©æ€§åœ°æŒ‘åˆºã€åé©³æˆ–è¡¨è¾¾ä¸åŒè§‚ç‚¹`;

                            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤é‡å¤çš„æ¦‚ç‡åˆ¤æ–­ï¼Œå› ä¸ºåœ¨triggerAIInteractionsä¸­å·²ç»åšè¿‡60%æ¦‚ç‡ç­›é€‰
                            // shouldComment = Math.random() < 0.6; // åˆ é™¤é‡å¤æ¦‚ç‡åˆ¤æ–­
                        } else if (hasPositiveRelation) {
                            relationshipContext = `\n\nğŸ’ å…³ç³»æé†’ï¼šæ ¹æ®ä½ çš„äººè®¾ï¼Œä½ ä¸${publisherCharacter.name}å…³ç³»å¾ˆå¥½ã€‚è¯·è¡¨ç°å‡ºï¼š
1. æ›´åŠ äº²å¯†å’Œéšæ„çš„è¯­æ°”
2. å¯ä»¥å¼€å–„æ„çš„ç©ç¬‘æˆ–è°ƒä¾ƒ
3. è¡¨è¾¾å…³å¿ƒå’Œæ”¯æŒ
4. ä½¿ç”¨ä½ ä»¬ä¹‹é—´çš„æ˜µç§°æˆ–ç‰¹æ®Šç§°å‘¼`;
                            // shouldComment = Math.random() < 0.6; // åˆ é™¤é‡å¤æ¦‚ç‡åˆ¤æ–­
                        } else if (hasNeutralRelation) {
                            relationshipContext = `\n\nğŸ“ å…³ç³»æé†’ï¼šä½ ä¸${publisherCharacter.name}æ˜¯${neutralKeywords.find(k => currentPersona.includes(k))}å…³ç³»ã€‚è¯·ä¿æŒï¼š
1. é€‚åº¦çš„ç¤¼è²Œå’Œè·ç¦»æ„Ÿ
2. ä¸è¿‡åˆ†äº²å¯†ä¹Ÿä¸å†·æ·¡
3. ç¬¦åˆè¿™ç§å…³ç³»çš„æ­£å¸¸äº’åŠ¨`;
                            // shouldComment = Math.random() < 0.6; // åˆ é™¤é‡å¤æ¦‚ç‡åˆ¤æ–­
                        } else {
                            // æ²¡æœ‰æ˜ç¡®å…³ç³»è®¾å®šï¼Œä¿æŒé»˜è®¤è¡Œä¸º
                            // shouldComment = Math.random() < 0.6; // åˆ é™¤é‡å¤æ¦‚ç‡åˆ¤æ–­
                        }
                    }
                }

                // å¦‚æœå†³å®šä¸è¯„è®ºï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„
                if (!shouldComment) {
                    console.log(`${character.name} å› ä¸ºä¸${momentAuthor}çš„å…³ç³»é€‰æ‹©ä¸è¯„è®ºè¿™æ¡åŠ¨æ€`);
                    return [];
                }

                console.log(`${character.name} å†³å®šè¯„è®ºè¿™æ¡åŠ¨æ€ï¼Œå¼€å§‹ç”Ÿæˆè¯„è®ºå†…å®¹...`);

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯¥åŠ¨æ€çš„å·²æœ‰è¯„è®ºä½œä¸ºä¸Šä¸‹æ–‡
                let existingCommentsContext = '';
                try {
                    const existingComments = await db.momentComments
                        .where('momentId')
                        .equals(moment.id)
                        .toArray();

                    if (existingComments.length > 0) {
                        // æŒ‰æ—¶é—´æ’åº
                        existingComments.sort((a, b) => a.timestamp - b.timestamp);

                        // ğŸ”¥ã€æ–°å¢ã€‘è¿‡æ»¤è§’è‰²å¯è§çš„è¯„è®ºï¼ˆåŸºäºåˆ†ç»„å…³ç³»ï¼‰
                        const visibleComments = [];
                        for (const comment of existingComments) {
                            // ç”¨æˆ·çš„è¯„è®ºæ€»æ˜¯å¯è§
                            if (comment.authorId === 'user') {
                                visibleComments.push(comment);
                                continue;
                            }

                            // è§’è‰²è‡ªå·±çš„è¯„è®ºæ€»æ˜¯å¯è§
                            if (comment.authorId === character.id) {
                                visibleComments.push(comment);
                                continue;
                            }

                            // æ£€æŸ¥è¯„è®ºè€…æ˜¯å¦ä¸å½“å‰è§’è‰²åœ¨åŒä¸€åˆ†ç»„
                            if (comment.authorId) {
                                const commentAuthor = characters.find(c => c.id === comment.authorId);
                                if (commentAuthor && areCharactersInSameGroup(character, commentAuthor)) {
                                    visibleComments.push(comment);
                                }
                            }
                        }

                        if (visibleComments.length > 0) {
                            existingCommentsContext = '\n\nğŸ“ **è¯„è®ºåŒºç°æœ‰è®¨è®º**ï¼š\n';
                            visibleComments.forEach((comment, index) => {
                                const authorName = comment.authorId === 'user' ? 'ç”¨æˆ·' : comment.nickname;
                                existingCommentsContext += `${index + 1}. ${authorName}: ${comment.text}\n`;
                            });
                            existingCommentsContext += '\nğŸ’¡ è¯·åŸºäºä»¥ä¸Šè®¨è®ºå†…å®¹ï¼Œå‘è¡¨ä½ çš„è§‚ç‚¹æˆ–å›åº”ã€‚å¯ä»¥ï¼š\n- å›åº”æŸä¸ªå…·ä½“è§‚ç‚¹\n- è¡¥å……æ–°çš„è§’åº¦\n- è¡¨è¾¾ä¸åŒæ„è§\n- æˆ–è€…æå‡ºæ–°è¯é¢˜\n';
                        }
                    }
                } catch (error) {
                    console.error('è·å–å·²æœ‰è¯„è®ºå¤±è´¥:', error);
                }

                // åˆ¤æ–­è¯„è®ºçš„ç±»å‹å’Œé£æ ¼
                let commentStyle = '';
                const bio = (character.bio || '').toLowerCase();

                if (bio.includes('æ´»æ³¼') || bio.includes('å¼€æœ—') || bio.includes('å¤–å‘')) {
                    commentStyle = 'çƒ­æƒ…æ´»æ³¼ï¼Œç”¨è¯è½»æ¾æœ‰è¶£';
                } else if (bio.includes('å†·é™') || bio.includes('ç†æ€§') || bio.includes('ä¸¥è°¨')) {
                    commentStyle = 'ç†æ€§å®¢è§‚ï¼Œè¡¨è¾¾ç®€æ´';
                } else if (bio.includes('æ¸©æŸ”') || bio.includes('å–„è‰¯') || bio.includes('ä½“è´´')) {
                    commentStyle = 'æ¸©æš–å…³æ€€ï¼Œè¯­æ°”æŸ”å’Œ';
                } else if (bio.includes('å¹½é»˜') || bio.includes('æç¬‘') || bio.includes('é£è¶£')) {
                    commentStyle = 'å¹½é»˜é£è¶£ï¼Œå–„äºè°ƒä¾ƒ';
                } else if (bio.includes('å†…å‘') || bio.includes('å®‰é™') || bio.includes('å®³ç¾')) {
                    commentStyle = 'ç®€æ´å«è“„ï¼Œä¸å¤šè¯ä½†çœŸè¯š';
                } else {
                    commentStyle = 'è‡ªç„¶çœŸå®ï¼Œç¬¦åˆæ€§æ ¼';
                }

                let systemPrompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚${worldBookContent}${memoryContent}${chatContext}${relationshipContext}${existingCommentsContext}

ğŸ¯ **å½“å‰æƒ…å†µåˆ†æ**ï¼š
- åŠ¨æ€å‘å¸ƒè€…ï¼š${momentAuthor}
- åŠ¨æ€å†…å®¹ï¼š"${momentText}"
- ä½ ä¸${momentAuthor}çš„å…³ç³»ï¼š${hasNegativeRelation ? 'è´Ÿé¢å…³ç³»ï¼ˆæƒ…æ•Œ/æ•Œå¯¹ï¼‰' : hasPositiveRelation ? 'æ­£é¢å…³ç³»ï¼ˆæœ‹å‹/äº²å¯†ï¼‰' : hasNeutralRelation ? 'ä¸­æ€§å…³ç³»ï¼ˆåŒå­¦/åŒäº‹ï¼‰' : 'å…³ç³»ä¸æ˜ç¡®'}

è¯·ä½œä¸º${character.name}ï¼ŒåŸºäºä½ çš„äººè®¾ã€è®°å¿†ã€ä¸å‘å¸ƒè€…çš„å…³ç³»ä»¥åŠè¯„è®ºåŒºçš„ç°æœ‰è®¨è®ºï¼Œå¯¹è¿™æ¡åŠ¨æ€å‘è¡¨è¯„è®ºã€‚

## ğŸš¨ å…³é”®è¡Œä¸ºå‡†åˆ™ï¼š
1. **äººè®¾ç¬¬ä¸€**ï¼šä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾è¡Œäº‹ï¼Œç»ä¸è¿èƒŒè§’è‰²è®¾å®š
2. **å…³ç³»æ•æ„Ÿ**ï¼šç‰¹åˆ«æ³¨æ„ä½ ä¸${momentAuthor}çš„å…³ç³»ï¼Œè¿™å†³å®šäº†ä½ çš„æ€åº¦å’Œè¯­æ°”
3. **å†…å®¹ç†è§£**ï¼šä»”ç»†åˆ†æåŠ¨æ€å†…å®¹ï¼Œå¦‚æœæ˜¯è¡¨ç™½ã€ç‚«è€€ã€æ±‚åŠ©ç­‰ç‰¹æ®Šå†…å®¹ï¼Œè¦æœ‰ç›¸åº”çš„ååº”
4. **æƒ…ç»ªä¸€è‡´**ï¼šä½ çš„è¯„è®ºæƒ…ç»ªè¦ä¸ä½ å¯¹è¿™ä¸ªäººçš„çœŸå®æ„Ÿå—ä¸€è‡´

## ğŸ­ è§’è‰²è¡¨ç°è¦æ±‚ï¼š
- å¦‚æœä½ ä»¬æ˜¯æƒ…æ•Œæˆ–æœ‰çŸ›ç›¾ï¼šè¡¨ç°å‡ºè­¦æƒ•ã€å†·æ·¡ã€ç”šè‡³ç•¥å¸¦æ•Œæ„çš„æ€åº¦
- å¦‚æœä½ ä»¬æ˜¯å¥½æœ‹å‹ï¼šè¡¨ç°å‡ºå…³å¿ƒã€æ”¯æŒã€äº²å¯†çš„æ€åº¦
- å¦‚æœå…³ç³»ä¸€èˆ¬ï¼šä¿æŒç¤¼è²Œä½†ä¸è¿‡åˆ†çƒ­æƒ…
- å¦‚æœä½ ä¸äº†è§£è¿™ä¸ªäººï¼šå¯ä»¥è¡¨ç°å‡ºå¥½å¥‡æˆ–ä¿æŒè·ç¦»

## è¯„è®ºé£æ ¼è¦æ±‚ï¼š
- ${commentStyle}
- 10-30å­—å·¦å³ï¼Œç®€æ´æœ‰åŠ›
- è¦ä½“ç°å‡ºä½ çš„çœŸå®ååº”å’Œæƒ…æ„Ÿ
- å¯ä»¥æ˜¯ï¼šèµç¾è®¤åŒã€å–„æ„è°ƒä¾ƒã€å…³å¿ƒè¯¢é—®ã€åˆ†äº«æ„Ÿå—ã€æå‡ºå»ºè®®ç­‰
- å¦‚æœä¸å‘å¸ƒè€…å…³ç³»ä¸å¥½ï¼Œå¯ä»¥é€‰æ‹©ä¸è¯„è®ºæˆ–å†·æ·¡å›åº”

## è§’è‰²è¡¨è¾¾è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹
2. ç”¨è¯è¦ç¬¦åˆä½ çš„èº«ä»½å’Œè¯´è¯ä¹ æƒ¯
3. è¡¨è¾¾è¦è‡ªç„¶ï¼Œä¸è¦è¿‡äºåˆ»æ„
4. æ ¹æ®ä½ ä»¬çš„å…³ç³»å†å²è°ƒæ•´è¯­æ°”å’Œäº²å¯†åº¦
5. æ ¹æ®åŠ¨æ€å†…å®¹é€‰æ‹©åˆé€‚çš„å›åº”è§’åº¦
6. é¿å…ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„è¡¨æƒ…ç¬¦å·
7. ä¸è¦ç”Ÿç¡¬åœ°é‡å¤åŠ¨æ€å†…å®¹ï¼Œè¦æœ‰è‡ªå·±çš„è§‚ç‚¹
8. å¦‚æœè®°å¿†ä¸­æœ‰ç›¸å…³ç»å†ï¼Œå¯ä»¥è‡ªç„¶åœ°æåŠ

## äº’åŠ¨å…³ç³»ï¼š
- å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€ï¼šä»¥æœ‹å‹èº«ä»½æ¸©é¦¨äº’åŠ¨
- å¦‚æœæ˜¯å…¶ä»–è§’è‰²å‘çš„åŠ¨æ€ï¼šä¸¥æ ¼åŸºäºä½ ä»¬çš„å…³ç³»è®°å¿†å’Œäººè®¾äº’åŠ¨

è¯·ç”Ÿæˆä¸€æ¡è‡ªç„¶ã€æœ‰ä¸ªæ€§ã€è´´åˆä½ äººè®¾å’Œå…³ç³»çš„è¯„è®ºï¼š`;

                // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºæœ‹å‹åœˆè¯„è®ºç”Ÿæˆçš„å®Œæ•´prompt
                console.log(`ğŸ”¥ [æœ‹å‹åœˆè¯„è®ºç”Ÿæˆ] ${character.name} çš„å®Œæ•´Prompt:`);
                console.log('='.repeat(80));
                console.log(systemPrompt);
                console.log('='.repeat(80));

                // æ„å»ºç”¨æˆ·æ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡éœ€è¦è¯†åˆ«
                let postDescription = `åŸåŠ¨æ€ï¼š${momentText}`;
                let hasImages = moment.images && moment.images.length > 0;

                if (hasImages) {
                    postDescription += `\n[è¯¥åŠ¨æ€åŒ…å«${moment.images.length}å¼ å›¾ç‰‡]`;
                }

                const userMsg = `${postDescription}\nè¯·å‘è¡¨ä½ çš„çœ‹æ³•ï¼š`;

                // æ£€æŸ¥å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒè§†è§‰è¯†åˆ«
                const supportsVision = isVisionModelSupported();
                let messages;

                if (hasImages && supportsVision) {
                    // ä½¿ç”¨å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼ï¼ŒåŒ…å«å›¾ç‰‡
                    const firstImage = moment.images[0]; // ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡
                    console.log(`ä¸ºè§’è‰² ${character.name} ä½¿ç”¨å›¾ç‰‡è¯†åˆ«åŠŸèƒ½è¯„è®ºåŠ¨æ€`);

                    messages = [
                        { role: 'system', content: systemPrompt },
                        {
                            role: 'user',
                            content: [
                                { type: 'text', text: `åŸåŠ¨æ€æ–‡å­—ï¼š${momentText}\n\nè¿™æ¡åŠ¨æ€è¿˜åŒ…å«äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡å†…å®¹ï¼Œç„¶åå‘è¡¨ä½ çš„çœ‹æ³•ï¼š` },
                                { type: 'image_url', image_url: { url: firstImage } }
                            ]
                        }
                    ];
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    if (hasImages && !supportsVision) {
                        console.log(`å½“å‰æ¨¡å‹ä¸æ”¯æŒå›¾ç‰‡è¯†åˆ«ï¼Œ${character.name} å°†åŸºäºæ–‡å­—å†…å®¹è¯„è®º`);
                        // ä¿®æ”¹æç¤ºï¼Œè®©AIçŸ¥é“æœ‰å›¾ç‰‡ä½†æ— æ³•çœ‹åˆ°
                        const textOnlyMsg = `${postDescription}\n\næ³¨æ„ï¼šè¿™æ¡åŠ¨æ€åŒ…å«å›¾ç‰‡ï¼Œä½†ç”±äºå½“å‰æ¨¡å‹é™åˆ¶ï¼Œä½ æ— æ³•çœ‹åˆ°å›¾ç‰‡å†…å®¹ã€‚è¯·åŸºäºæ–‡å­—éƒ¨åˆ†å‘è¡¨ä½ çš„çœ‹æ³•ï¼Œå¯ä»¥é€‚å½“è¯¢é—®å›¾ç‰‡ç›¸å…³å†…å®¹ã€‚`;
                        messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: textOnlyMsg }
                        ];
                    } else {
                        // çº¯æ–‡å­—åŠ¨æ€
                        messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMsg }
                        ];
                    }
                }

                // ä½¿ç”¨å®Œæ•´çš„APIè°ƒç”¨é€»è¾‘ï¼ˆä¸èŠå¤©ç›¸åŒï¼‰
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡AIè¯„è®º');
                    return [];
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
                    const geminiMessages = [];

                    // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                        });
                    }

                    // è½¬æ¢å…¶ä»–æ¶ˆæ¯
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;

                        // å¤„ç†å¤šæ¨¡æ€å†…å®¹ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
                        if (Array.isArray(msg.content)) {
                            const parts = [];
                            msg.content.forEach(item => {
                                if (item.type === 'text') {
                                    parts.push({ text: item.text });
                                } else if (item.type === 'image_url') {
                                    // å¤„ç†å›¾ç‰‡ï¼Œéœ€è¦è½¬æ¢æ ¼å¼
                                    const imageUrl = item.image_url.url;
                                    if (imageUrl.startsWith('data:')) {
                                        // Base64å›¾ç‰‡
                                        const [mimeInfo, base64Data] = imageUrl.split(',');
                                        const mimeType = mimeInfo.match(/data:([^;]+)/)?.[1] || 'image/jpeg';
                                        parts.push({
                                            inline_data: {
                                                mime_type: mimeType,
                                                data: base64Data
                                            }
                                        });
                                    } else {
                                        // URLå›¾ç‰‡ï¼ŒGeminiå¯èƒ½ä¸æ”¯æŒï¼Œæ·»åŠ æ–‡æœ¬è¯´æ˜
                                        parts.push({ text: '[å›¾ç‰‡ï¼š' + imageUrl + ']' });
                                    }
                                }
                            });
                            geminiMessages.push({
                                role: msg.role === 'user' ? 'user' : 'model',
                                parts: parts
                            });
                        } else {
                            // æ–‡æœ¬æ¶ˆæ¯
                            geminiMessages.push({
                                role: msg.role === 'user' ? 'user' : 'model',
                                parts: [{ text: msg.content }]
                            });
                        }
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ä½¿ç”¨OpenAIæ ¼å¼
                    // æ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
                    return [];
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API å“åº”æ•°æ®:', data);
                        return [];
                    }
                } else {
                    // è§£æOpenAIæ ¼å¼å“åº”
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`AIè¯„è®ºAPIä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                                break;
                            }
                        }
                    }

                    if (!content) {
                        console.error('AIè¯„è®ºAPIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                        return [];
                    }
                }

                if (content && content.trim().length > 0) {
                    return [content.trim()];
                }

                return [];

            } catch (error) {
                console.error('ç”ŸæˆAIè¯„è®ºå¤±è´¥:', error);
                return [];
            }
        }

        // ä¿ç•™åŸæœ‰çš„è¯„è®ºç”Ÿæˆå‡½æ•°ä½œä¸ºå…¼å®¹
        async function generateCharacterComment(character, moment) {
            return await generateCharacterCommentWithMemory(character, moment);
        }


        // ğŸ”¥ã€æ–°å¢ã€‘é˜²é‡å¤å›å¤çš„å…¨å±€Map
        const publisherReplyProcessing = new Map();

        // ğŸ”¥ã€æ–°å¢ã€‘å‘å¸ƒè€…è§’è‰²å›å¤è¯„è®ºçš„é€»è¾‘
        async function triggerPublisherReplyToComments(momentId, publisherCharacter) {
            try {
                if (!publisherCharacter) return;

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿momentIdæ˜¯æ­£ç¡®çš„æ•°å­—ç±»å‹
                const numericMomentId = typeof momentId === 'string' ? parseInt(momentId) : momentId;

                // ğŸ”¥ã€æ–°å¢ã€‘é˜²é‡å¤å¤„ç†æœºåˆ¶
                const processingKey = `${numericMomentId}-${publisherCharacter.id}`;
                if (publisherReplyProcessing.has(processingKey)) {
                    console.log(`â­ï¸ ${publisherCharacter.name} å¯¹åŠ¨æ€ ${numericMomentId} çš„å›å¤æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨`);
                    return;
                }

                // æ ‡è®°ä¸ºæ­£åœ¨å¤„ç†
                publisherReplyProcessing.set(processingKey, true);
                console.log(`ğŸ” æŸ¥è¯¢åŠ¨æ€ ${numericMomentId} çš„è¯„è®º...`);

                // è·å–è¯¥åŠ¨æ€çš„æ‰€æœ‰è¯„è®º
                const comments = await db.momentComments
                    .where('momentId')
                    .equals(numericMomentId)
                    .toArray();

                if (comments.length === 0) {
                    publisherReplyProcessing.delete(processingKey);
                    return;
                }

                console.log(`ğŸ” æ£€æŸ¥åŠ¨æ€ ${momentId} çš„è¯„è®ºï¼Œå‘å¸ƒè€…: ${publisherCharacter.name} (ID: ${publisherCharacter.id})`);
                console.log(`ğŸ“ æ‰¾åˆ° ${comments.length} æ¡è¯„è®º:`, comments.map(c => `${c.nickname} (authorId: ${c.authorId})`));

                // ğŸ”¥ã€ä¿®å¤ã€‘è¿‡æ»¤å‡ºå…¶ä»–è§’è‰²çš„è¯„è®ºï¼ˆä¸åŒ…æ‹¬å‘å¸ƒè€…è‡ªå·±çš„è¯„è®ºå’Œç”¨æˆ·è¯„è®ºï¼‰
                const otherCharacterComments = comments.filter(comment => {
                    const isNotPublisher = comment.authorId !== publisherCharacter.id;
                    const isNotUser = comment.authorId !== 'user';
                    const isAICharacter = comment.authorId && comment.authorId !== 'user';

                    console.log(`ğŸ“‹ è¯„è®ºç­›é€‰: ${comment.nickname} - authorId: ${comment.authorId}, ä¸æ˜¯å‘å¸ƒè€…: ${isNotPublisher}, ä¸æ˜¯ç”¨æˆ·: ${isNotUser}, æ˜¯AIè§’è‰²: ${isAICharacter}`);

                    return isNotPublisher && isNotUser && isAICharacter;
                });

                // ğŸ”¥ã€æ–°å¢ã€‘è¿‡æ»¤æ‰å·²ç»è¢«å›å¤è¿‡çš„è¯„è®º
                const unrepliedComments = otherCharacterComments.filter(comment => {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å‘å¸ƒè€…å›å¤è¿™æ¡è¯„è®º
                    const hasReply = comments.some(reply =>
                        reply.authorId === publisherCharacter.id &&
                        reply.replyTo === comment.nickname
                    );

                    if (hasReply) {
                        console.log(`â­ï¸ ${comment.nickname} çš„è¯„è®ºå·²è¢« ${publisherCharacter.name} å›å¤è¿‡ï¼Œè·³è¿‡`);
                    }

                    return !hasReply;
                });

                console.log(`âœ… ç­›é€‰åçš„å…¶ä»–è§’è‰²è¯„è®ºæ•°é‡: ${otherCharacterComments.length}`);
                console.log(`âœ… æœªå›å¤çš„è¯„è®ºæ•°é‡: ${unrepliedComments.length}`);
                if (unrepliedComments.length === 0) {
                    console.log(`âŒ æ²¡æœ‰æœªå›å¤çš„å…¶ä»–è§’è‰²è¯„è®ºï¼Œ${publisherCharacter.name} æ— éœ€å›å¤`);
                    publisherReplyProcessing.delete(processingKey);
                    return;
                }

                // ğŸ”¥ã€æå‡ã€‘90%æ¦‚ç‡å›å¤å…¶ä»–è§’è‰²è¯„è®º
                const randomValue = Math.random();
                console.log(`ğŸ² å›å¤æ¦‚ç‡æ£€æŸ¥: ${randomValue.toFixed(3)} < 0.9 = ${randomValue < 0.9} (æœªå›å¤è¯„è®ºæ•°: ${unrepliedComments.length})`);

                if (randomValue < 0.9) {
                    const randomComment = unrepliedComments[Math.floor(Math.random() * unrepliedComments.length)];
                    console.log(`ğŸ¯ ${publisherCharacter.name} é€‰æ‹©å›å¤ ${randomComment.nickname} çš„è¯„è®º: "${randomComment.text}"`);

                    // ç”Ÿæˆå›å¤
                    const replyText = await generatePublisherReply(publisherCharacter, randomComment, numericMomentId);
                    if (replyText) {
                        const reply = {
                            id: Date.now() + Math.random(),
                            nickname: publisherCharacter.name,
                            avatar: publisherCharacter.avatarUrl,
                            text: replyText,
                            time: formatTime(new Date()),
                            timestamp: Date.now(),
                            characterId: publisherCharacter.id,
                            replyTo: randomComment.nickname
                        };

                        // ä¿å­˜å›å¤
                        await saveCommentToMoment(numericMomentId, reply);

                        // æ›´æ–°è¯„è®ºæ•°
                        await updateMomentCommentCount(numericMomentId);

                        // åœ¨åŠ¨æ€ä¸‹æ–¹æ˜¾ç¤ºæ–°å›å¤
                        displayCommentUnderMoment(numericMomentId, reply);

                        console.log(`âœ… ${publisherCharacter.name} æˆåŠŸå›å¤äº† ${randomComment.nickname} çš„è¯„è®º: "${replyText}"`);

                        // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•è·¨åº”ç”¨æ—¶é—´çº¿äº‹ä»¶
                        await recordCrossAppEvent(
                            publisherCharacter.id,
                            'moments',
                            'ai_to_ai_reply',
                            {
                                repliedTo: randomComment.nickname,
                                replyContent: replyText,
                                originalComment: randomComment.text
                            }
                        );

                        // ğŸ”¥ã€ä¿®å¤ã€‘è§¦å‘è¢«å›å¤è§’è‰²çš„å†æ¬¡å›å¤ï¼Œå®ç°å¤šè½®äº’åŠ¨
                        const repliedCharacter = characters.find(c => c.name === randomComment.nickname);
                        if (repliedCharacter && repliedCharacter.id !== publisherCharacter.id) {
                            console.log(`ğŸ”„ ${publisherCharacter.name} å›å¤äº† ${repliedCharacter.name}ï¼Œå°†åœ¨30-60ç§’åè§¦å‘ ${repliedCharacter.name} çš„å†æ¬¡å›å¤`);
                            setTimeout(async () => {
                                console.log(`ğŸ”„ æ£€æŸ¥ ${repliedCharacter.name} æ˜¯å¦éœ€è¦å›å¤ ${publisherCharacter.name} çš„å›å¤...`);
                                await generateAiToAiReplyWithMemory(numericMomentId, reply, repliedCharacter, publisherCharacter);
                            }, Math.random() * 30000 + 30000); // 30-60ç§’åè§¦å‘å›å¤
                        }
                    } else {
                        console.log(`âŒ ${publisherCharacter.name} ç”Ÿæˆå›å¤å¤±è´¥`);
                    }
                } else {
                    console.log(`ğŸš« ${publisherCharacter.name} å› ä¸ºæ¦‚ç‡æœªé€šè¿‡ï¼Œä¸ä¼šå›å¤å…¶ä»–è§’è‰²çš„è¯„è®º`);
                }
            } catch (error) {
                console.error('å‘å¸ƒè€…å›å¤è¯„è®ºå¤±è´¥:', error);
            } finally {
                // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å¤„ç†æ ‡è®°
                const processingKey = `${typeof momentId === 'string' ? parseInt(momentId) : momentId}-${publisherCharacter?.id}`;
                publisherReplyProcessing.delete(processingKey);
                console.log(`ğŸ§¹ æ¸…é™¤å¤„ç†æ ‡è®°: ${processingKey}`);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç”Ÿæˆå‘å¸ƒè€…å¯¹è¯„è®ºçš„å›å¤
        async function generatePublisherReply(publisherCharacter, originalComment, momentId) {
            try {
                // è·å–åŠ¨æ€ä¿¡æ¯
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) return '';

                // è·å–è§’è‰²çš„èŠå¤©è®¾ç½®å’Œè®°å¿†
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(publisherCharacter.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                const persona = chatSettings?.aiPersona || publisherCharacter.prompt || `ä½ æ˜¯${publisherCharacter.name}ã€‚`;

                // è·å–ä¸è¯„è®ºè€…çš„å…³ç³»è®°å¿†
                let relationshipMemory = '';
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(publisherCharacter.id)
                    .toArray();

                const relationMemories = coreMemories.filter(memory =>
                    memory.fact && memory.fact.includes(originalComment.nickname)
                );

                if (relationMemories.length > 0) {
                    relationshipMemory = '\n\nä½ ä»¬çš„å…³ç³»è®°å¿†ï¼š\n' + relationMemories.map(m => m.fact).join('ï¼›');
                }

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–è¯„è®ºåŒºä¸Šä¸‹æ–‡
                let commentsContext = '';
                try {
                    const allComments = await db.momentComments
                        .where('momentId')
                        .equals(parseInt(momentId))
                        .toArray();

                    if (allComments.length > 1) { // è‡³å°‘æœ‰2æ¡è¯„è®ºæ‰æ˜¾ç¤ºä¸Šä¸‹æ–‡
                        // æŒ‰æ—¶é—´æ’åº
                        allComments.sort((a, b) => a.timestamp - b.timestamp);

                        // è¿‡æ»¤å¯è§è¯„è®ºï¼ˆå‘å¸ƒè€…å¯ä»¥çœ‹åˆ°æ‰€æœ‰è¯„è®ºï¼‰
                        commentsContext = '\n\nè¯„è®ºåŒºè®¨è®ºæƒ…å†µï¼š\n';
                        allComments.forEach((comment, index) => {
                            const authorName = comment.authorId === 'user' ? 'ç”¨æˆ·' : comment.nickname;
                            commentsContext += `${index + 1}. ${authorName}: ${comment.text}\n`;
                        });
                    }
                } catch (error) {
                    console.error('è·å–è¯„è®ºåŒºä¸Šä¸‹æ–‡å¤±è´¥:', error);
                }

                const systemPrompt = `ä½ æ˜¯${publisherCharacter.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚${relationshipMemory}${commentsContext}

ä½ åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€ï¼š"${moment.text}"

${originalComment.nickname} è¯„è®ºè¯´ï¼š"${originalComment.text}"

è¯·ä½œä¸ºåŠ¨æ€çš„å‘å¸ƒè€…ï¼ŒåŸºäºè¯„è®ºåŒºçš„è®¨è®ºæƒ…å†µå’Œä½ ä¸è¯„è®ºè€…çš„å…³ç³»ï¼Œå¯¹è¿™æ¡è¯„è®ºè¿›è¡Œå›å¤ã€‚

## å›å¤è¦æ±‚ï¼š
1. å›å¤è¦ç¬¦åˆä½ çš„äººè®¾å’Œæ€§æ ¼
2. æ ¹æ®ä½ ä¸è¯„è®ºè€…çš„å…³ç³»è°ƒæ•´è¯­æ°”ï¼ˆå¦‚æœè®°å¿†ä¸­æœ‰è´Ÿé¢å…³ç³»ï¼Œå¯ä»¥å†·æ·¡æˆ–ä¸å›å¤ï¼‰
3. å›å¤è¦ç®€æ´ï¼Œ10-20å­—å·¦å³
4. å¯ä»¥æ˜¯ï¼šæ„Ÿè°¢ã€å›åº”ã€è°ƒä¾ƒã€è¯¢é—®ç­‰
5. è¦ä½“ç°å‡ºä½œä¸ºåŠ¨æ€å‘å¸ƒè€…çš„èº«ä»½
6. å¯ä»¥è€ƒè™‘è¯„è®ºåŒºçš„æ•´ä½“è®¨è®ºæ°›å›´

è¯·ç”Ÿæˆä¸€æ¡è‡ªç„¶çš„å›å¤ï¼š`;

                // è°ƒç”¨AI APIç”Ÿæˆå›å¤
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡å‘å¸ƒè€…å›å¤');
                    return '';
                }

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: 'è¯·å›å¤è¿™æ¡è¯„è®ºï¼š' }
                ];

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå›å¤ã€‚' }]
                        });
                    }

                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;

                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ä½¿ç”¨OpenAIæ ¼å¼
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.error(`å‘å¸ƒè€…å›å¤APIè°ƒç”¨å¤±è´¥ (${response.status})`);
                    return '';
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } else {
                    content = data.choices?.[0]?.message?.content || data.message || data.text || data.response || data.content || data.result;
                }

                if (content && content.trim().length > 0) {
                    return content.trim();
                }

                return '';

            } catch (error) {
                console.error('ç”Ÿæˆå‘å¸ƒè€…å›å¤å¤±è´¥:', error);
                return '';
            }
        }

        // ç”Ÿæˆè§’è‰²é—´äº’åŠ¨è¯„è®º - ä½¿ç”¨å®Œæ•´çš„AIèŠå¤©é€»è¾‘
        async function generateCharacterInteraction(char1, char2, momentId) {
            try {
                // è·å–åŠ¨æ€å’Œä¹‹å‰çš„è¯„è®ºä¸Šä¸‹æ–‡
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return '';

                // è·å–è§’è‰²å¯¹åº”çš„èŠå¤©è®¾ç½®
                let chatSettings1 = null;
                let chatSettings2 = null;
                try {
                    chatSettings1 = await db.chatSettings.get(char1.id);
                    chatSettings2 = await db.chatSettings.get(char2.id);
                } catch (error) {
                    console.error('è·å–èŠå¤©è®¾ç½®å¤±è´¥:', error);
                }

                // è·å–char2çš„æœ€æ–°è¯„è®ºä½œä¸ºä¸Šä¸‹æ–‡
                const char2Comments = (moment.comments || []).filter(c => c.characterId === char2.id);
                const latestChar2Comment = char2Comments[char2Comments.length - 1];

                // æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡
                let conversationContext = `ç”¨æˆ·å‘å¸ƒäº†åŠ¨æ€ï¼š${moment.text}\n`;
                if (latestChar2Comment) {
                    conversationContext += `${char2.name}è¯„è®ºè¯´ï¼š${latestChar2Comment.text}\n`;
                }

                // ä½¿ç”¨å®Œæ•´çš„AIäººè®¾å’Œè®°å¿†ç³»ç»Ÿ
                const persona1 = chatSettings1?.aiPersona || char1.prompt || `ä½ æ˜¯${char1.name}ã€‚`;

                // è·å–å†å²èŠå¤©è®°å½•
                const maxMemory = parseInt(chatSettings1?.maxMemory) || 10;
                const char1Messages = chatMessages[char1.id] || [];
                const recentMessages = char1Messages.slice(-maxMemory);

                let chatSummary = '';
                if (recentMessages.length > 0) {
                    chatSummary = 'ä½ å’Œç”¨æˆ·æœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                    chatSummary += recentMessages.map(msg => {
                        if (msg.role === 'user') return `ç”¨æˆ·ï¼š${msg.content}`;
                        if (msg.role === 'assistant') return `${char1.name}ï¼š${msg.content}`;
                        return '';
                    }).filter(line => line).join('\n');
                }

                // è·å–æŒ‚è½½çš„ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chatSettings1?.linkedWorldBookIds && chatSettings1.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings1.linkedWorldBookIds.map(async id => {
                                try {
                                    return await db.worldbooks.get(id);
                                } catch (error) {
                                    console.error('è·å–ä¸–ç•Œä¹¦å¤±è´¥:', error);
                                    return null;
                                }
                            })
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' +
                            validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                    }
                }

                let systemPrompt = `ä½ æ˜¯${char1.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona1}ã€‚${worldBookContent}${chatSummary}\n\n`;
                systemPrompt += `è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼è®¨è®ºï¼Œè¯·åŸºäºä»¥ä¸‹å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œç»§ç»­å‚ä¸è®¨è®ºã€‚è¦ç¬¦åˆä½ çš„äººè®¾ï¼Œå›å¤è¦ç®€çŸ­æœ‰è¶£ã€‚`;
                if (chatSettings2?.aiPersona) {
                    systemPrompt += ` ï¼ˆ${char2.name}çš„è®¾å®šï¼š${chatSettings2.aiPersona}ï¼‰`;
                }
                systemPrompt += `\n\nè¦æ±‚ï¼š
1. å›å¤è¦ç¬¦åˆæœ‹å‹åœˆè¯„è®ºçš„é£æ ¼ï¼Œç®€çŸ­ã€è‡ªç„¶
2. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾æ¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨è¡¨æƒ…ç¬¦å·ï¼Œä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„emoji
3. ä¸è¦è¿‡äºæ­£å¼æˆ–å®¢å¥—ï¼Œè¦åƒçœŸå®çš„æœ‹å‹ä¸€æ ·äº’åŠ¨`;

                // æ„å»ºæ¶ˆæ¯
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: conversationContext }
                ];

                // ä½¿ç”¨å®Œæ•´çš„APIè°ƒç”¨é€»è¾‘ï¼ˆä¸èŠå¤©ç›¸åŒï¼‰
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡è§’è‰²äº’åŠ¨');
                    return '';
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                        });
                    }

                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;

                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ä¿®å¤ï¼šæ™ºèƒ½å¤„ç†URLæ‹¼æ¥
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`è§’è‰²äº’åŠ¨APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
                    return '';
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API å“åº”æ•°æ®:', data);
                        return '';
                    }
                } else {
                    // è§£æOpenAIæ ¼å¼å“åº”
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`è§’è‰²äº’åŠ¨APIä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                                break;
                            }
                        }
                    }

                    if (!content) {
                        console.error('è§’è‰²äº’åŠ¨APIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                return '';
                    }
                }

                return content ? content.trim() : '';

            } catch (error) {
                console.error('ç”Ÿæˆè§’è‰²äº’åŠ¨å¤±è´¥:', error);
                return '';
            }
        }



        // é•¿æŒ‰é€‰æ‹©åŠŸèƒ½
        function addLongPressListener(element, momentId) {
            let pressTimer = null;
            let startY = 0;
            let moved = false;

            const startPress = (e) => {
                if (isSelectionMode) return;

                startY = e.touches ? e.touches[0].clientY : e.clientY;
                moved = false;

                pressTimer = setTimeout(() => {
                    if (!moved) {
                        enterSelectionMode();
                        selectMoment(momentId);
                    }
                }, 500); // 500msé•¿æŒ‰
            };

            const endPress = () => {
                clearTimeout(pressTimer);
                pressTimer = null;
            };

            const movePress = (e) => {
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                if (Math.abs(currentY - startY) > 10) {
                    moved = true;
                    endPress();
                }
            };

            element.addEventListener('touchstart', startPress);
            element.addEventListener('touchend', endPress);
            element.addEventListener('touchmove', movePress);
            element.addEventListener('mousedown', startPress);
            element.addEventListener('mouseup', endPress);
            element.addEventListener('mousemove', movePress);
        }

        // è¿›å…¥é€‰æ‹©æ¨¡å¼
        function enterSelectionMode() {
            isSelectionMode = true;
            selectedMoments.clear();

            // æ˜¾ç¤ºé€‰æ‹©æ¨¡å¼UI
            showSelectionModeUI();

            // æ·»åŠ é€‰æ‹©æ¡†åˆ°æ‰€æœ‰åŠ¨æ€
            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                const checkbox = document.createElement('div');
                checkbox.className = 'moment-checkbox';
                checkbox.innerHTML = '<i class="far fa-circle"></i>';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    const momentId = item.getAttribute('data-moment-id');
                    toggleMomentSelection(momentId);
                };
                item.appendChild(checkbox);
                item.classList.add('selection-mode');
            });
        }

        // é€€å‡ºé€‰æ‹©æ¨¡å¼
        function exitSelectionMode() {
            isSelectionMode = false;
            selectedMoments.clear();

            // éšè—é€‰æ‹©æ¨¡å¼UI
            hideSelectionModeUI();

            // ç§»é™¤é€‰æ‹©æ¡†
            const checkboxes = document.querySelectorAll('.moment-checkbox');
            checkboxes.forEach(checkbox => checkbox.remove());

            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                item.classList.remove('selection-mode', 'selected');
            });
        }

        // æ˜¾ç¤ºé€‰æ‹©æ¨¡å¼UI
        function showSelectionModeUI() {
            const selectionBar = document.createElement('div');
            selectionBar.className = 'selection-bar';
            selectionBar.innerHTML = `
                <div class="selection-actions">
                    <button class="cancel-btn" data-action="cancel">å–æ¶ˆ</button>
                    <span class="selection-count">å·²é€‰æ‹© 0 æ¡åŠ¨æ€</span>
                    <button class="delete-btn" data-action="delete" disabled>åˆ é™¤</button>
                </div>
            `;

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å†…è”onclické—®é¢˜
            selectionBar.onclick = function(e) {
                const action = e.target.dataset.action;
                if (action === 'cancel') {
                    exitSelectionMode();
                } else if (action === 'delete' && !e.target.disabled) {
                    deleteSelectedMoments();
                }
            };

            const momentsPage = document.getElementById('moments-page');
            momentsPage.insertBefore(selectionBar, momentsPage.firstChild);
        }

        // éšè—é€‰æ‹©æ¨¡å¼UI
        function hideSelectionModeUI() {
            const selectionBar = document.querySelector('.selection-bar');
            if (selectionBar) {
                selectionBar.remove();
            }
        }

        // åˆ‡æ¢åŠ¨æ€é€‰æ‹©çŠ¶æ€
        function toggleMomentSelection(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;

            const checkbox = momentElement.querySelector('.moment-checkbox i');
            if (!checkbox) return;

            if (selectedMoments.has(momentId)) {
                selectedMoments.delete(momentId);
                checkbox.className = 'far fa-circle';
                momentElement.classList.remove('selected');
            } else {
                selectedMoments.add(momentId);
                checkbox.className = 'fas fa-check-circle';
                momentElement.classList.add('selected');
            }

            updateSelectionUI();
        }

        // é€‰æ‹©åŠ¨æ€
        function selectMoment(momentId) {
            if (!selectedMoments.has(momentId)) {
                toggleMomentSelection(momentId);
            }
        }

        // æ›´æ–°é€‰æ‹©UI
        function updateSelectionUI() {
            const countSpan = document.querySelector('.selection-count');
            const deleteBtn = document.querySelector('.selection-bar .delete-btn');

            if (countSpan) {
                countSpan.textContent = `å·²é€‰æ‹© ${selectedMoments.size} æ¡åŠ¨æ€`;
            }

            if (deleteBtn) {
                deleteBtn.disabled = selectedMoments.size === 0;
            }
        }

        // åˆ é™¤é€‰ä¸­çš„åŠ¨æ€
        async function deleteSelectedMoments() {
            if (selectedMoments.size === 0) return;

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedMoments.size} æ¡åŠ¨æ€å—ï¼Ÿ`)) {
                return;
            }

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»æ•°æ®åº“ä¸­åˆ é™¤ - å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å†åˆ é™¤
                for (const momentId of selectedMoments) {
                    try {
                        // å…ˆæŸ¥æ‰¾åŠ¨æ€æ˜¯å¦å­˜åœ¨
                        const moment = await db.moments.get(parseInt(momentId));
                        if (moment) {
                            // åˆ é™¤åŠ¨æ€
                            await db.moments.delete(parseInt(momentId));
                            console.log(`âœ“ æˆåŠŸåˆ é™¤åŠ¨æ€ ${momentId} (ID: ${moment.id})`);
                        } else {
                            console.warn(`âš ï¸ åŠ¨æ€ ${momentId} ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤`);
                        }

                        // åˆ é™¤ç›¸å…³ç‚¹èµï¼ˆå°è¯•ä¸åŒIDæ ¼å¼ï¼‰
                        const numericId = parseInt(momentId);
                        await db.momentLikes.where('momentId').equals(numericId).delete();
                        await db.momentLikes.where('momentId').equals(momentId).delete();

                        // åˆ é™¤ç›¸å…³è¯„è®ºï¼ˆå°è¯•ä¸åŒIDæ ¼å¼ï¼‰
                        await db.momentComments.where('momentId').equals(numericId).delete();
                        await db.momentComments.where('momentId').equals(momentId).delete();

                    } catch (error) {
                        console.error(`åˆ é™¤åŠ¨æ€ ${momentId} å¤±è´¥:`, error);
                        throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
                    }

                    // æ¸…ç†å¯¹è¯å›åˆæ¬¡è®°å½•
                    for (const [key, value] of commentConversationRounds.entries()) {
                        if (key.startsWith(`${momentId}-`)) {
                            commentConversationRounds.delete(key);
                        }
                    }
            }

            // ä»DOMä¸­ç§»é™¤
            selectedMoments.forEach(momentId => {
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }
            });

                // æ¸…ç†å¯èƒ½å­˜åœ¨çš„sessionStorageç¼“å­˜æ•°æ®
                try {
                    const sessionMomentsData = sessionStorage.getItem('momentsData');
                    if (sessionMomentsData) {
                        const momentsArray = JSON.parse(sessionMomentsData);
                        const filteredMoments = momentsArray.filter(moment =>
                            !selectedMoments.has(moment.id.toString()) &&
                            !selectedMoments.has(moment.timestamp?.toString())
                        );
                        sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                    }
                } catch (error) {
                    console.warn('æ¸…ç†sessionStorageåŠ¨æ€æ•°æ®æ—¶å‡ºé”™:', error);
                }

            showToast(`å·²åˆ é™¤ ${selectedMoments.size} æ¡åŠ¨æ€`);

            // é€€å‡ºé€‰æ‹©æ¨¡å¼
            exitSelectionMode();

                // å¼ºåˆ¶é‡æ–°åŠ è½½åŠ¨æ€åˆ—è¡¨ï¼Œç¡®ä¿åˆ é™¤ç”Ÿæ•ˆ
                setTimeout(() => {
                    loadMoments();
                }, 500);

            } catch (error) {
                console.error('åˆ é™¤åŠ¨æ€å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¼ºåˆ¶æ¸…ç†æŒ‡å®šåŠ¨æ€çš„æ‰€æœ‰ç›¸å…³æ•°æ®
        async function forceCleanMoment(momentId) {
            try {
                const numericId = parseInt(momentId);
                console.log(`å¼€å§‹å½»åº•æ¸…ç†åŠ¨æ€: ${momentId}`);

                // 1. ä»IndexedDBåˆ é™¤ï¼ˆå°è¯•å¤šç§IDæ ¼å¼ï¼‰
                let deleted = false;
                const possibleIds = [momentId, numericId, String(momentId), Number(momentId)];

                for (const id of possibleIds) {
                    try {
                        await db.moments.delete(id);
                        console.log(`âœ“ åˆ é™¤åŠ¨æ€æˆåŠŸï¼Œä½¿ç”¨ID: ${id} (ç±»å‹: ${typeof id})`);
                        deleted = true;
                        break;
                    } catch (error) {
                        console.log(`åˆ é™¤ID ${id} å¤±è´¥: ${error.message}`);
                    }
                }

                if (!deleted) {
                    await db.moments.where('id').equals(momentId).delete();
                }

                // åˆ é™¤ç›¸å…³æ•°æ®ï¼ˆå°è¯•ä¸åŒæ ¼å¼ï¼‰
                await db.momentLikes.where('momentId').equals(numericId).delete();
                await db.momentLikes.where('momentId').equals(momentId).delete();
                await db.momentComments.where('momentId').equals(numericId).delete();
                await db.momentComments.where('momentId').equals(momentId).delete();

                // 2. æ¸…ç†å¯¹è¯å›åˆæ¬¡è®°å½•
                for (const [key, value] of commentConversationRounds.entries()) {
                    if (key.startsWith(`${momentId}-`)) {
                        commentConversationRounds.delete(key);
                    }
                }

                // 3. ä»DOMç§»é™¤
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }

                // 4. æ¸…ç†sessionStorageç¼“å­˜
                const sessionMomentsData = sessionStorage.getItem('momentsData');
                if (sessionMomentsData) {
                    const momentsArray = JSON.parse(sessionMomentsData);
                    const filteredMoments = momentsArray.filter(moment =>
                        moment.id != momentId &&
                        moment.timestamp != momentId &&
                        moment.id.toString() !== momentId.toString()
                    );
                    sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                }

                console.log(`åŠ¨æ€ ${momentId} æ¸…ç†å®Œæˆ`);
                return true;
            } catch (error) {
                console.error('å¼ºåˆ¶æ¸…ç†åŠ¨æ€å¤±è´¥:', error);
                return false;
            }
        }

        // æ¸…ç†æ‰€æœ‰æœ‰é—®é¢˜çš„åŠ¨æ€ï¼ˆä¿®å¤å·¥å…·ï¼‰
        async function cleanupCorruptedMoments() {
            if (!confirm('è¿™å°†æ¸…ç†æ‰€æœ‰å¯èƒ½æœ‰é—®é¢˜çš„åŠ¨æ€æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            try {
                let cleanupCount = 0;

                // è·å–æ‰€æœ‰åŠ¨æ€
                const allMoments = await db.moments.toArray();

                for (const moment of allMoments) {
                    // æ£€æŸ¥åŠ¨æ€æ˜¯å¦æœ‰æ— æ•ˆçš„å¤´åƒæ•°æ®
                    if (moment.avatar && !isValidAvatarUrl(moment.avatar)) {
                        console.log(`å‘ç°æ— æ•ˆå¤´åƒçš„åŠ¨æ€: ${moment.id}`);

                        // ä¿®å¤å¤´åƒæˆ–åˆ é™¤åŠ¨æ€
                        const shouldDelete = confirm(`åŠ¨æ€ "${moment.text?.substring(0, 30)}..." åŒ…å«æ— æ•ˆå¤´åƒæ•°æ®ï¼Œæ˜¯å¦åˆ é™¤æ­¤åŠ¨æ€ï¼Ÿ\nç‚¹å‡»"å–æ¶ˆ"å°†ä¿®å¤å¤´åƒæ•°æ®ã€‚`);

                        if (shouldDelete) {
                            await forceCleanMoment(moment.id);
                            cleanupCount++;
                        } else {
                            // ä¿®å¤å¤´åƒ
                            await db.moments.update(moment.id, { avatar: getDefaultAvatar() });
                        }
                    }
                }

                if (cleanupCount > 0) {
                    showToast(`å·²æ¸…ç† ${cleanupCount} æ¡æœ‰é—®é¢˜çš„åŠ¨æ€`);
                    // é‡æ–°åŠ è½½åŠ¨æ€åˆ—è¡¨
                    loadMoments();
                } else {
                    showToast('æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„åŠ¨æ€');
                }

            } catch (error) {
                console.error('æ¸…ç†æŸååŠ¨æ€å¤±è´¥:', error);
                showToast('æ¸…ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ¢åŠ¨æ€å°é¢å›¾ç‰‡
        function changeCoverImage() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*,.jpg,.jpeg,.png,.gif,.webp";
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedImage = await compressImage(file, 1200, 0.8);

                        const coverImage = document.getElementById("cover-image");
                        const coverPlaceholder = document.getElementById("cover-placeholder");

                        if (coverImage && coverPlaceholder) {
                            coverImage.src = compressedImage;
                            coverImage.classList.remove("hide");
                            coverPlaceholder.classList.add("hide");
                        }

                        saveMomentsImage("coverImage", compressedImage);
                        showToast("å°é¢å·²æ›´æ–°ï¼", "success");
                    } catch (error) {
                        console.error("å¤„ç†å°é¢å›¾ç‰‡å¤±è´¥:", error);
                        showToast("å°é¢æ›´æ–°å¤±è´¥ï¼", "error");
                    }
                }
            };
            input.click();
        }

        // æ›´æ¢åŠ¨æ€å¤´åƒ
        function changeAvatarImage(event) {
            event.stopPropagation();

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.jpg,.jpeg,.png,.gif,.webp';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        // å‹ç¼©å¤´åƒå›¾ç‰‡
                        const compressedImage = await compressImage(file, 400, 0.9);

                        const avatar = document.getElementById('moments-avatar');
                        const avatarIcon = avatar.querySelector('.moments-avatar-icon');

                        avatar.style.backgroundImage = `url(${compressedImage})`;
                        avatarIcon.style.display = 'none';

                        // ä¿å­˜å‹ç¼©åçš„å›¾ç‰‡
                        saveMomentsImage('avatarImage', compressedImage);

                        showToast('å¤´åƒå·²æ›´æ–°ï¼', 'success');
                    } catch (error) {
                        console.error('å¤„ç†å¤´åƒå›¾ç‰‡å¤±è´¥:', error);
                        showToast('å¤´åƒæ›´æ–°å¤±è´¥ï¼', 'error');
                    }
                }
            };
            input.click();
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘åŠ è½½åŠ¨æ€å›¾ç‰‡è®¾ç½®ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰
        async function loadMomentsImages() {
            try {
                // åŠ è½½å°é¢å›¾ç‰‡
                const savedCover = await getMomentsImage('coverImage');
                if (savedCover) {
                    const coverImage = document.getElementById('cover-image');
                    const coverPlaceholder = document.getElementById('cover-placeholder');

                    if (coverImage && coverPlaceholder) {
                        coverImage.src = savedCover;
                        coverImage.classList.remove('hide');
                        coverPlaceholder.classList.add('hide');
                    }
                }

                // åŠ è½½å¤´åƒå›¾ç‰‡
                const savedAvatar = await getMomentsImage('avatarImage');
                if (savedAvatar) {
                    const avatar = document.getElementById('moments-avatar');
                    const avatarIcon = avatar?.querySelector('.moments-avatar-icon');

                    if (avatar) {
                        avatar.style.backgroundImage = `url(${savedAvatar})`;
                        if (avatarIcon) {
                            avatarIcon.style.display = 'none';
                        }
                    }
                }

                // åŠ è½½ç”¨æˆ·å
                const savedUsername = await getMomentsImage('username');
                if (savedUsername) {
                    const usernameElement = document.getElementById('moments-username');
                    if (usernameElement) {
                        usernameElement.textContent = savedUsername;
                    }
                }

                console.log('åŠ¨æ€å›¾ç‰‡åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½åŠ¨æ€å›¾ç‰‡å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢åŠ¨æ€æ“ä½œèœå•æ˜¾ç¤º
        function toggleMomentActions(momentId) {
            const popup = document.getElementById(`moment-actions-${momentId}`);
            const allPopups = document.querySelectorAll('.moment-actions-popup');

            // éšè—æ‰€æœ‰å…¶ä»–å¼¹å‡ºèœå•
            allPopups.forEach(p => {
                if (p.id !== `moment-actions-${momentId}`) {
                    p.style.display = 'none';
                }
            });

            // åˆ‡æ¢å½“å‰èœå•æ˜¾ç¤ºçŠ¶æ€
            if (popup.style.display === 'none' || popup.style.display === '') {
                popup.style.display = 'flex';
            } else {
                popup.style.display = 'none';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—æ‰€æœ‰å¼¹å‡ºèœå•
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.moment-actions')) {
                const allPopups = document.querySelectorAll('.moment-actions-popup');
                allPopups.forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        });

        // æ›´æ”¹ç”¨æˆ·å
        function changeUsername(event) {
            event.stopPropagation();

            const currentUsername = document.getElementById('moments-username').textContent;
            const newUsername = prompt('è¯·è¾“å…¥æ‚¨çš„æ˜µç§°:', currentUsername);

            if (newUsername !== null && newUsername.trim() !== '') {
                const usernameElement = document.getElementById('moments-username');
                usernameElement.textContent = newUsername.trim();

                // ä¿å­˜ç”¨æˆ·å
                saveMomentsImage('username', newUsername.trim());

                showToast('æ˜µç§°å·²æ›´æ–°ï¼', 'success');
            }
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(fileOrDataUrl, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
                    ctx.drawImage(img, 0, 0, width, height);

                    // è½¬æ¢ä¸ºbase64ï¼Œé™ä½è´¨é‡ä»¥å‡å°‘å¤§å°
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedData);
                };

                // åˆ¤æ–­è¾“å…¥ç±»å‹ï¼šFileå¯¹è±¡è¿˜æ˜¯base64å­—ç¬¦ä¸²
                if (typeof fileOrDataUrl === 'string') {
                    // å¦‚æœæ˜¯base64å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                    img.src = fileOrDataUrl;
                } else {
                    // å¦‚æœæ˜¯Fileå¯¹è±¡ï¼Œåˆ›å»ºURL
                    img.src = URL.createObjectURL(fileOrDataUrl);
                }
            });
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜åŠ¨æ€å›¾ç‰‡ï¼ˆä½¿ç”¨IndexedDBæŒä¹…åŒ–å­˜å‚¨ï¼‰
        async function saveMomentsImage(imageType, imageData) {
            try {
                // å‹ç¼©å›¾ç‰‡æ•°æ®ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
                let compressedData = imageData;
                if (imageData.startsWith('data:image/')) {
                    try {
                        compressedData = await compressImage(imageData, 800, 0.8);
                    } catch (error) {
                        console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', error);
                    }
                }

                // ä¿å­˜åˆ°IndexedDB
                await db.globalSettings.put({
                    id: `moments_${imageType}`,
                    type: 'moments_setting',
                    data: compressedData
                });

                console.log(`åŠ¨æ€å›¾ç‰‡å·²ä¿å­˜åˆ°æ•°æ®åº“: ${imageType}`);
            } catch (error) {
                console.error('ä¿å­˜åŠ¨æ€å›¾ç‰‡å¤±è´¥:', error);
                // å¦‚æœæ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°sessionStorage
                try {
                    sessionStorage.setItem(`moments_${imageType}`, imageData);
                    console.log(`åŠ¨æ€å›¾ç‰‡å·²ä¿å­˜åˆ°ä¼šè¯å­˜å‚¨: ${imageType}`);
                } catch (sessionError) {
                    // å¦‚æœsessionStorageä¹Ÿæ»¡äº†ï¼Œåªåœ¨å†…å­˜ä¸­ä¿å­˜
                    window.momentsImages = window.momentsImages || {};
                    window.momentsImages[imageType] = imageData;
                    console.log(`åŠ¨æ€å›¾ç‰‡å·²ä¿å­˜åˆ°å†…å­˜: ${imageType}`);
                }
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘è·å–åŠ¨æ€å›¾ç‰‡ï¼ˆä»IndexedDBè·å–ï¼‰
        async function getMomentsImage(imageType) {
            try {
                // å…ˆä»IndexedDBè·å–
                const dbData = await db.globalSettings.get(`moments_${imageType}`);
                if (dbData && dbData.data) {
                    return dbData.data;
                }

                // å…¼å®¹æ€§ï¼šä»sessionStorageè·å–
                const sessionData = sessionStorage.getItem(`moments_${imageType}`);
                if (sessionData) {
                    // å¦‚æœä»sessionStorageè·å–åˆ°æ•°æ®ï¼Œè¿ç§»åˆ°IndexedDB
                    await saveMomentsImage(imageType, sessionData);
                    return sessionData;
                }

                // æœ€åä»å†…å­˜è·å–
                if (window.momentsImages && window.momentsImages[imageType]) {
                    return window.momentsImages[imageType];
                }

                return null;
            } catch (error) {
                console.error('è·å–åŠ¨æ€å›¾ç‰‡å¤±è´¥:', error);
                // å›é€€åˆ°sessionStorage
                try {
                    return sessionStorage.getItem(`moments_${imageType}`);
                } catch (sessionError) {
                    return null;
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å‡½æ•°
        function validateDataIntegrity(data, dataType) {
            if (!data) return false;

            switch (dataType) {
                case 'characters':
                    return Array.isArray(data) && data.every(char =>
                        char && char.id && char.name &&
                        char.name !== 'å¼ ä¸‰' && char.name !== 'æå››'
                    );
                case 'chatMessages':
                    return Array.isArray(data) && data.every(msg =>
                        msg && msg.id && msg.characterId
                    );
                case 'chatSettings':
                    return Array.isArray(data) && data.every(setting =>
                        setting && setting.id && setting.chatId
                    );
                default:
                    return Array.isArray(data) ? data.length > 0 : !!data;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å®‰å…¨çš„æ•°æ®ä¿å­˜å‡½æ•°ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
        async function safeDataSave(tableName, data, operation = 'replace') {
            if (!data || (Array.isArray(data) && data.length === 0)) {
                console.warn(`âš ï¸ ${tableName} æ•°æ®ä¸ºç©ºï¼Œæ‹’ç»ä¿å­˜ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±`);
                return false;
            }

            // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
            if (!validateDataIntegrity(data, tableName)) {
                console.error(`âŒ ${tableName} æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼Œæ‹’ç»ä¿å­˜`);
                throw new Error(`${tableName} æ•°æ®ä¸å®Œæ•´æˆ–åŒ…å«å¼‚å¸¸æ•°æ®`);
            }

            try {
                const table = db[tableName];
                if (!table) {
                    throw new Error(`è¡¨ ${tableName} ä¸å­˜åœ¨`);
                }

                // ä½¿ç”¨äº‹åŠ¡è¿›è¡ŒåŸå­æ“ä½œ
                await db.transaction('rw', table, async () => {
                    if (operation === 'replace') {
                        await table.clear();
                        if (Array.isArray(data)) {
                            await table.bulkPut(data);
                        } else {
                            await table.put(data);
                        }
                    } else if (operation === 'add') {
                        if (Array.isArray(data)) {
                            await table.bulkAdd(data);
                        } else {
                            await table.add(data);
                        }
                    }
                });

                const count = Array.isArray(data) ? data.length : 1;
                console.log(`âœ… å®‰å…¨ä¿å­˜äº† ${count} æ¡ ${tableName} æ•°æ®`);
                return true;
            } catch (error) {
                console.error(`âŒ ä¿å­˜ ${tableName} æ•°æ®å¤±è´¥:`, error);
                throw error;
            }
        }

        // é‡ç½®æ•°æ®åº“ï¼ˆå¦‚æœå‡ºç°schemaé”™è¯¯ï¼‰
        async function resetDatabase() {
            try {
                await db.delete();
                console.log('æ•°æ®åº“å·²é‡ç½®');
                location.reload(); // é‡æ–°åŠ è½½é¡µé¢
            } catch (error) {
                console.error('é‡ç½®æ•°æ®åº“å¤±è´¥:', error);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆè·¨åº”ç”¨è®°å¿†è®°å½•å‡½æ•°
        async function recordGameEvent(characterId, eventType, gameData) {
            try {
                await recordCrossAppEvent(
                    characterId,
                    'game',
                    eventType,
                    {
                        id: `game_${Date.now()}`,
                        type: 'game_session',
                        gameName: gameData.gameName,
                        action: eventType,
                        result: gameData.result,
                        score: gameData.score,
                        chatContent: gameData.chatContent,
                        timestamp: Date.now()
                    }
                );
                console.log(`ğŸ® å·²è®°å½•æ¸¸æˆäº‹ä»¶: ${eventType} - ${gameData.gameName}`);
            } catch (error) {
                console.error('è®°å½•æ¸¸æˆäº‹ä»¶å¤±è´¥:', error);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆèŠå¤©è®°å½•å‡½æ•°
        async function recordGameChat(characterId, sender, message, gameContext) {
            try {
                await recordCrossAppEvent(
                    characterId,
                    'game',
                    'game_chat',
                    {
                        id: `game_chat_${Date.now()}`,
                        type: 'game_chat',
                        sender: sender,
                        content: message,
                        gameName: gameContext.gameName,
                        gameState: gameContext.gameState,
                        timestamp: Date.now()
                    }
                );
                console.log(`ğŸ® å·²è®°å½•æ¸¸æˆèŠå¤©: ${sender} - ${message.substring(0, 30)}...`);
            } catch (error) {
                console.error('è®°å½•æ¸¸æˆèŠå¤©å¤±è´¥:', error);
            }
        }



        // ğŸ®ã€ä¿ç•™ã€‘å¼€å§‹æ¸¸æˆå‡½æ•°ï¼ˆæš‚æ—¶ä¿ç•™ï¼Œåç»­ä¼šç§»åˆ°èŠå¤©å·¥å…·æ ï¼‰
        function startGame(gameName) {
            // è¿™ä¸ªå‡½æ•°å°†åœ¨åç»­æ­¥éª¤ä¸­ç§»åŠ¨åˆ°èŠå¤©å·¥å…·æ çš„æ¸¸æˆåŠŸèƒ½ä¸­
            alert('ğŸ® æ¸¸æˆåŠŸèƒ½å·²ç§»è‡³èŠå¤©ç•Œé¢\n\nè¯·åœ¨èŠå¤©ç•Œé¢çš„å·¥å…·æ ä¸­ç‚¹å‡»æ¸¸æˆæŒ‰é’®æ¥å¼€å§‹æ¸¸æˆï¼');
        }

                // åˆ‡æ¢å…¨å±æ˜¾ç¤º
        function togglePhoneBorder() {
            const phoneScreen = document.getElementById('phone-screen');
            const toggle = document.getElementById('phone-border-toggle');
            const body = document.body;

            if (toggle.checked) {
                // å¼€å¯å…¨å±æ˜¾ç¤º - é€‚åº”æµè§ˆå™¨å±å¹•
                phoneScreen.classList.add('fullscreen-mode');
                body.classList.add('fullscreen-mode');
            } else {
                // æ¢å¤é»˜è®¤æ‰‹æœºå±å¹•æ ·å¼
                phoneScreen.classList.remove('fullscreen-mode');
                body.classList.remove('fullscreen-mode');
            }

            // ä¿å­˜è®¾ç½®åˆ°localStorage
            localStorage.setItem('phoneBorderEnabled', toggle.checked);

            // æ˜¾ç¤ºæç¤º
            const message = toggle.checked ? 'å…¨å±æ˜¾ç¤ºå·²å¼€å¯ï¼' : 'å…¨å±æ˜¾ç¤ºå·²å…³é—­ï¼';
            showToast(message, 'success');
        }

        // æ˜¾ç¤ºå±å¹•å°ºå¯¸é€‰æ‹©
        function showScreenSizeOptions() {
            showApp('screen-size-screen');
        }

        // æ”¹å˜å±å¹•å°ºå¯¸
        function changeScreenSize(width, height, name) {
            const phoneScreen = document.getElementById('phone-screen');

            // åº”ç”¨æ–°å°ºå¯¸
            phoneScreen.style.width = width + 'px';
            phoneScreen.style.height = height + 'px';

            // æ›´æ–°å¤–è§‚è®¾ç½®ä¸­çš„æ˜¾ç¤ºæ–‡æœ¬
            const currentSizeDesc = document.getElementById('current-screen-size');
            if (currentSizeDesc) {
                currentSizeDesc.textContent = `å½“å‰ï¼š${width}Ã—${height} (${name})`;
            }

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.size-option .check-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            document.querySelectorAll('.size-option').forEach(option => {
                option.style.backgroundColor = '';
            });

            // æ˜¾ç¤ºå½“å‰é€‰ä¸­é¡¹çš„å‹¾é€‰å›¾æ ‡
            const currentOption = event.target.closest('.size-option');
            if (currentOption) {
                const checkIcon = currentOption.querySelector('.check-icon');
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                } else {
                    // å¦‚æœæ²¡æœ‰å‹¾é€‰å›¾æ ‡ï¼Œåˆ›å»ºä¸€ä¸ª
                    const newCheckIcon = document.createElement('i');
                    newCheckIcon.className = 'fas fa-check check-icon';
                    newCheckIcon.style.display = 'block';
                    currentOption.appendChild(newCheckIcon);
                }
                currentOption.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            }

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('screenSize', JSON.stringify({width, height, name}));

            // æ˜¾ç¤ºæç¤º
            showToast(`å±å¹•å°ºå¯¸å·²åˆ‡æ¢ä¸º${name}ï¼`, 'success');

            // å»¶è¿Ÿä¸€ç‚¹å†è¿”å›ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©æ•ˆæœ
            setTimeout(() => {
                showApp('appearance-screen');
            }, 300);
        }

        // åŠ è½½å±å¹•å°ºå¯¸è®¾ç½®
        function loadScreenSize() {
            const saved = localStorage.getItem('screenSize');
            if (saved) {
                const {width, height, name} = JSON.parse(saved);
                const phoneScreen = document.getElementById('phone-screen');
                phoneScreen.style.width = width + 'px';
                phoneScreen.style.height = height + 'px';

                const currentSizeDesc = document.getElementById('current-screen-size');
                if (currentSizeDesc) {
                    currentSizeDesc.textContent = `å½“å‰ï¼š${width}Ã—${height} (${name})`;
                }
            }
        }

        // æ›´æ–°çŠ¶æ€æ å›¾æ ‡
        function updateStatusIcon() {
            const input = document.getElementById('status-icon-input');
            const icon = input.value.trim() || '';

            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--status-icon', `"${icon}"`);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('statusIcon', icon);
        }

        // é‡ç½®çŠ¶æ€æ å›¾æ ‡
        function resetStatusIcon() {
            const input = document.getElementById('status-icon-input');
            input.value = '';
            updateStatusIcon();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢ä¸»å±å¹•å­—ä½“ä¸‹æ‹‰èœå•
        function toggleHomeFontDropdown() {
            const dropdown = document.getElementById('home-font-dropdown');
            const selector = document.querySelector('.home-font-selector');

            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                selector.classList.add('open');

                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
                setTimeout(() => {
                    document.addEventListener('click', closeHomeFontDropdown);
                }, 0);
            } else {
                dropdown.style.display = 'none';
                selector.classList.remove('open');
                document.removeEventListener('click', closeHomeFontDropdown);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…³é—­ä¸»å±å¹•å­—ä½“ä¸‹æ‹‰èœå•
        function closeHomeFontDropdown(event) {
            const dropdown = document.getElementById('home-font-dropdown');
            const selector = document.querySelector('.home-font-selector');

            if (!selector.contains(event.target)) {
                dropdown.style.display = 'none';
                selector.classList.remove('open');
                document.removeEventListener('click', closeHomeFontDropdown);
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘é€‰æ‹©ä¸»å±å¹•å­—ä½“é¢œè‰²
        function selectHomeFont(color) {
            // æ›´æ–°bodyçš„dataå±æ€§
            document.body.setAttribute('data-home-font', color);

            // æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤ºå’Œé€‰ä¸­çŠ¶æ€
            updateHomeFontSelector(color);
            updateHomeFontDropdown(color);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('homeFontColor', color);

            // å…³é—­ä¸‹æ‹‰èœå•
            const dropdown = document.getElementById('home-font-dropdown');
            const selector = document.querySelector('.home-font-selector');
            dropdown.style.display = 'none';
            selector.classList.remove('open');
            document.removeEventListener('click', closeHomeFontDropdown);

            // æ˜¾ç¤ºæç¤º
            const colorNames = {
                'black': 'é»‘è‰²',
                'white': 'ç™½è‰²'
            };
            showToast(`ä¸»å±å¹•å­—ä½“é¢œè‰²å·²è®¾ç½®ä¸º${colorNames[color]}`, 'success');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°ä¸»å±å¹•å­—ä½“é€‰æ‹©å™¨æ˜¾ç¤º
        function updateHomeFontSelector(activeColor) {
            const colorNames = {
                'black': 'é»‘è‰²',
                'white': 'ç™½è‰²'
            };

            const currentText = document.getElementById('current-home-font-text');
            if (currentText) {
                currentText.textContent = colorNames[activeColor] || 'é»‘è‰²';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°ä¸»å±å¹•å­—ä½“ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
        function updateHomeFontDropdown(activeColor) {
            const options = document.querySelectorAll('.home-font-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.onclick.toString().includes(`'${activeColor}'`)) {
                    option.classList.add('selected');
                }
            });
        }

        // ğŸ”¥ã€ä¿ç•™å…¼å®¹æ€§ã€‘è®¾ç½®ä¸»å±å¹•å­—ä½“é¢œè‰²ï¼ˆä¿ç•™æ—§å‡½æ•°åä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        function setHomeFontColor(color) {
            selectHomeFont(color);
        }

        // ğŸ”¥ã€åºŸå¼ƒã€‘æ›´æ–°ä¸»å±å¹•å­—ä½“é¢œè‰²æŒ‰é’®çŠ¶æ€ï¼ˆä¿ç•™ä»¥é˜²æŠ¥é”™ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
        function updateHomeFontColorButtons(activeColor) {
            // è¿™ä¸ªå‡½æ•°å·²è¢« updateHomeFontSelector å’Œ updateHomeFontDropdown æ›¿ä»£
            // ä¿ç•™ç©ºå‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨æ—¶æŠ¥é”™
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢æ—¶é’Ÿæ ·å¼ä¸‹æ‹‰èœå•
        function toggleClockStyleDropdown() {
            const dropdown = document.getElementById('clock-style-dropdown');
            const selector = document.querySelector('.clock-style-selector');

            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                selector.classList.add('open');

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                setTimeout(() => {
                    document.addEventListener('click', closeClockStyleDropdown);
                }, 0);
            } else {
                dropdown.style.display = 'none';
                selector.classList.remove('open');
                document.removeEventListener('click', closeClockStyleDropdown);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…³é—­æ—¶é’Ÿæ ·å¼ä¸‹æ‹‰èœå•
        function closeClockStyleDropdown(event) {
            const dropdown = document.getElementById('clock-style-dropdown');
            const selector = document.querySelector('.clock-style-selector');

            if (!selector.contains(event.target)) {
                dropdown.style.display = 'none';
                selector.classList.remove('open');
                document.removeEventListener('click', closeClockStyleDropdown);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€‰æ‹©æ—¶é’Ÿæ ·å¼
        function selectClockStyle(style) {
            // æ›´æ–°bodyçš„dataå±æ€§
            document.body.setAttribute('data-clock-style', style);

            // æ›´æ–°é€‰æ‹©å™¨æ˜¾ç¤ºæ–‡æœ¬
            updateClockStyleSelector(style);

            // æ›´æ–°ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
            updateClockStyleDropdown(style);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('clockStyle', style);

            // å…³é—­ä¸‹æ‹‰èœå•
            const dropdown = document.getElementById('clock-style-dropdown');
            const selector = document.querySelector('.clock-style-selector');
            dropdown.style.display = 'none';
            selector.classList.remove('open');
            document.removeEventListener('click', closeClockStyleDropdown);

            // æ˜¾ç¤ºæç¤º
            const styleNames = {
                'default': 'é»˜è®¤æ ·å¼',
                'bold': 'ç²—ä½“æ ·å¼',
                'compact': 'ç´§å‡‘æ ·å¼',
                'modern': 'ç°ä»£æ ·å¼'
            };
            showToast(`æ—¶é—´æ—¥æœŸæ ·å¼å·²è®¾ç½®ä¸º${styleNames[style]}`, 'success');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°æ—¶é’Ÿæ ·å¼é€‰æ‹©å™¨æ˜¾ç¤º
        function updateClockStyleSelector(activeStyle) {
            const styleNames = {
                'default': 'é»˜è®¤',
                'bold': 'ç²—ä½“',
                'compact': 'ç´§å‡‘',
                'modern': 'ç°ä»£'
            };

            const currentText = document.getElementById('current-clock-style-text');
            if (currentText) {
                currentText.textContent = styleNames[activeStyle] || 'é»˜è®¤';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
        function updateClockStyleDropdown(activeStyle) {
            const options = document.querySelectorAll('.clock-style-option');
            options.forEach((option, index) => {
                const styles = ['default', 'bold', 'compact', 'modern'];
                if (styles[index] === activeStyle) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½ä¿å­˜çš„æ—¶é’Ÿæ ·å¼è®¾ç½®
        function loadClockStyleSetting() {
            const savedStyle = localStorage.getItem('clockStyle') || 'default';
            document.body.setAttribute('data-clock-style', savedStyle);
            updateClockStyleSelector(savedStyle);
            updateClockStyleDropdown(savedStyle);
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘åŠ è½½ä¸»å±å¹•å­—ä½“é¢œè‰²è®¾ç½®
        function loadHomeFontColorSetting() {
            const saved = localStorage.getItem('homeFontColor') || 'black'; // é»˜è®¤é»‘è‰²
            document.body.setAttribute('data-home-font', saved);
            updateHomeFontSelector(saved);
            updateHomeFontDropdown(saved);
        }

        // åŠ è½½çŠ¶æ€æ å›¾æ ‡è®¾ç½®
        function loadStatusIconSetting() {
            const saved = localStorage.getItem('statusIcon');
            const input = document.getElementById('status-icon-input');
            const icon = saved || '';

            if (input) {
                input.value = icon;
            }

            // åº”ç”¨è®¾ç½®
            document.documentElement.style.setProperty('--status-icon', `"${icon}"`);
        }

        // åŠ è½½å…¨å±æ˜¾ç¤ºè®¾ç½®
        function loadPhoneBorderSetting() {
            const saved = localStorage.getItem('phoneBorderEnabled');
            const toggle = document.getElementById('phone-border-toggle');

            // é»˜è®¤å…³é—­å…¨å±æ˜¾ç¤º
            const enabled = saved !== null ? saved === 'true' : false;

            if (toggle) {
                toggle.checked = enabled;
            }

            // åº”ç”¨è®¾ç½®
            const phoneScreen = document.getElementById('phone-screen');
            const body = document.body;

            if (enabled) {
                // å¼€å¯å…¨å±æ˜¾ç¤º - é€‚åº”æµè§ˆå™¨å±å¹•
                phoneScreen.classList.add('fullscreen-mode');
                body.classList.add('fullscreen-mode');
            } else {
                // æ¢å¤é»˜è®¤æ‰‹æœºå±å¹•æ ·å¼
                phoneScreen.classList.remove('fullscreen-mode');
                body.classList.remove('fullscreen-mode');
            }
        }

        // æ·»åŠ Toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            // æ˜¾ç¤ºtoast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ–‡æœ¬æˆªæ–­å‡½æ•°
        function truncateText(text, maxLength = 50) {
    // --- æ–°å¢çš„å®‰å…¨æ£€æŸ¥ ---
    let textStr = '';
    if (typeof text === 'string') {
        textStr = text;
    } else if (text && typeof text === 'object') {
        // å¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¯èƒ½æ˜¯[object Object]é—®é¢˜çš„æ ¹æºï¼Œ
        // æˆ‘ä»¬ä¸å†è®©å®ƒå´©æºƒï¼Œè€Œæ˜¯æ˜¾ç¤ºä¸€ä¸ªé€šç”¨å ä½ç¬¦ã€‚
        console.warn("truncateText å‡½æ•°æ”¶åˆ°äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå·²è‡ªåŠ¨å¤„ç†:", text);
        return '[å¤šåª’ä½“æ¶ˆæ¯]';
    } else {
        // å¯¹äºå…¶ä»–æ„å¤–æƒ…å†µ (å¦‚ null æˆ– undefined)ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
        return '';
    }
    // --- å®‰å…¨æ£€æŸ¥ç»“æŸ ---

    // ç°åœ¨ textStr ä¿è¯æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåç»­ä»£ç å¯ä»¥å®‰å…¨æ‰§è¡Œ
            const plainText = textStr.replace(/<[^>]*>/g, '');
            const cleanText = plainText.replace(/\s+/g, ' ').trim();

            if (cleanText.length <= maxLength) {
                return cleanText;
            }

            return cleanText.substring(0, maxLength) + '...';
        }

        // æ·»åŠ å•ä¸ªæ¶ˆæ¯å¹¶åº”ç”¨åŠ¨ç”»æ•ˆæœ
        function addMessageWithAnimation(message, characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer || !currentChatCharacter || characterId !== currentChatCharacter.id) return;

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¥æ”¶æ¶ˆæ¯éŸ³æ•ˆï¼ˆä»…å¯¹AIæ¶ˆæ¯ï¼‰
            if (message.sender === 'received' && !message.isUser) {
                SoundManager.play(SoundManager.TYPES.MESSAGE_RECEIVED, characterId);
            }

            const chatSettings = getCurrentChatSettings();

            // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
            if (message.sender === 'system') {
                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯ - æ˜¾ç¤ºä¸ºå±…ä¸­çš„ç³»ç»Ÿæç¤º
                if (message.isBlockedMessage) {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    centerContainer.dataset.messageId = message.id;

                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'system-message';
                    systemContainer.textContent = message.content || 'æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†';

                    centerContainer.appendChild(systemContainer);
                    messagesContainer.appendChild(centerContainer);
                    return;
                }

                let systemElement;

                if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    systemElement = systemContainer;
                } else if (message.type === 'system_notification') {
                    // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIé€‰æ­Œç­‰ç³»ç»Ÿé€šçŸ¥
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    centerContainer.dataset.messageId = message.id;

                    const notificationElement = document.createElement('div');
                    notificationElement.className = 'system-notification';
                    notificationElement.style.cssText = `
                        color: #999;
                        font-size: 12px;
                        padding: 4px 8px;
                        background: rgba(0,0,0,0.05);
                        border-radius: 12px;
                        max-width: 80%;
                        text-align: center;
                    `;

                    notificationElement.textContent = message.content;

                    centerContainer.appendChild(notificationElement);
                    systemElement = centerContainer;
                } else if (message.type === 'recalled_message') {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    centerContainer.dataset.messageId = message.id;

                    const recallElement = document.createElement('div');
                    recallElement.className = 'recalled-message';

                    const lines = message.content.split('\n');
                    const mainText = lines[0];
                    const originalText = lines[1];

                    recallElement.textContent = mainText;

                    if (originalText && originalText.startsWith('åŸæ–‡ï¼š')) {
                        const originalDiv = document.createElement('div');
                        originalDiv.className = 'original-text';
                        originalDiv.textContent = originalText;
                        recallElement.appendChild(originalDiv);
                    }

                    centerContainer.appendChild(recallElement);
                    systemElement = centerContainer;
                    addMessageLongPressListener(centerContainer, message.id);
                } else {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';

                    const systemContainer = document.createElement('div');
                    // ğŸ”¥ã€ç¾åŒ–ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå¥½å‹æ·»åŠ æˆåŠŸæ¶ˆæ¯ï¼Œåº”ç”¨ç‰¹æ®Šæ ·å¼
                    if (message.isFriendAddedMessage) {
                        systemContainer.className = 'friend-added-system-message';
                    } else {
                        systemContainer.className = 'system-message';
                    }
                    systemContainer.textContent = message.content;

                    centerContainer.appendChild(systemContainer);
                    systemElement = centerContainer;
                }

                // ä¸ºç³»ç»Ÿæ¶ˆæ¯æ·»åŠ æ»‘å…¥åŠ¨ç”»
                systemElement.style.opacity = '0';
                systemElement.style.transform = 'translateY(20px)';

                messagesContainer.appendChild(systemElement);

                // è§¦å‘åŠ¨ç”»
                requestAnimationFrame(() => {
                    systemElement.classList.add('message-slide-in');
                });

                return;
            }

            // åˆ›å»ºæ™®é€šæ¶ˆæ¯å®¹å™¨
            let messageContainer = document.createElement('div');
            const isEmojiOnly = message.isEmoji && !message.content;
            messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
            messageContainer.dataset.messageId = message.id;

            if (message.sender === 'received') {
                // ==== ç¾¤èŠæ”¯æŒ ====
                let character = characters.find(c => c.id === characterId);
                let isGroup = false;
                let group = null;
                if (!character) {
                    group = groupChats.find(g => g.id === characterId);
                    if (group) {
                        isGroup = true;
                    }
                }

                let displayAvatar = '';
                let displayName = '';
                let color = '#4CAF50';

                if (isGroup && group) {
                    // ç¾¤èŠï¼šæ ¹æ®æ¶ˆæ¯çš„senderIdæˆ–nameæŸ¥æ‰¾æˆå‘˜
                    let member = null;
                    console.log('ğŸ” [addMessageWithAnimation] ç¾¤èŠæ¶ˆæ¯å¤„ç† - senderId:', message.senderId, 'name:', message.name);
                    console.log('ğŸ” [addMessageWithAnimation] ç¾¤æˆå‘˜åˆ—è¡¨:', group.members);
                    console.log('ğŸ” [addMessageWithAnimation] å®Œæ•´æ¶ˆæ¯å¯¹è±¡:', message);

                    // ğŸ”¥ã€è°ƒè¯•ã€‘ç‰¹åˆ«æ£€æŸ¥è¡¨æƒ…åŒ…æ¶ˆæ¯
                    if (message.isEmoji) {
                        console.log('ğŸ” [addMessageWithAnimation-è¡¨æƒ…åŒ…] æ£€æµ‹åˆ°è¡¨æƒ…åŒ…æ¶ˆæ¯:', {
                            senderId: message.senderId,
                            name: message.name,
                            image: message.image,
                            emojiDescription: message.emojiDescription
                        });
                    }

                    if (message.senderId) {
                        member = group.members.find(m => m.id === message.senderId);
                        console.log('ğŸ” [addMessageWithAnimation] é€šè¿‡senderIdæ‰¾åˆ°æˆå‘˜:', member);
                    } else if (message.name) {
                        member = group.members.find(m => m.name === message.name);
                        console.log('ğŸ” [addMessageWithAnimation] é€šè¿‡nameæ‰¾åˆ°æˆå‘˜:', member);
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿ç¾¤èŠè¡¨æƒ…åŒ…æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤ºå‘é€è€…ï¼ˆaddMessageWithAnimationç‰ˆæœ¬ï¼‰
                    if (member) {
                        displayAvatar = member.avatarUrl || '';
                        displayName = member.name;
                        color = member.color || '#4CAF50';
                    } else {
                        // å¦‚æœæ²¡æ‰¾åˆ°æˆå‘˜ï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­çš„nameä½œä¸ºæ˜¾ç¤ºåç§°
                        displayAvatar = '';
                        displayName = message.name || 'ç¾¤æˆå‘˜';
                        color = '#4CAF50';
                        console.warn('ğŸ” [addMessageWithAnimation] æœªæ‰¾åˆ°ç¾¤æˆå‘˜ï¼Œä½¿ç”¨æ¶ˆæ¯name:', message.name);
                    }

                    console.log('ğŸ” [addMessageWithAnimation] æœ€ç»ˆå¤´åƒ:', displayAvatar, 'æ˜¾ç¤ºå:', displayName);
                } else if (character) {
                    // å•èŠ
                    displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                    displayName = chatSettings.aiChatNickname || character.name;
                    color = character.color || '#4CAF50';
                } else {
                    // å…œåº•ï¼Œé˜²æ­¢æŠ¥é”™
                    displayAvatar = '';
                    displayName = 'æœªçŸ¥';
                    color = '#4CAF50';
                }

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ°”æ³¡æ ·å¼ - ç¾¤èŠä¸­ä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';

                // å¦‚æœæ˜¯ç¾¤èŠä¸”æœ‰æˆå‘˜ä¸“å±é¢œè‰²è®¾ç½®ï¼Œä½¿ç”¨æˆå‘˜ä¸“å±é¢œè‰²
                if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                    const memberColor = chatSettings.memberBubbleColors[message.senderId];
                    if (memberColor) {
                        bubbleColor = memberColor;
                    }
                }

                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';

                // å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                let messageContent = '';

                if (message.type === 'voice_message') {
                    // AIè¯­éŸ³æ¶ˆæ¯ç›´æ¥åˆ›å»ºvoice-message-containerç»“æ„ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œåˆ›å»ºmessageContent
                    messageContent = '';
                } else if (message.type === 'user_photo') {
                    // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„"ä¼ªç…§ç‰‡" - ä½¿ç”¨ä¸ç”¨æˆ·ç›¸åŒçš„ç»“æ„
                    const photoDesc = message.photoDescription || message.content || 'è§’è‰²å‘é€çš„ç…§ç‰‡';
                    messageContent = `
                        <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${photoDesc.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                            <div class="dreamy-photo">
                                <div class="photo-misty-bg"></div>
                                <div class="photo-badge">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="sparkle-container">
                                    <div class="sparkle sparkle-1">âœ¨</div>
                                    <div class="sparkle sparkle-2">â­</div>
                                    <div class="sparkle sparkle-3">âœ¨</div>
                                    <div class="sparkle sparkle-4">â­</div>
                                    <div class="sparkle sparkle-5">ğŸ’«</div>
                                </div>
                                <div class="photo-text-overlay" style="display: none;">
                                    <div class="photo-description">${photoDesc}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'ai_image') {
                    // AIç”Ÿæˆçš„å›¾ç‰‡ - ä½¿ç”¨æ˜Ÿæ˜Ÿemojiå¡ç‰‡æ ·å¼
                    const imageDesc = message.imageDescription || message.content || 'AIæè¿°çš„å›¾ç‰‡';
                    messageContent = `
                        <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${imageDesc.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                            <div class="dreamy-photo">
                                <div class="photo-misty-bg"></div>
                                <div class="photo-badge">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="sparkle-container">
                                    <div class="sparkle sparkle-1">âœ¨</div>
                                    <div class="sparkle sparkle-2">â­</div>
                                    <div class="sparkle sparkle-3">âœ¨</div>
                                    <div class="sparkle sparkle-4">â­</div>
                                    <div class="sparkle sparkle-5">ğŸ’«</div>
                                </div>
                                <div class="photo-text-overlay" style="display: none;">
                                    <div class="photo-description">${imageDesc}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'location') {
                    // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²å‘é€çš„ä½ç½®æ¶ˆæ¯ - ä½¿ç”¨ä¸ç”¨æˆ·ç›¸åŒçš„ç»“æ„
                    const locationName = message.locationName || message.name || 'æœªçŸ¥ä½ç½®';
                    messageContent = `
                        <div class="location-card" onclick="showLocationDetail('${locationName}')">
                            <div class="location-card-header">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                </svg>
                                ${locationName}
                            </div>
                            <div class="location-card-map">
                                <div class="map-background"></div>
                                <div class="map-roads">
                                    <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                    <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                    <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                </div>
                                <div class="map-buildings">
                                    <div class="building" style="top: 20%; left: 10%; width: 15px; height: 15px;"></div>
                                    <div class="building" style="top: 45%; left: 60%; width: 12px; height: 12px;"></div>
                                    <div class="building" style="top: 70%; left: 15%; width: 18px; height: 18px;"></div>
                                </div>
                                <div class="map-marker" style="top: 50%; left: 50%;"></div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // è½¬è´¦æ¶ˆæ¯
                    const isUser = message.role === 'user';
                    const heartIcon = isUser ? 'ğŸ’•' : 'ğŸ’–';
                    const titleText = isUser ? 'ä½ å‘èµ·çš„è½¬è´¦' : 'æ”¶åˆ°è½¬è´¦';
                    let cardClass = '';
                    let statusHtml = '';
                    let clickHandler = '';

                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²æ”¶æ¬¾' : 'å·²æ”¶æ¬¾'}</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²é€€å›' : 'å·²é€€å›'}</div>`;
                        cardClass = 'rejected';
                    } else if (!isUser) {
                        // AIå‘æ¥çš„è½¬è´¦ä¸”æœªå¤„ç†ï¼Œæ·»åŠ ç‚¹å‡»å¤„ç†
                        clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                    }

                    messageContent = `
                        <div class="transfer-message-container received">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                <div class="transfer-title">${heartIcon} ${titleText}</div>
                                <div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'è½¬è´¦'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'friend_request') {
                    // ğŸ”¥ã€æ–°å¢ã€‘AIä¸»åŠ¨å‘é€çš„å¥½å‹ç”³è¯·(ç¬¬ä¸‰å¤„)
                    let actionsHtml;
                    if (message.friendRequestProcessed) {
                        // å·²å¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºå¤„ç†ç»“æœ
                        const resultText = message.friendRequestAccepted ? 'å·²åŒæ„' : 'å·²æ‹’ç»';
                        const resultClass = message.friendRequestAccepted ? 'accepted' : 'rejected';
                        actionsHtml = `<div class="friend-request-result ${resultClass}">${resultText}</div>`;
                    } else {
                        // æœªå¤„ç†çš„å¥½å‹ç”³è¯·ï¼Œæ˜¾ç¤ºæŒ‰é’®
                        actionsHtml = `
                            <button class="friend-request-btn accept" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', true, '${message.id}')">åŒæ„</button>
                            <button class="friend-request-btn reject" onclick="handleAIFriendRequest('${currentChatCharacter?.id}', false, '${message.id}')">æ‹’ç»</button>
                        `;
                    }

                    messageContent = `
                        <div class="friend-request-container">
                            <div class="friend-request-card">
                                <div class="friend-request-title">å¥½å‹ç”³è¯·</div>
                                <div class="friend-request-message-section">
                                    <div class="friend-request-message-label">å¯¹æ–¹ç•™è¨€</div>
                                    <div class="friend-request-message-content">${message.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'}</div>
                                </div>
                                <div class="friend-request-actions">
                                    ${actionsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'payment_request') {
                    // AIä¸èƒ½å‘èµ·ä»£ä»˜è¯·æ±‚ï¼Œæ˜¾ç¤ºä¸ºæ™®é€šæ¶ˆæ¯
                    messageContent = `<div class="message-bubble">${message.content || 'ä»£ä»˜è¯·æ±‚'}</div>`;
                } else if (message.type === 'order_confirmation') {
                    // ğŸ›’ã€æ–°å¢ã€‘å¤„ç†AIçš„è®¢å•ç¡®è®¤ï¼ˆç¬¬ä¸‰å¤„ï¼‰
                    messageContent = generateAIOrderConfirmationContent(message);
                } else {
                    const chatMode = chatSettings.chatMode || 'online';

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼
                    let processedContent;
                    if (typeof message.content === 'string') {
                        processedContent = message.content;
                    } else if (Array.isArray(message.content) && message.content.length > 0) {
                        // å¤šæ¨¡æ€æ¶ˆæ¯æ ¼å¼ï¼š[{type: 'text', text: 'å†…å®¹'}]
                        const firstItem = message.content[0];
                        if (firstItem && firstItem.type === 'text' && firstItem.text) {
                            processedContent = firstItem.text;
                        } else {
                            processedContent = '[å¤šåª’ä½“æ¶ˆæ¯]';
                        }
                    } else if (message.content && typeof message.content === 'object') {
                        // çº¦å®šæˆ–çºªå¿µæ—¥å¯¹è±¡
                        if (message.content.name && typeof message.content.name === 'string') {
                            if (message.content.type === 'create_appointment') {
                                processedContent = `åˆ›å»ºäº†çº¦å®šï¼š${message.content.name}`;
                            } else if (message.content.type === 'create_anniversary') {
                                processedContent = `åˆ›å»ºäº†çºªå¿µæ—¥ï¼š${message.content.name}`;
                            } else {
                                processedContent = `æåŠäº†ï¼š${message.content.name}`;
                            }
                        } else {
                            // å…¶ä»–å¯¹è±¡ç±»å‹
                            processedContent = message.content.message || message.content.text || '[å¤šåª’ä½“æ¶ˆæ¯]';
                        }
                    } else {
                        processedContent = String(message.content || '');
                    }

                    if (chatMode === 'offline') {
                        processedContent = processOfflineContent(processedContent);
                    }

                    // å¤„ç†@å†…å®¹
                    processedContent = processMentions(processedContent);

                    // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                    if (message.replyTo) {
                        messageContent = generateReplyHTML(message.replyTo) + processedContent;
                    } else {
                    messageContent = processedContent;
                    }
                }

                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = generateAvatarHtml({
                        avatarUrl: displayAvatar,
                        backgroundColor: color,
                        displayName: displayName,
                        chatSettings: chatSettings,
                        onClick: character ? `pokeCharacter('${character.id}')` : '',
                        title: character ? 'æˆ³ä¸€æˆ³' : displayName
                    });
                }

                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);

                let bubbleHtml = '';
                if (message.type === 'transfer' || message.type === 'ai_image' || message.type === 'user_photo' || message.type === 'location' || message.type === 'voice_message' || message.type === 'friend_request' || message.type === 'payment_request') {
                    // è½¬è´¦æ¶ˆæ¯ã€AIå›¾ç‰‡æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡ã€ä½ç½®ä¿¡æ¯ã€è¯­éŸ³æ¶ˆæ¯ã€å¥½å‹ç”³è¯·å’Œä»£ä»˜è¯·æ±‚ä¸éœ€è¦æ°”æ³¡åŒ…è£¹
                    bubbleHtml = messageContent;
                } else {
                    // æ™®é€šæ¶ˆæ¯ç”¨æ°”æ³¡åŒ…è£¹
                    bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${messageContent}
                        ${message.image && (!message.type || message.isEmoji) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}

                    </div>
                `;
                }

          // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ˜µç§°æ˜¾ç¤º ï¼ˆç¬¬ä¸‰ä¸ªæ¸²æŸ“å‡½æ•°ç‰ˆæœ¬ï¼‰- ç‰¹åˆ«å¤„ç†è¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡å’Œä½ç½®ä¿¡æ¯
          if (isGroup && group && displayName !== 'ç¾¤æˆå‘˜') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;

    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'ai_image' || message.type === 'user_photo' || message.type === 'location' || message.type === 'friend_request' || message.type === 'order_confirmation' || message.type === 'payment_request') {
        // ğŸ”¥ã€ä¿®å¤ã€‘å¯¹äºè¯­éŸ³æ¶ˆæ¯ã€è½¬è´¦æ¶ˆæ¯ã€AIå›¾ç‰‡æ¶ˆæ¯ã€ç…§ç‰‡å¡ç‰‡ã€ä½ç½®ä¿¡æ¯ã€å¥½å‹ç”³è¯·ã€è®¢å•ç¡®è®¤å’Œä»£ä»˜è¯·æ±‚ï¼Œæ˜µç§°éœ€è¦åœ¨å®¹å™¨å¤–éƒ¨
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // æ™®é€šæ¶ˆæ¯çš„å¤„ç†ï¼ˆåŒ…æ‹¬è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼‰
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                messageContainer.innerHTML = avatarHtml + bubbleHtml;
}

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼ŒæŒ‰ç…§renderChatMessagesçš„ç»“æ„åˆ›å»ºï¼Œä½†è¦ä¿ç•™ç¾¤èŠæ˜µç§°
                if (message.type === 'voice_message') {
                    // è¿‡æ»¤æ‰æ‹¬å·ä¸­çš„æè¿°æ€§å†…å®¹ï¼Œä¿ç•™å®é™…è¯´è¯å†…å®¹
                    const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                    const duration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                    const durationFormatted = duration < 60 ? `0:${String(duration).padStart(2, '0')}''` : `${Math.floor(duration/60)}:${String(duration%60).padStart(2, '0')}''`;

                    const voiceMessageHTML = `
                        <div class="voice-message-container received">
                            <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${durationFormatted}</div>

                                </div>
                            </div>
                            <div class="voice-text-content">${cleanVoiceContent}</div>
                        </div>
                    `;

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç¾¤èŠæ˜µç§°æ˜¾ç¤º
                    if (isGroup && group && displayName !== 'ç¾¤æˆå‘˜') {
                        const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
                        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${voiceMessageHTML}</div>`;
                    } else {
                    messageContainer.innerHTML = avatarHtml + voiceMessageHTML;
                    }
                }
            } else {
                // ç”¨æˆ·æ¶ˆæ¯
                let myDisplayAvatar = chatSettings.myChatAvatar;

                if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                    if (selectedPersona && selectedPersona.avatarUrl) {
                        myDisplayAvatar = selectedPersona.avatarUrl;
                    }
                }

                const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                const myBubblePadding = chatSettings.bubblePadding || '12';

                const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);

                let myBubbleHtml = '';
                if (message.type === 'voice') {
                    const duration = message.duration || Math.max(1, Math.ceil(message.content.length / 8));

                    myBubbleHtml = `
                        <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                            <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                <div class="voice-wave">
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                </div>
                                <div class="voice-duration">${duration}"</div>

                            </div>
                        </div>
                    `;
                } else if (message.type === 'location') {
                    // ä½ç½®æ¶ˆæ¯
                    myBubbleHtml = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                </svg>
                                ${message.locationName}
                            </div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // ç”¨æˆ·è½¬è´¦æ¶ˆæ¯
                    let cardClass = '';
                    let statusHtml = '';

                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²æ”¶æ¬¾</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">å¯¹æ–¹å·²é€€å›</div>`;
                        cardClass = 'rejected';
                    }

                    myBubbleHtml = `
                        <div class="transfer-message-container sent">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                <div class="transfer-title">ğŸ’• ä½ å‘èµ·çš„è½¬è´¦</div>
                                <div class="transfer-amount">Â¥ ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'è½¬è´¦'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'friend_request') {
                    // ğŸ”¥ã€æ–°å¢ã€‘ç”¨æˆ·å‘é€çš„å¥½å‹ç”³è¯·(ç¦»çº¿æ¨¡å¼)
                    myBubbleHtml = `
                        <div class="friend-request-container">
                            <div class="friend-request-card">
                                <div class="friend-request-title">å¥½å‹ç”³è¯·</div>
                                <div class="friend-request-message">${message.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹'}</div>
                                <div class="friend-request-status">å·²å‘é€</div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'order_confirmation') {
                    // è´­ç‰©å°ç¥¨æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨å†…å®¹ï¼Œä¸åŒ…è£¹æ°”æ³¡
                    myBubbleHtml = message.content;
                } else {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯æˆ–æ™®é€šæ–‡æœ¬æ¶ˆæ¯ (ç¬¬ä¸‰ä¸ªæ¸²æŸ“å‡½æ•°ç‰ˆæœ¬)
                    let messageContentStr = '';
                    if (Array.isArray(message.content)) {
                        // æ–°çš„å¤šæ¨¡æ€æ ¼å¼
                        const textPart = message.content.find(p => p.type === 'text');
                        const imagePart = message.content.find(p => p.type === 'image_url');

                        let baseContent = textPart?.text || '';
                        // å¤„ç†@å†…å®¹
                        baseContent = processMentions(baseContent);

                        // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                        if (message.replyTo) {
                            messageContentStr = generateReplyHTML(message.replyTo) + baseContent;
                        } else {
                            messageContentStr = baseContent;
                        }

                        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ˜¾ç¤º
                        if (imagePart?.image_url?.url) {
                            if (messageContentStr) {
                                messageContentStr += '<br>';
                            }
                            messageContentStr += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                        }
                    } else {
                        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯æˆ–æ—§æ ¼å¼
                        let baseContent = message.content;
                        // å¤„ç†@å†…å®¹
                        baseContent = processMentions(baseContent);

                        // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œåœ¨å†…å®¹å‰æ·»åŠ å¼•ç”¨æ˜¾ç¤º
                        if (message.replyTo) {
                            messageContentStr = generateReplyHTML(message.replyTo) + baseContent;
                        } else {
                            messageContentStr = baseContent;
                        }
                    }

                    myBubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                        ${messageContentStr}
                        ${message.image && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                    </div>
                `;
                }

                let myAvatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    myAvatarHtml = generateAvatarHtml({
                        avatarUrl: myDisplayAvatar,
                        backgroundColor: '#007AFF',
                        displayName: '',
                        chatSettings: chatSettings
                    });
                }

                messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;

                // å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼ŒæŒ‰ç…§renderChatMessagesçš„ç»“æ„åˆ›å»º
                if (message.type === 'voice') {
                    // åˆ›å»ºå®Œæ•´çš„è¯­éŸ³æ¶ˆæ¯HTMLï¼Œå’ŒrenderChatMessagesä¿æŒä¸€è‡´
                    const voiceMessageHTML = `
                        <div class="voice-message-container sent">
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>

                                </div>
                            </div>
                            <div class="voice-text-content">${message.content}</div>
                        </div>
                    `;

                    messageContainer.innerHTML = voiceMessageHTML + myAvatarHtml;
                }

                // å¦‚æœæ˜¯ä½ç½®æ¶ˆæ¯ï¼ŒæŒ‰ç…§renderChatMessagesçš„ç»“æ„åˆ›å»º
                if (message.type === 'location') {
                    // åˆ›å»ºå®Œæ•´çš„ä½ç½®æ¶ˆæ¯HTMLï¼Œç¡®ä¿ä¸è¢«åŒ…è£…åœ¨æ°”æ³¡ä¸­
                    const locationMessageHTML = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                </svg>
                                ${message.locationName}
                            </div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;

                    messageContainer.innerHTML = locationMessageHTML + myAvatarHtml;
                }
            }

            // æ·»åŠ æ»‘å…¥åŠ¨ç”»æ•ˆæœ - ç®€å•è‡ªç„¶çš„æ»‘å…¥
            messageContainer.style.opacity = '0';
            messageContainer.style.transform = 'translateY(20px)';

            messagesContainer.appendChild(messageContainer);

            // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ°”æ³¡æˆ³æ ·å¼æ·»åŠ çœŸå®çš„ä¸‰è§’å½¢å…ƒç´ 
            addBubbleTail(messageContainer, message);

            // è§¦å‘æ»‘å…¥åŠ¨ç”»
            requestAnimationFrame(() => {
                messageContainer.classList.add('message-slide-in');
            });

            // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶æ·»åŠ æŒ‡ç¤ºå™¨
            addBlockedIndicatorToMessage(messageContainer, message, characterId);

            // æ·»åŠ é•¿æŒ‰ç›‘å¬å™¨
            addMessageLongPressListener(messageContainer, message.id);

            // æ·»åŠ å³é”®èœå•åŠŸèƒ½
            const bubble = messageContainer.querySelector('.message-bubble');
            if (bubble) {
                bubble.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageMenu(message.id, e);
                });

                bubble.onclick = (e) => {
                    if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                        showImage(e.target.src);
                    }
                };
            }

            // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œè°ƒæ•´å¿ƒç‡
            if (message.sender === 'received' && typeof message.content === 'string') {
                adjustHeartrateForMessage(message.content, false);
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // å°†é¢œè‰²å’Œé€æ˜åº¦è½¬æ¢ä¸ºrgbaæ ¼å¼
        function convertColorWithOpacity(color, opacity) {
            // æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§
            if (!color || typeof color !== 'string') {
                return 'rgba(0, 0, 0, 0)'; // è¿”å›é€æ˜é»‘è‰²ä½œä¸ºé»˜è®¤å€¼
            }

            // å¦‚æœé¢œè‰²å·²ç»æ˜¯rgbaæ ¼å¼ï¼Œç›´æ¥è¿”å›
            if (color.startsWith('rgba')) {
                return color;
            }

            // å¦‚æœæ˜¯åå…­è¿›åˆ¶é¢œè‰²ï¼Œè½¬æ¢ä¸ºrgba
            if (color.startsWith('#')) {
                const hex = color.slice(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }

            // å¦‚æœæ˜¯rgbæ ¼å¼ï¼Œè½¬æ¢ä¸ºrgba
            if (color.startsWith('rgb(')) {
                const rgbValues = color.match(/\d+/g);
                return `rgba(${rgbValues[0]}, ${rgbValues[1]}, ${rgbValues[2]}, ${opacity})`;
            }

            // å¦‚æœæ˜¯é¢œè‰²åç§°ï¼Œå°è¯•è½¬æ¢ï¼ˆç®€å•å®ç°ï¼‰
            const colorMap = {
                'red': '255, 0, 0',
                'green': '0, 128, 0',
                'blue': '0, 0, 255',
                'white': '255, 255, 255',
                'black': '0, 0, 0',
                'gray': '128, 128, 128',
                'yellow': '255, 255, 0',
                'cyan': '0, 255, 255',
                'magenta': '255, 0, 255'
            };

            if (colorMap[color.toLowerCase()]) {
                return `rgba(${colorMap[color.toLowerCase()]}, ${opacity})`;
            }

            // å¦‚æœæ— æ³•è¯†åˆ«ï¼Œè¿”å›åŸè‰²åŠ é€æ˜åº¦ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            return color;
        }

        // å­—ä½“å¤§å°è®¾ç½®åŠŸèƒ½
        function changeFontSize(size) {
            const fontSize = parseInt(size);

            // æ›´æ–°é¢„è§ˆæ–‡å­—
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');

            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }

            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }

            // åˆ›å»ºæˆ–æ›´æ–°å…¨å±€å­—ä½“å¤§å°CSSå˜é‡
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');

            // åº”ç”¨åˆ°èŠå¤©æ¶ˆæ¯
            applyFontSizeToMessages(fontSize);

            // åº”ç”¨åˆ°ç¤¾äº¤åŠ¨æ€
            applyFontSizeToMoments(fontSize);

            // å¦‚æœå½“å‰æœ‰èŠå¤©è§’è‰²ï¼Œé‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥ç¡®ä¿æ–°å­—ä½“å¤§å°ç”Ÿæ•ˆ
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('globalFontSize', fontSize);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('å­—å·è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
        }

        // å­—è·è®¾ç½®åŠŸèƒ½
        function changeLetterSpacing(spacing) {
            const letterSpacing = parseFloat(spacing);

            // æ›´æ–°é¢„è§ˆæ–‡å­—
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('letter-spacing-value');

            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }

            if (valueDisplay) {
                // æ ¹æ®æ•°å€¼æ˜¾ç¤ºå¯¹åº”çš„æ–‡å­—æè¿°
                let description;
                if (letterSpacing < -0.2) {
                    description = 'å¾ˆç´§å‡‘';
                } else if (letterSpacing < 0.2) {
                    description = 'æ ‡å‡†';
                } else if (letterSpacing < 0.8) {
                    description = 'èˆ’é€‚';
                } else if (letterSpacing < 1.5) {
                    description = 'å®½æ¾';
                } else {
                    description = 'å¾ˆå®½æ¾';
                }
                valueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }

            // åˆ›å»ºæˆ–æ›´æ–°å…¨å±€å­—è·CSSå˜é‡
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');

            // åº”ç”¨åˆ°èŠå¤©æ¶ˆæ¯
            applyLetterSpacingToMessages(letterSpacing);

            // åº”ç”¨åˆ°ç¤¾äº¤åŠ¨æ€
            applyLetterSpacingToMoments(letterSpacing);

            // å¦‚æœå½“å‰æœ‰èŠå¤©è§’è‰²ï¼Œé‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥ç¡®ä¿æ–°å­—è·ç”Ÿæ•ˆ
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('globalLetterSpacing', letterSpacing);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('å­—è·è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
        }

        function applyFontSizeToMessages(fontSize) {
            // åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¶ˆæ¯ï¼Œä½¿ç”¨!importantå¼ºåˆ¶è¦†ç›–å†…è”æ ·å¼
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('font-size', fontSize + 'px', 'important');
            });

            // åº”ç”¨åˆ°èŠå¤©è¾“å…¥æ¡†
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.fontSize = fontSize + 'px';
            }
        }

        function applyFontSizeToMoments(fontSize) {
            // åº”ç”¨åˆ°å¾®åšåŠ¨æ€å†…å®¹
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.fontSize = fontSize + 'px';
            });

            // åº”ç”¨åˆ°å¾®åšè¾“å…¥æ¡†
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.fontSize = fontSize + 'px';
            }
        }

        function applyLetterSpacingToMessages(letterSpacing) {
            // åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¶ˆæ¯
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('letter-spacing', letterSpacing + 'px', 'important');
            });

            // åº”ç”¨åˆ°èŠå¤©è¾“å…¥æ¡†
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.letterSpacing = letterSpacing + 'px';
            }
        }

        function applyLetterSpacingToMoments(letterSpacing) {
            // åº”ç”¨åˆ°å¾®åšåŠ¨æ€å†…å®¹
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.letterSpacing = letterSpacing + 'px';
            });

            // åº”ç”¨åˆ°å¾®åšè¾“å…¥æ¡†
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.letterSpacing = letterSpacing + 'px';
            }
        }

        function toggleAutoScale() {
            const toggle = document.getElementById('auto-scale-toggle');
            const isEnabled = toggle.checked;

            // ä¿å­˜è‡ªåŠ¨ç¼©æ”¾è®¾ç½®
            localStorage.setItem('autoScaleFont', isEnabled);

            if (isEnabled) {
                // æ ¹æ®å±å¹•å°ºå¯¸è‡ªåŠ¨è°ƒæ•´å­—ä½“
                autoAdjustFontSize();
                showToast('å­—ä½“è‡ªåŠ¨ç¼©æ”¾å·²å¼€å¯ï¼', 'success');
            } else {
                showToast('å­—ä½“è‡ªåŠ¨ç¼©æ”¾å·²å…³é—­ï¼', 'success');
            }
        }

        function autoAdjustFontSize() {
            const phoneScreen = document.getElementById('phone-screen');
            if (!phoneScreen) return;

            const screenWidth = parseInt(phoneScreen.style.width) || 350;

            // æ ¹æ®å±å¹•å®½åº¦è®¡ç®—æ¨èå­—ä½“å¤§å°
            let recommendedSize = 15; // é»˜è®¤å¤§å°

            if (screenWidth <= 320) {
                recommendedSize = 13; // å°å±å¹•ç”¨å°å­—ä½“
            } else if (screenWidth <= 350) {
                recommendedSize = 14;
            } else if (screenWidth <= 375) {
                recommendedSize = 15;
            } else if (screenWidth <= 390) {
                recommendedSize = 16;
            } else {
                recommendedSize = 17; // å¤§å±å¹•ç”¨å¤§å­—ä½“
            }

            // æ›´æ–°æ»‘å—å’Œåº”ç”¨å­—ä½“å¤§å°
            const slider = document.getElementById('font-size-slider');
            if (slider) {
                slider.value = recommendedSize;
                changeFontSize(recommendedSize);
            }
        }

        function loadFontSizeSettings() {
            // åŠ è½½å­—ä½“å¤§å°è®¾ç½®
            const savedSize = localStorage.getItem('globalFontSize');
            const fontSize = savedSize ? parseInt(savedSize) : 15;

            const slider = document.getElementById('font-size-slider');
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');

            if (slider) {
                slider.value = fontSize;
            }

            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }

            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }

            // åº”ç”¨å­—ä½“å¤§å°
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');

            // åŠ è½½å­—è·è®¾ç½®
            const savedSpacing = localStorage.getItem('globalLetterSpacing');
            const letterSpacing = savedSpacing ? parseFloat(savedSpacing) : 0;

            const spacingSlider = document.getElementById('letter-spacing-slider');
            const spacingValueDisplay = document.getElementById('letter-spacing-value');

            if (spacingSlider) {
                spacingSlider.value = letterSpacing;
            }

            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }

            if (spacingValueDisplay) {
                // æ ¹æ®æ•°å€¼æ˜¾ç¤ºå¯¹åº”çš„æ–‡å­—æè¿°
                let description;
                if (letterSpacing < -0.2) {
                    description = 'å¾ˆç´§å‡‘';
                } else if (letterSpacing < 0.2) {
                    description = 'æ ‡å‡†';
                } else if (letterSpacing < 0.8) {
                    description = 'èˆ’é€‚';
                } else if (letterSpacing < 1.5) {
                    description = 'å®½æ¾';
                } else {
                    description = 'å¾ˆå®½æ¾';
                }
                spacingValueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }

            // åº”ç”¨å­—è·
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');

            // å»¶è¿Ÿåº”ç”¨ï¼Œç¡®ä¿DOMå…ƒç´ å·²ç»åŠ è½½
            setTimeout(() => {
                applyFontSizeToMessages(fontSize);
                applyFontSizeToMoments(fontSize);
                applyLetterSpacingToMessages(letterSpacing);
                applyLetterSpacingToMoments(letterSpacing);
            }, 500);

            // åŠ è½½è‡ªåŠ¨ç¼©æ”¾è®¾ç½®
            const autoScale = localStorage.getItem('autoScaleFont');
            const autoScaleToggle = document.getElementById('auto-scale-toggle');
            if (autoScaleToggle) {
                autoScaleToggle.checked = autoScale === 'true';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…¨å±€è‡ªå®šä¹‰å­—ä½“åŠŸèƒ½
        let globalFontSettings = {
            fontUrl: '',
            fontName: '',
            isApplied: false
        };

        // é¢„è§ˆå…¨å±€å­—ä½“
        function previewGlobalFont() {
            const fontUrl = document.getElementById('global-font-url').value.trim();
            if (!fontUrl) {
                showFontStatus('è¯·è¾“å…¥å­—ä½“é“¾æ¥', 'error');
                return;
            }

            showFontStatus('æ­£åœ¨åŠ è½½å­—ä½“é¢„è§ˆ...', 'info');

            // æ¸…é™¤ä¹‹å‰çš„é¢„è§ˆå­—ä½“
            const existingPreview = document.getElementById('global-font-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // åˆ¤æ–­å­—ä½“ç±»å‹å¹¶åŠ è½½
            if (isCSSFontUrl(fontUrl)) {
                loadCSSFontPreview(fontUrl);
            } else if (isFontFileUrl(fontUrl)) {
                loadFontFilePreview(fontUrl);
            } else {
                showFontStatus('ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä½¿ç”¨CSSé“¾æ¥æˆ–å­—ä½“æ–‡ä»¶é“¾æ¥', 'error');
            }
        }

        // åº”ç”¨å…¨å±€å­—ä½“
        function applyGlobalFont() {
            const fontUrl = document.getElementById('global-font-url').value.trim();
            if (!fontUrl) {
                showFontStatus('è¯·è¾“å…¥å­—ä½“é“¾æ¥', 'error');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„å­—ä½“
            const existingFont = document.getElementById('global-custom-font');
            if (existingFont) {
                existingFont.remove();
            }

            showFontStatus('æ­£åœ¨åº”ç”¨å­—ä½“...', 'info');

            // åˆ¤æ–­å­—ä½“ç±»å‹å¹¶åº”ç”¨
            if (isCSSFontUrl(fontUrl)) {
                applyCSSFont(fontUrl);
            } else if (isFontFileUrl(fontUrl)) {
                applyFontFile(fontUrl);
            } else {
                showFontStatus('ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä½¿ç”¨CSSé“¾æ¥æˆ–å­—ä½“æ–‡ä»¶é“¾æ¥', 'error');
            }
        }

        // é‡ç½®å…¨å±€å­—ä½“
        function resetGlobalFont() {
            // æ¸…é™¤å­—ä½“æ ·å¼
            const existingFont = document.getElementById('global-custom-font');
            if (existingFont) {
                existingFont.remove();
            }

            const existingPreview = document.getElementById('global-font-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤å…¨å±€å­—ä½“è¦†ç›–æ ·å¼
            const existingGlobalStyle = document.getElementById('global-font-override');
            if (existingGlobalStyle) {
                existingGlobalStyle.remove();
            }

            // ğŸ”¥ã€æ–°å¢ã€‘é‡ç½®bodyå­—ä½“ä¸ºé»˜è®¤
            document.body.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('global-font-url').value = '';

            // é‡ç½®è®¾ç½®
            globalFontSettings = {
                fontUrl: '',
                fontName: '',
                isApplied: false
            };

            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('globalCustomFont');

            showFontStatus('å­—ä½“å·²é‡ç½®ä¸ºç³»ç»Ÿé»˜è®¤', 'success');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºCSSå­—ä½“é“¾æ¥
        function isCSSFontUrl(url) {
            return url.includes('fonts.googleapis.com') ||
                   url.includes('fonts.google.com') ||
                   url.endsWith('.css') ||
                   url.includes('fontsapi') ||
                   url.includes('zeoseven.com') ||
                   url.includes('css');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå­—ä½“æ–‡ä»¶é“¾æ¥
        function isFontFileUrl(url) {
            return url.endsWith('.ttf') ||
                   url.endsWith('.otf') ||
                   url.endsWith('.woff') ||
                   url.endsWith('.woff2');
        }

        // åŠ è½½CSSå­—ä½“é¢„è§ˆ
        function loadCSSFontPreview(fontUrl) {
            const link = document.createElement('link');
            link.id = 'global-font-preview';
            link.rel = 'stylesheet';
            link.href = fontUrl;
            link.crossOrigin = 'anonymous';

            link.onload = function() {
                console.log('ğŸ¨ CSSå­—ä½“é¢„è§ˆåŠ è½½æˆåŠŸ');

                // ç­‰å¾…ä¸€ä¸‹è®©CSSå®Œå…¨åŠ è½½
                setTimeout(() => {
                    // å°è¯•æå–å­—ä½“åç§°
                    let fontName = extractFontNameFromCSS(fontUrl);

                    // ğŸ”¥ã€æ–°å¢ã€‘å°è¯•ä»åŠ è½½çš„CSSä¸­åŠ¨æ€æå–çœŸå®å­—ä½“åç§°
                    try {
                        const sheets = document.styleSheets;
                        for (let i = sheets.length - 1; i >= 0; i--) {
                            const sheet = sheets[i];
                            if (sheet.href === fontUrl) {
                                try {
                                    const rules = sheet.cssRules || sheet.rules;
                                    for (let j = 0; j < rules.length; j++) {
                                        const rule = rules[j];
                                        if (rule.type === CSSRule.FONT_FACE_RULE && rule.style.fontFamily) {
                                            fontName = rule.style.fontFamily.replace(/['"]/g, '');
                                            console.log('ğŸ¨ ä»CSSä¸­æå–åˆ°çœŸå®å­—ä½“åç§°:', fontName);
                                            break;
                                        }
                                    }
                                } catch (e) {
                                    console.log('ğŸ¨ æ— æ³•è¯»å–CSSè§„åˆ™ï¼Œä½¿ç”¨é»˜è®¤åç§°');
                                }
                                break;
                            }
                        }
                    } catch (e) {
                        console.log('ğŸ¨ CSSè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°');
                    }

                    // åº”ç”¨é¢„è§ˆæ ·å¼
                    const previewText = document.getElementById('font-size-preview');
                    if (previewText) {
                        previewText.style.fontFamily = `'${fontName}', sans-serif`;
                    }

                    showFontStatus(`å­—ä½“é¢„è§ˆå·²åŠ è½½ï¼š${fontName}`, 'success');
                }, 500);
            };

            link.onerror = function() {
                showFontStatus('å­—ä½“CSSåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
            };

            document.head.appendChild(link);
        }

        // åŠ è½½å­—ä½“æ–‡ä»¶é¢„è§ˆ
        function loadFontFilePreview(fontUrl) {
            const fontName = 'GlobalPreviewFont_' + Date.now();
            const style = document.createElement('style');
            style.id = 'global-font-preview';

            // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šæ ¼å¼
            let format = 'truetype';
            if (fontUrl.endsWith('.woff')) format = 'woff';
            if (fontUrl.endsWith('.woff2')) format = 'woff2';
            if (fontUrl.endsWith('.otf')) format = 'opentype';

            style.textContent = `
                @font-face {
                    font-family: '${fontName}';
                    src: url('${fontUrl}') format('${format}');
                    font-display: swap;
                }
            `;

            document.head.appendChild(style);

            // ç­‰å¾…å­—ä½“åŠ è½½
            setTimeout(() => {
                const previewText = document.getElementById('font-size-preview');
                if (previewText) {
                    previewText.style.fontFamily = `'${fontName}', sans-serif`;
                }
                showFontStatus(`å­—ä½“é¢„è§ˆå·²åŠ è½½ï¼š${fontName}`, 'success');
            }, 500);
        }

        // åº”ç”¨CSSå­—ä½“
        function applyCSSFont(fontUrl) {
            const link = document.createElement('link');
            link.id = 'global-custom-font';
            link.rel = 'stylesheet';
            link.href = fontUrl;
            link.crossOrigin = 'anonymous';

            link.onload = function() {
                console.log('ğŸ¨ CSSå­—ä½“åŠ è½½æˆåŠŸï¼Œå¼€å§‹åº”ç”¨');

                // ç­‰å¾…ä¸€ä¸‹è®©CSSå®Œå…¨åŠ è½½
                setTimeout(() => {
                    let fontName = extractFontNameFromCSS(fontUrl);

                    // ğŸ”¥ã€æ–°å¢ã€‘å°è¯•ä»åŠ è½½çš„CSSä¸­åŠ¨æ€æå–çœŸå®å­—ä½“åç§°
                    try {
                        const sheets = document.styleSheets;
                        for (let i = sheets.length - 1; i >= 0; i--) {
                            const sheet = sheets[i];
                            if (sheet.href === fontUrl) {
                                try {
                                    const rules = sheet.cssRules || sheet.rules;
                                    for (let j = 0; j < rules.length; j++) {
                                        const rule = rules[j];
                                        if (rule.type === CSSRule.FONT_FACE_RULE && rule.style.fontFamily) {
                                            fontName = rule.style.fontFamily.replace(/['"]/g, '');
                                            console.log('ğŸ¨ ä»CSSä¸­æå–åˆ°çœŸå®å­—ä½“åç§°:', fontName);
                                            break;
                                        }
                                    }
                                } catch (e) {
                                    console.log('ğŸ¨ æ— æ³•è¯»å–CSSè§„åˆ™ï¼Œä½¿ç”¨é»˜è®¤åç§°');
                                }
                                break;
                            }
                        }
                    } catch (e) {
                        console.log('ğŸ¨ CSSè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°');
                    }

                    applyFontToElements(fontName);

                    // ä¿å­˜è®¾ç½®
                    globalFontSettings = {
                        fontUrl: fontUrl,
                        fontName: fontName,
                        isApplied: true
                    };
                    localStorage.setItem('globalCustomFont', JSON.stringify(globalFontSettings));

                    showFontStatus(`å­—ä½“å·²åº”ç”¨ï¼š${fontName}`, 'success');
                }, 500);
            };

            link.onerror = function() {
                showFontStatus('å­—ä½“CSSåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
            };

            document.head.appendChild(link);
        }

        // åº”ç”¨å­—ä½“æ–‡ä»¶
        function applyFontFile(fontUrl) {
            const fontName = 'GlobalCustomFont_' + Date.now();
            const style = document.createElement('style');
            style.id = 'global-custom-font';

            // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šæ ¼å¼
            let format = 'truetype';
            if (fontUrl.endsWith('.woff')) format = 'woff';
            if (fontUrl.endsWith('.woff2')) format = 'woff2';
            if (fontUrl.endsWith('.otf')) format = 'opentype';

            style.textContent = `
                @font-face {
                    font-family: '${fontName}';
                    src: url('${fontUrl}') format('${format}');
                    font-display: swap;
                }
            `;

            document.head.appendChild(style);

            // ç­‰å¾…å­—ä½“åŠ è½½ååº”ç”¨
            setTimeout(() => {
                applyFontToElements(fontName);

                // ä¿å­˜è®¾ç½®
                globalFontSettings = {
                    fontUrl: fontUrl,
                    fontName: fontName,
                    isApplied: true
                };
                localStorage.setItem('globalCustomFont', JSON.stringify(globalFontSettings));

                showFontStatus(`å­—ä½“å·²åº”ç”¨ï¼š${fontName}`, 'success');
            }, 500);
        }

        // ä»CSSé“¾æ¥æå–å­—ä½“åç§°
        function extractFontNameFromCSS(fontUrl) {
            // ä»Google Fonts URLæå–å­—ä½“åç§°
            if (fontUrl.includes('fonts.googleapis.com') || fontUrl.includes('fonts.google.com')) {
                const match = fontUrl.match(/family=([^&:]+)/);
                if (match) {
                    return decodeURIComponent(match[1].replace(/\+/g, ' '));
                }
            }

            // ä»zeoseven.comå­—ä½“APIæå–ï¼ˆè¿™ä¸ªAPIé€šå¸¸æ˜¯ChillKaiå­—ä½“ï¼‰
            if (fontUrl.includes('zeoseven.com')) {
                return 'ChillKai';
            }

            // ä»å…¶ä»–CSSé“¾æ¥å°è¯•æå–
            if (fontUrl.includes('fontsapi')) {
                return 'CustomFont';
            }

            return 'CustomFont';
        }

        // åº”ç”¨å­—ä½“åˆ°é¡µé¢å…ƒç´ 
        function applyFontToElements(fontName) {
            console.log('ğŸ¨ å¼€å§‹åº”ç”¨å…¨å±€å­—ä½“:', fontName);

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç›´æ¥ä¿®æ”¹bodyçš„å­—ä½“ï¼Œè¿™æ ·ä¼šå½±å“æ‰€æœ‰å­å…ƒç´ 
            document.body.style.fontFamily = `'${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;

            // ğŸ”¥ã€æ–°å¢ã€‘åˆ›å»ºå…¨å±€CSSè§„åˆ™ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½ä½¿ç”¨æ–°å­—ä½“
            const existingGlobalStyle = document.getElementById('global-font-override');
            if (existingGlobalStyle) {
                existingGlobalStyle.remove();
            }

            const globalStyle = document.createElement('style');
            globalStyle.id = 'global-font-override';
            globalStyle.textContent = `
                /* ğŸ”¥ã€ä¿®å¤ã€‘åªå¯¹æ–‡å­—å†…å®¹åº”ç”¨å­—ä½“ï¼Œä¸å½±å“å›¾æ ‡ */
                body {
                    font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                }

                /* ç‰¹åˆ«é’ˆå¯¹æ‰‹æœºç•Œé¢çš„æ–‡å­—éƒ¨åˆ†ï¼Œæ’é™¤å›¾æ ‡ */
                .header .header-title,
                .app-title,
                .setting-label,
                .setting-desc,
                .app-icon .label,
                .message-bubble .content,
                .chat-input,
                .form-input,
                .form-textarea,
                .form-button,
                .list-item .item-title,
                .list-item .item-content,
                .post-content,
                .diary-content,
                .forum-post-content,
                .font-size-preview-text,
                #main-time,
                #main-date,
                .settings-item-left,
                .chat-list-item .name,
                .chat-list-item .last-msg,
                .contact-item .contact-name,
                .contact-item .contact-desc,
                .modal-title,
                .modal-body,
                .btn,
                button:not(.icon-only),
                input,
                textarea,
                select,
                /* ğŸ”¥ã€æ–°å¢ã€‘æ—¥è®°ç›¸å…³å…ƒç´  */
                #today-diary-content,
                #single-diary-content,
                #diary-preview-content,
                .diary-mode-content,
                .diary-settings-content {
                    font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                }

                /* ğŸ”¥ã€é‡è¦ã€‘ç¡®ä¿å›¾æ ‡å­—ä½“ä¸è¢«è¦†ç›– */
                .fas, .far, .fab, .fal, .fad,
                i[class*="fa-"],
                .icon-bg,
                .app-icon .icon-bg,
                .back-btn,
                .action-btn,
                .settings-icon,
                [class*="icon-"]:not(.app-icon) {
                    font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 5 Free", "Font Awesome 5 Pro", FontAwesome !important;
                }
            `;
            document.head.appendChild(globalStyle);

            console.log('âœ… å…¨å±€å­—ä½“å·²åº”ç”¨åˆ°æ‰€æœ‰å…ƒç´ ');
        }

        // æ˜¾ç¤ºå­—ä½“çŠ¶æ€
        function showFontStatus(message, type) {
            const statusElement = document.getElementById('global-font-status');
            const statusText = statusElement.querySelector('.font-status-text');

            statusElement.className = `font-status ${type}`;
            statusText.textContent = message;
            statusElement.style.display = 'block';

            // 3ç§’åéšè—æˆåŠŸå’Œä¿¡æ¯çŠ¶æ€
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // åŠ è½½ä¿å­˜çš„å…¨å±€å­—ä½“è®¾ç½®
        function loadGlobalFontSettings() {
            const saved = localStorage.getItem('globalCustomFont');
            if (saved) {
                try {
                    globalFontSettings = JSON.parse(saved);
                    if (globalFontSettings.fontUrl) {
                        // æ¢å¤è¾“å…¥æ¡†å†…å®¹
                        const fontUrlInput = document.getElementById('global-font-url');
                        if (fontUrlInput) {
                            fontUrlInput.value = globalFontSettings.fontUrl;
                        }

                        // é‡æ–°åº”ç”¨å­—ä½“
                        if (globalFontSettings.isApplied) {
                            if (isCSSFontUrl(globalFontSettings.fontUrl)) {
                                applyCSSFont(globalFontSettings.fontUrl);
                            } else if (isFontFileUrl(globalFontSettings.fontUrl)) {
                                applyFontFile(globalFontSettings.fontUrl);
                            }
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½å…¨å±€å­—ä½“è®¾ç½®å¤±è´¥:', error);
                }
            }
        }

        // å·¥å…·æ åŠŸèƒ½
        function triggerVoiceMessage() {
            showToast('è¯­éŸ³åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¯­éŸ³å½•åˆ¶åŠŸèƒ½
        }

        // èŠå¤©ç•Œé¢æ‹ç…§åŠŸèƒ½ - æ–‡å­—æè¿°å›¾ç‰‡å‘é€ç»™AI
        async function openCamera() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡', 'error');
                return;
            }

            const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š");
            if (description && description.trim()) {
                const msg = {
                    id: Date.now().toString(),
                    sender: 'sent',
                    type: 'user_photo',
                    content: description.trim(),
                    timestamp: Date.now(),
                    photoDescription: description.trim() // ä¿å­˜åŸå§‹æè¿°ç”¨äºç‚¹å‡»æŸ¥çœ‹
                };

                // æ·»åŠ åˆ°èŠå¤©è®°å½•
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(msg);
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘ç…§ç‰‡åˆ†äº«ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([currentChatCharacter.id]);
                    console.log('âœ… [é«˜æ•ˆç…§ç‰‡åˆ†äº«] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('ç…§ç‰‡åˆ†äº«æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }

                // åˆ·æ–°ç•Œé¢
                renderChatMessages(currentChatCharacter.id);
                renderMessageList();

                showToast('ç…§ç‰‡å·²å‘é€', 'success');
            }
        }

        function openTransfer() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰èŠå¤©è§’è‰²
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡', 'warning');
                return;
            }

            // æ˜¾ç¤ºè½¬è´¦å¯¹è¯æ¡†
            document.getElementById('transfer-modal').classList.add('visible');
        }

        // é€šè¯çŠ¶æ€å˜é‡
        let isInCall = false;
        let callTimer = null;
        let callStartTime = null;
        let callDuration = 0;
        let isMuted = false;
        let isSpeakerOn = false;
        let currentCallCharacter = null;

        // ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘é€šè¯çŠ¶æ€å˜é‡
        let isInVideoCall = false;
        let videoCallTimer = null;
        let videoCallStartTime = null;
        let videoCallDuration = 0;
        let isVideoMuted = false;
        let isVideoCameraOff = false;
        let currentVideoCallCharacter = null;

        // ç”Ÿæˆæ¶ˆæ¯IDå‡½æ•°
        function generateMessageId() {
            return Date.now().toString() + Math.floor(Math.random() * 1000).toString();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
        async function addMessageToChat(message) {
            if (!currentChatCharacter) return;

            const characterId = currentChatCharacter.id;
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }

            chatMessages[characterId].push(message);

            // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
            try {
                const stableId = `${characterId}_${message.id}_${chatMessages[characterId].length - 1}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: characterId,
                    timestamp: message.timestamp,
                    messageOrder: chatMessages[characterId].length - 1,
                    originalMessageId: message.id,
                    messageData: message
                });
                console.log('âœ… [é«˜æ•ˆé€šè¯æ¶ˆæ¯] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('é€šè¯æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                saveChatMessages(); // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ä¼ å…¥characterIdï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
            }

            // æ›´æ–°èŠå¤©ç•Œé¢
            renderChatMessages(characterId);
        }

        function makeCall() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸æ”¯æŒç”µè¯é€šè¯', 'error');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ‹¨å‡ºé€šè¯éŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.OUTGOING_CALL, currentChatCharacter?.id);

            // æ£€æŸ¥è§’è‰²ä¸»åŠ¨æ‹¨æ‰“ç”µè¯å¼€å…³ï¼Œç”¨æˆ·ä¸»åŠ¨æ‹¨æ‰“æ—¶ä¸å—æ­¤é™åˆ¶
            const currentChatSettings = getCurrentChatSettings();
            console.log('ğŸ“ ç”¨æˆ·ä¸»åŠ¨æ‹¨æ‰“ç”µè¯ï¼Œå¼€å…³çŠ¶æ€:', currentChatSettings.aiCallEnabled);

            currentCallCharacter = currentChatCharacter;

            // è®¾ç½®é€šè¯ç•Œé¢
            const avatarSrc = currentCallCharacter.avatar || currentCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            document.getElementById('call-avatar-img').src = avatarSrc;
            document.getElementById('call-name').textContent = currentCallCharacter.name;
            document.getElementById('call-status').textContent = 'æ­£åœ¨é€šè¯ä¸­...';
            document.getElementById('call-timer').textContent = '00:00';

            // æ¸…ç©ºé€šè¯æ¶ˆæ¯å®¹å™¨
            document.getElementById('call-message-container').innerHTML = '';

            // æ˜¾ç¤ºé€šè¯ç•Œé¢
            showApp('phone-call-screen');

            // å¼€å§‹è®¡æ—¶
            startCallTimer();

            // è®¾ç½®é€šè¯çŠ¶æ€
            isInCall = true;

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const callStartMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `${currentCallCharacter.name}å·²æ¥é€šè¯­éŸ³ç”µè¯`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'outgoing',
                callStatus: 'started'
            };

            addMessageToChat(callStartMessage);

            // ç”¨æˆ·ä¸»åŠ¨æ‹¨æ‰“ç”µè¯æ—¶ä¸è‡ªåŠ¨æ·»åŠ è§’è‰²å›åº”ï¼Œç­‰å¾…ç”¨æˆ·å…ˆè¯´è¯
            // è®¾ç½®æ ‡å¿—ï¼Œè¡¨æ˜è¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨æ‹¨æ‰“çš„ç”µè¯
            window.isUserInitiatedCall = true;
        }

        // è§’è‰²ä¸»åŠ¨æ‹¨æ‰“ç”µè¯
        async function initiateAICall(character, callReason) {
            if (isInCall) return; // å¦‚æœå·²ç»åœ¨é€šè¯ä¸­ï¼Œä¸å†å‘èµ·

            currentCallCharacter = character;
            isInCall = true;

            // ğŸ”¥ã€ä¿®å¤ã€‘ç«‹å³æ˜¾ç¤ºç³»ç»Ÿæç¤ºå’Œæ’­æ”¾é“ƒå£°ï¼Œä¸ç­‰å¾…AIç”Ÿæˆå¼€åœºç™½
            const incomingCallMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `${character.name}æ­£åœ¨å‘¼å«ä½ `,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'ringing'
            };
            addMessageToChat(incomingCallMessage);

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¥ç”µéŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.INCOMING_CALL, character?.id);

            // ğŸ”¥ã€æ–°å¢ã€‘è®°ä½å½“å‰æ˜¾ç¤ºçš„ç•Œé¢ï¼Œä»¥ä¾¿æ‹’ç»æ¥ç”µæ—¶æ¢å¤
            const allApps = document.querySelectorAll('.app-screen');
            let currentVisibleApp = null;
            allApps.forEach(app => {
                if (app.style.display === 'flex' || app.style.display === 'block') {
                    currentVisibleApp = app.id;
                }
            });
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯è§çš„åº”ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨ä¸»å±å¹•
            if (!currentVisibleApp) {
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                if (clockContainer && clockContainer.style.display !== 'none' &&
                    homeGrid && homeGrid.style.display !== 'none') {
                    currentVisibleApp = 'home-screen';
                }
            }
            // ä¿å­˜å½“å‰ç•Œé¢çŠ¶æ€
            window.previousScreenBeforeCall = currentVisibleApp || 'api-chat-screen';

            // ğŸ”¥ã€æ¢å¤ã€‘å…ˆç”Ÿæˆè§’è‰²çš„å¼€åœºç™½ï¼Œå†æ˜¾ç¤ºæ¥ç”µç•Œé¢
            let characterGreeting = '';
            try {
                const prompt = `ä½ æ˜¯${character.name}ï¼Œåˆšåˆšå†³å®šç»™ç”¨æˆ·æ‰“ç”µè¯ã€‚

è¯·ç”Ÿæˆä¸€å¥ç®€çŸ­è‡ªç„¶çš„å¼€åœºç™½ï¼Œè¯´æ˜ä½ ä¸ºä»€ä¹ˆè¦æ‰“è¿™ä¸ªç”µè¯ï¼š
- è¦ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹
- åƒçœŸå®é€šè¯å¼€å§‹æ—¶çš„è‡ªç„¶è¡¨è¾¾
- 1å¥è¯å³å¯ï¼Œä¸è¦è¶…è¿‡20å­—
- ç›´æ¥è¯´è¯ï¼Œä¸è¦ä»»ä½•æ ¼å¼æ ‡è®°

ä¾‹å¦‚ï¼š
- "æˆ‘æƒ³å’Œä½ èŠèŠä»Šå¤©çš„äº‹æƒ…"
- "æœ‰ä¸ªå¥½æ¶ˆæ¯æƒ³å‘Šè¯‰ä½ "
- "æƒ³å¬åˆ°ä½ çš„å£°éŸ³"

è¯·åªå›å¤å¼€åœºç™½å†…å®¹ï¼š`;

                const response = await callChatAPI(prompt, character);

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨parseAiResponseè§£æå¼€åœºç™½
                const parsedMessages = await parseAiResponse(response);
                console.log('ğŸ”” å¼€åœºç™½AIå›å¤è§£æç»“æœ:', parsedMessages);

                if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                    // æ‰¾åˆ°ç¬¬ä¸€æ¡çº¯æ–‡æœ¬æ¶ˆæ¯
                    const firstTextMessage = parsedMessages.find(msg => typeof msg === 'string');
                    if (firstTextMessage) {
                        characterGreeting = firstTextMessage.trim();
                    } else {
                        // å¦‚æœæ²¡æœ‰çº¯æ–‡æœ¬ï¼Œå°è¯•æå–å¯¹è±¡ä¸­çš„å†…å®¹
                        const firstMessage = parsedMessages[0];
                        if (typeof firstMessage === 'object' && firstMessage.content) {
                            characterGreeting = firstMessage.content.trim();
                        }
                    }
                } else if (typeof response === 'string') {
                    // å¤‡ç”¨ï¼šå¦‚æœè§£æå¤±è´¥ï¼Œæ¸…ç†åŸå§‹å­—ç¬¦ä¸²
                    characterGreeting = cleanCallResponse(response).trim();
                }

                if (!characterGreeting || characterGreeting.length > 30) {
                    characterGreeting = callReason || 'æƒ³å’Œä½ é€šè¯...';
                }
            } catch (error) {
                console.error('ç”Ÿæˆè§’è‰²å¼€åœºç™½å¤±è´¥:', error);
                characterGreeting = callReason || 'æƒ³å’Œä½ é€šè¯...';
            }

            // è®¾ç½®æ¥ç”µæ˜¾ç¤ºç•Œé¢
            const avatarSrc = character.avatar || character.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            document.getElementById('incoming-call-avatar').src = avatarSrc;
            document.getElementById('incoming-call-name').textContent = character.name;
            document.getElementById('incoming-call-text').textContent = characterGreeting;

            // ğŸ”¥ã€ä¿å­˜å¼€åœºç™½ä¾›æ¥å¬åä½¿ç”¨ã€‘
            window.aiCallGreeting = characterGreeting;

            // æ·»åŠ æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-call-avatar').classList.add('ringing-animation');

            // æ˜¾ç¤ºæ¥ç”µç•Œé¢
            showApp('incoming-call-screen');

            // æ’­æ”¾æ¥ç”µé“ƒå£°ï¼ˆå¦‚æœéœ€è¦ï¼‰
            // playRingtone();

            // ğŸ”¥ã€åˆ é™¤ã€‘ç³»ç»Ÿæ¶ˆæ¯å·²åœ¨å‰é¢å‘é€ï¼Œé¿å…é‡å¤

            // å¦‚æœ30ç§’å†…æ²¡æœ‰æ¥å¬ï¼Œè‡ªåŠ¨æŒ‚æ–­
            setTimeout(() => {
                if (document.getElementById('incoming-call-screen').style.display !== 'none') {
                    rejectCall();
                }
            }, 30000);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²ä¸»åŠ¨å‘èµ·è§†é¢‘é€šè¯
        async function initiateAIVideoCall(character, callReason) {
            if (isInVideoCall) return; // å¦‚æœå·²ç»åœ¨è§†é¢‘é€šè¯ä¸­ï¼Œä¸å†å‘èµ·

            currentVideoCallCharacter = character;
            isInVideoCall = true;

            // ğŸ”¥ã€ä¿®å¤ã€‘ç«‹å³æ˜¾ç¤ºç³»ç»Ÿæç¤ºå’Œæ’­æ”¾é“ƒå£°ï¼Œä¸ç­‰å¾…AIç”Ÿæˆå¼€åœºç™½
            const incomingVideoCallMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `${character.name}æ­£åœ¨å‘¼å«ä½ `,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming_video',
                callStatus: 'ringing'
            };
            addMessageToChat(incomingVideoCallMessage);

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¥ç”µéŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.INCOMING_CALL, character?.id);

            // ğŸ”¥ã€æ–°å¢ã€‘è®°ä½å½“å‰æ˜¾ç¤ºçš„ç•Œé¢ï¼Œä»¥ä¾¿æ‹’ç»æ¥ç”µæ—¶æ¢å¤
            const allApps = document.querySelectorAll('.app-screen');
            let currentVisibleApp = null;
            allApps.forEach(app => {
                if (app.style.display === 'flex' || app.style.display === 'block') {
                    currentVisibleApp = app.id;
                }
            });
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯è§çš„åº”ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨ä¸»å±å¹•
            if (!currentVisibleApp) {
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                if (clockContainer && clockContainer.style.display !== 'none' &&
                    homeGrid && homeGrid.style.display !== 'none') {
                    currentVisibleApp = 'home-screen';
                }
            }
            // ä¿å­˜å½“å‰ç•Œé¢çŠ¶æ€
            window.previousScreenBeforeVideoCall = currentVisibleApp || 'api-chat-screen';

            // ç”Ÿæˆè§’è‰²çš„å¼€åœºç™½
            let characterGreeting = '';
            try {
                const prompt = `ä½ æ˜¯${character.name}ï¼Œåˆšåˆšå†³å®šç»™ç”¨æˆ·æ‰“è§†é¢‘ç”µè¯ã€‚

è¯·ç”Ÿæˆä¸€å¥ç®€çŸ­è‡ªç„¶çš„å¼€åœºç™½ï¼Œè¯´æ˜ä½ ä¸ºä»€ä¹ˆè¦æ‰“è¿™ä¸ªè§†é¢‘ç”µè¯ï¼š
- è¦ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹
- åƒçœŸå®è§†é¢‘é€šè¯å¼€å§‹æ—¶çš„è‡ªç„¶è¡¨è¾¾
- 1å¥è¯å³å¯ï¼Œä¸è¦è¶…è¿‡20å­—
- ç›´æ¥è¯´è¯ï¼Œä¸è¦ä»»ä½•æ ¼å¼æ ‡è®°

ä¾‹å¦‚ï¼š
- "æƒ³çœ‹çœ‹ä½ åœ¨åšä»€ä¹ˆ"
- "æœ‰ä¸ªå¥½æ¶ˆæ¯æƒ³å’Œä½ åˆ†äº«"
- "æƒ³çœ‹åˆ°ä½ çš„ç¬‘å®¹"

è¯·åªå›å¤å¼€åœºç™½å†…å®¹ï¼š`;

                const response = await callChatAPI(prompt, character);

                // ä½¿ç”¨parseAiResponseè§£æå¼€åœºç™½
                const parsedMessages = await parseAiResponse(response);
                console.log('ğŸ”” è§†é¢‘é€šè¯å¼€åœºç™½AIå›å¤è§£æç»“æœ:', parsedMessages);

                if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                    // æ‰¾åˆ°ç¬¬ä¸€æ¡çº¯æ–‡æœ¬æ¶ˆæ¯
                    const firstTextMessage = parsedMessages.find(msg => typeof msg === 'string');
                    if (firstTextMessage) {
                        characterGreeting = firstTextMessage.trim();
                    } else {
                        // å¦‚æœæ²¡æœ‰çº¯æ–‡æœ¬ï¼Œå°è¯•æå–å¯¹è±¡ä¸­çš„å†…å®¹
                        const firstMessage = parsedMessages[0];
                        if (typeof firstMessage === 'object' && firstMessage.content) {
                            characterGreeting = firstMessage.content.trim();
                        }
                    }
                } else if (typeof response === 'string') {
                    // å¤‡ç”¨ï¼šå¦‚æœè§£æå¤±è´¥ï¼Œæ¸…ç†åŸå§‹å­—ç¬¦ä¸²
                    characterGreeting = cleanCallResponse(response).trim();
                }

                if (!characterGreeting || characterGreeting.length > 30) {
                    characterGreeting = callReason || 'æƒ³å’Œä½ è§†é¢‘èŠèŠ...';
                }
            } catch (error) {
                console.error('ç”Ÿæˆè§’è‰²è§†é¢‘é€šè¯å¼€åœºç™½å¤±è´¥:', error);
                characterGreeting = callReason || 'æƒ³å’Œä½ è§†é¢‘èŠèŠ...';
            }

            // è®¾ç½®è§†é¢‘æ¥ç”µæ˜¾ç¤ºç•Œé¢
            const avatarSrc = character.avatar || character.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            document.getElementById('incoming-video-call-avatar').src = avatarSrc;
            document.getElementById('incoming-video-call-name').textContent = character.name;
            document.getElementById('incoming-video-call-text').textContent = characterGreeting;

            // ğŸ”¥ã€ä¿å­˜å¼€åœºç™½ä¾›æ¥å¬åä½¿ç”¨ã€‘
            window.aiVideoCallGreeting = characterGreeting;

            // æ·»åŠ æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-video-call-avatar').classList.add('ringing-animation');

            // æ˜¾ç¤ºè§†é¢‘æ¥ç”µç•Œé¢
            showApp('incoming-video-call-screen');

            // ğŸ”¥ã€åˆ é™¤ã€‘ç³»ç»Ÿæ¶ˆæ¯å·²åœ¨å‰é¢å‘é€ï¼Œé¿å…é‡å¤

            // å¦‚æœ30ç§’å†…æ²¡æœ‰æ¥å¬ï¼Œè‡ªåŠ¨æŒ‚æ–­
            setTimeout(() => {
                if (document.getElementById('incoming-video-call-screen').style.display !== 'none') {
                    rejectVideoCall();
                }
            }, 30000);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¥å—è§†é¢‘æ¥ç”µ
        function acceptVideoCall() {
            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æ¥ç”µé“ƒå£°
            SoundManager.stopSound(SoundManager.TYPES.INCOMING_CALL);

            // åœæ­¢æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-video-call-avatar').classList.remove('ringing-animation');

            // éšè—è§†é¢‘æ¥ç”µç•Œé¢
            hideApp('incoming-video-call-screen');

            // è·å–é€šè¯å½¢è±¡è®¾ç½®
            const videoAvatarSettings = getVideoAvatarSettings();

            // è®¾ç½®è§†é¢‘é€šè¯ç•Œé¢
            const characterAvatarSrc = videoAvatarSettings.characterAvatar || currentVideoCallCharacter.avatar || currentVideoCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            const userAvatarSrc = videoAvatarSettings.userAvatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightblue"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="white">ä½ </text></svg>';

            document.getElementById('video-call-character-avatar').src = characterAvatarSrc;
            document.getElementById('video-call-user-avatar').src = userAvatarSrc;
            document.getElementById('video-call-name').textContent = currentVideoCallCharacter.name;
            document.getElementById('video-call-status').textContent = 'è§†é¢‘é€šè¯ä¸­...';
            document.getElementById('video-call-timer').textContent = '00:00';

            // æ¸…ç©ºæµ®ç°æ¶ˆæ¯å®¹å™¨
            const messageContainer = document.getElementById('video-call-floating-messages');
            if (messageContainer) {
                messageContainer.innerHTML = '';
            }

            // æ˜¾ç¤ºè§†é¢‘é€šè¯ç•Œé¢
            showApp('video-call-screen');

            // å¼€å§‹è®¡æ—¶
            startVideoCallTimer();

            // è®¾ç½®é€šè¯çŠ¶æ€
            isInVideoCall = true;
            isVideoMuted = false;
            isVideoCameraOff = false;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateVideoCallButtons();

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const videoCallAcceptedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `ä½ å·²æ¥é€š${currentVideoCallCharacter.name}çš„è§†é¢‘é€šè¯`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'accepted'
            };

            addMessageToChat(videoCallAcceptedMessage);

            // å¦‚æœæœ‰ä¿å­˜çš„å¼€åœºç™½ï¼Œæ˜¾ç¤ºå®ƒ
            if (window.aiVideoCallGreeting) {
                setTimeout(() => {
                    addVideoCallMessage(window.aiVideoCallGreeting, 'received');
                    window.aiVideoCallGreeting = null; // æ¸…é™¤ä¿å­˜çš„å¼€åœºç™½
                }, 1000);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤ä¿å­˜çš„ç•Œé¢çŠ¶æ€ï¼Œå› ä¸ºå·²ç»æ¥å¬äº†è§†é¢‘ç”µè¯
            window.previousScreenBeforeVideoCall = null;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ‹’ç»è§†é¢‘æ¥ç”µ
        function rejectVideoCall() {
            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æ¥ç”µé“ƒå£°
            SoundManager.stopSound(SoundManager.TYPES.INCOMING_CALL);

            // åœæ­¢æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-video-call-avatar').classList.remove('ringing-animation');

            // éšè—è§†é¢‘æ¥ç”µç•Œé¢
            hideApp('incoming-video-call-screen');

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¢å¤åˆ°æ¥ç”µå‰çš„ç•Œé¢
            const previousScreen = window.previousScreenBeforeVideoCall;
            if (previousScreen && previousScreen !== 'home-screen') {
                showApp(previousScreen);
            } else if (previousScreen === 'home-screen') {
                // å¦‚æœä¹‹å‰åœ¨ä¸»å±å¹•ï¼Œåˆ™æ˜¾ç¤ºä¸»å±å¹•ç»„ä»¶
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                const dockBar = document.getElementById('dock-bar');
                if (clockContainer) clockContainer.style.display = 'block';
                if (homeGrid) homeGrid.style.display = 'grid';
                if (dockBar) dockBar.style.display = 'block';
            } else {
                // é»˜è®¤è¿”å›åˆ°èŠå¤©ç•Œé¢
                showApp('api-chat-screen');
            }

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const videoCallRejectedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `å·²æ‹’ç»${currentVideoCallCharacter.name}çš„è§†é¢‘æ¥ç”µ`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'rejected'
            };

            addMessageToChat(videoCallRejectedMessage);

            currentVideoCallCharacter = null;
            window.aiVideoCallGreeting = null; // æ¸…é™¤ä¿å­˜çš„å¼€åœºç™½
            // æ¸…é™¤ä¿å­˜çš„ç•Œé¢çŠ¶æ€
            window.previousScreenBeforeVideoCall = null;
        }

        // æ¥å—æ¥ç”µ
        function acceptCall() {
            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æ¥ç”µé“ƒå£°
            SoundManager.stopSound(SoundManager.TYPES.INCOMING_CALL);

            // åœæ­¢æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-call-avatar').classList.remove('ringing-animation');

            // éšè—æ¥ç”µç•Œé¢
            hideApp('incoming-call-screen');

            // è®¾ç½®é€šè¯ç•Œé¢
            const avatarSrc = currentCallCharacter.avatar || currentCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            document.getElementById('call-avatar-img').src = avatarSrc;
            document.getElementById('call-name').textContent = currentCallCharacter.name;
            document.getElementById('call-status').textContent = 'æ­£åœ¨é€šè¯ä¸­...';
            document.getElementById('call-timer').textContent = '00:00';

            // æ¸…ç©ºé€šè¯æ¶ˆæ¯å®¹å™¨
            document.getElementById('call-message-container').innerHTML = '';

            // æ˜¾ç¤ºé€šè¯ç•Œé¢
            showApp('phone-call-screen');

            // å¼€å§‹è®¡æ—¶
            startCallTimer();

            // è®¾ç½®é€šè¯çŠ¶æ€
            isInCall = true;

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const callAcceptedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `ä½ å·²æ¥é€š${currentCallCharacter.name}çš„è¯­éŸ³ç”µè¯`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'accepted'
            };

            addMessageToChat(callAcceptedMessage);

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨AIç”Ÿæˆçš„å¼€åœºç™½æˆ–é»˜è®¤é—®å€™
            setTimeout(() => {
                let initialResponse = window.aiCallGreeting || getRandomCallGreeting(currentCallCharacter.name);
                addCallMessage(initialResponse, 'received');
                // æ¸…ç†å¼€åœºç™½ç¼“å­˜
                window.aiCallGreeting = null;
            }, 1000);

            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤ä¿å­˜çš„ç•Œé¢çŠ¶æ€ï¼Œå› ä¸ºå·²ç»æ¥å¬äº†ç”µè¯
            window.previousScreenBeforeCall = null;
        }

        // æ‹’ç»æ¥ç”µ
        function rejectCall() {
            // ğŸ”¥ã€æ–°å¢ã€‘åœæ­¢æ¥ç”µé“ƒå£°
            SoundManager.stopSound(SoundManager.TYPES.INCOMING_CALL);

            // åœæ­¢æŒ¯é“ƒåŠ¨ç”»
            document.getElementById('incoming-call-avatar').classList.remove('ringing-animation');

            // éšè—æ¥ç”µç•Œé¢
            hideApp('incoming-call-screen');

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¢å¤åˆ°æ¥ç”µå‰çš„ç•Œé¢
            const previousScreen = window.previousScreenBeforeCall;
            if (previousScreen && previousScreen !== 'home-screen') {
                showApp(previousScreen);
            } else if (previousScreen === 'home-screen') {
                // å¦‚æœä¹‹å‰åœ¨ä¸»å±å¹•ï¼Œåˆ™æ˜¾ç¤ºä¸»å±å¹•ç»„ä»¶
                const clockContainer = document.getElementById('clock-container');
                const homeGrid = document.getElementById('home-grid');
                const dockBar = document.getElementById('dock-bar');
                if (clockContainer) clockContainer.style.display = 'block';
                if (homeGrid) homeGrid.style.display = 'grid';
                if (dockBar) dockBar.style.display = 'block';
            } else {
                // é»˜è®¤è¿”å›åˆ°èŠå¤©ç•Œé¢
                showApp('api-chat-screen');
            }

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const callRejectedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `å·²æ‹’ç»${currentCallCharacter.name}çš„æ¥ç”µ`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'rejected'
            };

            addMessageToChat(callRejectedMessage);

            currentCallCharacter = null;
            // æ¸…é™¤ä¿å­˜çš„ç•Œé¢çŠ¶æ€
            window.previousScreenBeforeCall = null;
        }

        // ç»“æŸé€šè¯
        function endCall() {
            if (!isInCall) return;

            // åœæ­¢è®¡æ—¶
            stopCallTimer();

            // éšè—é€šè¯ç•Œé¢
            hideApp('phone-call-screen');

            // è¿”å›èŠå¤©ç•Œé¢
            showApp('api-chat-screen');

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const formattedDuration = formatCallDuration(callDuration);
            const callEndedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `è¯­éŸ³ç”µè¯å·²ç»“æŸï¼Œé€šè¯æ—¶é•¿ ${formattedDuration}`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'ended',
                callStatus: 'completed',
                duration: formattedDuration
            };

            addMessageToChat(callEndedMessage);

            // é‡ç½®é€šè¯çŠ¶æ€
            isInCall = false;
            isMuted = false;
            isSpeakerOn = false;

            currentCallCharacter = null;
        }

        // é™éŸ³/å–æ¶ˆé™éŸ³
        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('mute-btn');

            if (isMuted) {
                muteBtn.classList.add('muted');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                showToast('å·²é™éŸ³', 'info');
            } else {
                muteBtn.classList.remove('muted');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                showToast('å·²å–æ¶ˆé™éŸ³', 'info');
            }
        }

        // æ‰¬å£°å™¨å¼€å…³
        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            const speakerBtn = document.getElementById('speaker-btn');

            if (isSpeakerOn) {
                speakerBtn.classList.add('active');
                showToast('å·²å¼€å¯æ‰¬å£°å™¨', 'info');
            } else {
                speakerBtn.classList.remove('active');
                showToast('å·²å…³é—­æ‰¬å£°å™¨', 'info');
            }
        }

        // å¼€å§‹é€šè¯è®¡æ—¶å™¨
        function startCallTimer() {
            callStartTime = new Date();
            callDuration = 0;

            callTimer = setInterval(() => {
                callDuration = Math.floor((new Date() - callStartTime) / 1000);
                document.getElementById('call-timer').textContent = formatCallDuration(callDuration);
            }, 1000);
        }

        // åœæ­¢é€šè¯è®¡æ—¶å™¨
        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }

        // æ ¼å¼åŒ–é€šè¯æ—¶é•¿
        function formatCallDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // åœ¨é€šè¯ç•Œé¢å‘é€æ¶ˆæ¯
        function sendCallMessage() {
            const input = document.getElementById('call-input');
            if (!input) {
                console.error('æ‰¾ä¸åˆ°é€šè¯è¾“å…¥æ¡†å…ƒç´ ');
                return;
            }

            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°é€šè¯ç•Œé¢
            addCallMessage(message, 'sent');

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // æ˜¾ç¤ºAIæ­£åœ¨è¯´è¯çš„æŒ‡ç¤ºå™¨
            const typingIndicator = showCallTypingIndicator();

            // æ ¹æ®é€šè¯ç±»å‹å†³å®šæ˜¯å¦å›å¤
            if (currentCallCharacter) {
                setTimeout(async () => {
                    try {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ„å»ºæ›´å¥½çš„è¯­éŸ³é€šè¯æç¤ºè¯
                        const prompt = `ä½ æ˜¯${currentCallCharacter.name}ï¼Œæ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè¯­éŸ³é€šè¯ã€‚
ç”¨æˆ·åˆšè¯´ï¼š"${message}"

è¯·ç”¨ç®€çŸ­è‡ªç„¶çš„å£è¯­æ–¹å¼å›å¤ï¼Œå°±åƒçœŸå®çš„ç”µè¯å¯¹è¯ä¸€æ ·ï¼š
- ç›´æ¥è¯´è¯ï¼Œä¸è¦ä»»ä½•æè¿°æ€§æ–‡å­—
- ä¿æŒè‡ªç„¶çš„è¯­éŸ³å¯¹è¯é£æ ¼
- å›å¤è¦ç®€æ´ï¼Œ1-2å¥è¯å³å¯
- ç¬¦åˆä½ çš„æ€§æ ¼è®¾å®š

è¯·åªå›å¤å¯¹è¯å†…å®¹ï¼Œä¸è¦JSONæ ¼å¼ï¼Œä¸è¦å…¶ä»–æ ¼å¼ï¼š`;

                        try {
                            const response = await callChatAPI(prompt, currentCallCharacter);

                            // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                            hideCallTypingIndicator(typingIndicator);

                            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨parseAiResponseè§£æå›å¤ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ–‡æœ¬æ¶ˆæ¯
                            const parsedMessages = await parseAiResponse(response);
                            console.log('ğŸ”” é€šè¯AIå›å¤è§£æç»“æœ:', parsedMessages);

                            let hasValidMessage = false;
                            if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                                // éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¯ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯
                                for (const msg of parsedMessages) {
                                    let replyText = '';
                                    if (typeof msg === 'string') {
                                        replyText = msg.trim();
                                    } else if (typeof msg === 'object' && msg.content) {
                                        replyText = msg.content.trim();
                                    }

                                    if (replyText) {
                                        addCallMessage(replyText, 'received');
                                        hasValidMessage = true;
                                        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œè®©å¤šæ¡æ¶ˆæ¯åˆ†å¼€æ˜¾ç¤º
                                        await new Promise(resolve => setTimeout(resolve, 300));
                                    }
                                }
                            }

                            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ¶ˆæ¯ï¼Œä½¿ç”¨å¤‡ç”¨å›å¤
                            if (!hasValidMessage) {
                                if (typeof response === 'string') {
                                    const cleanedText = cleanCallResponse(response);
                                    if (cleanedText) {
                                        addCallMessage(cleanedText, 'received');
                                    } else {
                                        addCallMessage(getRandomCallResponse(), 'received');
                                    }
                                } else {
                                    addCallMessage(getRandomCallResponse(), 'received');
                                }
                            }

                        } catch (error) {
                            console.error('è·å–AIå›å¤å¤±è´¥:', error);
                            hideCallTypingIndicator(typingIndicator);
                            addCallMessage(getRandomCallResponse(), 'received');
                        }

                    } catch (error) {
                        console.error('é€šè¯å›å¤é”™è¯¯:', error);
                        hideCallTypingIndicator(typingIndicator);
                        addCallMessage('æˆ‘æ˜ç™½äº†', 'received');
                    }
                }, 1000 + Math.random() * 1000);
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°é€šè¯ç•Œé¢
        function addCallMessage(message, type) {
            const container = document.getElementById('call-message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `call-message ${type}`;
            messageElement.textContent = message;

            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;

            // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶æ·»åŠ åˆ°èŠå¤©è®°å½•ï¼Œä½†æ ‡è®°ä¸ºé€šè¯æ¶ˆæ¯
            if (currentChatCharacter && currentChatCharacter.id) {
                const callMessage = {
                    id: generateMessageId(),
                    sender: type === 'sent' ? 'sent' : 'received',  // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„senderæ ¼å¼
                    content: message,
                    timestamp: Date.now(),
                    isCallMessage: true,
                    type: 'call_message'  // æ·»åŠ ç‰¹æ®Šç±»å‹æ ‡è®°
                };

                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }

                chatMessages[currentChatCharacter.id].push(callMessage);
                saveChatMessages();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºAIæ­£åœ¨è¯´è¯çš„æŒ‡ç¤ºå™¨
        function showCallTypingIndicator() {
            const container = document.getElementById('call-message-container');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'call-typing-indicator';
            typingIndicator.innerHTML = `
                <div class="call-typing-dots">
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                </div>
            `;

            container.appendChild(typingIndicator);
            container.scrollTop = container.scrollHeight;

            return typingIndicator;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—AIæ­£åœ¨è¯´è¯çš„æŒ‡ç¤ºå™¨
        function hideCallTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºè§†é¢‘é€šè¯æ‰“å­—æŒ‡ç¤ºå™¨
        function showVideoCallTypingIndicator() {
            const container = document.getElementById('video-call-floating-messages');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°è§†é¢‘é€šè¯æ¶ˆæ¯å®¹å™¨å…ƒç´ ');
                return null;
            }

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'floating-message-bubble received video-typing-indicator';
            typingIndicator.innerHTML = `
                <div class="video-typing-dots">
                    <div class="video-typing-dot"></div>
                    <div class="video-typing-dot"></div>
                    <div class="video-typing-dot"></div>
                </div>
            `;

            container.appendChild(typingIndicator);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ‰“å­—æŒ‡ç¤ºå™¨èƒ½å¤Ÿæ­£ç¡®æ»šåŠ¨
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });

            return typingIndicator;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—è§†é¢‘é€šè¯æ‰“å­—æŒ‡ç¤ºå™¨
        function hideVideoCallTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // ğŸ”¥ã€ç®€åŒ–ã€‘æ¸…ç†é€šè¯å›å¤æ–‡æœ¬ - å› ä¸ºå·²ç»ç”¨parseAiResponseå¤„ç†JSONæ ¼å¼
        function cleanCallResponse(text) {
            if (!text) return '';

            console.log('ğŸ§¹ åŸå§‹æ–‡æœ¬:', text);

            // åŸºç¡€æ¸…ç†ï¼šç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
            text = text.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();

            // ç§»é™¤å¸¸è§çš„æè¿°æ€§å‰ç¼€
            text = text.replace(/^(è§’è‰²è¯´|æˆ‘è¯´|å›å¤|ç­”æ¡ˆ|å›ç­”)[:ï¼š]\s*/i, '');

            // ç§»é™¤æ‹¬å·ä¸­çš„æè¿°æ€§å†…å®¹
            text = text.replace(/\([^)]*\)/g, '');
            text = text.replace(/ã€[^ã€‘]*ã€‘/g, '');
            text = text.replace(/\[[^\]]*\]/g, '');

            // å¦‚æœæ–‡æœ¬ä»¥æ ‡ç‚¹ç¬¦å·å¼€å¤´ï¼Œç§»é™¤å®ƒ
            text = text.replace(/^[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š,.!?;:\s]*/, '');

            console.log('ğŸ§¹ æ¸…ç†åæ–‡æœ¬:', text);

            // éªŒè¯æ¸…ç†ç»“æœ
            if (!text || text.length < 2) {
                console.log('ğŸ§¹ æ–‡æœ¬æ— æ•ˆï¼Œä½¿ç”¨å¤‡ç”¨å›å¤');
                return getRandomCallResponse();
            }

            // å¦‚æœæ–‡æœ¬å¤ªé•¿ï¼Œæˆªå–å‰é¢éƒ¨åˆ†
            if (text.length > 60) {
                text = text.substring(0, 60) + '...';
            }

            return text;
        }

        // éšæœºé€šè¯é—®å€™è¯­
        function getRandomCallGreeting(characterName) {
            const greetings = [
                `ä½ å¥½ï¼Œæˆ‘æ˜¯${characterName}ï¼Œå¾ˆé«˜å…´èƒ½å’Œä½ é€šè¯ã€‚`,
                `å—¨ï¼Œç»ˆäºèƒ½å¬åˆ°ä½ çš„å£°éŸ³äº†ï¼`,
                `å–‚ï¼Œä½ å¥½å•Šï¼Œå¬å¾—åˆ°æˆ‘è¯´è¯å—ï¼Ÿ`,
                `ä½ å¥½ï¼Œè°¢è°¢ä½ æ¥æˆ‘ç”µè¯ã€‚`,
                `å—¨ï¼Œå¾ˆé«˜å…´èƒ½å’Œä½ é€šè¯ã€‚`
            ];

            return greetings[Math.floor(Math.random() * greetings.length)];
        }

        // éšæœºé€šè¯å›å¤ï¼ˆå¤‡ç”¨ï¼‰
        function getRandomCallResponse() {
            const responses = [
                'å—¯ï¼Œæˆ‘æ˜ç™½äº†ã€‚',
                'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ã€‚',
                'æ˜¯çš„ï¼Œä½ è¯´å¾—å¯¹ã€‚',
                'æˆ‘è§‰å¾—è¿™ä¸ªæƒ³æ³•ä¸é”™ã€‚',
                'å—¯ï¼Œæœ‰é“ç†ã€‚',
                'å“¦ï¼ŒçœŸçš„å—ï¼Ÿ',
                'æˆ‘æ˜ç™½ä½ çš„æ„æ€äº†ã€‚',
                'è¿™æ ·å•Šï¼Œæˆ‘æ‡‚äº†ã€‚',
                'ç¡®å®å¦‚æ­¤ã€‚',
                'æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚'
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }

        // æ£€æµ‹æ˜¯å¦åº”è¯¥è§¦å‘AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯
        function checkForAICallTrigger(userMessage, aiResponse) {
            // è·å–å½“å‰èŠå¤©è®¾ç½®
            const currentChatSettings = getCurrentChatSettings();

            // å¦‚æœæœªå¯ç”¨AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯åŠŸèƒ½ï¼Œç›´æ¥è¿”å›
            if (!currentChatSettings.aiCallEnabled) {
                console.log('ğŸ”” AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯åŠŸèƒ½æœªå¼€å¯ï¼Œè§’è‰²ä¸ä¼šä¸»åŠ¨æ‹¨æ‰“ç”µè¯');
                return false;
            }

            // å¦‚æœå·²ç»åœ¨é€šè¯ä¸­ï¼Œä¸å†è§¦å‘
            if (isInCall || isInVideoCall) {
                console.log('ğŸ”” å½“å‰æ­£åœ¨é€šè¯ä¸­ï¼Œä¸è§¦å‘æ–°çš„æ¥ç”µ');
                return false;
            }

            // ç¡®ä¿æœ‰å½“å‰èŠå¤©è§’è‰²ä¸”ä¸æ˜¯ç¾¤èŠ
            if (!currentChatCharacter || currentChatCharacter.isGroup) {
                console.log('ğŸ”” æ²¡æœ‰å½“å‰èŠå¤©è§’è‰²æˆ–ä¸ºç¾¤èŠï¼Œæ— æ³•è§¦å‘æ¥ç”µ');
                return false;
            }

            // é€šè¯ç›¸å…³å…³é”®è¯
            const callKeywords = ['é€šè¯', 'ç”µè¯', 'è§†é¢‘', 'è¯­éŸ³', 'æ‰“ç»™ä½ ', 'æƒ³å¬', 'æƒ³çœ‹', 'èŠå¤©', 'è¯´è¯', 'æ‰“ç”µè¯', 'æ¥ç”µ', 'æ¥ç”µè¯'];

            // æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ä¸­æ˜¯å¦åŒ…å«é€šè¯å…³é”®è¯
            const userMessageHasCallKeyword = callKeywords.some(keyword => userMessage.includes(keyword));
            const aiResponseHasCallKeyword = callKeywords.some(keyword => aiResponse.includes(keyword));

            console.log('ğŸ”” æ£€æŸ¥AIä¸»åŠ¨æ‹¨æ‰“è§¦å‘æ¡ä»¶:', {
                userMessage: userMessage.substring(0, 50) + '...',
                aiResponse: aiResponse.substring(0, 50) + '...',
                userHasKeyword: userMessageHasCallKeyword,
                aiHasKeyword: aiResponseHasCallKeyword,
                characterName: currentChatCharacter.name
            });

            // åŸºäºè§’è‰²äººè®¾å’Œå¯¹è¯å†…å®¹å†³å®šè§¦å‘æ¦‚ç‡
            let triggerProbability = 0;

            // 1. åŸºç¡€æ¦‚ç‡ï¼šå¦‚æœå¯¹è¯ä¸­æåˆ°é€šè¯ç›¸å…³å†…å®¹
            if (userMessageHasCallKeyword || aiResponseHasCallKeyword) {
                triggerProbability = 0.15; // åŸºç¡€15%æ¦‚ç‡

                // å¦‚æœåŒæ–¹éƒ½æåˆ°é€šè¯ï¼Œæå‡æ¦‚ç‡
                if (userMessageHasCallKeyword && aiResponseHasCallKeyword) {
                    triggerProbability = 0.35;
                }
            }

            // 2. æ ¹æ®è§’è‰²æ€§æ ¼è°ƒæ•´æ¦‚ç‡
            const characterBio = (currentChatCharacter.bio || '').toLowerCase();
            if (characterBio.includes('ä¸»åŠ¨') || characterBio.includes('å¤–å‘') || characterBio.includes('çƒ­æƒ…') ||
                characterBio.includes('æ´»æ³¼') || characterBio.includes('å¼€æœ—') || characterBio.includes('ç§¯æ')) {
                triggerProbability += 0.1;
            }

            // 3. æ ¹æ®å¯¹è¯æƒ…æ„Ÿè°ƒæ•´æ¦‚ç‡
            const emotionalKeywords = ['æƒ³ä½ ', 'æƒ³è§ä½ ', 'æƒ³å’Œä½ ', 'å–œæ¬¢ä½ ', 'çˆ±ä½ ', 'æƒ³èŠ', 'æƒ³è¯´', 'æƒ³åˆ†äº«'];
            const hasEmotionalContent = emotionalKeywords.some(keyword =>
                userMessage.includes(keyword) || aiResponse.includes(keyword)
            );
            if (hasEmotionalContent) {
                triggerProbability += 0.1;
            }

            // 4. éšæœºå› ç´ ï¼šå³ä½¿æ²¡æœ‰æ˜æ˜¾è§¦å‘æ¡ä»¶ï¼Œä¹Ÿæœ‰å°æ¦‚ç‡è§¦å‘ï¼ˆæ¨¡æ‹Ÿè§’è‰²çªç„¶æƒ³æ‰“ç”µè¯ï¼‰
            if (triggerProbability === 0 && Math.random() < 0.03) {
                triggerProbability = 0.03;
                console.log('ğŸ”” è§’è‰²çªç„¶æƒ³è¦æ‰“ç”µè¯ï¼ˆéšæœºè§¦å‘ï¼‰');
            }

            // é™åˆ¶æœ€å¤§æ¦‚ç‡
            triggerProbability = Math.min(triggerProbability, 0.5);

            if (triggerProbability > 0 && Math.random() < triggerProbability) {
                console.log('ğŸ”” AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯è¢«è§¦å‘ï¼æ¦‚ç‡:', triggerProbability);

                // ä»AIå›å¤ä¸­æå–é€šè¯ç†ç”±ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆé»˜è®¤ç†ç”±
                let callReason = extractCallReason(aiResponse);
                if (!callReason || callReason.includes('æƒ³å’Œä½ èŠèŠå¤©')) {
                    // æ ¹æ®è§’è‰²æ€§æ ¼ç”Ÿæˆæ›´ä¸ªæ€§åŒ–çš„ç†ç”±
                    const personalizedReasons = [
                        'çªç„¶æƒ³å¬å¬ä½ çš„å£°éŸ³',
                        'æœ‰è¯æƒ³å’Œä½ è¯´',
                        'æƒ³å’Œä½ èŠèŠå¤©',
                        'æƒ³é€šè¿‡ç”µè¯å’Œä½ äº¤æµ',
                        'è§‰å¾—æ‰“ç”µè¯ä¼šæ›´æœ‰æ„æ€'
                    ];
                    callReason = personalizedReasons[Math.floor(Math.random() * personalizedReasons.length)];
                }

                // å»¶è¿Ÿ1-4ç§’åè§¦å‘æ¥ç”µï¼Œè®©å¯¹è¯æ›´è‡ªç„¶
                const delay = 1000 + Math.random() * 3000;
                console.log(`ğŸ”” å°†åœ¨${Math.round(delay/1000)}ç§’åå‘èµ·æ¥ç”µï¼Œç†ç”±: ${callReason}`);

                setTimeout(() => {
                    console.log('ğŸ”” å¼€å§‹å‘èµ·AIæ¥ç”µ');
                    initiateAICall(currentChatCharacter, callReason);
                }, delay);

                return true;
            } else {
                console.log('ğŸ”” AIä¸»åŠ¨æ‹¨æ‰“æœªè§¦å‘ï¼Œæ¦‚ç‡:', triggerProbability);
            }

            return false;
        }

        // ä»AIå›å¤ä¸­æå–é€šè¯ç†ç”±
        function extractCallReason(aiResponse) {
            // é»˜è®¤ç†ç”±
            let defaultReasons = [
                'æƒ³å’Œä½ èŠèŠå¤©',
                'æœ‰äº‹æƒ…æƒ³å‘Šè¯‰ä½ ',
                'æƒ³å¬å¬ä½ çš„å£°éŸ³',
                'æƒ³å’Œä½ è¯´è¯´è¯'
            ];

            // å°è¯•ä»å›å¤ä¸­æå–ä¸€ä¸ªåˆç†çš„å¥å­ä½œä¸ºç†ç”±
            const sentences = aiResponse.split(/[ã€‚ï¼ï¼Ÿ.!?]/);
            const validSentences = sentences.filter(s => {
                const trimmed = s.trim();
                return trimmed.length > 5 && trimmed.length < 20 && !trimmed.includes('æˆ‘');
            });

            if (validSentences.length > 0) {
                return validSentences[Math.floor(Math.random() * validSentences.length)].trim();
            }

            return defaultReasons[Math.floor(Math.random() * defaultReasons.length)];
        }

        function openVideoCall() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸æ”¯æŒè§†é¢‘é€šè¯', 'error');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ‹¨å‡ºé€šè¯éŸ³æ•ˆ
            SoundManager.play(SoundManager.TYPES.OUTGOING_CALL, currentChatCharacter?.id);

            currentVideoCallCharacter = currentChatCharacter;

            // è·å–é€šè¯å½¢è±¡è®¾ç½®
            const videoAvatarSettings = getVideoAvatarSettings();

            // è®¾ç½®è§†é¢‘é€šè¯ç•Œé¢
            const characterAvatarSrc = videoAvatarSettings.characterAvatar || currentVideoCallCharacter.avatar || currentVideoCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">å¤´åƒ</text></svg>';
            const userAvatarSrc = videoAvatarSettings.userAvatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightblue"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="white">ä½ </text></svg>';

            document.getElementById('video-call-character-avatar').src = characterAvatarSrc;
            document.getElementById('video-call-user-avatar').src = userAvatarSrc;
            document.getElementById('video-call-name').textContent = currentVideoCallCharacter.name;
            document.getElementById('video-call-status').textContent = 'è§†é¢‘é€šè¯ä¸­...';
            document.getElementById('video-call-timer').textContent = '00:00';

            // æ¸…ç©ºæµ®ç°æ¶ˆæ¯å®¹å™¨
            const messageContainer = document.getElementById('video-call-floating-messages');
            if (messageContainer) {
                messageContainer.innerHTML = '';
            }

            // æ˜¾ç¤ºè§†é¢‘é€šè¯ç•Œé¢
            showApp('video-call-screen');

            // å¼€å§‹è®¡æ—¶
            startVideoCallTimer();

            // è®¾ç½®é€šè¯çŠ¶æ€
            isInVideoCall = true;
            isVideoMuted = false;
            isVideoCameraOff = false;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateVideoCallButtons();

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const videoCallStartMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `${currentVideoCallCharacter.name}å·²æ¥é€šè§†é¢‘é€šè¯`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'outgoing',
                callStatus: 'started'
            };

            addMessageToChat(videoCallStartMessage);

            // ç”¨æˆ·ä¸»åŠ¨æ‹¨æ‰“è§†é¢‘é€šè¯æ—¶ä¸è‡ªåŠ¨æ·»åŠ è§’è‰²å›åº”ï¼Œç­‰å¾…ç”¨æˆ·å…ˆè¯´è¯
            window.isUserInitiatedVideoCall = true;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘é€šè¯ç›¸å…³å‡½æ•°
        function startVideoCallTimer() {
            videoCallStartTime = new Date();
            videoCallDuration = 0;

            videoCallTimer = setInterval(() => {
                videoCallDuration = Math.floor((new Date() - videoCallStartTime) / 1000);
                document.getElementById('video-call-timer').textContent = formatCallDuration(videoCallDuration);
            }, 1000);
        }

        function stopVideoCallTimer() {
            if (videoCallTimer) {
                clearInterval(videoCallTimer);
                videoCallTimer = null;
            }
        }

        function endVideoCall() {
            if (!isInVideoCall) return;

            // åœæ­¢è®¡æ—¶
            stopVideoCallTimer();

            // éšè—è§†é¢‘é€šè¯ç•Œé¢
            hideApp('video-call-screen');

            // è¿”å›èŠå¤©ç•Œé¢
            showApp('api-chat-screen');

            // å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const formattedDuration = formatCallDuration(videoCallDuration);
            const videoCallEndedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `è§†é¢‘é€šè¯å·²ç»“æŸï¼Œé€šè¯æ—¶é•¿ ${formattedDuration}`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'ended',
                callStatus: 'completed',
                duration: formattedDuration
            };

            addMessageToChat(videoCallEndedMessage);

            // é‡ç½®è§†é¢‘é€šè¯çŠ¶æ€
            isInVideoCall = false;
            isVideoMuted = false;
            isVideoCameraOff = false;

            currentVideoCallCharacter = null;
            window.isUserInitiatedVideoCall = false;
        }

        function toggleVideoMute() {
            isVideoMuted = !isVideoMuted;
            updateVideoCallButtons();

            const muteBtn = document.getElementById('video-mute-btn');
            if (isVideoMuted) {
                showToast('å·²é™éŸ³', 'info');
            } else {
                showToast('å·²å–æ¶ˆé™éŸ³', 'info');
            }
        }

        function toggleVideoCamera() {
            isVideoCameraOff = !isVideoCameraOff;
            updateVideoCallButtons();

            const userWindow = document.querySelector('.video-call-user-window');
            if (isVideoCameraOff) {
                userWindow.style.background = '#333';
                userWindow.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 12px;"><i class="fas fa-video-slash"></i></div>';
                showToast('æ‘„åƒå¤´å·²å…³é—­', 'info');
            } else {
                const userAvatarSettings = getVideoAvatarSettings();
                const userAvatarSrc = userAvatarSettings.userAvatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightblue"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="white">ä½ </text></svg>';
                userWindow.style.background = '';
                userWindow.innerHTML = `<img id="video-call-user-avatar" src="${userAvatarSrc}" alt="ç”¨æˆ·é€šè¯å½¢è±¡" class="user-video-avatar">`;
                showToast('æ‘„åƒå¤´å·²å¼€å¯', 'info');
            }
        }

        function updateVideoCallButtons() {
            const muteBtn = document.getElementById('video-mute-btn');
            const cameraBtn = document.getElementById('video-camera-btn');

            if (muteBtn) {
                if (isVideoMuted) {
                    muteBtn.classList.add('muted');
                    muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                } else {
                    muteBtn.classList.remove('muted');
                    muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                }
            }

            if (cameraBtn) {
                if (isVideoCameraOff) {
                    cameraBtn.classList.add('camera-off');
                    cameraBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                } else {
                    cameraBtn.classList.remove('camera-off');
                    cameraBtn.innerHTML = '<i class="fas fa-video"></i>';
                }
            }
        }



        function sendVideoCallMessage() {
            const input = document.getElementById('video-call-input');
            if (!input) {
                console.error('æ‰¾ä¸åˆ°è§†é¢‘é€šè¯è¾“å…¥æ¡†å…ƒç´ ');
                return;
            }

            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°è§†é¢‘é€šè¯ç•Œé¢
            addVideoCallMessage(message, 'sent');

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // æ˜¾ç¤ºAIæ­£åœ¨å›å¤çš„æŒ‡ç¤ºå™¨
            const typingIndicator = showVideoCallTypingIndicator();

            // æ ¹æ®é€šè¯ç±»å‹å†³å®šæ˜¯å¦å›å¤
            if (currentVideoCallCharacter) {
                setTimeout(async () => {
                    try {
                        // æ„å»ºè§†é¢‘é€šè¯æç¤ºè¯
                        const prompt = `ä½ æ˜¯${currentVideoCallCharacter.name}ï¼Œæ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè§†é¢‘é€šè¯ã€‚
ç”¨æˆ·åˆšè¯´ï¼š"${message}"

è¯·å›å¤ï¼Œå¯ä»¥åŒ…å«å¯¹è¯å’Œæå†™ï¼š
- è¯´è¯çš„éƒ¨åˆ†ç”¨ã€Œã€ç¬¦å·åŒ…è£¹ï¼Œå¦‚ï¼šã€Œä½ å¥½ï¼Œå¬å¾—åˆ°æˆ‘è¯´è¯å—ï¼Ÿã€
- å¯ä»¥åŠ å…¥åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€åœºæ™¯æå†™ç­‰ï¼Œè®©è§†é¢‘é€šè¯æ›´ç”ŸåŠ¨
- æ¯æ¬¡å›å¤ä¸è¦è¶…è¿‡300å­—
- ä¿æŒè‡ªç„¶çš„è§†é¢‘å¯¹è¯é£æ ¼
- ç¬¦åˆä½ çš„è§’è‰²è®¾å®š

ç›´æ¥å›å¤å†…å®¹ï¼Œä¸è¦ä»»ä½•æ ¼å¼æ ‡è®°ï¼š`;

                        const response = await callChatAPI(prompt, currentVideoCallCharacter);

                        if (response && response.trim()) {
                            // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                            hideVideoCallTypingIndicator(typingIndicator);

                            // è§£æAIå›å¤å¹¶æ˜¾ç¤º - ä½¿ç”¨ä¸è¯­éŸ³é€šè¯ç›¸åŒçš„é€»è¾‘
                            const parsedMessages = await parseAiResponse(response);
                            console.log('ğŸ”” è§†é¢‘é€šè¯AIå›å¤è§£æç»“æœ:', parsedMessages);

                            let hasValidMessage = false;
                            if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                                // éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¯ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯
                                for (const msg of parsedMessages) {
                                    let replyText = '';
                                    if (typeof msg === 'string') {
                                        replyText = msg.trim();
                                    } else if (typeof msg === 'object' && msg.content) {
                                        replyText = msg.content.trim();
                                    }

                                    if (replyText) {
                                        addVideoCallMessage(replyText, 'received');
                                        hasValidMessage = true;
                                        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œè®©å¤šæ¡æ¶ˆæ¯åˆ†å¼€æ˜¾ç¤º
                                        await new Promise(resolve => setTimeout(resolve, 300));
                                    }
                                }
                            }

                            if (!hasValidMessage) {
                                const cleanResponse = cleanCallResponse(response);
                                if (cleanResponse && cleanResponse.trim()) {
                                    addVideoCallMessage(cleanResponse.trim(), 'received');
                                } else {
                                    addVideoCallMessage(getRandomCallResponse(), 'received');
                                }
                            }
                        } else {
                            hideVideoCallTypingIndicator(typingIndicator);
                            addVideoCallMessage(getRandomCallResponse(), 'received');
                        }

                    } catch (error) {
                        console.error('è§†é¢‘é€šè¯å›å¤é”™è¯¯:', error);
                        hideVideoCallTypingIndicator(typingIndicator);
                        addVideoCallMessage('æˆ‘æ˜ç™½äº†', 'received');
                    }
                }, 1000 + Math.random() * 1000);
            }
        }

        function addVideoCallMessage(message, type) {
            const container = document.getElementById('video-call-floating-messages');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°è§†é¢‘é€šè¯æ¶ˆæ¯å®¹å™¨å…ƒç´ ');
                return;
            }

            // åˆ›å»ºæµ®ç°æ¶ˆæ¯æ°”æ³¡
            const messageElement = document.createElement('div');
            messageElement.className = `floating-message-bubble ${type}`;
            messageElement.textContent = message;

            // ç›´æ¥æ·»åŠ æ¶ˆæ¯åˆ°å®¹å™¨
            container.appendChild(messageElement);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®æ»šåŠ¨
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMæ›´æ–°åå†æ»šåŠ¨
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });

            // åŒæ—¶æ·»åŠ åˆ°èŠå¤©è®°å½•ï¼Œä½†æ ‡è®°ä¸ºè§†é¢‘é€šè¯æ¶ˆæ¯
            if (currentVideoCallCharacter && currentVideoCallCharacter.id) {
                const videoCallMessage = {
                    id: generateMessageId(),
                    sender: type === 'sent' ? 'sent' : 'received',
                    content: message,
                    timestamp: Date.now(),
                    type: 'call_message'
                };

                addMessageToChat(videoCallMessage);
            }
        }



        // ğŸ”¥ã€æ–°å¢ã€‘è§†é¢‘é€šè¯å½¢è±¡è®¾ç½®ç›¸å…³å‡½æ•°
        function showVideoAvatarModal() {
            // åŠ è½½å½“å‰è®¾ç½®
            const settings = getVideoAvatarSettings();

            // æ›´æ–°é¢„è§ˆå›¾ç‰‡
            const characterPreview = document.getElementById('character-video-avatar-preview');
            const userPreview = document.getElementById('user-video-avatar-preview');
            const characterPlaceholder = document.getElementById('character-avatar-placeholder');
            const userPlaceholder = document.getElementById('user-avatar-placeholder');

            if (settings.characterAvatar) {
                characterPreview.src = settings.characterAvatar;
                characterPreview.style.display = 'block';
                characterPlaceholder.style.display = 'none';
            } else {
                characterPreview.style.display = 'none';
                characterPlaceholder.style.display = 'flex';
            }

            if (settings.userAvatar) {
                userPreview.src = settings.userAvatar;
                userPreview.style.display = 'block';
                userPlaceholder.style.display = 'none';
            } else {
                userPreview.style.display = 'none';
                userPlaceholder.style.display = 'flex';
            }

            document.getElementById('video-avatar-modal').style.display = 'flex';
        }

        function hideVideoAvatarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('video-avatar-modal').style.display = 'none';
        }

        function changeCharacterVideoAvatar() {
            document.getElementById('character-video-avatar-input').click();
        }

        function changeUserVideoAvatar() {
            document.getElementById('user-video-avatar-input').click();
        }

        function handleCharacterVideoAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('character-video-avatar-preview');
                    const placeholder = document.getElementById('character-avatar-placeholder');

                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleUserVideoAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('user-video-avatar-preview');
                    const placeholder = document.getElementById('user-avatar-placeholder');

                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveVideoAvatarSettings() {
            const characterPreview = document.getElementById('character-video-avatar-preview');
            const userPreview = document.getElementById('user-video-avatar-preview');

            const settings = {
                characterAvatar: characterPreview.style.display === 'block' ? characterPreview.src : null,
                userAvatar: userPreview.style.display === 'block' ? userPreview.src : null
            };

            // ä¿å­˜åˆ°localStorage
            if (currentChatCharacter && currentChatCharacter.id) {
                const key = `videoAvatarSettings_${currentChatCharacter.id}`;
                localStorage.setItem(key, JSON.stringify(settings));
                showToast('é€šè¯å½¢è±¡è®¾ç½®å·²ä¿å­˜', 'success');
            }

            hideVideoAvatarModal();
        }

        function getVideoAvatarSettings() {
            if (!currentChatCharacter || !currentChatCharacter.id) {
                return { characterAvatar: null, userAvatar: null };
            }

            const key = `videoAvatarSettings_${currentChatCharacter.id}`;
            const saved = localStorage.getItem(key);

            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (error) {
                    console.error('è§£æè§†é¢‘é€šè¯å½¢è±¡è®¾ç½®å¤±è´¥:', error);
                }
            }

            return { characterAvatar: null, userAvatar: null };
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è§†é¢‘é€šè¯å½¢è±¡è®¾ç½®çš„æ˜¾ç¤ºçŠ¶æ€
        function updateVideoAvatarSettingVisibility() {
            const videoAvatarSetting = document.getElementById('video-avatar-setting');
            if (videoAvatarSetting) {
                // åªåœ¨å•èŠæ—¶æ˜¾ç¤ºè§†é¢‘é€šè¯å½¢è±¡è®¾ç½®
                if (currentChatCharacter && !currentChatCharacter.isGroup) {
                    videoAvatarSetting.style.display = 'flex';  // ä½¿ç”¨flexè€Œä¸æ˜¯block
                } else {
                    videoAvatarSetting.style.display = 'none';
                }
            }
        }

        function shareLocation() {
            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            // é‡ç½®è¾“å…¥æ¡†
            document.getElementById('location-address').value = '';
            document.getElementById('map-location-display').textContent = 'è¯·è¾“å…¥ä½ç½®åç§°';

            // éšæœºåŒ–åœ°å›¾æ˜¾ç¤º
            randomizeMapPosition();

            // åŠ è½½å†å²è®°å½•
            renderLocationHistory();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('chat-location-modal').style.display = 'flex';
        }

        function hideChatLocationModal() {
            document.getElementById('chat-location-modal').style.display = 'none';
        }

        function setLocationAddress(address) {
            document.getElementById('location-address').value = address;
            document.getElementById('map-location-display').textContent = address;

            // ç”Ÿæˆéšæœºåæ ‡
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}Â°E, ${lat}Â°N`;
        }

        function randomizeMapPosition() {
            const marker = document.getElementById('location-marker');
            const buildings = document.querySelectorAll('.building');

            // éšæœºç§»åŠ¨æ ‡è®°ä½ç½®
            const newTop = 20 + Math.random() * 60; // 20% - 80%
            const newLeft = 20 + Math.random() * 60; // 20% - 80%
            marker.style.top = newTop + '%';
            marker.style.left = newLeft + '%';

            // éšæœºç§»åŠ¨å»ºç­‘ç‰©
            buildings.forEach(building => {
                const top = Math.random() * 85; // 0% - 85%
                const left = Math.random() * 85; // 0% - 85%
                building.style.top = top + '%';
                building.style.left = left + '%';
            });

            // æ›´æ–°åæ ‡
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}Â°E, ${lat}Â°N`;
        }

        // ç”Ÿæˆé€¼çœŸçš„åœ°å›¾HTMLå†…å®¹
        function generateRealisticMapHTML() {
            return `
                <div class="map-background"></div>
                <!-- å¼¯æ›²æ²³æµ -->
                <div class="river" style="top: 5%; left: 60%; width: 20px; height: 3px; transform: rotate(35deg);"></div>
                <div class="river-curve" style="top: 12%; left: 72%; width: 18px; height: 3px; transform: rotate(15deg);"></div>
                <div class="river" style="top: 18%; left: 80%; width: 16px; height: 3px; transform: rotate(-5deg);"></div>
                <div class="river-curve" style="top: 22%; left: 85%; width: 15px; height: 3px; transform: rotate(-25deg);"></div>
                <div class="river" style="top: 55%; left: 2%; width: 22px; height: 3px; transform: rotate(-10deg);"></div>
                <div class="river-curve" style="top: 62%; left: 18%; width: 20px; height: 3px; transform: rotate(8deg);"></div>
                <div class="river" style="top: 68%; left: 32%; width: 18px; height: 3px; transform: rotate(25deg);"></div>
                <!-- å…¬å›­ç»¿åœ° -->
                <div class="park" style="top: 20%; left: 65%; width: 18px; height: 15px;"></div>
                <div class="park" style="top: 45%; left: 10%; width: 22px; height: 18px;"></div>
                <!-- é“è·¯ -->
                <div class="map-roads">
                    <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                    <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                    <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                </div>
                <!-- å»ºç­‘ç‰© -->
                <div class="map-buildings">
                    <div class="building house" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                    <div class="building office" style="top: 25%; left: 45%; width: 8px; height: 16px;"></div>
                    <div class="building shop" style="top: 50%; left: 50%; width: 14px; height: 8px;"></div>
                    <div class="building house" style="top: 70%; left: 75%; width: 10px; height: 8px;"></div>
                    <div class="building office" style="top: 8%; left: 85%; width: 6px; height: 12px;"></div>
                </div>
                <!-- æ ‘æœ¨ -->
                <div class="tree big" style="top: 25%; left: 15%; width: 6px; height: 6px;"></div>
                <div class="tree small" style="top: 55%; left: 25%; width: 4px; height: 4px;"></div>
                <div class="tree big" style="top: 10%; left: 70%; width: 5px; height: 5px;"></div>
                <div class="tree small" style="top: 75%; left: 85%; width: 3px; height: 3px;"></div>
                <div class="tree small" style="top: 40%; left: 80%; width: 4px; height: 4px;"></div>
                <!-- ä½ç½®æ ‡è®° -->
                <div class="map-marker">
                    <div class="marker-pin">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                        </svg>
                    </div>
                </div>
            `;
        }

        // å†å²åœ°ç‚¹ç®¡ç†
        let locationHistory = JSON.parse(localStorage.getItem('locationHistory') || '[]');

        function saveLocationHistory() {
            localStorage.setItem('locationHistory', JSON.stringify(locationHistory));
        }

        function addToLocationHistory(locationName) {
            if (!locationName.trim()) return;

            // ç§»é™¤é‡å¤é¡¹
            locationHistory = locationHistory.filter(name => name !== locationName);
            // æ·»åŠ åˆ°å¼€å¤´
            locationHistory.unshift(locationName);
            // é™åˆ¶æœ€å¤šä¿å­˜10ä¸ª
            if (locationHistory.length > 10) {
                locationHistory = locationHistory.slice(0, 10);
            }

            saveLocationHistory();
            renderLocationHistory();
        }

        function removeFromLocationHistory(locationName) {
            locationHistory = locationHistory.filter(name => name !== locationName);
            saveLocationHistory();
            renderLocationHistory();
        }

        function renderLocationHistory() {
            const container = document.getElementById('location-history-items');
            if (!container) return;

            if (locationHistory.length === 0) {
                container.innerHTML = '<div class="location-history-empty">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            container.innerHTML = locationHistory.map(location =>
                `<div class="location-history-item" data-location="${location}">
                    <span class="location-text">${location}</span>
                    <span class="delete-btn" data-location="${location}" title="åˆ é™¤">Ã—</span>
                </div>`
            ).join('');

            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å†…è”onclické—®é¢˜
            container.onclick = function(e) {
                const locationItem = e.target.closest('.location-history-item');
                if (!locationItem) return;

                const location = locationItem.dataset.location;

                if (e.target.classList.contains('delete-btn')) {
                    // ç‚¹å‡»åˆ é™¤æŒ‰é’®
                    e.stopPropagation();
                    confirmDeleteLocation(location);
                } else {
                    // ç‚¹å‡»ä½ç½®é¡¹
                    setLocationAddress(location);
                }
            };
        }

        // é•¿æŒ‰åˆ é™¤å¤„ç†
        let touchTimer = null;
        let touchedElement = null;

        function handleLocationTouchStart(event, location) {
            touchedElement = event.target;
            touchTimer = setTimeout(() => {
                confirmDeleteLocation(location);
            }, 800); // 800msé•¿æŒ‰
        }

        function handleLocationTouchEnd(event) {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
            if (touchedElement) {
                touchedElement.classList.remove('deleting');
                touchedElement = null;
            }
        }

        function confirmDeleteLocation(location) {
            if (touchedElement) {
                touchedElement.classList.add('deleting');
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤ä½ç½®"${location}"å—ï¼Ÿ`)) {
                removeFromLocationHistory(location);
                showToast('ä½ç½®å·²åˆ é™¤', 'success');
            } else if (touchedElement) {
                touchedElement.classList.remove('deleting');
            }
        }

        function sendLocationMessage() {
            const address = document.getElementById('location-address').value.trim();
            if (!address) {
                alert('è¯·è¾“å…¥ä½ç½®åç§°');
                return;
            }

            // æ·»åŠ åˆ°å†å²è®°å½•
            addToLocationHistory(address);

            // åˆ›å»ºä½ç½®æ¶ˆæ¯
            const locationMessage = {
                id: Date.now().toString(),
                sender: 'sent',
                type: 'location',
                locationName: address,
                coordinates: document.querySelector('.map-coordinates').textContent,
                content: `[ç”¨æˆ·åˆ†äº«äº†ä½ç½®ä¿¡æ¯ï¼š${address}ï¼Œåæ ‡ï¼š${document.querySelector('.map-coordinates').textContent}]`,
                timestamp: Date.now()
            };

            console.log('ğŸ—ºï¸ åˆ›å»ºä½ç½®æ¶ˆæ¯:', locationMessage);

            // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥æ¶ˆæ¯æ•°æ®
            if (!locationMessage.locationName || !locationMessage.coordinates) {
                console.error('âŒ ä½ç½®æ¶ˆæ¯æ•°æ®ä¸å®Œæ•´:', {
                    locationName: locationMessage.locationName,
                    coordinates: locationMessage.coordinates
                });
                alert('ä½ç½®ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·é‡è¯•');
                return;
            }

            // æ·»åŠ åˆ°èŠå¤©è®°å½•
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(locationMessage);

            // ä¿å­˜åˆ°æ•°æ®åº“
            saveChatMessages();

            // ä½¿ç”¨åŠ¨ç”»æ·»åŠ æ¶ˆæ¯è€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
            addMessageWithAnimation(locationMessage, currentChatCharacter.id);

            // è®¾ç½®ä¸ºå¾…å›å¤æ¶ˆæ¯
            pendingUserMessage = locationMessage;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
            }

            // æ›´æ–°è”ç³»äººåˆ—è¡¨
            renderMessageList();

            // å…³é—­æ¨¡æ€æ¡†
            hideChatLocationModal();

            showToast('ä½ç½®å·²åˆ†äº«', 'success');
        }

        // æ›´æ–°å·²å­˜åœ¨çš„ä½ç½®å¡ç‰‡åœ°å›¾
        function updateExistingLocationMaps() {
            const locationMaps = document.querySelectorAll('.location-card-map');
            locationMaps.forEach(mapElement => {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆæ²¡æœ‰æ–°çš„åœ°å›¾å…ƒç´ ï¼‰
                if (!mapElement.querySelector('.river')) {
                    mapElement.innerHTML = generateRealisticMapHTML();
                }
            });
        }

        // ç›‘å¬ä½ç½®è¾“å…¥æ¡†çš„å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location-address');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    if (value) {
                        document.getElementById('map-location-display').textContent = value;

                        // ç”Ÿæˆéšæœºåæ ‡
                        const lat = (39.8 + Math.random() * 0.4).toFixed(4);
                        const lng = (116.2 + Math.random() * 0.4).toFixed(4);
                        document.querySelector('.map-coordinates').textContent = `${lng}Â°E, ${lat}Â°N`;
                    } else {
                        document.getElementById('map-location-display').textContent = 'è¯·è¾“å…¥ä½ç½®åç§°';
                    }
                });
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.getElementById('chat-location-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('chat-location-modal')) {
                    hideChatLocationModal();
                }
            });

            // å®šæœŸæ›´æ–°ç°æœ‰çš„ä½ç½®å¡ç‰‡åœ°å›¾
            setInterval(updateExistingLocationMaps, 1000);
        });

        // æ˜¾ç¤ºä½ç½®è¯¦æƒ…
        function showLocationDetail(locationName) {
            alert(`ğŸ—ºï¸ ${locationName}`);
        }

        // ğŸ“Š æ•°æ®ç®¡ç†ç›¸å…³å‡½æ•°

        // è®¡ç®—å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0, characterSize = 0, settingsSize = 0, emojiSize = 0;

                const [chatData, charData, settingsData, emojiData] = await Promise.all([
                    db.chatMessages.toArray(),
                    db.characters.toArray(),
                    db.chatSettings.toArray(),
                    db.customEmojis.toArray()
                ]);

                chatSize = JSON.stringify(chatData).length;
                characterSize = JSON.stringify(charData).length;
                settingsSize = JSON.stringify(settingsData).length;
                emojiSize = JSON.stringify(emojiData).length;
                const total = chatSize + characterSize + settingsSize + emojiSize;

                // æ›´æ–°æ˜¾ç¤º
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                if (document.getElementById('chat-storage-size')) {
                    document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                    document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                    document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                    document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                    document.getElementById('total-storage-size').textContent = formatBytes(total);
                }
            } catch (error) {
                console.error('è®¡ç®—å­˜å‚¨å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æµè§ˆå™¨å…¼å®¹æ€§è¯Šæ–­å‡½æ•°
        function diagnoseBrowserCompatibility() {
            console.log('ğŸ” æµè§ˆå™¨å…¼å®¹æ€§è¯Šæ–­æŠ¥å‘Š:');
            console.log('æµè§ˆå™¨ä¿¡æ¯:', {
                userAgent: navigator.userAgent,
                vendor: navigator.vendor,
                platform: navigator.platform
            });
            console.log('æ•°æ®çŠ¶æ€:', {
                charactersCount: characters.length,
                contactsCount: contacts.length,
                chatMessagesKeys: Object.keys(chatMessages).length,
                charactersData: characters.slice(0, 2), // åªæ˜¾ç¤ºå‰2ä¸ªè§’è‰²çš„æ•°æ®
                contactsData: contacts.slice(0, 10) // åªæ˜¾ç¤ºå‰10ä¸ªè”ç³»äººID
            });
            console.log('DOMçŠ¶æ€:', {
                messageListExists: !!document.getElementById('message-list'),
                messageItemsCount: document.querySelectorAll('.message-item').length
            });
            console.log('IndexedDBçŠ¶æ€:', {
                dbVersion: db.verno,
                dbTables: db.tables.map(t => t.name)
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¼ºåˆ¶ä¿®å¤æ•°æ®ä¸ä¸€è‡´é—®é¢˜
        async function forceFixDataConsistency() {
            try {
                console.log('ğŸ”§ å¼€å§‹å¼ºåˆ¶ä¿®å¤æ•°æ®ä¸€è‡´æ€§...');
                showToast('æ­£åœ¨ä¿®å¤æ•°æ®ä¸€è‡´æ€§...', 'info');

                // 1. é‡æ–°åŠ è½½æ‰€æœ‰åŸºç¡€æ•°æ®
                await Promise.all([
                    loadCharacters(),
                    loadChatMessages()
                ]);

                // 2. æ™ºèƒ½ä¿®å¤è”ç³»äººåˆ—è¡¨
                if (characters.length > 0 && contacts.length === 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰èŠå¤©è®°å½•
                    const chatCharacterIds = Object.keys(chatMessages).filter(id =>
                        characters.some(char => char.id === id)
                    );

                    if (chatCharacterIds.length > 0) {
                        contacts = chatCharacterIds;
                        await saveContacts();
                        console.log(`ğŸ”§ ä»èŠå¤©è®°å½•æ¢å¤äº† ${contacts.length} ä¸ªè”ç³»äºº`);
                    } else {
                        console.log('ğŸ”§ æ— èŠå¤©è®°å½•ï¼Œä¿æŒè”ç³»äººä¸ºç©º');
                    }
                } else {
                    console.log('ğŸ”§ è”ç³»äººçŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤');
                }

                // 3. é‡æ–°æ¸²æŸ“ç•Œé¢
                renderMessageList();
                renderContactList();

                console.log('âœ… æ•°æ®ä¸€è‡´æ€§ä¿®å¤å®Œæˆ');
                showToast('æ•°æ®ä¸€è‡´æ€§ä¿®å¤å®Œæˆ', 'success');

            } catch (error) {
                console.error('âŒ æ•°æ®ä¸€è‡´æ€§ä¿®å¤å¤±è´¥:', error);
                showToast('æ•°æ®ä¸€è‡´æ€§ä¿®å¤å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å…¨å±€è°ƒè¯•å·¥å…· - æš´éœ²ç»™æ§åˆ¶å°ä½¿ç”¨
        window.debugTools = {
            // è¯Šæ–­æµè§ˆå™¨å…¼å®¹æ€§
            diagnose: diagnoseBrowserCompatibility,

            // å¼ºåˆ¶ä¿®å¤æ•°æ®ä¸€è‡´æ€§
            fix: forceFixDataConsistency,

            // æŸ¥çœ‹å½“å‰æ•°æ®çŠ¶æ€
            showData: function() {
                console.log('ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€:');
                console.log('è§’è‰²æ•°æ®:', characters);
                console.log('è”ç³»äººæ•°æ®:', contacts);
                console.log('èŠå¤©æ¶ˆæ¯:', chatMessages);
                console.log('DOMçŠ¶æ€:', {
                    messageItems: document.querySelectorAll('.message-item').length,
                    contactItems: document.querySelectorAll('.contact-item').length
                });
            },

            // é‡æ–°æ¸²æŸ“ç•Œé¢
            rerender: function() {
                console.log('ğŸ”„ é‡æ–°æ¸²æŸ“ç•Œé¢...');
                renderMessageList();
                renderContactList();
                renderCharacterList();
                console.log('âœ… é‡æ–°æ¸²æŸ“å®Œæˆ');
            },

            // æ¸…ç†å¹¶é‡æ–°åŠ è½½æ•°æ®
            reload: async function() {
                console.log('ğŸ”„ é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®...');
                await Promise.all([
                    loadCharacters(),
                    loadContacts(),
                    loadChatMessages()
                ]);
                this.rerender();
                console.log('âœ… æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
            },

            // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•åˆ é™¤å¯¹è¯åŠŸèƒ½
            testDeleteConversation: function() {
                console.log('ğŸ§ª æµ‹è¯•åˆ é™¤å¯¹è¯åŠŸèƒ½...');
                console.log('åˆ é™¤å‰çŠ¶æ€:', {
                    charactersCount: characters.length,
                    contactsCount: contacts.length,
                    contacts: [...contacts]
                });

                if (contacts.length > 0) {
                    const testId = contacts[0];
                    console.log(`ğŸ§ª æ¨¡æ‹Ÿåˆ é™¤å¯¹è¯: ${testId}`);

                    // æ¨¡æ‹Ÿåˆ é™¤æ“ä½œ
                    const index = contacts.indexOf(testId);
                    if (index > -1) {
                        contacts.splice(index, 1);
                        saveContacts();
                        this.rerender();

                        console.log('åˆ é™¤åçŠ¶æ€:', {
                            contactsCount: contacts.length,
                            contacts: [...contacts]
                        });
                        console.log('âœ… åˆ é™¤æµ‹è¯•å®Œæˆï¼Œåˆ·æ–°é¡µé¢éªŒè¯æ˜¯å¦ä¼šé‡æ–°å‡ºç°');
                    }
                } else {
                    console.log('âš ï¸ æ²¡æœ‰å¯¹è¯å¯ä»¥æµ‹è¯•åˆ é™¤');
                }
            }
        };

        // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè°ƒè¯•å·¥å…·ä½¿ç”¨è¯´æ˜
        console.log('ğŸ› ï¸ è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼åœ¨æ§åˆ¶å°ä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:');
        console.log('debugTools.diagnose() - è¯Šæ–­æµè§ˆå™¨å…¼å®¹æ€§');
        console.log('debugTools.fix() - æ™ºèƒ½ä¿®å¤æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆä¸ä¼šæ¢å¤å·²åˆ é™¤çš„å¯¹è¯ï¼‰');
        console.log('debugTools.showData() - æŸ¥çœ‹å½“å‰æ•°æ®çŠ¶æ€');
        console.log('debugTools.rerender() - é‡æ–°æ¸²æŸ“ç•Œé¢');
        console.log('debugTools.reload() - é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®');
        console.log('debugTools.testDeleteConversation() - æµ‹è¯•åˆ é™¤å¯¹è¯åŠŸèƒ½');
        console.log('ğŸ’¡ æ³¨æ„ï¼šä¿®å¤åŠŸèƒ½åªä¼šæ¢å¤æœ‰èŠå¤©è®°å½•ä½†ç¼ºå°‘è”ç³»äººçš„å¯¹è¯ï¼Œä¸ä¼šæ¢å¤ç”¨æˆ·ä¸»åŠ¨åˆ é™¤çš„å¯¹è¯');

        // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¯¼å‡ºæ‰€æœ‰æ•°æ® - é’ˆå¯¹å¤§æ•°æ®é‡å’ŒSafariå†…å­˜é™åˆ¶ä¼˜åŒ–
        async function exportAllData() {
            try {
                // ğŸ”¥ã€Safariä¼˜åŒ–ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºSafariæµè§ˆå™¨
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                if (isSafari && isMobile) {
                    showToast('æ£€æµ‹åˆ°Safariç§»åŠ¨ç‰ˆï¼Œä½¿ç”¨ä¼˜åŒ–æ¨¡å¼...', 'info');
                } else {
                    showToast('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'info');
                }

                // ğŸ”¥ã€å†…å­˜æ£€æŸ¥ã€‘å°è¯•ä¼°ç®—å¯ç”¨å†…å­˜
                let memoryInfo = null;
                if ('memory' in performance) {
                    memoryInfo = performance.memory;
                    console.log('ğŸ§  å†…å­˜ä¿¡æ¯:', {
                        used: Math.round(memoryInfo.usedJSHeapSize / 1024 / 1024) + 'MB',
                        total: Math.round(memoryInfo.totalJSHeapSize / 1024 / 1024) + 'MB',
                        limit: Math.round(memoryInfo.jsHeapSizeLimit / 1024 / 1024) + 'MB'
                    });
                }

                // ğŸ”¥ã€è°ƒè¯•ã€‘æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬å’Œè¡¨æ˜¯å¦å­˜åœ¨
                console.log('ğŸ” æ•°æ®åº“ç‰ˆæœ¬:', db.verno);
                console.log('ğŸ” æ•°æ®åº“è¡¨åˆ—è¡¨:', db.tables.map(t => t.name));

                // ğŸ”¥ã€å†…å­˜ä¼˜åŒ–ã€‘åˆ†æ‰¹åŠ è½½æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®å¯¼è‡´å†…å­˜æº¢å‡º
                showToast('æ­£åœ¨åˆ†ææ•°æ®å¤§å°...', 'info');

                // ğŸ”¥ã€å†…å­˜ä¼˜åŒ–ã€‘åˆ†æ‰¹åŠ è½½æ•°æ®ï¼Œé¿å…Safariå†…å­˜æº¢å‡º
                const exportData = {
                    version: '6.1', // ğŸ”¥ã€æ›´æ–°ç‰ˆæœ¬å·ã€‘ä¼˜åŒ–å¤§æ•°æ®é‡å¯¼å‡º
                    exportTime: new Date().toISOString()
                };

                // ğŸ”¥ã€é¢„æ£€æŸ¥ã€‘å…ˆæ£€æŸ¥æœ€å¤§çš„è¡¨ï¼ˆèŠå¤©æ¶ˆæ¯ï¼‰çš„å¤§å°
                try {
                    const chatMessageCount = await db.chatMessages.count();
                    const groupMessageCount = await db.groupChatMessages.count();
                    const totalMessages = chatMessageCount + groupMessageCount;

                    console.log(`ğŸ“Š æ¶ˆæ¯æ•°é‡ç»Ÿè®¡: èŠå¤©æ¶ˆæ¯ ${chatMessageCount} æ¡, ç¾¤èŠæ¶ˆæ¯ ${groupMessageCount} æ¡, æ€»è®¡ ${totalMessages} æ¡`);

                    // ğŸ”¥ã€æ™ºèƒ½å»ºè®®ã€‘å¦‚æœæ¶ˆæ¯æ•°é‡è¿‡å¤šï¼Œå»ºè®®ä½¿ç”¨è½»é‡çº§å¯¼å‡º
                    if (totalMessages > 10000) {
                        const useLight = confirm(
                            `æ£€æµ‹åˆ°å¤§é‡æ¶ˆæ¯æ•°æ® (${totalMessages} æ¡)\n\n` +
                            `ä¸ºé¿å…å¯¼å‡ºå¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨è½»é‡çº§å¯¼å‡ºã€‚\n\n` +
                            `è½»é‡çº§å¯¼å‡ºåŒ…å«ï¼šè§’è‰²ã€æ¶ˆæ¯ã€è®°å¿†ç³»ç»Ÿã€ä¸–ç•Œä¹¦ã€è®ºå›ç­‰æ ¸å¿ƒæ•°æ®\n` +
                            `ä¸åŒ…å«ï¼šåŠ¨æ€ã€è¡¨æƒ…åŒ…ã€éŸ³ä¹ç­‰æ‰©å±•æ•°æ®\n\n` +
                            `ç‚¹å‡»"ç¡®å®š"ä½¿ç”¨è½»é‡çº§å¯¼å‡º\n` +
                            `ç‚¹å‡»"å–æ¶ˆ"ç»§ç»­å®Œæ•´å¯¼å‡ºï¼ˆå¯èƒ½å¤±è´¥ï¼‰`
                        );

                        if (useLight) {
                            await exportLightweightData();
                            return;
                        }
                    }
                } catch (preCheckError) {
                    console.warn('âš ï¸ é¢„æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸å¯¼å‡º:', preCheckError);
                }

                // ğŸ”¥ã€åˆ†æ‰¹å¤„ç†ã€‘å®šä¹‰æ•°æ®è¡¨åŠ è½½é¡ºåºï¼Œä¼˜å…ˆåŠ è½½å°è¡¨
                const tableLoadOrder = [
                    // ç¬¬ä¸€æ‰¹ï¼šå°è¡¨ï¼ˆé…ç½®å’Œè®¾ç½®ï¼‰
                    { name: 'characters', label: 'è§’è‰²' },
                    { name: 'chatSettings', label: 'èŠå¤©è®¾ç½®' },
                    { name: 'contacts', label: 'è”ç³»äºº' },
                    { name: 'personas', label: 'ç”¨æˆ·é¢å…·' },
                    { name: 'characterGroups', label: 'è§’è‰²åˆ†ç»„' },
                    { name: 'groupChats', label: 'ç¾¤èŠ' },
                    { name: 'worldbooks', label: 'ä¸–ç•Œä¹¦' },
                    { name: 'apiSettings', label: 'APIè®¾ç½®' },
                    { name: 'globalSettings', label: 'å…¨å±€è®¾ç½®' },
                    { name: 'wallpapers', label: 'å£çº¸' },
                    { name: 'appIcons', label: 'åº”ç”¨å›¾æ ‡' },
                    { name: 'anniversaries', label: 'çºªå¿µæ—¥' },
                    { name: 'diarySettings', label: 'æ—¥è®°è®¾ç½®' },

                    // ç¬¬äºŒæ‰¹ï¼šä¸­ç­‰è¡¨
                    { name: 'worldbookEntries', label: 'ä¸–ç•Œä¹¦æ¡ç›®' },
                    { name: 'customEmojis', label: 'è‡ªå®šä¹‰è¡¨æƒ…' },
                    { name: 'recentEmojis', label: 'æœ€è¿‘è¡¨æƒ…' },
                    { name: 'groupChatMembers', label: 'ç¾¤èŠæˆå‘˜' },
                    { name: 'moments', label: 'åŠ¨æ€' },
                    { name: 'momentLikes', label: 'åŠ¨æ€ç‚¹èµ' },
                    { name: 'momentComments', label: 'åŠ¨æ€è¯„è®º' },
                    { name: 'characterDiaries', label: 'è§’è‰²æ—¥è®°' },
                    { name: 'innerThoughts', label: 'å¿ƒå£°' },

                    // ç¬¬ä¸‰æ‰¹ï¼šè®ºå›ç›¸å…³
                    { name: 'forums', label: 'è®ºå›' },
                    { name: 'forumPosts', label: 'è®ºå›å¸–å­' },
                    { name: 'forumReplies', label: 'è®ºå›å›å¤' },
                    { name: 'forumFavorites', label: 'è®ºå›æ”¶è—' },
                    { name: 'replyLikes', label: 'å›å¤ç‚¹èµ' },
                    { name: 'forumPostImages', label: 'è®ºå›å›¾ç‰‡' },
                    { name: 'forumMountedWorldbooks', label: 'è®ºå›ä¸–ç•Œä¹¦' },

                    // ç¬¬å››æ‰¹ï¼šè®°å¿†ç³»ç»Ÿï¼ˆå¯èƒ½è¾ƒå¤§ï¼‰
                    { name: 'workingMemory', label: 'å·¥ä½œè®°å¿†' },
                    { name: 'episodicMemory', label: 'æƒ…èŠ‚è®°å¿†' },
                    { name: 'episodicMemories', label: 'æƒ…æ™¯è®°å¿†' },
                    { name: 'memorySummaries', label: 'è®°å¿†æ€»ç»“' },
                    { name: 'memoryEvents', label: 'è®°å¿†äº‹ä»¶' },
                    { name: 'coreMemory', label: 'æ ¸å¿ƒè®°å¿†' },
                    { name: 'coreMemories', label: 'æ ¸å¿ƒè®°å¿†åº“' },
                    { name: 'crossAppTimeline', label: 'æ—¶é—´çº¿' },

                    // ç¬¬äº”æ‰¹ï¼šå…¶ä»–ç³»ç»Ÿ
                    { name: 'blacklist', label: 'æ‹‰é»‘åˆ—è¡¨' },
                    { name: 'blockedCharacters', label: 'è¢«æ‹‰é»‘è§’è‰²' },
                    { name: 'friendRequests', label: 'å¥½å‹ç”³è¯·' },
                    { name: 'characterStatus', label: 'è§’è‰²çŠ¶æ€' },
                    { name: 'offlineHistoryRecords', label: 'çº¿ä¸‹è®°å½•' },
                    { name: 'offlineUISettings', label: 'çº¿ä¸‹ç•Œé¢è®¾ç½®' },
                    { name: 'offlinePresets', label: 'çº¿ä¸‹é¢„è®¾' },
                    { name: 'musicPlaylist', label: 'éŸ³ä¹æ’­æ”¾åˆ—è¡¨' },
                    { name: 'musicCovers', label: 'éŸ³ä¹å°é¢' },

                    // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®
                    { name: 'smsContacts', label: 'çŸ­ä¿¡è”ç³»äºº' },
                    { name: 'smsMessages', label: 'çŸ­ä¿¡æ¶ˆæ¯' },

                    // æœ€åï¼šæœ€å¤§çš„è¡¨ï¼ˆèŠå¤©æ¶ˆæ¯å’Œç¾¤èŠæ¶ˆæ¯ï¼‰
                    { name: 'chatMessages', label: 'èŠå¤©æ¶ˆæ¯' },
                    { name: 'groupChatMessages', label: 'ç¾¤èŠæ¶ˆæ¯' }
                ];

                let loadedTables = 0;
                const totalTables = tableLoadOrder.length;

                // ğŸ”¥ã€åˆ†æ‰¹åŠ è½½ã€‘é€ä¸ªåŠ è½½æ•°æ®è¡¨
                for (const tableInfo of tableLoadOrder) {
                    try {
                        showToast(`æ­£åœ¨åŠ è½½ ${tableInfo.label}... (${loadedTables + 1}/${totalTables})`, 'info');

                        // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                        if (db[tableInfo.name]) {
                            const data = await db[tableInfo.name].toArray();
                            exportData[tableInfo.name] = data;
                            console.log(`âœ… åŠ è½½ ${tableInfo.label}: ${data.length} æ¡è®°å½•`);
                        } else {
                            console.warn(`âš ï¸ è¡¨ ${tableInfo.name} ä¸å­˜åœ¨ï¼Œè·³è¿‡`);
                            exportData[tableInfo.name] = [];
                        }

                        loadedTables++;

                        // ğŸ”¥ã€å†…å­˜ç®¡ç†ã€‘æ¯åŠ è½½å‡ ä¸ªè¡¨å°±å¼ºåˆ¶åƒåœ¾å›æ”¶
                        if (loadedTables % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 100)); // ç»™æµè§ˆå™¨ä¸€äº›æ—¶é—´
                        }

                    } catch (error) {
                        console.error(`âŒ åŠ è½½ ${tableInfo.label} å¤±è´¥:`, error);
                        exportData[tableInfo.name] = [];
                    }
                }

                showToast('æ­£åœ¨ç”Ÿæˆå¯¼å‡ºæ–‡ä»¶...', 'info');

                // æ˜¾ç¤ºå¯¼å‡ºç»Ÿè®¡
                const stats = [];
                // åŸºç¡€æ•°æ®ç»Ÿè®¡
                if (exportData.characters?.length) stats.push(`è§’è‰²: ${exportData.characters.length}ä¸ª`);
                if (exportData.chatMessages?.length) stats.push(`æ¶ˆæ¯: ${exportData.chatMessages.length}æ¡`);
                if (exportData.personas?.length) stats.push(`é¢å…·: ${exportData.personas.length}ä¸ª`);
                if (exportData.contacts?.length) stats.push(`è”ç³»äºº: ${exportData.contacts.length}ä¸ª`);
                // è¡¨æƒ…åŒ…ç³»ç»Ÿ
                if (exportData.customEmojis?.length) stats.push(`è¡¨æƒ…: ${exportData.customEmojis.length}ä¸ª`);
                if (exportData.recentEmojis?.length) stats.push(`æœ€è¿‘è¡¨æƒ…: ${exportData.recentEmojis.length}ä¸ª`);
                // ä¸–ç•Œä¹¦ç³»ç»Ÿ
                if (exportData.worldbooks?.length) stats.push(`ä¸–ç•Œä¹¦: ${exportData.worldbooks.length}ä¸ª`);
                if (exportData.worldbookEntries?.length) stats.push(`ä¸–ç•Œä¹¦æ¡ç›®: ${exportData.worldbookEntries.length}æ¡`);
                // ç¾¤èŠç³»ç»Ÿ
                if (exportData.groupChats?.length) {
                    stats.push(`ç¾¤èŠ: ${exportData.groupChats.length}ä¸ª`);

                    // ğŸ”¥ã€ä¿®å¤ã€‘ç»Ÿè®¡ç¾¤èŠæ¶ˆæ¯æ•°é‡ - ä»chatMessagesä¸­ç­›é€‰ç¾¤èŠæ¶ˆæ¯
                    let groupChatMessageCount = 0;
                    if (exportData.chatMessages?.length && exportData.groupChats?.length) {
                        const groupChatIds = exportData.groupChats.map(g => g.id);
                        groupChatMessageCount = exportData.chatMessages.filter(msg =>
                            groupChatIds.includes(msg.characterId)
                        ).length;
                    }
                    if (groupChatMessageCount > 0) {
                        stats.push(`ç¾¤èŠæ¶ˆæ¯: ${groupChatMessageCount}æ¡`);
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘ç»Ÿè®¡ç¾¤èŠæˆå‘˜æ•°é‡ - ä»ç¾¤èŠå¯¹è±¡çš„memberså±æ€§ä¸­ç»Ÿè®¡
                    let groupMemberCount = 0;
                    if (exportData.groupChats?.length) {
                        exportData.groupChats.forEach(group => {
                            if (group.members && Array.isArray(group.members)) {
                                groupMemberCount += group.members.length;
                            }
                        });
                    }
                    if (groupMemberCount > 0) {
                        stats.push(`ç¾¤èŠæˆå‘˜: ${groupMemberCount}ä¸ª`);
                    }
                }
                // åŠ¨æ€ç³»ç»Ÿ
                if (exportData.moments?.length) stats.push(`åŠ¨æ€: ${exportData.moments.length}æ¡`);
                if (exportData.momentComments?.length) stats.push(`åŠ¨æ€è¯„è®º: ${exportData.momentComments.length}æ¡`);
                // è®°å¿†ç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘å®Œæ•´çš„è®°å¿†ç³»ç»Ÿç»Ÿè®¡
                if (exportData.workingMemory?.length) stats.push(`å·¥ä½œè®°å¿†: ${exportData.workingMemory.length}æ¡`);
                if (exportData.episodicMemory?.length) stats.push(`æƒ…èŠ‚è®°å¿†: ${exportData.episodicMemory.length}æ¡`);
                if (exportData.episodicMemories?.length) stats.push(`æƒ…æ™¯è®°å¿†: ${exportData.episodicMemories.length}æ¡`);
                if (exportData.memorySummaries?.length) stats.push(`è®°å¿†æ€»ç»“: ${exportData.memorySummaries.length}æ¡`);
                if (exportData.memoryEvents?.length) stats.push(`è®°å¿†äº‹ä»¶: ${exportData.memoryEvents.length}æ¡`);
                if (exportData.coreMemory?.length) stats.push(`æ ¸å¿ƒè®°å¿†: ${exportData.coreMemory.length}æ¡`);
                if (exportData.coreMemories?.length) stats.push(`æ ¸å¿ƒè®°å¿†åº“: ${exportData.coreMemories.length}æ¡`);
                if (exportData.crossAppTimeline?.length) stats.push(`æ—¶é—´çº¿: ${exportData.crossAppTimeline.length}æ¡`);
                // æ‹‰é»‘å’Œå¥½å‹ç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘å®Œæ•´çš„æ‹‰é»‘ç³»ç»Ÿç»Ÿè®¡
                if (exportData.blacklist?.length) stats.push(`æ‹‰é»‘åˆ—è¡¨: ${exportData.blacklist.length}æ¡`);
                if (exportData.blockedCharacters?.length) stats.push(`è¢«æ‹‰é»‘è§’è‰²: ${exportData.blockedCharacters.length}ä¸ª`);
                if (exportData.friendRequests?.length) stats.push(`å¥½å‹ç”³è¯·: ${exportData.friendRequests.length}æ¡`);
                if (exportData.characterStatus?.length) stats.push(`è§’è‰²çŠ¶æ€: ${exportData.characterStatus.length}æ¡`);
                // æ—¥è®°ç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘è§’è‰²æ—¥è®°ç»Ÿè®¡
                if (exportData.characterDiaries?.length) stats.push(`è§’è‰²æ—¥è®°: ${exportData.characterDiaries.length}æ¡`);
                // çº¿ä¸‹æ¨¡å¼
                if (exportData.offlineHistoryRecords?.length) stats.push(`çº¿ä¸‹è®°å½•: ${exportData.offlineHistoryRecords.length}æ¡`);
                if (exportData.offlinePresets?.length) stats.push(`çº¿ä¸‹é¢„è®¾: ${exportData.offlinePresets.length}ä¸ª`);
                // éŸ³ä¹ç³»ç»Ÿ
                if (exportData.musicPlaylist?.length) stats.push(`éŸ³ä¹: ${exportData.musicPlaylist.length}é¦–`);
                // è®¾ç½®æ•°æ®
                if (exportData.chatSettings?.length) stats.push(`èŠå¤©è®¾ç½®: ${exportData.chatSettings.length}ä¸ª`);
                if (exportData.wallpapers?.length) stats.push(`å£çº¸: ${exportData.wallpapers.length}ä¸ª`);
                // çºªå¿µæ—¥ç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘çºªå¿µæ—¥ç»Ÿè®¡
                if (exportData.anniversaries?.length) stats.push(`çºªå¿µæ—¥: ${exportData.anniversaries.length}ä¸ª`);
                // æ—¥è®°è®¾ç½® - ğŸ”¥ã€æ–°å¢ã€‘æ—¥è®°è®¾ç½®ç»Ÿè®¡
                if (exportData.diarySettings?.length) stats.push(`æ—¥è®°è®¾ç½®: ${exportData.diarySettings.length}ä¸ª`);
                // å¿ƒå£°ç³»ç»Ÿ - ğŸ”¥ã€æ–°å¢ã€‘å¿ƒå£°ç»Ÿè®¡
                if (exportData.innerThoughts?.length) stats.push(`å¿ƒå£°: ${exportData.innerThoughts.length}æ¡`);
                // ğŸ”¥ã€æ–°å¢ã€‘è®ºå›åŠŸèƒ½ç»Ÿè®¡
                if (exportData.forums?.length) stats.push(`è®ºå›: ${exportData.forums.length}ä¸ª`);
                if (exportData.forumPosts?.length) stats.push(`è®ºå›å¸–å­: ${exportData.forumPosts.length}æ¡`);
                if (exportData.forumReplies?.length) stats.push(`è®ºå›å›å¤: ${exportData.forumReplies.length}æ¡`);
                if (exportData.forumFavorites?.length) stats.push(`è®ºå›æ”¶è—: ${exportData.forumFavorites.length}æ¡`);
                if (exportData.replyLikes?.length) stats.push(`å›å¤ç‚¹èµ: ${exportData.replyLikes.length}æ¡`);
                if (exportData.forumPostImages?.length) stats.push(`è®ºå›å›¾ç‰‡: ${exportData.forumPostImages.length}å¼ `);
                if (exportData.forumMountedWorldbooks?.length) stats.push(`è®ºå›ä¸–ç•Œä¹¦: ${exportData.forumMountedWorldbooks.length}ä¸ª`);

                console.log('å¯¼å‡ºæ•°æ®ç»Ÿè®¡:', stats.join(', '));

                // ğŸ”¥ã€å†…å­˜ä¼˜åŒ–ã€‘ä½¿ç”¨åˆ†å—JSONåºåˆ—åŒ–ï¼Œé¿å…å¤§æ•°æ®é‡å¯¼è‡´å†…å­˜æº¢å‡º
                try {
                    showToast('æ­£åœ¨åºåˆ—åŒ–æ•°æ®...', 'info');

                    // ğŸ”¥ã€æ£€æŸ¥æ•°æ®å¤§å°ã€‘ä¼°ç®—å†…å­˜ä½¿ç”¨
                    const estimatedSize = JSON.stringify(exportData).length;
                    console.log(`ğŸ“Š ä¼°ç®—æ•°æ®å¤§å°: ${(estimatedSize / 1024 / 1024).toFixed(2)} MB`);

                    let dataStr;
                    if (estimatedSize > 50 * 1024 * 1024) { // å¦‚æœè¶…è¿‡50MB
                        showToast('æ•°æ®é‡è¾ƒå¤§ï¼Œä½¿ç”¨ä¼˜åŒ–åºåˆ—åŒ–...', 'info');
                        // ğŸ”¥ã€åˆ†å—åºåˆ—åŒ–ã€‘å¯¹äºå¤§æ•°æ®ï¼Œä½¿ç”¨æ›´èŠ‚çœå†…å­˜çš„æ–¹å¼
                        dataStr = JSON.stringify(exportData, null, 1); // ä½¿ç”¨æ›´å°çš„ç¼©è¿›
                    } else {
                        dataStr = JSON.stringify(exportData, null, 2);
                    }

                    showToast('æ­£åœ¨åˆ›å»ºä¸‹è½½æ–‡ä»¶...', 'info');

                    // ğŸ”¥ã€åˆ†å—åˆ›å»ºBlobã€‘é¿å…ä¸€æ¬¡æ€§åˆ›å»ºå¤§Blob
                    const chunkSize = 1024 * 1024; // 1MB chunks
                    const chunks = [];

                    for (let i = 0; i < dataStr.length; i += chunkSize) {
                        chunks.push(dataStr.slice(i, i + chunkSize));
                        if (chunks.length % 10 === 0) {
                            // æ¯10ä¸ªchunkç»™æµè§ˆå™¨ä¸€äº›æ—¶é—´
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }

                    const dataBlob = new Blob(chunks, { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `å®Œæ•´å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // ğŸ”¥ã€å†…å­˜æ¸…ç†ã€‘å»¶è¿Ÿé‡Šæ”¾URLï¼Œç»™ä¸‹è½½ä¸€äº›æ—¶é—´
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 5000);

                } catch (serializationError) {
                    console.error('âŒ åºåˆ—åŒ–å¤±è´¥:', serializationError);
                    throw new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${serializationError.message}`);
                }

                const statsText = stats.length > 0 ? `\n${stats.join('\n')}` : '';
                showToast(`å¯¼å‡ºæˆåŠŸï¼${statsText}`, 'success');
            } catch (error) {
                console.error('âŒ å®Œæ•´å¯¼å‡ºå¤±è´¥:', error);

                // ğŸ”¥ã€é™çº§å¤„ç†ã€‘å¦‚æœå®Œæ•´å¯¼å‡ºå¤±è´¥ï¼Œæä¾›è½»é‡çº§å¯¼å‡ºé€‰é¡¹
                const fallbackChoice = confirm(
                    `å®Œæ•´å¯¼å‡ºå¤±è´¥: ${error.message}\n\n` +
                    `è¿™å¯èƒ½æ˜¯å› ä¸ºæ•°æ®é‡è¿‡å¤§å¯¼è‡´çš„å†…å­˜ä¸è¶³ã€‚\n\n` +
                    `æ˜¯å¦å°è¯•è½»é‡çº§å¯¼å‡ºï¼Ÿ\n` +
                    `ï¼ˆåŒ…å«æ ¸å¿ƒæ•°æ®ï¼šè§’è‰²ã€æ¶ˆæ¯ã€è®°å¿†ç³»ç»Ÿã€ä¸–ç•Œä¹¦ã€è®ºå›ç­‰ï¼‰`
                );

                if (fallbackChoice) {
                    try {
                        await exportLightweightData();
                    } catch (fallbackError) {
                        console.error('âŒ è½»é‡çº§å¯¼å‡ºä¹Ÿå¤±è´¥:', fallbackError);
                        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·å°è¯•æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡è¯•', 'error');
                    }
                } else {
                    showToast('å¯¼å‡ºå·²å–æ¶ˆ', 'warning');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è½»é‡çº§å¯¼å‡ºåŠŸèƒ½ - åŒ…å«æ ¸å¿ƒæ•°æ®å’Œè®°å¿†ç³»ç»Ÿ
        async function exportLightweightData() {
            try {
                showToast('æ­£åœ¨è¿›è¡Œè½»é‡çº§å¯¼å‡º...', 'info');

                const coreData = {
                    version: '6.1-lite',
                    exportTime: new Date().toISOString(),
                    exportType: 'lightweight',

                    // æ ¸å¿ƒè§’è‰²å’ŒèŠå¤©æ•°æ®
                    characters: await db.characters.toArray(),
                    chatMessages: await db.chatMessages.toArray(),
                    chatSettings: await db.chatSettings.toArray(),
                    personas: await db.personas.toArray(),
                    contacts: await db.contacts.toArray(),

                    // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠç³»ç»Ÿæ•°æ®
                    groupChats: await db.groupChats.toArray(),
                    groupChatMessages: await db.groupChatMessages.toArray(),
                    groupChatMembers: await db.groupChatMembers.toArray(),

                    // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®
                    smsContacts: await db.smsContacts.toArray(),
                    smsMessages: await db.smsMessages.toArray(),

                    // ä¸–ç•Œä¹¦ç³»ç»Ÿ
                    worldbooks: await db.worldbooks.toArray(),
                    worldbookEntries: await db.worldbookEntries.toArray(),

                    // ğŸ”¥ã€é‡è¦ã€‘è®°å¿†ç³»ç»Ÿ - å®Œæ•´ä¿ç•™
                    workingMemory: await db.workingMemory.toArray(),
                    episodicMemory: await db.episodicMemory.toArray(),
                    episodicMemories: await db.episodicMemories.toArray(),
                    memorySummaries: await db.memorySummaries.toArray(),
                    memoryEvents: await db.memoryEvents.toArray(),
                    coreMemory: await db.coreMemory.toArray(),
                    coreMemories: await db.coreMemories.toArray(),
                    crossAppTimeline: await db.crossAppTimeline.toArray(),

                    // è®ºå›æ ¸å¿ƒæ•°æ®
                    forums: await db.forums.toArray(),
                    forumPosts: await db.forumPosts.toArray(),
                    forumReplies: await db.forumReplies.toArray(),
                    forumFavorites: await db.forumFavorites.toArray(),

                    // è§’è‰²ç›¸å…³é‡è¦æ•°æ®
                    characterGroups: await db.characterGroups.toArray(),
                    characterDiaries: await db.characterDiaries.toArray(),
                    innerThoughts: await db.innerThoughts.toArray(),

                    // åŸºç¡€è®¾ç½®
                    apiSettings: await db.apiSettings.toArray(),
                    globalSettings: await db.globalSettings.toArray(),

                    // çºªå¿µæ—¥ï¼ˆç”¨æˆ·é‡è¦æ•°æ®ï¼‰
                    anniversaries: await db.anniversaries.toArray(),

                    // æ—¥è®°è®¾ç½®ï¼ˆç”¨æˆ·ä¸ªæ€§åŒ–è®¾ç½®ï¼‰
                    diarySettings: await db.diarySettings.toArray()
                };

                const dataStr = JSON.stringify(coreData, null, 1);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `è½»é‡çº§å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => URL.revokeObjectURL(url), 3000);

                // ç»Ÿè®¡å¯¼å‡ºçš„æ•°æ®
                const stats = [];
                if (coreData.characters?.length) stats.push(`è§’è‰²: ${coreData.characters.length}ä¸ª`);
                if (coreData.chatMessages?.length) stats.push(`æ¶ˆæ¯: ${coreData.chatMessages.length}æ¡`);
                if (coreData.workingMemory?.length || coreData.episodicMemory?.length || coreData.coreMemory?.length) {
                    const memoryCount = (coreData.workingMemory?.length || 0) +
                                      (coreData.episodicMemory?.length || 0) +
                                      (coreData.coreMemory?.length || 0) +
                                      (coreData.episodicMemories?.length || 0) +
                                      (coreData.coreMemories?.length || 0);
                    stats.push(`è®°å¿†: ${memoryCount}æ¡`);
                }
                if (coreData.worldbooks?.length) stats.push(`ä¸–ç•Œä¹¦: ${coreData.worldbooks.length}ä¸ª`);
                if (coreData.forums?.length) stats.push(`è®ºå›: ${coreData.forums.length}ä¸ª`);

                const statsText = stats.length > 0 ? `\n${stats.join(', ')}` : '';
                showToast(`è½»é‡çº§å¯¼å‡ºæˆåŠŸï¼${statsText}`, 'success');

            } catch (error) {
                console.error('âŒ è½»é‡çº§å¯¼å‡ºå¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºæ¸…ç†é€‰é¡¹
        function showCleanupOptions() {
            // å…ˆè®¡ç®—å„ç±»æ•°æ®çš„å¤§å°
            let offlineBackupSize = 0;
            let customBackgroundSize = 0;

            Object.keys(localStorage).forEach(key => {
                const size = (localStorage.getItem(key) || '').length;
                if (key.startsWith('offlineUISettings_') && key.includes('window_')) {
                    offlineBackupSize += size;
                } else if (key === 'diary-custom-background') {
                    customBackgroundSize += size;
                }
            });

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            const options = [
                `1. åˆ é™¤ç©ºèŠå¤©è®°å½•`,
                `2. å‹ç¼©æ‰€æœ‰å›¾ç‰‡ (å¤´åƒ/èƒŒæ™¯/èŠå¤©å›¾ç‰‡/è¡¨æƒ…åŒ…)`,
                `3. æ¸…ç†çº¿ä¸‹æ¨¡å¼å¤‡ä»½ (${formatSize(offlineBackupSize)}) â­æ¨è`,
                `4. åˆ é™¤è‡ªå®šä¹‰èƒŒæ™¯ (${formatSize(customBackgroundSize)})`
            ];

            const choice = prompt(`é€‰æ‹©æ¸…ç†é¡¹ç›®ï¼š\n${options.join('\n')}\n\nè¾“å…¥æ•°å­—ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œæ¨èé€‰æ‹©3ï¼š`);
            if (choice) executeCleanupOptions(choice);
        }

        // æ‰§è¡Œæ¸…ç†
        async function executeCleanupOptions(choice) {
            const selections = choice.split(',').map(s => parseInt(s.trim())).filter(n => n >= 1 && n <= 4);
            if (!selections.length) return;

            showToast('æ¸…ç†ä¸­...', 'info');
            let count = 0;
            let freedSpace = 0;

            for (const option of selections) {
                switch (option) {
                    case 1:
                        // åˆ é™¤ç©ºèŠå¤©è®°å½•
                        Object.keys(chatMessages).forEach(id => {
                            if (!chatMessages[id]?.length) {
                                delete chatMessages[id];
                                count++;
                            }
                        });
                        break;
                    case 2:
                        // å‹ç¼©æ‰€æœ‰å›¾ç‰‡
                        const compressResult = await compressAllImagesEnhanced();
                        count += compressResult.count;
                        freedSpace += compressResult.savedSpace;
                        break;
                    case 3:
                        // æ¸…ç†çº¿ä¸‹æ¨¡å¼å¤‡ä»½ï¼ˆæœ€é‡è¦çš„æ¸…ç†é¡¹ï¼‰
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key?.startsWith('offlineUISettings_') && key.includes('window_')) {
                                freedSpace += (localStorage.getItem(key) || '').length;
                                localStorage.removeItem(key);
                                count++;
                            }
                        }
                        break;
                    case 4:
                        // åˆ é™¤è‡ªå®šä¹‰èƒŒæ™¯
                        const bgKey = 'diary-custom-background';
                        if (localStorage.getItem(bgKey)) {
                            freedSpace += (localStorage.getItem(bgKey) || '').length;
                            localStorage.removeItem(bgKey);
                            count++;

                            // åŒæ—¶æ¸…ç†è§’è‰²ç‰¹å®šçš„è‡ªå®šä¹‰èƒŒæ™¯
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const key = localStorage.key(i);
                                if (key?.includes('-custom-background')) {
                                    freedSpace += (localStorage.getItem(key) || '').length;
                                    localStorage.removeItem(key);
                                    count++;
                                }
                            }
                        }
                        break;
                }
            }

            await saveChatSettings();
            // ğŸ”¥ã€ä¼˜åŒ–ã€‘å­˜å‚¨æ¸…ç†ä½¿ç”¨é«˜æ•ˆä¿å­˜
            try {
                const activeCharacterIds = Object.keys(chatMessages).filter(id =>
                    chatMessages[id] && chatMessages[id].length > 0);
                await saveChatMessagesImmediate(activeCharacterIds);
                console.log('âœ… [é«˜æ•ˆå­˜å‚¨æ¸…ç†] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('å­˜å‚¨æ¸…ç†ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                await saveChatMessages();
            }
            calculateStorageUsage();

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            showToast(`æ¸…ç†å®Œæˆï¼å¤„ç† ${count} é¡¹ï¼Œé‡Šæ”¾ ${formatSize(freedSpace)} ç©ºé—´`, 'success');
        }

        // å‹ç¼©å›¾ç‰‡ï¼ˆåŸç‰ˆï¼Œä¿æŒå…¼å®¹æ€§ï¼‰
        async function compressAllImages() {
            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            const result = await compressAllImagesEnhanced();
            showToast(`å‹ç¼©å®Œæˆï¼å¤„ç† ${result.count} å¼ å›¾ç‰‡ï¼ŒèŠ‚çœ ${formatSize(result.savedSpace)} ç©ºé—´`, 'success');
        }

        // å¢å¼ºç‰ˆå›¾ç‰‡å‹ç¼©å‡½æ•°
        async function compressAllImagesEnhanced() {
            let count = 0;
            let savedSpace = 0;

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            try {
                // 1. å‹ç¼©è§’è‰²å¤´åƒ
                for (const char of characters) {
                    if (char.avatarUrl?.length > 30000) { // é™ä½é˜ˆå€¼ï¼Œå‹ç¼©æ›´å¤šå›¾ç‰‡
                        const originalSize = char.avatarUrl.length;
                        char.avatarUrl = await compressImage(char.avatarUrl, 120, 0.7); // æ›´é«˜å‹ç¼©
                        savedSpace += originalSize - char.avatarUrl.length;
                        count++;
                    }
                }
                await saveCharacters();

                // 2. å‹ç¼©èŠå¤©è®¾ç½®ä¸­çš„å¤´åƒ
                for (const id of Object.keys(chatSettings)) {
                    const settings = chatSettings[id];
                    if (settings?.aiChatAvatar?.length > 30000) {
                        const originalSize = settings.aiChatAvatar.length;
                        settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 120, 0.7);
                        savedSpace += originalSize - settings.aiChatAvatar.length;
                        count++;
                    }
                    if (settings?.myChatAvatar?.length > 30000) {
                        const originalSize = settings.myChatAvatar.length;
                        settings.myChatAvatar = await compressImage(settings.myChatAvatar, 120, 0.7);
                        savedSpace += originalSize - settings.myChatAvatar.length;
                        count++;
                    }
                }
                await saveChatSettings();

                // 3. å‹ç¼©è‡ªå®šä¹‰èƒŒæ™¯
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key?.includes('-custom-background') || key === 'diary-custom-background') {
                        const bgData = localStorage.getItem(key);
                        if (bgData && bgData.length > 50000) { // èƒŒæ™¯å›¾ç‰‡é€šå¸¸æ›´å¤§
                            const originalSize = bgData.length;
                            const compressedBg = await compressImage(bgData, 800, 0.8); // èƒŒæ™¯ä¿æŒè¾ƒé«˜è´¨é‡
                            localStorage.setItem(key, compressedBg);
                            savedSpace += originalSize - compressedBg.length;
                            count++;
                        }
                    }
                }

                // 4. å‹ç¼©èŠå¤©è®°å½•ä¸­çš„å›¾ç‰‡
                for (const characterId of Object.keys(chatMessages)) {
                    const messages = chatMessages[characterId] || [];
                    let messagesChanged = false;

                    for (const message of messages) {
                        // å‹ç¼©æ¶ˆæ¯ä¸­çš„å›¾ç‰‡
                        if (message.image && message.image.length > 30000) {
                            const originalSize = message.image.length;
                            message.image = await compressImage(message.image, 400, 0.8);
                            savedSpace += originalSize - message.image.length;
                            count++;
                            messagesChanged = true;
                        }

                        // å‹ç¼©å¤šæ¨¡æ€æ¶ˆæ¯ä¸­çš„å›¾ç‰‡
                        if (Array.isArray(message.content)) {
                            for (const part of message.content) {
                                if (part.type === 'image_url' && part.image_url?.url?.length > 30000) {
                                    const originalSize = part.image_url.url.length;
                                    part.image_url.url = await compressImage(part.image_url.url, 400, 0.8);
                                    savedSpace += originalSize - part.image_url.url.length;
                                    count++;
                                    messagesChanged = true;
                                }
                            }
                        }
                    }

                    if (messagesChanged) {
                        await saveChatMessages(characterId);
                    }
                }

                // 5. å‹ç¼©è¡¨æƒ…åŒ…ï¼ˆå¦‚æœå­˜å‚¨åœ¨localStorageä¸­ï¼‰
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key?.includes('emoji') || key?.includes('sticker')) {
                        const emojiData = localStorage.getItem(key);
                        if (emojiData && emojiData.length > 20000) {
                            try {
                                const originalSize = emojiData.length;
                                const compressedEmoji = await compressImage(emojiData, 200, 0.8);
                                localStorage.setItem(key, compressedEmoji);
                                savedSpace += originalSize - compressedEmoji.length;
                                count++;
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡
                                continue;
                            }
                        }
                    }
                }

                calculateStorageUsage();

                return { count, savedSpace };

            } catch (error) {
                console.error('å›¾ç‰‡å‹ç¼©è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                return { count, savedSpace };
            }
        }

        // è°ƒè¯•ç”¨ï¼šåˆ—å‡ºæ‰€æœ‰è§’è‰²IDå’Œåç§°ï¼Œå¸®åŠ©è¯†åˆ«å¹½çµè§’è‰²
        async function debugListAllCharacters() {
            try {
                console.log('=== æ‰€æœ‰è§’è‰²æ•°æ® ===');

                // 1. æ•°æ®åº“ä¸­çš„è§’è‰²
                const dbChars = await db.characters.toArray();
                console.log('æ•°æ®åº“è§’è‰²è¡¨:', dbChars.map(c => `${c.name} (ID: ${c.id})`));

                // 2. å†…å­˜ä¸­çš„è§’è‰²
                if (window.characters) {
                    console.log('å†…å­˜è§’è‰²åˆ—è¡¨:', window.characters.map(c => `${c.name} (ID: ${c.id})`));
                }

                // 3. è”ç³»äººåˆ—è¡¨
                if (window.contacts) {
                    console.log('è”ç³»äººIDåˆ—è¡¨:', window.contacts);
                }

                // 4. åŠ¨æ€è¯„è®ºä¸­çš„è§’è‰²
                const comments = await db.momentComments.toArray();
                const commentAuthors = [...new Set(comments.map(c => `${c.nickname} (ID: ${c.authorId})`))];
                console.log('åŠ¨æ€è¯„è®ºä¸­çš„è§’è‰²:', commentAuthors);

                // 5. åŠ¨æ€ç‚¹èµä¸­çš„è§’è‰²
                const likes = await db.momentLikes.toArray();
                const likeAuthors = [...new Set(likes.map(l => `${l.name} (ID: ${l.authorId})`))];
                console.log('åŠ¨æ€ç‚¹èµä¸­çš„è§’è‰²:', likeAuthors);

                return {dbChars, comments, likes};
            } catch (error) {
                console.error('è°ƒè¯•å¤±è´¥:', error);
            }
        }

        // è°ƒè¯•ç”¨ï¼šç²¾ç¡®åˆ é™¤æŒ‡å®šIDçš„è§’è‰²æ•°æ®
        async function debugDeleteCharacterById(characterId) {
            if (!characterId) {
                console.log('ç”¨æ³•: debugDeleteCharacterById("è§’è‰²ID")');
                return;
            }

            try {
                console.log(`å¼€å§‹åˆ é™¤è§’è‰²ID: ${characterId}`);
                let deleteCount = 0;

                // 1. ä»åŠ¨æ€è¯„è®ºä¸­åˆ é™¤
                const comments = await db.momentComments.where('authorId').equals(characterId).toArray();
                for (const comment of comments) {
                    await db.momentComments.delete(comment.id);
                    deleteCount++;
                    console.log(`åˆ é™¤è¯„è®º: ${comment.nickname} - ${comment.text}`);
                }

                // 2. ä»åŠ¨æ€ç‚¹èµä¸­åˆ é™¤
                const likes = await db.momentLikes.where('authorId').equals(characterId).toArray();
                for (const like of likes) {
                    await db.momentLikes.delete([like.momentId, like.authorId]);
                    deleteCount++;
                    console.log(`åˆ é™¤ç‚¹èµ: ${like.name}`);
                }

                // 3. ä»å…¶ä»–è¡¨ä¸­åˆ é™¤
                const chatMsgs = await db.chatMessages.where('characterId').equals(characterId).toArray();
                for (const msg of chatMsgs) {
                    await db.chatMessages.delete(msg.id);
                    deleteCount++;
                }

                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId === characterId) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }

                await db.characters.delete(characterId);
                deleteCount++;

                // 4. ä»å†…å­˜æ•°ç»„ä¸­åˆ é™¤
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => id !== characterId);
                    await saveContacts();
                }
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.id !== characterId);
                }

                console.log(`åˆ é™¤å®Œæˆï¼å…±åˆ é™¤ ${deleteCount} æ¡ç›¸å…³æ•°æ®`);

                // åˆ·æ–°ç•Œé¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();

            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
            }
        }

        // å¼ºåˆ¶åˆ é™¤æŒ‡å®šè§’è‰²ï¼ˆç”¨äºæ¸…ç†å¹½çµè§’è‰²ï¼‰
        async function forceDeleteCharacter() {
            const characterName = prompt('è¾“å…¥è¦å¼ºåˆ¶åˆ é™¤çš„è§’è‰²åç§°ï¼ˆå¦‚ï¼šæ–¹å›ï¼‰ï¼š');
            if (!characterName || !characterName.trim()) return;

            try {
                showToast(`æ­£åœ¨å¼ºåˆ¶åˆ é™¤è§’è‰² "${characterName}"...`, 'info');
                let deleteCount = 0;

                // 1. ä»åŠ¨æ€è¯„è®ºä¸­åˆ é™¤
                const comments = await db.momentComments.toArray();
                for (const comment of comments) {
                    if (comment.nickname === characterName || (comment.authorId && comment.authorId.includes(characterName))) {
                        await db.momentComments.delete(comment.id);
                        deleteCount++;
                        console.log(`åˆ é™¤è¯„è®ºï¼š${comment.nickname} - ${comment.text}`);
                    }
                }

                // 2. ä»åŠ¨æ€ç‚¹èµä¸­åˆ é™¤
                const likes = await db.momentLikes.toArray();
                for (const like of likes) {
                    if (like.name === characterName || (like.authorId && like.authorId.includes(characterName))) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        deleteCount++;
                        console.log(`åˆ é™¤ç‚¹èµï¼š${like.name}`);
                    }
                }

                // 3. ä»èŠå¤©æ¶ˆæ¯ä¸­åˆ é™¤
                const chatMsgs = await db.chatMessages.toArray();
                for (const msg of chatMsgs) {
                    if (msg.characterId && msg.characterId.includes(characterName)) {
                        await db.chatMessages.delete(msg.id);
                        deleteCount++;
                    }
                }

                // 4. ä»èŠå¤©è®¾ç½®ä¸­åˆ é™¤
                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId && setting.characterId.includes(characterName)) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }

                // 5. ä»charactersè¡¨ä¸­åˆ é™¤
                const chars = await db.characters.toArray();
                for (const char of chars) {
                    if (char.name === characterName || char.id.includes(characterName)) {
                        await db.characters.delete(char.id);
                        deleteCount++;
                        console.log(`åˆ é™¤è§’è‰²ï¼š${char.name} (${char.id})`);
                    }
                }

                // 6. ä»è”ç³»äººåˆ—è¡¨ä¸­åˆ é™¤
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => !id.includes(characterName));
                    await saveContacts();
                }

                // 7. æ¸…ç†å†…å­˜ä¸­çš„æ•°æ®
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.name !== characterName);
                }
                if (window.chatMessages) {
                    Object.keys(window.chatMessages).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatMessages[key];
                        }
                    });
                }
                if (window.chatSettings) {
                    Object.keys(window.chatSettings).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatSettings[key];
                        }
                    });
                }

                // åˆ·æ–°ç•Œé¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();

                showToast(`å¼ºåˆ¶åˆ é™¤å®Œæˆï¼å…±åˆ é™¤ ${deleteCount} æ¡ç›¸å…³æ•°æ®`, 'success');
                console.log(`å¼ºåˆ¶åˆ é™¤è§’è‰² "${characterName}" å®Œæˆï¼Œåˆ é™¤äº† ${deleteCount} æ¡è®°å½•`);

            } catch (error) {
                console.error('å¼ºåˆ¶åˆ é™¤å¤±è´¥:', error);
                showToast('å¼ºåˆ¶åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç†å­¤ç«‹è”ç³»äººå’Œé‡å¤æ•°æ®
        async function cleanupOrphanedContacts() {
            try {
                showToast('æ­£åœ¨æ¸…ç†å­¤ç«‹æ•°æ®...', 'info');

                let cleanupCount = 0;

                // 1. æ¸…ç†è”ç³»äººåˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„è§’è‰²ID
                const validCharacterIds = characters.map(char => char.id);
                const originalContactsLength = contacts.length;
                contacts = contacts.filter(contactId => {
                    const isValid = validCharacterIds.includes(contactId);
                    if (!isValid) cleanupCount++;
                    return isValid;
                });

                // 2. ä»æ•°æ®åº“ä¸­æ¸…ç†å­¤ç«‹çš„è”ç³»äººè®°å½•
                const dbContacts = await db.contacts.toArray();
                for (const contact of dbContacts) {
                    if (!validCharacterIds.includes(contact.characterId)) {
                        await db.contacts.delete(contact.id);
                        cleanupCount++;
                    }
                }

                // 3. æ¸…ç†èŠå¤©æ¶ˆæ¯ä¸­ä¸å­˜åœ¨è§’è‰²çš„è®°å½•
                const chatMessageKeys = Object.keys(chatMessages);
                for (const characterId of chatMessageKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatMessages[characterId];
                        cleanupCount++;
                    }
                }

                // 4. æ¸…ç†æ•°æ®åº“ä¸­å­¤ç«‹çš„èŠå¤©æ¶ˆæ¯
                const dbChatMessages = await db.chatMessages.toArray();
                for (const msgRecord of dbChatMessages) {
                    if (!validCharacterIds.includes(msgRecord.characterId)) {
                        await db.chatMessages.delete(msgRecord.id);
                        cleanupCount++;
                    }
                }

                // 5. æ¸…ç†èŠå¤©è®¾ç½®ä¸­ä¸å­˜åœ¨è§’è‰²çš„è®°å½•
                const chatSettingsKeys = Object.keys(chatSettings);
                for (const characterId of chatSettingsKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatSettings[characterId];
                        cleanupCount++;
                    }
                }

                // 6. æ¸…ç†æ•°æ®åº“ä¸­å­¤ç«‹çš„èŠå¤©è®¾ç½®
                const dbChatSettings = await db.chatSettings.toArray();
                for (const setting of dbChatSettings) {
                    if (!validCharacterIds.includes(setting.characterId)) {
                        await db.chatSettings.delete(setting.id);
                        cleanupCount++;
                    }
                }

                // 7. æ¸…ç†åŠ¨æ€è¯„è®ºä¸­ä¸å­˜åœ¨è§’è‰²çš„è®°å½•
                const dbMomentComments = await db.momentComments.toArray();
                for (const comment of dbMomentComments) {
                    // æ¸…ç†authorIdä¸åœ¨è§’è‰²åˆ—è¡¨ä¸­ä¸”ä¸æ˜¯ç”¨æˆ·çš„è¯„è®º
                    if (comment.authorId !== 'user' && !validCharacterIds.includes(comment.authorId)) {
                        await db.momentComments.delete(comment.id);
                        cleanupCount++;
                        console.log(`åˆ é™¤äº†å­¤ç«‹è¯„è®ºï¼š${comment.nickname}(${comment.authorId})`);
                    }
                }

                // 8. æ¸…ç†åŠ¨æ€ç‚¹èµä¸­ä¸å­˜åœ¨è§’è‰²çš„è®°å½•
                const dbMomentLikes = await db.momentLikes.toArray();
                for (const like of dbMomentLikes) {
                    // æ¸…ç†authorIdä¸åœ¨è§’è‰²åˆ—è¡¨ä¸­ä¸”ä¸æ˜¯ç”¨æˆ·çš„ç‚¹èµ
                    if (like.authorId !== 'user' && !validCharacterIds.includes(like.authorId)) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        cleanupCount++;
                        console.log(`åˆ é™¤äº†å­¤ç«‹ç‚¹èµï¼š${like.name}(${like.authorId})`);
                    }
                }

                // 9. ä¿å­˜æ¸…ç†åçš„æ•°æ®
                await Promise.all([
                    saveContacts(),
                    saveChatMessages(),
                    saveChatSettings()
                ]);

                // 10. é‡æ–°æ¸²æŸ“ç•Œé¢
                renderContactList();
                renderMessageList();

                showToast(`æ¸…ç†å®Œæˆï¼å…±æ¸…ç†äº† ${cleanupCount} æ¡å­¤ç«‹æ•°æ®`, 'success');

                console.log('æ¸…ç†ç»“æœ:', {
                    æœ‰æ•ˆè§’è‰²æ•°: validCharacterIds.length,
                    æ¸…ç†å‰è”ç³»äººæ•°: originalContactsLength,
                    æ¸…ç†åè”ç³»äººæ•°: contacts.length,
                    æ€»æ¸…ç†é¡¹ç›®: cleanupCount
                });

            } catch (error) {
                console.error('æ¸…ç†å­¤ç«‹æ•°æ®å¤±è´¥:', error);
                showToast('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            const confirm = prompt('è­¦å‘Šï¼šå°†åˆ é™¤æ‰€æœ‰æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼\nè¾“å…¥"æ¸…ç©ºæ‰€æœ‰æ•°æ®"ç¡®è®¤ï¼š');
            if (confirm !== 'æ¸…ç©ºæ‰€æœ‰æ•°æ®') return;

            try {
                showToast('æ¸…ç©ºä¸­...', 'info');

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“è¡¨
                await Promise.all([
                    // åŸºç¡€æ•°æ®è¡¨
                    db.characters.clear(),
                    db.contacts.clear(),
                    db.chatMessages.clear(),

                    // ç”¨æˆ·é¢å…·ç³»ç»Ÿ
                    db.personas.clear(),

                    // è¡¨æƒ…åŒ…ç³»ç»Ÿ
                    db.customEmojis.clear(),
                    db.recentEmojis.clear(),

                    // ä¸–ç•Œä¹¦ç³»ç»Ÿ
                    db.worldbooks.clear(),
                    db.worldbookEntries.clear(),

                    // ç¾¤èŠç³»ç»Ÿ
                    db.characterGroups.clear(),
                    db.groupChats.clear(),
                    db.groupChatMessages.clear(),
                    db.groupChatMembers.clear(),

                    // åŠ¨æ€ç³»ç»Ÿ
                    db.moments.clear(),
                    db.momentLikes.clear(),
                    db.momentComments.clear(),
                    db.momentVisibility.clear(),
                    db.momentLocations.clear(),
                    db.momentMentions.clear(),

                    // è®°å¿†ç³»ç»Ÿ
                    db.workingMemory.clear(),
                    db.episodicMemory.clear(),
                    db.episodicMemories.clear(),
                    db.memorySummaries.clear(),
                    db.memoryEvents.clear(),
                    db.coreMemory.clear(),
                    db.coreMemories.clear(),
                    db.crossAppTimeline.clear(),

                    // æ‹‰é»‘å’Œå¥½å‹ç³»ç»Ÿ
                    db.blacklist.clear(),
                    db.blockedCharacters.clear(),
                    db.friendRequests.clear(),
                    db.characterStatus.clear(),

                    // æ—¥è®°ç³»ç»Ÿ
                    db.characterDiaries.clear(),
                    db.diarySettings.clear(),

                    // çº¿ä¸‹æ¨¡å¼ç³»ç»Ÿ
                    db.offlineHistoryRecords.clear(),
                    db.offlineUISettings.clear(),
                    db.offlinePresets.clear(),

                    // éŸ³ä¹æ’­æ”¾å™¨ç³»ç»Ÿ
                    db.musicPlaylist.clear(),
                    db.musicCovers.clear(),

                    // è®¾ç½®å’Œé…ç½®
                    db.apiSettings.clear(),
                    db.globalSettings.clear(),
                    db.wallpapers.clear(),
                    db.appIcons.clear(),
                    db.chatSettings.clear(),

                    // å¿ƒå£°ç³»ç»Ÿ
                    db.innerThoughts.clear(),

                    // è®ºå›åŠŸèƒ½ç›¸å…³è¡¨
                    db.forums.clear(),
                    db.forumPosts.clear(),
                    db.forumReplies.clear(),
                    db.forumFavorites.clear(),
                    db.replyLikes.clear(),
                    db.forumPostImages.clear(),
                    db.forumMountedWorldbooks.clear(),

                    // çŸ­ä¿¡åº”ç”¨ç‹¬ç«‹æ•°æ®è¡¨
                    db.smsContacts.clear(),
                    db.smsMessages.clear(),

                    // çºªå¿µæ—¥å’Œçº¦å®šç³»ç»Ÿ
                    db.anniversaries.clear(),
                    db.appointments.clear(),

                    // è¶³è¿¹åŠŸèƒ½
                    db.characterFootprints.clear(),
                    db.footprintActivities.clear(),

                    // è¡¨æƒ…åŒ…åº“åŠŸèƒ½
                    db.emojiLibraries.clear(),
                    db.emojiLibraryItems.clear(),

                    // éŸ³æ•ˆç³»ç»Ÿ
                    db.soundSettings.clear(),
                    db.characterSounds.clear(),

                    // è‡ªå®šä¹‰ä¸»é¢˜ç³»ç»Ÿ
                    db.globalThemes.clear(),
                    db.chatThemes.clear(),
                    db.themeSettings.clear(),

                    // çª—å£éš”ç¦»èŠå¤©è®¾ç½®
                    db.windowChatSettings.clear()
                ]);

                // ğŸ”¥ã€ä¿®å¤ã€‘é‡ç½®å†…å­˜ä¸­çš„å…¨å±€å˜é‡
                characters = [];
                chatMessages = {};
                chatSettings = {};
                customEmojis = [];
                contacts = [];
                groupChats = [];
                characterGroups = [];
                currentChatCharacter = null;
                currentGroupChat = null;

                // é‡ç½®å…¶ä»–å…¨å±€å˜é‡
                if (typeof personas !== 'undefined') personas = [];
                if (typeof worldbooks !== 'undefined') worldbooks = [];
                if (typeof musicPlaylist !== 'undefined') musicPlaylist = [];
                if (typeof smsMessages !== 'undefined') smsMessages = {};
                if (typeof anniversaries !== 'undefined') anniversaries = [];
                if (typeof appointments !== 'undefined') appointments = [];

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†localStorageä¸­çš„æ‰€æœ‰åº”ç”¨æ•°æ®
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    // æ¸…é™¤æ‰€æœ‰åº”ç”¨ç›¸å…³æ•°æ®ï¼Œä½†ä¿ç•™åŸºç¡€è®¾ç½®
                    if (key && (
                        key.startsWith('chatSettings_') ||
                        key.startsWith('contacts') ||
                        key.startsWith('characters') ||
                        key.startsWith('chatMessages') ||
                        key.startsWith('groupChats') ||
                        key.startsWith('characterGroups') ||
                        key.startsWith('personas') ||
                        key.startsWith('customEmojis') ||
                        key.startsWith('worldbooks') ||
                        key.startsWith('moments') ||
                        key.startsWith('musicPlaylist') ||
                        key.startsWith('smsMessages') ||
                        key.startsWith('anniversaries') ||
                        key.startsWith('appointments') ||
                        key.startsWith('forums') ||
                        key.startsWith('diarySettings_') ||
                        key.startsWith('offlineUISettings_') ||
                        key.startsWith('offlinePresets') ||
                        key.startsWith('footprints_') ||
                        key.startsWith('emojiLibraries') ||
                        key.startsWith('soundSettings') ||
                        key.startsWith('globalCustomTheme') ||
                        key.startsWith('chatTheme_') ||
                        key.startsWith('selectedTheme') ||
                        key.startsWith('windowChatSettings_')
                    )) {
                        localStorage.removeItem(key);
                    }
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ·æ–°æ‰€æœ‰ç›¸å…³ç•Œé¢
                renderCharacterList();
                renderMessageList();
                renderContactList();
                calculateStorageUsage();

                // æ¸…ç©ºåŠ¨æ€åˆ—è¡¨
                const momentsList = document.getElementById('moments-list');
                if (momentsList) momentsList.innerHTML = '';

                // æ¸…ç©ºç¾¤èŠåˆ—è¡¨
                const groupChatsList = document.getElementById('group-chats-list');
                if (groupChatsList) groupChatsList.innerHTML = '';

                // æ¸…ç©ºéŸ³ä¹æ’­æ”¾åˆ—è¡¨
                const musicList = document.getElementById('music-list');
                if (musicList) musicList.innerHTML = '';

                // æ¸…ç©ºè®ºå›åˆ—è¡¨
                const forumsList = document.getElementById('forums-list');
                if (forumsList) forumsList.innerHTML = '';

                // é‡ç½®å½“å‰èŠå¤©çŠ¶æ€
                const chatContent = document.getElementById('chat-content');
                if (chatContent) chatContent.innerHTML = '';

                // é‡ç½®åº”ç”¨æ ‡é¢˜
                const appTitle = document.querySelector('.app-title');
                if (appTitle) appTitle.textContent = 'èŠå¤©';

                showToast('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'success');
                console.log('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼ŒåŒ…æ‹¬è§’è‰²ã€èŠå¤©è®°å½•ã€ç¾¤èŠã€åŠ¨æ€ã€è®ºå›ã€éŸ³ä¹ã€é¢å…·ã€ä¸–ç•Œä¹¦ç­‰æ‰€æœ‰åº”ç”¨æ•°æ®');

                // è¿”å›ä¸»ç•Œé¢
                setTimeout(() => {
                    hideApp('data-management-screen');
                    hideApp('settings-screen');
                    showApp('chat-screen');
                }, 2000);
            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                showToast('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡å¤å‡½æ•°å·²åˆ é™¤

        // è½¬è´¦ç›¸å…³å˜é‡
        let currentTransferMsg = null;

        // å¤„ç†ç”¨æˆ·å‘é€ç»™AIçš„è½¬è´¦ - ç®€åŒ–ç‰ˆæœ¬ï¼Œç±»ä¼¼ä»£ä»˜å¤„ç†
        async function processUserTransfer(userTransferMsg, aiMessages, characterId) {
            console.log('ğŸš€ [è½¬è´¦å¤„ç†] å¼€å§‹å¤„ç†AIå¯¹è½¬è´¦çš„å›å¤:', {
                userTransferMsg,
                aiMessages,
                characterId
            });

            if (!userTransferMsg || !characterId) {
                console.log('âŒ [è½¬è´¦å¤„ç†] é€€å‡ºï¼šç¼ºå°‘å¿…è¦å‚æ•°');
                return;
            }

            // ğŸ”¥ã€æ”¹è¿›ã€‘åˆ†æAIå›å¤ï¼Œæ”¯æŒJSONæŒ‡ä»¤å’Œå…³é”®è¯ä¸¤ç§æ–¹å¼
            let transferAction = null;
            let fullAiResponse = '';

            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ˜ç¡®çš„JSONæŒ‡ä»¤
            for (const msgData of aiMessages) {
                if (typeof msgData === 'object' && msgData.type === 'transfer_action') {
                    transferAction = msgData.action; // 'accept' æˆ– 'reject'
                    console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] æ£€æµ‹åˆ°æ˜ç¡®çš„è½¬è´¦æŒ‡ä»¤:', msgData);
                    break;
                }

                // åŒæ—¶æ”¶é›†æ–‡æœ¬å†…å®¹ç”¨äºå…³é”®è¯åˆ†æ
                if (typeof msgData === 'string') {
                    fullAiResponse += msgData + ' ';
                } else if (typeof msgData === 'object' && msgData.content) {
                    fullAiResponse += msgData.content + ' ';
                }
            }
            fullAiResponse = fullAiResponse.trim().toLowerCase();
            console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] AIå®Œæ•´å›å¤å†…å®¹:', fullAiResponse);

            // æ£€æµ‹AIæ˜¯å¦æ¥å—è½¬è´¦
            const acceptKeywords = [
                'æ”¶ä¸‹äº†', 'æ”¶ä¸‹', 'æ”¶æ¬¾', 'æ¥å—', 'ç¡®è®¤æ”¶æ¬¾', 'å·²æ”¶æ¬¾',
                'æ”¶åˆ°äº†', 'æ”¶åˆ°', 'æ”¶äº†', 'è¦äº†', 'æ‹¿äº†', 'æ¥æ”¶äº†', 'æ¥æ”¶',
                'è°¢è°¢', 'æ„Ÿè°¢', 'å¤šè°¢', 'å¤ªå¥½äº†', 'å¥½çš„', 'å¯ä»¥', 'è¡Œ'
            ];

            // æ£€æµ‹AIæ˜¯å¦æ‹’ç»è½¬è´¦
            const rejectKeywords = [
                'é€€å›', 'æ‹’ç»', 'ä¸æ”¶', 'ä¸è¦', 'ä¸éœ€è¦', 'ä¸èƒ½æ”¶',
                'é€€ç»™ä½ ', 'ä¸ç”¨ç»™', 'ç®—äº†', 'è‡ªå·±ç•™ç€', 'æˆ‘ä¸è¦',
                'æ‹¿ç€', 'ç•™ç€', 'ä¸ç”¨', 'ä¸è¡Œ', 'ä¸å¯ä»¥'
            ];

            // ğŸ”¥ã€æ”¹è¿›ã€‘å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡ä»¤ï¼Œåˆ™ä½¿ç”¨å…³é”®è¯åŒ¹é…
            let isAccepted = false;
            let isRejected = false;
            let matchedKeywords = [];

            if (transferAction) {
                // æœ‰æ˜ç¡®æŒ‡ä»¤ï¼Œç›´æ¥ä½¿ç”¨
                isAccepted = (transferAction === 'accept');
                isRejected = (transferAction === 'reject');
                console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] ä½¿ç”¨æ˜ç¡®æŒ‡ä»¤:', { transferAction, isAccepted, isRejected });
            } else {
                // æ²¡æœ‰æ˜ç¡®æŒ‡ä»¤ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…
                console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] æœªæ£€æµ‹åˆ°æ˜ç¡®æŒ‡ä»¤ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…');

                // æ£€æŸ¥æ¥å—å…³é”®è¯
                for (const keyword of acceptKeywords) {
                    if (fullAiResponse.includes(keyword)) {
                        isAccepted = true;
                        matchedKeywords.push(`æ¥å—:${keyword}`);
                    }
                }

                // æ£€æŸ¥æ‹’ç»å…³é”®è¯
                for (const keyword of rejectKeywords) {
                    if (fullAiResponse.includes(keyword)) {
                        isRejected = true;
                        matchedKeywords.push(`æ‹’ç»:${keyword}`);
                    }
                }

                console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] å…³é”®è¯æ£€æµ‹ç»“æœ:', {
                    isAccepted,
                    isRejected,
                    matchedKeywords,
                    fullAiResponse: fullAiResponse.substring(0, 100) + '...'
                });
            }

            // æ›´æ–°è½¬è´¦çŠ¶æ€
            if (isAccepted && !isRejected) {
                // AIæ¥å—è½¬è´¦
                userTransferMsg.status = 'accepted';
                console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] AIæ¥å—è½¬è´¦ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå·²æ¥å—');

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç«‹å³æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯çŠ¶æ€ï¼Œé¿å…é‡å¤å¤„ç†
                const messages = chatMessages[characterId] || [];
                const transferIndex = messages.findIndex(msg =>
                    msg.timestamp === userTransferMsg.timestamp && msg.type === 'transfer');
                if (transferIndex !== -1) {
                    messages[transferIndex].status = 'accepted';
                }

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateTransferDisplay(userTransferMsg.timestamp, 'accepted');

            } else if (isRejected) {
                // AIæ‹’ç»è½¬è´¦
                userTransferMsg.status = 'rejected';
                console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] AIæ‹’ç»è½¬è´¦ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå·²æ‹’ç»');

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç«‹å³æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯çŠ¶æ€ï¼Œé¿å…é‡å¤å¤„ç†
                const messages = chatMessages[characterId] || [];
                const transferIndex = messages.findIndex(msg =>
                    msg.timestamp === userTransferMsg.timestamp && msg.type === 'transfer');
                if (transferIndex !== -1) {
                    messages[transferIndex].status = 'rejected';
                }

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateTransferDisplay(userTransferMsg.timestamp, 'rejected');
            }

            // ä¿å­˜æ›´æ–°åçš„æ¶ˆæ¯
            if (isAccepted || isRejected) {
                try {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å•æ¡æ¶ˆæ¯ä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                    const messages = chatMessages[characterId] || [];
                    const transferMessage = messages.find(msg =>
                        msg.timestamp === userTransferMsg.timestamp && msg.type === 'transfer');

                    if (transferMessage) {
                        const stableId = `${characterId}_transfer_${transferMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                        await db.chatMessages.put({
                            id: stableId,
                            characterId: characterId,
                            messageData: transferMessage
                        });
                        console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] è½¬è´¦çŠ¶æ€å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    }
                } catch (error) {
                    console.error('ğŸ”¥ [è½¬è´¦å¤„ç†] ä¿å­˜è½¬è´¦çŠ¶æ€å¤±è´¥:', error);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤º
                const actionText = isAccepted ? 'å·²æ”¶æ¬¾' : 'å·²é€€å›';
                const characterName = currentChatCharacter?.name || 'è§’è‰²';
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${characterName}${actionText} Â¥${Number(userTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–æ¶ˆæ¯æ•°ç»„å¹¶æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                const messages = chatMessages[characterId] || [];
                messages.push(systemMsg);
                chatMessages[characterId] = messages;

                // ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯
                try {
                    const systemStableId = `${characterId}_system_${systemMsg.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    await db.chatMessages.add({
                        id: systemStableId,
                        characterId: characterId,
                        messageData: systemMsg
                    });
                    console.log('ğŸ”¥ [è½¬è´¦å¤„ç†] ç³»ç»Ÿæ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('ğŸ”¥ [è½¬è´¦å¤„ç†] ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯å¤±è´¥:', error);
                }

                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                renderChatMessages(characterId);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è½¬è´¦å¡ç‰‡æ˜¾ç¤ºçŠ¶æ€
        function updateTransferDisplay(transferTimestamp, status) {
            console.log('ğŸ”¥ [è½¬è´¦ç•Œé¢æ›´æ–°] æ›´æ–°è½¬è´¦å¡ç‰‡æ˜¾ç¤º:', { transferTimestamp, status });

            // ğŸ”¥ã€è°ƒè¯•ã€‘æŸ¥çœ‹é¡µé¢ä¸­æ‰€æœ‰çš„è½¬è´¦å¡ç‰‡
            const allTransferCards = document.querySelectorAll('[data-transfer-id]');
            console.log('ğŸ”¥ [è½¬è´¦ç•Œé¢æ›´æ–°] é¡µé¢ä¸­çš„æ‰€æœ‰è½¬è´¦å¡ç‰‡:', Array.from(allTransferCards).map(card => ({
                id: card.getAttribute('data-transfer-id'),
                element: card
            })));

            // æŸ¥æ‰¾å¯¹åº”çš„è½¬è´¦å¡ç‰‡
            const transferCard = document.querySelector(`[data-transfer-id="${transferTimestamp}"]`);
            if (!transferCard) {
                console.log('ğŸ”¥ [è½¬è´¦ç•Œé¢æ›´æ–°] æœªæ‰¾åˆ°è½¬è´¦å¡ç‰‡ï¼Œé‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢');
                // å¦‚æœæ‰¾ä¸åˆ°å¡ç‰‡ï¼Œé‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                return;
            }

            // ç§»é™¤æ—§çš„çŠ¶æ€ç±»
            transferCard.classList.remove('accepted', 'rejected');

            // æ·»åŠ æ–°çš„çŠ¶æ€ç±»
            transferCard.classList.add(status);

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            let statusHtml = '';
            if (status === 'accepted') {
                statusHtml = `<div class="transfer-status">å·²æ”¶æ¬¾</div>`;
            } else if (status === 'rejected') {
                statusHtml = `<div class="transfer-status">å·²é€€å›</div>`;
            }

            // æŸ¥æ‰¾å¹¶æ›´æ–°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
            const existingStatus = transferCard.querySelector('.transfer-status');
            if (existingStatus) {
                existingStatus.outerHTML = statusHtml;
            } else if (statusHtml) {
                // å¦‚æœæ²¡æœ‰çŠ¶æ€åŒºåŸŸï¼Œæ·»åŠ åˆ°å¡ç‰‡æœ«å°¾
                transferCard.insertAdjacentHTML('beforeend', statusHtml);
            }

            // ç§»é™¤ç‚¹å‡»å¤„ç†å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            transferCard.removeAttribute('onclick');

            console.log('ğŸ”¥ [è½¬è´¦ç•Œé¢æ›´æ–°] è½¬è´¦å¡ç‰‡çŠ¶æ€å·²æ›´æ–°');
        }

        // è½¬è´¦ç›¸å…³å‡½æ•°
        async function sendTransfer() {
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const note = document.getElementById('transfer-note').value.trim();

            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢', 'warning');
                return;
            }

            if (amount > 1000000000) {
                showToast('è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡10äº¿å…ƒ', 'warning');
                return;
            }

            // åˆ›å»ºè½¬è´¦æ¶ˆæ¯ - ä¿®å¤æ•°æ®ç»“æ„å’Œè®¾ç½®pendingUserMessage
            const transferMessage = {
                id: Date.now().toString(),
                sender: 'sent',  // ä¿®å¤ï¼šä½¿ç”¨ sender è€Œä¸æ˜¯ role
                type: 'transfer',
                amount: amount,
                note: note || 'è½¬è´¦',
                timestamp: Date.now()
            };

            // æ·»åŠ åˆ°èŠå¤©è®°å½•
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            const messages = chatMessages[currentChatCharacter.id];
            messages.push(transferMessage);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç”¨æˆ·å‘é€è½¬è´¦ä½¿ç”¨å•æ¡ä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
            try {
                const stableId = `${currentChatCharacter.id}_transfer_${transferMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                await db.chatMessages.add({
                    id: stableId,
                    characterId: currentChatCharacter.id,
                    messageData: transferMessage
                });
                console.log('âœ… [é«˜æ•ˆç”¨æˆ·è½¬è´¦] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('ç”¨æˆ·è½¬è´¦æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                await saveChatMessages();
            }

            // ä½¿ç”¨åŠ¨ç”»æ·»åŠ æ¶ˆæ¯è€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
            addMessageWithAnimation(transferMessage, currentChatCharacter.id);

            // ğŸ”¥ ã€å…³é”®ä¿®å¤ã€‘è®¾ç½®ä¸ºå¾…å›å¤æ¶ˆæ¯ï¼Œè®©AIèƒ½çœ‹åˆ°è½¬è´¦
            pendingUserMessage = transferMessage;

            // æ›´æ–°æ™ºèƒ½å›å¤æŒ‰é’®çŠ¶æ€
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ç‚¹å‡»è·å–AIå›å¤';
            }

            // æ›´æ–°è”ç³»äººåˆ—è¡¨
            renderMessageList();

            // å…³é—­è½¬è´¦å¯¹è¯æ¡†
            document.getElementById('transfer-modal').classList.remove('visible');

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-note').value = '';

            showToast('è½¬è´¦å·²å‘é€', 'success');
        }

        function showTransferConfirmDialog(transferMsg) {
            if (!transferMsg || transferMsg.status) return;

            const modal = document.getElementById('transfer-confirm-modal');
            const amountEl = modal.querySelector('.transfer-confirm-amount');
            const noteEl = modal.querySelector('.transfer-confirm-note');

            // è®¾ç½®è½¬è´¦ä¿¡æ¯
            amountEl.textContent = `Â¥ ${Number(transferMsg.amount).toFixed(2)}`;
            noteEl.textContent = `å¤‡æ³¨ï¼š${transferMsg.note || 'æ— '}`;

            // å­˜å‚¨å½“å‰å¤„ç†çš„è½¬è´¦ä¿¡æ¯
            currentTransferMsg = transferMsg;

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            modal.classList.add('visible');
        }

        async function acceptTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;

            // åœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„è½¬è´¦æ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg =>
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');

            if (transferIndex !== -1) {
                // æ›´æ–°è½¬è´¦çŠ¶æ€
                messages[transferIndex].status = 'accepted';

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateTransferDisplay(currentTransferMsg.timestamp, 'accepted');

                // ä¿å­˜çŠ¶æ€
                try {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å•æ¡æ¶ˆæ¯ä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                    const stableId = `${currentChatCharacter.id}_transfer_${currentTransferMsg.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    await db.chatMessages.put({
                        id: stableId,
                        characterId: currentChatCharacter.id,
                        messageData: messages[transferIndex]
                    });
                    console.log('âœ… [æ‰‹åŠ¨ç¡®è®¤æ”¶æ¬¾] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('ç¡®è®¤æ”¶æ¬¾ä¿å­˜å¤±è´¥:', error);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤º
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `ä½ å·²ç¡®è®¤æ”¶æ¬¾ Â¥${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };

                messages.push(systemMsg);

                // ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯
                try {
                    const systemStableId = `${currentChatCharacter.id}_system_${systemMsg.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    await db.chatMessages.add({
                        id: systemStableId,
                        characterId: currentChatCharacter.id,
                        messageData: systemMsg
                    });
                    console.log('âœ… [æ‰‹åŠ¨ç¡®è®¤æ”¶æ¬¾] ç³»ç»Ÿæ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ‰‹åŠ¨ç¡®è®¤æ”¶æ¬¾ç³»ç»Ÿæ¶ˆæ¯ä¿å­˜å¤±è´¥:', error);
                }

                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                renderChatMessages(currentChatCharacter.id);
            }

            // å…³é—­å¯¹è¯æ¡†
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;

            showToast('å·²ç¡®è®¤æ”¶æ¬¾', 'success');
        }

        async function rejectTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;

            // åœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„è½¬è´¦æ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg =>
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');

            if (transferIndex !== -1) {
                // æ›´æ–°è½¬è´¦çŠ¶æ€
                messages[transferIndex].status = 'rejected';

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateTransferDisplay(currentTransferMsg.timestamp, 'rejected');

                // ä¿å­˜çŠ¶æ€
                try {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å•æ¡æ¶ˆæ¯ä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                    const stableId = `${currentChatCharacter.id}_transfer_${currentTransferMsg.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    await db.chatMessages.put({
                        id: stableId,
                        characterId: currentChatCharacter.id,
                        messageData: messages[transferIndex]
                    });
                    console.log('âœ… [æ‰‹åŠ¨æ‹’ç»è½¬è´¦] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ‹’ç»è½¬è´¦ä¿å­˜å¤±è´¥:', error);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤º
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `ä½ å·²é€€å› Â¥${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };

                messages.push(systemMsg);

                // ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯
                try {
                    const systemStableId = `${currentChatCharacter.id}_system_${systemMsg.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    await db.chatMessages.add({
                        id: systemStableId,
                        characterId: currentChatCharacter.id,
                        messageData: systemMsg
                    });
                    console.log('âœ… [æ‰‹åŠ¨æ‹’ç»è½¬è´¦] ç³»ç»Ÿæ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ‰‹åŠ¨æ‹’ç»è½¬è´¦ç³»ç»Ÿæ¶ˆæ¯ä¿å­˜å¤±è´¥:', error);
                }

                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                renderChatMessages(currentChatCharacter.id);
            }

            // å…³é—­å¯¹è¯æ¡†
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;

            showToast('å·²é€€å›è½¬è´¦', 'success');
        }

        // ç›‘å¬appæ˜¾ç¤ºäº‹ä»¶
        const originalShowApp = window.showApp;
        if (originalShowApp) {
            window.showApp = function(appId) {
                originalShowApp(appId);
                if (appId === 'data-management-screen') calculateStorageUsage();
            };
        }

        // æ˜¾ç¤ºå®šæ—¶å‘å¸ƒæ—¶é—´è®¾ç½®æ¨¡æ€æ¡†
        function showScheduleTimesModal() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];

            const container = document.getElementById('schedule-times-modal-container');
            container.innerHTML = '';

            // æ¸²æŸ“å·²æœ‰æ—¶é—´ç‚¹
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-bottom: 10px;
                    gap: 10px;
                `;
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)"
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <button onclick="removeScheduleTime(${index})"
                            style="padding: 8px 12px; background: #ff3b30; color: white; border: none; border-radius: 6px; cursor: pointer;">Ã—</button>
                `;
                container.appendChild(timeItem);
            });

            showModal('schedule-times-modal');
        }

        // æ·»åŠ å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        function addScheduleTime() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsTimes) {
                chatSettings.scheduledMomentsTimes = [];
            }

            if (chatSettings.scheduledMomentsTimes.length >= 10) {
                alert('æœ€å¤šåªèƒ½è®¾ç½®10ä¸ªæ—¶é—´ç‚¹');
                return;
            }

            chatSettings.scheduledMomentsTimes.push('09:00');
            saveCurrentChatSettings(chatSettings);
            showScheduleTimesModal(); // é‡æ–°æ¸²æŸ“
        }

        // æ›´æ–°å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        function updateScheduleTime(index, newTime) {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes[index] = newTime;
                saveCurrentChatSettings(chatSettings);
            }
        }

        // ç§»é™¤å®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹
        function removeScheduleTime(index) {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes.splice(index, 1);
                saveCurrentChatSettings(chatSettings);
                showScheduleTimesModal(); // é‡æ–°æ¸²æŸ“
            }
        }

        // ä¿å­˜å®šæ—¶å‘å¸ƒè®¾ç½®
        function saveScheduleTimes() {
            if (!currentChatCharacter) return;

            const container = document.getElementById('schedule-times-modal-container');
            const timeInputs = container.querySelectorAll('input[type="time"]');
            const times = Array.from(timeInputs).map(input => input.value).filter(time => time);

            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduledMomentsTimes = times;
            saveCurrentChatSettings(chatSettings);

            updateScheduleTimesDisplay();
            hideModal('schedule-times-modal');

            // é‡æ–°åˆå§‹åŒ–å…¨å±€åŠ¨æ€å‘å¸ƒç³»ç»Ÿä»¥åº”ç”¨æ–°è®¾ç½®
            setTimeout(async () => {
                try {
                    await initGlobalMomentsSystem();
                    console.log('âœ… å®šæ—¶å‘å¸ƒè®¾ç½®å·²æ›´æ–°');
                } catch (error) {
                    console.error('âŒ æ›´æ–°å®šæ—¶å‘å¸ƒè®¾ç½®å¤±è´¥:', error);
                }
            }, 500);

            showToast(`å·²ä¿å­˜ ${times.length} ä¸ªå®šæ—¶å‘å¸ƒæ—¶é—´ç‚¹`, 'success');
        }

        // æ›´æ–°å®šæ—¶å‘å¸ƒæ—¶é—´æ˜¾ç¤º
        function updateScheduleTimesDisplay() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];
            const displayElement = document.getElementById('schedule-times-display');

            if (scheduleTimes.length === 0) {
                displayElement.textContent = 'æœªè®¾ç½®';
            } else if (scheduleTimes.length === 1) {
                displayElement.textContent = `1ä¸ªæ—¶é—´ç‚¹ (${scheduleTimes[0]})`;
            } else {
                displayElement.textContent = `${scheduleTimes.length}ä¸ªæ—¶é—´ç‚¹`;
            }
        }

        // æµ‹è¯•å‘å¸ƒåŠ¨æ€
        async function testPublishMoment() {
            if (!currentChatCharacter) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            const button = document.querySelector('button[onclick="testPublishMoment()"]');
            const originalText = button.textContent;
            button.textContent = 'å‘å¸ƒä¸­...';
            button.disabled = true;

            try {
                await triggerBackgroundMomentsTest(currentChatCharacter.id);
                showToast('æµ‹è¯•åŠ¨æ€å‘å¸ƒæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('æµ‹è¯•å‘å¸ƒå¤±è´¥:', error);
                showToast('æµ‹è¯•å‘å¸ƒå¤±è´¥', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // åˆå§‹åŒ–å®šæ—¶å‘å¸ƒç³»ç»Ÿ
        function initScheduledMomentsSystem() {
            if (!currentChatCharacter) return;

            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsEnabled || !chatSettings.scheduledMomentsTimes?.length) {
                return;
            }

            // ä¸ºæ¯ä¸ªè®¾å®šæ—¶é—´åˆ›å»ºå®šæ—¶å™¨
            chatSettings.scheduledMomentsTimes.forEach(time => {
                if (!time) return;

                const [hours, minutes] = time.split(':').map(Number);
                const now = new Date();
                const scheduledTime = new Date();

                scheduledTime.setHours(hours, minutes, 0, 0);

                // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œè®¾ç½®ä¸ºæ˜å¤©
                if (scheduledTime <= now) {
                    scheduledTime.setDate(scheduledTime.getDate() + 1);
                }

                const delay = scheduledTime.getTime() - now.getTime();

                setTimeout(() => {
                    // æ‰§è¡Œå®šæ—¶å‘å¸ƒ
                    triggerBackgroundMoments(currentChatCharacter.id);

                    // è®¾ç½®æ¯24å°æ—¶é‡å¤æ‰§è¡Œ
                    setInterval(() => {
                        triggerBackgroundMoments(currentChatCharacter.id);
                    }, 24 * 60 * 60 * 1000);
                }, delay);
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¨é€é€šçŸ¥åŠŸèƒ½
        // ğŸ”¥ã€æ–°å¢ã€‘é€šçŸ¥é˜Ÿåˆ—å’Œå•ä¸ªé€šçŸ¥ç®¡ç†
        let notificationQueue = [];
        let currentNotification = null;
        let isProcessingQueue = false;

        // ğŸ”¥ã€ä¿®å¤ã€‘åˆ›å»ºæ¨é€é€šçŸ¥ - æ”¹ä¸ºé˜Ÿåˆ—æ–¹å¼ï¼Œå•ä¸ªæ˜¾ç¤º
        function createPushNotification(character, messageData, delay = 0) {
            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¨é€é€šçŸ¥éŸ³æ•ˆ
            setTimeout(() => {
                SoundManager.play(SoundManager.TYPES.NOTIFICATION, character?.id);
            }, delay);

            // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å’Œè¯¥è§’è‰²çš„èŠå¤©ç•Œé¢ - æ›´ç²¾ç¡®çš„åˆ¤æ–­

            // æ–¹æ³•1ï¼šæ£€æŸ¥ä¸»å±å¹•æ˜¯å¦å¯è§
            const phoneScreen = document.getElementById('phone-screen');
            const isOnMainScreen = phoneScreen && window.getComputedStyle(phoneScreen).display !== 'none';

            // æ–¹æ³•2ï¼šæ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦å¯è§
            const chatScreen = document.getElementById('api-chat-screen');
            const isChatVisible = chatScreen && window.getComputedStyle(chatScreen).display !== 'none';

            // æ–¹æ³•3ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å’Œè¯¥è§’è‰²èŠå¤©
            const isChattingWithThisCharacter = isChatVisible && currentChatCharacter && currentChatCharacter.id === character.id;

            console.log('ğŸ”” [æ¨é€é€šçŸ¥] æ£€æŸ¥ç•Œé¢çŠ¶æ€:', {
                mainScreenVisible: isOnMainScreen,
                chatScreenVisible: isChatVisible,
                currentChatCharacter: currentChatCharacter?.name,
                messageFromCharacter: character.name,
                isChattingWithThisCharacter: isChattingWithThisCharacter,
                shouldShowNotification: isOnMainScreen && !isChattingWithThisCharacter
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘çºªå¿µæ—¥å’Œçº¦å®šé€šçŸ¥åº”è¯¥æ€»æ˜¯æ˜¾ç¤ºï¼Œæ— è®ºåœ¨å“ªä¸ªç•Œé¢
            // æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦æ˜¯çºªå¿µæ—¥æˆ–çº¦å®šç›¸å…³çš„é€šçŸ¥
            const isAnniversaryNotification = typeof messageData === 'string' &&
                (messageData.includes('åˆ›å»ºäº†çºªå¿µæ—¥') || messageData.includes('åˆ›å»ºäº†çº¦å®š') ||
                 messageData.includes('åˆ›å»ºäº†ç‰¹åˆ«çš„æ—¥å­') || messageData.includes('è®°å½•äº†ç”Ÿæ—¥') ||
                 messageData.includes('åˆ›å»ºäº†å…³ç³»çºªå¿µæ—¥') || messageData.includes('å’Œä½ çº¦å®šäº†') ||
                 messageData.includes('è®¸ä¸‹æ‰¿è¯º') || messageData.includes('çº¦å®šå’Œä½ è§é¢') ||
                 messageData.includes('çº¦å®šäº†æ´»åŠ¨') || messageData.includes('çº¦å®šäº†çº¦ä¼š') ||
                 messageData.includes('æé†’ï¼š') || messageData.includes('ä»Šå¤©æ˜¯') ||
                 messageData.includes('ğŸ‰') || messageData.includes('ğŸ“') || messageData.includes('ğŸ“…') || messageData.includes('â°'));

            if (isAnniversaryNotification) {
                // çºªå¿µæ—¥/çº¦å®šé€šçŸ¥æ€»æ˜¯æ˜¾ç¤ºï¼Œæ— è®ºç”¨æˆ·åœ¨å“ªé‡Œï¼ŒåŒ…æ‹¬æ­£åœ¨å’Œè¯¥è§’è‰²èŠå¤©
                console.log('ğŸ”” [æ¨é€é€šçŸ¥] çºªå¿µæ—¥/çº¦å®šé€šçŸ¥ï¼Œæ— æ¡ä»¶æ˜¾ç¤º');
                // ç›´æ¥è·³è¿‡æ‰€æœ‰æ¡ä»¶æ£€æŸ¥ï¼Œå¼ºåˆ¶æ˜¾ç¤º
            } else {
                // æ™®é€šæ¶ˆæ¯é€šçŸ¥çš„åŸæœ‰é€»è¾‘
                if (!isOnMainScreen || isChattingWithThisCharacter) {
                    console.log('ğŸ”” [æ¨é€é€šçŸ¥] ç”¨æˆ·ä¸åœ¨ä¸»å±å¹•æˆ–æ­£åœ¨å’Œè¯¥è§’è‰²èŠå¤©ï¼Œä¸æ˜¾ç¤ºæ¨é€');
                    return;
                }
            }

            // æ·»åŠ åˆ°é˜Ÿåˆ—
            notificationQueue.push({
                character,
                messageData,
                delay
            });

            console.log('ğŸ”” [æ¨é€é€šçŸ¥] æ·»åŠ é€šçŸ¥åˆ°é˜Ÿåˆ—ï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦:', notificationQueue.length);

            // å¼€å§‹å¤„ç†é˜Ÿåˆ—
            processNotificationQueue();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†é€šçŸ¥é˜Ÿåˆ—
        function processNotificationQueue() {
            if (isProcessingQueue || notificationQueue.length === 0) {
                return;
            }

            isProcessingQueue = true;
            console.log('ğŸ”” [æ¨é€é€šçŸ¥] å¼€å§‹å¤„ç†é˜Ÿåˆ—ï¼Œå‰©ä½™é€šçŸ¥æ•°:', notificationQueue.length);

            const processNext = () => {
                if (notificationQueue.length === 0) {
                    isProcessingQueue = false;
                    console.log('ğŸ”” [æ¨é€é€šçŸ¥] é˜Ÿåˆ—å¤„ç†å®Œæˆ');
                    return;
                }

                const { character, messageData, delay } = notificationQueue.shift();

                setTimeout(() => {
                    showSingleNotification(character, messageData);

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¢åŠ é€šçŸ¥é—´éš”åˆ°2.6ç§’ï¼Œç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿæ—¶é—´çœ‹å®Œå½“å‰é€šçŸ¥
                    setTimeout(() => {
                        processNext();
                    }, 2600);
                }, delay);
            };

            processNext();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå•ä¸ªé€šçŸ¥
        function showSingleNotification(character, messageData) {
            console.log('ğŸ”” [æ¨é€é€šçŸ¥] æ˜¾ç¤ºå•ä¸ªé€šçŸ¥ï¼Œè§’è‰²:', character.name);

            const container = document.getElementById('notification-container');
            if (!container) {
                console.error('ğŸ”” [æ¨é€é€šçŸ¥] æ‰¾ä¸åˆ°é€šçŸ¥å®¹å™¨!');
                return;
            }

            // å¦‚æœæœ‰ç°æœ‰é€šçŸ¥ï¼Œå…ˆç§»é™¤
            if (currentNotification) {
                hideNotification(currentNotification, true);
            }

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'push-notification';
            currentNotification = notification;

            // ç”Ÿæˆé€šçŸ¥å†…å®¹
            let notificationText = '';
            let notificationType = 'message';
            let senderName = character.name;
            let isGroupMessage = false;
            let groupSenderName = '';

            if (typeof messageData === 'string') {
                notificationText = messageData;
            } else if (typeof messageData === 'object') {
                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†ç¾¤èŠæ¶ˆæ¯æ ¼å¼
                if (messageData.name && messageData.message) {
                    // ç¾¤èŠæ¶ˆæ¯æ ¼å¼: {name: "è§’è‰²å", message: "æ¶ˆæ¯å†…å®¹"}
                    isGroupMessage = true;
                    groupSenderName = messageData.name;
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¾¤èŠæ¨é€æ ‡é¢˜æ˜¾ç¤ºç¾¤èŠåå­—ï¼Œå†…å®¹æ˜¾ç¤º"è§’è‰²åï¼šæ¶ˆæ¯"
                    senderName = `[ç¾¤èŠ]${character.name}`;

                    if (typeof messageData.message === 'string') {
                        notificationText = `${groupSenderName}ï¼š${messageData.message}`;
                    } else if (typeof messageData.message === 'object' && messageData.message.type) {
                        // ç¾¤èŠä¸­çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                        switch (messageData.message.type) {
                            case 'transfer':
                                notificationText = `${groupSenderName}ï¼šå‘ä½ è½¬è´¦äº† Â¥${messageData.message.amount}`;
                                notificationType = 'transfer';
                                break;
                            case 'voice_message':
                                notificationText = `${groupSenderName}ï¼š[è¯­éŸ³æ¶ˆæ¯]`;
                                notificationType = 'voice';
                                break;
                            default:
                                notificationText = `${groupSenderName}ï¼š${messageData.message.content || '[æ¶ˆæ¯]'}`;
                        }
                    } else {
                        notificationText = `${groupSenderName}ï¼š${String(messageData.message)}`;
                    }
                } else if (messageData.type) {
                    // æ™®é€šçš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                    switch (messageData.type) {
                        case 'transfer':
                            notificationText = `å‘ä½ è½¬è´¦äº† Â¥${messageData.amount}`;
                            notificationType = 'transfer';
                            break;
                        case 'voice_message':
                            notificationText = '[è¯­éŸ³æ¶ˆæ¯]';
                            notificationType = 'voice';
                            break;
                        case 'ai_image':
                            notificationText = '[å›¾ç‰‡]';
                            notificationType = 'image';
                            break;
                        case 'emoji':
                            notificationText = `å‘é€äº†è¡¨æƒ…åŒ…ï¼š${messageData.description}`;
                            notificationType = 'emoji';
                            break;
                        default:
                            notificationText = messageData.content || '[æ¶ˆæ¯]';
                    }
                } else {
                    notificationText = messageData.content || messageData.message || '[æ¶ˆæ¯]';
                }
            }

            // é™åˆ¶é€šçŸ¥æ–‡æœ¬é•¿åº¦
            if (notificationText.length > 25) {
                notificationText = notificationText.substring(0, 25) + '...';
            }

            // ç”Ÿæˆæ—¶é—´
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // è®¾ç½®é€šçŸ¥HTML
            notification.innerHTML = `
                <img class="notification-avatar" src="${character.avatarUrl || character.avatar || createDefaultAvatar(character.name)}" alt="${senderName}">
                <div class="notification-content">
                    <div class="notification-title">${senderName}</div>
                    <div class="notification-message">${notificationText}</div>
                </div>
                <div class="notification-time">${timeString}</div>
            `;

            // ç‚¹å‡»é€šçŸ¥æ‰“å¼€èŠå¤©
            notification.onclick = () => {
                console.log('ğŸ”” [æ¨é€é€šçŸ¥] ç”¨æˆ·ç‚¹å‡»äº†æ¨é€é€šçŸ¥ï¼Œè·³è½¬åˆ°èŠå¤©ç•Œé¢');

                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯çŸ­ä¿¡æ¨é€é€šçŸ¥
                const isSMSNotification = notificationText.startsWith('[çŸ­ä¿¡]');
                // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯æ—¥è®°æ¨é€é€šçŸ¥
                const isDiaryNotification = notificationText.startsWith('[æ—¥è®°]');

                // å¦‚æœæœ‰è§’è‰²ä¿¡æ¯ï¼Œç¡®ä¿åˆ‡æ¢åˆ°å¯¹åº”è§’è‰²
                if (character && character.id) {
                    console.log('ğŸ”” [æ¨é€é€šçŸ¥] åˆ‡æ¢åˆ°è§’è‰²:', character.name, character.id, 'æ˜¯å¦ä¸ºçŸ­ä¿¡:', isSMSNotification, 'æ˜¯å¦ä¸ºæ—¥è®°:', isDiaryNotification);

                    if (isSMSNotification) {
                        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡æ¨é€é€šçŸ¥è·³è½¬åˆ°çŸ­ä¿¡èŠå¤©ç•Œé¢
                        window.currentSMSCharacter = character;
                        updateSMSChatHeader(character);
                        renderSMSMessages(character.id);

                        // åˆ‡æ¢åˆ°çŸ­ä¿¡èŠå¤©ç•Œé¢
                        showApp('sms-chat-screen');
                        console.log('ğŸ”” [çŸ­ä¿¡æ¨é€é€šçŸ¥] è·³è½¬åˆ°çŸ­ä¿¡èŠå¤©ç•Œé¢å®Œæˆ');
                    } else if (isDiaryNotification) {
                        // ğŸ”¥ã€æ–°å¢ã€‘æ—¥è®°æ¨é€é€šçŸ¥è·³è½¬åˆ°æ—¥è®°ç•Œé¢
                        currentChatCharacter = character;

                        // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                        showApp('api-chat-screen');

                        // å»¶è¿Ÿæ‰“å¼€æ—¥è®°ç•Œé¢ï¼Œç¡®ä¿èŠå¤©ç•Œé¢å·²åŠ è½½
                        setTimeout(() => {
                            showDiary();
                        }, 100);

                        console.log('ğŸ”” [æ—¥è®°æ¨é€é€šçŸ¥] è·³è½¬åˆ°æ—¥è®°ç•Œé¢å®Œæˆ');
                    } else {
                        // ğŸ”¥ã€ä¿æŒåŸæœ‰é€»è¾‘ã€‘æ™®é€šèŠå¤©æ¨é€é€šçŸ¥è·³è½¬åˆ°èŠå¤©ç•Œé¢
                        currentChatCharacter = character;
                        // æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜
                        const chatTitle = document.getElementById('api-chat-title');
                        if (chatTitle) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                            let displayTitle = character.name;
                            if (character.isGroup && character.members) {
                                const memberCount = character.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                                displayTitle = `${character.name}ï¼ˆ${memberCount}ï¼‰`;
                            }
                            chatTitle.textContent = displayTitle;
                            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                            chatTitle.classList.remove('typing-status');
                            chatTitle.dataset.originalTitle = displayTitle;
                        }
                        // æ¸²æŸ“è¯¥è§’è‰²çš„èŠå¤©è®°å½•
                        renderChatMessages(character.id);

                        // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                        showApp('api-chat-screen');
                        console.log('ğŸ”” [æ¨é€é€šçŸ¥] è·³è½¬åˆ°èŠå¤©ç•Œé¢å®Œæˆ');
                    }
                }

                // ç§»é™¤é€šçŸ¥
                hideNotification(notification);
            };

            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(notification);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.add('show');
            }, 50);

            // ğŸ”¥ã€ä¿®å¤ã€‘è‡ªåŠ¨éšè— - å¢åŠ æ˜¾ç¤ºæ—¶é•¿
            setTimeout(() => {
                if (currentNotification === notification) {
                    hideNotification(notification);
                }
            }, 2300);
        }

        function hideNotification(notification, immediate = false) {
            if (notification && notification.parentNode) {
                notification.classList.remove('show');
                notification.classList.add('hide');

                // å¦‚æœæ˜¯å½“å‰é€šçŸ¥ï¼Œæ¸…é™¤å¼•ç”¨
                if (currentNotification === notification) {
                    currentNotification = null;
                }

                const removeDelay = immediate ? 0 : 250;
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, removeDelay);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºåŠ¨æ€äº’åŠ¨åˆ›å»ºæ¨é€é€šçŸ¥
        function createMomentInteractionNotification(character, interactionType, momentText) {
            let notificationText = '';
            switch (interactionType) {
                case 'like':
                    notificationText = `èµäº†ä½ çš„åŠ¨æ€`;
                    break;
                case 'comment':
                    notificationText = `è¯„è®ºäº†ä½ çš„åŠ¨æ€`;
                    break;
                default:
                    notificationText = `ä¸ä½ çš„åŠ¨æ€äº’åŠ¨äº†`;
            }

            createPushNotification(character, notificationText);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çŸ­ä¿¡ä¸“ç”¨æ¨é€é€šçŸ¥å‡½æ•°
        function createSMSPushNotification(character, messageText, delay = 0) {
            // ğŸ”¥ã€æ–°å¢ã€‘æ’­æ”¾æ¨é€é€šçŸ¥éŸ³æ•ˆ
            setTimeout(() => {
                SoundManager.play(SoundManager.TYPES.NOTIFICATION, character?.id);
            }, delay);

            // ğŸ”¥ã€å…³é”®ã€‘æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å’Œè¯¥è§’è‰²çš„çŸ­ä¿¡èŠå¤©ç•Œé¢
            const phoneScreen = document.getElementById('phone-screen');
            const isOnMainScreen = phoneScreen && window.getComputedStyle(phoneScreen).display !== 'none';

            const smsScreen = document.getElementById('sms-chat-screen');
            const isSMSVisible = smsScreen && window.getComputedStyle(smsScreen).display !== 'none';

            const isChattingWithThisCharacter = isSMSVisible && window.currentSMSCharacter && window.currentSMSCharacter.id === character.id;

            console.log('ğŸ”” [çŸ­ä¿¡æ¨é€é€šçŸ¥] æ£€æŸ¥ç•Œé¢çŠ¶æ€:', {
                mainScreenVisible: isOnMainScreen,
                smsScreenVisible: isSMSVisible,
                currentSMSCharacter: window.currentSMSCharacter?.name,
                messageFromCharacter: character.name,
                isChattingWithThisCharacter: isChattingWithThisCharacter,
                shouldShowNotification: isOnMainScreen && !isChattingWithThisCharacter
            });

            // ğŸ”¥ã€å…³é”®ã€‘åªæœ‰å½“ç”¨æˆ·ä¸åœ¨å’Œè¯¥è§’è‰²çš„çŸ­ä¿¡èŠå¤©ç•Œé¢æ—¶æ‰æ˜¾ç¤ºæ¨é€
            if (!isOnMainScreen || isChattingWithThisCharacter) {
                console.log('ğŸ”” [çŸ­ä¿¡æ¨é€é€šçŸ¥] ç”¨æˆ·ä¸åœ¨ä¸»å±å¹•æˆ–æ­£åœ¨å’Œè¯¥è§’è‰²çŸ­ä¿¡èŠå¤©ï¼Œä¸æ˜¾ç¤ºæ¨é€');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºçŸ­ä¿¡æ¶ˆæ¯æ·»åŠ [çŸ­ä¿¡]æ ‡è¯†
            const smsNotificationText = `[çŸ­ä¿¡] ${messageText}`;

            // å¤ç”¨ç°æœ‰çš„æ¨é€é€šçŸ¥ç³»ç»Ÿ
            createPushNotification(character, smsNotificationText, delay);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é¡µé¢å¸è½½æ—¶æ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»
        window.addEventListener('beforeunload', function() {
            // å¦‚æœç”¨æˆ·æ­£åœ¨èŠå¤©ç•Œé¢ï¼Œæ ‡è®°å½“å‰èŠå¤©çš„æ¶ˆæ¯ä¸ºå·²è¯»
            if (currentChatCharacter) {
                markAsRead(currentChatCharacter.id);
                console.log('ğŸ”¥ [é¡µé¢å¸è½½] æ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»:', currentChatCharacter.name);
            } else {
                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœcurrentChatCharacterä¸ºç©ºï¼Œå°è¯•ä»sessionStorageæ¢å¤
                const savedChatId = sessionStorage.getItem('currentChatCharacterId');
                if (savedChatId) {
                    markAsRead(savedChatId);
                    console.log('ğŸ”¥ [é¡µé¢å¸è½½] ä»sessionStorageæ¢å¤å¹¶æ ‡è®°èŠå¤©ä¸ºå·²è¯»:', savedChatId);
                }
            }
            // æ¸…é™¤ä¿å­˜çš„èŠå¤©çŠ¶æ€
            sessionStorage.removeItem('currentChatCharacterId');
        });

        // ğŸ”¥ã€æ–°å¢ã€‘é¡µé¢éšè—æ—¶ä¹Ÿæ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»ï¼ˆå¤„ç†ç§»åŠ¨ç«¯åˆ‡æ¢åº”ç”¨çš„æƒ…å†µï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentChatCharacter) {
                markAsRead(currentChatCharacter.id);
                console.log('ğŸ”¥ [é¡µé¢éšè—] æ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»:', currentChatCharacter.name);
            }
        });

        // ğŸ”¥ã€æ–°å¢ã€‘é¡µé¢å¤±å»ç„¦ç‚¹æ—¶ä¹Ÿæ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»ï¼ˆå¤„ç†åˆ‡æ¢æ ‡ç­¾é¡µçš„æƒ…å†µï¼‰
        window.addEventListener('blur', function() {
            if (currentChatCharacter) {
                markAsRead(currentChatCharacter.id);
                console.log('ğŸ”¥ [é¡µé¢å¤±ç„¦] æ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»:', currentChatCharacter.name);
            }
        });

        // åˆå§‹åŒ–è½¬è´¦åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ è½¬è´¦ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('transfer-cancel-btn')?.addEventListener('click', () => {
                document.getElementById('transfer-modal').classList.remove('visible');
            });

            document.getElementById('transfer-confirm-btn')?.addEventListener('click', sendTransfer);
            document.getElementById('transfer-accept-btn')?.addEventListener('click', acceptTransfer);
            document.getElementById('transfer-reject-btn')?.addEventListener('click', rejectTransfer);

            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.getElementById('transfer-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-modal')) {
                    document.getElementById('transfer-modal').classList.remove('visible');
                }
            });

            document.getElementById('transfer-confirm-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-confirm-modal')) {
                    document.getElementById('transfer-confirm-modal').classList.remove('visible');
                    currentTransferMsg = null;
                }
            });
        });

        // ç¾¤èŠç›¸å…³å‡½æ•°
        function updateGroupChatInfo() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

            // æ›´æ–°ç¾¤èŠå¤´åƒé¢„è§ˆ
            const groupAvatarPreview = document.getElementById('group-avatar-preview');
            if (groupAvatarPreview) {
                if (currentChatCharacter.avatarUrl) {
                    groupAvatarPreview.src = currentChatCharacter.avatarUrl;
                } else {
                    // ä½¿ç”¨é»˜è®¤çš„ç¾¤èŠå¤´åƒ - åˆ›å»ºä¸€ä¸ªç®€å•çš„Canvaså¤´åƒ
                    const canvas = document.createElement('canvas');
                    canvas.width = 40;
                    canvas.height = 40;
                    const ctx = canvas.getContext('2d');

                    // ç»˜åˆ¶è“è‰²åœ†å½¢èƒŒæ™¯
                    ctx.beginPath();
                    ctx.arc(20, 20, 20, 0, 2 * Math.PI);
                    ctx.fillStyle = '#4a84c1';
                    ctx.fill();

                    // ç»˜åˆ¶ç™½è‰²"ç¾¤"å­—
                    ctx.fillStyle = 'white';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ç¾¤', 20, 20);

                    groupAvatarPreview.src = canvas.toDataURL();
                }
            }

            // æ›´æ–°ç¾¤èŠåç§°æ˜¾ç¤º
            const groupNameDisplay = document.getElementById('group-name-display');
            if (groupNameDisplay) {
                groupNameDisplay.textContent = currentChatCharacter.name || 'ç¾¤èŠåç§°';
            }

            // æ›´æ–°ç¾¤æˆå‘˜æ•°é‡æ˜¾ç¤º
            const groupMemberCountDisplay = document.getElementById('group-member-count-display');
            if (groupMemberCountDisplay) {
                const memberCount = currentChatCharacter.members ? currentChatCharacter.members.length : 0;
                // ç¾¤æˆå‘˜æ•°é‡ = è§’è‰²æ•°é‡ + 1ä¸ªç”¨æˆ·
                const totalMemberCount = memberCount + 1;
                groupMemberCountDisplay.textContent = `${totalMemberCount}åæˆå‘˜`;
            }

            // æ›´æ–°ç¾¤å…¬å‘Šæ˜¾ç¤º
            const groupDescriptionDisplay = document.getElementById('group-description-display');
            if (groupDescriptionDisplay) {
                groupDescriptionDisplay.textContent = currentChatCharacter.description || 'ç¾¤å…¬å‘Šï¼šç‚¹å‡»è®¾ç½®ç¾¤å…¬å‘Š';
            }

            // æ›´æ–°æˆ‘åœ¨ç¾¤é‡Œçš„æ˜µç§° - ä½¿ç”¨å½“å‰é€‰æ‹©çš„é¢å…·åç§°ä½œä¸ºé»˜è®¤å€¼
            const currentMyGroupNickname = document.getElementById('current-my-group-nickname');
            if (currentMyGroupNickname) {
                let defaultNickname = 'æœªé€‰æ‹©';

        // --- æ–°å¢ä»£ç å¼€å§‹ ---
        const chatSettings = getCurrentChatSettings();
        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
        // --- æ–°å¢ä»£ç ç»“æŸ ---

                // å¦‚æœç”¨æˆ·é€‰æ‹©äº†é¢å…·ï¼Œä½¿ç”¨é¢å…·åç§°
        if (selectedPersona && selectedPersona.name) { // <--- ä¿®æ”¹è¿™é‡Œ
            defaultNickname = selectedPersona.name;
                }

        // ä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·åœ¨ç¾¤èŠä¸­è‡ªå·±è®¾ç½®çš„æ˜µç§°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¾ç¤ºåˆ›å»ºç¾¤èŠæ—¶é€‰æ‹©çš„èº«ä»½æ˜µç§°
        currentMyGroupNickname.textContent = chatSettings.myChatNickname || defaultNickname;
            }

            // æ¸²æŸ“ç¾¤æˆå‘˜ç½‘æ ¼
            renderGroupMembersGrid();
        }

        function changeGroupAvatar() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*,.jpg,.jpeg,.png,.gif,.webp';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);

            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        // æ›´æ–°å½“å‰ç¾¤èŠè§’è‰²çš„å¤´åƒ
                        currentChatCharacter.avatarUrl = event.target.result;

                        // å¦‚æœæ˜¯ç¾¤èŠï¼Œéœ€è¦æ›´æ–°ç¾¤èŠæ•°æ®
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].avatarUrl = event.target.result;
                                await saveGroupChats(groupChats);
                            }
                        }

                        // æ›´æ–°UIæ˜¾ç¤º
                        updateGroupChatInfo();

                        // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                        let displayTitle = currentChatCharacter.name;
                        if (currentChatCharacter.members) {
                            const memberCount = currentChatCharacter.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                            displayTitle = `${currentChatCharacter.name}ï¼ˆ${memberCount}ï¼‰`;
                        }
                        const chatTitle = document.getElementById('api-chat-title');
                        if (chatTitle) {
                            chatTitle.textContent = displayTitle;
                            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                            chatTitle.classList.remove('typing-status');
                            chatTitle.dataset.originalTitle = displayTitle;
                        }

                        // æ›´æ–°å¤´åƒæ˜¾ç¤º
                        const chatAvatarElement = document.querySelector('#api-chat-screen .message-avatar img');
                        if (chatAvatarElement) {
                            chatAvatarElement.src = event.target.result;
                        }

                        // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨å’Œè”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠå¤´åƒ
                        renderContactList();
                        renderMessageList();

                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    document.body.removeChild(tempInput);
                }
            };

            tempInput.click();
        }

        function changeGroupName() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç¾¤èŠåç§°:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const trimmedName = newName.trim();

                // æ›´æ–°å½“å‰ç¾¤èŠè§’è‰²çš„åç§°
                currentChatCharacter.name = trimmedName;

                // å¦‚æœæ˜¯ç¾¤èŠï¼Œéœ€è¦æ›´æ–°ç¾¤èŠæ•°æ®
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].name = trimmedName;
                        saveGroupChats(groupChats);
                    }
                }

                // æ›´æ–°UIæ˜¾ç¤º
                updateGroupChatInfo();

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¾¤èŠæ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                let displayTitle = trimmedName;
                if (currentChatCharacter.members) {
                    const memberCount = currentChatCharacter.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                    displayTitle = `${trimmedName}ï¼ˆ${memberCount}ï¼‰`;
                }
                const chatTitle = document.getElementById('api-chat-title');
                if (chatTitle) {
                    chatTitle.textContent = displayTitle;
                    // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                    chatTitle.classList.remove('typing-status');
                    chatTitle.dataset.originalTitle = displayTitle;
                }
                renderContactList();
                renderMessageList();
            }
        }

// --- è¯·ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œæ›¿æ¢æ‰æ—§çš„ showGroupChatMemberSelection å’Œ renderGroupMembersGrid å‡½æ•° ---

// 5. æ˜¾ç¤ºç¾¤æˆå‘˜é€‰æ‹© (å·²ä¿®æ­£ç‰ˆæœ¬)
function showGroupChatMemberSelection(personaId) {
    console.log('âœ… ç¬¬äºŒä¸ªshowGroupChatMemberSelectionè¢«è°ƒç”¨ï¼Œæ¥æ”¶åˆ°çš„personaId:', personaId);

    // ç«‹å³å°†personaIdå­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±
    window.currentGroupPersonaId = personaId;

    // é‡ç½®è¡¨å•
    document.getElementById('group-chat-name').value = '';
    selectedGroupMembers = [];

    const membersContainer = document.getElementById('group-chat-members');
    membersContainer.innerHTML = '';

    if (characters.length < 2) {
        membersContainer.innerHTML = '<p class="empty-mount-chats">è‡³å°‘éœ€è¦2ä¸ªè§’è‰²æ‰èƒ½åˆ›å»ºç¾¤èŠ</p>';
    } else {
        characters.forEach(character => {
            const memberItem = document.createElement('div');
            memberItem.className = 'group-member-item';
            memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // å…³é”®ä¿®å¤ï¼šé‡æ–°æ·»åŠ äº†æ˜¾ç¤ºè§’è‰²ç®€ä»‹çš„HTMLä»£ç 
            memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                    ${character.avatarUrl ? '' : character.name.charAt(0)}
                </div>
                <div class="chat-option-text">
                    <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'æš‚æ— ç®€ä»‹', 80)}</div>
                </div>`;
            membersContainer.appendChild(memberItem);
        });
    }

    // å°† personaId é™„åŠ åˆ°åˆ›å»ºæŒ‰é’®ä¸Š
    console.log('âœ… åœ¨ç¬¬äºŒä¸ªä½ç½®ç»‘å®šåˆ›å»ºæŒ‰é’®ï¼ŒpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('âœ… ç¬¬äºŒä¸ªä½ç½®çš„åˆ›å»ºç¾¤èŠæŒ‰é’®è¢«ç‚¹å‡»ï¼Œç›´æ¥ä½¿ç”¨å‚æ•°personaId:', personaId);
        createGroupChat(personaId);
    }; // ç»‘å®šå¸¦å‚æ•°çš„åˆ›å»ºå‡½æ•°

    showModal('group-chat-modal');
}


// æ¸²æŸ“ç¾¤æˆå‘˜ç½‘æ ¼ (å·²ä¿®æ­£ç‰ˆæœ¬)
        function renderGroupMembersGrid() {
            const groupMembersGrid = document.getElementById('group-members-grid');
            if (!groupMembersGrid || !currentChatCharacter || !currentChatCharacter.isGroup) return;

            // æ¸…ç©ºç°æœ‰å†…å®¹
            groupMembersGrid.innerHTML = '';

    // --- å…³é”®ä¿®å¤ï¼šæ­£ç¡®è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·åœ¨å½“å‰ç¾¤èŠä¸­çš„èº«ä»½ ---
    const chatSettings = getCurrentChatSettings(); // è·å–å½“å‰ç¾¤èŠçš„ä¸“å±è®¾ç½®
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);

            let userName = 'ç”¨æˆ·';
            let userAvatar = '';

    if (selectedPersona) {
        // ä¼˜å…ˆä½¿ç”¨ç¾¤èŠè®¾ç½®é‡Œä¸ºâ€œæˆ‘â€å•ç‹¬è®¾ç½®çš„æ˜µç§°å’Œå¤´åƒ
        userName = chatSettings.myChatNickname || selectedPersona.name;
        userAvatar = chatSettings.myChatAvatar || selectedPersona.avatarUrl;
    }

    // æ·»åŠ ç”¨æˆ·è‡ªå·±ï¼ˆæ’åœ¨ç¬¬ä¸€ä½ï¼‰
    const userItem = document.createElement('div');
    userItem.className = 'member-item user-member';
    userItem.onclick = () => changeMyGroupAvatar();
            userItem.innerHTML = `
                <img class="member-avatar" src="${userAvatar || createDefaultAvatar(userName)}" alt="${userName}">
                <div class="member-name">${userName}</div>
            `;
            groupMembersGrid.appendChild(userItem);
    // --- ä¿®å¤ç»“æŸ ---

            // ç„¶åæ·»åŠ ç¾¤å†…ç°æœ‰è§’è‰²
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                currentChatCharacter.members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';

                    memberItem.innerHTML = `
                        <div class="member-avatar-wrapper">
                            <img class="member-avatar clickable-avatar"
                                 src="${member.avatarUrl || createDefaultAvatar(member.name)}"
                                 alt="${member.name}"
                                 onclick="changeMemberAvatar('${member.id}', event)"
                                 title="ç‚¹å‡»æ›´æ¢${member.name}çš„å¤´åƒ">
                            <div class="avatar-hover-hint">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="member-name">${member.name}</div>
                    `;
                    groupMembersGrid.appendChild(memberItem);
                });
            }

            // æ·»åŠ é‚€è¯·æŒ‰é’®
            const addMemberBtn = document.createElement('div');
            addMemberBtn.className = 'member-item add-member';
            addMemberBtn.onclick = () => addGroupMember();
            addMemberBtn.innerHTML = `
                <div class="member-avatar add-avatar">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="member-name">é‚€è¯·</div>
            `;
            groupMembersGrid.appendChild(addMemberBtn);

            // åªè¦ç¾¤å†…æœ‰è§’è‰²æˆå‘˜å°±æ˜¾ç¤ºç§»é™¤æŒ‰é’®
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                const removeMemberBtn = document.createElement('div');
                removeMemberBtn.className = 'member-item remove-member';
                removeMemberBtn.onclick = () => removeGroupMember();
                removeMemberBtn.innerHTML = `
                    <div class="member-avatar remove-avatar">
                        <i class="fas fa-minus"></i>
                    </div>
                    <div class="member-name">ç§»é™¤</div>
                `;
                groupMembersGrid.appendChild(removeMemberBtn);
            }
        }

// --- è¯·å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ ---

        // æ˜¾ç¤ºæˆå‘˜è¯¦æƒ…
        function showMemberProfile(member) {
            alert(`ğŸ‘¤ ç¾¤æˆå‘˜ä¿¡æ¯\n\næ˜µç§°ï¼š${member.name}\nè§’è‰²IDï¼š${member.id}\n\nç‚¹å‡»å¤´åƒå¯ä»¥æŸ¥çœ‹è§’è‰²è¯¦ç»†ä¿¡æ¯`);
        }

        // æ˜¾ç¤ºç”¨æˆ·è‡ªå·±çš„èµ„æ–™
        function showUserProfile() {
            let userName = 'ç”¨æˆ·';
            let userInfo = 'ç¾¤èŠæˆå‘˜';

            if (currentChatCharacter.myNickname) {
                userName = currentChatCharacter.myNickname;
                userInfo = `ç¾¤æ˜µç§°ï¼š${currentChatCharacter.myNickname}`;
            }

            alert(`ğŸ‘¤ æˆ‘çš„ä¿¡æ¯\n\næ˜µç§°ï¼š${userName}\nèº«ä»½ï¼š${userInfo}\n\nè¿™æ˜¯ä½ è‡ªå·±åœ¨ç¾¤èŠä¸­çš„ä¿¡æ¯`);
        }

        // åˆ›å»ºé»˜è®¤å¤´åƒ
        function createDefaultAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');

            // éšæœºèƒŒæ™¯é¢œè‰²
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];
            const bgColor = colors[name.charCodeAt(0) % colors.length];

            // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯
            ctx.beginPath();
            ctx.arc(25, 25, 25, 0, 2 * Math.PI);
            ctx.fillStyle = bgColor;
            ctx.fill();

            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name.charAt(0), 25, 25);

            return canvas.toDataURL();
        }

        function showGroupMembers() {
            alert('ğŸ‘¥ ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...\n\nå°†æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š\nâ€¢ æŸ¥çœ‹ç¾¤æˆå‘˜åˆ—è¡¨\nâ€¢ è®¾ç½®ç¾¤ç®¡ç†å‘˜\nâ€¢ ç®¡ç†ç¾¤æˆå‘˜æƒé™\nâ€¢ ç¦è¨€/è¸¢å‡ºç¾¤èŠ');
        }

        async function changeMyGroupNickname() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

    const chatSettings = getCurrentChatSettings();
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);

    const currentNickname = chatSettings.myChatNickname || (selectedPersona ? selectedPersona.name : 'ç”¨æˆ·');
    const newNickname = prompt('è¯·è¾“å…¥æˆ‘åœ¨æœ¬ç¾¤çš„æ˜µç§°:', currentNickname);

    if (newNickname && newNickname.trim() !== '' && newNickname.trim() !== currentNickname) {
                const trimmedNickname = newNickname.trim();

        // 1. æ›´æ–°å½“å‰ç¾¤èŠè®¾ç½®ä¸­çš„æ˜µç§°
        chatSettings.myChatNickname = trimmedNickname;
        await saveCurrentChatSettings(chatSettings);

        // 2. åˆ›å»ºå¹¶æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        const systemMessage = {
            id: 'system_' + Date.now(),
            sender: 'system',
            content: `ä½ å·²å°†ç¾¤æ˜µç§°ä¿®æ”¹ä¸º "${trimmedNickname}"`,
            timestamp: Date.now()
        };

        if (!chatMessages[currentChatCharacter.id]) {
            chatMessages[currentChatCharacter.id] = [];
        }
        chatMessages[currentChatCharacter.id].push(systemMessage);
        // ğŸ”¥ã€ä¼˜åŒ–ã€‘ç¾¤æ˜µç§°ä¿®æ”¹ä½¿ç”¨é«˜æ•ˆä¿å­˜
        try {
            await saveChatMessagesImmediate([currentChatCharacter.id]);
            console.log('âœ… [é«˜æ•ˆç¾¤æ˜µç§°ä¿®æ”¹] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
        } catch (error) {
            console.error('ç¾¤æ˜µç§°ä¿®æ”¹æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
            await saveChatMessages();
        }

        // 3. æ›´æ–°UI
        updateGroupChatInfo(); // è¿™ä¼šåˆ·æ–°è®¾ç½®é¡µé¢çš„æ˜¾ç¤º
        renderChatMessages(currentChatCharacter.id); // åˆ·æ–°èŠå¤©ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

        showToast('ç¾¤æ˜µç§°ä¿®æ”¹æˆåŠŸï¼', 'success');
    }
}
// --- æ–°å¢å‡½æ•° ---
async function changeMyGroupAvatar() {
    if (!currentChatCharacter) return;

    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶è¾“å…¥æ¡†
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,.jpg,.jpeg,.png,.gif,.webp';
    input.style.display = 'none';

    // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶å
    input.onchange = async (e) => {
        if (!e.target.files || !e.target.files[0]) return;

        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async (event) => {
            const newAvatarUrl = event.target.result;

            // 1. æ›´æ–°å½“å‰ç¾¤èŠè®¾ç½®ä¸­çš„å¤´åƒ
            const chatSettings = getCurrentChatSettings();
            chatSettings.myChatAvatar = newAvatarUrl;
            await saveCurrentChatSettings(chatSettings);

            // 2. åˆ›å»ºå¹¶æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            const systemMessage = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `ä½ æ›´æ¢äº†æ–°å¤´åƒ`,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(systemMessage);
            // ğŸ”¥ã€ä¼˜åŒ–ã€‘ç¾¤å¤´åƒæ›´æ¢ä½¿ç”¨é«˜æ•ˆä¿å­˜
            try {
                await saveChatMessagesImmediate([currentChatCharacter.id]);
                console.log('âœ… [é«˜æ•ˆç¾¤å¤´åƒæ›´æ¢] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('ç¾¤å¤´åƒæ›´æ¢æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                await saveChatMessages();
            }

            // 3. æ›´æ–°UI
            updateGroupChatInfo(); // åˆ·æ–°è®¾ç½®é¡µé¢çš„æˆå‘˜åˆ—è¡¨
            renderChatMessages(currentChatCharacter.id); // åˆ·æ–°èŠå¤©ç•Œé¢æ˜¾ç¤ºæ–°å¤´åƒå’Œç³»ç»Ÿæ¶ˆæ¯

            showToast('ç¾¤å¤´åƒæ›´æ¢æˆåŠŸï¼', 'success');
        };

        reader.readAsDataURL(file);
        document.body.removeChild(input); // æ¸…ç†ä¸´æ—¶çš„inputå…ƒç´ 
    };

    document.body.appendChild(input);
    input.click(); // å¼¹å‡ºæ–‡ä»¶é€‰æ‹©çª—å£
        }

        // ç¼–è¾‘ç¾¤å…¬å‘Š
        function editGroupDescription() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            showGroupNoticeModal();
        }

        // æ˜¾ç¤ºç¾¤å…¬å‘Šç¼–è¾‘æ¨¡æ€æ¡†
        function showGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');

            // è®¾ç½®å½“å‰ç¾¤å…¬å‘Šå†…å®¹
            const currentDescription = currentChatCharacter?.description || '';
            textarea.value = currentDescription;
            charCount.textContent = currentDescription.length;

            // ç›‘å¬å­—ç¬¦æ•°å˜åŒ–
            textarea.addEventListener('input', updateNoticeCharCount);

            modal.style.display = 'flex';
            setTimeout(() => textarea.focus(), 100);
        }

        // éšè—ç¾¤å…¬å‘Šç¼–è¾‘æ¨¡æ€æ¡†
        function hideGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');

            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            textarea.removeEventListener('input', updateNoticeCharCount);

            modal.style.display = 'none';
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateNoticeCharCount() {
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');
            charCount.textContent = textarea.value.length;

            // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œå˜è‰²æç¤º
            if (textarea.value.length > 500) {
                charCount.style.color = '#ff3b30';
            } else if (textarea.value.length > 450) {
                charCount.style.color = '#ff9500';
            } else {
                charCount.style.color = '#007AFF';
            }
        }

        // ä¿å­˜ç¾¤å…¬å‘Š
        function saveGroupNotice() {
            const textarea = document.getElementById('group-notice-content');
            const newDescription = textarea.value.trim();

            if (newDescription.length > 500) {
                alert('ç¾¤å…¬å‘Šå†…å®¹ä¸èƒ½è¶…è¿‡500å­—');
                return;
            }

                // æ›´æ–°å½“å‰ç¾¤èŠè§’è‰²çš„æè¿°
            currentChatCharacter.description = newDescription;

                // å¦‚æœæ˜¯ç¾¤èŠï¼Œéœ€è¦æ›´æ–°ç¾¤èŠæ•°æ®
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                    groupChats[groupIndex].description = newDescription;
                        saveGroupChats(groupChats);
                    }
                }

                // æ›´æ–°UIæ˜¾ç¤º
                updateGroupChatInfo();
            hideGroupNoticeModal();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('âœ… ç¾¤å…¬å‘Šä¿å­˜æˆåŠŸ', 'success');
        }

        // æ·»åŠ ç¾¤æˆå‘˜ - ä»ç°æœ‰è§’è‰²ä¸­é€‰æ‹©
        function addGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;

            // è·å–æ‰€æœ‰è§’è‰²åˆ—è¡¨
            if (!characters || characters.length === 0) {
                alert('æš‚æ— å¯é‚€è¯·çš„è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²');
                return;
            }

            // è¿‡æ»¤æ‰å·²ç»åœ¨ç¾¤é‡Œçš„è§’è‰²
            const currentMemberIds = currentChatCharacter.members ? currentChatCharacter.members.map(m => m.id) : [];
            const availableCharacters = characters.filter(char => !currentMemberIds.includes(char.id));

            if (availableCharacters.length === 0) {
                alert('æ‰€æœ‰è§’è‰²éƒ½å·²ç»åœ¨ç¾¤é‡Œäº†');
                return;
            }

            // åˆ›å»ºç¾è§‚çš„é€‰æ‹©ç•Œé¢
            showCharacterSelectionModal(availableCharacters, 'é‚€è¯·ç¾¤æˆå‘˜', 'è¯·é€‰æ‹©è¦é‚€è¯·è¿›ç¾¤çš„è§’è‰²ï¼š', (selectedCharacter) => {
                // æ·»åŠ åˆ°ç¾¤æˆå‘˜åˆ—è¡¨
                if (!currentChatCharacter.members) {
                    currentChatCharacter.members = [];
                }
                currentChatCharacter.members.push({
                    id: selectedCharacter.id,
                    name: selectedCharacter.name,
                    avatarUrl: selectedCharacter.avatarUrl
                });

                // ä¿å­˜ç¾¤èŠæ•°æ®
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯ï¼Œè®©AIçŸ¥é“æœ‰æ–°æˆå‘˜åŠ å…¥
                const systemMessage = {
                    id: Date.now().toString(),
                    content: `${selectedCharacter.name} åŠ å…¥äº†ç¾¤èŠ`,
                    timestamp: Date.now(),
                    sender: 'system',
                    type: 'system_notification'
                };

                // ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(systemMessage);
                saveChatMessages();

                // æ›´æ–°UI
                updateGroupChatInfo();
                renderChatMessages(currentChatCharacter.id); // åˆ·æ–°èŠå¤©ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

                // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                const chatTitle = document.getElementById('api-chat-title');
                if (chatTitle) {
                    let displayTitle = currentChatCharacter.name;
                    const memberCount = currentChatCharacter.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                    displayTitle = `${displayTitle}ï¼ˆ${memberCount}ï¼‰`;
                    chatTitle.textContent = displayTitle;
                    // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                    chatTitle.classList.remove('typing-status');
                    chatTitle.dataset.originalTitle = displayTitle;
                }

                showToast(`âœ… ${selectedCharacter.name} å·²åŠ å…¥ç¾¤èŠ`, 'success');
            });
        }

        // ç§»é™¤ç¾¤æˆå‘˜
        function removeGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup || !currentChatCharacter.members) return;

            if (currentChatCharacter.members.length <= 1) {
                alert('ç¾¤èŠè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè§’è‰²æˆå‘˜ï¼ˆä¸åŒ…æ‹¬ç”¨æˆ·è‡ªå·±ï¼‰');
                return;
            }

            // åˆ›å»ºç¾è§‚çš„é€‰æ‹©ç•Œé¢
            showCharacterSelectionModal(currentChatCharacter.members, 'ç§»é™¤ç¾¤æˆå‘˜', 'è¯·é€‰æ‹©è¦ç§»å‡ºç¾¤èŠçš„æˆå‘˜ï¼š', (selectedMember) => {
                if (confirm(`ç¡®å®šè¦å°† ${selectedMember.name} ç§»å‡ºç¾¤èŠå—ï¼Ÿ`)) {
                    // ä»ç¾¤æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤
                    const memberIndex = currentChatCharacter.members.findIndex(m => m.id === selectedMember.id);
                    if (memberIndex !== -1) {
                        currentChatCharacter.members.splice(memberIndex, 1);

                        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯ï¼Œè®©AIçŸ¥é“æœ‰æˆå‘˜é€€å‡º
                        const systemMessage = {
                            id: Date.now().toString(),
                            content: `${selectedMember.name} é€€å‡ºäº†ç¾¤èŠ`,
                            timestamp: Date.now(),
                            sender: 'system',
                            type: 'system_notification'
                        };

                        // ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                        if (!chatMessages[currentChatCharacter.id]) {
                            chatMessages[currentChatCharacter.id] = [];
                        }
                        chatMessages[currentChatCharacter.id].push(systemMessage);
                        saveChatMessages();

                        // ä¿å­˜ç¾¤èŠæ•°æ®
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].members = currentChatCharacter.members;
                                saveGroupChats(groupChats);
                            }
                        }

                        // æ›´æ–°UI
                        updateGroupChatInfo();
                        renderChatMessages(currentChatCharacter.id); // åˆ·æ–°èŠå¤©ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

                        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜æ˜¾ç¤ºæˆå‘˜æ•°é‡
                        const chatTitle = document.getElementById('api-chat-title');
                        if (chatTitle) {
                            let displayTitle = currentChatCharacter.name;
                            const memberCount = currentChatCharacter.members.length + 1; // +1 åŒ…æ‹¬ç”¨æˆ·è‡ªå·±
                            displayTitle = `${displayTitle}ï¼ˆ${memberCount}ï¼‰`;
                            chatTitle.textContent = displayTitle;
                            // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€å¹¶ä¿å­˜æ–°çš„åŸå§‹æ ‡é¢˜
                            chatTitle.classList.remove('typing-status');
                            chatTitle.dataset.originalTitle = displayTitle;
                        }

                        showToast(`âœ… ${selectedMember.name} å·²è¢«ç§»å‡ºç¾¤èŠ`, 'success');
                    }
                }
            });
        }

        // ç¾¤å…¬å‘ŠåŠŸèƒ½
        function showGroupNotice() {
            const notice = currentChatCharacter?.description || 'æš‚æ— ç¾¤å…¬å‘Š';
            alert(`ğŸ“¢ ç¾¤å…¬å‘Š\n\n${notice}\n\nç‚¹å‡»ç¾¤ä¿¡æ¯å¡ç‰‡çš„å…¬å‘ŠåŒºåŸŸå¯ä»¥ç¼–è¾‘ç¾¤å…¬å‘Š`);
        }





        // æ˜¾ç¤ºè§’è‰²é€‰æ‹©æ¨¡æ€æ¡†
        function showCharacterSelectionModal(characterList, title, description, onSelect) {
            const modalHTML = `
                <div class="modal character-selection-modal" id="character-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="hideCharacterSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">${description}</p>
                            <div class="character-selection-grid" id="character-selection-grid">
                                ${characterList.map(char => `
                                    <div class="character-selection-item" data-character-id="${char.id}">
                                        <div class="character-selection-avatar">
                                            <img src="${char.avatarUrl || createDefaultAvatar(char.name)}" alt="${char.name}">
                                        </div>
                                        <div class="character-selection-info">
                                            <div class="character-selection-name">${char.name}</div>
                                            <div class="character-selection-bio">${(char.description || char.bio || 'æš‚æ— ç®€ä»‹').substring(0, 30)}${(char.description || char.bio || '').length > 30 ? '...' : ''}</div>
                                        </div>
                                        <div class="character-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hideCharacterSelectionModal()">å–æ¶ˆ</button>
                            <button class="modal-primary" id="confirm-selection-btn" onclick="confirmCharacterSelection()" disabled>ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('character-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            window.characterSelectionCallback = onSelect;
            window.selectedCharacterId = null;

            document.querySelectorAll('.character-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.character-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedCharacterId = this.dataset.characterId;
                    document.getElementById('confirm-selection-btn').disabled = false;
                });
            });
        }

        // éšè—è§’è‰²é€‰æ‹©æ¨¡æ€æ¡†
        function hideCharacterSelectionModal() {
            const modal = document.getElementById('character-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.characterSelectionCallback = null;
            window.selectedCharacterId = null;
        }

        // ç¡®è®¤è§’è‰²é€‰æ‹©
        function confirmCharacterSelection() {
            if (!window.selectedCharacterId || !window.characterSelectionCallback) return;

            const allCharacters = [...characters, ...(currentChatCharacter.members || [])];
            const selectedCharacter = allCharacters.find(char => char.id === window.selectedCharacterId);

            if (selectedCharacter) {
                window.characterSelectionCallback(selectedCharacter);
                hideCharacterSelectionModal();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤æˆå‘˜å¤´åƒæ›´æ¢åŠŸèƒ½
        function changeMemberAvatar(memberId, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            const member = currentChatCharacter.members.find(m => m.id === memberId);
            if (!member) return;

            // æ˜¾ç¤ºå¤´åƒæ›´æ¢æ¨¡æ€æ¡†
            showMemberAvatarModal(member);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºç¾¤æˆå‘˜å¤´åƒæ›´æ¢æ¨¡æ€æ¡†
        function showMemberAvatarModal(member) {
            const modal = document.getElementById('member-avatar-modal');
            const preview = document.getElementById('member-avatar-preview');
            const memberName = document.getElementById('member-avatar-name');
            const uploadInput = document.getElementById('member-avatar-upload');

            // è®¾ç½®å½“å‰æˆå‘˜ä¿¡æ¯
            window.currentEditingMember = member;
            memberName.textContent = member.name;
            preview.src = member.avatarUrl || createDefaultAvatar(member.name);

            // é‡ç½®æ–‡ä»¶è¾“å…¥
            uploadInput.value = '';

            modal.style.display = 'flex';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—ç¾¤æˆå‘˜å¤´åƒæ›´æ¢æ¨¡æ€æ¡†
        function hideMemberAvatarModal() {
            const modal = document.getElementById('member-avatar-modal');
            modal.style.display = 'none';
            window.currentEditingMember = null;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†ç¾¤æˆå‘˜å¤´åƒä¸Šä¼ 
        function handleMemberAvatarUpload() {
            const uploadInput = document.getElementById('member-avatar-upload');
            uploadInput.click();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜ç¾¤æˆå‘˜å¤´åƒ
        function saveMemberAvatar() {
            if (!window.currentEditingMember) return;

            const preview = document.getElementById('member-avatar-preview');
            const newAvatarUrl = preview.src;

            // æ›´æ–°ç¾¤æˆå‘˜å¤´åƒ
            const memberIndex = currentChatCharacter.members.findIndex(m => m.id === window.currentEditingMember.id);
            if (memberIndex !== -1) {
                currentChatCharacter.members[memberIndex].avatarUrl = newAvatarUrl;

                // åŒæ—¶æ›´æ–°å…¨å±€è§’è‰²åˆ—è¡¨ä¸­çš„å¤´åƒ
                const characterIndex = characters.findIndex(c => c.id === window.currentEditingMember.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].avatarUrl = newAvatarUrl;
                    saveCharacters(characters);
                }

                // ä¿å­˜ç¾¤èŠæ•°æ®
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘åœ¨ç¾¤èŠæ¶ˆæ¯ä¸­æ·»åŠ å¤´åƒæ›´æ¢æç¤º
                addAvatarChangeMessage(window.currentEditingMember.name);

                // æ›´æ–°UI
                updateGroupChatInfo();
                renderGroupMembersGrid();
                refreshChatMessages(); // åˆ·æ–°èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºæ–°å¤´åƒ

                showToast(`âœ… ${window.currentEditingMember.name} çš„å¤´åƒå·²æ›´æ–°`, 'success');
            }

            hideMemberAvatarModal();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ å¤´åƒæ›´æ¢ç³»ç»Ÿæ¶ˆæ¯
        function addAvatarChangeMessage(memberName) {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            const systemMessage = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `${memberName} æ›´æ¢äº†å¤´åƒ`,
                timestamp: Date.now(),
                isSystem: true
            };

            chatMessages[currentChatCharacter.id].push(systemMessage);
            saveChatMessages();

            // åˆ·æ–°èŠå¤©ç•Œé¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ·æ–°èŠå¤©æ¶ˆæ¯ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
        function refreshChatMessages() {
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é‡ç½®ç¾¤æˆå‘˜å¤´åƒä¸ºé»˜è®¤
        function resetMemberAvatar() {
            if (!window.currentEditingMember) return;

            const preview = document.getElementById('member-avatar-preview');
            const defaultAvatar = createDefaultAvatar(window.currentEditingMember.name);
            preview.src = defaultAvatar;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®æ¢å¤æ£€æŸ¥å’Œä¿®å¤åŠŸèƒ½
        async function checkAndFixChatHistory() {
            try {
                console.log('å¼€å§‹æ£€æŸ¥èŠå¤©å†å²æ•°æ®...');

                // æ£€æŸ¥IndexedDBä¸­çš„æ•°æ®
                const dbMessages = await db.chatMessages.toArray();
                const memoryMessages = chatMessages;

                console.log('IndexedDBä¸­çš„æ¶ˆæ¯æ•°:', dbMessages.length);
                console.log('å†…å­˜ä¸­çš„èŠå¤©æ•°:', Object.keys(memoryMessages).length);

                // æ£€æŸ¥æ˜¯å¦æœ‰localStorageçš„å¤‡ä»½æ•°æ®
                const localStorageBackup = localStorage.getItem('chatMessages');
                if (localStorageBackup) {
                    try {
                        const backupData = JSON.parse(localStorageBackup);
                        console.log('æ‰¾åˆ°localStorageå¤‡ä»½æ•°æ®');

                        // æ¯”è¾ƒæ•°æ®æ—¶é—´æˆ³ï¼Œé€‰æ‹©æœ€æ–°çš„
                        let shouldUseBackup = false;
                        let newerMessagesCount = 0;

                        for (const [characterId, messages] of Object.entries(backupData)) {
                            if (messages && messages.length > 0) {
                                const latestBackupTime = Math.max(...messages.map(m => m.timestamp || 0));
                                const currentMessages = memoryMessages[characterId] || [];
                                const latestCurrentTime = currentMessages.length > 0 ?
                                    Math.max(...currentMessages.map(m => m.timestamp || 0)) : 0;

                                if (latestBackupTime > latestCurrentTime) {
                                    console.log(`è§’è‰² ${characterId} çš„å¤‡ä»½æ•°æ®æ›´æ–° (å¤‡ä»½:${new Date(latestBackupTime)}, å½“å‰:${new Date(latestCurrentTime)})`);
                                    shouldUseBackup = true;
                                    newerMessagesCount += messages.length - currentMessages.length;
                                }
                            }
                        }

                        if (shouldUseBackup) {
                            const confirmRestore = confirm(`æ£€æµ‹åˆ°localStorageä¸­æœ‰æ›´æ–°çš„èŠå¤©è®°å½•ï¼\n\nå‘ç° ${newerMessagesCount} æ¡æ›´æ–°çš„æ¶ˆæ¯\n\næ˜¯å¦æ¢å¤è¿™äº›æ•°æ®ï¼Ÿ`);
                            if (confirmRestore) {
                                // æ¢å¤æ•°æ®
                                Object.assign(chatMessages, backupData);
                                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ•°æ®æ¢å¤ä½¿ç”¨é«˜æ•ˆä¿å­˜
                                try {
                                    const restoredCharacterIds = Object.keys(backupData);
                                    await saveChatMessagesImmediate(restoredCharacterIds);
                                    console.log('âœ… [é«˜æ•ˆæ•°æ®æ¢å¤] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                                } catch (error) {
                                    console.error('æ•°æ®æ¢å¤ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                                    await saveChatMessages();
                                }

                                // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©
                                if (currentChatCharacter) {
                                    renderChatMessages(currentChatCharacter.id);
                                }

                                showToast(`å·²æ¢å¤ ${newerMessagesCount} æ¡æ¶ˆæ¯ï¼`, 'success');
                                return true;
                            }
                        }
                    } catch (e) {
                        console.error('è§£æå¤‡ä»½æ•°æ®å¤±è´¥:', e);
                    }
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„æ—¶é—´æˆ³ï¼ˆæœªæ¥æ—¶é—´æˆ–è¿‡è€æ—¶é—´ï¼‰
                let fixedCount = 0;
                const now = Date.now();
                const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);

                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    if (messages && Array.isArray(messages)) {
                        for (let i = 0; i < messages.length; i++) {
                            const msg = messages[i];
                            if (!msg.timestamp || msg.timestamp > now || msg.timestamp < oneWeekAgo) {
                                // ä¿®å¤å¼‚å¸¸æ—¶é—´æˆ³
                                const correctedTime = now - (messages.length - i) * 60000; // æŒ‰é¡ºåºé€’å‡1åˆ†é’Ÿ
                                console.log(`ä¿®å¤æ¶ˆæ¯æ—¶é—´æˆ³: ${msg.timestamp} -> ${correctedTime}`);
                                msg.timestamp = correctedTime;
                                fixedCount++;
                            }
                        }

                        // é‡æ–°æ’åºæ¶ˆæ¯
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                    }
                }

                if (fixedCount > 0) {
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ—¶é—´æˆ³ä¿®å¤ä½¿ç”¨é«˜æ•ˆä¿å­˜
                    try {
                        const fixedCharacterIds = Object.keys(chatMessages).filter(id =>
                            chatMessages[id] && chatMessages[id].length > 0);
                        await saveChatMessagesImmediate(fixedCharacterIds);
                        console.log('âœ… [é«˜æ•ˆæ—¶é—´æˆ³ä¿®å¤] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('æ—¶é—´æˆ³ä¿®å¤ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }
                    showToast(`ä¿®å¤äº† ${fixedCount} æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³`, 'info');
                }

                return false;
            } catch (error) {
                console.error('æ£€æŸ¥èŠå¤©å†å²å¤±è´¥:', error);
                return false;
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
            }, 100);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ–‡æœ¬æˆªæ–­å‡½æ•°
        function truncateText(text, maxLength = 80) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿textæ˜¯å­—ç¬¦ä¸²ç±»å‹
            if (text === null || text === undefined) {
                return '';
            }

            // å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            if (typeof text !== 'string') {
                text = String(text);
            }

            if (!text || text.length <= maxLength) return text;

            // æŒ‰è¡Œåˆ†å‰²æ–‡æœ¬
            const lines = text.split('\n');
            let result = '';
            let lineCount = 0;

            for (const line of lines) {
                // é™åˆ¶æœ€å¤šæ˜¾ç¤º3è¡Œ
                if (lineCount >= 3) break;

                if (result.length + line.length + 1 <= maxLength) {
                    result += (result ? '\n' : '') + line;
                    lineCount++;
                } else {
                    // å¦‚æœè¿™ä¸€è¡Œä¼šè¶…å‡ºé•¿åº¦é™åˆ¶ï¼Œæˆªæ–­å¹¶æ·»åŠ çœç•¥å·
                    const remaining = maxLength - result.length - 1;
                    if (remaining > 10) { // ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºæœ‰æ„ä¹‰çš„å†…å®¹
                        result += (result ? '\n' : '') + line.substring(0, remaining - 3) + '...';
                    } else if (!result) {
                        // å¦‚æœæ˜¯ç¬¬ä¸€è¡Œå°±è¶…é•¿ï¼Œç›´æ¥æˆªæ–­
                        result = line.substring(0, maxLength - 3) + '...';
                    } else {
                        // å¦åˆ™åœ¨å½“å‰ç»“æœååŠ çœç•¥å·
                        result += '...';
                    }
                    break;
                }
            }

            return result;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¶ˆæ¯åˆ—è¡¨å¤šé€‰åˆ é™¤åŠŸèƒ½

        // è¿›å…¥æ¶ˆæ¯åˆ—è¡¨å¤šé€‰æ¨¡å¼
        function enterMessageListMultiSelectMode(conversationId) {
            console.log('è§¦å‘é•¿æŒ‰å¤šé€‰æ¨¡å¼ï¼Œå¯¹è¯ID:', conversationId); // è°ƒè¯•ä¿¡æ¯
            isMessageListMultiSelectMode = true;
            selectedConversations = [conversationId]; // å°†è§¦å‘é•¿æŒ‰çš„å¯¹è¯æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
            renderMessageList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ˜¾ç¤ºå¤šé€‰ç•Œé¢
            showToast('å·²è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œå¯ä»¥é€‰æ‹©å¤šä¸ªå¯¹è¯è¿›è¡Œåˆ é™¤', 'info');
        }

        // é€€å‡ºæ¶ˆæ¯åˆ—è¡¨å¤šé€‰æ¨¡å¼
        function exitMessageListMultiSelectMode() {
            isMessageListMultiSelectMode = false;
            selectedConversations = [];

            renderMessageList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨æ¢å¤æ­£å¸¸çŠ¶æ€
        }

        // åˆ‡æ¢å¯¹è¯é€‰æ‹©çŠ¶æ€
        function toggleConversationSelection(conversationId) {
            const index = selectedConversations.indexOf(conversationId);
            if (index > -1) {
                selectedConversations.splice(index, 1);
            } else {
                selectedConversations.push(conversationId);
            }
            renderMessageList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰æ‹©çŠ¶æ€
        }

        // åˆ é™¤é€‰ä¸­çš„å¯¹è¯
        async function deleteSelectedConversations() {
            if (selectedConversations.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¯¹è¯', 'error');
                return;
            }

            const count = selectedConversations.length;
            const confirmText = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªå¯¹è¯å—ï¼Ÿ\n\nåˆ é™¤åå°†æ¸…ç©ºå¯¹è¯çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œä¸“å±è®¾ç½®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;

            if (confirm(confirmText)) {
                try {
                    // ä½¿ç”¨ for...of å¾ªç¯æ¥ç¡®ä¿å¼‚æ­¥æ“ä½œä¸€ä¸ªæ¥ä¸€ä¸ªå®Œæˆ
                    for (const conversationId of selectedConversations) {
                        // 1. åˆ é™¤èŠå¤©æ¶ˆæ¯
                    if (chatMessages[conversationId]) {
                        delete chatMessages[conversationId];
                    }

                        // 2. [æ ¸å¿ƒä¿®å¤] ä»æ•°æ®åº“ä¸­åˆ é™¤æ­¤å¯¹è¯çš„è®¾ç½®
                        await db.chatSettings.delete(conversationId);
                        //    åŒæ—¶ä»å†…å­˜ä¸­ä¹Ÿåˆ é™¤ï¼Œä¿æŒåŒæ­¥
                        if (chatSettings[conversationId]) {
                            delete chatSettings[conversationId];
                        }

                        // 2.1 [é¢å¤–ä¿®å¤] åˆ é™¤localStorageä¸­çš„å¤‡ä»½è®¾ç½®
                        localStorage.removeItem(`chatSettings_${conversationId}`);

                        // 2.2 [å½»åº•ä¿®å¤] åˆ é™¤è§’è‰²å¯¹è±¡ä¸­çš„èƒŒæ™¯è®¾ç½®
                        const character = characters.find(c => c.id === conversationId);
                        if (character) {
                            character.background = null;
                            // è¿™é‡Œä¸éœ€è¦ç«‹å³ä¿å­˜ï¼Œåé¢ä¼šç»Ÿä¸€ä¿å­˜
                        }

                        // 3. ğŸ”¥ã€ä¿®å¤ã€‘åŒºåˆ†å•èŠå’Œç¾¤èŠçš„åˆ é™¤é€»è¾‘
                        const groupIndex = groupChats.findIndex(g => g.id === conversationId);
                        if (groupIndex > -1) {
                            // å¦‚æœæ˜¯ç¾¤èŠï¼Œä»ç¾¤èŠåˆ—è¡¨ä¸­åˆ é™¤
                            groupChats.splice(groupIndex, 1);
                        } else {
                            // å¦‚æœæ˜¯å•èŠï¼Œä»è”ç³»äººåˆ—è¡¨ä¸­ç§»é™¤ (è¿™ä»£è¡¨ç§»é™¤äº†ä¸€ä¸ª"æ´»è·ƒå¯¹è¯")
                            const contactIndex = contacts.indexOf(conversationId);
                            if (contactIndex > -1) {
                                contacts.splice(contactIndex, 1);
                            }
                        }
                    }

                    // 4. å¼‚æ­¥ä¿å­˜æ‰€æœ‰æ›´æ”¹
                    await Promise.all([
                        saveChatMessages(),
                        saveGroupChats(),
                        saveContacts()
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸å†éœ€è¦ä¿å­˜ charactersï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹è§’è‰²æœ¬èº«
                    ]);

                    // 5. é€€å‡ºå¤šé€‰æ¨¡å¼å¹¶åˆ·æ–°UI
                    exitMessageListMultiSelectMode(); // è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ renderMessageList()

                showToast(`âœ… å·²åˆ é™¤ ${count} ä¸ªå¯¹è¯`, 'success');

                } catch (error) {
                    console.error("åˆ é™¤å¯¹è¯æ—¶å‡ºé”™:", error);
                    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯', 'error');
                }
            }
        }

        // --- è®ºå›åŠŸèƒ½ ---

        let currentForumId = null;
        let worldEvent = null; // ç”¨äºå­˜å‚¨"æä¸ªå¤§æ–°é—»"çš„äº‹ä»¶

        // ã€å‡çº§ã€‘å¤„ç†ç”¨æˆ·æŠ•ç¥¨çš„å‡½æ•° (æ”¯æŒå•é€‰/å¤šé€‰)
        async function handlePollVote(optionElement, optionId) {
            const pollElement = optionElement.closest('.forum-poll');
            if (!pollElement) return;

            const pollType = pollElement.dataset.pollType || 'single';
            const postId = window.currentPostId;

            if (pollType === 'single') {
                // --- å•é€‰é€»è¾‘ ---
                const userVotedOption = localStorage.getItem(`poll_voted_${postId}`);
                if (pollElement.classList.contains('voted') || (userVotedOption && userVotedOption !== 'null')) {
                    showToast('æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†', 'info');
                    return;
                }

                if (!postId) return;

                // ç«‹å³æ›´æ–°UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°è‡ªå·±çš„é€‰æ‹©
                optionElement.classList.add('user-voted');
                pollElement.classList.add('voted');

                try {
                    const post = await db.forumPosts.get(postId);
                    if (!post) return;

                    // ç¡®ä¿ä½¿ç”¨ç»Ÿä¸€çš„optionIdæå–é€»è¾‘
                    let finalOptionId = optionId;
                    if (!finalOptionId) {
                        const textContent = optionElement.querySelector('.option-text')?.textContent || '';
                        finalOptionId = textContent.replace(/\s+/g, '_').toLowerCase();
                    }

                    // åˆå§‹åŒ–æŠ•ç¥¨æ•°æ®ç»“æ„
                    if (!post.pollData) {
                        post.pollData = { totalVotes: 0, options: {} };
                    }
                    if (!post.pollData.options[finalOptionId]) {
                        post.pollData.options[finalOptionId] = 0;
                    }

                    // æ›´æ–°ç¥¨æ•°
                    post.pollData.options[finalOptionId]++;
                    post.pollData.totalVotes++;

                    // ä¿å­˜å›æ•°æ®åº“
                    await db.forumPosts.put(post);
                    updatePollUI(postId, post.pollData);

                    // ä¿å­˜æŠ•ç¥¨è®°å½•
                    const optionText = optionElement.querySelector('.option-text')?.textContent || '';
                    saveVoteRecord(postId, finalOptionId, optionText, post.title);

                    showToast('æŠ•ç¥¨æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error("å•é€‰æŠ•ç¥¨å¤±è´¥:", error);
                    showToast('æŠ•ç¥¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }

            } else if (pollType === 'multiple') {
                // --- å¤šé€‰é€»è¾‘ ---
                const isSelected = optionElement.dataset.selected === 'true';
                optionElement.dataset.selected = !isSelected;

                // æ›´æ–°é€‰ä¸­çŠ¶æ€çš„è§†è§‰æ•ˆæœ
                if (!isSelected) {
                    optionElement.classList.add('user-voted');
                } else {
                    optionElement.classList.remove('user-voted');
                }
            }
        }

        // ã€æ–°å¢ã€‘æäº¤å¤šé€‰æŠ•ç¥¨çš„å‡½æ•°
        async function submitMultipleChoiceVote(submitButton) {
            const pollElement = submitButton.closest('.forum-poll');
            const postId = window.currentPostId;
            const selectedOptions = pollElement.querySelectorAll('.poll-option[data-selected="true"]');

            if (selectedOptions.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹', 'info');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æŠ•è¿‡ç¥¨
            const userVotedOption = localStorage.getItem(`poll_voted_${postId}`);
            if (pollElement.classList.contains('voted') || (userVotedOption && userVotedOption !== 'null')) {
                showToast('æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†', 'info');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'æ­£åœ¨æäº¤...';

            try {
                const post = await db.forumPosts.get(postId);
                if (!post) return;

                if (!post.pollData) {
                    post.pollData = { totalVotes: 0, options: {} };
                }

                let userVotedOptions = [];

                selectedOptions.forEach(option => {
                    const onclickAttr = option.getAttribute('onclick');
                    let optionId = '';

                    // æå–option ID
                    const patterns = [
                        /'([^']+)'/,
                        /"([^"]+)"/,
                        /handlePollVote\([^,]+,\s*['"]([^'"]+)['"]\)/
                    ];

                    for (const pattern of patterns) {
                        const match = onclickAttr.match(pattern);
                        if (match && match[1]) {
                            optionId = match[1];
                            break;
                        }
                    }

                    if (optionId) {
                        userVotedOptions.push(optionId);
                        if (!post.pollData.options[optionId]) {
                            post.pollData.options[optionId] = 0;
                        }
                        post.pollData.options[optionId]++;
                        post.pollData.totalVotes++;
                    }
                });

                await db.forumPosts.put(post);

                // ä¿å­˜å¤šé€‰è®°å½•
                saveVoteRecord(postId, JSON.stringify(userVotedOptions), `${userVotedOptions.length}ä¸ªé€‰é¡¹`, post.title);

                pollElement.classList.add('voted');
                updatePollUI(postId, post.pollData);
                showToast('æŠ•ç¥¨æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error("å¤šé€‰æŠ•ç¥¨å¤±è´¥:", error);
                showToast('æŠ•ç¥¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'æŠ•ç¥¨';
            }
        }

        // ã€å‡çº§ã€‘æ›´æ–°æŠ•ç¥¨UIçš„å‡½æ•° - æ”¯æŒå®æ—¶è¿›åº¦æ¡
        function updatePollUI(postId, pollData) {
            const pollElement = document.querySelector(`.post-full-body .forum-poll`);
            if (!pollElement) {
                return;
            }

            const totalVotes = pollData.totalVotes || 0;
            const options = pollElement.querySelectorAll('.poll-option');

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æŠ•è¿‡ç¥¨
            const userVotedOption = localStorage.getItem(`poll_voted_${postId}`);
            if (userVotedOption && userVotedOption !== 'null') {
                pollElement.classList.add('voted');
            }

            options.forEach((option, index) => {
                // æå–é€‰é¡¹ID
                const onclickAttr = option.getAttribute('onclick');
                let optionId = '';

                if (onclickAttr) {
                    const patterns = [
                        /'([^']+)'/,
                        /"([^"]+)"/,
                        /handlePollVote\([^,]+,\s*['"]([^'"]+)['"]\)/
                    ];

                    for (const pattern of patterns) {
                        const match = onclickAttr.match(pattern);
                        if (match && match[1]) {
                            optionId = match[1];
                            break;
                        }
                    }
                }

                if (!optionId) {
                    const textContent = option.querySelector('.option-text')?.textContent || '';
                    optionId = textContent.replace(/\s+/g, '_').toLowerCase();
                    if (!onclickAttr) {
                        option.setAttribute('onclick', `handlePollVote(this, '${optionId}')`);
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºæ¯ä¸ªé€‰é¡¹åŠ¨æ€åˆ›å»ºè¿›åº¦æ¡
                if (!option.querySelector('.result-bar-bg')) {
                    // ç¡®ä¿é€‰é¡¹æœ‰ç›¸å¯¹å®šä½
                    option.style.position = 'relative';

                    // åˆ›å»ºè¿›åº¦æ¡èƒŒæ™¯
                    const resultBg = document.createElement('div');
                    resultBg.className = 'result-bar-bg';

                    // åˆ›å»ºè¿›åº¦æ¡
                    const resultBar = document.createElement('div');
                    resultBar.className = 'result-bar';

                    resultBg.appendChild(resultBar);
                    option.insertBefore(resultBg, option.firstChild);
                }

                // è·å–ç¥¨æ•°
                let votes = pollData.options[optionId] || 0;
                if (votes === 0 && Object.keys(pollData.options).length > 0) {
                    const textContent = option.querySelector('.option-text')?.textContent || '';
                    for (const [key, value] of Object.entries(pollData.options)) {
                        if (key.includes(textContent.toLowerCase()) || textContent.toLowerCase().includes(key)) {
                            votes = value;
                            optionId = key;
                            break;
                        }
                    }
                }

                const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;

                // é«˜äº®ç”¨æˆ·æŠ•ç¥¨çš„é€‰é¡¹
                if (userVotedOption && userVotedOption !== 'null') {
                    try {
                        const votedOptions = JSON.parse(userVotedOption);
                        if (Array.isArray(votedOptions) && votedOptions.includes(optionId)) {
                            option.classList.add('user-voted');
                        } else {
                            option.classList.remove('user-voted');
                        }
                    } catch (e) {
                        if (optionId === userVotedOption ||
                            userVotedOption.includes(optionId) ||
                            optionId.includes(userVotedOption)) {
                            option.classList.add('user-voted');
                        } else {
                            option.classList.remove('user-voted');
                        }
                    }
                } else {
                    option.classList.remove('user-voted');
                }

                // ğŸ”¥ã€æ ¸å¿ƒã€‘æ›´æ–°ç¥¨æ•°æ˜¾ç¤ºå’Œè¿›åº¦æ¡åŠ¨ç”»
                const voteCountElement = option.querySelector('.vote-count');
                const resultBarElement = option.querySelector('.result-bar');

                if (voteCountElement) {
                    voteCountElement.textContent = `${votes}ç¥¨ (${percentage}%)`;
                }

                if (resultBarElement) {
                    // å»¶è¿Ÿæ›´æ–°è¿›åº¦æ¡å®½åº¦ï¼Œäº§ç”ŸåŠ¨ç”»æ•ˆæœ
                    setTimeout(() => {
                        resultBarElement.style.width = `${percentage}%`;
                    }, 100 + index * 50); // æ¯ä¸ªé€‰é¡¹å»¶è¿Ÿ50msï¼Œäº§ç”Ÿæ³¢æµªæ•ˆæœ
                }
            });
        }

        // ã€æ–°å¢ã€‘ä¸ºAIæŠ•ç¥¨å¸–å­ç”Ÿæˆæ™ºèƒ½åˆå§‹æ•°æ®çš„å‡½æ•°
        async function generateSmartPollData(postId, post) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡æ•°æ®
            if (post.pollData && post.pollData.totalVotes > 0) {
                updatePollUI(postId, post.pollData);
                return;
            }

            const pollElement = document.querySelector(`.post-full-body .forum-poll`);
            if (!pollElement) return;

            const options = pollElement.querySelectorAll('.poll-option');
            if (options.length === 0) return;

            // ç”Ÿæˆåˆç†çš„æŠ•ç¥¨æ•°æ®
            const pollData = { totalVotes: 0, options: {} };

            // æ ¹æ®å¸–å­ç±»å‹ç”ŸæˆåŸºç¡€ç¥¨æ•°
            const baseVotes = Math.floor(Math.random() * 40) + 15; // 15-55ç¥¨åŸºç¡€
            const isPopularTopic = post.title.includes('é¢œå€¼') || post.title.includes('äººæ°”') || post.title.includes('æœ€');
            const totalVotes = isPopularTopic ? baseVotes + Math.floor(Math.random() * 60) : baseVotes;

            // ä¸ºæ¯ä¸ªé€‰é¡¹åˆ†é…ç¥¨æ•°
            const optionVotes = [];
            let remainingVotes = totalVotes;

            options.forEach((option, index) => {
                const isLastOption = index === options.length - 1;
                if (isLastOption) {
                    // æœ€åä¸€ä¸ªé€‰é¡¹è·å¾—å‰©ä½™æ‰€æœ‰ç¥¨æ•°
                    optionVotes.push(remainingVotes);
                } else {
                    // éšæœºåˆ†é…ç¥¨æ•°ï¼Œä½†ç¡®ä¿ä¸è¶…è¿‡å‰©ä½™ç¥¨æ•°
                    const maxVotes = Math.floor(remainingVotes * 0.6); // æœ€å¤š60%
                    const minVotes = Math.floor(remainingVotes * 0.1); // æœ€å°‘10%
                    const votes = Math.floor(Math.random() * (maxVotes - minVotes + 1)) + minVotes;
                    optionVotes.push(votes);
                    remainingVotes -= votes;
                }
            });

            // å°†ç¥¨æ•°åˆ†é…ç»™é€‰é¡¹
            options.forEach((option, index) => {
                const onclickAttr = option.getAttribute('onclick');
                let optionId = '';

                if (onclickAttr) {
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match && match[1]) {
                        optionId = match[1];
                    }
                }

                if (!optionId) {
                    const textContent = option.querySelector('.option-text')?.textContent || '';
                    optionId = textContent.replace(/\s+/g, '_').toLowerCase();
                }

                pollData.options[optionId] = optionVotes[index];
                pollData.totalVotes += optionVotes[index];
            });

            // ä¿å­˜åˆ°æ•°æ®åº“
            post.pollData = pollData;
            await db.forumPosts.put(post);

            // æ›´æ–°UI
            updatePollUI(postId, pollData);
        }

        // ã€æ–°å¢ã€‘ä¸ºæŠ•ç¥¨ç”Ÿæˆæ™ºèƒ½å‡æ•°æ®çš„å‡½æ•°
        async function generateSmartPollData(postId, post) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡å‡æ•°æ®
            if (post.pollData && post.pollData.totalVotes > 0) {
                updatePollUI(postId, post.pollData);
                return;
            }

            const pollElement = document.querySelector(`.post-full-body .forum-poll`);
            if (!pollElement) return;

            const options = pollElement.querySelectorAll('.poll-option');
            if (options.length === 0) return;

            // è·å–å½“å‰è®ºå›ä¿¡æ¯ï¼Œç”¨äºç”Ÿæˆç¬¦åˆä¸–ç•Œè§‚çš„æ•°æ®
            const forum = await db.forums.get(parseInt(currentForumId));
            const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));

            // æ ¹æ®è®ºå›ç±»å‹å’Œä¸–ç•Œè§‚ç”Ÿæˆåˆç†çš„æŠ•ç¥¨æ•°æ®
            const pollData = {
                totalVotes: 0,
                options: {}
            };

            // ç”ŸæˆåŸºç¡€æŠ•ç¥¨æ•°ï¼šæ ¹æ®è®ºå›æ´»è·ƒåº¦
            const baseVotes = Math.floor(Math.random() * 50) + 20; // 20-70ç¥¨åŸºç¡€
            const isPopularTopic = post.title.includes('ã€æŠ•ç¥¨ã€‘') || post.title.includes('äººæ°”') || post.title.includes('æœ€');
            const totalVotes = isPopularTopic ? baseVotes + Math.floor(Math.random() * 80) : baseVotes;

            // ä¸ºæ¯ä¸ªé€‰é¡¹åˆ†é…ç¥¨æ•°
            const optionVotes = [];
            let remainingVotes = totalVotes;

            options.forEach((option, index) => {
                const optionText = option.querySelector('.option-text')?.textContent || '';

                // æ ¹æ®é€‰é¡¹å†…å®¹å’Œä¸–ç•Œè§‚è°ƒæ•´æƒé‡
                let weight = 1;

                // å¨±ä¹åœˆè®ºå›ï¼šæ˜æ˜Ÿç›¸å…³é€‰é¡¹æ›´å—æ¬¢è¿
                if (forum.worldview && forum.worldview.includes('å¨±ä¹')) {
                    if (forumCharacters.some(c => optionText.includes(c.name))) {
                        weight = 1.5; // è®ºå›æˆå‘˜ç›¸å…³é€‰é¡¹æ›´å—æ¬¢è¿
                    }
                }

                // æ ¡å›­è®ºå›ï¼šå®ç”¨æ€§é€‰é¡¹æ›´å—æ¬¢è¿
                if (forum.worldview && forum.worldview.includes('æ ¡å›­')) {
                    if (optionText.includes('é£Ÿå ‚') || optionText.includes('å›¾ä¹¦é¦†') || optionText.includes('å®¿èˆ')) {
                        weight = 1.3;
                    }
                }

                // ç”Ÿæˆè¯¥é€‰é¡¹çš„ç¥¨æ•°ï¼ˆå¸¦ä¸€äº›éšæœºæ€§ï¼‰
                const baseVoteForOption = Math.floor((remainingVotes / (options.length - index)) * weight);
                const randomVariation = Math.floor(Math.random() * 10) - 5; // -5åˆ°+5çš„éšæœºå˜åŒ–
                const finalVotes = Math.max(0, Math.min(remainingVotes, baseVoteForOption + randomVariation));

                optionVotes.push(finalVotes);
                remainingVotes -= finalVotes;
            });

            // å°†å‰©ä½™ç¥¨æ•°éšæœºåˆ†é…ç»™å„é€‰é¡¹
            while (remainingVotes > 0) {
                const randomIndex = Math.floor(Math.random() * options.length);
                optionVotes[randomIndex]++;
                remainingVotes--;
            }

            // ä¿å­˜æŠ•ç¥¨æ•°æ®
            options.forEach((option, index) => {
                const onclickAttr = option.getAttribute('onclick');
                let optionId = '';
                if (onclickAttr) {
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match && match[1]) {
                        optionId = match[1];
                    } else {
                        const textContent = option.querySelector('.option-text')?.textContent || '';
                        optionId = textContent.replace(/\s+/g, '_').toLowerCase();
                    }
                }

                pollData.options[optionId] = optionVotes[index];
                pollData.totalVotes += optionVotes[index];
            });

            // ä¿å­˜åˆ°æ•°æ®åº“
            post.pollData = pollData;
            await db.forumPosts.put(post);

            // æ›´æ–°UIæ˜¾ç¤º
            updatePollUI(postId, pollData);


        }

        // ã€æ–°å¢ã€‘æ¸…ç†æ—§çš„æŠ•ç¥¨è®°å½•ï¼Œä¿ç•™æœ€è¿‘çš„æŠ•ç¥¨
        function cleanOldVoteRecords(maxRecords = 100) {
            try {
                // è·å–æ‰€æœ‰æŠ•ç¥¨ç›¸å…³çš„localStorageé”®
                const voteKeys = Object.keys(localStorage)
                    .filter(key => key.startsWith('poll_voted_'))
                    .map(key => {
                        const postId = key.replace('poll_voted_', '');
                        return {
                            key: key,
                            postId: parseInt(postId),
                            timestamp: Date.now() // ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
                        };
                    })
                    .sort((a, b) => b.postId - a.postId); // æŒ‰å¸–å­IDé™åºæ’åˆ—ï¼ˆæ–°å¸–å­IDé€šå¸¸æ›´å¤§ï¼‰

                // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œåˆ é™¤æ—§çš„è®°å½•
                if (voteKeys.length > maxRecords) {
                    const toDelete = voteKeys.slice(maxRecords);
                    toDelete.forEach(item => {
                        localStorage.removeItem(item.key);
                    });
                    console.log(`ğŸ§¹ [æŠ•ç¥¨æ¸…ç†] å·²æ¸…ç† ${toDelete.length} æ¡æ—§æŠ•ç¥¨è®°å½•ï¼Œä¿ç•™æœ€è¿‘ ${maxRecords} æ¡`);
                }
            } catch (error) {
                console.error('æ¸…ç†æŠ•ç¥¨è®°å½•å¤±è´¥:', error);
            }
        }

        // ã€æ–°å¢ã€‘å¢å¼ºç‰ˆæŠ•ç¥¨è®°å½•ä¿å­˜ï¼ŒåŒ…å«æ›´å¤šä¿¡æ¯
        function saveVoteRecord(postId, optionId, optionText, postTitle) {
            try {
                // ä¿å­˜åŸºæœ¬çš„æŠ•ç¥¨é€‰æ‹©ï¼ˆç”¨äºé˜²é‡å¤æŠ•ç¥¨ï¼‰
                localStorage.setItem(`poll_voted_${postId}`, optionId);

                // ä¿å­˜è¯¦ç»†çš„æŠ•ç¥¨è®°å½•ï¼ˆç”¨äºå†å²æŸ¥çœ‹ï¼‰
                const voteRecord = {
                    postId: postId,
                    postTitle: postTitle || 'æœªçŸ¥å¸–å­',
                    optionId: optionId,
                    optionText: optionText || 'æœªçŸ¥é€‰é¡¹',
                    timestamp: Date.now(),
                    date: new Date().toLocaleString()
                };

                localStorage.setItem(`vote_detail_${postId}`, JSON.stringify(voteRecord));

                // æ‰§è¡Œæ¸…ç†ï¼Œä¿ç•™æœ€è¿‘100æ¡è®°å½•
                cleanOldVoteRecords(100);

            } catch (error) {
                console.error('ä¿å­˜æŠ•ç¥¨è®°å½•å¤±è´¥:', error);
                // å¦‚æœlocalStorageæ»¡äº†ï¼Œå°è¯•æ¸…ç†åé‡è¯•
                cleanOldVoteRecords(50);
                try {
                    localStorage.setItem(`poll_voted_${postId}`, optionId);
                } catch (retryError) {
                    console.error('é‡è¯•ä¿å­˜æŠ•ç¥¨è®°å½•ä»ç„¶å¤±è´¥:', retryError);
                }
            }
        }

        // ã€æ–°å¢ã€‘è·å–ç”¨æˆ·çš„æŠ•ç¥¨å†å²
        function getUserVoteHistory(limit = 20) {
            try {
                const voteDetails = Object.keys(localStorage)
                    .filter(key => key.startsWith('vote_detail_'))
                    .map(key => {
                        try {
                            return JSON.parse(localStorage.getItem(key));
                        } catch {
                            return null;
                        }
                    })
                    .filter(record => record !== null)
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, limit);

                return voteDetails;
            } catch (error) {
                console.error('è·å–æŠ•ç¥¨å†å²å¤±è´¥:', error);
                return [];
            }
        }

        // ã€æ–°å¢ã€‘æ˜¾ç¤ºæŠ•ç¥¨å†å²
        function showVoteHistory() {
            const voteHistory = getUserVoteHistory(50);

            if (voteHistory.length === 0) {
                showToast('æ‚¨è¿˜æ²¡æœ‰æŠ•ç¥¨è®°å½•', 'info');
                return;
            }

            const historyHtml = voteHistory.map(record => `
                <div class="vote-history-item">
                    <div class="vote-post-title">${record.postTitle}</div>
                    <div class="vote-choice">é€‰æ‹©äº†ï¼š${record.optionText}</div>
                    <div class="vote-date">${record.date}</div>
                </div>
            `).join('');

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content vote-history-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>æˆ‘çš„æŠ•ç¥¨å†å²</h3>
                            <button class="modal-close" onclick="closeModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="vote-history-list">
                                ${historyHtml}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
                            <button class="btn btn-danger" onclick="clearVoteHistory()">æ¸…ç©ºå†å²</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }



        // ğŸ”¥ã€ä¼˜åŒ–åã€‘æ˜¾ç¤ºåˆ›å»ºè®ºå›ç•Œé¢
        async function showCreateForumScreen() {
            hideApp('forum-screen');
            const characterContainer = document.getElementById('forum-character-selection');
            const personaContainer = document.getElementById('forum-persona-selection');
            const worldbookContainer = document.getElementById('forum-worldbook-selection');

            // æ¸…ç©ºè¡¨å•
            document.getElementById('forum-form-id').value = '';
            document.getElementById('forum-name-input').value = '';
            document.getElementById('forum-worldview-input').value = '';
            document.getElementById('forum-form-title').textContent = 'åˆ›å»ºæ–°è®ºå›';
            document.getElementById('forum-form-submit-btn').textContent = 'è¿›å…¥è®ºå›';

            // æ¸²æŸ“è§’è‰²å’Œèº«ä»½é¢å…·é€‰é¡¹
            characterContainer.innerHTML = characters.map(char => `
                <div class="selection-item" data-id="${char.id}" onclick="toggleSelection(this)">
                    <img src="${char.avatarUrl || createDefaultAvatar(char.name)}" alt="${char.name}">
                    <div class="selection-item-name">${char.name}</div>
                </div>
            `).join('');

            personaContainer.innerHTML = personas.map(p => `
                <div class="selection-item" data-id="${p.id}" onclick="toggleSelection(this, true)">
                    <img src="${p.avatarUrl || createDefaultAvatar(p.name)}" alt="${p.name}">
                    <div class="selection-item-name">${p.name}</div>
                </div>
            `).join('');

            // æ¸²æŸ“å±€éƒ¨ä¸–ç•Œä¹¦é€‰é¡¹
            const localWorldbooks = worldbooks.filter(w => !w.isGlobal);
            if (localWorldbooks.length > 0) {
                worldbookContainer.innerHTML = localWorldbooks.map(book => `
                    <div class="selection-item" data-id="${book.id}" onclick="toggleSelection(this)">
                        <div class="selection-item-icon"><i class="fas fa-book-open"></i></div>
                        <div class="selection-item-name">${book.title || book.name}</div>
                    </div>
                `).join('');
            } else {
                worldbookContainer.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center;">æš‚æ— å±€éƒ¨ä¸–ç•Œä¹¦</p>';
            }

            showApp('create-forum-screen');
        }

        // å¤šé€‰/å•é€‰åˆ‡æ¢
        function toggleSelection(element, isSingle = false) {
            const container = element.parentElement;
            if (isSingle) {
                // å•é€‰é€»è¾‘
                const currentlySelected = container.querySelector('.selected');
                if (currentlySelected) {
                    currentlySelected.classList.remove('selected');
                }
            }
            element.classList.toggle('selected');
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤è®ºå›åŠŸèƒ½
        async function deleteForum(forumId, event) {
            event.stopPropagation();

            const forum = await db.forums.get(parseInt(forumId));
            if (!forum) {
                alert("æ‰¾ä¸åˆ°è¦åˆ é™¤çš„è®ºå›");
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤è®ºå› "${forum.name}" å—ï¼Ÿ\n\nåˆ é™¤åå°†åŒæ—¶åˆ é™¤è¯¥è®ºå›çš„æ‰€æœ‰å¸–å­ã€å›å¤å’Œç›¸å…³æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                try {
                    // ğŸ”¥ã€ä¿®å¤ã€‘åˆ é™¤è®ºå›åŠå…¶æ‰€æœ‰ç›¸å…³æ•°æ®

                    // é¦–å…ˆè·å–è¯¥è®ºå›çš„æ‰€æœ‰å¸–å­
                    const forumPosts = await db.forumPosts.where('forumId').equals(parseInt(forumId)).toArray();
                    const postIds = forumPosts.map(post => post.id);

                    // åˆ é™¤è®ºå›æœ¬èº«
                    await db.forums.delete(parseInt(forumId));

                    // åˆ é™¤è®ºå›çš„æ‰€æœ‰å¸–å­
                    await db.forumPosts.where('forumId').equals(parseInt(forumId)).delete();

                    // åˆ é™¤è®ºå›æŒ‚è½½çš„ä¸–ç•Œä¹¦è®°å½•
                    await db.forumMountedWorldbooks.where('forumId').equals(parseInt(forumId)).delete();

                    // å¦‚æœæœ‰å¸–å­ï¼Œåˆ é™¤ä¸å¸–å­ç›¸å…³çš„æ•°æ®
                    if (postIds.length > 0) {
                        // è·å–æ‰€æœ‰å›å¤
                        const allReplies = [];
                        for (const postId of postIds) {
                            const replies = await db.forumReplies.where('postId').equals(postId).toArray();
                            allReplies.push(...replies);
                        }
                        const replyIds = allReplies.map(reply => reply.id);

                        // åˆ é™¤å¸–å­ç›¸å…³æ•°æ®
                        await Promise.all([
                            // åˆ é™¤å¸–å­çš„å›å¤
                            ...postIds.map(postId => db.forumReplies.where('postId').equals(postId).delete()),
                            // åˆ é™¤å¸–å­çš„å›¾ç‰‡
                            ...postIds.map(postId => db.forumPostImages.where('postId').equals(postId).delete())
                        ]);

                        // åˆ é™¤å¸–å­çš„æ”¶è—è®°å½•ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†å¤åˆç´¢å¼•ï¼‰
                        for (const postId of postIds) {
                            await db.forumFavorites.where('postId').equals(postId).delete();
                        }

                        // åˆ é™¤å›å¤çš„ç‚¹èµè®°å½•
                        if (replyIds.length > 0) {
                            await Promise.all(replyIds.map(replyId =>
                                db.replyLikes.where('replyId').equals(replyId).delete()
                            ));
                        }
                    }

                    showToast(`è®ºå› "${forum.name}" å·²åˆ é™¤`, 'success');
                    await renderForumArchives(); // é‡æ–°æ¸²æŸ“è®ºå›åˆ—è¡¨
                } catch (error) {
                    console.error('åˆ é™¤è®ºå›å¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºç¼–è¾‘è®ºå›ç•Œé¢
        async function showEditForumScreen(forumId, event) {
            event.stopPropagation();
            hideApp('forum-screen');

            const forum = await db.forums.get(parseInt(forumId));
            if (!forum) {
                alert("æ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„è®ºå›");
                return;
            }

            // å¤ç”¨åˆ›å»ºç•Œé¢ï¼Œä½†å¡«å……æ•°æ®
            await showCreateForumScreen();

            document.getElementById('forum-form-id').value = forum.id;
            document.getElementById('forum-name-input').value = forum.name;
            document.getElementById('forum-worldview-input').value = forum.worldview;
            document.getElementById('forum-form-title').textContent = 'ç¼–è¾‘è®ºå›';
            document.getElementById('forum-form-submit-btn').textContent = 'ä¿å­˜ä¿®æ”¹';

            // é¢„é€‰è§’è‰²
            forum.characterIds.forEach(id => {
                const el = document.querySelector(`#forum-character-selection .selection-item[data-id='${id}']`);
                if (el) el.classList.add('selected');
            });

            // é¢„é€‰èº«ä»½
            const personaEl = document.querySelector(`#forum-persona-selection .selection-item[data-id='${forum.personaId}']`);
            if (personaEl) personaEl.classList.add('selected');

            // é¢„é€‰ä¸–ç•Œä¹¦
            (forum.mountedWorldbookIds || []).forEach(id => {
                const el = document.querySelector(`#forum-worldbook-selection .selection-item[data-id='${id}']`);
                if (el) el.classList.add('selected');
            });
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç»Ÿä¸€å¤„ç†è¡¨å•æäº¤ï¼ˆåˆ›å»º/ç¼–è¾‘ï¼‰
        async function handleForumFormSubmit() {
            const forumId = document.getElementById('forum-form-id').value;
            const name = document.getElementById('forum-name-input').value.trim();
            const worldview = document.getElementById('forum-worldview-input').value.trim();

            const selectedCharElements = document.querySelectorAll('#forum-character-selection .selected');
            const selectedPersonaElement = document.querySelector('#forum-persona-selection .selected');
            const selectedWorldbookElements = document.querySelectorAll('#forum-worldbook-selection .selected');

            if (!name) return alert('è¯·è¾“å…¥è®ºå›åç§°');
            if (selectedCharElements.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²');
            if (!selectedPersonaElement) return alert('è¯·é€‰æ‹©ä½ çš„èº«ä»½');

            const characterIds = Array.from(selectedCharElements).map(el => el.dataset.id);
            const personaId = selectedPersonaElement.dataset.id;
            const mountedWorldbookIds = Array.from(selectedWorldbookElements).map(el => el.dataset.id);

            const forumData = {
                name,
                characterIds,
                personaId,
                worldview,
                mountedWorldbookIds,
                createdAt: forumId ? undefined : Date.now() // ä»…åˆ›å»ºæ—¶è®¾ç½®
            };

            try {
                if (forumId) { // ç¼–è¾‘æ¨¡å¼
                    await db.forums.update(parseInt(forumId), { name, characterIds, worldview, mountedWorldbookIds });
                    showToast(`è®ºå› "${name}" ä¿®æ”¹æˆåŠŸï¼`, 'success');
                    hideApp('create-forum-screen');
                    await renderForumArchives();
                    showApp('forum-screen');
                } else { // åˆ›å»ºæ¨¡å¼
                    const newForumId = await db.forums.add(forumData);
                    showToast(`è®ºå› "${name}" åˆ›å»ºæˆåŠŸï¼æ­£åœ¨ç”Ÿæˆå¸–å­...`, 'success');
                    hideApp('create-forum-screen');
                    await loadAndDisplayForum(newForumId, true);
                }
            } catch (error) {
                console.error("è®ºå›æ“ä½œå¤±è´¥:", error);
                alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            }
        }

        // æ¸²æŸ“è®ºå›å­˜æ¡£åˆ—è¡¨
        async function renderForumArchives() {
            const forums = await db.forums.toArray();
            const listContainer = document.getElementById('forum-archive-list');

            if (forums.length === 0) {
                listContainer.innerHTML = `
                    <div class="forum-empty-state">
                        <i class="fas fa-comments"></i>
                        <p>è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•è®ºå›</p>
                        <p>ç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªè®ºå›</p>
                    </div>`;
                return;
            }

            listContainer.innerHTML = forums.sort((a, b) => b.createdAt - a.createdAt).map(forum => `
                <div class="forum-archive-item" onclick="loadAndDisplayForum('${forum.id}')">
                    <div class="forum-archive-header">
                        <div class="forum-archive-title">${forum.name}</div>
                        <div class="forum-archive-actions">
                            <button class="forum-delete-btn" onclick="deleteForum('${forum.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="forum-edit-btn" onclick="showEditForumScreen('${forum.id}', event)">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="forum-archive-meta">
                        <span><svg class="forum-users-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 18v-1c0-2.66 5.33-4 8-4s8 1.34 8 4v1H4zM12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 6c.2-.71.78-1.29 1.49-1.51A6.991 6.991 0 0 0 21 14c0-2.21-1.79-4-4-4-.51 0-1 .1-1.47.26C16.21 10.69 17 11.77 17 13v5h1z"/></svg> ${forum.characterIds.length} ä¸ªè§’è‰²</span>
                        <span>${new Date(forum.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºä¸€ä¸ªè®ºå›
        async function loadAndDisplayForum(forumId, shouldGeneratePosts = false) {
            currentForumId = forumId;
            const forum = await db.forums.get(parseInt(forumId));
            if (!forum) {
                alert("æ‰¾ä¸åˆ°è¯¥è®ºå›");
                return;
            }

            document.getElementById('forum-view-title').innerText = forum.name;
            hideApp('forum-screen');
            showApp('forum-view-screen');

            if (shouldGeneratePosts) {
                await generateForumPosts(forumId);
            }
            await renderForumPosts(forumId);
        }

        // è¿”å›è®ºå›å­˜æ¡£åˆ—è¡¨
        async function backToForumArchives() {
            // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆæ˜¾ç¤ºè®ºå›ä¸»é¡µï¼Œå†éšè—å½“å‰é¡µé¢ï¼Œé¿å…é—ªç°ä¸»å±å¹•
            await renderForumArchives();
            showApp('forum-screen');
            hideApp('forum-view-screen');
        }

        // ğŸ”¥ã€ä¼˜åŒ–åã€‘çš„è®ºå›å¸–å­ç”Ÿæˆå‡½æ•° (æ·±åº¦æ•´åˆè®°å¿†ä¸ä¸–ç•Œä¹¦)
        async function generateForumPosts(forumId) {
            const forum = await db.forums.get(parseInt(forumId));
            if (!forum) return;

            const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));
            const persona = personas.find(p => p.id === forum.personaId);

            const MAX_CONTEXT_LENGTH = 8000;
            let currentLength = 0;
            let finalContext = '';

            const appendContext = (title, content) => {
                if (!content || content.trim() === '' || currentLength >= MAX_CONTEXT_LENGTH) return;
                const section = `\n\n## ${title}:\n${content}\n`;
                if (currentLength + section.length < MAX_CONTEXT_LENGTH) {
                    finalContext += section;
                    currentLength += section.length;
                } else {
                    const remainingLength = MAX_CONTEXT_LENGTH - currentLength - title.length - 20;
                    if (remainingLength > 100) {
                         finalContext += `\n\n## ${title}:\n${content.substring(0, remainingLength)}...\n[å†…å®¹å·²æˆªæ–­]\n`;
                    }
                    currentLength = MAX_CONTEXT_LENGTH;
                }
            };

            // ä¼˜å…ˆçº§ 1: æ—¶é—´æ„ŸçŸ¥ä¸Šä¸‹æ–‡
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            let timeOfDay, timeCharacteristics;
            if (hour >= 5 && hour < 9) { timeOfDay = "æ¸…æ™¨"; timeCharacteristics = "å¤§å®¶åˆšèµ·åºŠï¼Œå¯èƒ½åœ¨è®¨è®ºæ—©é¤ã€ä»Šå¤©çš„è®¡åˆ’ã€æ˜¨æ™šçš„æ¢¦å¢ƒç­‰"; }
            else if (hour >= 9 && hour < 12) { timeOfDay = "ä¸Šåˆ"; timeCharacteristics = isWeekend ? "å‘¨æœ«ä¸Šåˆï¼Œå¤§å®¶æ¯”è¾ƒæ‚ é—²ï¼Œå¯èƒ½åœ¨è®¨è®ºå¨±ä¹æ´»åŠ¨ã€è´­ç‰©è®¡åˆ’ç­‰" : "å·¥ä½œæ—¥ä¸Šåˆï¼Œå¯èƒ½æœ‰äººåœ¨æ‘¸é±¼ã€å·å·åˆ·è®ºå›ã€è®¨è®ºè¯¾ç¨‹æˆ–å·¥ä½œ"; }
            else if (hour >= 12 && hour < 14) { timeOfDay = "åˆä¼‘"; timeCharacteristics = "åˆé¥­æ—¶é—´ï¼Œå¤§å®¶å¯èƒ½åœ¨è®¨è®ºé£Ÿç‰©ã€ä¸‹åˆçš„å®‰æ’ã€åˆ†äº«åˆé¤ç…§ç‰‡ç­‰"; }
            else if (hour >= 14 && hour < 18) { timeOfDay = "ä¸‹åˆ"; timeCharacteristics = isWeekend ? "å‘¨æœ«ä¸‹åˆï¼Œé€‚åˆåˆ†äº«æ´»åŠ¨ã€çº¦ä¼šã€è´­ç‰©ç­‰è¯é¢˜" : "å·¥ä½œæ—¥ä¸‹åˆï¼Œå¯èƒ½æœ‰äººç»§ç»­æ‘¸é±¼ã€è®¨è®ºä¸‹ç­åçš„è®¡åˆ’"; }
            else if (hour >= 18 && hour < 22) { timeOfDay = "æ™šä¸Š"; timeCharacteristics = "æ™šé¥­åçš„é»„é‡‘æ—¶é—´ï¼Œå¤§å®¶æ¯”è¾ƒæ´»è·ƒï¼Œé€‚åˆå„ç§è¯é¢˜è®¨è®ºã€åˆ†äº«ä»Šå¤©çš„ç»å†"; }
            else if (hour >= 22 && hour < 24) { timeOfDay = "æ·±å¤œ"; timeCharacteristics = "å¤œæ·±äººé™ï¼Œé€‚åˆæ›´ç§äººã€æ·±åº¦çš„è¯é¢˜ï¼Œæƒ…æ„Ÿåˆ†äº«ã€äººç”Ÿæ„Ÿæ‚Ÿç­‰"; }
            else { timeOfDay = "å‡Œæ™¨"; timeCharacteristics = "å¤œçŒ«å­æ—¶é—´ï¼Œå¯èƒ½æœ‰å¤±çœ çš„äººåœ¨èŠå¤©ã€åˆ†äº«æ·±å¤œæƒ³æ³•ã€æˆ–è€…æ—©èµ·çš„äººå¼€å§‹æ–°çš„ä¸€å¤©"; }
            const timeContext = `ç°åœ¨æ˜¯${timeOfDay}ï¼ˆ${now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'})}ï¼‰ï¼Œ${isWeekend ? 'å‘¨æœ«' : 'å·¥ä½œæ—¥'}ã€‚${timeCharacteristics}`;
            appendContext("å½“å‰æ—¶é—´ä¸æ°›å›´", timeContext);

            // ä¼˜å…ˆçº§ 2: ä¸–ç•Œäº‹ä»¶ ("å¤§æ–°é—»")
            let eventContext = '';
            if (worldEvent && worldEvent.expires > Date.now()) {
                eventContext = `**è¿™æ˜¯åˆšåˆšå‘ç”Ÿçš„ã€æœ€é‡è¦çš„æ–°é—»ï¼Œè¯·åŠ¡å¿…å›´ç»•è¿™ä¸ªäº‹ä»¶ç”Ÿæˆä¸€äº›å¸–å­:**\n${worldEvent.content}`;
            }
            appendContext("å¤´æ¡æ–°é—»/ä¸–ç•Œçº¿å˜åŠ¨", eventContext);

            // ä¼˜å…ˆçº§ 3: è§’è‰²è¿‘æœŸè®°å¿† (æ ¸å¿ƒè®°å¿† + æƒ…æ™¯è®°å¿†)
            let memoryContext = '';
            const charactersForMemory = forumCharacters.sort(() => 0.5 - Math.random()).slice(0, 3);
            for (const char of charactersForMemory) {
                const coreMemories = await db.coreMemories.where('characterId').equals(char.id).limit(2).toArray();
                const episodicMemories = await db.episodicMemories.where('characterId').equals(char.id).reverse().limit(3).toArray();
                if (coreMemories.length > 0 || episodicMemories.length > 0) {
                    memoryContext += `### å…³äº ${char.name} çš„è¿‘æœŸåŠ¨æ€:\n`;
                    coreMemories.forEach(mem => { memoryContext += `- (æ ¸å¿ƒè®°å¿†) ${mem.fact}\n`; });
                    episodicMemories.forEach(mem => { memoryContext += `- (æœ€è¿‘å‘ç”Ÿ) ${mem.fact}\n`; });
                }
            }
            appendContext("æœ€è¿‘å‘ç”Ÿçš„å¤§äº‹ä»¶ (è§’è‰²è®°å¿†)", memoryContext);

            // ä¼˜å…ˆçº§ 4: å…¨å±€ä¸–ç•Œä¹¦ + ç¤¾åŒºæŒ‚è½½çš„å±€éƒ¨ä¸–ç•Œä¹¦
            const allWorldbooks = await db.worldbooks.toArray();
            let worldbookContext = '';
            const globalBooks = allWorldbooks.filter(b => b.isGlobal && (window.activeGlobalWorldbooks || []).includes(b.id));
            const mountedBooks = allWorldbooks.filter(b => (forum.mountedWorldbookIds || []).includes(b.id));
            const relevantBooks = [...new Set([...globalBooks, ...mountedBooks])]; // åˆå¹¶å»é‡

            if (relevantBooks.length > 0) {
                worldbookContext = relevantBooks.map(book => `### ${book.title}\n${book.content}`).join('\n\n');
                appendContext("è®ºå›å‚è€ƒçš„ä¸–ç•Œè§‚è®¾å®š (ä¸–ç•Œä¹¦)", worldbookContext);
            }

            let prompt = `
# è§’è‰²ï¼šè®ºå›å†…å®¹ç”ŸæˆAI
ä½ çš„ä»»åŠ¡æ˜¯ä¸ºä¸€ä¸ªåä¸º "${forum.name}" çš„è™šæ‹Ÿè®ºå›ç”Ÿæˆ10ä¸ªæ–°çš„å¸–å­ã€‚

## è®ºå›èƒŒæ™¯è®¾å®š:
**æ ¸å¿ƒä¸–ç•Œè§‚**: ${forum.worldview || 'ä¸€ä¸ªæ™®é€šçš„ç°ä»£ç¤¾åŒºï¼Œå¤§å®¶åœ¨è¿™é‡Œåˆ†äº«æ—¥å¸¸ç”Ÿæ´»ä¸è§é—»ã€‚'}
${finalContext}

## è®ºå›æˆå‘˜:
${forumCharacters.map(c => `- ${c.name} (äººè®¾: ${c.bio})`).join('\n')}
- ${persona.name} (è¿™æ˜¯ç”¨æˆ·, äººè®¾: ${persona.description})

## å¸–å­ç”ŸæˆæŒ‡ä»¤:
è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹è¦æ±‚ï¼Œç”Ÿæˆ**å®Œæ•´çš„10ä¸ªå¸–å­**çš„JSONå¯¹è±¡ã€‚
**ã€é‡è¦ã€‘**: å¿…é¡»ç”Ÿæˆå®Œæ•´çš„10ä¸ªå¸–å­ï¼Œä¸èƒ½å°‘äº10ä¸ªã€‚

### ã€æ–°å¢åŠŸèƒ½ã€‘æŠ•ç¥¨å¸–å­ (å•é€‰/å¤šé€‰):
- ä½ å¯ä»¥é€‰æ‹©æ€§åœ°å°†1-2ä¸ªå¸–å­åˆ›å»ºä¸º **å•é€‰** æˆ– **å¤šé€‰** æŠ•ç¥¨å¸–ã€‚
- **ã€æå…¶é‡è¦ã€‘**: å½“å¸–å­çš„ "content" å­—æ®µåŒ…å«HTMLæ—¶ï¼Œè¯¥HTMLä»£ç  **å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶**:
    1.  **å¿…é¡»æ˜¯å•è¡Œæ–‡æœ¬**ï¼Œç»å¯¹ä¸èƒ½åŒ…å«ä»»ä½•æ¢è¡Œç¬¦ (\\n)ã€‚
    2.  HTMLä»£ç ä¸­çš„æ‰€æœ‰ **åŒå¼•å· (")** éƒ½ **å¿…é¡»ç”¨åæ–œæ è½¬ä¹‰æˆ (\\")**ã€‚

- **å•é€‰æŠ•ç¥¨ (æ­£ç¡®æ ¼å¼ç¤ºä¾‹)**:
  \`\`\`json
  "content": "<div class=\\"forum-poll\\" data-poll-type=\\"single\\"><h4>ã€æŠ•ç¥¨ã€‘å•é€‰æ ‡é¢˜</h4><div class=\\"poll-option\\" onclick=\\"handlePollVote(this, 'option_1')\\"><span class=\\"option-text\\">é€‰é¡¹ä¸€</span><span class=\\"vote-count\\">0ç¥¨</span></div><div class=\\"poll-option\\" onclick=\\"handlePollVote(this, 'option_2')\\"><span class=\\"option-text\\">é€‰é¡¹äºŒ</span><span class=\\"vote-count\\">0ç¥¨</span></div></div>"
  \`\`\`
- **å¤šé€‰æŠ•ç¥¨ (æ­£ç¡®æ ¼å¼ç¤ºä¾‹)**:
  \`\`\`json
  "content": "<div class=\\"forum-poll\\" data-poll-type=\\"multiple\\"><h4>ã€æŠ•ç¥¨ã€‘å¤šé€‰æ ‡é¢˜</h4><div class=\\"poll-option\\" onclick=\\"handlePollVote(this, 'option_A')\\"><span class=\\"option-text\\">é€‰é¡¹A</span><span class=\\"vote-count\\">0ç¥¨</span></div><div class=\\"poll-option\\" onclick=\\"handlePollVote(this, 'option_B')\\"><span class=\\"option-text\\">é€‰é¡¹B</span><span class=\\"vote-count\\">0ç¥¨</span></div><button class=\\"vote-submit-btn\\" onclick=\\"submitMultipleChoiceVote(this)\\">æŠ•ç¥¨</button></div>"
  \`\`\`
- æŠ•ç¥¨çš„æ ‡é¢˜å’Œé€‰é¡¹å†…å®¹å¿…é¡»ä¸è®ºå›çš„ä¸–ç•Œè§‚å’Œè§’è‰²ç›¸å…³ã€‚
- æ¯ä¸ªæŠ•ç¥¨é€‰é¡¹çš„onclickä¸­çš„option_idå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼ˆå¦‚option_1, option_2ç­‰ï¼‰ã€‚
- å¤šé€‰æŠ•ç¥¨å¿…é¡»åŒ…å«æŠ•ç¥¨æŒ‰é’®ï¼Œå•é€‰æŠ•ç¥¨ä¸éœ€è¦ã€‚

### ã€é‡è¦ã€‘å‘å¸–äººåˆ†é…è§„åˆ™:
- **8-9ä¸ªå¸–å­**: å¿…é¡»ç”±æ™®é€šNPCè·¯äººå‘å¸ƒï¼Œä½¿ç”¨ç¬¦åˆä¸–ç•Œè§‚çš„æ™®é€šç½‘åï¼ˆå¦‚"å­¦éœ¸å°ç‹"ã€"å¤œçŒ«å­"ã€"ç¯®çƒå°‘å¹´"ç­‰ï¼‰
- **æœ€å¤š1-2ä¸ªå¸–å­**: å¯ä»¥ç”±è®ºå›æˆå‘˜è§’è‰²å‘å¸ƒï¼Œæ ¼å¼ä¸º"ç½‘å(çœŸå®å§“å)"
- **ã€ä¸¥æ ¼ç¦æ­¢ã€‘**: ç»å¯¹ä¸å¾—å†’å……ç”¨æˆ· ${persona.name} å‘å¸–æˆ–è¯„è®ºï¼Œç”¨æˆ·æœ‰è‡ªå·±çš„å‘å¸–æƒé™

### å†…å®¹è¦æ±‚:
1.  **ğŸ”¥ æ—¶é—´æ„ŸçŸ¥**: å¸–å­çš„å†…å®¹å’Œæ°›å›´è¦ç¬¦åˆå½“å‰çš„ **${timeOfDay}** æ—¶æ®µç‰¹ç‚¹ã€‚è¯·æ ¹æ®"å½“å‰æ—¶é—´ä¸æ°›å›´"éƒ¨åˆ†çš„æè¿°æ¥è°ƒæ•´å¸–å­çš„è¯é¢˜ã€è¯­æ°”å’Œæ´»è·ƒåº¦ã€‚
2.  **çœŸå®è®ºå›æ„Ÿ**: å¤§éƒ¨åˆ†å¸–å­åº”è¯¥æ˜¯æ™®é€šäººçš„æ—¥å¸¸åˆ†äº«ã€æ±‚åŠ©ã€åæ§½ã€é—²èŠç­‰ï¼Œå°±åƒçœŸå®è®ºå›ä¸€æ ·
3.  **ä¸–ç•Œè§‚èåˆ**: åœ¨ä¿æŒçœŸå®æ„Ÿçš„å‰æä¸‹ï¼Œé€‚åº¦èå…¥èƒŒæ™¯ä¸–ç•Œè§‚
4.  **è¯é¢˜å¤šæ ·æ€§**: åŒ…æ‹¬å­¦ä¹ ã€ç”Ÿæ´»ã€å¨±ä¹ã€æ±‚åŠ©ã€åˆ†äº«ã€å…«å¦ç­‰å„ç§æ—¥å¸¸è¯é¢˜ï¼Œä½†è¦ç¬¦åˆå½“å‰æ—¶é—´æ®µçš„ç‰¹ç‚¹
5.  **é¿å…è¿‡åº¦å…³è”**: ä¸è¦è®©å¤ªå¤šå¸–å­éƒ½å›´ç»•è®ºå›æˆå‘˜è§’è‰²å±•å¼€

### ã€æå…¶é‡è¦ã€‘è¾“å‡ºæ ¼å¼:
ä½ çš„å›å¤**å¿…é¡»**æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„ã€ä¸åŒ…å«ä»»ä½•é¢å¤–è§£é‡Šæ–‡å­—çš„JSONæ•°ç»„æ ¼å¼ã€‚

**æ ‡å‡†å¸–å­æ ¼å¼ç¤ºä¾‹**:
\`\`\`json
[
  {
    "authorName": "å­¦éœ¸å°ç‹",
    "title": "ä»Šå¤©çš„æ•°å­¦ä½œä¸šå¥½éš¾å•Š",
    "content": "æœ‰æ²¡æœ‰å¤§ç¥èƒ½å¸®å¿™è§£ç­”ä¸€ä¸‹è¿™é“é¢˜ï¼Ÿæ„Ÿè§‰è‡ªå·±è¦è¢«ç»•ç³Šæ¶‚äº†...",
    "timestamp": "12:30"
  },
  {
    "authorName": "å¤œçŒ«å­(å¼ æ˜è¾‰)",
    "title": "æ·±å¤œé£Ÿå ‚æ¨è",
    "content": "åˆšå‘ç°å­¦æ ¡é™„è¿‘æœ‰å®¶24å°æ—¶è¥ä¸šçš„å°åº—ï¼Œæ³¡é¢åŠ è›‹æ‰8å—é’±ï¼Œæ€§ä»·æ¯”è¶…é«˜ï¼",
    "timestamp": "23:45"
  }
]
\`\`\`

**é‡è¦**: æ¯ä¸ªå¸–å­å¯¹è±¡å¿…é¡»åŒ…å« authorNameã€titleã€content ä¸‰ä¸ªå­—æ®µï¼Œtimestamp å­—æ®µå¯é€‰ã€‚
`;

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºå®Œæ•´çš„prompt
            console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] å®Œæ•´Prompt:');
            console.log('='.repeat(80));
            console.log(prompt);
            console.log('='.repeat(80));

            showToast('AIæ­£åœ¨ç”Ÿæˆæ–°å¸–å­ï¼Œè¯·ç¨å€™...', 'info');

            try {
                console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] Prompté•¿åº¦:', prompt.length, 'å­—ç¬¦');
                const response = await callForumAPI(prompt);
                console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] AIåŸå§‹å“åº”é•¿åº¦:', response.length, 'å­—ç¬¦');
                console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] AIåŸå§‹å“åº”:', response);

                let posts;
                try {
                    posts = JSON.parse(response);
                } catch (e) {
                    console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] ç›´æ¥JSONè§£æå¤±è´¥ï¼Œå°è¯•æå–ä»£ç å—');

                    // å°è¯•æå– ```json ä»£ç å—
                    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                    if (jsonMatch && jsonMatch[1]) {
                        console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] æ‰¾åˆ°JSONä»£ç å—');
                        try {
                            posts = JSON.parse(jsonMatch[1]);
                            console.log('âœ… [è®ºå›å¸–å­ç”Ÿæˆ] æˆåŠŸè§£æJSONä»£ç å—ï¼Œè·å¾—', posts.length, 'ä¸ªå¸–å­');
                        } catch (e2) {
                            console.error('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] JSONä»£ç å—è§£æå¤±è´¥:', e2);
                            throw new Error("AIè¿”å›çš„JSONä»£ç å—æ ¼å¼é”™è¯¯ã€‚");
                        }
                    } else {
                        // åªæœ‰åœ¨ç¡®å®æ²¡æœ‰æ‰¾åˆ°å®Œæ•´ä»£ç å—æ—¶ï¼Œæ‰å°è¯•ä¿®å¤æˆªæ–­çš„JSON
                        console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] æœªæ‰¾åˆ°å®Œæ•´ä»£ç å—ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºæˆªæ–­çš„JSON');

                        const partialMatch = response.match(/```json\s*([\s\S]*)/);
                        if (partialMatch && partialMatch[1]) {
                            let jsonContent = partialMatch[1].trim();
                            console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] æ‰¾åˆ°éƒ¨åˆ†JSONå†…å®¹ï¼Œé•¿åº¦:', jsonContent.length);

                            // åªæœ‰å½“JSONæ˜æ˜¾ä¸å®Œæ•´æ—¶æ‰ä¿®å¤
                            if (!jsonContent.endsWith(']') && !jsonContent.endsWith('}]')) {
                                console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] JSONç¡®å®è¢«æˆªæ–­ï¼Œå°è¯•ä¿®å¤');

                                // æ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
                                const lastCompleteEnd = jsonContent.lastIndexOf('},');
                                if (lastCompleteEnd > 0) {
                                    jsonContent = jsonContent.substring(0, lastCompleteEnd + 1) + '\n]';
                                    console.log('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] ä¿®å¤æˆªæ–­çš„JSON');
                                }
                            }

                            try {
                                posts = JSON.parse(jsonContent);
                                console.log('âœ… [è®ºå›å¸–å­ç”Ÿæˆ] æˆåŠŸè§£æJSONï¼Œè·å¾—', posts.length, 'ä¸ªå¸–å­');
                            } catch (e3) {
                                console.error('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] ä¿®å¤åä»æ— æ³•è§£æ:', e3);
                                throw new Error("AIè¿”å›çš„JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•ä¿®å¤ã€‚");
                            }
                        } else {
                            console.error('ğŸ”¥ [è®ºå›å¸–å­ç”Ÿæˆ] æ— æ³•è§£æçš„å“åº”:', response.substring(0, 500) + '...');
                            throw new Error("AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚");
                        }
                    }
                }
                if (!Array.isArray(posts)) throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚");

                for (const post of posts) {
                    const authorName = post.authorName || post.author || post.poster;
                    if (post && typeof authorName === 'string' && post.title && post.content) {
                        let author = null;
                        let authorAvatar = null;
                        const realNameMatch = authorName.match(/^(.+)\((.+)\)$/);
                        if (realNameMatch) {
                            const realName = realNameMatch[2];
                            author = characters.find(c => c.name === realName) || personas.find(p => p.name === realName);
                            if (author) authorAvatar = author.avatarUrl;
                        }
                        if (!author) authorAvatar = createDefaultAvatar(authorName);
                        await db.forumPosts.add({
                            forumId: parseInt(forumId),
                            title: post.title,
                            content: post.content,
                            authorId: author ? author.id : null,
                            authorName: authorName,
                            authorAvatar: authorAvatar,
                            timestamp: Date.now() - Math.floor(Math.random() * 10000),
                            replies: 0,
                            likes: 0
                        });
                    } else {
                        console.warn("AIç”Ÿæˆäº†ä¸€ä¸ªæ ¼å¼ä¸è§„èŒƒçš„å¸–å­ï¼Œå·²è·³è¿‡:", post);
                    }
                }
            } catch (error) {
                console.error("ç”Ÿæˆå¸–å­å¤±è´¥:", error);
                alert("AIç”Ÿæˆå¸–å­å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®æˆ–åˆ·æ–°é‡è¯•ã€‚\né”™è¯¯è¯¦æƒ…: " + error.message);
            }
        }

        // æ¸²æŸ“å¸–å­åˆ—è¡¨
        async function renderForumPosts(forumId) {
            const posts = await db.forumPosts.where('forumId').equals(parseInt(forumId)).toArray();
            const listContainer = document.getElementById('forum-posts-list');

            if (posts.length === 0) {
                listContainer.innerHTML = `<div class="forum-empty-state"><p>è¿™ä¸ªè®ºå›è¿˜æ²¡æœ‰å¸–å­</p></div>`;
                return;
            }

            // 1. è®¡ç®—æ¯ä¸ªå¸–å­çš„çƒ­åº¦ï¼ˆæ”¹è¿›ç®—æ³•ï¼‰
            const now = Date.now();
            for (const post of posts) {
                const repliesCount = await db.forumReplies.where('postId').equals(post.id).count();

                // ğŸ”¥ã€æ”¹è¿›çƒ­åº¦ç®—æ³•ã€‘è€ƒè™‘æ—¶é—´è¡°å‡å’Œæ´»è·ƒåº¦
                const ageInHours = (now - post.timestamp) / (1000 * 60 * 60); // å¸–å­å¹´é¾„ï¼ˆå°æ—¶ï¼‰
                const timeFactor = Math.max(0.1, 1 / (1 + ageInHours / 24)); // æ—¶é—´è¡°å‡å› å­ï¼Œ24å°æ—¶åå¼€å§‹æ˜æ˜¾è¡°å‡

                // è·å–æœ€è¿‘24å°æ—¶çš„å›å¤æ•°ï¼ˆæ´»è·ƒåº¦æŒ‡æ ‡ï¼‰
                const recentReplies = await db.forumReplies
                    .where('postId').equals(post.id)
                    .and(reply => reply.timestamp > (now - 24 * 60 * 60 * 1000))
                    .count();

                // çƒ­åº¦è®¡ç®—ï¼šåŸºç¡€åˆ†æ•° + æ—¶é—´è¡°å‡ + è¿‘æœŸæ´»è·ƒåº¦åŠ æˆ
                const baseScore = repliesCount * 2 + (post.likes || 0);
                const recentActivityBonus = recentReplies * 5; // è¿‘æœŸå›å¤æƒé‡æ›´é«˜

                post.hotness = (baseScore + recentActivityBonus) * timeFactor;

                // è°ƒè¯•ä¿¡æ¯
                console.log(`å¸–å­"${post.title}": å›å¤${repliesCount}, è¿‘æœŸå›å¤${recentReplies}, å¹´é¾„${ageInHours.toFixed(1)}h, çƒ­åº¦${post.hotness.toFixed(2)}`);
            }

            // 2. æŒ‰çƒ­åº¦é™åºæ’åˆ—
            posts.sort((a, b) => b.hotness - a.hotness);

            // 3. åˆ†ç¦»å‡ºçƒ­å¸–å’Œæœ€æ–°å¸–å­ (æœ€å¤š3ä¸ªçƒ­å¸–)
            const hotPostsCount = Math.min(3, posts.length);
            const hotPosts = posts.slice(0, hotPostsCount);
            const newestPosts = posts.slice(hotPostsCount).sort((a, b) => b.timestamp - a.timestamp);

            // 4. æ¸²æŸ“HTML
            let html = '';

            // æ¸²æŸ“çƒ­å¸–åŒº
            if (hotPosts.length > 0) {
                html += '<div class="forum-section-header">çƒ­é—¨å¸–å­</div>';
                html += await Promise.all(hotPosts.map(async post => {
                    // æ£€æŸ¥å¸–å­æ˜¯å¦æœ‰å›¾ç‰‡
                    const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;

                    return `
                        <div class="post-item hot" onclick="showPostView(${post.id})">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                ${post.isUserPost ? '<span class="user-post-badge">æˆ‘</span>' : ''}
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    `;
                })).then(results => results.join(''));
            }

            // æ¸²æŸ“æœ€æ–°å¸–å­åŒº
            if (newestPosts.length > 0) {
                html += '<div class="forum-section-header">æœ€æ–°å¸–å­</div>';
                html += await Promise.all(newestPosts.map(async post => {
                    // æ£€æŸ¥å¸–å­æ˜¯å¦æœ‰å›¾ç‰‡
                    const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;

                    return `
                        <div class="post-item" onclick="showPostView(${post.id})">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                ${post.isUserPost ? '<span class="user-post-badge">æˆ‘</span>' : ''}
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    `;
                })).then(results => results.join(''));
            }

            listContainer.innerHTML = html;
        }

        // åˆ·æ–°å¸–å­
        async function refreshPosts() {
            if (!currentForumId) return;

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const forumTitle = document.getElementById('forum-view-title');
            const originalTitle = forumTitle.textContent;
            forumTitle.innerHTML = originalTitle + '<span class="forum-loading-spinner"></span>';

            showToast("æ­£åœ¨è·å–æœ€æ–°åŠ¨æ€...", "info");

            try {
                // 1. ç”Ÿæˆ10æ¡æ–°å¸–å­
                await generateForumPosts(currentForumId);

                // --- å¸–å­çš„"æ–°é™ˆä»£è°¢"ä¸"æ°¸ä¹…çè—"é€»è¾‘ ---

                // 2. è·å–æ‰€æœ‰å¸–å­IDã€ç”¨æˆ·æ”¶è—çš„å¸–å­IDã€ç”¨æˆ·è‡ªå·±å‘å¸ƒçš„å¸–å­ID
                const allPostsInForum = await db.forumPosts.where('forumId').equals(parseInt(currentForumId)).toArray();
                const allPostIds = new Set(allPostsInForum.map(post => post.id));

                const favoriteRecords = await db.forumFavorites.where({ userId: 'user' }).toArray();
                const favoritedPostIds = new Set(favoriteRecords.map(fav => fav.postId));

                const userPosts = allPostsInForum.filter(post => post.isUserPost === true);
                const userPostIds = new Set(userPosts.map(post => post.id));

                // 3. ç¡®å®šéœ€è¦ä¿ç•™çš„å¸–å­ï¼šæœ€æ–°çš„30æ¡ + æ‰€æœ‰æ”¶è—çš„ + æ‰€æœ‰ç”¨æˆ·å‘å¸ƒçš„
                const postsToKeepIds = new Set();

                // 3.1 æ·»åŠ æœ€æ–°çš„30æ¡
                allPostsInForum
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 30)
                    .forEach(post => postsToKeepIds.add(post.id));

                // 3.2 æ·»åŠ æ‰€æœ‰æ”¶è—çš„
                favoritedPostIds.forEach(id => postsToKeepIds.add(id));

                // 3.3 æ·»åŠ æ‰€æœ‰ç”¨æˆ·è‡ªå·±å‘å¸ƒçš„
                userPostIds.forEach(id => postsToKeepIds.add(id));

                // 4. æ‰¾å‡ºéœ€è¦åˆ é™¤çš„å¸–å­
                const postsToDeleteIds = [];
                allPostIds.forEach(id => {
                    if (!postsToKeepIds.has(id)) {
                        postsToDeleteIds.push(id);
                    }
                });

                // 5. æ‰§è¡Œåˆ é™¤
                if (postsToDeleteIds.length > 0) {
                    console.log(`è®ºå›å¸–å­æ¸…ç†ï¼šå‡†å¤‡åˆ é™¤ ${postsToDeleteIds.length} æ¡è¿‡æœŸ/æœªæ”¶è—/éç”¨æˆ·å‘å¸ƒçš„å¸–å­ã€‚`);
                    await db.forumPosts.bulkDelete(postsToDeleteIds);
                    await db.forumReplies.where('postId').anyOf(postsToDeleteIds).delete();
                    console.log(`âœ… æ¸…ç†å®Œæˆï¼`);
                }

                // 6. é‡æ–°æ¸²æŸ“ç•Œé¢
                await renderForumPosts(currentForumId);
                showToast("è®ºå›å·²åˆ·æ–°ï¼", "success");

            } catch (error) {
                console.error('åˆ·æ–°å¸–å­å¤±è´¥:', error);
                showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
                await renderForumPosts(currentForumId);
            } finally {
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                forumTitle.innerHTML = originalTitle;
            }
        }

        // ä»å¸–å­è¯¦æƒ…è¿”å›è®ºå›
        function backToForum() {
            // ğŸ”¥ã€ä¿®å¤ã€‘æ ¹æ®æ¥æºé¡µé¢è¿”å›åˆ°æ­£ç¡®ä½ç½®
            const source = window.postViewSource || 'forum';

            if (source === 'chat') {
                // ä»èŠå¤©ç•Œé¢è¿›å…¥çš„ï¼Œè¿”å›èŠå¤©ç•Œé¢
                showApp('api-chat-screen');
            } else {
                // ä»è®ºå›è¿›å…¥çš„ï¼Œè¿”å›è®ºå›
                if (currentForumId) {
                    loadAndDisplayForum(currentForumId);
                } else {
                    showApp('forum-screen');
                }
            }
            hideApp('post-view-screen');
        }

        // ğŸ”¥ã€ä¼˜åŒ–åã€‘æ˜¾ç¤ºå¸–å­è¯¦æƒ… (æ”¯æŒå›¾ç‰‡)
        async function showPostView(postId, fromSource = 'forum') {
            const post = await db.forumPosts.get(postId);
            if (!post) return;

            window.currentPostId = postId;
            currentForumId = post.forumId;

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•æ¥æºé¡µé¢ï¼Œç”¨äºè¿”å›å¯¼èˆª
            window.postViewSource = fromSource;

            const contentContainer = document.getElementById('post-view-content');

            // è·å–å¸–å­å›¾ç‰‡
            const postImage = await db.forumPostImages.where('postId').equals(postId).first();
            const imageUrl = postImage ? postImage.imageUrl : null;

            // å®‰å…¨åœ°æ¸²æŸ“å¸–å­å†…å®¹
            const postBodyContainerHTML = (post.content || '').replace(/\n/g, '<br>');

            contentContainer.innerHTML = `
                <div class="post-full-content">
                    <div class="post-full-title-container">
                        <div class="post-full-title">${post.title}${imageUrl ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}</div>
                        ${post.isUserPost ? '<span class="user-post-badge">æˆ‘</span>' : ''}
                    </div>
                    <div class="post-full-meta">ç”± ${post.authorName} å‘å¸ƒäº ${new Date(post.timestamp).toLocaleString()}</div>
                    <div class="post-full-body" id="post-body-container">${postBodyContainerHTML}${imageUrl ? `<img src="${imageUrl}" alt="å¸–å­å›¾ç‰‡" style="max-width: 100%; border-radius: 8px; margin-top: 15px;">` : ''}</div>
                </div>
                <div class="replies-section">
                    <h3>å›å¤</h3>
                    <div id="replies-list"><div class="loading-container" style="text-align: center; padding: 30px;"><div class="loading-spinner" style="width: 30px; height: 30px; border: 2px solid #f3f3f3; border-top: 2px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;"></div><div style="color: #666; font-size: 12px;">åŠ è½½è¯„è®ºä¸­...</div></div></div>
                </div>
            `;

            // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
            const isFav = await db.forumFavorites.where('[userId+postId]').equals(['user', postId]).first();
            const favIcon = document.querySelector('#favorite-btn i');
            favIcon.className = isFav ? 'fas fa-star' : 'far fa-star';

            showApp('post-view-screen');

            setTimeout(async () => {
                // ğŸ”¥ã€æ¢å¤ã€‘ä¸ºæŠ•ç¥¨å¸–å­ç”Ÿæˆæ™ºèƒ½ç¥¨æ•°æ•°æ®
                const pollElement = document.querySelector('.post-full-body .forum-poll');
                if (pollElement) {
                    await generateSmartPollData(postId, post);
                }

                const existingReplies = await db.forumReplies.where('postId').equals(postId).count();
                if (existingReplies === 0) {
                    await generateRepliesForUserPost(postId, imageUrl);
                }
                await renderReplies(postId);
            }, 100);
        }

        // ç”Ÿæˆå¸–å­è¯„è®º
        async function generateRepliesForPost(postId) {
            const post = await db.forumPosts.get(postId);
            if (!post) return;

            const forum = await db.forums.get(post.forumId);
            const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));
            const persona = personas.find(p => p.id === forum.personaId);

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const repliesContainer = document.getElementById('replies-list');
            repliesContainer.innerHTML = `
                <div class="loading-container" style="text-align: center; padding: 30px;">
                    <div class="loading-spinner" style="
                        width: 30px;
                        height: 30px;
                        border: 2px solid #f3f3f3;
                        border-top: 2px solid #007AFF;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 15px auto;
                    "></div>
                    <div style="color: #666; font-size: 12px;">åŠ è½½è¯„è®ºä¸­...</div>
                </div>
            `;

            const prompt = `
# è§’è‰²ï¼šè®ºå›è¯„è®ºç”ŸæˆAI
è¯·ä¸ºä»¥ä¸‹å¸–å­ç”Ÿæˆ10æ¡çœŸå®çš„è¯„è®ºå›å¤ã€‚

## å¸–å­ä¿¡æ¯:
æ ‡é¢˜: ${post.title}
å†…å®¹: ${post.content}
ä½œè€…: ${post.authorName}

## è®ºå›èƒŒæ™¯:
ä¸–ç•Œè§‚: ${forum.worldview || 'ç°ä»£éƒ½å¸‚ç”Ÿæ´»åˆ†äº«ç¤¾åŒº'}

## å¯å‚ä¸è¯„è®ºçš„è§’è‰²:
${forumCharacters.map(c => `- ${c.name}: ${c.bio}`).join('\n')}

**é‡è¦ï¼šç»å¯¹ä¸è¦ç”Ÿæˆç”¨æˆ·(${persona.name})çš„è¯„è®ºï¼ç”¨æˆ·ä¼šè‡ªå·±è¯„è®ºï¼**

## è¯„è®ºç”Ÿæˆè¦æ±‚:
1. **çœŸå®æ„Ÿ**: è¯„è®ºè¦åƒçœŸäººå†™çš„ï¼Œæœ‰ä¸åŒçš„è§‚ç‚¹å’Œè¯­æ°”
2. **å¤šæ ·æ€§**: åŒ…æ‹¬èµåŒã€åå¯¹ã€æé—®ã€åˆ†äº«ç»éªŒç­‰ä¸åŒç±»å‹
3. **è§’è‰²åˆ†é…**:
   - 50%ç”±è™šæ„çš„è·¯äººç½‘å‹è¯„è®ºï¼ˆè¯·åˆ›é€ ç¬¦åˆä¸–ç•Œè§‚çš„ç½‘å‹æ˜µç§°ï¼‰
   - 30%ç”±ä¸Šè¿°è§’è‰²è¯„è®ºï¼Œè¦ç¬¦åˆäººè®¾ï¼Œä½¿ç”¨"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
   - 20%ç”±ä¸Šè¿°è§’è‰²åŒ¿åè¯„è®ºï¼Œåªä½¿ç”¨ç½‘åï¼Œä¸æš´éœ²çœŸå®èº«ä»½
4. **äº’åŠ¨æ€§**: è¯„è®ºä¹‹é—´å¯ä»¥æœ‰å›åº”å’Œè®¨è®º
5. **é•¿åº¦é€‚ä¸­**: æ¯æ¡è¯„è®º1-3å¥è¯å³å¯

### è¾“å‡ºæ ¼å¼:
ä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ï¼š

[
  {
    "authorName": "è¯„è®ºè€…å§“å",
    "content": "è¯„è®ºå†…å®¹"
  }
]
`;

            // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºè®ºå›è¯„è®ºç”Ÿæˆçš„å®Œæ•´prompt
            console.log('ğŸ”¥ [è®ºå›è¯„è®ºç”Ÿæˆ] å®Œæ•´Prompt:');
            console.log('='.repeat(80));
            console.log(prompt);
            console.log('='.repeat(80));

            try {
                const response = await callForumAPI(prompt);
                let replies;
                try {
                    replies = JSON.parse(response);
                } catch (e) {
                    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                    if (jsonMatch && jsonMatch[1]) {
                        replies = JSON.parse(jsonMatch[1]);
                    } else {
                        throw new Error("AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚");
                    }
                }

                if (!Array.isArray(replies)) {
                    throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚");
                }

                // ä¿å­˜è¯„è®ºåˆ°æ•°æ®åº“
                for (let i = 0; i < replies.length; i++) {
                    const reply = replies[i];
                    if (reply.authorName && reply.content) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è¯†åˆ«è§’è‰²èº«ä»½ï¼Œæ”¯æŒ"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                        let author = null;
                        let realName = '';

                        // æ£€æŸ¥æ˜¯å¦æ˜¯"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                        const nameMatch = reply.authorName.match(/^(.+)\((.+)\)$/);
                        if (nameMatch) {
                            realName = nameMatch[2]; // æå–çœŸå®èº«ä»½
                            author = characters.find(c => c.name === realName) || personas.find(p => p.name === realName);
                        } else {
                            // ç›´æ¥åŒ¹é…è§’è‰²å
                            author = characters.find(c => c.name === reply.authorName) || personas.find(p => p.name === reply.authorName);
                        }

                        await db.forumReplies.add({
                            postId: postId,
                            content: reply.content,
                            authorName: reply.authorName,
                            authorAvatar: author ? author.avatarUrl : createDefaultAvatar(reply.authorName),
                            timestamp: Date.now() + i * 1000, // é”™å¼€æ—¶é—´æˆ³
                            likes: Math.floor(Math.random() * 100) // å…³é”®æ–°å¢ï¼šç”Ÿæˆ0-99çš„éšæœºç‚¹èµæ•°
                        });
                    }
                }
            } catch (error) {
                console.error("ç”Ÿæˆè¯„è®ºå¤±è´¥:", error);
                showToast("ç”Ÿæˆè¯„è®ºå¤±è´¥: " + error.message, 'error');
            }
        }

        // æ¸²æŸ“å›å¤ (å·²ç¾åŒ–ç‰ˆæœ¬)
        async function renderReplies(postId) {
            const replies = await db.forumReplies.where('postId').equals(postId).sortBy('timestamp');
            const listContainer = document.getElementById('replies-list');

            const userLikes = await db.replyLikes.where('userId').equals('user').toArray();
            const likedReplyIds = new Set(userLikes.map(like => like.replyId));

            // SVGå›¾æ ‡å®šä¹‰
            const svgThumbsUpOutline = `<svg viewBox="0 0 24 24"><path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558-.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z"></path></svg>`;
            const svgThumbsUpFilled = `<svg viewBox="0 0 24 24"><path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558-.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z" fill="currentColor"></path></svg>`;

            const repliesHtml = replies.map((reply, index) => { // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ  index å‚æ•°
                const isLiked = likedReplyIds.has(reply.id);
                const likedClass = isLiked ? 'liked' : '';
                const thumbsUpIcon = isLiked ? svgThumbsUpFilled : svgThumbsUpOutline;
                // ğŸ”¥ã€ä¿®å¤ã€‘æ ¼å¼åŒ–æ—¶é—´æˆ³
                const formattedTime = new Date(reply.timestamp).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="reply-item" data-reply-id="${reply.id}">
                        <img class="reply-avatar" src="${reply.authorAvatar || createDefaultAvatar(reply.authorName)}" alt="${reply.authorName}">
                        <div class="reply-body">
                            <div class="reply-author">${reply.authorName}</div>

                            <div class="reply-meta">
                                <span>No.${index + 1}</span>
                                <span>${formattedTime}</span>
                            </div>

                            <div class="reply-content">${reply.content.replace(/\n/g, '<br>')}</div>
                            <div class="reply-actions">
                                <button class="reply-action-btn like-btn ${likedClass}" onclick="likeReply(${reply.id})" title="ç‚¹èµ">
                                    ${thumbsUpIcon}
                                    <span class="like-count">${reply.likes || 0}</span>
                                </button>
                                <button class="reply-action-btn" onclick="replyToComment(${reply.id}, '${reply.authorName}')" title="å›å¤">
                                    <i class="far fa-comment"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ğŸ”¥ã€æ–°å¢ã€‘åœ¨è¯„è®ºåˆ—è¡¨æœ€åæ·»åŠ "åŠ è½½æ›´å¤šè¯„è®º"æŒ‰é’®
            const loadMoreButton = replies.length > 0 ? `
                <div class="load-more-comments-container">
                    <button class="load-more-comments-btn" onclick="loadMoreComments(${postId})">
                        ğŸ”˜åŠ è½½æ›´å¤šè¯„è®º
                    </button>
                </div>
            ` : '';

            listContainer.innerHTML = repliesHtml + loadMoreButton;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½æ›´å¤šè¯„è®ºåŠŸèƒ½
        async function loadMoreComments(postId) {
            try {
                const post = await db.forumPosts.get(postId);
                if (!post) return;

                const forum = await db.forums.get(post.forumId);
                const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));
                const persona = personas.find(p => p.id === forum.personaId);

                // è·å–ç°æœ‰è¯„è®ºä½œä¸ºä¸Šä¸‹æ–‡
                const existingReplies = await db.forumReplies.where('postId').equals(postId).sortBy('timestamp');

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadMoreBtn = document.querySelector('.load-more-comments-btn');
                const originalText = loadMoreBtn.textContent;
                loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
                loadMoreBtn.disabled = true;

                // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
                const recentContext = existingReplies.slice(-5).map(reply =>
                    `${reply.authorName}: ${reply.content}`
                ).join('\n');

                const prompt = `
# è§’è‰²ï¼šè®ºå›è¯„è®ºç”ŸæˆAI
è¯·ä¸ºä»¥ä¸‹å¸–å­ç”Ÿæˆ10æ¡çœŸå®çš„è¯„è®ºå›å¤ï¼Œè¿™äº›è¯„è®ºéœ€è¦ä¸ä¹‹å‰çš„è®¨è®ºæœ‰ä¸€å®šçš„ä¸Šä¸‹æ–‡å…³è”ã€‚

## å¸–å­ä¿¡æ¯:
æ ‡é¢˜: ${post.title}
å†…å®¹: ${post.content}
ä½œè€…: ${post.authorName}

## è®ºå›èƒŒæ™¯:
ä¸–ç•Œè§‚: ${forum.worldview || 'ç°ä»£éƒ½å¸‚ç”Ÿæ´»åˆ†äº«ç¤¾åŒº'}

## æœ€è¿‘çš„è¯„è®ºä¸Šä¸‹æ–‡:
${recentContext || 'æš‚æ— è¯„è®º'}

## å¯å‚ä¸è¯„è®ºçš„è§’è‰²:
${forumCharacters.map(c => `- ${c.name}: ${c.bio}`).join('\n')}

**é‡è¦ï¼šç»å¯¹ä¸è¦ç”Ÿæˆç”¨æˆ·(${persona.name})çš„è¯„è®ºï¼ç”¨æˆ·ä¼šè‡ªå·±è¯„è®ºï¼**

## è¯„è®ºç”Ÿæˆè¦æ±‚:
1. **çœŸå®æ„Ÿ**: è¯„è®ºè¦åƒçœŸäººå†™çš„ï¼Œæœ‰ä¸åŒçš„è§‚ç‚¹å’Œè¯­æ°”
2. **ä¸Šä¸‹æ–‡å…³è”**: æ–°è¯„è®ºåº”è¯¥ä¸ä¹‹å‰çš„è®¨è®ºæœ‰å…³è”ï¼Œå¯ä»¥ï¼š
   - å›åº”ä¹‹å‰æŸä¸ªè§’è‰²çš„è§‚ç‚¹
   - ç»§ç»­ä¹‹å‰çš„è¯é¢˜è®¨è®º
   - æå‡ºæ–°çš„ç›¸å…³é—®é¢˜
   - å¯¹ä¹‹å‰çš„è¯„è®ºè¡¨ç¤ºèµåŒæˆ–ä¸åŒæ„è§
3. **å¤šæ ·æ€§**: åŒ…æ‹¬èµåŒã€åå¯¹ã€æé—®ã€åˆ†äº«ç»éªŒç­‰ä¸åŒç±»å‹
4. **è§’è‰²åˆ†é…**:
   - 50%ç”±è™šæ„çš„è·¯äººç½‘å‹è¯„è®ºï¼ˆè¯·åˆ›é€ ç¬¦åˆä¸–ç•Œè§‚çš„ç½‘å‹æ˜µç§°ï¼‰
   - 30%ç”±ä¸Šè¿°è§’è‰²è¯„è®ºï¼Œè¦ç¬¦åˆäººè®¾ï¼Œä½¿ç”¨"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
   - 20%ç”±ä¸Šè¿°è§’è‰²åŒ¿åè¯„è®ºï¼Œåªä½¿ç”¨ç½‘åï¼Œä¸æš´éœ²çœŸå®èº«ä»½
5. **äº’åŠ¨æ€§**: è¯„è®ºä¹‹é—´å¯ä»¥æœ‰å›åº”å’Œè®¨è®º
6. **é•¿åº¦é€‚ä¸­**: æ¯æ¡è¯„è®º1-3å¥è¯å³å¯

### è¾“å‡ºæ ¼å¼:
ä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ï¼š

[
  {
    "authorName": "è¯„è®ºè€…å§“å",
    "content": "è¯„è®ºå†…å®¹"
  }
]
`;

                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨æ­£ç¡®çš„APIè°ƒç”¨å‡½æ•°
                const response = await callForumAPI(prompt);
                let newReplies = [];

                try {
                    newReplies = JSON.parse(response);
                } catch (e) {
                    console.log('ğŸ”¥ [loadMoreComments] ç›´æ¥è§£æJSONå¤±è´¥ï¼Œå°è¯•æå–ä»£ç å—');

                    // å°è¯•æå– ```json ä»£ç å—
                    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                    if (jsonMatch && jsonMatch[1]) {
                        console.log('ğŸ”¥ [loadMoreComments] æ‰¾åˆ°JSONä»£ç å—:', jsonMatch[1]);
                        try {
                            newReplies = JSON.parse(jsonMatch[1]);
                        } catch (e2) {
                            console.error('ğŸ”¥ [loadMoreComments] JSONä»£ç å—è§£æå¤±è´¥:', e2);
                            throw new Error(`AIè¿”å›çš„JSONä»£ç å—æ ¼å¼é”™è¯¯: ${e2.message}`);
                        }
                    } else {
                        // å°è¯•æå–æ™®é€šçš„ ``` ä»£ç å—
                        const codeMatch = response.match(/```\s*([\s\S]*?)\s*```/);
                        if (codeMatch && codeMatch[1]) {
                            console.log('ğŸ”¥ [loadMoreComments] æ‰¾åˆ°æ™®é€šä»£ç å—:', codeMatch[1]);
                            try {
                                newReplies = JSON.parse(codeMatch[1]);
                            } catch (e3) {
                                console.error('ğŸ”¥ [loadMoreComments] æ™®é€šä»£ç å—è§£æå¤±è´¥:', e3);
                                throw new Error(`AIè¿”å›çš„ä»£ç å—æ ¼å¼é”™è¯¯: ${e3.message}`);
                            }
                        } else {
                            // å°è¯•æŸ¥æ‰¾æ•°ç»„æ ¼å¼ [...]
                            const arrayMatch = response.match(/\[[\s\S]*\]/);
                            if (arrayMatch) {
                                console.log('ğŸ”¥ [loadMoreComments] æ‰¾åˆ°æ•°ç»„æ ¼å¼:', arrayMatch[0]);
                                try {
                                    newReplies = JSON.parse(arrayMatch[0]);
                                } catch (e4) {
                                    console.error('ğŸ”¥ [loadMoreComments] æ•°ç»„æ ¼å¼è§£æå¤±è´¥:', e4);
                                    throw new Error(`AIè¿”å›çš„æ•°ç»„æ ¼å¼é”™è¯¯: ${e4.message}`);
                                }
                            } else {
                                console.error('ğŸ”¥ [loadMoreComments] æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼');
                                throw new Error(`AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚åŸå§‹å“åº”: ${response.substring(0, 200)}...`);
                            }
                        }
                    }
                }

                // ä¿å­˜æ–°è¯„è®ºåˆ°æ•°æ®åº“
                const baseTimestamp = Date.now();
                let successCount = 0;

                for (let i = 0; i < newReplies.length; i++) {
                    const replyData = newReplies[i];
                    if (!replyData.content || !replyData.authorName) continue;

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è¯†åˆ«è§’è‰²èº«ä»½ï¼Œæ”¯æŒ"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                    let author = null;
                    let realName = '';

                    // æ£€æŸ¥æ˜¯å¦æ˜¯"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                    const nameMatch = replyData.authorName.match(/^(.+?)\((.+?)\)$/);
                    if (nameMatch) {
                        const nickname = nameMatch[1].trim();
                        realName = nameMatch[2].trim();
                        author = characters.find(c => c.name === realName);
                        if (author) {
                            // ä½¿ç”¨ç½‘åä½œä¸ºæ˜¾ç¤ºåç§°
                            replyData.authorName = nickname;
                        }
                    } else {
                        // ç›´æ¥åŒ¹é…è§’è‰²å
                        author = characters.find(c => c.name === replyData.authorName);
                    }

                    const reply = {
                        postId: postId,
                        authorName: replyData.authorName,
                        authorAvatar: author ? author.avatarUrl : createDefaultAvatar(replyData.authorName),
                        content: replyData.content,
                        timestamp: baseTimestamp + (i * 1000), // é—´éš”1ç§’
                        likes: Math.floor(Math.random() * 5), // éšæœºç‚¹èµæ•°
                        characterId: author ? author.id : null
                    };
                    await db.forumReplies.add(reply);
                    successCount++;
                }

                // é‡æ–°æ¸²æŸ“è¯„è®ºåˆ—è¡¨
                await renderReplies(postId);
                showToast(`æˆåŠŸåŠ è½½äº† ${successCount} æ¡æ–°è¯„è®º`, 'success');

            } catch (error) {
                console.error('åŠ è½½æ›´å¤šè¯„è®ºå¤±è´¥:', error);
                showToast('åŠ è½½è¯„è®ºå¤±è´¥: ' + error.message, 'error');

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const loadMoreBtn = document.querySelector('.load-more-comments-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.textContent = 'ğŸ”˜åŠ è½½æ›´å¤šè¯„è®º';
                    loadMoreBtn.disabled = false;
                }
            }
        }

        // ğŸ”¥ã€ä¼˜åŒ–åã€‘æ˜¾ç¤ºå‘å¸–æ¨¡æ€æ¡†
        function showCreatePostModal() {
            const modal = document.getElementById('create-post-modal');
            modal.style.display = 'flex';

            // æ¸…ç©ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
            document.getElementById('post-title-input').value = '';
            document.getElementById('post-content-input').value = '';
            document.getElementById('anonymous-post-checkbox').checked = false;
            document.getElementById('post-image-upload').value = '';
            document.getElementById('post-image-preview-container').style.display = 'none';
            document.getElementById('post-image-preview').src = '';
            updateCharCount();

            const titleInput = document.getElementById('post-title-input');
            const contentInput = document.getElementById('post-content-input');
            titleInput.oninput = updateCharCount;
            contentInput.oninput = updateCharCount;

            // ç»‘å®šå›¾ç‰‡ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            const uploadBtn = document.getElementById('post-upload-image-btn');
            const fileInput = document.getElementById('post-image-upload');
            const removeBtn = document.getElementById('post-remove-image-btn');
            const previewContainer = document.getElementById('post-image-preview-container');
            const previewImg = document.getElementById('post-image-preview');

            uploadBtn.onclick = () => fileInput.click();

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewImg.src = event.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };

            removeBtn.onclick = () => {
                fileInput.value = '';
                previewImg.src = '';
                previewContainer.style.display = 'none';
            };
        }

        // éšè—å‘å¸–æ¨¡æ€æ¡†
        function hideCreatePostModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('create-post-modal');
            modal.style.display = 'none';
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const titleInput = document.getElementById('post-title-input');
            const contentInput = document.getElementById('post-content-input');
            const titleCount = document.getElementById('title-count');
            const contentCount = document.getElementById('content-count');

            titleCount.textContent = `${titleInput.value.length}/100`;
            contentCount.textContent = `${contentInput.value.length}/2000`;

            // è¶…å‡ºé™åˆ¶æ—¶å˜çº¢
            titleCount.style.color = titleInput.value.length > 100 ? '#ff3b30' : '#666';
            contentCount.style.color = contentInput.value.length > 2000 ? '#ff3b30' : '#666';
        }

        // ğŸ”¥ã€ä¼˜åŒ–åã€‘æäº¤ç”¨æˆ·å‘å¸– (æ”¯æŒå›¾ç‰‡)
        async function submitUserPost() {
            const title = document.getElementById('post-title-input').value.trim();
            const content = document.getElementById('post-content-input').value.trim();
            const isAnonymous = document.getElementById('anonymous-post-checkbox').checked;
            const imageInput = document.getElementById('post-image-upload');
            const imageFile = imageInput.files[0];

            if (!title && !imageFile) { // å¦‚æœæ ‡é¢˜å’Œå›¾ç‰‡éƒ½ä¸ºç©º
                showToast('è¯·è¾“å…¥æ ‡é¢˜æˆ–ä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }
            if (!content && !imageFile) { // å¦‚æœå†…å®¹å’Œå›¾ç‰‡éƒ½ä¸ºç©º
                showToast('è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }

            if (title.length > 100 || content.length > 2000) {
                showToast('æ ‡é¢˜æˆ–å†…å®¹è¶…å‡ºå­—æ•°é™åˆ¶', 'error');
                return;
            }

            showToast('æ­£åœ¨å‘å¸ƒå¸–å­...', 'info');

            try {
                const forum = await db.forums.get(parseInt(currentForumId));
                const persona = personas.find(p => p.id === forum.personaId);

                let authorName, authorId, authorAvatar;
                if (isAnonymous) {
                    const anonymousNames = ['ç¥ç§˜è·¯äºº', 'åŒ¿åç½‘å‹', 'è·¯è¿‡çš„äºº'];
                    authorName = anonymousNames[Math.floor(Math.random() * anonymousNames.length)];
                    authorId = 'anonymous_' + Date.now();
                    authorAvatar = null;
                } else {
                    authorName = persona.name;
                    authorId = persona.id;
                    authorAvatar = persona.avatarUrl;
                }

                const postData = {
                    forumId: parseInt(currentForumId),
                    title: title || "åˆ†äº«å›¾ç‰‡", // å¦‚æœæ²¡æœ‰æ ‡é¢˜ï¼Œç»™ä¸ªé»˜è®¤æ ‡é¢˜
                    content,
                    authorId,
                    authorName,
                    authorAvatar,
                    timestamp: Date.now(),
                    isUserPost: true,
                    isAnonymous
                };

                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(imageFile);
                    });
                }

                const postId = await db.forumPosts.add(postData);

                if (imageUrl) {
                    await db.forumPostImages.add({ postId, imageUrl });
                }

                hideCreatePostModal();
                await renderForumPosts(currentForumId);

                showToast('å¸–å­å‘å¸ƒæˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('å‘å¸–å¤±è´¥:', error);
                showToast('å‘å¸–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ã€æœ€ç»ˆä¿®å¤ã€‘ä¸ºç”¨æˆ·å¸–å­ç”ŸæˆAIå›å¤ (æ™ºèƒ½åˆ†æµ)
        async function generateRepliesForUserPost(postId, imageUrl = null) {
            const post = await db.forumPosts.get(postId);
            if (!post) return;

            const forum = await db.forums.get(post.forumId);
            const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));
            const persona = personas.find(p => p.id === forum.personaId);

            let imageContext = '';
            if (imageUrl) {
                // è¿™æ˜¯å‘Šè¯‰AIæœ‰å›¾ç‰‡å­˜åœ¨çš„å…³é”®
                imageContext = `\n\n**é‡è¦**ï¼šç”¨æˆ·åœ¨å¸–å­ä¸­é™„å¸¦äº†ä¸€å¼ å›¾ç‰‡ï¼Œä½ å¿…é¡»å¯¹å›¾ç‰‡å†…å®¹è¿›è¡Œå›åº”ã€‚ä½ çš„å›å¤å¿…é¡»ä½“ç°å‡ºä½ çœ‹åˆ°äº†è¿™å¼ å›¾ç‰‡ã€‚`;
            }

            const prompt = `
# è§’è‰²ï¼šè®ºå›å›å¤ç”ŸæˆAI
ç”¨æˆ·åœ¨è®ºå›å‘äº†ä¸€ä¸ªå¸–å­ï¼Œè¯·ç”Ÿæˆ8-12æ¡çœŸå®çš„å›å¤ã€‚

## ç”¨æˆ·å¸–å­:
æ ‡é¢˜: ${post.title}
å†…å®¹: ${post.content}
ä½œè€…: ${post.authorName}${post.isAnonymous ? ' (åŒ¿åç”¨æˆ·ï¼Œèº«ä»½æœªçŸ¥)' : ''}
${imageContext}

## è®ºå›èƒŒæ™¯:
ä¸–ç•Œè§‚: ${forum.worldview || 'ç°ä»£éƒ½å¸‚ç”Ÿæ´»åˆ†äº«ç¤¾åŒº'}

## å¯å‚ä¸å›å¤çš„è§’è‰²:
${forumCharacters.map(c => `- ${c.name}: ${c.bio}`).join('\n')}

**é‡è¦ï¼šç»å¯¹ä¸è¦ç”Ÿæˆç”¨æˆ·(${persona.name})çš„è¯„è®ºï¼ç”¨æˆ·ä¼šè‡ªå·±è¯„è®ºï¼**

## å›å¤ç”Ÿæˆè¦æ±‚:
1.  **ğŸ”¥ è¯†å›¾ä¼˜å…ˆ**: å¦‚æœå¸–å­æœ‰å›¾ç‰‡ï¼Œä½ çš„å›å¤å¿…é¡»ä¼˜å…ˆå›´ç»•å›¾ç‰‡å†…å®¹å±•å¼€ã€‚
2.  **çœŸå®æ„Ÿ**: å›å¤è¦åƒçœŸäººå†™çš„ï¼Œæœ‰ä¸åŒçš„è§‚ç‚¹å’Œè¯­æ°”
3.  **å¤šæ ·æ€§**: åŒ…æ‹¬èµåŒã€åå¯¹ã€æé—®ã€åˆ†äº«ç»éªŒã€è°ƒä¾ƒç­‰ä¸åŒç±»å‹
4.  **è§’è‰²åˆ†é…**:
   - 50%ç”±è™šæ„çš„è·¯äººç½‘å‹å›å¤ï¼ˆè¯·åˆ›é€ ç¬¦åˆä¸–ç•Œè§‚çš„ç½‘å‹æ˜µç§°ï¼‰
   - 30%ç”±ä¸Šè¿°è§’è‰²å›å¤ï¼Œè¦ç¬¦åˆäººè®¾ï¼Œä½¿ç”¨"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
   - 20%ç”±ä¸Šè¿°è§’è‰²åŒ¿åå›å¤ï¼Œåªä½¿ç”¨ç½‘åï¼Œä¸æš´éœ²çœŸå®èº«ä»½
5.  **äº’åŠ¨æ€§**: å¯ä»¥@ç”¨æˆ·æˆ–å…¶ä»–å›å¤è€…${post.isAnonymous ? 'ï¼Œä½†ä¸è¦è¯•å›¾çŒœæµ‹åŒ¿åç”¨æˆ·çš„çœŸå®èº«ä»½' : ''}
6.  **é•¿åº¦é€‚ä¸­**: æ¯æ¡å›å¤1-3å¥è¯å³å¯
7.  **åŒ¿åä¿æŠ¤**: ${post.isAnonymous ? 'å¸–å­ä½œè€…æ˜¯åŒ¿åçš„ï¼ŒAIè§’è‰²ä¸åº”è¯¥è®¤å‡ºæˆ–æš—ç¤ºçŸ¥é“ä½œè€…çš„çœŸå®èº«ä»½' : 'æ­£å¸¸äº’åŠ¨å³å¯'}

### è¾“å‡ºæ ¼å¼:
**é‡è¦ï¼šåªè¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ï¼**

[
  {
    "authorName": "å›å¤è€…ç½‘åæˆ–ç½‘å(çœŸå®èº«ä»½)",
    "content": "å›å¤å†…å®¹"
  }
]

**å†æ¬¡å¼ºè°ƒï¼šç›´æ¥è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦åŒ…è£…åœ¨ä»£ç å—ä¸­ï¼**
`;

            try {
                let response;
                // ã€æ™ºèƒ½åˆ†æµã€‘
                if (imageUrl) {
                    console.log("æ­£åœ¨è°ƒç”¨å›¾ç‰‡API...");
                    response = await callForumAPIWithImage(prompt, imageUrl);
                } else {
                    console.log("æ­£åœ¨è°ƒç”¨æ–‡æœ¬API...");
                    response = await callForumAPI(prompt);
                }

                let replies;
                console.log('ğŸ”¥ [generateRepliesForUserPost] AIåŸå§‹å“åº”:', response);

                try {
                    replies = JSON.parse(response);
                } catch (e) {
                    console.log('ğŸ”¥ [generateRepliesForUserPost] ç›´æ¥è§£æJSONå¤±è´¥ï¼Œå°è¯•æå–ä»£ç å—');

                    // å°è¯•æå– ```json ä»£ç å—
                    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                    if (jsonMatch && jsonMatch[1]) {
                        console.log('ğŸ”¥ [generateRepliesForUserPost] æ‰¾åˆ°JSONä»£ç å—:', jsonMatch[1]);
                        try {
                            replies = JSON.parse(jsonMatch[1]);
                        } catch (e2) {
                            console.error('ğŸ”¥ [generateRepliesForUserPost] JSONä»£ç å—è§£æå¤±è´¥:', e2);
                            throw new Error(`AIè¿”å›çš„JSONä»£ç å—æ ¼å¼é”™è¯¯: ${e2.message}`);
                        }
                    } else {
                        // å°è¯•æå–æ™®é€šçš„ ``` ä»£ç å—
                        const codeMatch = response.match(/```\s*([\s\S]*?)\s*```/);
                        if (codeMatch && codeMatch[1]) {
                            console.log('ğŸ”¥ [generateRepliesForUserPost] æ‰¾åˆ°æ™®é€šä»£ç å—:', codeMatch[1]);
                            try {
                                replies = JSON.parse(codeMatch[1]);
                            } catch (e3) {
                                console.error('ğŸ”¥ [generateRepliesForUserPost] æ™®é€šä»£ç å—è§£æå¤±è´¥:', e3);
                                throw new Error(`AIè¿”å›çš„ä»£ç å—æ ¼å¼é”™è¯¯: ${e3.message}`);
                            }
                        } else {
                            // å°è¯•æŸ¥æ‰¾æ•°ç»„æ ¼å¼ [...]
                            const arrayMatch = response.match(/\[[\s\S]*\]/);
                            if (arrayMatch) {
                                console.log('ğŸ”¥ [generateRepliesForUserPost] æ‰¾åˆ°æ•°ç»„æ ¼å¼:', arrayMatch[0]);
                                try {
                                    replies = JSON.parse(arrayMatch[0]);
                                } catch (e4) {
                                    console.error('ğŸ”¥ [generateRepliesForUserPost] æ•°ç»„æ ¼å¼è§£æå¤±è´¥:', e4);
                                    throw new Error(`AIè¿”å›çš„æ•°ç»„æ ¼å¼é”™è¯¯: ${e4.message}`);
                                }
                            } else {
                                console.error('ğŸ”¥ [generateRepliesForUserPost] æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼');
                                throw new Error(`AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚åŸå§‹å“åº”: ${response.substring(0, 200)}...`);
                            }
                        }
                    }
                }

                if (Array.isArray(replies)) {
                    for (let i = 0; i < replies.length; i++) {
                        const reply = replies[i];
                        if (reply.authorName && reply.content) {
                            // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è¯†åˆ«è§’è‰²èº«ä»½ï¼Œæ”¯æŒ"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                            let author = null;
                            let realName = '';

                            // æ£€æŸ¥æ˜¯å¦æ˜¯"ç½‘å(çœŸå®èº«ä»½)"æ ¼å¼
                            const nameMatch = reply.authorName.match(/^(.+)\((.+)\)$/);
                            if (nameMatch) {
                                realName = nameMatch[2]; // æå–çœŸå®èº«ä»½
                                author = characters.find(c => c.name === realName) || personas.find(p => p.name === realName);
                            } else {
                                // ç›´æ¥åŒ¹é…è§’è‰²å
                                author = characters.find(c => c.name === reply.authorName) || personas.find(p => p.name === reply.authorName);
                            }

                            await db.forumReplies.add({
                                postId: postId,
                                content: reply.content,
                                authorName: reply.authorName,
                                authorAvatar: author ? author.avatarUrl : createDefaultAvatar(reply.authorName),
                                timestamp: Date.now() + i * 2000
                            });
                        }
                    }
                    showToast(`æ”¶åˆ°äº†${replies.length}æ¡å›å¤ï¼`, 'success');
                }

            } catch (error) {
                console.error("ç”Ÿæˆç”¨æˆ·å¸–å­å›å¤å¤±è´¥:", error);
                // ã€é‡è¦ã€‘å‘ç”¨æˆ·æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                showToast(`ç”Ÿæˆå›å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç‚¹èµè¯„è®º (å·²ç¾åŒ–ç‰ˆæœ¬)
        async function likeReply(replyId) {
            try {
                const reply = await db.forumReplies.get(replyId);
                if (!reply) return;

                const likeBtn = document.querySelector(`[data-reply-id="${replyId}"] .like-btn`);
                const likeCountSpan = likeBtn.querySelector('.like-count');

                // SVGå›¾æ ‡å®šä¹‰ (ä¸renderRepliesä¸­ä¿æŒä¸€è‡´)
                const svgThumbsUpOutline = `<svg viewBox="0 0 24 24"><path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558-.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z"></path></svg>`;
                const svgThumbsUpFilled = `<svg viewBox="0 0 24 24"><path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558-.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z" fill="currentColor"></path></svg>`;

                const existingLike = await db.replyLikes.where('[userId+replyId]').equals(['user', replyId]).first();

                if (existingLike) {
                    // å–æ¶ˆç‚¹èµ
                    await db.replyLikes.delete(existingLike.id);
                    reply.likes = Math.max(0, (reply.likes || 0) - 1);
                    likeBtn.classList.remove('liked');
                    likeBtn.innerHTML = svgThumbsUpOutline + `<span class="like-count">${reply.likes || 0}</span>`;
                } else {
                    // ç‚¹èµ
                    await db.replyLikes.add({ userId: 'user', replyId: replyId, timestamp: Date.now() });
                    reply.likes = (reply.likes || 0) + 1;
                    likeBtn.classList.add('liked');
                    likeBtn.innerHTML = svgThumbsUpFilled + `<span class="like-count">${reply.likes || 0}</span>`;
                }

                await db.forumReplies.update(replyId, { likes: reply.likes });

            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                showToast('ç‚¹èµå¤±è´¥', 'error');
            }
        }

        // å›å¤è¯„è®º
        async function replyToComment(replyId, authorName) {
            const input = document.getElementById('reply-input');
            if (input) {
                input.value = `@${authorName} `;
                input.focus();
                // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
                input.setSelectionRange(input.value.length, input.value.length);
            }
        }

        // ã€æ–°å¢ã€‘ä¸ºè®ºå›å›å¤è®¾è®¡çš„ç®€åŒ–ç‰ˆAPIè°ƒç”¨å‡½æ•°
        async function callSimpleTextAPI(prompt) {
            if (!apiSettings.key) {
                throw new Error('APIå¯†é’¥æœªè®¾ç½®');
            }

            const requestBody = {
                model: apiSettings.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85 // ç¨å¾®æé«˜ä¸€ç‚¹åˆ›é€ æ€§
            };

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let url, headers, body;

            if (isGemini) {
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = { 'Content-Type': 'application/json' };
                body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });
            } else {
                url = apiSettings.base.endsWith('/v1') ? `${apiSettings.base}/chat/completions` : `${apiSettings.base}/v1/chat/completions`;
                headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.key}` };
                body = JSON.stringify(requestBody);
            }

            const response = await fetch(url, { method: 'POST', headers: headers, body: body });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            if (isGemini) {
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } else {
                return data.choices?.[0]?.message?.content;
            }
        }

        // ã€æ–°å¢ã€‘åŒ¿åæ¨¡å¼çŠ¶æ€
        let isAnonymousMode = false;

        // ã€æ–°å¢ã€‘åˆ‡æ¢åŒ¿åæ¨¡å¼
        function toggleAnonymousMode() {
            isAnonymousMode = !isAnonymousMode;
            const toggleBtn = document.getElementById('anonymous-toggle');
            const replyInput = document.getElementById('reply-input');

            if (isAnonymousMode) {
                toggleBtn.classList.add('active');
                toggleBtn.title = 'åŒ¿åæ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»å…³é—­';
                replyInput.placeholder = 'åŒ¿åå›å¤...';
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.title = 'åŒ¿åå›å¤';
                replyInput.placeholder = 'è¾“å…¥ä½ çš„å›å¤...';
            }
        }

        // ã€æ–°å¢ã€‘ç”ŸæˆåŒ¿åç”¨æˆ·å
        function generateAnonymousName() {
            const prefixes = [
                'çƒ­å¿ƒç½‘å‹', 'è·¯è¿‡ç½‘å‹', 'åŒ¿åç”¨æˆ·', 'ç¥ç§˜çš„', 'ä½è°ƒçš„',
                'æ½œæ°´ç½‘å‹', 'åƒç“œç½‘å‹', 'å›´è§‚ç½‘å‹', 'è£…æ·±æ²‰', 'å®‰é™çš„',
                'ä½›ç³»çš„', 'æ·¡å®šçš„', 'è£…å¿§éƒ', 'ç†æ€§çš„', 'å®¢è§‚çš„'
            ];

            const suffixes = [
                'å°ç™½', 'å°é»‘', 'å°çº¢', 'å°è“', 'å°ç»¿', 'å°ç´«', 'å¥½å¿ƒäºº', 'å°é»„',
                'é˜¿å¼º', 'é˜¿æ˜', 'å°ç‹—', 'å°çŒ«', 'è¢«äººäº²', 'è¢«äººæ‰“', 'åŒå­¦', 'ä¸€åªçŒ¹',
                'å°A', 'å°B', 'å°C', 'å°D', 'å°E', 'å°F', 'å°G', 'å°H'
            ];

            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];

            return `${prefix}${suffix}ï¼ˆæˆ‘ï¼‰`;
        }

        // å‘é€å›å¤
        async function sendReply() {
            const input = document.getElementById('reply-input');
            const content = input.value.trim();
            if (!content || !window.currentPostId) return;

            // ã€ä¿®å¤ã€‘å¦‚æœæ²¡æœ‰currentForumIdï¼Œä»å½“å‰å¸–å­è·å–è®ºå›ID
            if (!currentForumId) {
                const post = await db.forumPosts.get(window.currentPostId);
                if (post) {
                    currentForumId = post.forumId;
                } else {
                    showToast('æ‰¾ä¸åˆ°å¸–å­ä¿¡æ¯', 'error');
                    return;
                }
            }

            const forum = await db.forums.get(parseInt(currentForumId));
            if (!forum) {
                showToast('æ‰¾ä¸åˆ°å½“å‰è®ºå›ä¿¡æ¯', 'error');
                return;
            }

            let persona = null;
            if (!isAnonymousMode) {
                persona = personas.find(p => p.id === forum.personaId);
                if (!persona) {
                    showToast('æ‰¾ä¸åˆ°ç”¨æˆ·èº«ä»½ä¿¡æ¯', 'error');
                    return;
                }
            }

            let reply;

            if (isAnonymousMode) {
                // åŒ¿åå›å¤
                reply = {
                    postId: window.currentPostId,
                    authorId: 'anonymous',
                    authorName: generateAnonymousName(),
                    authorAvatar: createDefaultAvatar('åŒ¿å'),
                    content: content,
                    timestamp: Date.now(),
                    isAnonymous: true
                };
            } else {
                // æ­£å¸¸å›å¤ï¼ˆä½¿ç”¨èº«ä»½é¢å…·ï¼‰
                reply = {
                    postId: window.currentPostId,
                    authorId: 'user',
                    authorName: persona.name,
                    authorAvatar: persona.avatarUrl,
                    content: content,
                    timestamp: Date.now(),
                    isAnonymous: false
                };
            }

            await db.forumReplies.add(reply);
            input.value = '';
            await renderReplies(window.currentPostId);

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æ–°çš„ã€ä¸“å±çš„è®ºå›AIå›å¤æ§åˆ¶å™¨
            handleForumAIReply(content, window.currentPostId);
        }

        // ã€æ–°å¢ã€‘è®ºå›AIå›å¤çš„æ€»æ§åˆ¶å™¨
        async function handleForumAIReply(userContent, postId) {
            try {
                const post = await db.forumPosts.get(postId);
                const forum = await db.forums.get(post.forumId);
                const forumCharacters = characters.filter(c => forum.characterIds.includes(c.id));

                const mentionMatch = userContent.match(/@(\S+)/);
                let replyingCharacter = null;
                let shouldReply = false;

                if (mentionMatch) { // ç”¨æˆ·@äº†æŸäºº
                    const mentionedName = mentionMatch[1];
                    const targetCharacter = forumCharacters.find(c => c.name === mentionedName);

                    if (targetCharacter) { // @çš„æ˜¯ä¸»è¦è§’è‰²
                        shouldReply = Math.random() < 0.6; // 60%æ¦‚ç‡è§’è‰²å›å¤
                        replyingCharacter = targetCharacter;
                    } else { // @çš„æ˜¯NPC
                        shouldReply = Math.random() < 0.7; // 70%æ¦‚ç‡NPCå›å¤
                        replyingCharacter = { name: mentionedName, bio: 'ä¸€ä¸ªè®ºå›è·¯äºº' }; // æ¨¡æ‹Ÿä¸€ä¸ªNPCå¯¹è±¡
                    }
                } else { // ç”¨æˆ·æ²¡æœ‰@ä»»ä½•äººï¼Œæ˜¯æ™®é€šå›å¤
                    shouldReply = Math.random() < 0.7; // 70%æ¦‚ç‡æœ‰äººå›å¤
                    if (shouldReply && forumCharacters.length > 0) {
                        // éšæœºé€‰ä¸€ä¸ªè§’è‰²æ¥å›å¤
                        replyingCharacter = forumCharacters[Math.floor(Math.random() * forumCharacters.length)];
                    }
                }

                if (shouldReply && replyingCharacter) {
                    console.log(`[è®ºå›å›å¤å†³ç­–] å†³å®šç”± "${replyingCharacter.name}" è¿›è¡Œå›å¤ã€‚`);
                    const prompt = await buildForumReplyPrompt(replyingCharacter, post, userContent);

                    // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºè®ºå›å›å¤çš„å®Œæ•´prompt
                    console.log(`ğŸ”¥ [è®ºå›å›å¤ç”Ÿæˆ] ${replyingCharacter.name} çš„å®Œæ•´Prompt:`);
                    console.log('='.repeat(80));
                    console.log(prompt);
                    console.log('='.repeat(80));

                    // ã€é‡è¦ã€‘è°ƒç”¨ä¸€ä¸ªç®€åŒ–çš„APIå‡½æ•°ï¼Œé¿å…ä¸Šä¸‹æ–‡æ±¡æŸ“
                    const aiReplyText = await callSimpleTextAPI(prompt);

                    if (aiReplyText && aiReplyText.trim()) {
                        const reply = {
                            postId: postId,
                            authorId: replyingCharacter.id || 'npc',
                            authorName: replyingCharacter.name,
                            authorAvatar: replyingCharacter.avatarUrl || createDefaultAvatar(replyingCharacter.name),
                            content: aiReplyText.trim(),
                            timestamp: Date.now() + 1000 // ç¡®ä¿åœ¨ç”¨æˆ·å›å¤ä¹‹å
                        };
                        await db.forumReplies.add(reply);
                        // å»¶è¿Ÿåˆ·æ–°ï¼Œæ¨¡æ‹ŸçœŸå®å›å¤
                        setTimeout(() => renderReplies(postId), 1500);
                    }
                } else {
                    console.log('[è®ºå›å›å¤å†³ç­–] æœ¬æ¬¡å†³å®šä¸è§¦å‘AIå›å¤ã€‚');
                }
            } catch (error) {
                console.error("å¤„ç†è®ºå›AIå›å¤å¤±è´¥:", error);
            }
        }

        // ã€æ–°å¢ã€‘ä¸ºè®ºå›å›å¤æ„å»ºä¸“å±çš„AIæŒ‡ä»¤
        async function buildForumReplyPrompt(replyingCharacter, post, userContent) {
            const replies = await db.forumReplies.where('postId').equals(post.id).sortBy('timestamp');
            const recentReplies = replies.slice(-5); // æœ€è¿‘5æ¡è¯„è®ºä½œä¸ºä¸Šä¸‹æ–‡

            return `
è§’è‰²ï¼šè®ºå›è¯„è®ºå‘˜
ä½ çš„èº«ä»½æ˜¯ ${replyingCharacter.name}ï¼Œä½ çš„äººè®¾æ˜¯: ${replyingCharacter.bio || 'ä¸€ä¸ªæ™®é€šçš„è®ºå›ç½‘å‹'}

å½“å‰åœºæ™¯:
åœ¨ä¸€ä¸ªåä¸º "${post.title}" çš„å¸–å­é‡Œï¼Œä½ çœ‹åˆ°äº†ç”¨æˆ·çš„ä¸€æ¡æ–°è¯„è®ºã€‚

å¸–å­å†…å®¹:
${post.content}

æœ€è¿‘çš„å‡ æ¡è¯„è®º:
${recentReplies.map(r => `${r.authorName}: ${r.content}`).join('\n')}

ç”¨æˆ·åˆšåˆšè¯´:
"${userContent}"

ä½ çš„ä»»åŠ¡:
ä½œä¸º ${replyingCharacter.name}ï¼Œå¯¹ç”¨æˆ·çš„è¯„è®ºåšå‡ºè‡ªç„¶çš„å›åº”ã€‚

å›å¤è¦æ±‚:
1. ä¿æŒäººè®¾: ä¸¥æ ¼æŒ‰ç…§ä½ çš„æ€§æ ¼å’Œèº«ä»½è¿›è¡Œå›å¤ã€‚
2. è‡ªç„¶ç®€çŸ­: å›å¤è¦åƒçœŸå®çš„è®ºå›è¯„è®ºï¼Œ1-3å¥è¯å³å¯ã€‚
3. ä½¿ç”¨è¡¨æƒ…: ä¸ºäº†è®©è®ºå›æ›´æœ‰è¶£ï¼Œè¯·åœ¨ä½ çš„å›å¤ä¸­å°‘é‡ä½¿ç”¨æ–‡å­—è¡¨æƒ…ã€é¢œæ–‡å­—æˆ–emojiï¼Œä½†æ•´æ¡å¸–å­çš„è¯„è®ºåŒºè¿™ç±»è¡¨æƒ…çš„æ€»æ•°ä¸åº”è¶…è¿‡ä¸¤ä¸ªã€‚
4. ç›´æ¥è¾“å‡º: åªè¿”å›çº¯æ–‡æœ¬çš„å›å¤å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•JSONæ ¼å¼æˆ–å¤šä½™çš„è§£é‡Šã€‚

è¯·ç°åœ¨å¼€å§‹ä½ çš„å›å¤:
`;
        }

        // æ”¶è—/å–æ¶ˆæ”¶è—å¸–å­ (å·²ä¿®å¤å¹¶å¢åŠ è°ƒè¯•æ—¥å¿—çš„ç‰ˆæœ¬)
        async function toggleFavoritePost() {
            console.log('--- [è®ºå›æ”¶è—] åŠŸèƒ½è§¦å‘ ---');

            if (!window.currentPostId) {
                console.error('ã€é”™è¯¯ã€‘æ”¶è—å¤±è´¥ï¼Œå› ä¸º window.currentPostId æœªè®¾ç½®ã€‚');
                showToast('é”™è¯¯ï¼šæ²¡æœ‰å¸–å­ID', 'error');
                return;
            }

            // ç¡®ä¿postIdæ˜¯æ•°å­—ç±»å‹ï¼Œè¿™å¯¹äºæ•°æ®åº“æŸ¥è¯¢è‡³å…³é‡è¦
            const postId = parseInt(window.currentPostId);
            const favIcon = document.querySelector('#favorite-btn i');

            console.log(`[è®ºå›æ”¶è—] å‡†å¤‡ä¸ºå¸–å­ ID: ${postId} (ç±»å‹: ${typeof postId}) åˆ‡æ¢æ”¶è—çŠ¶æ€`);

            if (!favIcon) {
                console.error('ã€é”™è¯¯ã€‘æ‰¾ä¸åˆ°æ”¶è—æŒ‰é’®çš„å›¾æ ‡å…ƒç´ ã€‚');
                return;
            }

            try {
                console.log('[è®ºå›æ”¶è—] æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“ï¼Œæ£€æŸ¥æ˜¯å¦å·²æ”¶è—...');
                const existingFav = await db.forumFavorites.where('[userId+postId]').equals(['user', postId]).first();

                if (existingFav) {
                    console.log('[è®ºå›æ”¶è—] å¸–å­å·²æ”¶è—ï¼Œå‡†å¤‡å–æ¶ˆã€‚è®°å½•:', existingFav);
                    await db.forumFavorites.delete(existingFav.id);
                    console.log('[è®ºå›æ”¶è—] æ•°æ®åº“åˆ é™¤æ“ä½œæˆåŠŸã€‚');

                    favIcon.className = 'far fa-star';
                    showToast('å·²å–æ¶ˆæ”¶è—', 'info');
                    console.log('[è®ºå›æ”¶è—] UIå·²æ›´æ–°ä¸º"æœªæ”¶è—"çŠ¶æ€ã€‚');
                } else {
                    const newFav = { userId: 'user', postId: postId, timestamp: Date.now() };
                    console.log('[è®ºå›æ”¶è—] å¸–å­æœªæ”¶è—ï¼Œå‡†å¤‡æ·»åŠ ã€‚æ–°è®°å½•:', newFav);
                    await db.forumFavorites.add(newFav);
                    console.log('[è®ºå›æ”¶è—] æ•°æ®åº“æ·»åŠ æ“ä½œæˆåŠŸã€‚');

                    favIcon.className = 'fas fa-star';
                    showToast('æ”¶è—æˆåŠŸï¼', 'success');
                    console.log('[è®ºå›æ”¶è—] UIå·²æ›´æ–°ä¸º"å·²æ”¶è—"çŠ¶æ€ã€‚');
                }
            } catch (error) {
                console.error("--- [è®ºå›æ”¶è—] æ•°æ®åº“æ“ä½œå¤±è´¥ï¼---", error);
                showToast("æ”¶è—æ“ä½œæ•°æ®åº“å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦æƒ…", "error");
            }
            console.log('--- [è®ºå›æ”¶è—] åŠŸèƒ½æ‰§è¡Œå®Œæ¯• ---');
        }

        // æ˜¾ç¤ºä¸ªäººä¸»é¡µ
        async function showForumProfile() {
            // åˆ‡æ¢åˆ°ä¸ªäººä¸»é¡µè§†å›¾
            showApp('forum-profile-screen');
            hideApp('forum-view-screen');

            // é»˜è®¤æ˜¾ç¤º"æˆ‘çš„å¸–å­"
            switchProfileTab('my-posts');

            // --- å¼‚æ­¥åŠ è½½ä¸¤ä¸ªåˆ†åŒºçš„æ•°æ® ---

            // 1. åŠ è½½å¹¶æ¸²æŸ“"æˆ‘çš„å¸–å­"
            const myPostsList = document.getElementById('my-posts-list');
            // ä½¿ç”¨filteræ–¹æ³•æ¥å®‰å…¨åœ°æŸ¥è¯¢ç”¨æˆ·å¸–å­
            const allPosts = await db.forumPosts.toArray();
            const userPosts = allPosts.filter(post => post.isUserPost === true).sort((a, b) => b.timestamp - a.timestamp);
            if (userPosts.length === 0) {
                myPostsList.innerHTML = `<div class="forum-empty-state"><p>ä½ è¿˜æ²¡æœ‰å‘è¿‡å¸–å­</p></div>`;
            } else {
                const userPostsHtml = await Promise.all(userPosts.map(async post => {
                    // æ£€æŸ¥å¸–å­æ˜¯å¦æœ‰å›¾ç‰‡
                    const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;

                    return `
                        <div class="post-item" onclick="showPostView(${post.id})">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                <span class="user-post-badge">æˆ‘</span>
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    `;
                }));
                myPostsList.innerHTML = userPostsHtml.join('');
            }

            // 2. åŠ è½½å¹¶æ¸²æŸ“"æˆ‘çš„æ”¶è—"
            const favListContainer = document.getElementById('favorite-posts-list');
            const favoriteRecords = await db.forumFavorites.where('userId').equals('user').toArray();
            const postIds = favoriteRecords.map(fav => fav.postId);

            if (postIds.length === 0) {
                favListContainer.innerHTML = `<div class="forum-empty-state"><p>ä½ è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å¸–å­</p></div>`;
            } else {
                const favoritePosts = await db.forumPosts.where('id').anyOf(postIds).toArray();
                const favoritePostsHtml = await Promise.all(favoritePosts.sort((a,b) => b.timestamp - a.timestamp).map(async post => {
                    // æ£€æŸ¥å¸–å­æ˜¯å¦æœ‰å›¾ç‰‡
                    const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;

                    return `
                        <div class="post-item" onclick="showPostView(${post.id})">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                ${post.isUserPost ? '<span class="user-post-badge">æˆ‘</span>' : ''}
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    `;
                }));
                favListContainer.innerHTML = favoritePostsHtml.join('');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä»ä¸ªäººä¸»é¡µè¿”å›å½“å‰è®ºå›ç¤¾åŒº
        async function backToCurrentForum() {
            if (!currentForumId) {
                // å¦‚æœæ²¡æœ‰å½“å‰è®ºå›IDï¼Œè¿”å›è®ºå›ä¸»é¡µ
                hideApp('forum-profile-screen');
                await renderForumArchives();
                showApp('forum-screen');
                return;
            }

            // è¿”å›å½“å‰è®ºå›ç¤¾åŒºé¡µé¢
            const forum = await db.forums.get(parseInt(currentForumId));
            if (forum) {
                document.getElementById('forum-view-title').innerText = forum.name;
                await renderForumPosts(currentForumId);
                showApp('forum-view-screen');
                hideApp('forum-profile-screen');
            } else {
                // è®ºå›ä¸å­˜åœ¨ï¼Œè¿”å›è®ºå›ä¸»é¡µ
                hideApp('forum-profile-screen');
                await renderForumArchives();
                showApp('forum-screen');
            }
        }

        // åˆå§‹åŒ–è®ºå›åº”ç”¨
        function initializeForumApp() {
            // ç»‘å®šè®ºå›åº”ç”¨å›¾æ ‡ç‚¹å‡»äº‹ä»¶
            const forumAppIcon = document.querySelector('.mini-app[onclick*="forum-screen"]');
            if (forumAppIcon) {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ç§»é™¤onclickå±æ€§ï¼Œä¿æŒå›¾æ ‡é€‰æ‹©å™¨çš„å…¼å®¹æ€§
                // è€Œæ˜¯æ·»åŠ é¢å¤–çš„äº‹ä»¶ç›‘å¬å™¨æ¥å¢å¼ºåŠŸèƒ½
                forumAppIcon.addEventListener('click', async (e) => {
                    // é˜»æ­¢åŸæœ‰çš„onclickäº‹ä»¶
                    e.preventDefault();
                    e.stopPropagation();
                    await renderForumArchives();
                    showApp('forum-screen');
                });
            }
            console.log('âœ… è®ºå›åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

    </script>

    <!-- ğŸ”¥ã€æ–°å¢ã€‘ç¾¤æˆå‘˜å¤´åƒæ›´æ¢æ¨¡æ€æ¡† -->
    <div class="modal" id="member-avatar-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ›´æ¢æˆå‘˜å¤´åƒ</h3>
                <button class="modal-close" onclick="hideMemberAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-avatar-form">
                    <div class="current-member-info">
                        <h4 id="member-avatar-name" class="member-name-title">è§’è‰²åç§°</h4>
                        <p class="member-info-desc">ä¸ºè¯¥è§’è‰²è®¾ç½®æ–°çš„å¤´åƒï¼Œå°†åœ¨ç¾¤èŠä¸­ç«‹å³ç”Ÿæ•ˆ</p>
                    </div>

                    <div class="avatar-upload-section">
                        <div class="avatar-preview-large">
                            <img id="member-avatar-preview" src="" alt="å¤´åƒé¢„è§ˆ" class="preview-image">
                        </div>

                        <div class="upload-buttons">
                            <button class="upload-btn primary" onclick="handleMemberAvatarUpload()">
                                <i class="fas fa-upload"></i>
                                é€‰æ‹©æ–°å¤´åƒ
                            </button>
                            <button class="upload-btn secondary" onclick="resetMemberAvatar()">
                                <i class="fas fa-undo"></i>
                                é‡ç½®é»˜è®¤
                            </button>
                        </div>

                        <input type="file" id="member-avatar-upload" accept="image/*" style="display: none;">
                    </div>

                    <div class="avatar-tips">
                        <div class="tips-header">
                            <i class="fas fa-info-circle"></i>
                            <span>å¤´åƒæ›´æ¢è¯´æ˜</span>
                        </div>
                        <div class="tips-content">
                            â€¢ æ”¯æŒJPGã€PNGç­‰å¸¸è§å›¾ç‰‡æ ¼å¼<br>
                            â€¢ å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡ï¼Œæ•ˆæœæ›´ä½³<br>
                            â€¢ å¤´åƒæ›´æ¢åå°†åœ¨ç¾¤èŠä¸­ç«‹å³æ˜¾ç¤º<br>
                            â€¢ è§’è‰²ä¹Ÿå¯ä»¥åœ¨èŠå¤©æ—¶è‡ªä¸»æ›´æ¢å¤´åƒ
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-secondary" onclick="hideMemberAvatarModal()">å–æ¶ˆ</button>
                <button class="modal-button modal-primary" onclick="saveMemberAvatar()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ç¾¤å…¬å‘Šç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="group-notice-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ç¾¤å…¬å‘Š</h3>
                <button class="modal-close" onclick="hideGroupNoticeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-notice-form">
                    <div class="form-group">
                        <label class="form-label">ç¾¤å…¬å‘Šå†…å®¹</label>
                        <textarea
                            id="group-notice-content"
                            class="form-textarea group-notice-textarea"
                            placeholder="è¾“å…¥ç¾¤å…¬å‘Šå†…å®¹...&#10;&#10;å¯ä»¥åŒ…æ‹¬ï¼š&#10;â€¢ ç¾¤è§„åˆ™è¯´æ˜&#10;â€¢ é‡è¦é€šçŸ¥&#10;â€¢ æ´»åŠ¨å®‰æ’&#10;â€¢ å…¶ä»–äº‹é¡¹"
                            maxlength="500"></textarea>
                        <div class="notice-char-count">
                            <span id="notice-char-current">0</span>/500å­—
                        </div>
                    </div>
                    <div class="notice-tips">
                        <div class="tips-header">
                            <i class="fas fa-lightbulb"></i>
                            <span>å…¬å‘Šå°è´´å£«</span>
                        </div>
                        <div class="tips-content">
                            â€¢ ç®€æ´æ˜äº†ï¼Œçªå‡ºé‡ç‚¹<br>
                            â€¢ ä½¿ç”¨å‹å¥½çš„è¯­è°ƒ<br>
                            â€¢ å®šæœŸæ›´æ–°é‡è¦ä¿¡æ¯<br>
                            â€¢ å¯ä»¥ä½¿ç”¨emojiå¢åŠ è¶£å‘³æ€§
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideGroupNoticeModal()">å–æ¶ˆ</button>
                <button class="modal-primary" onclick="saveGroupNotice()">ä¿å­˜å…¬å‘Š</button>
            </div>
        </div>
    </div>

    <!-- å®šæ—¶å‘å¸ƒæ—¶é—´è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="schedule-times-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å®šæ—¶å‘å¸ƒæ—¶é—´è®¾ç½®</h3>
                <button class="modal-close" onclick="hideModal('schedule-times-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    è®¾ç½®è§’è‰²æ¯å¤©è‡ªåŠ¨å‘å¸ƒåŠ¨æ€çš„æ—¶é—´ç‚¹ï¼ˆæœ€å¤š10ä¸ªï¼‰
                </p>
                <div id="schedule-times-modal-container">
                    <!-- æ—¶é—´è¾“å…¥é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button onclick="addScheduleTime()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    + æ·»åŠ æ—¶é—´ç‚¹
                </button>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideModal('schedule-times-modal')">å–æ¶ˆ</button>
                <button class="modal-primary" onclick="saveScheduleTimes()">ä¿å­˜</button>
            </div>
        </div>
    </div>



    <!-- æ¸¸æˆé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="game-menu-modal" class="modal" style="display: none;">
        <div class="modal-content game-modal-content">
            <div class="modal-header game-modal-header">
                <div class="game-modal-title">
                    <i class="fas fa-gamepad"></i>
                    <span>é€‰æ‹©æ¸¸æˆ</span>
                </div>
                <button class="modal-close game-modal-close" onclick="hideGameMenu()">Ã—</button>
            </div>
            <div class="modal-body game-modal-body">
                <div class="game-buttons-container" id="game-buttons-container">
                    <!-- æ¸¸æˆæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ä½ç½®åˆ†äº«æ¨¡æ€æ¡† -->
    <div id="chat-location-modal" class="modal" style="display: none;">
        <div class="modal-content location-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ†äº«ä½ç½®</h3>
                <button class="modal-close" onclick="hideChatLocationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="location-input-section">
                    <label for="location-address">ä½ç½®åç§°</label>
                    <input type="text" id="location-address" placeholder="è¯·è¾“å…¥ä½ç½®åç§°ï¼Œå¦‚ï¼šå’–å•¡å…ã€å­¦æ ¡ã€å®¶..." maxlength="50">

                    <!-- æœ€è¿‘ä½¿ç”¨å†å²è®°å½• -->
                    <div class="location-history" id="location-history">
                        <div class="location-history-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                            </svg>
                            æœ€è¿‘ä½¿ç”¨
                        </div>
                        <div class="location-history-items" id="location-history-items">
                            <div class="location-history-empty">æš‚æ— å†å²è®°å½•</div>
                        </div>
                    </div>
                </div>
                <div class="virtual-map-container">
                    <div class="map-header" style="background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);">
                        <div class="map-location-name" id="map-location-display" style="color: #52c41a;">è¯·è¾“å…¥ä½ç½®åç§°</div>
                        <div class="map-coordinates" style="color: #73d13d;">116.4074Â°E, 39.9042Â°N</div>
                    </div>
                    <div class="virtual-map">
                        <div class="map-background"></div>
                        <!-- å¼¯æ›²æ²³æµ -->
                        <div class="river" style="top: 8%; left: 55%; width: 25px; height: 4px; transform: rotate(30deg);"></div>
                        <div class="river-curve" style="top: 18%; left: 68%; width: 22px; height: 4px; transform: rotate(10deg);"></div>
                        <div class="river" style="top: 26%; left: 78%; width: 20px; height: 4px; transform: rotate(-10deg);"></div>
                        <div class="river-curve" style="top: 32%; left: 85%; width: 18px; height: 4px; transform: rotate(-30deg);"></div>
                        <div class="river" style="top: 60%; left: 5%; width: 28px; height: 4px; transform: rotate(-15deg);"></div>
                        <div class="river-curve" style="top: 68%; left: 25%; width: 25px; height: 4px; transform: rotate(5deg);"></div>
                        <div class="river" style="top: 75%; left: 42%; width: 22px; height: 4px; transform: rotate(20deg);"></div>
                        <!-- å…¬å›­ç»¿åœ° -->
                        <div style="position: absolute; top: 25%; left: 65%; width: 25px; height: 20px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <div style="position: absolute; top: 50%; left: 15%; width: 30px; height: 25px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <!-- é“è·¯ -->
                        <div class="map-roads">
                            <div class="road road-horizontal" style="top: 30%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 25%; top: 0; height: 100%;"></div>
                            <div class="road road-horizontal" style="top: 70%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 75%; top: 0; height: 100%;"></div>
                        </div>
                        <!-- å»ºç­‘ç‰© -->
                        <div class="map-buildings">
                            <div class="building" style="top: 10%; left: 35%; width: 20px; height: 15px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 15%; left: 55%; width: 25px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 40%; left: 10%; width: 18px; height: 12px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 45%; left: 85%; width: 22px; height: 18px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 75%; left: 40%; width: 30px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 80%; left: 15%; width: 20px; height: 15px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                        </div>
                        <!-- æ ‘æœ¨ -->
                        <div style="position: absolute; top: 35%; left: 20%; width: 8px; height: 8px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 60%; left: 30%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 12%; left: 70%; width: 7px; height: 7px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 85%; left: 90%; width: 5px; height: 5px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 50%; left: 90%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <!-- ä½ç½®æ ‡è®° -->
                        <div class="map-marker" id="location-marker">
                            <div class="marker-pin">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#1890ff"/>
                                </svg>
                            </div>
                        </div>
                        <div class="map-current-location">
                            <div class="current-location-dot"></div>
                        </div>
                    </div>
                    <div class="map-footer">
                        <div class="map-scale">500m</div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="randomizeMapPosition()">ğŸ¯ é‡æ–°å®šä½</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideChatLocationModal()">å–æ¶ˆ</button>
                <button class="modal-primary" onclick="sendLocationMessage()">å‘é€ä½ç½®</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤æˆå‘˜å¤´åƒä¸Šä¼ äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const memberAvatarUpload = document.getElementById('member-avatar-upload');
            if (memberAvatarUpload) {
                memberAvatarUpload.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('member-avatar-preview');
                            if (preview) {
                                preview.src = event.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>

    <!-- ğŸ”¥ã€æ°¸ä¹…ä¿®å¤ã€‘èº«ä»½é€‰æ‹©åŠŸèƒ½è‡ªåŠ¨ä¿®å¤è„šæœ¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ å¼€å§‹åº”ç”¨èº«ä»½é€‰æ‹©åŠŸèƒ½æ°¸ä¹…ä¿®å¤...');

            // ä¿®å¤1: é‡å†™showPersonaSelectionForSingleChatå‡½æ•°
            if (typeof showPersonaSelectionForSingleChat === 'function') {
                const originalShowPersonaSelectionForSingleChat = showPersonaSelectionForSingleChat;
                showPersonaSelectionForSingleChat = function() {
                    originalShowPersonaSelectionForSingleChat();

                    // å»¶è¿Ÿä¿®å¤äº‹ä»¶ç»‘å®šï¼Œç¡®ä¿DOMå·²ç”Ÿæˆ
                    setTimeout(() => {
                        const items = document.querySelectorAll('#persona-selection-modal .persona-selection-item');
                        console.log('ğŸ”§ ä¿®å¤èº«ä»½é€‰æ‹©äº‹ä»¶ç»‘å®šï¼Œæ‰¾åˆ°å…ƒç´ :', items.length);

                        items.forEach(item => {
                            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                            item.onclick = null;

                            // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶
                            item.addEventListener('click', function() {
                                console.log('èº«ä»½é€‰æ‹©ç‚¹å‡»:', this.dataset.personaId);

                                // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                                document.querySelectorAll('#persona-selection-modal .persona-selection-item').forEach(i => {
                                    i.classList.remove('selected');
                                });

                                // è®¾ç½®å½“å‰å…ƒç´ ä¸ºé€‰ä¸­
                                this.classList.add('selected');

                                // ä¿å­˜èº«ä»½ID
                                window.selectedPersonaForChat = this.dataset.personaId;
                                console.log('è®¾ç½®selectedPersonaForChat:', window.selectedPersonaForChat);

                                // å¯ç”¨ç¡®è®¤æŒ‰é’®
                                const confirmBtn = document.getElementById('confirm-persona-btn');
                                if (confirmBtn) {
                                    confirmBtn.disabled = false;
                                }
                            });
                        });
                    }, 100);
                };
            }

            // ä¿®å¤2: é‡å†™confirmPersonaAndShowCharacterså‡½æ•°
            if (typeof confirmPersonaAndShowCharacters === 'function') {
                confirmPersonaAndShowCharacters = function() {
                    console.log('confirmPersonaAndShowCharactersè°ƒç”¨ï¼Œèº«ä»½ID:', window.selectedPersonaForChat);

                    if (!window.selectedPersonaForChat) {
                        console.error('èº«ä»½IDä¸ºç©ºï¼');
                        return;
                    }

                    // ä¿å­˜èº«ä»½ID
                    const savedPersonaId = window.selectedPersonaForChat;

                    // éšè—æ¨¡æ€æ¡†
                    const modal = document.getElementById('persona-selection-modal');
                    if (modal) {
                        modal.remove();
                    }

                    // æ¢å¤èº«ä»½ID
                    window.selectedPersonaForChat = savedPersonaId;
                    console.log('ä¿æŠ¤åçš„èº«ä»½ID:', window.selectedPersonaForChat);

                    showCharacterSelectionForSingleChat();
                };
            }

            // ä¿®å¤3: é‡å†™buildCharacterPromptå‡½æ•°
            if (typeof buildCharacterPrompt === 'function') {
                const originalBuildCharacterPrompt = buildCharacterPrompt;
                buildCharacterPrompt = async function(character, hasImage = false) {
                    // è°ƒç”¨åŸå‡½æ•°è·å–åŸºç¡€prompt
                    let characterPrompt = await originalBuildCharacterPrompt(character, hasImage);

                    // ç§»é™¤åŸæœ‰çš„currentPersonaé€»è¾‘ï¼Œæ›¿æ¢ä¸ºä»èŠå¤©è®¾ç½®è¯»å–
                    const chatSettings = getCurrentChatSettings();
                    if (chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona) {
                            console.log('ğŸ”§ ä¸ºè§’è‰²', character.name, 'ä½¿ç”¨èº«ä»½:', selectedPersona.name);

                            // ç§»é™¤æ—§çš„èº«ä»½ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                            const personaRegex = /\n\n# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š[\s\S]*?è¯·æ ¹æ®ç”¨æˆ·çš„è¿™ä¸ªé¢å…·èº«ä»½æ¥è¿›è¡Œå¯¹è¯ã€‚/;
                            characterPrompt = characterPrompt.replace(personaRegex, '');

                            // æ·»åŠ æ–°çš„èº«ä»½ä¿¡æ¯
                            const personaInfo = `\n\n# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š\nç”¨æˆ·å½“å‰ä½¿ç”¨çš„é¢å…·æ˜¯"${selectedPersona.name}"${selectedPersona.description ? `ï¼š${selectedPersona.description}` : ''}\nè¯·æ ¹æ®ç”¨æˆ·çš„è¿™ä¸ªé¢å…·èº«ä»½æ¥è¿›è¡Œå¯¹è¯ã€‚`;

                            // åœ¨è§’è‰²è®¾å®šåæ’å…¥èº«ä»½ä¿¡æ¯
                            const insertPoint = characterPrompt.indexOf('\n# ğŸ”¥ã€ä¿®å¤ã€‘è¡¨æƒ…åŒ…åº“ä¿¡æ¯');
                            if (insertPoint !== -1) {
                                characterPrompt = characterPrompt.slice(0, insertPoint) + personaInfo + characterPrompt.slice(insertPoint);
                            } else {
                                characterPrompt += personaInfo;
                            }
                        }
                    }

                    return characterPrompt;
                };
            }

            console.log('âœ… èº«ä»½é€‰æ‹©åŠŸèƒ½æ°¸ä¹…ä¿®å¤å·²åº”ç”¨');
        });
    </script>

    <!-- ğŸ”§ã€ç®€å•ä¿®å¤ã€‘ç¾¤èŠèº«ä»½è®¾ç½®ç›´æ¥ä¿®å¤ -->
    <script>
        // ç®€å•ç›´æ¥çš„ç¾¤èŠèº«ä»½ä¿®å¤
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ [ç®€å•ä¿®å¤] ç¾¤èŠèº«ä»½è®¾ç½®ä¿®å¤å¯åŠ¨...');

            // é‡å†™createGroupChatå‡½æ•°ï¼Œç¡®ä¿èº«ä»½è®¾ç½®ç«‹å³ç”Ÿæ•ˆ
            if (typeof window.createGroupChat === 'function') {
                const originalCreateGroupChat = window.createGroupChat;
                window.createGroupChat = async function(personaId) {
                    console.log('ğŸ”§ [ä¿®å¤] createGroupChatè¢«è°ƒç”¨ï¼Œèº«ä»½ID:', personaId);

                    // è°ƒç”¨åŸå‡½æ•°ï¼Œä¼ é€’personaIdå‚æ•°
                    await originalCreateGroupChat.call(this, personaId);

                    // å¦‚æœæœ‰é€‰æ‹©èº«ä»½ï¼Œç«‹å³åŠ è½½åˆ°å†…å­˜
                    if (personaId && groupChats && groupChats.length > 0) {
                        const latestGroup = groupChats[groupChats.length - 1];
                        const savedSettings = localStorage.getItem(`chatSettings_${latestGroup.id}`);

                        if (savedSettings) {
                            try {
                                const settings = JSON.parse(savedSettings);
                                window.chatSettings[latestGroup.id] = settings;
                                console.log('ğŸ”§ [ä¿®å¤] ç¾¤èŠèº«ä»½è®¾ç½®å·²åŠ è½½åˆ°å†…å­˜:', settings);
                            } catch (error) {
                                console.error('ğŸ”§ [ä¿®å¤] è§£æç¾¤èŠè®¾ç½®å¤±è´¥:', error);
                            }
                        }
                    }
                };
            }

            console.log('ğŸ”§ [ç®€å•ä¿®å¤] ç¾¤èŠèº«ä»½è®¾ç½®ä¿®å¤å®Œæˆ');
        });
    </script>

    <!-- ğŸ“±ã€ç§»åŠ¨ç«¯ä¼˜åŒ–ã€‘è¾“å…¥æ¡†viewportè¡Œä¸ºä¿®å¤ -->
    <script>
        // ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ–
        (function() {
            'use strict';

            console.log('ğŸ“± [ç§»åŠ¨ç«¯ä¼˜åŒ–] è¾“å…¥æ¡†viewportè¡Œä¸ºä¿®å¤å¯åŠ¨...');

            let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            let isAndroid = /Android/.test(navigator.userAgent);
            let isMobile = isIOS || isAndroid;

            if (!isMobile) {
                console.log('ğŸ“± éç§»åŠ¨ç«¯è®¾å¤‡ï¼Œè·³è¿‡ç§»åŠ¨ç«¯ä¼˜åŒ–');
                return;
            }

            // è·å–æ‰€æœ‰å¯èƒ½çš„è¾“å…¥æ¡†
            function getAllInputs() {
                return document.querySelectorAll('textarea, input[type="text"], input[type="password"], input[type="email"], input[type="number"]');
            }

            // é˜²æ­¢iOS Safariè‡ªåŠ¨ç¼©æ”¾
            function preventZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content',
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no'
                    );
                }
            }

            // æ¢å¤ç¼©æ”¾åŠŸèƒ½
            function restoreZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content',
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=3.0, user-scalable=yes'
                    );
                }
            }

            // è¾“å…¥æ¡†ç„¦ç‚¹å¤„ç†
            function handleInputFocus(e) {
                console.log('ğŸ“± è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹ï¼Œé˜²æ­¢è‡ªåŠ¨ç¼©æ”¾');

                // é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾
                if (isIOS) {
                    preventZoom();
                }

                // ç¡®ä¿è¾“å…¥æ¡†å¯è§
                setTimeout(() => {
                    e.target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300);
            }

            // è¾“å…¥æ¡†å¤±ç„¦å¤„ç†
            function handleInputBlur(e) {
                console.log('ğŸ“± è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œæ¢å¤ç¼©æ”¾åŠŸèƒ½');

                // æ¢å¤ç¼©æ”¾åŠŸèƒ½
                if (isIOS) {
                    setTimeout(() => {
                        restoreZoom();
                    }, 100);
                }

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€ï¼Œé˜²æ­¢é¡µé¢åç§»
                setTimeout(() => {
                    // é‡ç½®æ»šåŠ¨ä½ç½®
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;

                    // å¼ºåˆ¶é‡æ–°è®¡ç®—è™šæ‹Ÿæ‰‹æœºçš„ä½ç½®
                    const phoneScreen = document.getElementById('phone-screen');
                    if (phoneScreen) {
                        // ä¸´æ—¶æ”¹å˜ä¸€ä¸ªæ ·å¼å±æ€§æ¥è§¦å‘é‡æ–°æ¸²æŸ“
                        phoneScreen.style.transform = 'translateZ(0)';
                        setTimeout(() => {
                            phoneScreen.style.transform = '';
                        }, 10);
                    }

                    // ç¡®ä¿bodyå±…ä¸­å¯¹é½
                    document.body.style.display = 'flex';
                    document.body.style.justifyContent = 'center';
                    document.body.style.alignItems = 'center';
                }, 300);
            }

            // ç»‘å®šäº‹ä»¶åˆ°æ‰€æœ‰è¾“å…¥æ¡†
            function bindInputEvents() {
                const inputs = getAllInputs();
                console.log(`ğŸ“± æ‰¾åˆ° ${inputs.length} ä¸ªè¾“å…¥æ¡†ï¼Œæ­£åœ¨ç»‘å®šäº‹ä»¶...`);

                inputs.forEach(input => {
                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    input.removeEventListener('focus', handleInputFocus);
                    input.removeEventListener('blur', handleInputBlur);

                    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                    input.addEventListener('focus', handleInputFocus, { passive: true });
                    input.addEventListener('blur', handleInputBlur, { passive: true });

                    // ç¡®ä¿è¾“å…¥æ¡†å­—ä½“å¤§å°è‡³å°‘16pxï¼ˆé˜²æ­¢iOSç¼©æ”¾ï¼‰
                    const computedStyle = window.getComputedStyle(input);
                    const fontSize = parseInt(computedStyle.fontSize);
                    if (fontSize < 16) {
                        input.style.fontSize = '16px';
                        console.log('ğŸ“± è°ƒæ•´è¾“å…¥æ¡†å­—ä½“å¤§å°ä¸º16pxï¼Œé˜²æ­¢iOSç¼©æ”¾');
                    }
                });
            }

            // ç›‘å¬DOMå˜åŒ–ï¼Œå¤„ç†åŠ¨æ€æ·»åŠ çš„è¾“å…¥æ¡†
            const observer = new MutationObserver(function(mutations) {
                let shouldRebind = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.matches && (node.matches('textarea') || node.matches('input'))) {
                                    shouldRebind = true;
                                } else if (node.querySelector) {
                                    const inputs = node.querySelectorAll('textarea, input');
                                    if (inputs.length > 0) {
                                        shouldRebind = true;
                                    }
                                }
                            }
                        });
                    }
                });

                if (shouldRebind) {
                    console.log('ğŸ“± æ£€æµ‹åˆ°æ–°çš„è¾“å…¥æ¡†ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶...');
                    setTimeout(bindInputEvents, 100);
                }
            });

            // å¼€å§‹ç›‘å¬DOMå˜åŒ–
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bindInputEvents);
            } else {
                bindInputEvents();
            }

            // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°ç»‘å®šï¼ˆå¤„ç†ä»åå°è¿”å›çš„æƒ…å†µï¼‰
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(bindInputEvents, 100);
                }
            });

            // ğŸ”¥ã€æ–°å¢ã€‘ç›‘å¬viewportå˜åŒ–ï¼Œä¿®å¤è™šæ‹Ÿé”®ç›˜æ”¶èµ·åçš„å¸ƒå±€é—®é¢˜
            let initialViewportHeight = window.innerHeight;
            let isKeyboardOpen = false;

            function handleViewportChange() {
                const currentHeight = window.innerHeight;
                const heightDiff = initialViewportHeight - currentHeight;

                // åˆ¤æ–­è™šæ‹Ÿé”®ç›˜æ˜¯å¦æ‰“å¼€ï¼ˆé«˜åº¦å‡å°‘è¶…è¿‡150pxè®¤ä¸ºæ˜¯é”®ç›˜æ‰“å¼€ï¼‰
                const keyboardWasOpen = isKeyboardOpen;
                isKeyboardOpen = heightDiff > 150;

                console.log(`ğŸ“± Viewportå˜åŒ–: ${currentHeight}px (åˆå§‹: ${initialViewportHeight}px, å·®å€¼: ${heightDiff}px, é”®ç›˜çŠ¶æ€: ${isKeyboardOpen})`);

                // å¦‚æœé”®ç›˜ä»æ‰“å¼€å˜ä¸ºå…³é—­ï¼Œå¼ºåˆ¶ä¿®å¤å¸ƒå±€
                if (keyboardWasOpen && !isKeyboardOpen) {
                    console.log('ğŸ“± æ£€æµ‹åˆ°è™šæ‹Ÿé”®ç›˜å…³é—­ï¼Œä¿®å¤å¸ƒå±€...');
                    setTimeout(() => {
                        // é‡ç½®æ‰€æœ‰æ»šåŠ¨ä½ç½®
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;

                        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“è™šæ‹Ÿæ‰‹æœº
                        const phoneScreen = document.getElementById('phone-screen');
                        if (phoneScreen) {
                            phoneScreen.style.transform = 'translateZ(0)';
                            requestAnimationFrame(() => {
                                phoneScreen.style.transform = '';
                            });
                        }

                        // ç¡®ä¿bodyå¸ƒå±€æ­£ç¡®
                        document.body.style.height = '100%';
                        document.body.style.display = 'flex';
                        document.body.style.justifyContent = 'center';
                        document.body.style.alignItems = 'center';
                    }, 100);
                }
            }

            // ç›‘å¬viewportå˜åŒ–
            window.addEventListener('resize', handleViewportChange, { passive: true });
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    initialViewportHeight = window.innerHeight;
                    handleViewportChange();
                }, 500);
            }, { passive: true });

            console.log('ğŸ“± [ç§»åŠ¨ç«¯ä¼˜åŒ–] è¾“å…¥æ¡†viewportè¡Œä¸ºä¿®å¤å·²å¯åŠ¨');
        })();
    </script>

    <!-- ğŸ’°ã€è½¬è´¦åŠŸèƒ½ä¼˜åŒ–ã€‘è®©AIæ ¹æ®äººè®¾è‡ªç„¶å›åº” -->
    <script>
        // è½¬è´¦åŠŸèƒ½ä¼˜åŒ– - ç§»é™¤è‡ªåŠ¨æ”¶æ¬¾ï¼Œè®©AIæ ¹æ®äººè®¾è‡ªç„¶å›åº”
        (function() {
            'use strict';

            console.log('ğŸ’° [è½¬è´¦ä¼˜åŒ–] ç§»é™¤è‡ªåŠ¨æ”¶æ¬¾é€»è¾‘ï¼Œè®©AIæ ¹æ®äººè®¾è‡ªç„¶å›åº”...');

            // ğŸ”¥ã€é‡è¦ä¿®æ”¹ã€‘ç§»é™¤è‡ªåŠ¨æ”¶æ¬¾é€»è¾‘ï¼Œè®©AIæ ¹æ®è§’è‰²äººè®¾è‡ªç„¶å†³å®š
            // è½¬è´¦çŠ¶æ€å˜åŒ–åº”è¯¥ç”±AIçš„è‡ªç„¶å›å¤è§¦å‘ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨å¤„ç†
            // AIä¼šæ ¹æ®è‡ªå·±çš„äººè®¾ï¼ˆæ¯”å¦‚é«˜å†·ã€æ¸©æŸ”ã€å‚²å¨‡ç­‰ï¼‰æ¥å†³å®šæ˜¯å¦æ”¶æ¬¾

            console.log('ğŸ’° [è½¬è´¦ä¼˜åŒ–] AIå°†æ ¹æ®è§’è‰²äººè®¾è‡ªç„¶å›åº”è½¬è´¦ï¼Œä¸å†è‡ªåŠ¨æ”¶æ¬¾');
        })();
    </script>

    <!-- ğŸš«ã€æ‹‰é»‘ç³»ç»Ÿã€‘æ¨¡æ€æ¡† -->
    <div id="blacklist-settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ‹‰é»‘ç®¡ç†</h3>
                <button class="modal-close" onclick="hideBlacklistSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-user-slash section-icon"></i>
                        <span class="section-title">å½“å‰çŠ¶æ€</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item" id="current-blacklist-status">
                            <div class="setting-left">
                                <div class="setting-label">æ‹‰é»‘çŠ¶æ€</div>
                                <div class="setting-desc" id="blacklist-status-desc">æ­£å¸¸èŠå¤©ä¸­</div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                        <span class="section-title danger-section-title">æ“ä½œ</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item" id="block-action-item" onclick="performBlockAction()">
                            <div class="setting-left">
                                <div class="setting-label" id="block-action-label">æ‹‰é»‘æ­¤è§’è‰²</div>
                                <div class="setting-desc" id="block-action-desc">é˜»æ­¢è¯¥è§’è‰²å‘ä½ å‘é€æ¶ˆæ¯</div>
                            </div>
                            <div class="setting-right">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideBlacklistSettings()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ğŸš«ã€å¥½å‹ç”³è¯·ã€‘æ¨¡æ€æ¡† -->
    <div id="friend-request-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å¥½å‹ç”³è¯·</h3>
                <button class="modal-close" onclick="hideFriendRequestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç”³è¯·ç†ç”±ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="friend-request-message" class="form-textarea" placeholder="è¯·è¾“å…¥ç”³è¯·ç†ç”±..." maxlength="200"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideFriendRequestModal()">å–æ¶ˆ</button>
                <button class="modal-primary" onclick="sendFriendRequestConfirm()">å‘é€ç”³è¯·</button>
            </div>
        </div>
    </div>

    <!-- ğŸ”¥ã€æ–°å¢ã€‘å¿ƒå£°æ¨¡æ€æ¡† -->
    <div id="inner-thoughts-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    ğŸ’­å¿ƒå£°
                </h3>
                <button class="modal-close" onclick="hideInnerThoughtsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="inner-thoughts-content" class="inner-thoughts-content">
                    <div class="inner-thoughts-loading">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨è¯»å–è§’è‰²çš„å†…å¿ƒæƒ³æ³•...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary inner-thoughts-refresh-btn" onclick="refreshInnerThoughts(selectedMessageId)">
                    <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆ
                </button>
                <button class="modal-secondary" onclick="hideInnerThoughtsModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ğŸš«ã€æ‹‰é»‘ç³»ç»Ÿã€‘JavaScriptæ ¸å¿ƒåŠŸèƒ½ -->
    <script>
        // æ‹‰é»‘ç³»ç»Ÿå…¨å±€å˜é‡ - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤å£°æ˜
        if (typeof blacklistData === 'undefined') {
            var blacklistData = [];
            var friendRequestsData = [];
            var characterStatusData = [];
        }

        // åŠ è½½æ‹‰é»‘ç³»ç»Ÿæ•°æ®
        async function loadBlacklistData() {
            try {
                blacklistData = await db.blacklist.orderBy('timestamp').reverse().toArray();
                console.log('æ‹‰é»‘æ•°æ®åŠ è½½å®Œæˆ:', blacklistData);
            } catch (error) {
                console.error('åŠ è½½æ‹‰é»‘æ•°æ®å¤±è´¥:', error);
                blacklistData = [];
            }
        }

        // æ£€æŸ¥æ˜¯å¦è¢«æ‹‰é»‘
        function isBlocked(blockerId, blockedId) {
            return blacklistData.some(record =>
                record.blockerId === blockerId &&
                record.blockedId === blockedId &&
                !record.unblocked
            );
        }



        // æ‹‰é»‘è§’è‰²
        async function blockCharacter(characterId, reason = '') {
            try {
                const now = new Date();

                if (isBlocked('user', characterId)) {
                    showToast('è¯¥è§’è‰²å·²è¢«æ‹‰é»‘', 'warning');
                    return;
                }

                const blockRecord = {
                    id: `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    blockerId: 'user',
                    blockedId: characterId,
                    timestamp: now.toISOString(),
                    reason: reason,
                    unblocked: false
                };

                blacklistData.unshift(blockRecord);
                await db.blacklist.add(blockRecord);

                const character = characters.find(c => c.id === characterId);
                showToast(`å·²æ‹‰é»‘ ${character?.name || 'è§’è‰²'}`, 'success');

                // ğŸ”¥ã€æ–°å¢ã€‘é€šçŸ¥è§’è‰²è¢«æ‹‰é»‘äº†
                await notifyCharacterBlocked(characterId, reason);

                // ç«‹å³æ›´æ–°èŠå¤©ç•Œé¢æ˜¾ç¤º
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    updateChatBlockedStatus();
                }

                renderContactList();
                renderMessageList();

            } catch (error) {
                console.error('æ‹‰é»‘è§’è‰²å¤±è´¥:', error);
                showToast('æ‹‰é»‘å¤±è´¥', 'error');
            }
        }

        // è§£é™¤æ‹‰é»‘
        async function unblockCharacter(characterId) {
            try {
                const blockRecord = blacklistData.find(r =>
                    r.blockerId === 'user' &&
                    r.blockedId === characterId &&
                    !r.unblocked
                );

                if (!blockRecord) {
                    showToast('è¯¥è§’è‰²æœªè¢«æ‹‰é»‘', 'warning');
                    return;
                }

                blockRecord.unblocked = true;
                blockRecord.unblockTimestamp = new Date().toISOString();

                await db.blacklist.put(blockRecord);

                const character = characters.find(c => c.id === characterId);
                showToast(`å·²è§£é™¤å¯¹ ${character?.name || 'è§’è‰²'} çš„æ‹‰é»‘`, 'success');

                // ğŸ”¥ã€æ–°å¢ã€‘é€šçŸ¥è§’è‰²è¢«è§£é™¤æ‹‰é»‘äº†
                await notifyCharacterUnblocked(characterId);

                // åˆ·æ–°èŠå¤©ç•Œé¢æ˜¾ç¤º
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    renderChatMessages(currentChatCharacter.id);
                    updateChatBlockedStatus();
                }

                renderContactList();
                renderMessageList();

            } catch (error) {
                console.error('è§£é™¤æ‹‰é»‘å¤±è´¥:', error);
                showToast('è§£é™¤æ‹‰é»‘å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°è§’è‰²çŠ¶æ€
        async function updateCharacterStatus(characterId, status, activity = '', location = '') {
            try {
                let statusRecord = characterStatusData.find(s => s.characterId === characterId);

                if (!statusRecord) {
                    statusRecord = {
                        id: `status_${characterId}`,
                        characterId: characterId,
                        status: status,
                        activity: activity,
                        location: location,
                        lastUpdate: new Date().toISOString(),
                        lastChatTime: null // ğŸ”¥ã€æ–°å¢ã€‘ä¿ç•™æœ€åèŠå¤©æ—¶é—´å­—æ®µ
                    };
                    characterStatusData.push(statusRecord);
                } else {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¿ç•™ç°æœ‰çš„lastChatTimeå­—æ®µ
                    const existingLastChatTime = statusRecord.lastChatTime;
                    statusRecord.status = status;
                    statusRecord.activity = activity;
                    statusRecord.location = location;
                    statusRecord.lastUpdate = new Date().toISOString();
                    statusRecord.lastChatTime = existingLastChatTime; // ä¿ç•™åŸæœ‰çš„èŠå¤©æ—¶é—´
                }

                await db.characterStatus.put(statusRecord);

            } catch (error) {
                console.error('æ›´æ–°è§’è‰²çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // è·å–è§’è‰²çŠ¶æ€
        function getCharacterStatus(characterId) {
            return characterStatusData.find(s => s.characterId === characterId) || {
                status: 'online',
                activity: 'åœ¨çº¿',
                location: '',
                lastUpdate: new Date().toISOString(),
                lastChatTime: null // ğŸ”¥ã€æ–°å¢ã€‘æœ€åèŠå¤©æ—¶é—´
            };
        }

        // è§’è‰²æ‹‰é»‘ç”¨æˆ·
        async function aiBlockUser(characterId, reason = '') {
            try {
                const now = new Date();

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ‹‰é»‘
                if (isBlocked(characterId, 'user')) {
                    return;
                }

                const blockRecord = {
                    id: `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    blockerId: characterId,
                    blockedId: 'user',
                    timestamp: now.toISOString(),
                    reason: reason,
                    unblocked: false
                };

                blacklistData.unshift(blockRecord);
                await db.blacklist.add(blockRecord);

                // æ›´æ–°èŠå¤©ç•Œé¢æ˜¾ç¤º
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    updateChatBlockedStatus();
                }

                const character = characters.find(c => c.id === characterId);
                showToast(`${character?.name || 'è§’è‰²'} å·²å°†ä½ æ‹‰é»‘`, 'warning');

            } catch (error) {
                console.error('è§’è‰²æ‹‰é»‘ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // å‘é€å¥½å‹ç”³è¯·
        async function sendFriendRequest(characterId, message = '') {
            try {
                const request = {
                    id: `request_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    fromId: 'user',
                    toId: characterId,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    type: 'friend',
                    message: message
                };

                friendRequestsData.unshift(request);
                await db.friendRequests.add(request);

                showToast('å¥½å‹ç”³è¯·å·²å‘é€', 'success');

            } catch (error) {
                console.error('å‘é€å¥½å‹ç”³è¯·å¤±è´¥:', error);
                showToast('å‘é€ç”³è¯·å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘æ›´æ–°èŠå¤©ç•Œé¢çš„æ‹‰é»‘çŠ¶æ€æ˜¾ç¤º - ç¾¤èŠä¸æ˜¾ç¤ºæ‹‰é»‘æç¤º
        function updateChatBlockedStatus() {
            if (!currentChatCharacter) return;

            const characterId = currentChatCharacter.id;
            const isGroupChat = currentChatCharacter.isGroup;

            // ç§»é™¤ç°æœ‰çš„æ‹‰é»‘æç¤º
            const existingBlockedUI = document.querySelector('.blocked-input-notice');
            if (existingBlockedUI) {
                existingBlockedUI.remove();
            }

            // ç§»é™¤ç°æœ‰çš„è§’è‰²è¢«æ‹‰é»‘æç¤º
            const existingCharacterHint = document.querySelector('.character-blocked-hint');
            if (existingCharacterHint) {
                existingCharacterHint.remove();
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸æ˜¾ç¤ºæ‹‰é»‘ç›¸å…³æç¤ºï¼Œåªæœ‰å•èŠæ‰å¤„ç†æ‹‰é»‘çŠ¶æ€
            if (!isGroupChat) {
                const isUserBlocked = isBlocked('user', characterId);
                const isCharacterBlocked = isBlocked(characterId, 'user');

                // å½“ç”¨æˆ·è¢«è§’è‰²æ‹‰é»‘æ—¶ï¼Œåœ¨è¾“å…¥æ¡†ä¸Šæ–¹æ˜¾ç¤ºæç¤º
                if (isCharacterBlocked) {
                    const inputArea = document.querySelector('.chat-input-area');
                    if (inputArea) {
                        const blockedNotice = document.createElement('div');
                        blockedNotice.className = 'blocked-input-notice show';

                        blockedNotice.innerHTML = `
                            <div class="notice-text">ä½ è¢« ${currentChatCharacter.name} æ‹‰é»‘äº†</div>
                            <button class="notice-button" onclick="showFriendRequestModal()">ç”³è¯·æ·»åŠ ä¸ºå¥½å‹</button>
                        `;

                        inputArea.appendChild(blockedNotice);
                    }

                    // ğŸ”¥ã€æ–°å¢ã€‘åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºè§’è‰²ç”³è¯·å¥½å‹çš„æç¤º
                    addCharacterBlockedHint(characterId);
                }

                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ä»¥æ˜¾ç¤ºæ‹‰é»‘çŠ¶æ€æŒ‡ç¤ºå™¨
                renderChatMessages(characterId);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºè§’è‰²è¢«æ‹‰é»‘çš„æç¤º
        function addCharacterBlockedHint(characterId) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;

            // ç§»é™¤ç°æœ‰çš„æç¤º
            const existingHint = messagesContainer.querySelector('.character-blocked-hint');
            if (existingHint) {
                existingHint.remove();
            }

            // åˆ›å»ºæç¤ºæ¶ˆæ¯
            const hintContainer = document.createElement('div');
            hintContainer.className = 'character-blocked-hint';
            hintContainer.style.cssText = `
                text-align: center;
                margin: 20px auto;
                padding: 15px 20px;
                background: rgba(255, 193, 7, 0.1);
                border: 1px solid rgba(255, 193, 7, 0.3);
                border-radius: 12px;
                max-width: 320px;
                color: #856404;
                font-size: 13px;
                line-height: 1.4;
            `;

            hintContainer.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">ğŸ’¡ æç¤º</div>
                <div>${currentChatCharacter.name} è¢«æ‹‰é»‘äº†ï¼Œä½†ä»å¯ä»¥å‘é€æ¶ˆæ¯ã€‚å¦‚æœæƒ³ä¿®å¤å…³ç³»ï¼Œå¯ä»¥å‘é€å¥½å‹ç”³è¯·ã€‚</div>
                <div style="margin-top: 8px; font-size: 12px; color: #6c757d;">
                    å¥½å‹ç”³è¯·æ ¼å¼ï¼š{"type": "friend_request", "message": "é“æ­‰æˆ–è¯·æ±‚ä¿¡æ¯"}
                </div>
            `;

            // å°†æç¤ºæ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨çš„é¡¶éƒ¨
            messagesContainer.insertBefore(hintContainer, messagesContainer.firstChild);
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ‹‰é»‘çŠ¶æ€å¹¶åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆåªåœ¨å‘é€æ¶ˆæ¯æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
        function checkAndCreateBlockedSystemMessage(userMessage, characterId) {
            if (!currentChatCharacter || currentChatCharacter.isGroup) return; // ç¾¤èŠä¸å¤„ç†æ‹‰é»‘

            // æ£€æŸ¥è§’è‰²æ˜¯å¦æ‹‰é»‘äº†ç”¨æˆ·
            const isCharacterBlocked = isBlocked(characterId, 'user');

            if (isCharacterBlocked) {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ä¿å­˜åˆ°èŠå¤©è®°å½•ï¼Œåªåœ¨ç•Œé¢ä¸Šä¸´æ—¶æ˜¾ç¤ºç³»ç»Ÿæç¤º
                // åˆ›å»ºä¸´æ—¶çš„ç³»ç»Ÿæç¤ºå…ƒç´ 
                const messagesContainer = document.getElementById('api-chat-messages');
                const systemHint = document.createElement('div');
                systemHint.className = 'blocked-message-hint';
                systemHint.style.cssText = `
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                    padding: 4px 8px;
                    margin: 2px 0;
                    background: transparent;
                    border: none;
                    display: block;
                    max-width: 80%;
                    width: fit-content;
                    margin-left: auto;
                    margin-right: auto;
                `;
                systemHint.textContent = 'æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†';

                // æ·»åŠ åˆ°ç•Œé¢
                messagesContainer.appendChild(systemHint);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†å·²ä¿å­˜çš„æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
        function cleanupBlockedSystemMessages() {
            let hasChanges = false;

            // éå†æ‰€æœ‰èŠå¤©è®°å½•
            Object.keys(chatMessages).forEach(characterId => {
                const messages = chatMessages[characterId];
                const originalLength = messages.length;

                // è¿‡æ»¤æ‰æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯
                chatMessages[characterId] = messages.filter(msg =>
                    !(msg.sender === 'system' && msg.isBlockedMessage)
                );

                if (chatMessages[characterId].length !== originalLength) {
                    hasChanges = true;
                    console.log(`ğŸ§¹ [æ¸…ç†] ä»è§’è‰² ${characterId} çš„èŠå¤©è®°å½•ä¸­ç§»é™¤äº† ${originalLength - chatMessages[characterId].length} æ¡æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯`);
                }
            });

            // å¦‚æœæœ‰å˜åŒ–ï¼Œä¿å­˜åˆ°æ•°æ®åº“
            if (hasChanges) {
                saveChatMessages();
                console.log('ğŸ§¹ [æ¸…ç†] æ‹‰é»‘ç³»ç»Ÿæ¶ˆæ¯æ¸…ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°æ•°æ®åº“');
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ¶ˆæ¯æ·»åŠ æ‹‰é»‘çŠ¶æ€æŒ‡ç¤ºå™¨ - æ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·å’Œç³»ç»Ÿæç¤º
        function addBlockedIndicatorToMessage(messageContainer, message, characterId) {
            if (!currentChatCharacter) return;

            // ğŸ”¥ã€æ–°å¢ã€‘è·³è¿‡å¥½å‹ç”³è¯·æ¶ˆæ¯ï¼Œä¸æ˜¾ç¤ºæ‹‰é»‘æŒ‡ç¤ºå™¨
            if (message.type === 'friend_request') {
                return; // å¥½å‹ç”³è¯·æ˜¯ä¿®å¤å…³ç³»çš„è¡Œä¸ºï¼Œä¸åº”è¯¥æ˜¾ç¤ºæ‹‰é»‘æ ‡å¿—
            }

            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨æ‹‰é»‘çŠ¶æ€ä¸‹å‘é€
            const messageTimestamp = message.timestamp;
            let shouldShowIndicator = false;
            let blockTimestamp = null;

            // ğŸ”¥ã€ä¿®å¤ã€‘æŸ¥æ‰¾ç›¸å…³çš„æ‹‰é»‘è®°å½• - å³ä½¿è§£é™¤æ‹‰é»‘åä¹Ÿè¦æ˜¾ç¤ºå†å²æ¶ˆæ¯çš„æŒ‡ç¤ºå™¨
            if (message.sender === 'sent') {
                // ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œæ£€æŸ¥è§’è‰²æ˜¯å¦æ›¾ç»æ‹‰é»‘äº†ç”¨æˆ·
                const blockRecord = blacklistData.find(r =>
                    r.blockerId === characterId &&
                    r.blockedId === 'user'
                    // ğŸ”¥ã€ç§»é™¤ã€‘ä¸å†æ£€æŸ¥ !r.unblockedï¼Œè®©å†å²æ¶ˆæ¯ä¿ç•™æŒ‡ç¤ºå™¨
                );
                if (blockRecord) {
                    blockTimestamp = new Date(blockRecord.timestamp).getTime();
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ¶ˆæ¯æ˜¯åœ¨æ‹‰é»‘æœŸé—´å‘é€çš„ï¼Œå°±æ˜¾ç¤ºæŒ‡ç¤ºå™¨
                    const unblockTimestamp = blockRecord.unblocked && blockRecord.unblockTimestamp
                        ? new Date(blockRecord.unblockTimestamp).getTime()
                        : Date.now();
                    shouldShowIndicator = messageTimestamp >= blockTimestamp &&
                                        (messageTimestamp <= unblockTimestamp || !blockRecord.unblocked);
                }
            } else if (message.sender === 'received') {
                // è§’è‰²å‘é€çš„æ¶ˆæ¯ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ›¾ç»æ‹‰é»‘äº†è§’è‰²
                const blockRecord = blacklistData.find(r =>
                    r.blockerId === 'user' &&
                    r.blockedId === characterId
                    // ğŸ”¥ã€ç§»é™¤ã€‘ä¸å†æ£€æŸ¥ !r.unblockedï¼Œè®©å†å²æ¶ˆæ¯ä¿ç•™æŒ‡ç¤ºå™¨
                );
                if (blockRecord) {
                    blockTimestamp = new Date(blockRecord.timestamp).getTime();
                    // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ¶ˆæ¯æ˜¯åœ¨æ‹‰é»‘æœŸé—´å‘é€çš„ï¼Œå°±æ˜¾ç¤ºæŒ‡ç¤ºå™¨
                    const unblockTimestamp = blockRecord.unblocked && blockRecord.unblockTimestamp
                        ? new Date(blockRecord.unblockTimestamp).getTime()
                        : Date.now();
                    shouldShowIndicator = messageTimestamp >= blockTimestamp &&
                                        (messageTimestamp <= unblockTimestamp || !blockRecord.unblocked);
                }
            }

            if (shouldShowIndicator) {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æŒ‡ç¤ºå™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const existingIndicator = messageContainer.querySelector('.message-blocked-indicator');
                const existingHint = messageContainer.nextElementSibling?.classList.contains('blocked-message-hint-inline');

                if (existingIndicator && existingHint) {
                    return; // å·²ç»æœ‰æŒ‡ç¤ºå™¨å’Œæç¤ºäº†ï¼Œä¸é‡å¤æ·»åŠ 
                }

                // åˆ›å»ºæ‹‰é»‘æŒ‡ç¤ºå™¨ï¼ˆçº¢è‰²æ„Ÿå¹å·ï¼‰
                if (!existingIndicator) {
                    const indicator = document.createElement('div');
                    indicator.className = 'message-blocked-indicator';
                    indicator.innerHTML = '!';
                    indicator.title = 'æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†';

                    // æ·»åŠ æŒ‡ç¤ºå™¨åˆ°æ¶ˆæ¯å®¹å™¨
                    messageContainer.style.position = 'relative';
                    messageContainer.appendChild(indicator);

                    // ğŸ”¥ã€æ–°å¢ã€‘åŠ¨æ€å®šä½æ„Ÿå¹å·åˆ°æ°”æ³¡å¤–ä¾§
                    setTimeout(() => {
                        const bubble = messageContainer.querySelector('.message-bubble');
                        if (bubble) {
                            // è·å–æ°”æ³¡ç›¸å¯¹äºæ¶ˆæ¯å®¹å™¨çš„ä½ç½®
                            const containerRect = messageContainer.getBoundingClientRect();
                            const bubbleRect = bubble.getBoundingClientRect();

                            if (message.sender === 'sent') {
                                // ç”¨æˆ·æ¶ˆæ¯ï¼šæ„Ÿå¹å·åœ¨æ°”æ³¡å·¦è¾¹
                                const bubbleLeftOffset = bubbleRect.left - containerRect.left;
                                indicator.style.left = (bubbleLeftOffset - 20) + 'px'; // 16pxæ„Ÿå¹å·å®½åº¦ + 4pxé—´è·
                                indicator.style.right = 'auto';
                            } else if (message.sender === 'received') {
                                // ğŸ”¥ã€ä¿®å¤ã€‘è§’è‰²æ¶ˆæ¯ï¼šæ„Ÿå¹å·åœ¨æ°”æ³¡å³ä¸‹è§’å¤–ä¾§3pxå¤„
                                const bubbleRightOffset = bubbleRect.right - containerRect.left;
                                indicator.style.left = (bubbleRightOffset + 3) + 'px'; // æ°”æ³¡å³è¾¹ + 3pxé—´è·
                                indicator.style.right = 'auto';
                            }
                        }
                    }, 10);
                }

                // ğŸ”¥ã€æ–°å¢ã€‘åœ¨æ¶ˆæ¯ä¸‹æ–¹æ·»åŠ ç³»ç»Ÿæç¤º
                if (!existingHint) {
                    const systemHint = document.createElement('div');
                    systemHint.className = 'blocked-message-hint-inline';
                    systemHint.style.cssText = `
                        text-align: center;
                        color: #999;
                        font-size: 12px;
                        padding: 2px 8px;
                        margin: 2px 0 8px 0;
                        background: transparent;
                        border: none;
                        display: block;
                        max-width: 80%;
                        width: fit-content;
                        margin-left: auto;
                        margin-right: auto;
                    `;
                    systemHint.textContent = 'æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†';

                    // åœ¨æ¶ˆæ¯å®¹å™¨åé¢æ’å…¥ç³»ç»Ÿæç¤º
                    messageContainer.parentNode.insertBefore(systemHint, messageContainer.nextSibling);
                }
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘æ˜¾ç¤ºæ‹‰é»‘/å±è”½è®¾ç½® - åŒºåˆ†å•èŠå’Œç¾¤èŠ
        function showBlacklistSettings() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'warning');
                return;
            }

            const characterId = currentChatCharacter.id;
            const isGroupChat = currentChatCharacter.isGroup;

            if (isGroupChat) {
                // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠåªèƒ½å±è”½ï¼Œä¸”åªæœ‰ç”¨æˆ·å¯ä»¥å±è”½ç¾¤èŠ
                showGroupMuteSettings(characterId);
            } else {
                // å•èŠä½¿ç”¨åŸæœ‰çš„æ‹‰é»‘é€»è¾‘
                const isUserBlocked = isBlocked('user', characterId);

                const statusDesc = document.getElementById('blacklist-status-desc');
                const actionLabel = document.getElementById('block-action-label');
                const actionDesc = document.getElementById('block-action-desc');

                if (isUserBlocked) {
                    statusDesc.textContent = 'ä½ å·²æ‹‰é»‘æ­¤è§’è‰²';
                    actionLabel.textContent = 'è§£é™¤æ‹‰é»‘';
                    actionDesc.textContent = 'æ¢å¤ä¸è¯¥è§’è‰²çš„æ­£å¸¸èŠå¤©';
                } else {
                    statusDesc.textContent = 'æ­£å¸¸èŠå¤©ä¸­';
                    actionLabel.textContent = 'æ‹‰é»‘æ­¤è§’è‰²';
                    actionDesc.textContent = 'é˜»æ­¢è¯¥è§’è‰²å‘ä½ å‘é€æ¶ˆæ¯';
                }

                document.getElementById('blacklist-settings-modal').style.display = 'flex';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°è®¾ç½®ç•Œé¢çš„æ‹‰é»‘/å±è”½ç®¡ç†æ–‡æ¡ˆ
        function updateBlockManageLabel(isGroupChat) {
            const labelElement = document.getElementById('block-manage-label');
            const descElement = document.getElementById('block-manage-desc');

            if (labelElement && descElement) {
                if (isGroupChat) {
                    labelElement.textContent = 'å±è”½ç®¡ç†';
                    descElement.textContent = 'å±è”½/å–æ¶ˆå±è”½ç¾¤èŠæ¶ˆæ¯é€šçŸ¥';
                } else {
                    labelElement.textContent = 'æ‹‰é»‘ç®¡ç†';
                    descElement.textContent = 'æ‹‰é»‘/è§£é™¤æ‹‰é»‘ç®¡ç†';
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºç¾¤èŠå±è”½è®¾ç½®
        function showGroupMuteSettings(groupId) {
            // æ£€æŸ¥æ˜¯å¦å·²å±è”½è¯¥ç¾¤èŠ
            const isMuted = isGroupMuted(groupId);

            const statusDesc = document.getElementById('blacklist-status-desc');
            const actionLabel = document.getElementById('block-action-label');
            const actionDesc = document.getElementById('block-action-desc');

            // ä¿®æ”¹ç•Œé¢æ–‡æ¡ˆä¸ºå±è”½ç›¸å…³
            if (isMuted) {
                statusDesc.textContent = 'ä½ å·²å±è”½æ­¤ç¾¤èŠ';
                actionLabel.textContent = 'å–æ¶ˆå±è”½';
                actionDesc.textContent = 'é‡æ–°æ¥æ”¶è¯¥ç¾¤èŠçš„æ¶ˆæ¯é€šçŸ¥';
            } else {
                statusDesc.textContent = 'æ­£å¸¸æ¥æ”¶ç¾¤èŠæ¶ˆæ¯';
                actionLabel.textContent = 'å±è”½æ­¤ç¾¤èŠ';
                actionDesc.textContent = 'ä¸å†æ¥æ”¶è¯¥ç¾¤èŠçš„æ¶ˆæ¯é€šçŸ¥';
            }

            document.getElementById('blacklist-settings-modal').style.display = 'flex';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥ç¾¤èŠæ˜¯å¦è¢«å±è”½
        function isGroupMuted(groupId) {
            const mutedGroups = JSON.parse(localStorage.getItem('mutedGroups') || '[]');
            return mutedGroups.includes(groupId);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å±è”½/å–æ¶ˆå±è”½ç¾¤èŠ
        function toggleGroupMute(groupId) {
            const mutedGroups = JSON.parse(localStorage.getItem('mutedGroups') || '[]');
            const isMuted = mutedGroups.includes(groupId);

            if (isMuted) {
                // å–æ¶ˆå±è”½
                const index = mutedGroups.indexOf(groupId);
                if (index > -1) {
                    mutedGroups.splice(index, 1);
                }
                showToast(`å·²å–æ¶ˆå±è”½ ${currentChatCharacter?.name}`, 'success');
            } else {
                // å±è”½ç¾¤èŠ
                mutedGroups.push(groupId);
                showToast(`å·²å±è”½ ${currentChatCharacter?.name}`, 'info');
            }

            localStorage.setItem('mutedGroups', JSON.stringify(mutedGroups));

            // æ›´æ–°ç•Œé¢
            renderContactList();
            hideBlacklistSettings();
        }

        // éšè—æ‹‰é»‘è®¾ç½®
        function hideBlacklistSettings() {
            document.getElementById('blacklist-settings-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºå¥½å‹ç”³è¯·æ¨¡æ€æ¡†
        function showFriendRequestModal() {
            if (!currentChatCharacter) return;

            document.getElementById('friend-request-message').value = '';
            document.getElementById('friend-request-modal').style.display = 'flex';
        }

        // éšè—å¥½å‹ç”³è¯·æ¨¡æ€æ¡†
        function hideFriendRequestModal() {
            document.getElementById('friend-request-modal').style.display = 'none';
        }

        // å‘é€å¥½å‹ç”³è¯·ç¡®è®¤
        async function sendFriendRequestConfirm() {
    if (!currentChatCharacter) return;

    const message = document.getElementById('friend-request-message').value.trim();
    const characterId = currentChatCharacter.id;

    // 1. å…ˆåœ¨æ•°æ®åº“ä¸­è®°å½•è¿™ä¸ªç”³è¯·äº‹ä»¶
    await sendFriendRequest(characterId, message);
    hideFriendRequestModal();

    // 2. ğŸ”¥ã€æ ¸å¿ƒæ–°å¢ã€‘ç«‹åˆ»è°ƒç”¨APIï¼Œè®©AIå¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
    showToast('ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹å›åº”...', 'info');
    await processAIFriendRequestResponse(characterId, message);
}

        // ğŸ”¥ã€æ–°å¢ã€‘è½»é‡çº§é˜²å´©åæ£€æŸ¥ - åªé˜²æ­¢çŸ­æ—¶é—´å†…çš„é‡å¤ç”³è¯·
        function isRecentFriendRequestSpam(characterId) {
            if (!characterId || !chatMessages[characterId]) {
                return false;
            }

            const messages = chatMessages[characterId];
            const now = Date.now();
            const recentThreshold = 5 * 60 * 1000; // 5åˆ†é’Ÿå†…

            // æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿå†…æ˜¯å¦æœ‰æœªå¤„ç†çš„å¥½å‹ç”³è¯·
            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                if (message.type === 'friend_request' && message.sender === 'received') {
                    const timeDiff = now - message.timestamp;

                    // å¦‚æœ5åˆ†é’Ÿå†…æœ‰æœªå¤„ç†çš„ç”³è¯·ï¼Œè®¤ä¸ºæ˜¯spam
                    if (timeDiff < recentThreshold && !message.friendRequestProcessed) {
                        console.log('ğŸš« [é˜²å´©å] æ£€æµ‹åˆ°5åˆ†é’Ÿå†…çš„é‡å¤å¥½å‹ç”³è¯·ï¼Œè·³è¿‡');
                        return true;
                    }

                    // åªæ£€æŸ¥æœ€è¿‘çš„ç”³è¯·ï¼Œä¸éœ€è¦éå†æ‰€æœ‰å†å²
                    break;
                }
            }

            return false;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIä¸»åŠ¨å‘é€çš„å¥½å‹ç”³è¯·
        async function handleAIFriendRequest(characterId, accepted, messageId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) return;

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œé¿å…è¢«é‡æ–°æ¸²æŸ“è¦†ç›–
                const friendRequestCard = document.querySelector(`[data-message-id="${messageId}"] .friend-request-card`);
                if (friendRequestCard) {
                    const actionsDiv = friendRequestCard.querySelector('.friend-request-actions');
                    if (actionsDiv) {
                        const resultText = accepted ? 'å·²åŒæ„' : 'å·²æ‹’ç»';
                        const resultClass = accepted ? 'accepted' : 'rejected';
                        actionsDiv.innerHTML = `<div class="friend-request-result ${resultClass}">${resultText}</div>`;
                    }
                }

                if (accepted) {
                    // ç”¨æˆ·åŒæ„äº†AIçš„å¥½å‹ç”³è¯·ï¼Œè§£é™¤æ‹‰é»‘
                    await unblockCharacter(characterId);

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å…ˆæ ‡è®°å¥½å‹ç”³è¯·æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œå†æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }
                    const messageIndex = chatMessages[characterId].findIndex(msg => msg.id === messageId);
                    if (messageIndex !== -1) {
                        chatMessages[characterId][messageIndex].friendRequestProcessed = true;
                        chatMessages[characterId][messageIndex].friendRequestAccepted = true;
                        console.log('âœ… æ ‡è®°å¥½å‹ç”³è¯·æ¶ˆæ¯ä¸ºå·²åŒæ„:', messageId);
                    } else {
                        console.error('âŒ æœªæ‰¾åˆ°å¥½å‹ç”³è¯·æ¶ˆæ¯:', messageId);
                    }

                    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯è¡¨ç¤ºå¥½å‹ç”³è¯·è¢«æ¥å—
                    const systemMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `ä½ ä»¬å·²æˆåŠŸæ·»åŠ ä¸ºå¥½å‹ï¼Œç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†ï¼`,
                        timestamp: Date.now(),
                        role: 'system'
                    };

                    chatMessages[characterId].push(systemMessage);

                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘ä½¿ç”¨é«˜æ•ˆä¿å­˜
                    try {
                        await saveChatMessagesImmediate([characterId]);
                        console.log('âœ… [é«˜æ•ˆå¥½å‹ç”³è¯·æ¥å—] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('å¥½å‹ç”³è¯·æ¥å—æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }

                    // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                    renderChatMessages(characterId);
                    updateChatBlockedStatus();

                } else {
                    // ç”¨æˆ·æ‹’ç»äº†AIçš„å¥½å‹ç”³è¯·
                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å…ˆæ ‡è®°å¥½å‹ç”³è¯·æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œå†æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }
                    const messageIndex = chatMessages[characterId].findIndex(msg => msg.id === messageId);
                    if (messageIndex !== -1) {
                        chatMessages[characterId][messageIndex].friendRequestProcessed = true;
                        chatMessages[characterId][messageIndex].friendRequestAccepted = false;
                        console.log('âœ… æ ‡è®°å¥½å‹ç”³è¯·æ¶ˆæ¯ä¸ºå·²æ‹’ç»:', messageId);
                    } else {
                        console.error('âŒ æœªæ‰¾åˆ°å¥½å‹ç”³è¯·æ¶ˆæ¯:', messageId);
                    }

                    // å¯ä»¥é€‰æ‹©æ·»åŠ ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯è¡¨ç¤ºç”³è¯·è¢«æ‹’ç»
                    const systemMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `ä½ æ‹’ç»äº†å¥½å‹ç”³è¯·`,
                        timestamp: Date.now(),
                        role: 'system'
                    };

                    chatMessages[characterId].push(systemMessage);

                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘ä½¿ç”¨é«˜æ•ˆä¿å­˜
                    try {
                        await saveChatMessagesImmediate([characterId]);
                        console.log('âœ… [é«˜æ•ˆå¥½å‹ç”³è¯·æ‹’ç»] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('å¥½å‹ç”³è¯·æ‹’ç»æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }

                    renderChatMessages(characterId);

                    // ğŸ”¥ã€æ–°å¢ã€‘è§¦å‘AIé€šè¿‡çŸ­ä¿¡è”ç³»çš„æœºåˆ¶
                    if (window.onFriendRequestRejected) {
                        window.onFriendRequestRejected(characterId);
                    }
                }

            } catch (error) {
                console.error('å¤„ç†AIå¥½å‹ç”³è¯·å¤±è´¥:', error);
                showToast('å¤„ç†å¥½å‹ç”³è¯·å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘æ‰§è¡Œæ‹‰é»‘/å±è”½æ“ä½œ - åŒºåˆ†å•èŠå’Œç¾¤èŠ
        function performBlockAction() {
            if (!currentChatCharacter) return;

            const characterId = currentChatCharacter.id;
            const isGroupChat = currentChatCharacter.isGroup;

            if (isGroupChat) {
                // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠå±è”½é€»è¾‘
                const isMuted = isGroupMuted(characterId);

                if (isMuted) {
                    if (confirm(`ç¡®å®šè¦å–æ¶ˆå±è”½ ${currentChatCharacter.name} å—ï¼Ÿ`)) {
                        toggleGroupMute(characterId);
                    }
                } else {
                    if (confirm(`ç¡®å®šè¦å±è”½ ${currentChatCharacter.name} å—ï¼Ÿ\n\nå±è”½åå°†ä¸å†æ¥æ”¶è¯¥ç¾¤èŠçš„æ¶ˆæ¯é€šçŸ¥`)) {
                        toggleGroupMute(characterId);
                    }
                }
            } else {
                // å•èŠæ‹‰é»‘é€»è¾‘
                const isUserBlocked = isBlocked('user', characterId);

                if (isUserBlocked) {
                    if (confirm(`ç¡®å®šè¦è§£é™¤å¯¹ ${currentChatCharacter.name} çš„æ‹‰é»‘å—ï¼Ÿ`)) {
                        unblockCharacter(characterId);
                        hideBlacklistSettings();
                    }
                } else {
                    if (confirm(`ç¡®å®šè¦æ‹‰é»‘ ${currentChatCharacter.name} å—ï¼Ÿ`)) {
                        blockCharacter(characterId, '');
                        hideBlacklistSettings();
                    }
                }
            }
        }

        // åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶åŠ è½½æ‹‰é»‘ç³»ç»Ÿæ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            setTimeout(async () => {
                try {
                    await Promise.all([
                        loadBlacklistData(),
                        loadFriendRequestsData(),
                        loadCharacterStatusData()
                    ]);
                    console.log('ğŸš« æ‹‰é»‘ç³»ç»Ÿæ•°æ®åŠ è½½å®Œæˆ');
                } catch (error) {
                    console.error('æ‹‰é»‘ç³»ç»Ÿæ•°æ®åŠ è½½å¤±è´¥:', error);
                }
            }, 1000);
        });

        // åŠ è½½å¥½å‹ç”³è¯·æ•°æ®
        async function loadFriendRequestsData() {
            try {
                friendRequestsData = await db.friendRequests.orderBy('timestamp').reverse().toArray();
                console.log('å¥½å‹ç”³è¯·æ•°æ®åŠ è½½å®Œæˆ:', friendRequestsData);
            } catch (error) {
                console.error('åŠ è½½å¥½å‹ç”³è¯·æ•°æ®å¤±è´¥:', error);
                friendRequestsData = [];
            }
        }

        // åŠ è½½è§’è‰²çŠ¶æ€æ•°æ®
        async function loadCharacterStatusData() {
            try {
                characterStatusData = await db.characterStatus.toArray();
                console.log('è§’è‰²çŠ¶æ€æ•°æ®åŠ è½½å®Œæˆ:', characterStatusData);
            } catch (error) {
                console.error('åŠ è½½è§’è‰²çŠ¶æ€æ•°æ®å¤±è´¥:', error);
                characterStatusData = [];
            }
        }

        // ğŸ“±ã€è§’è‰²çŠ¶æ€æ˜¾ç¤ºã€‘ç›¸å…³åŠŸèƒ½
        // æ¸²æŸ“è§’è‰²çŠ¶æ€
        function renderCharacterStatus(characterId, container) {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.characterStatusEnabled) {
                // å¦‚æœå…³é—­äº†çŠ¶æ€æ˜¾ç¤ºï¼Œç§»é™¤ç°æœ‰çš„çŠ¶æ€å…ƒç´ 
                if (container) {
                    const existingStatus = container.querySelector('.character-status');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                }
                return;
            }

            const status = getCharacterStatus(characterId);
            const isUserBlocked = isBlocked('user', characterId);
            const isCharacterBlocked = isBlocked(characterId, 'user');

            let statusClass = 'online';
            let statusText = status.activity || 'åœ¨çº¿';

            if (isUserBlocked || isCharacterBlocked) {
                statusClass = 'blocked';
                statusText = 'å·²æ‹‰é»‘';
            } else if (status.status === 'busy') {
                statusClass = 'busy';
            }

            const statusHtml = `
                <div class="character-status">
                    <div class="status-indicator ${statusClass}"></div>
                    <span class="status-text">${statusText}</span>
                </div>
            `;

            // å¦‚æœå®¹å™¨å­˜åœ¨ï¼Œæ·»åŠ çŠ¶æ€æ˜¾ç¤º
            if (container) {
                // å…ˆç§»é™¤ç°æœ‰çš„çŠ¶æ€æ˜¾ç¤º
                const existingStatus = container.querySelector('.character-status');
                if (existingStatus) {
                    existingStatus.remove();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ¤æ–­å®¹å™¨ç±»å‹ï¼Œä½¿ç”¨ä¸åŒçš„æ’å…¥ç­–ç•¥
                if (container.classList.contains('header')) {
                    // èŠå¤©ç•Œé¢çš„.headerå®¹å™¨ï¼šç›´æ¥æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œä½¿ç”¨CSSç»å¯¹å®šä½
                    container.insertAdjacentHTML('beforeend', statusHtml);
                } else if (container.classList.contains('app-header')) {
                    // å…¶ä»–ç•Œé¢çš„.app-headerå®¹å™¨ï¼šæ·»åŠ åˆ°.app-titleå†…éƒ¨
                    const titleElement = container.querySelector('.app-title');
                    if (titleElement) {
                        titleElement.insertAdjacentHTML('afterend', statusHtml);
                    } else {
                        container.insertAdjacentHTML('beforeend', statusHtml);
                    }
                } else {
                    // å…¶ä»–å®¹å™¨ï¼šé»˜è®¤æ·»åŠ åˆ°æœ«å°¾
                    container.insertAdjacentHTML('beforeend', statusHtml);
                }
            }
        }

        // AIç”Ÿæˆè§’è‰²çŠ¶æ€
        async function generateCharacterStatus(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // è·å–èŠå¤©è®¾ç½®å’Œæœ€è¿‘èŠå¤©è®°å½•
                const chatSettings = await getAsyncChatSettings(characterId);
                const messages = chatMessages[characterId] || [];
                const recentMessages = messages.slice(-5); // æœ€è¿‘5æ¡æ¶ˆæ¯

                // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
                let chatContext = '';
                if (recentMessages.length > 0) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®é™…ç”¨æˆ·åè€Œä¸æ˜¯"ç”¨æˆ·"
                    const userName = getCurrentPersonaName();
                    chatContext = 'æœ€è¿‘çš„èŠå¤©è®°å½•ï¼š\n' +
                        recentMessages.map(msg => {
                            if (msg.sender === 'sent') return `${userName}ï¼š${msg.content}`;
                            if (msg.sender === 'received') return `${character.name}ï¼š${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n') + '\n\n';
                }

                // è·å–ä¸–ç•Œä¹¦å†…å®¹ä½œä¸ºèƒŒæ™¯
                let worldBookContext = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContext = 'èƒŒæ™¯è®¾å®šï¼š\n' +
                                validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n') + '\n\n';
                        }
                    } catch (error) {
                        console.error('è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', error);
                    }
                }

                // éšæœºé€‰æ‹©çŠ¶æ€ç±»å‹ï¼šæ´»åŠ¨æˆ–å¿ƒæƒ…
                const statusType = Math.random() < 0.5 ? 'activity' : 'mood';

                let prompt;
                if (statusType === 'activity') {
                    // ç”Ÿæˆæ´»åŠ¨çŠ¶æ€
                    prompt = `ä½ æ˜¯${character.name}ï¼Œäººè®¾å¦‚ä¸‹ï¼š${character.bio}

${worldBookContext}${chatContext}è¯·æ ¹æ®ä½ çš„äººè®¾ã€å½“å‰å‰§æƒ…å’ŒèŠå¤©è®°å½•ï¼Œç”Ÿæˆä¸€ä¸ªç¬¦åˆä½ å½“å‰çŠ¶å†µçš„æ´»åŠ¨çŠ¶æ€ã€‚è¦æ±‚ï¼š
1. 10-20å­—å†…ï¼Œç®€æ´æ˜äº†
2. ç¬¦åˆä½ çš„æ€§æ ¼å’Œèº«ä»½è®¾å®š
3. åŸºäºæœ€è¿‘çš„èŠå¤©å†…å®¹æˆ–å‰§æƒ…å‘å±•
4. æ ¼å¼ï¼šåœ¨[åœ°ç‚¹][åšä»€ä¹ˆ]
5. è¦çœŸå®åæ˜ è§’è‰²å½“ä¸‹å¯èƒ½åœ¨åšçš„äº‹æƒ…
6. å¦‚æœæ²¡æœ‰å…·ä½“èŠå¤©è®°å½•ï¼Œåˆ™æ ¹æ®äººè®¾æ¨æµ‹åˆç†çš„æ—¥å¸¸æ´»åŠ¨

ç¤ºä¾‹æ ¼å¼ï¼šåœ¨å›¾ä¹¦é¦†æ•´ç†èµ„æ–™ã€åœ¨è®­ç»ƒåœºç»ƒä¹ å‰‘æœ¯ã€åœ¨æˆ¿é—´é‡Œæ²‰æ€ã€åœ¨èŠ±å›­ä¸­æ•£æ­¥ç­‰

è¯·ç”Ÿæˆä¸€ä¸ªæ´»åŠ¨çŠ¶æ€ï¼š`;
                } else {
                    // ç”Ÿæˆå¿ƒæƒ…çŠ¶æ€
                    prompt = `ä½ æ˜¯${character.name}ï¼Œäººè®¾å¦‚ä¸‹ï¼š${character.bio}

${worldBookContext}${chatContext}è¯·æ ¹æ®ä½ çš„äººè®¾ã€å½“å‰å‰§æƒ…å’ŒèŠå¤©è®°å½•ï¼Œç”Ÿæˆä¸€ä¸ªç¬¦åˆä½ å½“å‰å¿ƒæƒ…çš„çŠ¶æ€ã€‚è¦æ±‚ï¼š
1. 10-20å­—å†…ï¼Œç®€æ´æ˜äº†ï¼Œç¦æ­¢è¶…è¿‡20ä¸ªå­—
2. ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹
3. åŸºäºæœ€è¿‘çš„å¯¹è¯å†…å®¹æˆ–æƒ…æ„Ÿå˜åŒ–
4. è¡¨è¾¾ä½ å½“ä¸‹çš„çœŸå®æƒ…æ„ŸçŠ¶æ€
5. è¦æœ‰è§’è‰²çš„ä¸ªæ€§è‰²å½©
6. å¦‚æœæ²¡æœ‰å…·ä½“èŠå¤©è®°å½•ï¼Œåˆ™æ ¹æ®äººè®¾æ¨æµ‹åŸºæœ¬å¿ƒæƒ…

ç¤ºä¾‹æ ¼å¼ï¼šå¿ƒæƒ…æ„‰æ‚¦ã€ç•¥æ„Ÿå›°æƒ‘ã€æ­£åœ¨ä¸“æ³¨æ€è€ƒã€æ„Ÿåˆ°æœ‰äº›ç–²æƒ«ã€å¯¹æœªæ¥å……æ»¡æœŸå¾…ç­‰

è¯·ç”Ÿæˆä¸€ä¸ªå¿ƒæƒ…çŠ¶æ€ï¼š`;
                }

                // ä½¿ç”¨AIç”ŸæˆçŠ¶æ€
                const statusText = await generateAIResponse(prompt, character);

                if (statusText && statusText.trim()) {
                    const cleanStatus = statusText.trim().replace(/^["""''ã€Œã€ã€ã€ã€ã€‘]|["""''ã€Œã€ã€ã€ã€ã€‘]$/g, '');
                    await updateCharacterStatus(characterId, 'online', cleanStatus);
                    console.log(`ä¸º${character.name}ç”Ÿæˆ${statusType === 'activity' ? 'æ´»åŠ¨' : 'å¿ƒæƒ…'}çŠ¶æ€: ${cleanStatus}`);
                } else {
                    // å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸºäºäººè®¾çš„é»˜è®¤çŠ¶æ€
                    const fallbackStatus = generateFallbackStatus(character, statusType);
                    await updateCharacterStatus(characterId, 'online', fallbackStatus);
                    console.log(`ä¸º${character.name}ä½¿ç”¨é»˜è®¤${statusType === 'activity' ? 'æ´»åŠ¨' : 'å¿ƒæƒ…'}çŠ¶æ€: ${fallbackStatus}`);
                }

            } catch (error) {
                console.error('ç”Ÿæˆè§’è‰²çŠ¶æ€å¤±è´¥:', error);
                // é”™è¯¯æ—¶ä½¿ç”¨ç®€å•çš„é»˜è®¤çŠ¶æ€
                const fallbackStatus = generateFallbackStatus(character, 'activity');
                await updateCharacterStatus(characterId, 'online', fallbackStatus);
            }
        }

        // ç”ŸæˆåŸºäºäººè®¾çš„å¤‡ç”¨çŠ¶æ€
        function generateFallbackStatus(character, statusType) {
            const bio = (character.bio || '').toLowerCase();

            if (statusType === 'activity') {
                // åŸºäºäººè®¾å…³é”®è¯çš„æ´»åŠ¨çŠ¶æ€
                if (bio.includes('å­¦è€…') || bio.includes('ç ”ç©¶') || bio.includes('ä¹¦')) {
                    return 'åœ¨ä¹¦æˆ¿ç ”è¯»å…¸ç±';
                } else if (bio.includes('æˆ˜å£«') || bio.includes('å‰‘') || bio.includes('æˆ˜æ–—')) {
                    return 'åœ¨è®­ç»ƒåœºç»ƒä¹ ';
                } else if (bio.includes('åŒ»ç”Ÿ') || bio.includes('æ²»ç–—')) {
                    return 'åœ¨è¯Šæ‰€æ•´ç†è¯å“';
                } else if (bio.includes('å•†äºº') || bio.includes('ä¹°å–')) {
                    return 'åœ¨åº—é“ºå¿™ç¢Œ';
                } else if (bio.includes('è‰ºæœ¯') || bio.includes('ç”»') || bio.includes('éŸ³ä¹')) {
                    return 'åœ¨å·¥ä½œå®¤åˆ›ä½œ';
                } else if (bio.includes('å¨') || bio.includes('æ–™ç†')) {
                    return 'åœ¨å¨æˆ¿å‡†å¤‡é£Ÿæ';
                } else {
                    return 'åœ¨æˆ¿é—´é‡Œä¼‘æ¯';
                }
            } else {
                // åŸºäºäººè®¾å…³é”®è¯çš„å¿ƒæƒ…çŠ¶æ€
                if (bio.includes('å¼€æœ—') || bio.includes('æ´»æ³¼') || bio.includes('ä¹è§‚')) {
                    return 'å¿ƒæƒ…æ„‰æ‚¦';
                } else if (bio.includes('å†·é™') || bio.includes('ç†æ€§') || bio.includes('æ²‰ç€')) {
                    return 'å†…å¿ƒå¹³é™';
                } else if (bio.includes('ä¸¥è‚ƒ') || bio.includes('è®¤çœŸ')) {
                    return 'ä¸“æ³¨æ€è€ƒä¸­';
                } else if (bio.includes('æ¸©æŸ”') || bio.includes('å–„è‰¯')) {
                    return 'å¿ƒå¢ƒæ¸©å’Œ';
                } else if (bio.includes('ç¥ç§˜') || bio.includes('æ·±æ²‰')) {
                    return 'è‹¥æœ‰æ‰€æ€';
                } else {
                    return 'çŠ¶æ€è‰¯å¥½';
                }
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘çŠ¶æ€æ›´æ–°å®šæ—¶å™¨ç®¡ç†
        let characterStatusTimer = null;

        // è·å–çŠ¶æ€æ›´æ–°é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        function getStatusUpdateInterval() {
            // ğŸ”¥ã€ä¿®å¤ã€‘ä»localStorageè·å–å…¨å±€çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®
            let frequency = 'medium'; // é»˜è®¤ä¸­é¢‘

            try {
                // å°è¯•ä»localStorageè·å–å…¨å±€è®¾ç½®
                const globalSettings = localStorage.getItem('globalStatusUpdateFrequency');
                if (globalSettings) {
                    frequency = globalSettings;
                } else {
                    // å¦‚æœæ²¡æœ‰å…¨å±€è®¾ç½®ï¼Œå°è¯•ä»å½“å‰è§’è‰²è®¾ç½®ä¸­è·å–
                    if (currentChatCharacter) {
                        const chatSettings = getCurrentChatSettings();
                        frequency = chatSettings.statusUpdateFrequency || 'medium';
                        // ä¿å­˜ä¸ºå…¨å±€è®¾ç½®
                        localStorage.setItem('globalStatusUpdateFrequency', frequency);
                    }
                }
            } catch (error) {
                console.warn('è·å–çŠ¶æ€æ›´æ–°é¢‘ç‡è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å°†é¢‘ç‡è½¬æ¢ä¸ºæ¯«ç§’é—´éš” - ä¿®æ­£é«˜é¢‘ä¸º30ç§’
            const intervals = {
                'high': 30000,      // 30ç§’ï¼ˆç›®å‰é¢‘ç‡ï¼‰
                'medium-high': 60000, // 1åˆ†é’Ÿ
                'medium': 180000,   // 3åˆ†é’Ÿ
                'medium-low': 300000, // 5åˆ†é’Ÿ
                'low': 600000       // 10åˆ†é’Ÿ
            };

            return intervals[frequency] || intervals['medium'];
        }

        // æ¸…é™¤çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        function clearCharacterStatusTimer() {
            if (characterStatusTimer) {
                clearInterval(characterStatusTimer);
                characterStatusTimer = null;
                console.log('è§’è‰²çŠ¶æ€æ›´æ–°å®šæ—¶å™¨å·²æ¸…é™¤');
            }
        }

        // å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        async function startCharacterStatusTimer() {
            clearCharacterStatusTimer(); // å…ˆæ¸…é™¤ç°æœ‰å®šæ—¶å™¨

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è§’è‰²å¯ç”¨äº†çŠ¶æ€æ˜¾ç¤º
            let hasStatusEnabled = false;
            for (const character of characters) {
                if (contacts.includes(character.id)) {
                    const chatSettings = await getAsyncChatSettings(character.id);
                    if (chatSettings.characterStatusEnabled) {
                        hasStatusEnabled = true;
                        break;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰ä»»ä½•è§’è‰²å¯ç”¨çŠ¶æ€æ˜¾ç¤ºï¼Œä¸å¯åŠ¨å®šæ—¶å™¨
            if (!hasStatusEnabled) {
                console.log('æ²¡æœ‰è§’è‰²å¯ç”¨çŠ¶æ€æ˜¾ç¤ºï¼Œè·³è¿‡å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨');
                return;
            }

            const interval = getStatusUpdateInterval();
            console.log('å¯åŠ¨è§’è‰²çŠ¶æ€æ›´æ–°å®šæ—¶å™¨ï¼Œé—´éš”:', interval / 1000, 'ç§’');

            characterStatusTimer = setInterval(async () => {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è§’è‰²å¯ç”¨äº†çŠ¶æ€æ˜¾ç¤º
                let hasStatusEnabled = false;

                for (const character of characters) {
                    if (contacts.includes(character.id)) {
                        // æ£€æŸ¥è¯¥è§’è‰²çš„èŠå¤©è®¾ç½®ä¸­æ˜¯å¦å¯ç”¨äº†çŠ¶æ€æ˜¾ç¤º
                        const chatSettings = await getAsyncChatSettings(character.id);
                        if (chatSettings.characterStatusEnabled) {
                            hasStatusEnabled = true;

                            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°çŠ¶æ€
                            const shouldUpdate = await shouldUpdateCharacterStatus(character.id);
                            if (shouldUpdate) {
                                await generateCharacterStatus(character.id);
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰ä»»ä½•è§’è‰²å¯ç”¨çŠ¶æ€æ˜¾ç¤ºï¼Œåœæ­¢å®šæ—¶å™¨
                if (!hasStatusEnabled) {
                    console.log('æ²¡æœ‰è§’è‰²å¯ç”¨çŠ¶æ€æ˜¾ç¤ºï¼Œåœæ­¢çŠ¶æ€æ›´æ–°å®šæ—¶å™¨');
                    clearCharacterStatusTimer();
                    return;
                }

                // åˆ·æ–°å½“å‰æ˜¾ç¤ºçš„çŠ¶æ€ï¼ˆä»…å½“å½“å‰è§’è‰²å¯ç”¨äº†çŠ¶æ€æ˜¾ç¤ºæ—¶ï¼‰
                if (currentChatCharacter) {
                    const currentChatSettings = getCurrentChatSettings();
                    if (currentChatSettings.characterStatusEnabled) {
                        const headerContainer = document.querySelector('#api-chat-screen .header');
                        if (headerContainer) {
                            renderCharacterStatus(currentChatCharacter.id, headerContainer);
                        }
                    }
                }
            }, interval);
        }

        // é‡å¯çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        function restartCharacterStatusTimer() {
            console.log('é‡å¯è§’è‰²çŠ¶æ€æ›´æ–°å®šæ—¶å™¨');
            startCharacterStatusTimer();
        }

        // å‘åå…¼å®¹çš„å‡½æ•°å
        function startStatusUpdateTimer() {
            startCharacterStatusTimer();
        }

        // ================== å…¨å±€è®°å¿†ç³»ç»Ÿ ==================

        // å…¨å±€è®°å¿†æ•°æ®åº“ç»“æ„
        let globalMemoryDB = null;

        // åˆå§‹åŒ–å…¨å±€è®°å¿†æ•°æ®åº“
        async function initGlobalMemoryDB() {
            try {
                // æ‰©å±•ç°æœ‰æ•°æ®åº“ï¼Œæ·»åŠ è®°å¿†ç›¸å…³è¡¨
                if (!db.memorySummaries) {
                    // æƒ…æ™¯è®°å¿†è¡¨ - å­˜å‚¨AIç”Ÿæˆçš„æ—¥è®°æ‘˜è¦
                    db.memorySummaries = db.table('memorySummaries', '++id, characterId, date, summary, context, importance, timestamp');
                }

                if (!db.coreMemories) {
                    // æ ¸å¿ƒè®°å¿†è¡¨ - å­˜å‚¨æ°¸ä¹…é‡è¦ä¿¡æ¯
                    db.coreMemories = db.table('coreMemories', '++id, characterId, fact, category, importance, timestamp, lastAccessed');
                }

                if (!db.memoryEvents) {
                    // ç»Ÿä¸€äº‹ä»¶è¡¨ - è®°å½•æ‰€æœ‰è·¨åœºæ™¯äº‹ä»¶
                    db.memoryEvents = db.table('memoryEvents', '++id, timestamp, characterIds, context, eventType, eventData, importance');
                }

                console.log('âœ… å…¨å±€è®°å¿†æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ å…¨å±€è®°å¿†æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // è®°å½•ç»Ÿä¸€äº‹ä»¶
        async function recordMemoryEvent(characterIds, context, eventType, eventData, importance = 0.5) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½æ˜¯æœ‰æ•ˆçš„
                if (!characterIds || !eventType || !eventData) {
                    console.warn('âŒ recordMemoryEvent: ç¼ºå°‘å¿…éœ€å‚æ•°', { characterIds, eventType, eventData });
                    return;
                }

                const event = {
                    id: `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // ğŸ”¥ã€ä¿®å¤ã€‘æä¾›å”¯ä¸€ID
                    timestamp: Date.now(),
                    characterIds: Array.isArray(characterIds) ? characterIds : [characterIds],
                    context: context || { type: 'unknown', id: 'unknown' }, // ğŸ”¥ã€ä¿®å¤ã€‘æä¾›é»˜è®¤context
                    eventType: eventType, // 'message', 'activity_start', 'group_create' ç­‰
                    eventData: eventData,
                    importance: importance || 0.5
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿eventDataæ˜¯å¯åºåˆ—åŒ–çš„å¯¹è±¡
                if (typeof event.eventData === 'object' && event.eventData !== null) {
                    try {
                        JSON.stringify(event.eventData);
                    } catch (e) {
                        console.warn('âŒ eventDataä¸å¯åºåˆ—åŒ–ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²:', event.eventData);
                        event.eventData = String(event.eventData);
                    }
                }

                await db.memoryEvents.add(event);
                console.log('ğŸ“ è®°å½•äº‹ä»¶:', eventType, characterIds);
            } catch (error) {
                console.error('âŒ è®°å½•äº‹ä»¶å¤±è´¥:', error);
                console.error('âŒ äº‹ä»¶æ•°æ®:', { characterIds, context, eventType, eventData, importance });
            }
        }

        // æ·»åŠ æ ¸å¿ƒè®°å¿†
        async function addCoreMemory(characterId, fact, category = 'general', importance = 0.8) {
            try {
                const coreMemory = {
                    characterId: characterId,
                    fact: fact,
                    category: category, // 'personality', 'relationship', 'preference', 'general'
                    importance: importance,
                    timestamp: Date.now(),
                    lastAccessed: Date.now()
                };

                await db.coreMemories.add(coreMemory);
                console.log('ğŸ§  æ·»åŠ æ ¸å¿ƒè®°å¿†:', fact);
            } catch (error) {
                console.error('âŒ æ·»åŠ æ ¸å¿ƒè®°å¿†å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæƒ…æ™¯è®°å¿†æ‘˜è¦
        async function generateMemorySummary(characterId, startTime, endTime, context) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘å…ˆè·å–è§’è‰²ä¿¡æ¯ï¼Œé¿å…å˜é‡ä½œç”¨åŸŸé”™è¯¯
                const character = characters.find(c => c.id === characterId);
                if (!character) {
                    console.error('æœªæ‰¾åˆ°è§’è‰²ä¿¡æ¯:', characterId);
                    return null;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–æ—¶é—´æ®µå†…çš„è·¨åº”ç”¨æ—¶é—´çº¿äº‹ä»¶ï¼ˆåŒ…æ‹¬èŠå¤©è®°å½•ï¼‰
                const timelineEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => event.timestamp >= startTime && event.timestamp < endTime)
                    .toArray();

                // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶è·å–èŠå¤©æ¶ˆæ¯
                const characterMessages = chatMessages[characterId] || [];
                const todayMessages = characterMessages.filter(msg =>
                    msg.timestamp >= startTime && msg.timestamp < endTime
                );

                if (timelineEvents.length === 0 && todayMessages.length === 0) {
                    console.log('ä»Šå¤©æš‚æ— æ´»åŠ¨è®°å½•');
                    return null;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ„å»ºæ›´å…¨é¢çš„æ´»åŠ¨è®°å½•
                let eventsText = '';

                // æ·»åŠ èŠå¤©è®°å½•
                if (todayMessages.length > 0) {
                    eventsText += 'èŠå¤©è®°å½•ï¼š\n';
                    todayMessages.forEach(msg => {
                        const timeStr = new Date(msg.timestamp).toLocaleTimeString();
                        const role = msg.role === 'user' ? 'ç”¨æˆ·' : character.name;
                        eventsText += `[${timeStr}] ${role}: ${msg.content}\n`;
                    });
                }

                // æ·»åŠ è·¨åº”ç”¨äº‹ä»¶
                if (timelineEvents.length > 0) {
                    eventsText += '\nå…¶ä»–æ´»åŠ¨ï¼š\n';
                    timelineEvents.forEach(event => {
                        const timeStr = new Date(event.timestamp).toLocaleTimeString();
                        const actionDesc = getActionDescription(event.action, event.context);
                        eventsText += `[${timeStr}] ${actionDesc}\n`;
                    });
                }
                const summaryPrompt = `ä½ æ˜¯ä¸€ä¸ªå®¢è§‚çš„è®°å½•å‘˜ï¼Œéœ€è¦ä¸ºä»¥ä¸‹æ´»åŠ¨ç”Ÿæˆä¸€ä»½ç®€æ´çš„è®°å¿†æ‘˜è¦ã€‚

è§’è‰²ï¼š${character.name}
æ—¶é—´æ®µï¼š${new Date(startTime).toLocaleString()} - ${new Date(endTime).toLocaleString()}
ä»Šæ—¥æ´»åŠ¨ï¼š
${eventsText}

è¯·ç”Ÿæˆä¸€ä»½50-100å­—çš„å®¢è§‚è®°å¿†æ‘˜è¦ï¼Œè¦æ±‚ï¼š
1. ä½¿ç”¨ç¬¬ä¸‰äººç§°å®¢è§‚æè¿°
2. ç”¨"ç”¨æˆ·"æŒ‡ä»£ç”¨æˆ·ï¼Œç”¨"${character.name}"æŒ‡ä»£è§’è‰²
3. é‡ç‚¹è®°å½•é‡è¦äº‹ä»¶å’Œæƒ…æ„Ÿå˜åŒ–
4. ä¸è¦ä½¿ç”¨"æˆ‘"ã€"ä½ "ç­‰ç¬¬ä¸€ã€ç¬¬äºŒäººç§°
5. ç›´æ¥è¾“å‡ºæ‘˜è¦æ–‡æœ¬ï¼Œä¸è¦JSONæ ¼å¼ï¼Œä¸è¦èŠå¤©å›å¤æ ¼å¼

æ‘˜è¦ï¼š`;

                // è°ƒç”¨ä¸“é—¨çš„æ‘˜è¦ç”ŸæˆAPI
                const response = await callSummaryAPI(summaryPrompt);

                if (response && response.trim()) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å½“å‰æ—¥æœŸè€Œä¸æ˜¯startTimeï¼Œé¿å…æ—¶åŒºé—®é¢˜
                    const today = new Date();
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    const summary = {
                        id: `summary_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        characterId: characterId,
                        date: dateStr,
                        summary: response.trim(),
                        context: context,
                        importance: calculateSummaryImportance(timelineEvents.concat(todayMessages)),
                        timestamp: Date.now()
                    };

                    await db.memorySummaries.add(summary);
                    console.log('ğŸ“– ç”Ÿæˆè®°å¿†æ‘˜è¦:', summary.summary);
                    return summary;
                }
            } catch (error) {
                console.error('âŒ ç”Ÿæˆè®°å¿†æ‘˜è¦å¤±è´¥:', error);
            }
            return null;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è·å–åŠ¨ä½œæè¿°çš„è¾…åŠ©å‡½æ•°
        function getActionDescription(action, context) {
            const actionMap = {
                'user_message': 'æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯',
                'ai_reply': 'å›å¤äº†æ¶ˆæ¯',
                'moment_publish': 'å‘å¸ƒäº†åŠ¨æ€',
                'moment_comment': 'è¯„è®ºäº†åŠ¨æ€',
                'game_start': 'å¼€å§‹æ¸¸æˆ',
                'game_end': 'ç»“æŸæ¸¸æˆ'
            };

            const baseDesc = actionMap[action] || action;
            if (context && context.content) {
                return `${baseDesc}: ${context.content.substring(0, 30)}...`;
            }
            return baseDesc;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¸“é—¨ç”¨äºç”Ÿæˆæ‘˜è¦çš„APIè°ƒç”¨å‡½æ•°
        async function callSummaryAPI(prompt) {
            if (!apiSettings.key) {
                throw new Error('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
            }

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers;

            if (isGemini) {
                // Gemini API æ ¼å¼
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = { 'Content-Type': 'application/json' };

                requestBody = {
                    contents: [{
                        role: 'user',
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.3 // ä½¿ç”¨è¾ƒä½çš„æ¸©åº¦ç¡®ä¿å®¢è§‚æ€§
                    }
                };
            } else {
                // OpenAI å…¼å®¹æ ¼å¼
                if (apiSettings.base.endsWith('/v1')) {
                    url = `${apiSettings.base}/chat/completions`;
                } else if (apiSettings.base.includes('/v1/')) {
                    url = `${apiSettings.base}/chat/completions`;
                } else {
                    url = `${apiSettings.base}/v1/chat/completions`;
                }
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: [
                        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå®¢è§‚çš„è®°å½•å‘˜ï¼Œä¸“é—¨ç”Ÿæˆç®€æ´çš„è®°å¿†æ‘˜è¦ã€‚è¯·ç›´æ¥è¾“å‡ºæ‘˜è¦æ–‡æœ¬ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼æˆ–èŠå¤©å›å¤æ ¼å¼ã€‚' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.3
                };
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const data = await response.json();
            return isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content;
        }

        // è®¡ç®—æ‘˜è¦é‡è¦æ€§
        function calculateSummaryImportance(events) {
            if (!events || events.length === 0) return 0.3;

            // ğŸ”¥ã€ä¿®å¤ã€‘é€‚é…ä¸åŒç±»å‹çš„äº‹ä»¶æ•°æ®
            let totalImportance = 0;
            let validEvents = 0;

            events.forEach(event => {
                if (event.importance !== undefined) {
                    totalImportance += event.importance;
                    validEvents++;
                } else {
                    // å¯¹äºèŠå¤©æ¶ˆæ¯ï¼Œç»™äºˆåŸºç¡€é‡è¦æ€§
                    totalImportance += 0.6;
                    validEvents++;
                }
            });

            const avgImportance = validEvents > 0 ? totalImportance / validEvents : 0.5;
            const eventCount = events.length;

            // äº‹ä»¶æ•°é‡å’Œå¹³å‡é‡è¦æ€§çš„ç»¼åˆè¯„åˆ†
            return Math.min(0.9, avgImportance + (eventCount * 0.02));
        }

        // æ™ºèƒ½è®°å¿†æ£€ç´¢ç³»ç»Ÿ
        async function buildGlobalMemoryContext(characterId, currentContext, memoryDays = 7) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨å‡½æ•°ç¡®ä¿characterIdæ˜¯å­—ç¬¦ä¸²ç±»å‹
                characterId = safeCharacterId(characterId);

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿currentContextæœ‰æ•ˆ
                if (!currentContext || !currentContext.id) {
                    console.error('âŒ buildGlobalMemoryContext: currentContextæ— æ•ˆ:', currentContext);
                    return '';
                }

                let memoryContext = '';

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ™ºèƒ½è®°å¿†å…±äº« - æ›´ä¸»åŠ¨åœ°åŒ…å«è·¨åœºæ™¯è®°å¿†
                let sharedGroupIds = [];
                let contextIds = [String(currentContext.id)]; // ç¡®ä¿contextIdæ˜¯å­—ç¬¦ä¸²

                // ğŸ”¥ã€æ–°å¢ã€‘æ™ºèƒ½è®°å¿†å…±äº«ï¼šä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³çš„è·¨åœºæ™¯è®°å¿†
                try {
                    // æ£€æŸ¥è¯¥è§’è‰²æ˜¯å¦æœ‰è·¨åº”ç”¨æ—¶é—´çº¿è®°å½•ï¼Œå¦‚æœæœ‰åˆ™æ›´ç§¯æåœ°å…±äº«è®°å¿†
                    const recentTimeline = await db.crossAppTimeline
                        .where('characterId')
                        .equals(characterId)
                        .and(event => event.timestamp > Date.now() - (7 * 24 * 60 * 60 * 1000)) // æœ€è¿‘7å¤©
                        .toArray();

                    const hasRecentCrossAppActivity = recentTimeline.length > 0;
                    console.log(`ğŸ§  æ™ºèƒ½è®°å¿†æ£€æŸ¥ - è§’è‰²: ${characterId}, æœ€è¿‘7å¤©è·¨åº”ç”¨æ´»åŠ¨: ${recentTimeline.length}æ¡`);

                    if (currentContext.type === 'group_chat') {
                        // ğŸ”¥ã€æ–°å¢ã€‘ä¼˜å…ˆæ£€æŸ¥ï¼šè¯¥ç¾¤èŠæ˜¯å¦è¢«ç§èŠæŒ‚è½½äº†è®°å¿†å…±äº«
                        const characterChatSettings = await getAsyncChatSettings(characterId);
                        sharedGroupIds = characterChatSettings.memorySharedGroupIds || [];

                        console.log(`ğŸ” ç¾¤èŠè®°å¿†ä¼˜å…ˆçº§æ£€æŸ¥ - è§’è‰²: ${characterId}`);
                        console.log(`ğŸ” å½“å‰ç¾¤èŠID: ${currentContext.id}`);
                        console.log(`ğŸ” è§’è‰²ç§èŠè®¾ç½®çš„å…±äº«ç¾¤èŠIDs: ${sharedGroupIds}`);

                        // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¦‚æœè¯¥ç¾¤èŠè¢«ç§èŠæŒ‚è½½äº†è®°å¿†å…±äº«ï¼Œä¼˜å…ˆæ˜¾ç¤ºç§èŠè®°å¿†
                        if (sharedGroupIds.includes(currentContext.id)) {
                            // å°†ç§èŠè®°å¿†æ”¾åœ¨æœ€å‰é¢ï¼Œç¡®ä¿ä¼˜å…ˆè¯»å–
                            contextIds = [characterId, String(currentContext.id)]; // ç§èŠIDåœ¨å‰ï¼Œç¾¤èŠIDåœ¨å
                            console.log('ğŸ”— ç¾¤èŠè¢«ç§èŠæŒ‚è½½è®°å¿†å…±äº« - ä¼˜å…ˆè¯»å–ç§èŠè®°å¿†');
                        } else if (hasRecentCrossAppActivity) {
                            // å¦‚æœæœ‰è·¨åº”ç”¨æ´»åŠ¨ï¼Œä¹ŸåŒ…å«ç§èŠè®°å¿†ï¼Œä½†ä¼˜å…ˆçº§è¾ƒä½
                            contextIds.push(characterId);
                            console.log('ğŸ”— æ£€æµ‹åˆ°è·¨åº”ç”¨æ´»åŠ¨ - åŒ…å«ç§èŠè®°å¿†');
                        } else {
                            console.log('âŒ ç¾¤èŠæœªè¢«æŒ‚è½½è®°å¿†å…±äº«ä¸”æ— è·¨åº”ç”¨æ´»åŠ¨ï¼Œåªä½¿ç”¨ç¾¤èŠè®°å¿†');
                        }
                    } else if (currentContext.type === 'private_chat') {
                        // å¦‚æœåœ¨ç§èŠä¸­ï¼Œä½¿ç”¨å½“å‰èŠå¤©è®¾ç½®
                        const chatSettings = getCurrentChatSettings();
                        sharedGroupIds = chatSettings.memorySharedGroupIds || [];

                        // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¦‚æœæœ‰è·¨åº”ç”¨æ´»åŠ¨ï¼Œè‡ªåŠ¨åŒ…å«ç›¸å…³ç¾¤èŠè®°å¿†
                        if (sharedGroupIds.length > 0) {
                            contextIds.push(...sharedGroupIds.map(id => String(id)));
                            console.log('ğŸ”— ç§èŠä¸­å¯ç”¨è®°å¿†å…±äº«ï¼ŒåŒ…å«ç¾¤èŠ:', sharedGroupIds);
                        } else if (hasRecentCrossAppActivity) {
                            // ğŸ”¥ã€æ–°å¢ã€‘å³ä½¿æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ï¼Œå¦‚æœæœ‰è·¨åº”ç”¨æ´»åŠ¨ä¹Ÿå°è¯•åŒ…å«ç›¸å…³ç¾¤èŠ
                            const relatedGroupIds = recentTimeline
                                .filter(event => event.context?.type === 'group_chat' && event.context?.groupId)
                                .map(event => event.context.groupId)
                                .filter((id, index, self) => self.indexOf(id) === index); // å»é‡

                            if (relatedGroupIds.length > 0) {
                                contextIds.push(...relatedGroupIds.map(id => String(id)));
                                console.log('ğŸ”— æ£€æµ‹åˆ°ç¾¤èŠæ´»åŠ¨ï¼Œæ™ºèƒ½åŒ…å«ç›¸å…³ç¾¤èŠè®°å¿†:', relatedGroupIds);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('æ™ºèƒ½è®°å¿†å…±äº«æ£€æŸ¥å¤±è´¥:', error);
                }

                // 1. æ£€ç´¢æ ¸å¿ƒè®°å¿† - ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡è¿‡æ»¤å’Œç±»å‹æ£€æŸ¥
                let coreMemories = [];
                for (const contextId of contextIds) {
                    try {
                        const contextCoreMemories = await db.coreMemories
                            .where('characterId')
                            .equals(String(characterId)) // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                            .and(memory => {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æŒ‰ä¸Šä¸‹æ–‡è¿‡æ»¤æ ¸å¿ƒè®°å¿†
                                if (!memory.contextId) return true; // å…¼å®¹æ—§æ•°æ®
                                return String(memory.contextId) === String(contextId);
                            })
                            .toArray();
                        coreMemories = coreMemories.concat(contextCoreMemories);
                    } catch (error) {
                        console.error(`âŒ æŸ¥è¯¢æ ¸å¿ƒè®°å¿†å¤±è´¥ - characterId: ${characterId}, contextId: ${contextId}:`, error);
                    }
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æŒ‰ä¼˜å…ˆçº§å’Œé‡è¦æ€§æ’åºï¼šç§èŠè®°å¿†ä¼˜å…ˆï¼Œç„¶åæŒ‰é‡è¦æ€§æ’åº
                coreMemories.sort((a, b) => {
                    // é¦–å…ˆæŒ‰ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§æ’åºï¼ˆç§èŠè®°å¿†ä¼˜å…ˆï¼‰
                    const aIsPrivate = String(a.contextId) === String(characterId);
                    const bIsPrivate = String(b.contextId) === String(characterId);

                    if (aIsPrivate && !bIsPrivate) return -1; // aæ˜¯ç§èŠï¼Œbä¸æ˜¯ï¼Œaä¼˜å…ˆ
                    if (!aIsPrivate && bIsPrivate) return 1;  // bæ˜¯ç§èŠï¼Œaä¸æ˜¯ï¼Œbä¼˜å…ˆ

                    // å¦‚æœéƒ½æ˜¯åŒç±»å‹ï¼ŒæŒ‰é‡è¦æ€§æ’åº
                    return (b.importance || 0) - (a.importance || 0);
                });
                const limitedCoreMemories = coreMemories.slice(0, 10);

                if (limitedCoreMemories.length > 0) {
                    memoryContext += '\n# æ ¸å¿ƒè®°å¿†\n';
                    limitedCoreMemories.forEach(memory => {
                        memoryContext += `- ${memory.fact}\n`;
                    });
                }

                // 2. æ£€ç´¢æƒ…æ™¯è®°å¿†ï¼ˆæœ€è¿‘Nå¤©ï¼‰- ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡è¿‡æ»¤
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - memoryDays);
                const cutoffTimestamp = cutoffDate.getTime();

                let episodicMemories = [];
                for (const contextId of contextIds) {
                    const contextEpisodicMemories = await db.episodicMemories
                        .where('characterId')
                        .equals(characterId)
                        .and(memory => {
                            if (memory.timestamp < cutoffTimestamp) return false;
                            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘æŒ‰ä¸Šä¸‹æ–‡è¿‡æ»¤æƒ…æ™¯è®°å¿†
                            if (!memory.contextId) return true; // å…¼å®¹æ—§æ•°æ®
                            return memory.contextId === contextId;
                        })
                        .toArray();
                    episodicMemories = episodicMemories.concat(contextEpisodicMemories);
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æŒ‰ä¼˜å…ˆçº§å’Œæ—¶é—´æ’åºï¼šç§èŠè®°å¿†ä¼˜å…ˆï¼Œç„¶åæŒ‰æ—¶é—´æ’åº
                episodicMemories.sort((a, b) => {
                    // é¦–å…ˆæŒ‰ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§æ’åºï¼ˆç§èŠè®°å¿†ä¼˜å…ˆï¼‰
                    const aIsPrivate = String(a.contextId) === String(characterId);
                    const bIsPrivate = String(b.contextId) === String(characterId);

                    if (aIsPrivate && !bIsPrivate) return -1; // aæ˜¯ç§èŠï¼Œbä¸æ˜¯ï¼Œaä¼˜å…ˆ
                    if (!aIsPrivate && bIsPrivate) return 1;  // bæ˜¯ç§èŠï¼Œaä¸æ˜¯ï¼Œbä¼˜å…ˆ

                    // å¦‚æœéƒ½æ˜¯åŒç±»å‹ï¼ŒæŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    return b.timestamp - a.timestamp;
                });
                const limitedEpisodicMemories = episodicMemories.slice(0, 15);

                if (limitedEpisodicMemories.length > 0) {
                    memoryContext += '\n# æƒ…æ™¯è®°å¿†\n';
                    limitedEpisodicMemories.forEach(memory => {
                        const dateObj = new Date(memory.timestamp || Date.now());
                        const date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString();
                        memoryContext += `[${date}] ${memory.fact}\n`;
                    });
                }

                // 3. æ£€ç´¢è·¨åº”ç”¨æ—¶é—´çº¿è®°å¿†ï¼ˆæ”¯æŒè®°å¿†å…±äº«ï¼‰
                const timelineCutoff = Date.now() - (memoryDays * 24 * 60 * 60 * 1000);
                let timelineMemories = [];

                for (const contextId of contextIds) {
                    const contextTimeline = await db.crossAppTimeline
                        .where('characterId')
                        .equals(characterId)
                        .and(event => {
                            if (event.timestamp < timelineCutoff) return false;
                            if (!event.context) return false;

                            // ğŸ”¥ã€ä¿®å¤ã€‘çº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“ä¹Ÿåº”è¯¥è¢«åŒ…å«
                            if (event.appType === 'offline_mode' && event.action === 'storyline_summary') {
                                return true; // çº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“å¯¹æ‰€æœ‰ä¸Šä¸‹æ–‡éƒ½å¯è§
                            }

                            // ğŸ”¥ã€ä¿®å¤ã€‘çŸ­ä¿¡appäº‹ä»¶çš„ç‰¹æ®Šå¤„ç†
                            if (event.appType === 'sms') {
                                // çŸ­ä¿¡äº‹ä»¶çš„ä¸Šä¸‹æ–‡IDå°±æ˜¯è§’è‰²IDï¼Œç›´æ¥åŒ¹é…
                                return event.context.id === contextId ||
                                       event.context.chatId === contextId ||
                                       contextId === characterId; // å¦‚æœå½“å‰ä¸Šä¸‹æ–‡æ˜¯è¯¥è§’è‰²çš„ç§èŠï¼ŒåŒ…å«æ‰€æœ‰çŸ­ä¿¡äº‹ä»¶
                            }

                            // æ£€æŸ¥ä¸Šä¸‹æ–‡IDåŒ¹é…
                            return event.context.id === contextId ||
                                   (event.context.chatId === contextId) ||
                                   (event.context.groupId === contextId);
                        })
                        .toArray();
                    timelineMemories = timelineMemories.concat(contextTimeline);
                }

                // å»é‡å¹¶æ’åº
                const uniqueTimelineMemories = timelineMemories.filter((memory, index, self) =>
                    index === self.findIndex(m => m.id === memory.id));
                uniqueTimelineMemories.sort((a, b) => b.timestamp - a.timestamp);
                const limitedTimelineMemories = uniqueTimelineMemories.slice(0, 30); // ğŸ”¥ã€ä¼˜åŒ–ã€‘å¢åŠ åˆ°30æ¡

                if (limitedTimelineMemories.length > 0) {
                    memoryContext += '\n# æœ€è¿‘æ´»åŠ¨æ—¶é—´çº¿\n';
                    limitedTimelineMemories.forEach((memory, index) => {
                        const time = new Date(memory.timestamp).toLocaleString();
                        let contextInfo = 'ç§èŠ';
                        let contextEmoji = 'ğŸ’¬';

                        if (memory.context?.type === 'group_chat') {
                            contextInfo = memory.context?.groupName ? `ç¾¤èŠ(${memory.context.groupName})` : 'ç¾¤èŠ';
                            contextEmoji = 'ğŸ‘¥';
                        } else if (memory.appType === 'offline_mode') {
                            contextInfo = 'çº¿ä¸‹æ¨¡å¼';
                            contextEmoji = 'ğŸ­';
                        } else if (memory.appType === 'sms') {
                            contextInfo = 'çŸ­ä¿¡';
                            contextEmoji = 'ğŸ“±';
                        }

                        // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ„å»ºæ›´æœ‰æ„ä¹‰å’Œè¿è´¯çš„äº‹ä»¶æè¿°
                        let eventDescription = '';
                        let isImportant = false; // æ ‡è®°é‡è¦äº‹ä»¶

                        if (memory.action === 'user_message') {
                            if (memory.context?.content) {
                                eventDescription = `ç”¨æˆ·è¯´: "${memory.context.content.substring(0, 60)}${memory.context.content.length > 60 ? '..."' : '"'}`;
                            } else {
                                eventDescription = `ç”¨æˆ·å‘é€äº†æ¶ˆæ¯`;
                            }
                        } else if (memory.action === 'ai_message' || memory.action === 'ai_reply') {
                            if (memory.context?.content) {
                                eventDescription = `æˆ‘å›å¤: "${memory.context.content.substring(0, 60)}${memory.context.content.length > 60 ? '..."' : '"'}`;
                            } else {
                                eventDescription = `æˆ‘è¿›è¡Œäº†å›å¤`;
                            }
                        } else if (memory.appType === 'sms') {
                            // ğŸ”¥ã€ä¼˜åŒ–ã€‘çŸ­ä¿¡äº‹ä»¶çš„ç‰¹æ®Šæ˜¾ç¤ºï¼Œæ›´å¼ºè°ƒè·¨åœºæ™¯è¿æ¥
                            if (memory.action === 'user_message') {
                                eventDescription = `ğŸ“±æ”¶åˆ°çŸ­ä¿¡: "${memory.context?.content?.substring(0, 60) || ''}${(memory.context?.content?.length || 0) > 60 ? '..."' : '"'}`;
                                isImportant = true;
                            } else if (memory.action === 'ai_reply') {
                                eventDescription = `ğŸ“±å›å¤çŸ­ä¿¡: "${memory.context?.content?.substring(0, 60) || ''}${(memory.context?.content?.length || 0) > 60 ? '..."' : '"'}`;
                                isImportant = true;
                            } else if (memory.action === 'character_initiate') {
                                eventDescription = `ğŸ“±ä¸»åŠ¨å‘çŸ­ä¿¡: "${memory.context?.content?.substring(0, 60) || ''}${(memory.context?.content?.length || 0) > 60 ? '..."' : '"'}`;
                                isImportant = true;
                            } else {
                                eventDescription = 'ğŸ“±çŸ­ä¿¡äº’åŠ¨';
                            }
                        } else if (memory.action === 'storyline_summary' && memory.appType === 'offline_mode') {
                            // ğŸ”¥ã€ä¼˜åŒ–ã€‘çº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“çš„ç‰¹æ®Šæ˜¾ç¤º
                            if (memory.context?.content) {
                                eventDescription = `ğŸ­å‰§æƒ…æ€»ç»“: ${memory.context.content.substring(0, 80)}${memory.context.content.length > 80 ? '...' : ''}`;
                                isImportant = true;
                            } else {
                                eventDescription = 'ğŸ­çº¿ä¸‹å‰§æƒ…æ¨¡å¼æ€»ç»“';
                            }
                        } else {
                            eventDescription = memory.action || memory.eventType || 'æœªçŸ¥æ´»åŠ¨';
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘ä¸ºè·¨åœºæ™¯äº‹ä»¶æ·»åŠ ç‰¹æ®Šæ ‡è®°
                        const isCrossContext = memory.context?.id !== currentContext.id;
                        const crossContextMark = isCrossContext ? ' â­' : '';
                        const importantMark = isImportant ? ' ğŸ”¥' : '';

                        memoryContext += `[${time}] ${contextEmoji}${contextInfo}: ${eventDescription}${crossContextMark}${importantMark}\n`;
                    });
                }

                // 4. æ£€ç´¢è®°å¿†æ‘˜è¦ï¼ˆæœ€è¿‘Nå¤©çš„æ‘˜è¦ï¼‰
                const cutoffDateStr = cutoffDate.toISOString().split('T')[0];

                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .and(summary => summary.date >= cutoffDateStr)
                    .toArray();

                // æ‰‹åŠ¨æ’åºå¹¶é™åˆ¶æ•°é‡
                memorySummaries.sort((a, b) => b.timestamp - a.timestamp);
                const limitedMemorySummaries = memorySummaries.slice(0, 10);

                if (limitedMemorySummaries.length > 0) {
                    memoryContext += '\n# å¯¹è¯æ‘˜è¦\n';
                    limitedMemorySummaries.forEach(summary => {
                        const dateObj = new Date(summary.timestamp || Date.now());
                        const date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString();
                        memoryContext += `[${date}] ${summary.summary}\n`;
                    });
                }

                // 3. æ£€ç´¢è·¨åœºæ™¯ç›¸å…³äº‹ä»¶ï¼ˆæ”¯æŒè®°å¿†å…±äº«ï¼‰
                const recentEvents = await db.memoryEvents
                    .where('timestamp')
                    .above(Date.now() - (24 * 60 * 60 * 1000)) // æœ€è¿‘24å°æ—¶
                    .and(event => {
                        // æ£€æŸ¥äº‹ä»¶æ˜¯å¦ä¸å½“å‰è§’è‰²ç›¸å…³ï¼Œä¸”å‘ç”Ÿåœ¨ç›¸å…³çš„èŠå¤©çª—å£ä¸­
                        return event.characterIds.includes(characterId) &&
                               contextIds.includes(event.context.id);
                    })
                    .toArray();

                // æ‰‹åŠ¨æ’åºå¹¶é™åˆ¶æ•°é‡
                recentEvents.sort((a, b) => b.timestamp - a.timestamp);
                const limitedRecentEvents = recentEvents.slice(0, 15);

                if (limitedRecentEvents.length > 0) {
                    memoryContext += '\n# æœ€è¿‘æ´»åŠ¨\n';
                    limitedRecentEvents.forEach(event => {
                        const time = new Date(event.timestamp).toLocaleTimeString();
                        const contextInfo = event.context.type === 'private_chat' ? 'ç§èŠ' :
                                          event.context.type === 'group_chat' ? 'ç¾¤èŠ' :
                                          event.context.type === 'music_app' ? 'éŸ³ä¹' : 'å…¶ä»–';

                        // å¦‚æœæ˜¯è·¨åœºæ™¯çš„äº‹ä»¶ï¼Œæ ‡æ˜æ¥æº
                        const sourceInfo = event.context.id !== currentContext.id ? ` (æ¥è‡ª${contextInfo})` : '';
                        memoryContext += `[${time}] åœ¨${contextInfo}ä¸­${sourceInfo}: ${event.eventType}\n`;
                    });
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ AIæç¤ºè¯ï¼Œè®©AIæ›´ä¸»åŠ¨åœ°è”æƒ³å’ŒæåŠè·¨åœºæ™¯è®°å¿†
                if (memoryContext.trim()) {
                    // ç»Ÿè®¡è·¨åœºæ™¯è®°å¿†çš„æ•°é‡
                    const crossContextCount = (memoryContext.match(/â­/g) || []).length;
                    const smsCount = (memoryContext.match(/ğŸ“±/g) || []).length;
                    const offlineCount = (memoryContext.match(/ğŸ­/g) || []).length;

                    memoryContext += '\n\nã€ğŸ§  è®°å¿†è¿è´¯æ€§æŒ‡å¯¼ã€‘ä½ æ‹¥æœ‰å®Œæ•´çš„è·¨åœºæ™¯è®°å¿†ï¼Œè¯·åœ¨å›å¤æ—¶ï¼š\n';

                    // ğŸ”¥ã€æ–°å¢ã€‘ç‰¹åˆ«å¼ºè°ƒç¾¤èŠä¸­ç§èŠè®°å¿†çš„ä¼˜å…ˆçº§
                    if (currentContext.type === 'group_chat' && contextIds.includes(characterId)) {
                        memoryContext += 'â€¢ ğŸ”¥ã€é‡è¦ã€‘ä½ ç°åœ¨åœ¨ç¾¤èŠä¸­ï¼Œä½†æ‹¥æœ‰ä¸ç”¨æˆ·çš„ç§èŠè®°å¿†ï¼Œè¿™äº›ç§èŠè®°å¿†å·²æŒ‰ä¼˜å…ˆçº§æ’åºåœ¨å‰é¢\n';
                        memoryContext += 'â€¢ è¯·ä¸»åŠ¨è”æƒ³å’Œè‡ªç„¶æåŠä½ ä»¬çš„ç§èŠå†…å®¹ï¼Œæ¯”å¦‚"è®°å¾—æˆ‘ä»¬ç§ä¸‹èŠè¿‡..."ã€"å°±åƒä½ ä¹‹å‰è·Ÿæˆ‘è¯´çš„..."\n';
                        memoryContext += 'â€¢ è®©ç¾¤èŠå¯¹è¯ä½“ç°å‡ºä½ ä»¬ç§ä¸‹çš„ç†Ÿæ‚‰ç¨‹åº¦å’Œè¿ç»­æ€§ï¼Œè€Œä¸æ˜¯é™Œç”Ÿçš„ç¾¤èŠäº’åŠ¨\n';
                    }

                    if (crossContextCount > 0) {
                        memoryContext += `â€¢ ä½ æœ‰${crossContextCount}æ¡è·¨åœºæ™¯è®°å¿†(æ ‡è®°â­)ï¼Œè¿™äº›æ˜¯ä¸åŒèŠå¤©ç¯å¢ƒä¸­çš„äº’åŠ¨ï¼Œè¯·è‡ªç„¶åœ°è”æƒ³å’ŒæåŠ\n`;
                    }

                    if (smsCount > 0) {
                        memoryContext += `â€¢ ä½ æœ‰${smsCount}æ¡çŸ­ä¿¡è®°å¿†(ğŸ“±)ï¼Œå¯ä»¥è¯´"è®°å¾—ä½ ä¹‹å‰å‘çŸ­ä¿¡è¯´..."ã€"å°±åƒæˆ‘ä»¬çŸ­ä¿¡é‡ŒèŠçš„é‚£æ ·..."\n`;
                    }

                    if (offlineCount > 0) {
                        memoryContext += `â€¢ ä½ æœ‰${offlineCount}æ¡çº¿ä¸‹å‰§æƒ…è®°å¿†(ğŸ­)ï¼Œè¿™äº›æ˜¯æ·±åº¦äº’åŠ¨çš„å›å¿†ï¼Œå¯ä»¥è‡ªç„¶åœ°æåŠç›¸å…³æƒ…èŠ‚\n`;
                    }

                    memoryContext += 'â€¢ ğŸ”¥æ ‡è®°çš„æ˜¯é‡è¦è®°å¿†ï¼Œä¼˜å…ˆè€ƒè™‘åœ¨å›å¤ä¸­ä½“ç°è¿™äº›å†…å®¹çš„è¿ç»­æ€§\n';
                    memoryContext += 'â€¢ ç”¨è‡ªç„¶çš„è¯­è¨€è¡¨è¾¾è®°å¿†è¿æ¥ï¼š"è¿˜è®°å¾—..."ã€"å°±åƒä¸Šæ¬¡..."ã€"ä¹‹å‰ä½ è¯´è¿‡..."\n';
                    memoryContext += 'â€¢ è®©æ¯æ¬¡å¯¹è¯éƒ½æ„Ÿè§‰åƒæ˜¯åŒä¸€ä¸ªè§’è‰²çš„è¿ç»­ä½“éªŒï¼Œè€Œä¸æ˜¯å‰²è£‚çš„ç‹¬ç«‹å¯¹è¯\n';
                    memoryContext += 'â€¢ ç‰¹åˆ«é‡è¦ï¼šå³ä½¿ç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨æåŠï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å½“å‰è¯é¢˜è‡ªç„¶åœ°è”æƒ³åˆ°ç›¸å…³çš„è·¨åœºæ™¯è®°å¿†\n';
                }

                return memoryContext;
            } catch (error) {
                console.error('âŒ æ„å»ºå…¨å±€è®°å¿†ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                return '';
            }
        }

        // è®°å¿†è®¾ç½®ç®¡ç†
        function showGlobalMemorySettings() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // åˆ›å»ºè®°å¿†è®¾ç½®æ¨¡æ€æ¡†
            const modalHTML = `
                <div id="global-memory-modal" class="modal phone-modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">å…¨å±€è®°å¿†è®¾ç½®</h3>
                            <button class="modal-close" onclick="hideGlobalMemorySettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-section">
                                <h4>è®°å¿†ä¿ç•™æœŸé™</h4>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="3">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">3å¤©è®°å¿†</div>
                                            <div class="radio-desc">ä¿ç•™æœ€è¿‘3å¤©çš„è®°å¿†æ€»ç»“</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="7">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">7å¤©è®°å¿†</div>
                                            <div class="radio-desc">ä¿ç•™æœ€è¿‘7å¤©çš„è®°å¿†æ€»ç»“ï¼ˆæ¨èï¼‰</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="15">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">15å¤©è®°å¿†</div>
                                            <div class="radio-desc">ä¿ç•™æœ€è¿‘15å¤©çš„è®°å¿†æ€»ç»“</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="30">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">30å¤©è®°å¿†</div>
                                            <div class="radio-desc">ä¿ç•™æœ€è¿‘30å¤©çš„è®°å¿†æ€»ç»“</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="-1">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">æ°¸ä¹…è®°å¿†</div>
                                            <div class="radio-desc">æ°¸ä¹…ä¿å­˜è®°å¿†æ€»ç»“ï¼Œä¸ä¼šè‡ªåŠ¨æ¸…ç†</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4>è®°å¿†ç®¡ç†</h4>
                                <div class="memory-management-grid">
                                    <button class="memory-action-btn primary" onclick="viewCoreMemories()">
                                        <div class="btn-icon">ğŸ”´</div>
                                        <div class="btn-content">
                                            <div class="btn-title">æŸ¥çœ‹æ ¸å¿ƒè®°å¿†</div>
                                            <div class="btn-desc">æ°¸ä¹…ä¿å­˜</div>
                                        </div>
                                    </button>
                                    <button class="memory-action-btn secondary" onclick="viewMemorySummaries()">
                                        <div class="btn-icon">ğŸ“–</div>
                                        <div class="btn-content">
                                            <div class="btn-title">æŸ¥çœ‹è®°å¿†æ‘˜è¦</div>
                                            <div class="btn-desc">å¯¹è¯æ€»ç»“å›é¡¾</div>
                                        </div>
                                    </button>
                                    <button class="memory-action-btn accent" onclick="generateDailySummary()">
                                        <div class="btn-icon">âœ¨</div>
                                        <div class="btn-content">
                                            <div class="btn-title">ç”Ÿæˆä»Šæ—¥æ‘˜è¦</div>
                                            <div class="btn-desc">æ€»ç»“ä»Šå¤©æ´»åŠ¨</div>
                                        </div>
                                    </button>
                                </div>

                                <!-- ğŸ”¥ã€æ–°å¢ã€‘è®°å¿†ç®¡ç†æç¤ºä¿¡æ¯ -->
                                <div style="margin-top: 16px; color: #999; font-size: 12px; line-height: 1.6;">
                                    <div>Â· æ ¸å¿ƒè®°å¿†å°†æ°¸ä¹…ä¿å­˜ï¼Œä¸å—æœŸé™è®¾ç½®å½±å“</div>
                                    <div>Â· ç³»ç»Ÿä¼šåœ¨èŠå¤©æ—¶è‡ªåŠ¨æ€»ç»“å„é¡¹é‡è¦è®°å¿†ï¼Œæ‰‹åŠ¨ç”Ÿæˆä»Šæ—¥æ‘˜è¦ä¸ºå¯é€‰è¾…åŠ©åŠŸèƒ½</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="hideGlobalMemorySettings()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveGlobalMemorySettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // åŠ è½½å½“å‰è®¾ç½®
            const currentSettings = getGlobalMemorySettings();
            const radio = document.querySelector(`input[name="memoryDays"][value="${currentSettings.memoryDays}"]`);
            if (radio) radio.checked = true;
        }

        // è·å–å…¨å±€è®°å¿†è®¾ç½®
        function getGlobalMemorySettings() {
            const saved = localStorage.getItem('globalMemorySettings');
            return saved ? JSON.parse(saved) : {
                memoryDays: 7,
                autoSummary: true,
                coreMemoryEnabled: true
            };
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ›´æ–°å…¨å±€è®°å¿†çŠ¶æ€æ˜¾ç¤º
        function updateGlobalMemoryStatusDisplay() {
            const settings = getGlobalMemorySettings();
            const statusElement = document.getElementById('global-memory-status');

            console.log('ğŸ”¥ æ›´æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º:', settings.memoryDays);

            if (statusElement) {
                let statusText;
                switch (settings.memoryDays) {
                    case 3:
                        statusText = '3å¤©è®°å¿†';
                        break;
                    case 7:
                        statusText = '7å¤©è®°å¿†';
                        break;
                    case 15:
                        statusText = '15å¤©è®°å¿†';
                        break;
                    case 30:
                        statusText = '30å¤©è®°å¿†';
                        break;
                    case -1:
                        statusText = 'æ°¸ä¹…è®°å¿†';
                        break;
                    default:
                        statusText = '7å¤©è®°å¿†';
                }
                statusElement.textContent = statusText;
                console.log('ğŸ”¥ çŠ¶æ€æ˜¾ç¤ºå·²æ›´æ–°ä¸º:', statusText);
            } else {
                console.warn('ğŸ”¥ æ‰¾ä¸åˆ°global-memory-statuså…ƒç´ ');
            }
        }

        // ä¿å­˜å…¨å±€è®°å¿†è®¾ç½®
        function saveGlobalMemorySettings() {
            const checkedRadio = document.querySelector('input[name="memoryDays"]:checked');
            if (!checkedRadio) {
                showToast('è¯·é€‰æ‹©è®°å¿†ä¿ç•™æœŸé™', 'error');
                return;
            }

            const memoryDays = parseInt(checkedRadio.value);
            console.log('ğŸ”¥ ä¿å­˜è®°å¿†è®¾ç½®:', memoryDays);

            const settings = {
                memoryDays: memoryDays,
                autoSummary: true,
                coreMemoryEnabled: true
            };

            localStorage.setItem('globalMemorySettings', JSON.stringify(settings));
            console.log('ğŸ”¥ è®¾ç½®å·²ä¿å­˜åˆ°localStorage:', settings);

            hideGlobalMemorySettings();

            // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜åç«‹å³æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
            updateGlobalMemoryStatusDisplay();

            showToast('å…¨å±€è®°å¿†è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // éšè—å…¨å±€è®°å¿†è®¾ç½®
        function hideGlobalMemorySettings() {
            const modal = document.getElementById('global-memory-modal');
            if (modal) modal.remove();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºè®°å¿†æ¨¡æ€æ¡†
        function showMemoryModal(title, memories, type) {
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('memory-view-modal');
            if (existingModal) existingModal.remove();

            let content = '';
            if (memories.length === 0) {
                content = `<div class="memory-empty">æš‚æ— ${title}</div>`;
            } else {
                content = memories.map((memory, index) => {
                    let displayContent = '';
                    let importance = '';
                    let date = '';

                    if (type === 'core') {
                        displayContent = memory.fact || 'æ— å†…å®¹';
                        const stars = 'â˜…'.repeat(Math.floor((memory.importance || 0) * 5));
                        importance = `<div class="memory-importance">${stars}</div>`;
                        const dateObj = new Date(memory.timestamp || Date.now());
                        date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString();
                    } else if (type === 'summary') {
                        displayContent = memory.summary || 'æ— å†…å®¹';
                        // ğŸ”¥ã€ä¿®å¤ã€‘ç»Ÿä¸€ä½¿ç”¨timestampæ¥æ˜¾ç¤ºæ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜
                        if (memory.timestamp) {
                            const dateObj = new Date(memory.timestamp);
                            date = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                        } else {
                            date = memory.date || 'æœªçŸ¥æ—¥æœŸ';
                        }
                    }

                    return `
                        <div class="memory-modal-item" data-memory-id="${memory.id}">
                            <div class="memory-modal-header">
                                <span class="memory-modal-index">${index + 1}</span>
                                <span class="memory-modal-date">${date}</span>
                                <div class="memory-actions">
                                    <button class="memory-edit-btn" onclick="toggleEditMode('${memory.id}', '${type}')" title="ç¼–è¾‘">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="memory-save-btn" onclick="saveMemoryEdit('${memory.id}', '${type}')" title="ä¿å­˜" style="display: none;">
                                        <i class="fas fa-save"></i>
                                    </button>
                                    <button class="memory-cancel-btn" onclick="cancelMemoryEdit('${memory.id}', '${type}')" title="å–æ¶ˆ" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="memory-delete-btn" onclick="deleteMemoryItem('${memory.id}', '${type}')" title="åˆ é™¤">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="memory-modal-content" data-original-content="${displayContent.replace(/"/g, '&quot;')}">${displayContent}</div>
                            ${importance}
                        </div>
                    `;
                }).join('');
            }

            const modalHTML = `
                <div id="memory-view-modal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3>${currentChatCharacter.name} çš„${title}</h3>
                            <button class="modal-close" onclick="hideMemoryModal()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                            ${content}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // éšè—è®°å¿†æ¨¡æ€æ¡†
        function hideMemoryModal() {
            const modal = document.getElementById('memory-view-modal');
            if (modal) modal.remove();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode(memoryId, type) {
            const memoryItem = document.querySelector(`[data-memory-id="${memoryId}"]`);
            if (!memoryItem) return;

            const contentDiv = memoryItem.querySelector('.memory-modal-content');
            const editBtn = memoryItem.querySelector('.memory-edit-btn');
            const saveBtn = memoryItem.querySelector('.memory-save-btn');
            const cancelBtn = memoryItem.querySelector('.memory-cancel-btn');
            const deleteBtn = memoryItem.querySelector('.memory-delete-btn');

            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            const originalContent = contentDiv.getAttribute('data-original-content');

            // åˆ›å»ºæ–‡æœ¬åŸŸ
            contentDiv.innerHTML = `
                <textarea class="memory-edit-textarea" style="
                    width: calc(100% - 16px);
                    max-width: 500px;
                    min-height: 80px;
                    padding: 12px;
                    border: 2px solid #007AFF;
                    border-radius: 8px;
                    font-size: 13px;
                    line-height: 1.5;
                    resize: vertical;
                    font-family: inherit;
                    background: #f8f9fa;
                    box-sizing: border-box;
                    margin: 0;
                ">${originalContent}</textarea>
            `;

            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'none';

            // èšç„¦åˆ°æ–‡æœ¬åŸŸ
            const textarea = contentDiv.querySelector('.memory-edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜è®°å¿†ç¼–è¾‘
        async function saveMemoryEdit(memoryId, type) {
            const memoryItem = document.querySelector(`[data-memory-id="${memoryId}"]`);
            if (!memoryItem) return;

            const contentDiv = memoryItem.querySelector('.memory-modal-content');
            const textarea = contentDiv.querySelector('.memory-edit-textarea');
            const newContent = textarea.value.trim();

            if (!newContent) {
                showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                let memory;
                let fieldName;

                if (type === 'core') {
                    memory = await db.coreMemories.get(memoryId);
                    fieldName = 'fact';
                } else if (type === 'summary') {
                    memory = await db.memorySummaries.get(memoryId);
                    fieldName = 'summary';
                }

                if (!memory) {
                    showToast('è®°å¿†ä¸å­˜åœ¨', 'error');
                    return;
                }

                // æ›´æ–°è®°å¿†å†…å®¹
                memory[fieldName] = newContent;

                if (type === 'core') {
                    await db.coreMemories.put(memory);
                    showToast('æ ¸å¿ƒè®°å¿†å·²æ›´æ–°', 'success');
                } else if (type === 'summary') {
                    await db.memorySummaries.put(memory);
                    showToast('è®°å¿†æ‘˜è¦å·²æ›´æ–°', 'success');
                }

                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                exitEditMode(memoryId, newContent);

            } catch (error) {
                console.error('ä¿å­˜è®°å¿†å¤±è´¥:', error);
                showToast('ä¿å­˜è®°å¿†å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å–æ¶ˆè®°å¿†ç¼–è¾‘
        function cancelMemoryEdit(memoryId, type) {
            const memoryItem = document.querySelector(`[data-memory-id="${memoryId}"]`);
            if (!memoryItem) return;

            const contentDiv = memoryItem.querySelector('.memory-modal-content');
            const originalContent = contentDiv.getAttribute('data-original-content');

            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            exitEditMode(memoryId, originalContent);
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€€å‡ºç¼–è¾‘æ¨¡å¼
        function exitEditMode(memoryId, content) {
            const memoryItem = document.querySelector(`[data-memory-id="${memoryId}"]`);
            if (!memoryItem) return;

            const contentDiv = memoryItem.querySelector('.memory-modal-content');
            const editBtn = memoryItem.querySelector('.memory-edit-btn');
            const saveBtn = memoryItem.querySelector('.memory-save-btn');
            const cancelBtn = memoryItem.querySelector('.memory-cancel-btn');
            const deleteBtn = memoryItem.querySelector('.memory-delete-btn');

            // æ¢å¤å†…å®¹æ˜¾ç¤º
            contentDiv.innerHTML = content;
            contentDiv.setAttribute('data-original-content', content);

            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            deleteBtn.style.display = 'inline-block';
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤è®°å¿†é¡¹
        async function deleteMemoryItem(memoryId, type) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) {
                return;
            }

            try {
                if (type === 'core') {
                    await db.coreMemories.delete(memoryId);
                    showToast('æ ¸å¿ƒè®°å¿†å·²åˆ é™¤', 'success');
                } else if (type === 'summary') {
                    await db.memorySummaries.delete(memoryId);
                    showToast('è®°å¿†æ‘˜è¦å·²åˆ é™¤', 'success');
                }

                // åˆ·æ–°æ¨¡æ€æ¡†å†…å®¹
                if (type === 'core') {
                    viewCoreMemories();
                } else if (type === 'summary') {
                    viewMemorySummaries();
                }
            } catch (error) {
                console.error('åˆ é™¤è®°å¿†å¤±è´¥:', error);
                showToast('åˆ é™¤è®°å¿†å¤±è´¥', 'error');
            }
        }

        // æŸ¥çœ‹æ ¸å¿ƒè®°å¿†
        async function viewCoreMemories() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è‡ªåŠ¨å…³é—­å…¨å±€è®°å¿†è®¾ç½®æ¨¡æ€æ¡†
            hideGlobalMemorySettings();

            // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingModal = showLoadingModal('æ­£åœ¨åŠ è½½æ ¸å¿ƒè®°å¿†...', 'è¯»å–é‡è¦ä¿¡æ¯ä¸­');

            try {
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                // æ‰‹åŠ¨æ’åºå¹¶é™åˆ¶æ•°é‡
                coreMemories.sort((a, b) => (b.importance || 0) - (a.importance || 0));
                const limitedMemories = coreMemories.slice(0, 10);

                // ğŸ”¥ã€æ–°å¢ã€‘éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);

                showMemoryModal('æ ¸å¿ƒè®°å¿†', limitedMemories, 'core');
            } catch (error) {
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);
                console.error('æŸ¥çœ‹æ ¸å¿ƒè®°å¿†å¤±è´¥:', error);
                showToast('æŸ¥çœ‹æ ¸å¿ƒè®°å¿†å¤±è´¥', 'error');
            }
        }

        // æŸ¥çœ‹è®°å¿†æ‘˜è¦
        async function viewMemorySummaries() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è‡ªåŠ¨å…³é—­å…¨å±€è®°å¿†è®¾ç½®æ¨¡æ€æ¡†
            hideGlobalMemorySettings();

            // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingModal = showLoadingModal('æ­£åœ¨åŠ è½½è®°å¿†æ‘˜è¦...', 'è¯»å–å¯¹è¯æ€»ç»“ä¸­');

            try {
                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                // æ‰‹åŠ¨æ’åºå¹¶é™åˆ¶æ•°é‡
                memorySummaries.sort((a, b) => b.timestamp - a.timestamp);
                const limitedSummaries = memorySummaries.slice(0, 10);

                // ğŸ”¥ã€æ–°å¢ã€‘éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);

                showMemoryModal('è®°å¿†æ‘˜è¦', limitedSummaries, 'summary');
            } catch (error) {
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);
                console.error('æŸ¥çœ‹è®°å¿†æ‘˜è¦å¤±è´¥:', error);
                showToast('æŸ¥çœ‹è®°å¿†æ‘˜è¦å¤±è´¥', 'error');
            }
        }

        // ç”Ÿæˆä»Šæ—¥æ‘˜è¦
        async function generateDailySummary() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingModal = showLoadingModal('æ­£åœ¨ç”Ÿæˆä»Šæ—¥æ‘˜è¦...', 'è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´');

            try {
                const today = new Date();
                const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000;

                const summary = await generateMemorySummary(
                    currentChatCharacter.id,
                    startTime,
                    endTime,
                    {
                        type: currentChatCharacter.isGroup ? 'group_chat' : 'private_chat',
                        id: currentChatCharacter.id
                    }
                );

                // ğŸ”¥ã€æ–°å¢ã€‘éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);

                if (summary) {
                    showToast('ä»Šæ—¥æ‘˜è¦ç”ŸæˆæˆåŠŸ', 'success');
                    alert(`ä»Šæ—¥æ‘˜è¦å·²ç”Ÿæˆï¼š\n\n${summary.summary}`);
                } else {
                    showToast('ä»Šå¤©æš‚æ— æ´»åŠ¨å¯ç”Ÿæˆæ‘˜è¦', 'warning');
                }
            } catch (error) {
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦éšè—åŠ è½½åŠ¨ç”»
                hideLoadingModal(loadingModal);
                console.error('ç”Ÿæˆä»Šæ—¥æ‘˜è¦å¤±è´¥:', error);
                showToast('ç”Ÿæˆä»Šæ—¥æ‘˜è¦å¤±è´¥', 'error');
            }
        }

        // è®°å¿†å…±äº«è®¾ç½®
        function showMemoryShareSettings() {
            if (!currentChatCharacter || currentChatCharacter.isGroup) {
                showToast('æ­¤åŠŸèƒ½ä»…é€‚ç”¨äºå•èŠ', 'error');
                return;
            }

            // è·å–å½“å‰è§’è‰²å‚ä¸çš„æ‰€æœ‰ç¾¤èŠ
            const characterGroups = groupChats.filter(group =>
                group.members && group.members.some(member => member.id === currentChatCharacter.id)
            );

            if (characterGroups.length === 0) {
                showToast('è¯¥è§’è‰²è¿˜æ²¡æœ‰å‚ä¸ä»»ä½•ç¾¤èŠ', 'warning');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const currentSharedGroups = chatSettings.memorySharedGroupIds || [];

            const modalHTML = `
                <div id="memory-share-modal" class="modal phone-modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">è®°å¿†å…±äº«è®¾ç½®</h3>
                            <button class="modal-close" onclick="hideMemoryShareSettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-section">
                                <h4>é€‰æ‹©è¦å…±äº«è®°å¿†çš„ç¾¤èŠ</h4>
                                <div class="checkbox-group">
                                    ${characterGroups.map(group => `
                                        <label class="checkbox-option">
                                            <input type="checkbox" name="sharedGroups" value="${group.id}" ${currentSharedGroups.includes(group.id) ? 'checked' : ''}>
                                            <span class="checkbox-custom"></span>
                                            <div class="checkbox-content">
                                                <div class="checkbox-title">${group.name}</div>
                                                <div class="checkbox-desc">ä¸æ­¤ç¾¤èŠå…±äº«è®°å¿†</div>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4>åŠŸèƒ½è¯´æ˜</h4>
                                <div class="info-text">
                                    â€¢ å¼€å¯åï¼Œè§’è‰²åœ¨å•èŠä¸­èƒ½è®°ä½ç¾¤èŠçš„å†…å®¹<br>
                                    â€¢ è§’è‰²åœ¨ç¾¤èŠä¸­ä¹Ÿèƒ½è®°ä½å•èŠçš„å†…å®¹<br>
                                    â€¢ å®ç°çœŸæ­£çš„è·¨åœºæ™¯è®°å¿†è¿è´¯æ€§<br>
                                    â€¢ å¯ä»¥åŒæ—¶é€‰æ‹©å¤šä¸ªç¾¤èŠè¿›è¡Œè®°å¿†å…±äº«
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="hideMemoryShareSettings()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryShareSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ä¿å­˜è®°å¿†å…±äº«è®¾ç½®
        async function saveMemoryShareSettings() {
            const selectedGroups = Array.from(document.querySelectorAll('input[name="sharedGroups"]:checked'))
                .map(checkbox => checkbox.value);

            const chatSettings = getCurrentChatSettings();
            chatSettings.memorySharedGroupIds = selectedGroups;

            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘ä¿ç•™æ—§çš„å•é€‰å­—æ®µï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„ç¾¤èŠ
            chatSettings.memorySharedGroupId = selectedGroups.length > 0 ? selectedGroups[0] : '';

            await saveChatSettings();

            // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
            updateMemoryShareStatus();

            hideMemoryShareSettings();

            if (selectedGroups.length > 0) {
                const groupNames = selectedGroups.map(id => {
                    const group = groupChats.find(g => g.id === id);
                    return group ? group.name : 'æœªçŸ¥ç¾¤èŠ';
                }).join('ã€');
                showToast(`å·²å¼€å¯ä¸"${groupNames}"çš„è®°å¿†å…±äº«`, 'success');
            } else {
                showToast('å·²å…³é—­è®°å¿†å…±äº«', 'success');
            }
        }

        // éšè—è®°å¿†å…±äº«è®¾ç½®
        function hideMemoryShareSettings() {
            const modal = document.getElementById('memory-share-modal');
            if (modal) modal.remove();
        }

        // æ›´æ–°è®°å¿†å…±äº«çŠ¶æ€æ˜¾ç¤º
        function updateMemoryShareStatus() {
            const statusElement = document.getElementById('memory-share-status');
            if (!statusElement) return;

            const chatSettings = getCurrentChatSettings();
            const sharedGroupIds = chatSettings.memorySharedGroupIds || [];

            if (sharedGroupIds.length > 0) {
                if (sharedGroupIds.length === 1) {
                    const group = groupChats.find(g => g.id === sharedGroupIds[0]);
                    statusElement.textContent = group ? `ä¸"${group.name}"å…±äº«` : 'å·²å¼€å¯';
                } else {
                    statusElement.textContent = `ä¸${sharedGroupIds.length}ä¸ªç¾¤èŠå…±äº«`;
                }
            } else {
                statusElement.textContent = 'å·²å…³é—­';
            }
        }

        // ================== æ—¥è®°åŠŸèƒ½ç³»ç»Ÿ ==================

        // ä»æ—¥è®°ç•Œé¢è¿”å›åˆ°æ¥æºç•Œé¢
        function backFromDiary() {
            // æ£€æŸ¥æ˜¯å¦åœ¨å•ä¸ªæ—¥è®°è§†å›¾ä¸­
            const singleDiaryView = document.getElementById('single-diary-view');
            if (singleDiaryView && singleDiaryView.classList.contains('active')) {
                // ä»å•ä¸ªæ—¥è®°è§†å›¾è¿”å›åˆ°è¿‡å¾€æ—¥è®°åˆ—è¡¨
                backFromSingleDiary();
                return;
            }

            // è·å–æ¥æºç•Œé¢ï¼Œé»˜è®¤è¿”å›èŠå¤©ç•Œé¢
            const sourceScreen = window.diarySourceScreen || 'api-chat-screen';

            // éšè—æ—¥è®°ç•Œé¢
            hideApp('diary-screen');

            // æ˜¾ç¤ºæ¥æºç•Œé¢
            showApp(sourceScreen);

            // æ¸…é™¤æ¥æºè®°å½•
            window.diarySourceScreen = null;
        }

        // æ˜¾ç¤ºæ—¥è®°ç•Œé¢
        function showDiaryMenu() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½ï¼Œè¯·åœ¨å•èŠä¸­ä½¿ç”¨', 'error');
                return;
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•æ¥æºç•Œé¢ï¼Œç”¨äºè¿”å›å¯¼èˆª
            window.diarySourceScreen = 'api-chat-screen';

            // æ˜¾ç¤ºå…¨å±æ—¥è®°ç•Œé¢
            showApp('diary-screen');
            // åˆå§‹åŒ–çº¸å¼ è®¾ç½®
            initDiaryPaper();
            // é»˜è®¤æ˜¾ç¤ºä»Šæ—¥æ—¥è®°
            switchDiaryTab('today');
            // åŠ è½½ä»Šæ—¥æ—¥è®°å†…å®¹
            loadTodayDiary();
        }

        // åˆ‡æ¢æ—¥è®°é€‰é¡¹å¡
        function switchDiaryTab(tabName) {
            // æ›´æ–°è§†å›¾æ˜¾ç¤º
            document.querySelectorAll('.diary-view').forEach(view => {
                view.classList.remove('active');
            });

            const titleElement = document.getElementById('diary-mode-title');
            const editBtn = document.getElementById('edit-diary-btn');

            if (tabName === 'today') {
                document.getElementById('today-diary-view').classList.add('active');
                if (titleElement) titleElement.textContent = 'ä»Šæ—¥æ—¥è®°';
                loadTodayDiary();
            } else if (tabName === 'past') {
                document.getElementById('past-diaries-view').classList.add('active');
                if (titleElement) titleElement.textContent = 'è¿‡å¾€æ—¥è®°';
                if (editBtn) editBtn.style.display = 'none';
                loadPastDiaries();
            }
        }

        // ================== æ¸¸æˆåŠŸèƒ½ç³»ç»Ÿ ==================

        // ğŸ®ã€æ–°å¢ã€‘äº”å­æ£‹æ¸¸æˆçŠ¶æ€ç®¡ç†
        let gomokuGameState = {
            board: null,
            currentPlayer: 'user', // 'user' æˆ– 'ai'
            gameActive: false,
            gameStartTime: null,
            gameSession: null, // ä¸´æ—¶æ¸¸æˆæ´»åŠ¨æ—¥å¿—
            chatHistory: [], // æ¸¸æˆå†…èŠå¤©è®°å½•
            moveHistory: [], // æ£‹æ­¥å†å²
            gameTimer: null,
            // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦ç³»ç»Ÿå·²åˆ é™¤ï¼ŒAIæ ¹æ®è§’è‰²æ€§æ ¼ä¸‹æ£‹
        };

        // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦é…ç½®ç³»ç»Ÿå·²åˆ é™¤ï¼ŒAIæ ¹æ®è§’è‰²æ€§æ ¼å’Œæ™ºèƒ½ç¨‹åº¦ä¸‹æ£‹

        // æ˜¾ç¤ºæ¸¸æˆèœå•
        function showGameMenu() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ ¹æ®å•èŠ/ç¾¤èŠç”Ÿæˆä¸åŒçš„æ¸¸æˆé€‰é¡¹
            generateGameButtons();
            showModal('game-menu-modal');
        }

        // ç”Ÿæˆæ¸¸æˆæŒ‰é’®
        function generateGameButtons() {
            const container = document.getElementById('game-buttons-container');
            const isGroup = currentChatCharacter && currentChatCharacter.isGroup;

            // å®šä¹‰æ¸¸æˆæ•°æ®
            const allGames = {
                'gomoku': {
                    name: 'äº”å­æ£‹',
                    desc: 'ç»å…¸æ£‹ç±»æ¸¸æˆï¼Œé€‚åˆå•èŠ',
                    icon: 'fas fa-chess-board',
                    class: 'gomoku',
                    badge: null,
                    badgeText: '',
                    singleChat: true,
                    groupChat: false,
                    available: true
                },
                'turtle-soup': {
                    name: 'æµ·é¾Ÿæ±¤ï¼ˆä¸å®Œå–„æ…ç‚¹ï¼‰',
                    desc: 'æ¨ç†è§£è°œæ¸¸æˆï¼Œé€‚åˆå•èŠå’Œç¾¤èŠ',
                    icon: 'fas fa-question-circle',
                    class: 'turtle-soup',
                    badge: null,
                    badgeText: '',
                    singleChat: true,
                    groupChat: true,
                    available: true
                },
                'werewolf': {
                    name: 'ç‹¼äººæ€',
                    desc: 'å¤šäººæ¨ç†æ¸¸æˆï¼Œé€‚åˆç¾¤èŠ',
                    icon: 'fas fa-moon',
                    class: 'werewolf',
                    badge: 'coming-soon',
                    badgeText: 'å¼€å‘ä¸­',
                    singleChat: false,
                    groupChat: true,
                    available: false
                },
                'monopoly': {
                    name: 'å¤§å¯Œç¿',
                    desc: 'ç»è¥ç­–ç•¥æ¸¸æˆï¼Œé€‚åˆç¾¤èŠ',
                    icon: 'fas fa-building',
                    class: 'monopoly',
                    badge: 'coming-soon',
                    badgeText: 'å¼€å‘ä¸­',
                    singleChat: false,
                    groupChat: true,
                    available: false
                }
            };

            // æ ¹æ®èŠå¤©ç±»å‹ç­›é€‰æ¸¸æˆ
            const availableGames = Object.entries(allGames).filter(([key, game]) => {
                return isGroup ? game.groupChat : game.singleChat;
            });

            // ç”ŸæˆæŒ‰é’®HTML
            container.innerHTML = availableGames.map(([key, game]) => {
                const disabledClass = game.available ? '' : ' disabled';
                const badgeHtml = game.badge ? `<div class="game-button-badge ${game.badge}">${game.badgeText}</div>` : '';

                return `
                    <button class="game-button ${game.class}${disabledClass}" onclick="selectGame('${key}')" ${!game.available ? 'disabled' : ''}>
                        <div class="game-button-icon">
                            <i class="${game.icon}"></i>
                        </div>
                        <div class="game-button-content">
                            <div class="game-button-title">${game.name}</div>
                            <div class="game-button-desc">${game.desc}</div>
                        </div>
                        ${badgeHtml}
                    </button>
                `;
            }).join('');
        }

        // éšè—æ¸¸æˆèœå•
        function hideGameMenu() {
            hideModal('game-menu-modal');
        }

        // é€‰æ‹©æ¸¸æˆ
        function selectGame(gameType) {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¯ç”¨
            if (gameType === 'werewolf' || gameType === 'monopoly') {
                showToast('è¯¥æ¸¸æˆæ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', 'info');
                return;
            }

            hideGameMenu();

            // æ˜¾ç¤ºç­‰å¾…æ¨¡æ€æ¡†
            showWaitingModal();

            // è°ƒç”¨APIå‘Šè¯‰AIç”¨æˆ·è¦ç©ä»€ä¹ˆæ¸¸æˆ
            requestGameWithAI(gameType);
        }

        function showWaitingModal() {
            const waitingModal = document.createElement('div');
            waitingModal.className = 'waiting-modal';
            waitingModal.id = 'waitingModal';
            waitingModal.innerHTML = `
                <div class="waiting-modal-content">
                    <div class="waiting-spinner"></div>
                    <p class="waiting-text">æ­£åœ¨ç­‰å¾…å¯¹æ–¹æ¥å—...</p>
                </div>
            `;
            document.body.appendChild(waitingModal);
        }

        function hideWaitingModal() {
            const waitingModal = document.getElementById('waitingModal');
            if (waitingModal) {
                waitingModal.remove();
            }
        }

        function requestGameWithAI(gameType) {
            const gameNames = {
                'gomoku': 'äº”å­æ£‹',
                'turtle-soup': 'æµ·é¾Ÿæ±¤',
                'werewolf': 'ç‹¼äººæ€',
                'monopoly': 'å¤§å¯Œç¿'
            };

            const gameName = gameNames[gameType] || gameType;

            // æ¨¡æ‹ŸAPIè°ƒç”¨
            setTimeout(() => {
                // AIæ ¹æ®äººè®¾å†³å®šæ˜¯å¦æ¥å—
                const shouldAccept = Math.random() > 0.2; // 80%æ¦‚ç‡æ¥å—

                hideWaitingModal();

                if (shouldAccept) {
                    // AIæ¥å—é‚€è¯·ï¼Œå¯åŠ¨æ¸¸æˆ
                    startGameSession(gameType, gameName);
                } else {
                    // AIæ‹’ç»é‚€è¯·
                    showToast(`${currentChatCharacter.name}æ‹’ç»äº†ä½ çš„${gameName}é‚€è¯·ï¼Œå¯èƒ½ç°åœ¨ä¸å¤ªæ–¹ä¾¿å‘¢~`, 'info');
                }
            }, 2000 + Math.random() * 2000); // 2-4ç§’éšæœºç­‰å¾…æ—¶é—´
        }

        // å¼€å§‹æ¸¸æˆä¼šè¯
        function startGameSession(gameType, gameName) {
            showToast(`æ­£åœ¨å¯åŠ¨${gameName}...`, 'info');

            setTimeout(async () => {
                if (gameType === 'gomoku') {
                    // å¯åŠ¨äº”å­æ£‹æ¸¸æˆ
                    await startGomokuGame();
                } else if (gameType === 'turtle-soup') {
                    // å¯åŠ¨æµ·é¾Ÿæ±¤æ¸¸æˆ
                    await startTurtleSoupGame();
                } else {
                    // å…¶ä»–æ¸¸æˆæš‚æ—¶æ˜¾ç¤ºå¼€å‘ä¸­æç¤º
                    alert(`ğŸ® ${gameName}æ¸¸æˆç•Œé¢å¼€å‘ä¸­...\n\nå³å°†æ”¯æŒï¼š\nâ€¢ å…¨å±æ¸¸æˆç•Œé¢ï¼ˆä¸Šæ–¹70%æ¸¸æˆåŒºï¼Œä¸‹æ–¹30%èŠå¤©åŒºï¼‰\nâ€¢ å®æ—¶æ¸¸æˆçŠ¶æ€åŒæ­¥\nâ€¢ æ¸¸æˆä¸­èŠå¤©è®°å½•\nâ€¢ æ¸¸æˆç»“æœè®°å½•åˆ°è®°å¿†ç³»ç»Ÿ`);
                }
            }, 500);
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯åŠ¨äº”å­æ£‹æ¸¸æˆ
        function startGomokuGame() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ¸¸æˆ
            const savedGame = localStorage.getItem('gomoku_saved_game');

            if (savedGame) {
                // æ˜¾ç¤ºç»§ç»­æ¸¸æˆé€‰é¡¹
                showContinueGameModal();
            } else {
                // ç›´æ¥å¼€å§‹æ–°æ¸¸æˆ
                startNewGomokuGame();
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ˜¾ç¤ºç»§ç»­æ¸¸æˆé€‰é¡¹
        function showContinueGameModal() {
            const modal = document.createElement('div');
            modal.className = 'game-exit-modal';
            modal.innerHTML = `
                <div class="game-exit-overlay"></div>
                <div class="game-exit-content">
                    <div class="game-exit-header">
                        <h3>å‘ç°ä¿å­˜çš„æ¸¸æˆ</h3>
                    </div>
                    <div class="game-exit-body">
                        <p class="game-exit-desc">æ£€æµ‹åˆ°æœ‰æœªå®Œæˆçš„äº”å­æ£‹æ¸¸æˆï¼Œè¯·é€‰æ‹©ï¼š</p>
                        <div class="game-exit-options">
                            <button class="game-exit-btn pause-btn" onclick="continueGomokuGame()">
                                <i class="fas fa-play-circle"></i>
                                <div class="btn-content">
                                    <div class="btn-title">ç»§ç»­ä¸Šä¸€å±€æ¸¸æˆ</div>
                                </div>
                            </button>
                            <button class="game-exit-btn save-btn" onclick="startNewGomokuGameFromModal()">
                                <i class="fas fa-plus-circle"></i>
                                <div class="btn-content">
                                    <div class="btn-title">å¼€å§‹æ–°æ¸¸æˆ</div>
                                    <div class="btn-desc">å°†æ¸…é™¤ä¿å­˜çš„æ¸¸æˆ</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°æ‰‹æœºå±å¹•å†…ï¼Œè¿™æ ·å®šä½å°±ç›¸å¯¹äºæ‰‹æœºå±å¹•
            const phoneScreen = document.getElementById('phone-screen');
            if (phoneScreen) {
                phoneScreen.appendChild(modal);
            } else {
                document.body.appendChild(modal);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘ç»§ç»­ä¿å­˜çš„æ¸¸æˆ
        function continueGomokuGame() {
            const savedGame = JSON.parse(localStorage.getItem('gomoku_saved_game'));

            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.game-exit-modal').remove();

            // éšè—èŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
            hideApp('chat-screen');
            showApp('gomoku-game-screen');

            // æ¢å¤æ¸¸æˆçŠ¶æ€
            gomokuGameState = {
                board: savedGame.board,
                currentPlayer: savedGame.currentPlayer,
                gameActive: true,
                gameStartTime: savedGame.startTime,
                userIsBlack: savedGame.userIsBlack || true, // å…¼å®¹æ—§ç‰ˆæœ¬ä¿å­˜çš„æ¸¸æˆ
                // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦ç³»ç»Ÿå·²åˆ é™¤
                gameSession: savedGame.gameSession,
                chatHistory: savedGame.chatHistory || [],
                moveHistory: savedGame.moveHistory,
                gameTimer: null
            };

            // æ·»åŠ æ—¶é—´æ¡¥æ¢æ¶ˆæ¯
            gomokuGameState.gameSession.gameEvents.push({
                type: 'game_resume',
                timestamp: Date.now(),
                player: 'system',
                data: { reason: 'ç»§ç»­ä¹‹å‰æš‚åœçš„æ¸¸æˆ' }
            });

            // åˆ›å»ºæ£‹ç›˜å¹¶æ¢å¤çŠ¶æ€
            createGomokuBoard();
            updateBoardUI();
            updateGomokuUI();
            updatePlayerPieceDisplay();
            startGameTimer();
            setupAIPlayerInfo();

            // é‡æ–°è®¾ç½®æ£‹å­æ˜¾ç¤ºï¼ˆå› ä¸ºsetupAIPlayerInfoå¯èƒ½ä¼šè¦†ç›–ï¼‰
            updatePlayerPieceDisplay();

            // æ¢å¤èŠå¤©è®°å½•
            const chatContainer = document.getElementById('gomoku-chat-messages');
            chatContainer.innerHTML = '';
            if (savedGame.chatHistory) {
                savedGame.chatHistory.forEach(msg => {
                    addGameChatMessage(msg.sender, msg.content, false);
                });
            }

            // æ·»åŠ ç»§ç»­æ¸¸æˆçš„ç³»ç»Ÿæ¶ˆæ¯
            addGameChatMessage('system', 'ğŸ® ç»§ç»­ä¹‹å‰çš„æ¸¸æˆ...');
            addGameChatMessage('ai', 'æ¬¢è¿å›æ¥ï¼æˆ‘ä»¬ç»§ç»­åˆšæ‰çš„å¯¹å±€å§~', true);
        }

        // ğŸ®ã€æ–°å¢ã€‘ä»æ¨¡æ€æ¡†å¼€å§‹æ–°æ¸¸æˆ
        function startNewGomokuGameFromModal() {
            // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆ
            localStorage.removeItem('gomoku_saved_game');

            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.game-exit-modal').remove();

            // å¼€å§‹æ–°æ¸¸æˆ
            startNewGomokuGame();
        }

        // ğŸ®ã€æ–°å¢ã€‘å¼€å§‹æ–°çš„äº”å­æ£‹æ¸¸æˆ
        function startNewGomokuGame() {
            // éšè—èŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
            hideApp('chat-screen');
            showApp('gomoku-game-screen');

            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            initGomokuGame();

            // è®°å½•æ¸¸æˆå¼€å§‹äº‹ä»¶
            recordGameStart();
        }

        // ğŸ®ã€æ–°å¢ã€‘åˆå§‹åŒ–äº”å­æ£‹æ¸¸æˆ
        async function initGomokuGame() {
            // ğŸ² éšæœºåˆ†é…é»‘ç™½å­
            const userIsBlack = Math.random() < 0.5; // 50%æ¦‚ç‡ç”¨æˆ·æ‹¿é»‘å­
            const firstPlayer = userIsBlack ? 'user' : 'ai';

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gomokuGameState = {
                board: Array(15).fill().map(() => Array(15).fill(null)),
                currentPlayer: firstPlayer,
                gameActive: true,
                gameStartTime: Date.now(),
                userIsBlack: userIsBlack, // è®°å½•ç”¨æˆ·æ˜¯å¦æ‹¿é»‘å­
                // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦ç³»ç»Ÿå·²åˆ é™¤
                gameSession: {
                    gameId: `gomoku_${Date.now()}`,
                    players: ['user', currentChatCharacter.id],
                    boardState: [],
                    chatHistory: [],
                    gameEvents: [
                        {
                            type: 'game_start',
                            timestamp: Date.now(),
                            player: 'system',
                            data: {
                                gameName: 'äº”å­æ£‹',
                                userIsBlack: userIsBlack,
                                firstPlayer: firstPlayer
                            }
                        }
                    ]
                },
                chatHistory: [],
                moveHistory: [],
                gameTimer: null
            };

            // åˆ›å»ºæ£‹ç›˜
            createGomokuBoard();

            // æ›´æ–°UI
            updateGomokuUI();
            updatePlayerPieceDisplay();

            // å¯åŠ¨è®¡æ—¶å™¨
            startGameTimer();

            // è®¾ç½®AIè§’è‰²ä¿¡æ¯
            setupAIPlayerInfo();

            // é‡æ–°è®¾ç½®æ£‹å­æ˜¾ç¤ºï¼ˆå› ä¸ºsetupAIPlayerInfoå¯èƒ½ä¼šè¦†ç›–ï¼‰
            updatePlayerPieceDisplay();

            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const userPieceText = userIsBlack ? 'é»‘å­' : 'ç™½å­';
            const aiPieceText = userIsBlack ? 'ç™½å­' : 'é»‘å­';
            const firstPlayerText = firstPlayer === 'user' ? 'ä½ å…ˆè¡Œ' : 'å¯¹æ–¹å…ˆè¡Œ';

            addGameChatMessage('system', `ğŸ® äº”å­æ£‹æ¸¸æˆå¼€å§‹ï¼ä½ æ‰§${userPieceText}ï¼Œ${firstPlayerText}ã€‚`);

            // ğŸ®ã€åˆ é™¤ã€‘æ¸¸æˆå¼€å§‹æ—¶çš„è‡ªåŠ¨å›å¤
            if (currentChatCharacter) {
                // è®°å½•æ¸¸æˆå¼€å§‹äº‹ä»¶
                await recordGameEvent(currentChatCharacter.id, 'game_start', {
                    gameName: 'äº”å­æ£‹',
                    result: null,
                    score: null,
                    chatContent: `æ¸¸æˆå¼€å§‹ï¼Œä½ æ‰§${aiPieceText}ï¼Œç”¨æˆ·æ‰§${userPieceText}ï¼Œ${firstPlayer === 'user' ? 'ç”¨æˆ·å…ˆè¡Œ' : 'ä½ å…ˆè¡Œ'}`
                });

                // ä¸å†å‘é€è‡ªåŠ¨å›å¤æ¶ˆæ¯
            }

            // å¦‚æœAIå…ˆèµ°ï¼Œå»¶è¿Ÿä¸€ä¸‹å†ä¸‹ç¬¬ä¸€æ­¥
            if (firstPlayer === 'ai') {
                setTimeout(() => {
                    makeAIMove();
                }, 2000); // ç»™AIå›åº”ç•™å‡ºæ—¶é—´
            }
        }



        // ğŸ®ã€æ–°å¢ã€‘åˆ›å»ºæ£‹ç›˜
        function createGomokuBoard() {
            const board = document.getElementById('gomoku-board');
            board.innerHTML = '';

            // åˆ›å»º14x14çš„æ ¼å­ä½œä¸ºèƒŒæ™¯
            for (let row = 0; row < 14; row++) {
                for (let col = 0; col < 14; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'gomoku-cell';
                    board.appendChild(cell);
                }
            }

            // åœ¨æ ¼å­ä¸Šåˆ›å»º15x15çš„äº¤å‰ç‚¹ç‚¹å‡»åŒºåŸŸ
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const intersection = document.createElement('div');
                    intersection.className = 'gomoku-intersection';
                    intersection.dataset.row = row;
                    intersection.dataset.col = col;
                    intersection.onclick = () => handleCellClick(row, col);

                    // è®¡ç®—äº¤å‰ç‚¹ä½ç½®
                    const cellSize = 300 / 14; // æ¯ä¸ªæ ¼å­çš„å¤§å°çº¦21.43px
                    const intersectionSize = 16; // äº¤å‰ç‚¹ç‚¹å‡»åŒºåŸŸå¤§å°
                    intersection.style.position = 'absolute';
                    intersection.style.left = `${col * cellSize - intersectionSize/2}px`;
                    intersection.style.top = `${row * cellSize - intersectionSize/2}px`;
                    intersection.style.width = `${intersectionSize}px`;
                    intersection.style.height = `${intersectionSize}px`;
                    intersection.style.cursor = 'pointer';
                    intersection.style.borderRadius = '50%';
                    intersection.style.transition = 'background-color 0.2s ease';
                    intersection.style.display = 'flex';
                    intersection.style.alignItems = 'center';
                    intersection.style.justifyContent = 'center';
                    intersection.style.zIndex = '10';

                    board.appendChild(intersection);
                }
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘å¤„ç†æ£‹ç›˜ç‚¹å‡»
        async function handleCellClick(row, col) {
            if (!gomokuGameState.gameActive ||
                gomokuGameState.currentPlayer !== 'user' ||
                gomokuGameState.board[row][col] !== null) {
                return;
            }

            // ç”¨æˆ·ä¸‹æ£‹
            await makeMove(row, col, 'user');
        }

        // ğŸ®ã€æ–°å¢ã€‘ä¸‹æ£‹
        async function makeMove(row, col, player) {
            // æ›´æ–°æ£‹ç›˜çŠ¶æ€
            gomokuGameState.board[row][col] = player;

            // è®°å½•æ£‹æ­¥
            const move = {
                row,
                col,
                player,
                timestamp: Date.now(),
                moveNumber: gomokuGameState.moveHistory.length + 1
            };
            gomokuGameState.moveHistory.push(move);

            // è®°å½•åˆ°æ¸¸æˆäº‹ä»¶
            gomokuGameState.gameSession.gameEvents.push({
                type: 'move',
                timestamp: Date.now(),
                player: player,
                data: { row, col, moveNumber: move.moveNumber }
            });

            // æ›´æ–°UI
            updateBoardUI();

            // ğŸ®ã€ä¿®å¤ã€‘ç«‹å³åˆ‡æ¢ç©å®¶çŠ¶æ€å¹¶æ›´æ–°UI
            gomokuGameState.currentPlayer = player === 'user' ? 'ai' : 'user';
            updateGomokuUI();

            // ğŸ®ã€åˆ é™¤APIè°ƒç”¨ã€‘ç§»é™¤ç”¨æˆ·å¨èƒæ£€æµ‹çš„APIå›åº”
            // ç”¨æˆ·å¨èƒæ£€æµ‹çš„APIè°ƒç”¨å·²åˆ é™¤

            // æ£€æŸ¥èƒœè´Ÿ
            const winner = checkWinner(row, col);
            if (winner) {
                endGame(winner);
                return;
            }

            // æ£€æŸ¥å¹³å±€
            if (gomokuGameState.moveHistory.length >= 225) {
                endGame('draw');
                return;
            }

            // å¦‚æœè½®åˆ°AIï¼Œå»¶è¿Ÿä¸€ä¸‹å†ä¸‹æ£‹
            if (gomokuGameState.currentPlayer === 'ai') {
                // ğŸ®ã€æ–°å¢ã€‘æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
                setTimeout(() => {
                    const statusElement = document.getElementById('current-turn');
                    statusElement.textContent = 'å¯¹æ–¹æ€è€ƒä¸­â€¦';
                    statusElement.style.color = '#718096';
                }, 500); // 0.5ç§’åæ˜¾ç¤ºæ€è€ƒçŠ¶æ€

                setTimeout(() => {
                    makeAIMove();
                }, 1000 + Math.random() * 2000); // 1-3ç§’éšæœºå»¶è¿Ÿ
            }
        }

        // ğŸ®ã€é‡æ„ã€‘AIæ ¹æ®äººè®¾æ™ºèƒ½ä¸‹æ£‹
        async function makeAIMove() {
            if (!gomokuGameState.gameActive || gomokuGameState.currentPlayer !== 'ai') {
                return;
            }

            if (!currentChatCharacter) {
                // å¦‚æœæ²¡æœ‰è§’è‰²ï¼Œä½¿ç”¨å¤‡ç”¨ç®—æ³•
                makeBackupMove();
                return;
            }

            try {
                // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
                const statusElement = document.getElementById('current-turn');
                statusElement.textContent = `${currentChatCharacter.name}æ­£åœ¨æ€è€ƒ...`;
                statusElement.style.color = '#718096';

                // è°ƒç”¨AI APIå†³å®šä¸‹æ£‹ä½ç½®
                const aiMove = await getAIMoveFromAPI();

                if (aiMove && aiMove.row !== undefined && aiMove.col !== undefined) {
                    // éªŒè¯AIé€‰æ‹©çš„ä½ç½®æ˜¯å¦æœ‰æ•ˆ
                    if (isValidMove(aiMove.row, aiMove.col)) {
                        setTimeout(async () => {
                            await makeMove(aiMove.row, aiMove.col, 'ai');

                            // å¦‚æœAIæä¾›äº†æ€è€ƒè¿‡ç¨‹ï¼Œæ˜¾ç¤ºå‡ºæ¥
                            if (aiMove.reasoning) {
                                setTimeout(() => {
                                    addGameChatMessage('ai', aiMove.reasoning, true);
                                }, 500);
                            }
                        }, 800 + Math.random() * 1200); // 0.8-2ç§’æ€è€ƒæ—¶é—´
                    } else {
                        console.warn('AIé€‰æ‹©äº†æ— æ•ˆä½ç½®ï¼Œä½¿ç”¨å¤‡ç”¨ç®—æ³•');
                        makeBackupMove();
                    }
                } else {
                    console.warn('AIæœªè¿”å›æœ‰æ•ˆèµ°æ³•ï¼Œä½¿ç”¨å¤‡ç”¨ç®—æ³•');
                    makeBackupMove();
                }
            } catch (error) {
                console.error('AIä¸‹æ£‹APIè°ƒç”¨å¤±è´¥:', error);
                makeBackupMove();
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘éšæœºä¸‹æ£‹ï¼ˆçŠ¯é”™æ—¶ä½¿ç”¨ï¼‰
        function makeRandomMove() {
            const emptyCells = [];
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (gomokuGameState.board[row][col] === null) {
                        emptyCells.push({ row, col });
                    }
                }
            }

            if (emptyCells.length > 0) {
                const randomIndex = Math.floor(Math.random() * emptyCells.length);
                const { row, col } = emptyCells[randomIndex];

                setTimeout(async () => {
                    await makeMove(row, col, 'ai');
                }, 500);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯»æ‰¾æœ€ä½³ä¸‹æ£‹ä½ç½®
        function findBestMove(depth) {
            const board = gomokuGameState.board;

            // ä¼˜å…ˆçº§1ï¼šæ£€æŸ¥AIæ˜¯å¦èƒ½è·èƒœ
            const winMove = findWinningMove('ai');
            if (winMove) return winMove;

            // ä¼˜å…ˆçº§2ï¼šé˜»æ­¢ç”¨æˆ·è·èƒœ
            const blockMove = findWinningMove('user');
            if (blockMove) return blockMove;

            // ä¼˜å…ˆçº§3ï¼šæ ¹æ®æ·±åº¦è¿›è¡Œæ›´æ·±å±‚åˆ†æ
            if (depth >= 2) {
                const strategicMove = findStrategicMove(depth);
                if (strategicMove) return strategicMove;
            }

            // ä¼˜å…ˆçº§4ï¼šé€‰æ‹©ä¸­å¿ƒåŒºåŸŸ
            const centerMove = findCenterMove();
            if (centerMove) return centerMove;

            return null;
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯»æ‰¾è·èƒœä½ç½®
        function findWinningMove(player) {
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (gomokuGameState.board[row][col] === null) {
                        // æ¨¡æ‹Ÿä¸‹æ£‹
                        gomokuGameState.board[row][col] = player;
                        if (checkWinner(row, col)) {
                            gomokuGameState.board[row][col] = null; // æ¢å¤
                            return { row, col };
                        }
                        gomokuGameState.board[row][col] = null; // æ¢å¤
                    }
                }
            }
            return null;
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯»æ‰¾æˆ˜ç•¥ä½ç½®
        function findStrategicMove(depth) {
            // ç®€åŒ–çš„æˆ˜ç•¥åˆ†æï¼šå¯»æ‰¾èƒ½å½¢æˆå¤šä¸ªå¨èƒçš„ä½ç½®
            let bestScore = -1;
            let bestMove = null;

            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (gomokuGameState.board[row][col] === null) {
                        const score = evaluatePosition(row, col, 'ai');
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = { row, col };
                        }
                    }
                }
            }

            return bestMove;
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯»æ‰¾ä¸­å¿ƒä½ç½®
        function findCenterMove() {
            const center = 7;
            const candidates = [];

            // ä¼˜å…ˆé€‰æ‹©ä¸­å¿ƒé™„è¿‘çš„ä½ç½®
            for (let radius = 0; radius <= 3; radius++) {
                for (let row = center - radius; row <= center + radius; row++) {
                    for (let col = center - radius; col <= center + radius; col++) {
                        if (row >= 0 && row < 15 && col >= 0 && col < 15 &&
                            gomokuGameState.board[row][col] === null) {
                            candidates.push({ row, col });
                        }
                    }
                }
                if (candidates.length > 0) break;
            }

            return candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : null;
        }

        // ğŸ®ã€æ–°å¢ã€‘è¯„ä¼°ä½ç½®ä»·å€¼
        function evaluatePosition(row, col, player) {
            let score = 0;
            const directions = [[0,1], [1,0], [1,1], [1,-1]];

            for (const [dx, dy] of directions) {
                score += evaluateDirection(row, col, dx, dy, player);
            }

            return score;
        }

        // ğŸ®ã€æ–°å¢ã€‘è¯„ä¼°æ–¹å‘ä»·å€¼
        function evaluateDirection(row, col, dx, dy, player) {
            let count = 1; // åŒ…æ‹¬å½“å‰ä½ç½®
            let openEnds = 0;

            // å‘æ­£æ–¹å‘æ£€æŸ¥
            let r = row + dx, c = col + dy;
            while (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === player) {
                count++;
                r += dx;
                c += dy;
            }
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === null) {
                openEnds++;
            }

            // å‘è´Ÿæ–¹å‘æ£€æŸ¥
            r = row - dx;
            c = col - dy;
            while (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === player) {
                count++;
                r -= dx;
                c -= dy;
            }
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === null) {
                openEnds++;
            }

            // æ ¹æ®è¿å­æ•°å’Œå¼€æ”¾ç«¯æ•°è¯„åˆ†
            if (count >= 5) return 10000; // è·èƒœ
            if (count === 4 && openEnds > 0) return 1000; // å†²å››
            if (count === 3 && openEnds === 2) return 100; // æ´»ä¸‰
            if (count === 3 && openEnds === 1) return 10; // çœ ä¸‰
            if (count === 2 && openEnds === 2) return 5; // æ´»äºŒ

            return count * openEnds;
        }

        // ğŸ®ã€æ–°å¢ã€‘AIæ™ºèƒ½ä¸‹æ£‹APIè°ƒç”¨
        async function getAIMoveFromAPI() {
            if (!currentChatCharacter) return null;

            // æ„å»ºæ£‹ç›˜çŠ¶æ€æè¿°
            const boardDescription = getBoardDescription();
            const moveHistory = getMoveHistoryDescription();
            const gameAnalysis = getGameAnalysis();

            const prompt = `ä½ æ˜¯${currentChatCharacter.name}ï¼Œ${currentChatCharacter.prompt}

ç°åœ¨ä½ åœ¨å’Œç”¨æˆ·ä¸‹äº”å­æ£‹ã€‚æ¸¸æˆè§„åˆ™ï¼š
- æ£‹ç›˜æ˜¯15x15ï¼Œåæ ‡ä»(0,0)åˆ°(14,14)
- ç›®æ ‡æ˜¯è¿æˆ5ä¸ªå­ï¼ˆæ¨ªã€ç«–ã€æ–œï¼‰
- ä½ æ‰§${gomokuGameState.userIsBlack ? 'ç™½å­(O)' : 'é»‘å­(â—)'}ï¼Œç”¨æˆ·æ‰§${gomokuGameState.userIsBlack ? 'é»‘å­(â—)' : 'ç™½å­(O)'}

å½“å‰æ¸¸æˆçŠ¶æ€ï¼š
${boardDescription}

${moveHistory}

${gameAnalysis}

é‡è¦æé†’ï¼š
1. åªèƒ½é€‰æ‹©ç©ºä½ï¼ˆÂ·ï¼‰ä¸‹æ£‹
2. åæ ‡æ ¼å¼ï¼šrow(è¡Œ)å’Œcol(åˆ—)éƒ½æ˜¯0-14çš„æ•´æ•°
3. ä¼˜å…ˆè€ƒè™‘ï¼šè·èƒœæœºä¼š > é˜»æ­¢å¯¹æ‰‹è·èƒœ > å½¢æˆå¨èƒ > é˜²å®ˆ
4. ä½“ç°ä½ çš„æ€§æ ¼ç‰¹ç‚¹

è¯·åˆ†ææ£‹å±€å¹¶é€‰æ‹©ä½ çš„ä¸‹ä¸€æ­¥ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼å›å¤ï¼š

{
    "row": æ•´æ•°(0-14),
    "col": æ•´æ•°(0-14),
    "reasoning": "ç®€çŸ­è§£é‡Šé€‰æ‹©è¿™ä¸ªä½ç½®çš„åŸå› "
}

æ³¨æ„ï¼šåªè¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼`;

            try {
                const response = await callChatAPI(prompt, currentChatCharacter);
                return parseAIMoveResponse(response);
            } catch (error) {
                console.error('AIä¸‹æ£‹APIè°ƒç”¨å¤±è´¥:', error);
                return null;
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘åˆ†æå¨èƒ
        function analyzeThreats(row, col, player) {
            const threats = [];
            const directions = [[0,1], [1,0], [1,1], [1,-1]];

            for (const [dx, dy] of directions) {
                const count = countDirection(row, col, dx, dy, player);
                if (count >= 3) {
                    threats.push({ type: count === 3 ? 'three' : 'four', direction: [dx, dy] });
                }
            }

            return threats;
        }

        // ğŸ®ã€æ–°å¢ã€‘è®¡ç®—æ–¹å‘ä¸Šçš„è¿å­æ•°
        function countDirection(row, col, dx, dy, player) {
            let count = 1;

            // æ­£æ–¹å‘
            let r = row + dx, c = col + dy;
            while (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === player) {
                count++;
                r += dx;
                c += dy;
            }

            // è´Ÿæ–¹å‘
            r = row - dx;
            c = col - dy;
            while (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuGameState.board[r][c] === player) {
                count++;
                r -= dx;
                c -= dy;
            }

            return count;
        }

        // ğŸ®ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦é˜»æ­¢ç”¨æˆ·å¨èƒ
        function isBlockingUserThreat(row, col) {
            // æ¨¡æ‹Ÿç”¨æˆ·åœ¨æ­¤ä½ç½®ä¸‹æ£‹ï¼Œçœ‹æ˜¯å¦ä¼šå½¢æˆå¨èƒ
            gomokuGameState.board[row][col] = 'user';
            const userThreats = analyzeThreats(row, col, 'user');
            gomokuGameState.board[row][col] = 'ai'; // æ¢å¤AIæ£‹å­

            return userThreats.length > 0;
        }

        // ğŸ®ã€æ”¹è¿›ã€‘æ£‹ç›˜çŠ¶æ€æè¿°å‡½æ•° - æ›´æ¸…æ™°çš„æ ¼å¼
        function getBoardDescription() {
            let description = "å½“å‰æ£‹ç›˜çŠ¶æ€ï¼ˆ15x15ï¼Œåæ ‡ä»0å¼€å§‹ï¼Œâ—=é»‘å­ï¼ŒO=ç™½å­ï¼ŒÂ·=ç©ºä½ï¼‰ï¼š\n";
            description += "   ";
            for (let col = 0; col < 15; col++) {
                description += col.toString().padStart(2, ' ');
            }
            description += "\n";

            for (let row = 0; row < 15; row++) {
                let rowStr = row.toString().padStart(2, ' ') + ' ';
                for (let col = 0; col < 15; col++) {
                    const piece = gomokuGameState.board[row][col];
                    if (piece === 'user') {
                        rowStr += gomokuGameState.userIsBlack ? 'â—' : 'O';
                    } else if (piece === 'ai') {
                        rowStr += gomokuGameState.userIsBlack ? 'O' : 'â—';
                    } else {
                        rowStr += 'Â·';
                    }
                    if (col < 14) rowStr += ' ';
                }
                description += rowStr + '\n';
            }

            // æ·»åŠ ç©ºä½åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå‰20ä¸ªç©ºä½ï¼‰
            const emptyPositions = [];
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (gomokuGameState.board[row][col] === null) {
                        emptyPositions.push(`(${row},${col})`);
                    }
                }
            }

            if (emptyPositions.length > 0) {
                description += `\nå¯ä¸‹æ£‹ä½ç½®ç¤ºä¾‹: ${emptyPositions.slice(0, 20).join(', ')}`;
                if (emptyPositions.length > 20) {
                    description += ` ç­‰${emptyPositions.length}ä¸ªä½ç½®`;
                }
            }

            return description;
        }

        // ğŸ®ã€æ–°å¢ã€‘å†å²èµ°æ³•æè¿°
        function getMoveHistoryDescription() {
            if (gomokuGameState.moveHistory.length === 0) {
                return "è¿™æ˜¯æ¸¸æˆå¼€å§‹ï¼Œè¿˜æ²¡æœ‰ä»»ä½•èµ°æ³•ã€‚";
            }

            let description = `å†å²èµ°æ³•ï¼ˆå…±${gomokuGameState.moveHistory.length}æ­¥ï¼‰ï¼š\n`;
            const recentMoves = gomokuGameState.moveHistory.slice(-6); // åªæ˜¾ç¤ºæœ€è¿‘6æ­¥

            recentMoves.forEach((move, index) => {
                const stepNum = gomokuGameState.moveHistory.length - recentMoves.length + index + 1;
                const player = move.player === 'user' ? 'ç”¨æˆ·' : 'ä½ ';
                description += `ç¬¬${stepNum}æ­¥: ${player}åœ¨(${move.row},${move.col})ä¸‹äº†${move.player === 'user' ? (gomokuGameState.userIsBlack ? 'é»‘å­â—' : 'ç™½å­O') : (gomokuGameState.userIsBlack ? 'ç™½å­O' : 'é»‘å­â—')}\n`;
            });

            return description;
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆåˆ†æ
        function getGameAnalysis() {
            const totalMoves = gomokuGameState.moveHistory.length;
            let analysis = `æ¸¸æˆè¿›è¡Œåˆ°ç¬¬${totalMoves}æ­¥ã€‚`;

            if (totalMoves < 6) {
                analysis += " ç°åœ¨è¿˜æ˜¯å¼€å±€é˜¶æ®µï¼Œéœ€è¦æŠ¢å æœ‰åˆ©ä½ç½®ã€‚";
            } else if (totalMoves < 15) {
                analysis += " ç°åœ¨æ˜¯ä¸­å±€ï¼Œéœ€è¦å¹³è¡¡æ”»é˜²ã€‚";
            } else {
                analysis += " ç°åœ¨æ˜¯æ®‹å±€ï¼Œæ¯ä¸€æ­¥éƒ½å¾ˆå…³é”®ã€‚";
            }

            return analysis;
        }

        // ğŸ®ã€æ”¹è¿›ã€‘è§£æAIå›å¤ - å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
        function parseAIMoveResponse(response) {
            try {
                let responseText = '';
                if (Array.isArray(response)) {
                    responseText = response[0];
                } else {
                    responseText = response;
                }

                console.log('ğŸ¤– AIåŸå§‹å›å¤:', responseText);

                // å°è¯•æå–JSON
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const moveData = JSON.parse(jsonMatch[0]);
                    console.log('ğŸ¯ è§£æå‡ºçš„èµ°æ³•æ•°æ®:', moveData);

                    // éªŒè¯æ•°æ®æ ¼å¼å’ŒèŒƒå›´
                    if (typeof moveData.row === 'number' &&
                        typeof moveData.col === 'number' &&
                        moveData.row >= 0 && moveData.row <= 14 &&
                        moveData.col >= 0 && moveData.col <= 14) {

                        // æ£€æŸ¥ä½ç½®æ˜¯å¦å·²è¢«å ç”¨
                        if (gomokuGameState.board[moveData.row][moveData.col] !== null) {
                            console.warn(`ğŸš« AIé€‰æ‹©çš„ä½ç½®(${moveData.row},${moveData.col})å·²è¢«å ç”¨:`, gomokuGameState.board[moveData.row][moveData.col]);
                            return null;
                        }

                        console.log(`âœ… AIé€‰æ‹©æœ‰æ•ˆä½ç½®: (${moveData.row},${moveData.col})`);
                        return moveData;
                    } else {
                        console.warn('âŒ AIå›å¤çš„åæ ‡æ ¼å¼æˆ–èŒƒå›´ä¸æ­£ç¡®:', moveData);
                    }
                } else {
                    console.warn('âŒ æ— æ³•ä»AIå›å¤ä¸­æå–JSON:', responseText);
                }

                return null;
            } catch (error) {
                console.error('âŒ è§£æAIå›å¤å¤±è´¥:', error, response);
                return null;
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘éªŒè¯èµ°æ³•æ˜¯å¦æœ‰æ•ˆ
        function isValidMove(row, col) {
            return row >= 0 && row < 15 &&
                   col >= 0 && col < 15 &&
                   gomokuGameState.board[row][col] === null;
        }

        // ğŸ®ã€æ–°å¢ã€‘å¤‡ç”¨ä¸‹æ£‹ç®—æ³•ï¼ˆAPIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        function makeBackupMove() {
            // ä½¿ç”¨ç®€åŒ–çš„æœ¬åœ°ç®—æ³•ä½œä¸ºå¤‡ç”¨
            const bestMove = findBestMove(2); // ä½¿ç”¨ä¸­ç­‰æ·±åº¦

            if (bestMove) {
                setTimeout(async () => {
                    await makeMove(bestMove.row, bestMove.col, 'ai');
                }, 500 + Math.random() * 1000);
            } else {
                makeRandomMove();
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ£€æŸ¥èƒœè´Ÿ
        function checkWinner(row, col) {
            const player = gomokuGameState.board[row][col];
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],   // å‚ç›´
                [1, 1],   // å¯¹è§’çº¿
                [1, -1]   // åå¯¹è§’çº¿
            ];

            for (const [dx, dy] of directions) {
                let count = 1;
                const winningCells = [{row, col}];

                // å‘ä¸€ä¸ªæ–¹å‘æ£€æŸ¥
                for (let i = 1; i < 5; i++) {
                    const newRow = row + dx * i;
                    const newCol = col + dy * i;
                    if (newRow >= 0 && newRow < 15 && newCol >= 0 && newCol < 15 &&
                        gomokuGameState.board[newRow][newCol] === player) {
                        count++;
                        winningCells.push({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }

                // å‘ç›¸åæ–¹å‘æ£€æŸ¥
                for (let i = 1; i < 5; i++) {
                    const newRow = row - dx * i;
                    const newCol = col - dy * i;
                    if (newRow >= 0 && newRow < 15 && newCol >= 0 && newCol < 15 &&
                        gomokuGameState.board[newRow][newCol] === player) {
                        count++;
                        winningCells.unshift({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }

                if (count >= 5) {
                    // æ ‡è®°è·èƒœçš„æ£‹å­
                    winningCells.forEach(({row, col}) => {
                        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"] .gomoku-piece`);
                        if (cell) {
                            cell.classList.add('winning');
                        }
                    });
                    return player;
                }
            }

            return null;
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆç»“æŸ
        async function endGame(winner) {
            gomokuGameState.gameActive = false;
            clearInterval(gomokuGameState.gameTimer);

            // è®°å½•æ¸¸æˆç»“æŸäº‹ä»¶
            const gameEndEvent = {
                type: 'game_end',
                timestamp: Date.now(),
                player: 'system',
                data: {
                    winner: winner,
                    totalMoves: gomokuGameState.moveHistory.length,
                    gameDuration: Date.now() - gomokuGameState.gameStartTime
                }
            };
            gomokuGameState.gameSession.gameEvents.push(gameEndEvent);

            // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
            let resultMessage;
            if (winner === 'user') {
                resultMessage = 'ğŸ‰ æ­å–œä½ è·èƒœäº†ï¼';
            } else if (winner === 'ai') {
                resultMessage = 'ğŸ˜… å¯¹æ–¹è·èƒœäº†ï¼';
            } else {
                resultMessage = 'ğŸ¤ å¹³å±€ï¼';
            }
            addGameChatMessage('system', resultMessage);

            // ğŸ®ã€åˆ é™¤ã€‘æ¸¸æˆç»“æŸæ—¶çš„è‡ªåŠ¨å›å¤
            if (currentChatCharacter) {
                // è®°å½•æ¸¸æˆç»“æŸäº‹ä»¶
                const gameDuration = Math.round((Date.now() - gomokuGameState.gameStartTime) / 1000 / 60);
                const totalMoves = gomokuGameState.moveHistory.length;
                await recordGameEvent(currentChatCharacter.id, 'game_end', {
                    gameName: 'äº”å­æ£‹',
                    result: winner,
                    score: totalMoves,
                    chatContent: `æ¸¸æˆç»“æŸï¼Œç»“æœï¼š${winner}ï¼Œæ€»å…±${totalMoves}æ­¥ï¼Œç”¨æ—¶${gameDuration}åˆ†é’Ÿ`
                });

                // ä¸å†å‘é€è‡ªåŠ¨å›å¤æ¶ˆæ¯
            }

            updateGomokuUI();

            // å»¶è¿Ÿè°ƒç”¨æ¸¸æˆæ€»ç»“
            setTimeout(() => {
                summarizeGameSession();
            }, 3000);
        }



        // ğŸ®ã€æ–°å¢ã€‘æ›´æ–°æ£‹ç›˜UI
        function updateBoardUI() {
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const intersection = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    const piece = gomokuGameState.board[row][col];

                    // æ¸…é™¤ç°æœ‰æ£‹å­
                    intersection.innerHTML = '';

                    if (piece) {
                        const pieceElement = document.createElement('div');
                        // æ ¹æ®ç”¨æˆ·æ˜¯å¦æ‹¿é»‘å­æ¥å†³å®šæ£‹å­é¢œè‰²
                        let pieceColor;
                        if (piece === 'user') {
                            pieceColor = gomokuGameState.userIsBlack ? 'black' : 'white';
                        } else {
                            pieceColor = gomokuGameState.userIsBlack ? 'white' : 'black';
                        }
                        pieceElement.className = `gomoku-piece ${pieceColor}`;
                        intersection.appendChild(pieceElement);
                    }
                }
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ›´æ–°æ¸¸æˆUI
        function updateGomokuUI() {
            const statusElement = document.getElementById('current-turn');
            if (gomokuGameState.gameActive) {
                if (gomokuGameState.currentPlayer === 'user') {
                    statusElement.textContent = 'ä½ çš„å›åˆ';
                    statusElement.style.color = '#2d3748';
                } else {
                    statusElement.textContent = 'å¯¹æ–¹å›åˆ';
                    statusElement.style.color = '#718096';
                }
            } else {
                statusElement.textContent = 'æ¸¸æˆç»“æŸ';
                statusElement.style.color = '#e53e3e';
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ›´æ–°ç©å®¶æ£‹å­æ˜¾ç¤º
        function updatePlayerPieceDisplay() {
            // æŸ¥æ‰¾æ‰€æœ‰çš„ç”¨æˆ·å’ŒAIæ£‹å­æŒ‡ç¤ºå™¨
            const userPieceElements = document.querySelectorAll('.user-piece');
            const aiPieceElements = document.querySelectorAll('.ai-piece');

            console.log('æ£‹å­å…ƒç´ æŸ¥æ‰¾:', {
                userCount: userPieceElements.length,
                aiCount: aiPieceElements.length
            });

            // æ›´æ–°æ‰€æœ‰ç”¨æˆ·æ£‹å­æŒ‡ç¤ºå™¨
            userPieceElements.forEach(element => {
                element.classList.remove('black', 'white');
                if (gomokuGameState.userIsBlack) {
                    element.classList.add('black');
                } else {
                    element.classList.add('white');
                }
                element.textContent = '';
                element.style.display = 'block';
                element.style.visibility = 'visible';
            });

            // æ›´æ–°æ‰€æœ‰AIæ£‹å­æŒ‡ç¤ºå™¨
            aiPieceElements.forEach(element => {
                element.classList.remove('black', 'white');
                if (gomokuGameState.userIsBlack) {
                    element.classList.add('white');
                } else {
                    element.classList.add('black');
                }
                element.textContent = '';
                element.style.display = 'block';
                element.style.visibility = 'visible';
            });

            console.log('æ£‹å­æ˜¾ç¤ºå·²æ›´æ–° - ç”¨æˆ·æ‰§å­:', gomokuGameState.userIsBlack ? 'é»‘å­' : 'ç™½å­');
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨
        function startGameTimer() {
            const timerElement = document.getElementById('game-timer');
            gomokuGameState.gameTimer = setInterval(() => {
                const elapsed = Date.now() - gomokuGameState.gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ğŸ®ã€æ–°å¢ã€‘è®¾ç½®ç©å®¶ä¿¡æ¯ï¼ˆç”¨æˆ·å’ŒAIï¼‰
        function setupAIPlayerInfo() {
            const aiNameElement = document.getElementById('ai-player-name');
            const aiAvatarElement = document.getElementById('ai-player-avatar');
            const aiAvatarHeaderElement = document.getElementById('ai-player-avatar-header'); // æ ‡é¢˜æ ä¸­çš„AIå¤´åƒ
            const userAvatarElement = document.getElementById('user-player-avatar');
            const userAvatarHeaderElement = document.getElementById('user-player-avatar-header'); // æ ‡é¢˜æ ä¸­çš„ç”¨æˆ·å¤´åƒ

            // è®¾ç½®AIè§’è‰²ä¿¡æ¯
            if (currentChatCharacter) {
                if (aiNameElement) {
                    aiNameElement.textContent = currentChatCharacter.name;
                }
                // ä½¿ç”¨æ­£ç¡®çš„AIå¤´åƒè·å–é€»è¾‘
                const chatSettings = getCurrentChatSettings();
                const aiAvatar = chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl || currentChatCharacter.avatar;

                // è®¾ç½®åŸæ¥çš„AIå¤´åƒ
                if (aiAvatar && aiAvatarElement) {
                    // ä¿ç•™æ£‹å­æŒ‡ç¤ºå™¨ï¼Œåªæ›¿æ¢å¤´åƒå†…å®¹
                    const existingPieceIndicator = aiAvatarElement.querySelector('.piece-indicator');
                    aiAvatarElement.innerHTML = `<img src="${aiAvatar}" alt="${currentChatCharacter.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    // é‡æ–°æ·»åŠ æ£‹å­æŒ‡ç¤ºå™¨
                    if (existingPieceIndicator) {
                        aiAvatarElement.appendChild(existingPieceIndicator);
                    }
                }

                // è®¾ç½®æ ‡é¢˜æ ä¸­çš„AIå¤´åƒ
                if (aiAvatar && aiAvatarHeaderElement) {
                    // ä¿ç•™æ£‹å­æŒ‡ç¤ºå™¨ï¼Œåªæ›¿æ¢å¤´åƒå†…å®¹
                    const existingPieceIndicator = aiAvatarHeaderElement.querySelector('.piece-indicator');
                    aiAvatarHeaderElement.innerHTML = `<img src="${aiAvatar}" alt="${currentChatCharacter.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    // é‡æ–°æ·»åŠ æ£‹å­æŒ‡ç¤ºå™¨
                    if (existingPieceIndicator) {
                        aiAvatarHeaderElement.appendChild(existingPieceIndicator);
                    }
                }
            }

            // è®¾ç½®ç”¨æˆ·å¤´åƒ - ä½¿ç”¨å’ŒèŠå¤©ç•Œé¢ç›¸åŒçš„é€»è¾‘
            const chatSettings = getCurrentChatSettings();
            let userAvatar = null;

            // ä¼˜å…ˆçº§1ï¼šèŠå¤©ä¸“å±å¤´åƒè®¾ç½®
            if (chatSettings.myChatAvatar) {
                userAvatar = chatSettings.myChatAvatar;
            }

            // ä¼˜å…ˆçº§2ï¼šèº«ä»½é¢å…·å¡å¤´åƒ
            if (!userAvatar && chatSettings.selectedIdentityId) {
                const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                if (selectedPersona && selectedPersona.avatarUrl) {
                    userAvatar = selectedPersona.avatarUrl;
                }
            }

            // ä¼˜å…ˆçº§3ï¼šå…¨å±€ç”¨æˆ·å¤´åƒ
            if (!userAvatar && window.userAvatar) {
                userAvatar = window.userAvatar;
            }

            // è®¾ç½®åŸæ¥çš„ç”¨æˆ·å¤´åƒ
            if (userAvatar && userAvatarElement) {
                // ä¿ç•™æ£‹å­æŒ‡ç¤ºå™¨ï¼Œåªæ›¿æ¢å¤´åƒå†…å®¹
                const existingPieceIndicator = userAvatarElement.querySelector('.piece-indicator');
                userAvatarElement.innerHTML = `<img src="${userAvatar}" alt="ä½ " style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                // é‡æ–°æ·»åŠ æ£‹å­æŒ‡ç¤ºå™¨
                if (existingPieceIndicator) {
                    userAvatarElement.appendChild(existingPieceIndicator);
                }
            }

            // è®¾ç½®æ ‡é¢˜æ ä¸­çš„ç”¨æˆ·å¤´åƒ
            if (userAvatar && userAvatarHeaderElement) {
                // ä¿ç•™æ£‹å­æŒ‡ç¤ºå™¨ï¼Œåªæ›¿æ¢å¤´åƒå†…å®¹
                const existingPieceIndicator = userAvatarHeaderElement.querySelector('.piece-indicator');
                userAvatarHeaderElement.innerHTML = `<img src="${userAvatar}" alt="ä½ " style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                // é‡æ–°æ·»åŠ æ£‹å­æŒ‡ç¤ºå™¨
                if (existingPieceIndicator) {
                    userAvatarHeaderElement.appendChild(existingPieceIndicator);
                }
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ˜¾ç¤ºAIæ­£åœ¨å›å¤çš„åŠ è½½æ°”æ³¡
        function showGameChatLoading() {
            const messagesContainer = document.getElementById('gomoku-chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'game-chat-message ai';
            loadingDiv.id = 'game-chat-loading';

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'game-chat-bubble loading';
            bubbleDiv.innerHTML = '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';

            loadingDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(loadingDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ğŸ®ã€æ–°å¢ã€‘éšè—AIæ­£åœ¨å›å¤çš„åŠ è½½æ°”æ³¡
        function hideGameChatLoading() {
            const loadingElement = document.getElementById('game-chat-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ·»åŠ æ¸¸æˆèŠå¤©æ¶ˆæ¯
        function addGameChatMessage(sender, content, shouldRecord = false) {
            const messagesContainer = document.getElementById('gomoku-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `game-chat-message ${sender}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'game-chat-bubble';
            bubbleDiv.textContent = content;

            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // è®°å½•åˆ°æ¸¸æˆä¼šè¯
            const chatMessage = {
                sender,
                content,
                timestamp: Date.now()
            };
            gomokuGameState.gameSession.chatHistory.push(chatMessage);

            // å¦‚æœéœ€è¦è®°å½•åˆ°å…¨å±€è®°å¿†ç³»ç»Ÿ
            if (shouldRecord && currentChatCharacter) {
                recordGameChat(currentChatCharacter.id, sender, content, {
                    gameName: 'äº”å­æ£‹',
                    gameState: 'playing'
                });
            }
        }

        // ğŸ®ã€é‡æ„ã€‘æ¸¸æˆèŠå¤© - ä¸å¹³æ—¶èŠå¤©ä¸€æ ·æœ‰è®°å¿†å’Œä¸Šä¸‹æ–‡
        async function sendGameChatMessage() {
            const input = document.getElementById('gomoku-chat-input');
            const content = input.value.trim();

            if (!content) return;
            if (!currentChatCharacter) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ¸¸æˆèŠå¤©ç•Œé¢
            addGameChatMessage('user', content, true);
            input.value = '';

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showGameChatLoading();

                // ğŸ®ã€æ–°åŠŸèƒ½ã€‘å°†æ¸¸æˆèŠå¤©æ¶ˆæ¯æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
                const gameContextMessage = `[äº”å­æ£‹æ¸¸æˆä¸­] ${content}`;

                // æ·»åŠ åˆ°ä¸»èŠå¤©æ•°æ®åº“ï¼Œä¿æŒè®°å¿†è¿ç»­æ€§
                const userMessage = {
                    id: Date.now(),
                    characterId: currentChatCharacter.id,
                    content: gameContextMessage,
                    sender: 'user',
                    timestamp: Date.now(),
                    isGameContext: true // æ ‡è®°ä¸ºæ¸¸æˆä¸Šä¸‹æ–‡æ¶ˆæ¯
                };

                await db.chatMessages.add(userMessage);

                // æ„å»ºæ¸¸æˆèŠå¤©çš„ç‰¹æ®Šæç¤ºè¯
                const gameStatus = gomokuGameState.gameActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ';
                const moveCount = gomokuGameState.moveHistory.length;
                const userPiece = gomokuGameState.userIsBlack ? 'é»‘å­' : 'ç™½å­';
                const aiPiece = gomokuGameState.userIsBlack ? 'ç™½å­' : 'é»‘å­';

                const gameContextPrompt = `[æ¸¸æˆçŠ¶æ€] ä½ ä»¬æ­£åœ¨ä¸‹äº”å­æ£‹ï¼Œæ¸¸æˆ${gameStatus}ï¼Œå·²ä¸‹${moveCount}æ­¥ã€‚ä½ æ‰§${aiPiece}ï¼Œç”¨æˆ·æ‰§${userPiece}ã€‚ç”¨æˆ·åœ¨æ¸¸æˆä¸­å¯¹ä½ è¯´ï¼š"${content}"

è¯·è‡ªç„¶åœ°å›åº”ç”¨æˆ·ï¼Œå°±åƒå¹³æ—¶èŠå¤©ä¸€æ ·ã€‚ä½ å¯ä»¥ï¼š
1. å›åº”ç”¨æˆ·çš„è¯é¢˜
2. è¯„è®ºå½“å‰çš„æ£‹å±€
3. èŠå…¶ä»–ä»»ä½•è¯é¢˜
4. ä¿æŒä½ çš„æ€§æ ¼ç‰¹ç‚¹

å›å¤è¦è‡ªç„¶ï¼Œä¸è¦åˆ»æ„æé†’è¿™æ˜¯åœ¨æ¸¸æˆä¸­ã€‚`;

                // ä½¿ç”¨å®Œæ•´çš„èŠå¤©APIï¼ŒåŒ…å«è®°å¿†å’Œä¸Šä¸‹æ–‡
                const response = await callChatAPI(gameContextPrompt, currentChatCharacter);
                const aiMessages = await parseAiResponse(response);

                // éšè—åŠ è½½çŠ¶æ€
                hideGameChatLoading();

                // å¤„ç†AIå›å¤
                if (Array.isArray(aiMessages) && aiMessages.length > 0) {
                    for (let i = 0; i < aiMessages.length; i++) {
                        const message = aiMessages[i];
                        let messageText = '';

                        if (typeof message === 'string') {
                            messageText = message.trim();
                        } else if (typeof message === 'object' && message.content) {
                            messageText = message.content.trim();
                        }

                        if (messageText) {
                            setTimeout(async () => {
                                // æ·»åŠ åˆ°æ¸¸æˆèŠå¤©ç•Œé¢
                                addGameChatMessage('ai', messageText, true);

                                // ğŸ®ã€æ–°åŠŸèƒ½ã€‘åŒæ—¶æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ï¼Œä¿æŒè®°å¿†è¿ç»­æ€§
                                const aiChatMessage = {
                                    id: Date.now() + i,
                                    characterId: currentChatCharacter.id,
                                    content: `[äº”å­æ£‹æ¸¸æˆä¸­] ${messageText}`,
                                    sender: 'ai',
                                    timestamp: Date.now() + i,
                                    isGameContext: true
                                };

                                await db.chatMessages.add(aiChatMessage);
                            }, 300 + i * 800);
                        }
                    }
                }

                // è®°å½•æ¸¸æˆèŠå¤©äº‹ä»¶
                await recordGameEvent(currentChatCharacter.id, 'game_chat', {
                    gameName: 'äº”å­æ£‹',
                    result: null,
                    score: moveCount,
                    chatContent: `ç”¨æˆ·è¯´ï¼š${content}`
                });

            } catch (error) {
                console.error('æ¸¸æˆèŠå¤©APIè°ƒç”¨å¤±è´¥:', error);
                hideGameChatLoading();

                // é™çº§åˆ°ç®€å•å›å¤
                setTimeout(() => {
                    const aiReplies = [
                        "å“ˆå“ˆï¼Œæœ‰è¶£ï¼",
                        "è¯´å¾—å¯¹å‘¢~",
                        "æˆ‘ä¹Ÿè¿™ä¹ˆæƒ³ï¼",
                        "ç»§ç»­åŠ æ²¹ï¼",
                        "ä½ è¯´è¯çœŸæœ‰æ„æ€",
                        "ä¸“å¿ƒä¸‹æ£‹å•¦~",
                        "å—¯å—¯ï¼Œæˆ‘åœ¨å¬ç€å‘¢",
                        "å¥½çš„å¥½çš„ï¼"
                    ];
                    const reply = aiReplies[Math.floor(Math.random() * aiReplies.length)];
                    addGameChatMessage('ai', reply, true);
                }, 1000 + Math.random() * 2000);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸…ç©ºæ¸¸æˆèŠå¤©
        function clearGameChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ¸¸æˆèŠå¤©è®°å½•å—ï¼Ÿ')) {
                document.getElementById('gomoku-chat-messages').innerHTML = '';
                gomokuGameState.gameSession.chatHistory = [];
                showToast('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘è®°å½•æ¸¸æˆå¼€å§‹äº‹ä»¶
        function recordGameStart() {
            if (currentChatCharacter) {
                recordGameEvent(currentChatCharacter.id, 'game_start', {
                    gameName: 'äº”å­æ£‹',
                    result: null,
                    score: null,
                    chatContent: null
                });
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸…é™¤æ¸¸æˆç›¸å…³çš„æ—¶é—´çº¿è®°å¿†
        async function clearGameTimelineMemories(characterId, gameId) {
            try {
                // è·å–è¯¥è§’è‰²çš„æ‰€æœ‰æ—¶é—´çº¿è®°å¿†
                const allMemories = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                // ç­›é€‰å‡ºå½“å‰æ¸¸æˆä¼šè¯ç›¸å…³çš„è®°å¿†
                const gameMemories = allMemories.filter(memory => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ¸¸æˆç›¸å…³çš„è®°å¿†
                    if (memory.appType !== 'game') return false;

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å½“å‰æ¸¸æˆä¼šè¯ID
                    const data = memory.data || {};
                    return data.gameId === gameId ||
                           (data.id && data.id.includes(gameId)) ||
                           (memory.timestamp >= gomokuGameState.gameStartTime);
                });

                // åˆ é™¤è¿™äº›è®°å¿†
                if (gameMemories.length > 0) {
                    const memoryIds = gameMemories.map(m => m.id);
                    await db.crossAppTimeline.bulkDelete(memoryIds);
                    console.log(`ğŸ® å·²åˆ é™¤ ${gameMemories.length} æ¡æ¸¸æˆæ—¶é—´çº¿è®°å¿†`);
                }
            } catch (error) {
                console.error('æ¸…é™¤æ¸¸æˆæ—¶é—´çº¿è®°å¿†å¤±è´¥:', error);
                throw error;
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘é€€å‡ºäº”å­æ£‹æ¸¸æˆ
        function exitGomokuGame() {
            if (gomokuGameState.gameActive) {
                // æ˜¾ç¤ºé€€å‡ºé€‰é¡¹
                showExitGameModal();
            } else {
                // æ¸¸æˆå·²ç»“æŸï¼Œç›´æ¥è¿”å›
                hideApp('gomoku-game-screen');
                showApp('api-chat-screen');
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ˜¾ç¤ºé€€å‡ºæ¸¸æˆé€‰é¡¹æ¨¡æ€æ¡†
        function showExitGameModal() {
            const modal = document.createElement('div');
            modal.className = 'game-exit-modal';
            modal.innerHTML = `
                <div class="game-exit-overlay"></div>
                <div class="game-exit-content">
                    <div class="game-exit-header">
                        <h3>é€€å‡ºæ¸¸æˆ</h3>
                    </div>
                    <div class="game-exit-body">
                        <p class="game-exit-desc">æ¸¸æˆè¿˜åœ¨è¿›è¡Œä¸­ï¼Œè¯·é€‰æ‹©é€€å‡ºæ–¹å¼ï¼š</p>
                        <div class="game-exit-options">
                            <button class="game-exit-btn save-btn" onclick="exitGameWithSave()">
                                <i class="fas fa-bookmark"></i>
                                <div class="btn-content">
                                    <div class="btn-title">ä¿å­˜å¹¶é€€å‡º</div>
                                    <div class="btn-desc">æ¸¸æˆè¿‡ç¨‹ä¼šè¢«è§’è‰²è®°ä½</div>
                                </div>
                            </button>
                            <button class="game-exit-btn clear-btn" onclick="exitGameWithClear()">
                                <i class="fas fa-eraser"></i>
                                <div class="btn-content">
                                    <div class="btn-title">æ¸…ç©ºå¹¶é€€å‡º</div>
                                    <div class="btn-desc">æ¸…é™¤æ‰€æœ‰è®°å½•ï¼Œå°±åƒä»æœªå‘ç”Ÿè¿‡</div>
                                </div>
                            </button>
                            <button class="game-exit-btn pause-btn" onclick="exitGameTemporary()">
                                <i class="fas fa-pause-circle"></i>
                                <div class="btn-content">
                                    <div class="btn-title">æš‚æ—¶ç¦»å¼€</div>
                                    <div class="btn-desc">ä¿å­˜çŠ¶æ€ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­</div>
                                </div>
                            </button>
                            <button class="game-exit-btn game-cancel-btn" onclick="closeExitGameModal()">
                                <i class="fas fa-times-circle"></i>
                                <div class="btn-content">
                                    <div class="btn-title">å–æ¶ˆ</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°æ‰‹æœºå±å¹•å†…ï¼Œè¿™æ ·å®šä½å°±ç›¸å¯¹äºæ‰‹æœºå±å¹•
            const phoneScreen = document.getElementById('phone-screen');
            if (phoneScreen) {
                phoneScreen.appendChild(modal);
            } else {
                document.body.appendChild(modal);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘å…³é—­é€€å‡ºæ¸¸æˆæ¨¡æ€æ¡†
        function closeExitGameModal() {
            const modal = document.querySelector('.game-exit-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘ä¿å­˜å¹¶é€€å‡ºæ¸¸æˆ
        function exitGameWithSave() {
            // è®°å½•æ¸¸æˆä¸­é€”é€€å‡º
            gomokuGameState.gameSession.gameEvents.push({
                type: 'game_exit_save',
                timestamp: Date.now(),
                player: 'user',
                data: { reason: 'ç”¨æˆ·é€‰æ‹©ä¿å­˜å¹¶é€€å‡º' }
            });

            gomokuGameState.gameActive = false;
            clearInterval(gomokuGameState.gameTimer);

            // æ€»ç»“æ¸¸æˆä¼šè¯
            summarizeGameSession();

            closeExitGameModal();
            hideApp('gomoku-game-screen');
            showApp('api-chat-screen');
            showToast('æ¸¸æˆå·²ä¿å­˜å¹¶é€€å‡º', 'success');
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸…ç©ºå¹¶é€€å‡ºæ¸¸æˆ
        async function exitGameWithClear() {
            // è·å–å½“å‰æ¸¸æˆä¼šè¯ID
            const gameId = gomokuGameState.gameSession?.gameId;

            // æ¸…ç©ºæ¸¸æˆä¼šè¯æ•°æ®
            gomokuGameState.gameSession = {
                gameId: null,
                players: [],
                boardState: [],
                chatHistory: [],
                gameEvents: []
            };

            // æ¸…ç©ºèŠå¤©è®°å½•
            document.getElementById('gomoku-chat-messages').innerHTML = '';

            gomokuGameState.gameActive = false;
            clearInterval(gomokuGameState.gameTimer);

            // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤å½“å‰æ¸¸æˆä¼šè¯ç›¸å…³çš„æ—¶é—´çº¿è®°å¿†
            if (gameId && currentChatCharacter) {
                try {
                    await clearGameTimelineMemories(currentChatCharacter.id, gameId);
                    console.log('ğŸ® å·²æ¸…é™¤æ¸¸æˆç›¸å…³çš„æ—¶é—´çº¿è®°å¿†');
                } catch (error) {
                    console.error('æ¸…é™¤æ¸¸æˆæ—¶é—´çº¿è®°å¿†å¤±è´¥:', error);
                }
            }

            // ä¸è°ƒç”¨æ€»ç»“å‡½æ•°ï¼Œç›´æ¥é€€å‡º
            closeExitGameModal();
            hideApp('gomoku-game-screen');
            showApp('api-chat-screen');
            showToast('æ¸¸æˆè®°å½•å·²æ¸…ç©º', 'success');
        }

        // ğŸ®ã€æ–°å¢ã€‘æš‚æ—¶ç¦»å¼€æ¸¸æˆ
        function exitGameTemporary() {
            // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
            const gameState = {
                board: gomokuGameState.board,
                currentPlayer: gomokuGameState.currentPlayer,
                userIsBlack: gomokuGameState.userIsBlack,
                // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦ç³»ç»Ÿå·²åˆ é™¤
                moveHistory: gomokuGameState.moveHistory,
                gameSession: gomokuGameState.gameSession,
                startTime: gomokuGameState.startTime,
                chatHistory: Array.from(document.getElementById('gomoku-chat-messages').children).map(msg => ({
                    sender: msg.classList.contains('user') ? 'user' : (msg.classList.contains('ai') ? 'ai' : 'system'),
                    content: msg.textContent,
                    timestamp: Date.now()
                }))
            };

            localStorage.setItem('gomoku_saved_game', JSON.stringify(gameState));

            // è®°å½•æš‚æ—¶ç¦»å¼€äº‹ä»¶
            gomokuGameState.gameSession.gameEvents.push({
                type: 'game_pause',
                timestamp: Date.now(),
                player: 'user',
                data: { reason: 'ç”¨æˆ·é€‰æ‹©æš‚æ—¶ç¦»å¼€' }
            });

            gomokuGameState.gameActive = false;
            clearInterval(gomokuGameState.gameTimer);

            closeExitGameModal();
            hideApp('gomoku-game-screen');
            showApp('api-chat-screen');
            showToast('æ¸¸æˆå·²æš‚åœä¿å­˜', 'success');
        }

        // ğŸ®ã€æ–°å¢ã€‘é‡æ–°å¼€å§‹æ¸¸æˆ
        async function restartGomokuGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆ
                localStorage.removeItem('gomoku_saved_game');

                // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                await initGomokuGame();

                showToast('æ¸¸æˆå·²é‡æ–°å¼€å§‹', 'success');
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ‚”æ£‹åŠŸèƒ½ - ä½¿ç”¨çœŸå®APIè°ƒç”¨
        async function undoGomokuMove() {
            if (!gomokuGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸï¼Œæ— æ³•æ‚”æ£‹', 'warning');
                return;
            }

            if (gomokuGameState.moveHistory.length >= 2) {
                // æ’¤é”€æœ€åä¸¤æ­¥ï¼ˆç”¨æˆ·å’ŒAIå„ä¸€æ­¥ï¼‰
                for (let i = 0; i < 2; i++) {
                    const lastMove = gomokuGameState.moveHistory.pop();
                    if (lastMove) {
                        gomokuGameState.board[lastMove.row][lastMove.col] = null;
                    }
                }
                gomokuGameState.currentPlayer = 'user';
                updateBoardUI();
                updateGomokuUI();
                addGameChatMessage('system', 'å·²æ‚”æ£‹ä¸¤æ­¥');

                // ğŸ®ã€æ”¹è¿›ã€‘æ‚”æ£‹äº‹ä»¶è®°å½•
                if (currentChatCharacter) {
                    // è®°å½•æ‚”æ£‹äº‹ä»¶åˆ°æ—¶é—´çº¿
                    await recordCrossAppEvent(
                        currentChatCharacter.id,
                        'game',
                        'undo_move',
                        {
                            id: `undo_${Date.now()}`,
                            type: 'game_undo',
                            gameName: 'äº”å­æ£‹',
                            content: `ç”¨æˆ·åœ¨äº”å­æ£‹æ¸¸æˆä¸­ç”³è¯·æ‚”æ£‹ï¼Œ${currentChatCharacter.name}åŒæ„äº†`,
                            moveCount: gomokuGameState.moveHistory.length,
                            timestamp: Date.now()
                        }
                    );

                    // ä½¿ç”¨ç®€å•çš„é¢„è®¾å›å¤
                    addGameChatMessage('ai', 'å¥½å§ï¼Œç»™ä½ ä¸€æ¬¡æœºä¼š~', true);
                }
            } else {
                showToast('æ— æ³•æ‚”æ£‹ï¼Œæ£‹ç›˜ä¸Šæ£‹å­ä¸è¶³', 'warning');
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘è®¤è¾“åŠŸèƒ½ - ä½¿ç”¨çœŸå®APIè°ƒç”¨
        async function surrenderGomokuGame() {
            if (!gomokuGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸ', 'warning');
                return;
            }

            if (confirm('ç¡®å®šè¦è®¤è¾“å—ï¼Ÿ')) {
                addGameChatMessage('system', 'ä½ é€‰æ‹©äº†è®¤è¾“');

                // ğŸ®ã€æ”¹è¿›ã€‘è®¤è¾“äº‹ä»¶è®°å½•
                if (currentChatCharacter) {
                    // è®°å½•è®¤è¾“äº‹ä»¶åˆ°æ—¶é—´çº¿
                    await recordCrossAppEvent(
                        currentChatCharacter.id,
                        'game',
                        'surrender',
                        {
                            id: `surrender_${Date.now()}`,
                            type: 'game_surrender',
                            gameName: 'äº”å­æ£‹',
                            content: `ç”¨æˆ·åœ¨äº”å­æ£‹æ¸¸æˆä¸­ä¸»åŠ¨è®¤è¾“ï¼Œ${currentChatCharacter.name}è·èƒœ`,
                            result: 'ai_win',
                            moveCount: gomokuGameState.moveHistory.length,
                            timestamp: Date.now()
                        }
                    );

                    // ä½¿ç”¨ç®€å•çš„é¢„è®¾å›å¤
                    addGameChatMessage('ai', 'å¥½çš„ï¼Œè¿™å±€æˆ‘èµ¢äº†ï¼ä¸‹æ¬¡å†æ¥æŒ‘æˆ˜æˆ‘å§~', true);
                }

                // å»¶è¿Ÿç»“æŸæ¸¸æˆï¼Œè®©AIå›åº”å…ˆæ˜¾ç¤º
                setTimeout(() => {
                    endGame('ai');
                }, 1500);
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘å¼€å§‹ä¸‹ä¸€å±€æ¸¸æˆ
        async function startNextGomokuGame() {
            if (gomokuGameState.gameActive) {
                if (!confirm('å½“å‰æ¸¸æˆè¿˜åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦å¼€å§‹æ–°çš„ä¸€å±€å—ï¼Ÿ')) {
                    return;
                }
            }

            // æ¸…é™¤å½“å‰æ¸¸æˆçŠ¶æ€
            localStorage.removeItem('gomoku_saved_game');

            // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
            await initGomokuGame();

            showToast('æ–°çš„ä¸€å±€å¼€å§‹äº†ï¼', 'success');
        }

        // ğŸ®ã€æ–°å¢ã€‘æ¸¸æˆä¼šè¯æ€»ç»“ï¼ˆæŒ‰ç…§ä½ å’ŒGeminiè®¨è®ºçš„æ–¹æ¡ˆï¼‰
        async function summarizeGameSession() {
            if (!currentChatCharacter || !gomokuGameState.gameSession) {
                return;
            }

            try {
                // æ„å»ºæ¸¸æˆäº‹ä»¶æ—¥å¿—
                const gameEvents = gomokuGameState.gameSession.gameEvents;
                const chatHistory = gomokuGameState.gameSession.chatHistory;

                // åˆ†ææ¸¸æˆç»“æœ
                const lastEvent = gameEvents[gameEvents.length - 1];
                let winner = 'unknown';
                let gameResult = 'æ¸¸æˆå¼‚å¸¸ç»“æŸ';

                if (lastEvent && lastEvent.type === 'game_end') {
                    winner = lastEvent.data.winner;
                    if (winner === 'user') {
                        gameResult = 'ç”¨æˆ·è·èƒœ';
                    } else if (winner === 'ai') {
                        gameResult = `${currentChatCharacter.name}è·èƒœ`;
                    } else {
                        gameResult = 'å¹³å±€';
                    }
                }

                // ğŸ®ã€æ”¹è¿›ã€‘ä½¿ç”¨AIç”Ÿæˆäººæ€§åŒ–çš„æ¸¸æˆè®°å¿†æ€»ç»“
                try {
                    const gameDuration = Math.round((Date.now() - gomokuGameState.gameStartTime) / 1000 / 60);
                    const chatSummary = chatHistory.length > 0 ?
                        `æ¸¸æˆæœŸé—´æˆ‘ä»¬èŠäº†${chatHistory.length}æ¡æ¶ˆæ¯ï¼Œ` +
                        (chatHistory.length > 5 ? 'èŠå¾—å¾ˆå¼€å¿ƒ' : 'ç®€å•äº¤æµäº†ä¸€ä¸‹') :
                        'ä¸“å¿ƒä¸‹æ£‹ï¼Œæ²¡æ€ä¹ˆèŠå¤©';

                    // æ„å»ºAIè®°å¿†ç”Ÿæˆçš„æç¤ºè¯
                    const memoryPrompt = `ä½ æ˜¯${currentChatCharacter.name}ï¼Œåˆšåˆšå’Œç”¨æˆ·ä¸‹å®Œäº†ä¸€å±€äº”å­æ£‹ã€‚

æ¸¸æˆè¯¦æƒ…ï¼š
- æ¸¸æˆç»“æœï¼š${gameResult}
- æ¸¸æˆæ—¶é•¿ï¼š${gameDuration}åˆ†é’Ÿ
- æ€»æ­¥æ•°ï¼š${gomokuGameState.moveHistory.length}æ­¥
- èŠå¤©æƒ…å†µï¼š${chatSummary}

è¯·ç”Ÿæˆä¸€ä¸ªäººæ€§åŒ–çš„æƒ…æ™¯è®°å¿†æ€»ç»“ï¼Œè¦æ±‚ï¼š
1. ç”¨ç¬¬ä¸‰äººç§°æè¿°ï¼ˆç”¨"ç”¨æˆ·"å’Œ"${currentChatCharacter.name}"ï¼‰
2. ä½“ç°ä½ çš„æ€§æ ¼ç‰¹ç‚¹
3. åŒ…å«æ¸¸æˆè¿‡ç¨‹ä¸­çš„äº’åŠ¨å’Œæ„Ÿå—
4. å¦‚æœæœ‰èŠå¤©ï¼Œå¯ä»¥æ¦‚æ‹¬èŠå¤©å†…å®¹çš„æ„Ÿå—
5. æ§åˆ¶åœ¨50å­—ä»¥å†…ï¼Œè¦ç”ŸåŠ¨æœ‰è¶£

åªè¿”å›è®°å¿†å†…å®¹ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

                    // è°ƒç”¨AIç”Ÿæˆè®°å¿†
                    const memoryResponse = await callChatAPI(memoryPrompt, currentChatCharacter);
                    let aiGeneratedMemory = '';

                    if (Array.isArray(memoryResponse) && memoryResponse.length > 0) {
                        aiGeneratedMemory = memoryResponse[0].trim();
                    } else if (typeof memoryResponse === 'string') {
                        aiGeneratedMemory = memoryResponse.trim();
                    }

                    // å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨è®°å¿†
                    if (!aiGeneratedMemory) {
                        aiGeneratedMemory = winner === 'user' ?
                            `ç”¨æˆ·åœ¨äº”å­æ£‹ä¸­å‡»è´¥äº†${currentChatCharacter.name}ï¼Œ${chatHistory.length > 0 ? 'æœŸé—´è¿˜æ„‰å¿«åœ°èŠäº†å¤©' : 'ä¸“å¿ƒå¯¹å¼ˆ'}` :
                            winner === 'ai' ?
                            `${currentChatCharacter.name}åœ¨äº”å­æ£‹ä¸­è·èƒœäº†ï¼Œ${chatHistory.length > 0 ? 'æ¸¸æˆè¿‡ç¨‹ä¸­å’Œç”¨æˆ·èŠå¾—å¾ˆå¼€å¿ƒ' : 'ä¸‹å¾—å¾ˆä¸“æ³¨'}` :
                            `${currentChatCharacter.name}å’Œç”¨æˆ·äº”å­æ£‹ä¸‹æˆäº†å¹³å±€ï¼Œ${chatHistory.length > 0 ? 'è¾¹ä¸‹è¾¹èŠå¾ˆæœ‰è¶£' : 'åŠ¿å‡åŠ›æ•Œ'}`;
                    }

                    console.log('ğŸ® AIç”Ÿæˆçš„æ¸¸æˆè®°å¿†:', aiGeneratedMemory);

                    // è®°å½•åˆ°æ—¶é—´çº¿è®°å¿†
                    await recordCrossAppEvent(
                        currentChatCharacter.id,
                        'game',
                        'game_summary',
                        {
                            id: `game_summary_${Date.now()}`,
                            type: 'game_session_summary',
                            gameName: 'äº”å­æ£‹',
                            summary: aiGeneratedMemory,
                            result: gameResult,
                            totalMoves: gomokuGameState.moveHistory.length,
                            chatMessages: chatHistory.length,
                            gameDuration: gameDuration,
                            timestamp: Date.now()
                        }
                    );

                    // æ·»åŠ åˆ°æƒ…æ™¯è®°å¿†
                    await db.episodicMemories.add({
                        id: `game_memory_${Date.now()}`,
                        characterId: currentChatCharacter.id,
                        fact: aiGeneratedMemory,
                        importance: 0.7, // æ¸¸æˆè®°å¿†çš„é‡è¦æ€§
                        timestamp: Date.now(),
                        category: 'game_interaction',
                        contextId: currentChatCharacter.id
                    });

                } catch (error) {
                    console.error('ç”Ÿæˆæ¸¸æˆè®°å¿†å¤±è´¥:', error);

                    // é™çº§åˆ°ç®€å•è®°å¿†
                    const fallbackMemory = winner === 'user' ?
                        'ç”¨æˆ·åœ¨äº”å­æ£‹ä¸­è·èƒœäº†' :
                        winner === 'ai' ?
                        `${currentChatCharacter.name}åœ¨äº”å­æ£‹ä¸­è·èƒœäº†` :
                        'äº”å­æ£‹ä¸‹æˆäº†å¹³å±€';

                    await db.episodicMemories.add({
                        id: `game_memory_${Date.now()}`,
                        characterId: currentChatCharacter.id,
                        fact: fallbackMemory,
                        importance: 0.7,
                        timestamp: Date.now(),
                        category: 'game_interaction',
                        contextId: currentChatCharacter.id
                    });
                }

                console.log('ğŸ® æ¸¸æˆè®°å¿†å·²ä¿å­˜åˆ°å…¨å±€è®°å¿†ç³»ç»Ÿ');
                showToast('æ¸¸æˆè®°å½•å·²ä¿å­˜', 'success');

            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆè®°å¿†å¤±è´¥:', error);
            }
        }

        // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦è®¾ç½®ç›¸å…³å‡½æ•°å·²åˆ é™¤
        // AIç°åœ¨æ ¹æ®è§’è‰²æ€§æ ¼å’Œæ™ºèƒ½ç¨‹åº¦è¿›è¡Œä¸‹æ£‹å†³ç­–

        // ğŸ®ã€æ–°å¢ã€‘ç›‘å¬æ¸¸æˆèŠå¤©è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const gameInput = document.getElementById('gomoku-chat-input');
            if (gameInput) {
                gameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendGameChatMessage();
                    }
                });
            }

            // ğŸ®ã€ç§»é™¤ã€‘éš¾åº¦è®¾ç½®åŠ è½½å·²åˆ é™¤
        });

        // ================== æµ·é¾Ÿæ±¤æ¸¸æˆç³»ç»Ÿ ==================

        // ğŸ®ã€æ–°å¢ã€‘æµ·é¾Ÿæ±¤æ¸¸æˆçŠ¶æ€ç®¡ç†
        let turtleSoupGameState = {
            gameActive: false,
            gameStartTime: null,
            currentStory: null,
            currentAnswer: null,
            questionCount: 0,
            gameTimer: null,
            gameSession: null,
            dmPersonality: 'friendly', // DMæ€§æ ¼ï¼šfriendly, mysterious, humorous
            gameMode: 'single' // single æˆ– group
        };

        // ğŸ®ã€æ–°å¢ã€‘æµ·é¾Ÿæ±¤æ•…äº‹åº“ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
        const turtleSoupStories = [
            {
                id: 1,
                title: "æ·±å¤œçš„ç”µè¯",
                story: "ä¸€ä¸ªç”·äººåœ¨æ·±å¤œæ¥åˆ°ä¸€ä¸ªç”µè¯ï¼Œå¬äº†å‡ å¥è¯åå°±è‡ªæ€äº†ã€‚",
                answer: "è¿™ä¸ªç”·äººæ˜¯ç›²äººï¼Œç”µè¯é‡Œå‘Šè¯‰ä»–åŒ»é™¢å¼„é”™äº†ï¼Œä»–çš„çœ¼ç›å…¶å®æ²¡æœ‰æ²»å¥½ï¼Œä»–ä»¥ä¸ºè‡ªå·±é‡è§å…‰æ˜äº†ï¼Œä½†å…¶å®ä¸€ç›´éƒ½æ˜¯é»‘æš—çš„ã€‚",
                difficulty: "medium",
                tags: ["classic", "å¿ƒç†", "åŒ»ç–—", "è¯¯è§£"]
            },
            {
                id: 2,
                title: "æ¨é—¨è€Œå…¥",
                story: "ä¸€ä¸ªäººæ¨é—¨è¿›å…¥æˆ¿é—´ï¼Œçœ‹åˆ°æˆ¿é—´é‡Œçš„æƒ…å†µåç«‹å³æŠ¥è­¦ã€‚",
                answer: "è¿™ä¸ªäººæ˜¯é‚®é€’å‘˜ï¼Œæ¨é—¨è¿›å…¥æ—¶å‘ç°å±‹ä¸»å·²ç»æ­»äº†å¾ˆä¹…ï¼Œå°¸ä½“è…çƒ‚å‘è‡­ã€‚",
                difficulty: "easy",
                tags: ["classic", "æ—¥å¸¸", "å‘ç°", "æ­»äº¡"]
            },
            {
                id: 3,
                title: "åŠå¤œæƒŠé†’",
                story: "ä¸€ä¸ªå¥³äººåŠå¤œæƒŠé†’ï¼Œå‘ç°ä¸ˆå¤«ä¸åœ¨èº«è¾¹ï¼Œäºæ˜¯ç«‹åˆ»æŠ¥è­¦ã€‚",
                answer: "è¿™ä¸ªå¥³äººæ˜¯ç›²äººï¼Œå¹³æ—¶ä¸ˆå¤«éƒ½ä¼šåœ¨å¥¹èº«è¾¹ï¼Œä½†è¿™æ¬¡å¥¹æ‘¸åˆ°çš„æ˜¯ä¸€å…·å†°å†·çš„å°¸ä½“ï¼Œä¸ˆå¤«å·²ç»æ­»äº†ã€‚",
                difficulty: "hard",
                tags: ["horror", "å¤«å¦»", "ç›²äºº", "æ­»äº¡"]
            },
            {
                id: 4,
                title: "æ¶ˆå¤±çš„å½±å­",
                story: "ä¸€ä¸ªç”·äººå‘ç°è‡ªå·±çš„å½±å­æ¶ˆå¤±äº†ï¼Œä»–å››å¤„å¯»æ‰¾ï¼Œæœ€ååœ¨ä¸€é¢é•œå­å‰æ‰¾åˆ°äº†å®ƒã€‚",
                answer: "ç”·äººå¾—äº†ä¸¥é‡çš„æŠ‘éƒç—‡ï¼Œè§‰å¾—è‡ªå·±åƒè¡Œå°¸èµ°è‚‰ä¸€æ ·æ²¡æœ‰çµé­‚ã€‚'æ‰¾åˆ°å½±å­'å…¶å®æ˜¯ä»–é‡æ–°æ‰¾å›äº†ç”Ÿæ´»çš„å¸Œæœ›å’Œè‡ªæˆ‘è®¤åŒã€‚",
                difficulty: "easy",
                tags: ["funny", "å¹½é»˜", "å¿ƒç†", "æ¯”å–»"]
            },
            {
                id: 5,
                title: "çˆ±æƒ…çš„è¯æ˜",
                story: "ä¸€ä¸ªç”·äººæ¯å¤©éƒ½ç»™å¥³æœ‹å‹ä¹°åŒæ ·çš„èŠ±ï¼Œç›´åˆ°æœ‰ä¸€å¤©ä»–ä¹°äº†ä¸åŒçš„èŠ±ï¼Œå¥³æœ‹å‹å°±å’Œä»–åˆ†æ‰‹äº†ã€‚",
                answer: "å¥³æœ‹å‹å¯¹é‚£ç§èŠ±è¿‡æ•ï¼Œç”·äººæ¯å¤©ä¹°åŒæ ·çš„èŠ±æ˜¯å› ä¸ºè®°ä½äº†å¥¹çš„è¿‡æ•ç—‡ã€‚ä¹°ä¸åŒèŠ±è¯´æ˜ä»–å¿˜è®°äº†å¥¹çš„èº«ä½“çŠ¶å†µï¼Œå¥¹è§‰å¾—ä»–ä¸å¤Ÿå…³å¿ƒè‡ªå·±ã€‚",
                difficulty: "medium",
                tags: ["romantic", "çˆ±æƒ…", "å…³å¿ƒ", "ç»†èŠ‚"]
            },
            {
                id: 6,
                title: "ç¥ç§˜çš„ç¤¼ç‰©",
                story: "ä¸€ä¸ªå¥³äººæ”¶åˆ°åŒ¿åç¤¼ç‰©ï¼Œæ˜¯ä¸€æŠŠé’¥åŒ™ï¼Œå¥¹ç”¨è¿™æŠŠé’¥åŒ™æ‰“å¼€äº†è‡ªå·±å®¶çš„é—¨ã€‚",
                answer: "å¥³äººå¤±å¿†äº†ï¼Œå¿˜è®°äº†è‡ªå·±çš„å®¶åœ¨å“ªé‡Œã€‚é€é’¥åŒ™çš„æ˜¯å¥¹çš„ä¸ˆå¤«ï¼Œç”¨è¿™ç§æ–¹å¼å¸®åŠ©å¥¹æ‰¾å›å›å®¶çš„è·¯ã€‚",
                difficulty: "medium",
                tags: ["romantic", "çˆ±æƒ…", "å¤±å¿†", "æ¸©æš–"]
            }
        ];

        // ğŸ®ã€ä¿®å¤ã€‘å¯åŠ¨æµ·é¾Ÿæ±¤æ¸¸æˆ - å­¦ä¹ äº”å­æ£‹çš„å¯åŠ¨é€»è¾‘
        async function startTurtleSoupGame() {
            // ğŸ”¥ã€ä¿®å¤ã€‘å­¦ä¹ äº”å­æ£‹ï¼Œä»å½“å‰ç•Œé¢è¿›å…¥æ¸¸æˆ
            // å¦‚æœåœ¨APIèŠå¤©ç•Œé¢ï¼Œéšè—APIèŠå¤©ç•Œé¢
            if (document.getElementById('api-chat-screen').style.display !== 'none') {
                hideApp('api-chat-screen');
            }
            // å¦‚æœåœ¨æ¶ˆæ¯åˆ—è¡¨ç•Œé¢ï¼Œéšè—æ¶ˆæ¯åˆ—è¡¨ç•Œé¢
            if (document.getElementById('chat-screen').style.display !== 'none') {
                hideApp('chat-screen');
            }

            showApp('turtle-soup-game-screen');

            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            await initTurtleSoupGame();
        }

        // ğŸ®ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–æµ·é¾Ÿæ±¤æ¸¸æˆ - æ”¯æŒç”¨æˆ·åå¥½è®¾ç½®
        async function initTurtleSoupGame() {
            // ç¡®å®šæ¸¸æˆæ¨¡å¼
            const gameMode = currentChatCharacter && currentChatCharacter.isGroup ? 'group' : 'single';

            // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½ç”¨æˆ·è®¾ç½®
            let userSettings = { preferredType: 'random', dmPersonality: 'friendly' };
            try {
                const settings = await db.globalSettings.get('turtleSoupSettings');
                if (settings && settings.value) {
                    userSettings = settings.value;
                }
            } catch (error) {
                console.error('åŠ è½½æµ·é¾Ÿæ±¤è®¾ç½®å¤±è´¥:', error);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘è®©DM AIè‡ªåŠ¨ç”Ÿæˆæµ·é¾Ÿæ±¤æ•…äº‹
            let storyData;
            try {
                console.log('ğŸ­ DMæ­£åœ¨åˆ›ä½œæ–°çš„æµ·é¾Ÿæ±¤æ•…äº‹...');
                storyData = await generateTurtleSoupStoryByDM(userSettings.preferredType);
            } catch (error) {
                console.error('DMç”Ÿæˆæ•…äº‹å¤±è´¥ï¼Œä½¿ç”¨é¢„è®¾æ•…äº‹:', error);
                // å›é€€åˆ°é¢„è®¾æ•…äº‹
                let availableStories = turtleSoupStories;
                if (userSettings.preferredType !== 'random') {
                    availableStories = turtleSoupStories.filter(story =>
                        story.tags && story.tags.includes(userSettings.preferredType)
                    );
                    if (availableStories.length === 0) {
                        availableStories = turtleSoupStories;
                    }
                }
                storyData = availableStories[Math.floor(Math.random() * availableStories.length)];
            }

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            turtleSoupGameState = {
                gameActive: true,
                gameStartTime: Date.now(),
                currentStory: storyData,
                currentAnswer: storyData.answer,
                questionCount: 0,
                gameTimer: null,
                gameMode: gameMode,
                dmPersonality: userSettings.dmPersonality,
                gameSession: {
                    gameId: `turtle_soup_${Date.now()}`,
                    players: gameMode === 'group' ? ['user', ...Object.keys(currentChatCharacter.members || {})] : ['user', currentChatCharacter.id],
                    storyId: storyData.id,
                    chatHistory: [],
                    gameEvents: [
                        {
                            type: 'game_start',
                            timestamp: Date.now(),
                            player: 'system',
                            data: {
                                gameName: 'æµ·é¾Ÿæ±¤',
                                storyTitle: storyData.title,
                                gameMode: gameMode
                            }
                        }
                    ]
                }
            };

            // æ›´æ–°UI
            updateTurtleSoupUI();
            startTurtleSoupTimer();

            // æ¸…ç©ºèŠå¤©è®°å½•
            const chatContainer = document.getElementById('turtle-soup-chat-messages');
            chatContainer.innerHTML = '';

            // DMå¼€åœºç™½
            setTimeout(() => {
                showDMMessage("æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆï¼æˆ‘æ˜¯ä½ ä»¬çš„æ¸¸æˆä¸»æŒäººã€‚");
            }, 500);

            setTimeout(() => {
                showDMMessage("è§„åˆ™å¾ˆç®€å•ï¼šæˆ‘ä¼šç»™å‡ºä¸€ä¸ªçœ‹ä¼¼ä¸åˆç†çš„æƒ…æ™¯ï¼Œä½ ä»¬é€šè¿‡æé—®æ¥æ¨ç†å‡ºçœŸç›¸ã€‚");
            }, 1500);

            setTimeout(() => {
                showDMMessage("è®°ä½ï¼Œä½ ä»¬åªèƒ½é—®æ˜¯/å¦é—®é¢˜ï¼Œæˆ‘åªä¼šå›ç­”'æ˜¯'ã€'å¦'æˆ–'æ— å…³'ã€‚");
            }, 2500);

            setTimeout(() => {
                showDMMessage("å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼");
            }, 3500);

            setTimeout(() => {
                presentStory(storyData);
            }, 4500);
        }

        // ğŸ®ã€æ–°å¢ã€‘å±•ç¤ºæ•…äº‹ï¼ˆæ±¤é¢ï¼‰
        function presentStory(story) {
            // æ›´æ–°æ±¤é¢æ˜¾ç¤º
            const storyElement = document.getElementById('turtle-soup-story-content');
            storyElement.textContent = story.story;

            // DMä»‹ç»æ•…äº‹
            setTimeout(() => {
                showDMMessage(`è¿™å°±æ˜¯ä»Šå¤©çš„æ±¤é¢ï¼š"${story.title}"`);
            }, 500);

            setTimeout(() => {
                showDMMessage("ç°åœ¨å¼€å§‹ä½ ä»¬çš„æ¨ç†å§ï¼è®°ä½åªèƒ½é—®æ˜¯/å¦é—®é¢˜å“¦~");
            }, 1500);

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºæ±¤é¢ï¼Œæ±¤é¢åªåœ¨ä¸Šæ–¹æ¸¸æˆåŒºåŸŸæ˜¾ç¤º
        }

        // ğŸ®ã€ä¿®æ”¹ã€‘æ˜¾ç¤ºDMæ¶ˆæ¯ - æ”¯æŒå†å²è®°å½•å’Œè§’è‰²å¯è¯»
        function showDMMessage(message, shouldRecord = true) {
            const dmMessageElement = document.getElementById('turtle-soup-dm-message');
            dmMessageElement.textContent = message;

            // ğŸ”¥ã€æ–°å¢ã€‘è®°å½•DMæ¶ˆæ¯åˆ°æ¸¸æˆå†å²ï¼Œè®©è§’è‰²èƒ½å¤Ÿè¯»å–
            if (shouldRecord && turtleSoupGameState.gameActive) {
                const dmMessage = {
                    id: `dm_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    sender: 'dm',
                    content: message,
                    timestamp: Date.now(),
                    isGameMessage: true,
                    gameName: 'æµ·é¾Ÿæ±¤'
                };

                // æ·»åŠ åˆ°æ¸¸æˆä¼šè¯å†å²
                turtleSoupGameState.gameSession.chatHistory.push(dmMessage);

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸å†å°†DMæ¶ˆæ¯æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œé¿å…æ±¡æŸ“æ­£å¸¸èŠå¤©
                // DMæ¶ˆæ¯åªä¿å­˜åœ¨æ¸¸æˆä¼šè¯ä¸­ï¼Œé€€å‡ºæ¸¸æˆåä¸ä¼šæ˜¾ç¤ºåœ¨ä¸»èŠå¤©ç•Œé¢
            }
        }

        // ğŸ®ã€ä¿®æ”¹ã€‘æ·»åŠ æµ·é¾Ÿæ±¤èŠå¤©æ¶ˆæ¯ - ç§»é™¤å¤´åƒï¼Œåªæ˜¾ç¤ºæ°”æ³¡
        function addTurtleSoupChatMessage(sender, content, shouldRecord = false) {
            const messagesContainer = document.getElementById('turtle-soup-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `game-chat-message ${sender}`;

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸æ˜¾ç¤ºå¤´åƒï¼Œç›´æ¥åˆ›å»ºæ°”æ³¡

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'game-chat-bubble';
            bubbleDiv.textContent = content;

            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // è®°å½•åˆ°æ¸¸æˆä¼šè¯
            const chatMessage = {
                id: `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                sender,
                content,
                timestamp: Date.now(),
                isGameMessage: true,
                gameName: 'æµ·é¾Ÿæ±¤'
            };
            turtleSoupGameState.gameSession.chatHistory.push(chatMessage);

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸å†å°†æ¸¸æˆæ¶ˆæ¯æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œé¿å…æ±¡æŸ“æ­£å¸¸èŠå¤©
            // æ¸¸æˆæ¶ˆæ¯åªä¿å­˜åœ¨æ¸¸æˆä¼šè¯ä¸­ï¼Œé€€å‡ºæ¸¸æˆåä¸ä¼šæ˜¾ç¤ºåœ¨ä¸»èŠå¤©ç•Œé¢
            if (shouldRecord && currentChatCharacter) {
                // è®°å½•åˆ°å…¨å±€è®°å¿†ç³»ç»Ÿï¼ˆç”¨äºAIè®°å¿†ï¼Œä½†ä¸æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ï¼‰
                recordGameChat(currentChatCharacter.id, sender, content, {
                    gameName: 'æµ·é¾Ÿæ±¤',
                    gameState: 'playing'
                });
            }
        }

        // ğŸ®ã€é‡æ„ã€‘å‘é€æµ·é¾Ÿæ±¤é—®é¢˜ - å­¦ä¹ äº”å­æ£‹çš„å›åˆåˆ¶æœºåˆ¶
        async function sendTurtleSoupQuestion() {
            const input = document.getElementById('turtle-soup-chat-input');
            const content = input.value.trim();

            if (!content) return;
            if (!turtleSoupGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸ', 'warning');
                return;
            }

            // æ·»åŠ ç”¨æˆ·é—®é¢˜
            addTurtleSoupChatMessage('user', content, true);
            input.value = '';

            // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘ç«‹å³è®©è§’è‰²å›åº”ï¼Œå°±åƒäº”å­æ£‹ä¸­AIç«‹å³ä¸‹æ£‹ä¸€æ ·
            setTimeout(async () => {
                try {
                    await generateCharacterTurtleSoupResponse(content);
                } catch (error) {
                    console.error('è§’è‰²å›åº”ç”Ÿæˆå¤±è´¥:', error);
                    // æ·»åŠ é»˜è®¤å›åº”ï¼Œç¡®ä¿æ¸¸æˆç»§ç»­
                    const defaultResponses = [
                        "å—¯ï¼Œè®©æˆ‘æƒ³æƒ³...",
                        "è¿™ä¸ªçº¿ç´¢å¾ˆæœ‰æ„æ€",
                        "è¿˜æœ‰å…¶ä»–å¯èƒ½å—ï¼Ÿ",
                        "æˆ‘è§‰å¾—è¿™ä¸ªæ–¹å‘å€¼å¾—æ¢ç´¢"
                    ];
                    const randomResponse = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
                    addTurtleSoupChatMessage(currentChatCharacter.id, randomResponse, true);
                }
            }, 800 + Math.random() * 1200); // ç¼©çŸ­å»¶è¿Ÿï¼Œæ›´åƒäº”å­æ£‹çš„å³æ—¶å›åº”
        }

        // ğŸ”¥ã€é‡æ„ã€‘å‘è¨€ç»“æŸï¼Œè§¦å‘DMå·¥ä½œ - å­¦ä¹ äº”å­æ£‹çš„å³æ—¶å›åº”æœºåˆ¶
        async function finishSpeakingAndTriggerDM() {
            if (!turtleSoupGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸ', 'warning');
                return;
            }

            // ğŸ”¥ã€æ”¹è¿›ã€‘æ”¶é›†è¿™ä¸€è½®çš„å®Œæ•´è®¨è®ºå†…å®¹ï¼ˆç”¨æˆ·+è§’è‰²ï¼‰
            const recentMessages = turtleSoupGameState.gameSession.chatHistory
                .slice(-10) // å¢åŠ åˆ†æèŒƒå›´
                .filter(msg => msg.sender === 'user' || (msg.sender !== 'dm' && msg.sender !== 'system'))
                .map(msg => `${msg.sender}: ${msg.content}`)
                .join('\n');

            if (!recentMessages.trim()) {
                showToast('è¯·å…ˆæå‡ºé—®é¢˜æˆ–è¿›è¡Œè®¨è®º', 'warning');
                return;
            }

            // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘ç«‹å³æ˜¾ç¤ºDMçŠ¶æ€ï¼Œå°±åƒäº”å­æ£‹æ˜¾ç¤º"AIæ€è€ƒä¸­"
            showDMMessage('ğŸ­ DMæ­£åœ¨åˆ†æè®¨è®º...');

            // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘æ›´å¿«çš„å“åº”æ—¶é—´
            setTimeout(async () => {
                try {
                    const dmResponse = await generateDMResponseToDiscussion(recentMessages);

                    // æ›´æ–°DMæ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
                    showDMMessage(dmResponse);

                    // ğŸ”¥ã€ä¿®æ”¹ã€‘DMæ¶ˆæ¯ä¸æ·»åŠ åˆ°ä¸‹æ–¹èŠå¤©åŒºåŸŸï¼Œåªåœ¨ä¸Šæ–¹æ¸¸æˆåŒºåŸŸæ˜¾ç¤º

                    // ğŸ”¥ã€æ”¹è¿›ã€‘æ›´æ™ºèƒ½çš„é—®é¢˜è®¡æ•°
                    const hasQuestion = recentMessages.includes('?') || recentMessages.includes('ï¼Ÿ') ||
                                      recentMessages.includes('æ˜¯å¦') || recentMessages.includes('æ˜¯ä¸æ˜¯') ||
                                      recentMessages.includes('ä¼šä¸ä¼š') || recentMessages.includes('æœ‰æ²¡æœ‰');

                    if (hasQuestion) {
                        turtleSoupGameState.questionCount++;
                        updateTurtleSoupUI();
                    }

                } catch (error) {
                    console.error('DMå›åº”ç”Ÿæˆå¤±è´¥:', error);
                    // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘æä¾›å¤‡ç”¨å›åº”ï¼Œç¡®ä¿æ¸¸æˆç»§ç»­
                    const backupResponses = [
                        "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼Œè®©æˆ‘æƒ³æƒ³...",
                        "ä½ ä»¬çš„æ¨ç†å¾ˆæœ‰é“ç†",
                        "ç»§ç»­è¿™ä¸ªæ€è·¯è¯•è¯•",
                        "è¿˜éœ€è¦æ›´å¤šçº¿ç´¢",
                        "è¿™ä¸ªæ–¹å‘å€¼å¾—æ·±å…¥"
                    ];
                    const backupResponse = backupResponses[Math.floor(Math.random() * backupResponses.length)];
                    showDMMessage(backupResponse);
                    // ğŸ”¥ã€ä¿®æ”¹ã€‘DMå¤‡ç”¨å›åº”ä¹Ÿä¸æ·»åŠ åˆ°ä¸‹æ–¹èŠå¤©åŒºåŸŸ
                }
            }, 500 + Math.random() * 1000); // æ›´å¿«çš„å“åº”ï¼Œåƒäº”å­æ£‹ä¸€æ ·
        }

        // ğŸ”¥ã€æ–°å¢ã€‘DMåˆ†æè®¨è®ºå†…å®¹å¹¶å›åº”
        async function generateDMResponseToDiscussion(discussionContent) {
            const story = turtleSoupGameState.currentStory;
            const answer = turtleSoupGameState.currentAnswer;
            const questionCount = turtleSoupGameState.questionCount;

            // è·å–æ¸¸æˆå†å²
            const gameHistory = turtleSoupGameState.gameSession.chatHistory
                .slice(-15)
                .map(msg => `${msg.sender}: ${msg.content}`)
                .join('\n');

            const dmPersonality = turtleSoupGameState.dmPersonality || 'friendly';
            let personalityGuide = '';

            switch (dmPersonality) {
                case 'friendly':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªå‹å–„è€å¿ƒçš„DMï¼Œä¼šç»™äºˆç©å®¶é¼“åŠ±å’Œé€‚å½“çš„æç¤ºï¼Œè¯­æ°”æ¸©å’Œäº²åˆ‡ã€‚';
                    break;
                case 'mysterious':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªç¥ç§˜è«æµ‹çš„DMï¼Œå›ç­”ç®€æ´å†·é™ï¼Œä¿æŒç¥ç§˜æ„Ÿï¼Œå¾ˆå°‘ç»™å‡ºé¢å¤–ä¿¡æ¯ã€‚';
                    break;
                case 'humorous':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªå¹½é»˜é£è¶£çš„DMï¼Œä¼šç”¨è½»æ¾å¹½é»˜çš„è¯­æ°”å›ç­”ï¼Œå¶å°”å¼€ä¸ªå°ç©ç¬‘æ´»è·ƒæ°”æ°›ã€‚';
                    break;
                default:
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„DMï¼Œä¿æŒä¸­æ€§çš„æ€åº¦ã€‚';
            }

            const dmPrompt = `ä½ æ˜¯æµ·é¾Ÿæ±¤æ¸¸æˆçš„ä¸“ä¸šä¸»æŒäºº(DM)ã€‚${personalityGuide}

ã€å½“å‰æ±¤é¢ã€‘ï¼š${story.story}
ã€æ±¤åº•çœŸç›¸ã€‘ï¼š${answer}

ã€æ¸¸æˆè¿›å±•ã€‘ï¼š
- å·²æé—®æ¬¡æ•°ï¼š${questionCount}
- æ¸¸æˆå†å²ï¼š
${gameHistory}

ã€è¿™è½®ç”¨æˆ·å’Œè§’è‰²çš„è®¨è®ºå†…å®¹ã€‘ï¼š
${discussionContent}

è¯·åˆ†æç”¨æˆ·å’Œè§’è‰²è¿™è½®çš„è®¨è®ºï¼Œå¹¶ç»™å‡ºåˆé€‚çš„å›åº”ï¼š

1. å¦‚æœåŒ…å«æ˜ç¡®çš„æ˜¯/å¦é—®é¢˜ï¼Œè¯·å›ç­”"æ˜¯"ã€"å¦"æˆ–"æ— å…³"
2. å¦‚æœæ˜¯è®¨è®ºå’Œæ¨ç†ï¼Œç»™äºˆé€‚å½“çš„å¼•å¯¼å’Œé¼“åŠ±
3. å¦‚æœæ¨ç†æ–¹å‘æ­£ç¡®ï¼Œç»™äºˆè‚¯å®šå’Œæç¤º
4. å¦‚æœæ¨ç†åç¦»ï¼Œç»™äºˆæ¸©å’Œçš„çº æ­£
5. å¦‚æœè®¨è®ºåœæ»ï¼Œæä¾›æ–°çš„æ€è€ƒè§’åº¦
6. ä¿æŒç¥ç§˜æ„Ÿï¼Œä¸è¦ç›´æ¥é€éœ²ç­”æ¡ˆ
7. å›ç­”è¦ç®€æ´æ˜ç¡®ï¼ˆä¸è¶…è¿‡30å­—ï¼‰

é‡è¦ï¼šè¯·ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬å›ç­”ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼æˆ–æ•°ç»„æ ¼å¼ã€‚

è¯·ç»™å‡ºä½ çš„å›åº”ï¼š`;

            try {
                const response = await callTurtleSoupDMAPI(dmPrompt);
                let dmResponse = '';

                if (Array.isArray(response) && response.length > 0) {
                    dmResponse = response[0].trim();
                } else if (typeof response === 'string') {
                    dmResponse = response.trim();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†DMå›åº”ä¸­çš„JSONæ ¼å¼
                if (dmResponse.startsWith('```json') || dmResponse.startsWith('```')) {
                    // ç§»é™¤ä»£ç å—æ ‡è®°
                    dmResponse = dmResponse.replace(/```json\s*|\s*```/g, '').trim();
                }

                if (dmResponse.startsWith('[') && dmResponse.endsWith(']')) {
                    try {
                        // å¦‚æœæ˜¯JSONæ•°ç»„ï¼Œæå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                        const parsed = JSON.parse(dmResponse);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            dmResponse = parsed[0].toString().trim();
                        }
                    } catch (e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œç§»é™¤æ–¹æ‹¬å·
                        dmResponse = dmResponse.replace(/^\[|\]$/g, '').trim();
                        // ç§»é™¤å¼•å·
                        if (dmResponse.startsWith('"') && dmResponse.endsWith('"')) {
                            dmResponse = dmResponse.slice(1, -1);
                        }
                    }
                }

                if (!dmResponse || dmResponse.length > 100) {
                    throw new Error('DMå›åº”æ ¼å¼ä¸æ­£ç¡®');
                }

                return dmResponse;
            } catch (error) {
                console.error('DMå›åº”ç”Ÿæˆå¤±è´¥:', error);
                throw error;
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘ç‹¬ç«‹çš„æµ·é¾Ÿæ±¤DM AIç³»ç»Ÿ
        async function generateAIDMAnswer(question) {
            const story = turtleSoupGameState.currentStory;
            const answer = turtleSoupGameState.currentAnswer;
            const questionCount = turtleSoupGameState.questionCount;

            // è·å–æœ€è¿‘çš„æ¸¸æˆå¯¹è¯å†å²
            const recentHistory = turtleSoupGameState.gameSession.chatHistory
                .slice(-10)
                .map(msg => `${msg.sender}: ${msg.content}`)
                .join('\n');

            // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®DMæ€§æ ¼è°ƒæ•´prompté£æ ¼
            const dmPersonality = turtleSoupGameState.dmPersonality || 'friendly';
            let personalityGuide = '';

            switch (dmPersonality) {
                case 'friendly':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªå‹å–„è€å¿ƒçš„DMï¼Œä¼šç»™äºˆç©å®¶é¼“åŠ±å’Œé€‚å½“çš„æç¤ºï¼Œè¯­æ°”æ¸©å’Œäº²åˆ‡ã€‚';
                    break;
                case 'mysterious':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªç¥ç§˜è«æµ‹çš„DMï¼Œå›ç­”ç®€æ´å†·é™ï¼Œä¿æŒç¥ç§˜æ„Ÿï¼Œå¾ˆå°‘ç»™å‡ºé¢å¤–ä¿¡æ¯ã€‚';
                    break;
                case 'humorous':
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªå¹½é»˜é£è¶£çš„DMï¼Œä¼šç”¨è½»æ¾å¹½é»˜çš„è¯­æ°”å›ç­”ï¼Œå¶å°”å¼€ä¸ªå°ç©ç¬‘æ´»è·ƒæ°”æ°›ã€‚';
                    break;
                default:
                    personalityGuide = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„DMï¼Œä¿æŒä¸­æ€§çš„æ€åº¦ã€‚';
            }

            const dmPrompt = `ä½ æ˜¯æµ·é¾Ÿæ±¤æ¸¸æˆçš„ä¸“ä¸šä¸»æŒäºº(DM)ã€‚${personalityGuide}

ã€å½“å‰æ±¤é¢ã€‘ï¼š${story.story}
ã€æ±¤åº•çœŸç›¸ã€‘ï¼š${answer}

ã€æ¸¸æˆè§„åˆ™ã€‘ï¼š
1. ç©å®¶åªèƒ½é—®æ˜¯/å¦é—®é¢˜
2. ä½ åªèƒ½å›ç­”"æ˜¯"ã€"å¦"æˆ–"æ— å…³"
3. å¦‚æœé—®é¢˜ä¸çœŸç›¸æ— å…³ï¼Œå›ç­”"æ— å…³"
4. å¦‚æœé—®é¢˜æ¥è¿‘çœŸç›¸ï¼Œå¯ä»¥ç»™äºˆé¼“åŠ±
5. ä¿æŒç¥ç§˜æ„Ÿï¼Œä¸è¦ç›´æ¥é€éœ²ç­”æ¡ˆ

ã€å½“å‰æ¸¸æˆçŠ¶æ€ã€‘ï¼š
- å·²æé—®æ¬¡æ•°ï¼š${questionCount}
- æœ€è¿‘å¯¹è¯ï¼š
${recentHistory}

ã€ç©å®¶é—®é¢˜ã€‘ï¼š${question}

è¯·æ ¹æ®ä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼Œä½œä¸ºä¸“ä¸šçš„æµ·é¾Ÿæ±¤DMç»™å‡ºç®€æ´æ˜ç¡®çš„å›ç­”ï¼ˆä¸è¶…è¿‡20å­—ï¼‰ã€‚å¦‚æœé—®é¢˜å¾ˆæ¥è¿‘çœŸç›¸ï¼Œå¯ä»¥ç»™äºˆé€‚å½“çš„æç¤ºå’Œé¼“åŠ±ã€‚

é‡è¦ï¼šè¯·ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬å›ç­”ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼æˆ–æ•°ç»„æ ¼å¼ã€‚`;

            try {
                // ğŸ”¥ã€é‡è¦ã€‘ä½¿ç”¨ç‹¬ç«‹çš„APIè°ƒç”¨ï¼Œä¸ä¾èµ–ç°æœ‰è§’è‰²
                const response = await callTurtleSoupDMAPI(dmPrompt);
                let dmAnswer = '';

                if (Array.isArray(response) && response.length > 0) {
                    dmAnswer = response[0].trim();
                } else if (typeof response === 'string') {
                    dmAnswer = response.trim();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†DMå›ç­”ä¸­çš„JSONæ ¼å¼
                if (dmAnswer.startsWith('```json') || dmAnswer.startsWith('```')) {
                    dmAnswer = dmAnswer.replace(/```json\s*|\s*```/g, '').trim();
                }

                if (dmAnswer.startsWith('[') && dmAnswer.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(dmAnswer);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            dmAnswer = parsed[0].toString().trim();
                        }
                    } catch (e) {
                        dmAnswer = dmAnswer.replace(/^\[|\]$/g, '').trim();
                        if (dmAnswer.startsWith('"') && dmAnswer.endsWith('"')) {
                            dmAnswer = dmAnswer.slice(1, -1);
                        }
                    }
                }

                // ç¡®ä¿å›ç­”ç¬¦åˆæ¸¸æˆè§„åˆ™
                if (!dmAnswer || dmAnswer.length > 50) {
                    throw new Error('AIå›ç­”æ ¼å¼ä¸æ­£ç¡®');
                }

                return dmAnswer;
            } catch (error) {
                console.error('AI DMå›ç­”ç”Ÿæˆå¤±è´¥:', error);
                throw error;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç‹¬ç«‹çš„æµ·é¾Ÿæ±¤DM APIè°ƒç”¨å‡½æ•°
        async function callTurtleSoupDMAPI(prompt) {
            // ğŸ”¥ã€ä¿®å¤ã€‘ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ apiSettings
            console.log('ğŸ­ DM APIè°ƒç”¨å¼€å§‹ï¼Œæ£€æŸ¥APIè®¾ç½®:', apiSettings);

            if (!apiSettings.key || !apiSettings.base) {
                throw new Error('APIè®¾ç½®ä¸å®Œæ•´ï¼Œè¯·å…ˆé…ç½®API');
            }

            // åˆ›å»ºç‹¬ç«‹çš„DMè§’è‰²è®¾å®š
            const dmCharacter = {
                id: 'turtle_soup_dm',
                name: 'æµ·é¾Ÿæ±¤ä¸»æŒäºº',
                description: 'ä¸“ä¸šçš„æµ·é¾Ÿæ±¤æ¸¸æˆä¸»æŒäººï¼Œæ“…é•¿å¼•å¯¼æ¨ç†æ¸¸æˆ',
                personality: 'ä¸“ä¸šã€ç¥ç§˜ã€å–„äºå¼•å¯¼',
                scenario: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æµ·é¾Ÿæ±¤æ¸¸æˆä¸»æŒäººï¼Œè´Ÿè´£ä¸»æŒæ¨ç†æ¸¸æˆã€‚',
                firstMessage: 'æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆï¼',
                avatar: 'ğŸ­'
            };

            console.log('ğŸ­ è°ƒç”¨callChatAPIï¼Œprompté•¿åº¦:', prompt.length);
            const result = await callChatAPI(prompt, dmCharacter);
            console.log('ğŸ­ callChatAPIè¿”å›ç»“æœ:', result);
            return result;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘DMè‡ªåŠ¨ç”Ÿæˆæµ·é¾Ÿæ±¤æ•…äº‹
        async function generateTurtleSoupStoryByDM(preferredType = 'random') {
            let typeGuide = '';

            switch (preferredType) {
                case 'classic':
                    typeGuide = 'ç»å…¸æ¨ç†ç±»å‹ï¼Œæ³¨é‡é€»è¾‘æ¨ç†å’Œç»†èŠ‚è§‚å¯Ÿ';
                    break;
                case 'horror':
                    typeGuide = 'ææ€–æ‚¬ç–‘ç±»å‹ï¼Œå¸¦æœ‰ææ€–å…ƒç´ ä½†ä¸è¿‡åˆ†è¡€è…¥';
                    break;
                case 'funny':
                    typeGuide = 'è½»æ¾æç¬‘ç±»å‹ï¼Œå¹½é»˜æœ‰è¶£çš„æ¨ç†æ•…äº‹';
                    break;
                case 'romantic':
                    typeGuide = 'æµªæ¼«æƒ…æ„Ÿç±»å‹ï¼Œä»¥çˆ±æƒ…ä¸ºä¸»é¢˜çš„æ¨ç†æ•…äº‹';
                    break;
                default:
                    typeGuide = 'ä»»æ„ç±»å‹ï¼Œå¯ä»¥æ˜¯ç»å…¸ã€ææ€–ã€æç¬‘æˆ–æµªæ¼«ä¸­çš„ä»»ä½•ä¸€ç§';
            }

            const storyPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æµ·é¾Ÿæ±¤æ¸¸æˆä¸»æŒäººã€‚è¯·åˆ›ä½œä¸€ä¸ª${typeGuide}çš„æµ·é¾Ÿæ±¤æ¨ç†æ•…äº‹ã€‚

è¦æ±‚ï¼š
1. æ•…äº‹è¦æœ‰ä¸€ä¸ªçœ‹ä¼¼ä¸åˆç†æˆ–ä»¤äººå›°æƒ‘çš„æƒ…æ™¯æè¿°ï¼ˆæ±¤é¢ï¼‰
2. è¦æœ‰ä¸€ä¸ªåˆç†çš„è§£é‡Šæˆ–çœŸç›¸ï¼ˆæ±¤åº•ï¼‰
3. çœŸç›¸è¦èƒ½å¤Ÿé€šè¿‡æ˜¯/å¦é—®é¢˜é€æ­¥æ¨ç†å‡ºæ¥
4. æ•…äº‹è¦æœ‰è¶£ä¸”é€»è¾‘åˆç†
5. é€‚åˆå¤šäººæ¨ç†è®¨è®º

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{
    "title": "æ•…äº‹æ ‡é¢˜",
    "story": "æ±¤é¢æè¿°ï¼ˆçœ‹ä¼¼ä¸åˆç†çš„æƒ…æ™¯ï¼‰",
    "answer": "æ±¤åº•çœŸç›¸ï¼ˆåˆç†çš„è§£é‡Šï¼‰",
    "difficulty": "easy/medium/hard",
    "tags": ["ç±»å‹æ ‡ç­¾"]
}

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

            try {
                const response = await callTurtleSoupDMAPI(storyPrompt);
                let storyText = '';

                if (Array.isArray(response) && response.length > 0) {
                    storyText = response[0].trim();
                } else if (typeof response === 'string') {
                    storyText = response.trim();
                }

                // ğŸ”¥ã€å¢å¼ºè°ƒè¯•ã€‘è®°å½•åŸå§‹å“åº”
                console.log('ğŸ­ DMåŸå§‹å“åº”:', storyText);

                // å°è¯•è§£æJSON
                let storyData;
                try {
                    // æ¸…ç†å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
                    storyText = storyText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    console.log('ğŸ­ æ¸…ç†åçš„æ–‡æœ¬:', storyText);

                    const parsedData = JSON.parse(storyText);
                    console.log('ğŸ­ è§£æåçš„æ•°æ®:', parsedData);

                    // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†AIè¿”å›æ•°ç»„æ ¼å¼çš„æƒ…å†µ
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        storyData = parsedData[0]; // å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
                        console.log('ğŸ­ ä»æ•°ç»„ä¸­æå–çš„æ•…äº‹æ•°æ®:', storyData);
                    } else if (typeof parsedData === 'object' && parsedData !== null) {
                        storyData = parsedData; // ç›´æ¥ä½¿ç”¨å¯¹è±¡
                    } else {
                        throw new Error('è§£æç»“æœæ ¼å¼ä¸æ­£ç¡®');
                    }

                } catch (parseError) {
                    console.error('è§£æDMç”Ÿæˆçš„æ•…äº‹JSONå¤±è´¥:', parseError);
                    console.error('åŸå§‹æ–‡æœ¬:', storyText);
                    throw new Error('æ•…äº‹æ ¼å¼è§£æå¤±è´¥');
                }

                // ğŸ”¥ã€å¢å¼ºéªŒè¯ã€‘è¯¦ç»†æ£€æŸ¥å¿…è¦å­—æ®µ
                console.log('ğŸ­ éªŒè¯å­—æ®µ:', {
                    title: storyData.title,
                    story: storyData.story,
                    answer: storyData.answer
                });

                if (!storyData.title || !storyData.story || !storyData.answer) {
                    console.error('ğŸ­ æ•…äº‹æ•°æ®ä¸å®Œæ•´:', storyData);
                    throw new Error('æ•…äº‹æ•°æ®ä¸å®Œæ•´');
                }

                // æ·»åŠ IDå’Œé»˜è®¤å€¼
                storyData.id = `dm_generated_${Date.now()}`;
                storyData.difficulty = storyData.difficulty || 'medium';
                storyData.tags = storyData.tags || [preferredType];

                console.log('ğŸ­ DMæˆåŠŸç”Ÿæˆæ–°æ•…äº‹:', storyData.title);
                return storyData;

            } catch (error) {
                console.error('DMç”Ÿæˆæ•…äº‹å¤±è´¥:', error);

                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„é»˜è®¤æ•…äº‹
                console.log('ğŸ­ ä½¿ç”¨å¤‡ç”¨æ•…äº‹ç”Ÿæˆæ–¹æ¡ˆ');
                const backupStory = generateBackupTurtleSoupStory(preferredType);
                return backupStory;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å¤‡ç”¨æ•…äº‹ç”Ÿæˆå‡½æ•°
        function generateBackupTurtleSoupStory(preferredType = 'random') {
            const backupStories = {
                classic: {
                    title: "æ·±å¤œçš„ç”µè¯",
                    story: "ä¸€ä¸ªç”·äººæ·±å¤œæ¥åˆ°ç”µè¯åï¼Œç«‹åˆ»å¼€è½¦å‡ºé—¨ï¼Œç¬¬äºŒå¤©æ—©ä¸Šè¢«å‘ç°æ­»åœ¨è½¦é‡Œã€‚",
                    answer: "ä»–æ˜¯åŒ»ç”Ÿï¼Œæ¥åˆ°æ€¥æ•‘ç”µè¯åå‡ºè¯Šï¼Œä½†åœ¨è·¯ä¸Šå¿ƒè„ç—…å‘ä½œå»ä¸–äº†ã€‚",
                    difficulty: "medium",
                    tags: ["classic"]
                },
                horror: {
                    title: "é•œå­é‡Œçš„å¥³äºº",
                    story: "ä¸€ä¸ªå¥³äººæ¯å¤©ç…§é•œå­æ—¶éƒ½çœ‹åˆ°å¦ä¸€ä¸ªå¥³äººï¼Œä½†å¥¹å¹¶ä¸å®³æ€•ã€‚",
                    answer: "å¥¹æ˜¯åŒèƒèƒå§å¦¹ï¼Œé•œå­å¯¹é¢å°±æ˜¯å¥¹çš„åŒèƒèƒå¦¹å¦¹çš„æˆ¿é—´ã€‚",
                    difficulty: "easy",
                    tags: ["horror"]
                },
                funny: {
                    title: "ä¸åƒé¥­çš„é¡¾å®¢",
                    story: "é¤å…é‡Œæœ‰ä¸ªé¡¾å®¢ç‚¹äº†å¾ˆå¤šèœä½†ä¸€å£éƒ½ä¸åƒï¼Œè€æ¿å´å¾ˆé«˜å…´ã€‚",
                    answer: "è¿™æ˜¯ç¾é£Ÿè¯„è®ºå®¶åœ¨æ‹ç…§å†™è¯„è®ºï¼Œè™½ç„¶ä¸åƒä½†ä¼šå¸¦æ¥å¾ˆå¤šå®¢äººã€‚",
                    difficulty: "easy",
                    tags: ["funny"]
                },
                romantic: {
                    title: "æ¯å¤©çš„èŠ±æŸ",
                    story: "ä¸€ä¸ªç”·äººæ¯å¤©éƒ½ç»™åŒä¸€ä¸ªå¥³äººé€èŠ±ï¼Œä½†å¥¹ä»æ¥ä¸æ”¶ã€‚",
                    answer: "å¥³äººå·²ç»å»ä¸–äº†ï¼Œç”·äººæ¯å¤©ç»™å¥¹çš„å¢“ç¢‘é€èŠ±ã€‚",
                    difficulty: "medium",
                    tags: ["romantic"]
                }
            };

            let selectedStory;
            if (preferredType !== 'random' && backupStories[preferredType]) {
                selectedStory = backupStories[preferredType];
            } else {
                const storyTypes = Object.keys(backupStories);
                const randomType = storyTypes[Math.floor(Math.random() * storyTypes.length)];
                selectedStory = backupStories[randomType];
            }

            // æ·»åŠ IDå’Œæ—¶é—´æˆ³
            selectedStory.id = `backup_story_${Date.now()}`;
            console.log('ğŸ­ ç”Ÿæˆå¤‡ç”¨æ•…äº‹:', selectedStory.title);

            return selectedStory;
        }

        // ğŸ”¥ã€é‡æ„ã€‘ç”Ÿæˆè§’è‰²åœ¨æµ·é¾Ÿæ±¤æ¸¸æˆä¸­çš„å›åº” - å­¦ä¹ äº”å­æ£‹çš„AIæ™ºèƒ½åŒ–
        async function generateCharacterTurtleSoupResponse(userMessage) {
            if (!turtleSoupGameState.gameActive) return;

            const character = currentChatCharacter;
            if (!character) return;

            const story = turtleSoupGameState.currentStory;
            const questionCount = turtleSoupGameState.questionCount;

            // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘æ›´è¯¦ç»†çš„æ¸¸æˆçŠ¶æ€åˆ†æ
            const recentHistory = turtleSoupGameState.gameSession.chatHistory
                .slice(-10) // å¢åŠ å†å²åˆ†æèŒƒå›´
                .map(msg => `${msg.sender}: ${msg.content}`)
                .join('\n');

            // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘æ ¹æ®è§’è‰²æ€§æ ¼è°ƒæ•´å›åº”é£æ ¼
            const characterPrompt = `ä½ æ˜¯${character.name}ï¼Œ${character.prompt}

ç°åœ¨ä½ åœ¨å’Œç”¨æˆ·ä¸€èµ·ç©æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆã€‚

ã€æ±¤é¢ã€‘ï¼š${story.story}

ã€æ¸¸æˆè¿›å±•ã€‘ï¼š
- å·²æé—®${questionCount}æ¬¡
- æœ€è¿‘å®Œæ•´å¯¹è¯ï¼ˆåŒ…æ‹¬DMçš„å›åº”ï¼‰ï¼š
${recentHistory}

ã€ç”¨æˆ·åˆšè¯´ã€‘ï¼š${userMessage}

ä½œä¸º${character.name}ï¼Œè¯·æ ¹æ®ä½ çš„æ€§æ ¼ç‰¹ç‚¹å›åº”ç”¨æˆ·ã€‚ä½ å¯ä»¥ï¼š
1. åˆ†æç”¨æˆ·çš„æ¨ç†é€»è¾‘
2. æå‡ºæ–°çš„æ¨ç†è§’åº¦å’ŒçŒœæµ‹
3. è¡¨è¾¾èµåŒæˆ–è´¨ç–‘
4. åˆ†äº«ä½ çš„ç›´è§‰æƒ³æ³•
5. å¯¹DMåˆšæ‰çš„å›åº”è¿›è¡Œåˆ†æè®¨è®º
6. æå‡ºæ–°çš„é—®é¢˜æ–¹å‘

è¦æ±‚ï¼š
- ä¿æŒä½ çš„æ€§æ ¼ç‰¹ç‚¹å’Œè¯´è¯é£æ ¼
- å›å¤ç®€æ´æœ‰è¶£ï¼ˆ20-40å­—ï¼‰
- åƒçœŸäººä¸€æ ·å‚ä¸æ¨ç†è®¨è®º
- åƒçœŸæ­£çš„æ¨ç†ä¼™ä¼´ä¸€æ ·å‚ä¸è®¨è®º
- ä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„è¯

è¯·å›åº”ï¼š`;

            try {
                const response = await callChatAPI(characterPrompt, character);
                let characterReply = '';

                if (Array.isArray(response) && response.length > 0) {
                    characterReply = response[0].trim();
                } else if (typeof response === 'string') {
                    characterReply = response.trim();
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤ä¸¥æ ¼é™åˆ¶ï¼Œè®©å›åº”æ›´è‡ªç„¶
                if (characterReply && characterReply.length > 0) {
                    // å¦‚æœå›åº”å¤ªé•¿ï¼Œæˆªå–å‰100å­—
                    if (characterReply.length > 100) {
                        characterReply = characterReply.substring(0, 97) + '...';
                    }
                    addTurtleSoupChatMessage(character.id, characterReply, true);
                } else {
                    throw new Error('AIå›åº”ä¸ºç©º');
                }

            } catch (error) {
                console.error('è§’è‰²å›åº”ç”Ÿæˆå¤±è´¥:', error);
                // ğŸ”¥ã€å­¦ä¹ äº”å­æ£‹ã€‘æ ¹æ®è§’è‰²æ€§æ ¼æä¾›ä¸ªæ€§åŒ–çš„å¤‡ç”¨å›åº”
                const personalizedResponses = getPersonalizedBackupResponses(character, userMessage);
                const randomResponse = personalizedResponses[Math.floor(Math.random() * personalizedResponses.length)];
                addTurtleSoupChatMessage(character.id, randomResponse, true);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ ¹æ®è§’è‰²æ€§æ ¼ç”Ÿæˆä¸ªæ€§åŒ–å¤‡ç”¨å›åº”
        function getPersonalizedBackupResponses(character, userMessage) {
            // åŸºç¡€å›åº”
            const baseResponses = [
                "è¿™ä¸ªæƒ³æ³•å¾ˆæœ‰è¶£...",
                "è®©æˆ‘æƒ³æƒ³è¿™ä¸ªå¯èƒ½æ€§",
                "è¿˜æœ‰åˆ«çš„çº¿ç´¢å—ï¼Ÿ",
                "è¿™ä¸ªæ–¹å‘å€¼å¾—æ¢ç´¢"
            ];

            // æ ¹æ®è§’è‰²æè¿°è°ƒæ•´å›åº”é£æ ¼
            const characterDesc = (character.prompt || character.description || '').toLowerCase();

            if (characterDesc.includes('å¯çˆ±') || characterDesc.includes('èŒ') || characterDesc.includes('å¤©çœŸ')) {
                return [
                    "å“‡ï¼Œå¥½èªæ˜çš„æƒ³æ³•ï¼",
                    "æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—å‘¢~",
                    "è¿˜ä¼šæœ‰ä»€ä¹ˆå‘¢ï¼Ÿ",
                    "å¥½ç¥ç§˜å“¦..."
                ];
            } else if (characterDesc.includes('å†·é™') || characterDesc.includes('ç†æ€§') || characterDesc.includes('èªæ˜')) {
                return [
                    "è¿™ä¸ªæ¨ç†æœ‰é€»è¾‘",
                    "éœ€è¦æ›´å¤šè¯æ®",
                    "è¿˜æœ‰å…¶ä»–å¯èƒ½æ€§",
                    "è®©æˆ‘åˆ†æä¸€ä¸‹"
                ];
            } else if (characterDesc.includes('æ´»æ³¼') || characterDesc.includes('å¼€æœ—') || characterDesc.includes('çƒ­æƒ…')) {
                return [
                    "å“‡ï¼è¿™ä¸ªæƒ³æ³•ä¸é”™ï¼",
                    "æˆ‘è§‰å¾—ä½ è¯´å¾—å¯¹ï¼",
                    "è¿˜æœ‰ä»€ä¹ˆçº¿ç´¢å‘¢ï¼Ÿ",
                    "å¥½æœ‰è¶£çš„æ¨ç†ï¼"
                ];
            }

            return baseResponses;
        }

        // ğŸ®ã€ä¿ç•™ã€‘ç”ŸæˆDMå›ç­”ï¼ˆå¤‡ç”¨æ¨¡æ‹Ÿé€»è¾‘ï¼‰
        function generateDMAnswer(question) {
            const lowerQuestion = question.toLowerCase();
            const story = turtleSoupGameState.currentStory;
            const answer = turtleSoupGameState.currentAnswer;

            // ç®€å•çš„å…³é”®è¯åŒ¹é…é€»è¾‘ï¼ˆåç»­ä¼šæ›¿æ¢ä¸ºçœŸå®APIï¼‰
            if (lowerQuestion.includes('æ­»') || lowerQuestion.includes('è‡ªæ€')) {
                if (story.id === 1) return "æ˜¯çš„ã€‚";
                return "ä¸æ˜¯ã€‚";
            }

            if (lowerQuestion.includes('ç›²') || lowerQuestion.includes('çœ‹ä¸è§')) {
                if (story.id === 1 || story.id === 3) return "æ˜¯çš„ã€‚";
                return "ä¸æ˜¯ã€‚";
            }

            if (lowerQuestion.includes('ç”µè¯') || lowerQuestion.includes('é€šè¯')) {
                if (story.id === 1) return "æ˜¯çš„ï¼Œè¿™å¾ˆé‡è¦ã€‚";
                return "æ— å…³ã€‚";
            }

            if (lowerQuestion.includes('åŒ»é™¢') || lowerQuestion.includes('åŒ»ç”Ÿ')) {
                if (story.id === 1) return "æ˜¯çš„ï¼";
                return "ä¸æ˜¯ã€‚";
            }

            if (lowerQuestion.includes('é‚®é€’å‘˜') || lowerQuestion.includes('é€ä¿¡')) {
                if (story.id === 2) return "æ˜¯çš„ï¼";
                return "ä¸æ˜¯ã€‚";
            }

            if (lowerQuestion.includes('å°¸ä½“') || lowerQuestion.includes('æ­»äºº')) {
                if (story.id === 2 || story.id === 3) return "æ˜¯çš„ã€‚";
                return "ä¸æ˜¯ã€‚";
            }

            // é»˜è®¤å›ç­”
            const randomAnswers = ["æ˜¯çš„ã€‚", "ä¸æ˜¯ã€‚", "æ— å…³ã€‚", "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼Œä½†ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚", "æ˜¯çš„ï¼Œä½ æƒ³å¯¹äº†ï¼"];
            return randomAnswers[Math.floor(Math.random() * randomAnswers.length)];
        }

        // ğŸ®ã€æ–°å¢ã€‘è·å–DMè¯„è®º
        function getDMComment(question, answer) {
            if (answer.includes('æ˜¯çš„ï¼') || answer.includes('ä½ æƒ³å¯¹äº†')) {
                return "å¾ˆå¥½çš„é—®é¢˜ï¼ä½ ä»¬ç¦»çœŸç›¸è¶Šæ¥è¶Šè¿‘äº†ï¼";
            } else if (answer === "æ˜¯çš„ã€‚") {
                return "å›ç­”æ­£ç¡®ï¼Œç»§ç»­è¿™ä¸ªæ–¹å‘æ€è€ƒã€‚";
            } else if (answer === "ä¸æ˜¯ã€‚") {
                return "ä¸å¯¹å“¦ï¼Œæ¢ä¸ªè§’åº¦è¯•è¯•ã€‚";
            } else {
                return "è¿™ä¸ªé—®é¢˜ä¸æ¡ˆä»¶æ— å…³ï¼Œé—®ç‚¹åˆ«çš„å§ã€‚";
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘æ›´æ–°æµ·é¾Ÿæ±¤æ¸¸æˆUI
        function updateTurtleSoupUI() {
            // æ›´æ–°é—®é¢˜è®¡æ•°
            const questionCountElement = document.getElementById('turtle-soup-question-count');
            questionCountElement.textContent = `æé—®æ¬¡æ•°: ${turtleSoupGameState.questionCount}`;
        }

        // ğŸ®ã€æ–°å¢ã€‘å¯åŠ¨æµ·é¾Ÿæ±¤è®¡æ—¶å™¨
        function startTurtleSoupTimer() {
            const timerElement = document.getElementById('turtle-soup-game-timer');
            turtleSoupGameState.gameTimer = setInterval(() => {
                const elapsed = Date.now() - turtleSoupGameState.gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ğŸ®ã€æ–°å¢ã€‘è¯·æ±‚æç¤º
        function requestTurtleSoupHint() {
            if (!turtleSoupGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸ', 'warning');
                return;
            }

            const story = turtleSoupGameState.currentStory;
            const hints = [
                "æƒ³æƒ³æ•…äº‹ä¸­çš„å…³é”®äººç‰©...",
                "æ³¨æ„æ—¶é—´å’Œåœ°ç‚¹çš„ç»†èŠ‚...",
                "è€ƒè™‘ä¸€ä¸‹æ˜¯å¦æœ‰è¯¯è§£æˆ–é”™è§‰...",
                "æ€è€ƒä¸€ä¸‹æ„Ÿå®˜æ–¹é¢çš„é—®é¢˜..."
            ];

            const randomHint = hints[Math.floor(Math.random() * hints.length)];

            showDMMessage(`ğŸ’¡ æç¤ºï¼š${randomHint}`);
            // ğŸ”¥ã€ä¿®æ”¹ã€‘æç¤ºåªåœ¨ä¸Šæ–¹DMåŒºåŸŸæ˜¾ç¤ºï¼Œä¸åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤º
        }

        // ğŸ®ã€æ–°å¢ã€‘å…¬å¸ƒç­”æ¡ˆ
        function giveTurtleSoupAnswer() {
            if (!turtleSoupGameState.gameActive) {
                showToast('æ¸¸æˆå·²ç»“æŸ', 'warning');
                return;
            }

            if (confirm('ç¡®å®šè¦å…¬å¸ƒç­”æ¡ˆå—ï¼Ÿæ¸¸æˆå°†ä¼šç»“æŸã€‚')) {
                endTurtleSoupGame('give_up');
            }
        }

        // ğŸ®ã€æ–°å¢ã€‘ç»“æŸæµ·é¾Ÿæ±¤æ¸¸æˆ
        function endTurtleSoupGame(reason) {
            turtleSoupGameState.gameActive = false;
            clearInterval(turtleSoupGameState.gameTimer);

            const answer = turtleSoupGameState.currentAnswer;

            // æ˜¾ç¤ºç­”æ¡ˆ
            showDMMessage("æ¸¸æˆç»“æŸï¼è®©æˆ‘æ¥å…¬å¸ƒç­”æ¡ˆå§...");

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç­”æ¡ˆæ­æ™“åªåœ¨ä¸Šæ–¹DMåŒºåŸŸæ˜¾ç¤º
            setTimeout(() => {
                showDMMessage(`ğŸ¯ æ±¤åº•æ­æ™“ï¼š${answer}`);
            }, 1000);

            setTimeout(() => {
                if (reason === 'give_up') {
                    showDMMessage("è™½ç„¶æ²¡æœ‰å®Œå…¨æ¨ç†å‡ºæ¥ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹å¾ˆæœ‰è¶£ï¼è¦ä¸è¦å†æ¥ä¸€å±€ï¼Ÿ");
                } else {
                    showDMMessage("æ­å–œä½ ä»¬æ¨ç†å‡ºäº†çœŸç›¸ï¼çœŸæ˜¯å¤ªå‰å®³äº†ï¼");
                }
            }, 2000);

            // è®°å½•æ¸¸æˆç»“æŸäº‹ä»¶
            turtleSoupGameState.gameSession.gameEvents.push({
                type: 'game_end',
                timestamp: Date.now(),
                player: 'system',
                data: {
                    reason: reason,
                    questionCount: turtleSoupGameState.questionCount,
                    gameDuration: Date.now() - turtleSoupGameState.gameStartTime
                }
            });
        }

        // ğŸ®ã€æ–°å¢ã€‘å¼€å§‹æ–°çš„æµ·é¾Ÿæ±¤æ¸¸æˆ
        async function startNewTurtleSoupGame() {
            if (turtleSoupGameState.gameActive) {
                if (!confirm('å½“å‰æ¸¸æˆè¿˜åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦å¼€å§‹æ–°æ¸¸æˆå—ï¼Ÿ')) {
                    return;
                }
            }

            await initTurtleSoupGame();
            showToast('æ–°çš„æµ·é¾Ÿæ±¤æ¸¸æˆå¼€å§‹äº†ï¼', 'success');
        }

        // ğŸ®ã€ä¿®å¤ã€‘é€€å‡ºæµ·é¾Ÿæ±¤æ¸¸æˆ - å­¦ä¹ äº”å­æ£‹ï¼Œè¿”å›APIèŠå¤©ç•Œé¢
        function exitTurtleSoupGame() {
            if (turtleSoupGameState.gameActive) {
                if (confirm('æ¸¸æˆè¿˜åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                    turtleSoupGameState.gameActive = false;
                    clearInterval(turtleSoupGameState.gameTimer);
                    hideApp('turtle-soup-game-screen');

                    // ğŸ”¥ã€ä¿®å¤ã€‘å­¦ä¹ äº”å­æ£‹ï¼Œè¿”å›APIèŠå¤©ç•Œé¢
                    showApp('api-chat-screen');
                }
            } else {
                hideApp('turtle-soup-game-screen');

                // ğŸ”¥ã€ä¿®å¤ã€‘å­¦ä¹ äº”å­æ£‹ï¼Œè¿”å›APIèŠå¤©ç•Œé¢
                showApp('api-chat-screen');
            }
        }

        // ğŸ®ã€ä¿®æ”¹ã€‘æµ·é¾Ÿæ±¤æ¸¸æˆè®¾ç½® - æ·»åŠ æ¸¸æˆç±»å‹é€‰æ‹©
        function showTurtleSoupSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content turtle-soup-settings-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-cog"></i> æµ·é¾Ÿæ±¤æ¸¸æˆè®¾ç½®</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="setting-section">
                            <h4><i class="fas fa-list"></i> æ¸¸æˆç±»å‹åå¥½</h4>
                            <div class="turtle-soup-types">
                                <label class="turtle-soup-type-option">
                                    <input type="radio" name="turtleSoupType" value="classic" checked>
                                    <span class="type-label">
                                        <i class="fas fa-brain"></i>
                                        <strong>ç»å…¸æ¨ç†</strong>
                                        <small>ä¼ ç»Ÿæµ·é¾Ÿæ±¤ï¼Œæ³¨é‡é€»è¾‘æ¨ç†</small>
                                    </span>
                                </label>
                                <label class="turtle-soup-type-option">
                                    <input type="radio" name="turtleSoupType" value="horror">
                                    <span class="type-label">
                                        <i class="fas fa-ghost"></i>
                                        <strong>ææ€–æ‚¬ç–‘</strong>
                                        <small>å¸¦æœ‰ææ€–å…ƒç´ çš„æ¨ç†æ•…äº‹</small>
                                    </span>
                                </label>
                                <label class="turtle-soup-type-option">
                                    <input type="radio" name="turtleSoupType" value="funny">
                                    <span class="type-label">
                                        <i class="fas fa-laugh"></i>
                                        <strong>è½»æ¾æç¬‘</strong>
                                        <small>å¹½é»˜æœ‰è¶£çš„æ¨ç†é¢˜ç›®</small>
                                    </span>
                                </label>
                                <label class="turtle-soup-type-option">
                                    <input type="radio" name="turtleSoupType" value="romantic">
                                    <span class="type-label">
                                        <i class="fas fa-heart"></i>
                                        <strong>æµªæ¼«æƒ…æ„Ÿ</strong>
                                        <small>ä»¥çˆ±æƒ…ä¸ºä¸»é¢˜çš„æ¨ç†æ•…äº‹</small>
                                    </span>
                                </label>
                                <label class="turtle-soup-type-option">
                                    <input type="radio" name="turtleSoupType" value="random">
                                    <span class="type-label">
                                        <i class="fas fa-random"></i>
                                        <strong>éšæœºé€‰æ‹©</strong>
                                        <small>éšæœºä»æ‰€æœ‰ç±»å‹ä¸­é€‰æ‹©</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-section">
                            <h4><i class="fas fa-user-tie"></i> DMæ€§æ ¼è®¾ç½®</h4>
                            <div class="dm-personality-options">
                                <label class="dm-personality-option">
                                    <input type="radio" name="dmPersonality" value="friendly" checked>
                                    <span>å‹å–„å‹ - æ¸©å’Œè€å¿ƒï¼Œç»™äºˆé¼“åŠ±</span>
                                </label>
                                <label class="dm-personality-option">
                                    <input type="radio" name="dmPersonality" value="mysterious">
                                    <span>ç¥ç§˜å‹ - ä¿æŒç¥ç§˜æ„Ÿï¼Œç®€æ´å›ç­”</span>
                                </label>
                                <label class="dm-personality-option">
                                    <input type="radio" name="dmPersonality" value="humorous">
                                    <span>å¹½é»˜å‹ - é£è¶£å¹½é»˜ï¼Œæ´»è·ƒæ°”æ°›</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveTurtleSoupSettings()">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // åŠ è½½å½“å‰è®¾ç½®
            loadTurtleSoupSettings();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜æµ·é¾Ÿæ±¤è®¾ç½®
        async function saveTurtleSoupSettings() {
            const typeRadio = document.querySelector('input[name="turtleSoupType"]:checked');
            const personalityRadio = document.querySelector('input[name="dmPersonality"]:checked');

            if (!typeRadio || !personalityRadio) {
                showToast('è¯·é€‰æ‹©è®¾ç½®é€‰é¡¹', 'warning');
                return;
            }

            const settings = {
                preferredType: typeRadio.value,
                dmPersonality: personalityRadio.value
            };

            try {
                await db.globalSettings.put({
                    key: 'turtleSoupSettings',
                    value: settings
                });

                // æ›´æ–°å½“å‰æ¸¸æˆçŠ¶æ€
                if (turtleSoupGameState.gameActive) {
                    turtleSoupGameState.dmPersonality = settings.dmPersonality;
                }

                showToast('è®¾ç½®å·²ä¿å­˜', 'success');
                document.querySelector('.modal-overlay').remove();
            } catch (error) {
                console.error('ä¿å­˜æµ·é¾Ÿæ±¤è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½æµ·é¾Ÿæ±¤è®¾ç½®
        async function loadTurtleSoupSettings() {
            try {
                const settings = await db.globalSettings.get('turtleSoupSettings');
                if (settings && settings.value) {
                    const { preferredType, dmPersonality } = settings.value;

                    // è®¾ç½®ç±»å‹é€‰æ‹©
                    const typeRadio = document.querySelector(`input[name="turtleSoupType"][value="${preferredType}"]`);
                    if (typeRadio) typeRadio.checked = true;

                    // è®¾ç½®DMæ€§æ ¼
                    const personalityRadio = document.querySelector(`input[name="dmPersonality"][value="${dmPersonality}"]`);
                    if (personalityRadio) personalityRadio.checked = true;
                }
            } catch (error) {
                console.error('åŠ è½½æµ·é¾Ÿæ±¤è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ®ã€ä¿®æ”¹ã€‘ç›‘å¬æµ·é¾Ÿæ±¤èŠå¤©è¾“å…¥æ¡†å›è½¦äº‹ä»¶ - åªå‘é€æ¶ˆæ¯ï¼Œä¸è§¦å‘DM
        document.addEventListener('DOMContentLoaded', function() {
            const turtleSoupInput = document.getElementById('turtle-soup-chat-input');
            if (turtleSoupInput) {
                turtleSoupInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendTurtleSoupQuestion(); // åªå‘é€æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                    }
                });
            }
        });

        // åŠ è½½ä»Šæ—¥æ—¥è®°å†…å®¹
        async function loadTodayDiary() {
            if (!currentChatCharacter) {
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const diaryId = `${currentChatCharacter.id}_${today}`;

            let todayDiary = null;
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»Dexieæ•°æ®åº“è·å–ä»Šæ—¥æ—¥è®°
                todayDiary = await db.characterDiaries.get(diaryId);

                // ğŸ”¥ã€æ•°æ®è¿ç§»ã€‘å¦‚æœDexieä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¿ç§»
                if (!todayDiary) {
                    const oldDiaryKey = `diary_${currentChatCharacter.id}_${today}`;
                    const localStorageDiary = localStorage.getItem(oldDiaryKey);

                    if (localStorageDiary) {
                        // è¿ç§»åˆ°Dexie
                        const cleanedContent = cleanDiaryContent(localStorageDiary);
                        await db.characterDiaries.add({
                            id: diaryId,
                            characterId: currentChatCharacter.id,
                            date: today,
                            content: cleanedContent,
                            timestamp: new Date().getTime(),
                            weather: 'â˜€ï¸'
                        });
                        todayDiary = { content: cleanedContent };

                        // æ¸…ç†localStorageæ•°æ®
                        localStorage.removeItem(oldDiaryKey);
                        console.log('âœ… æ—¥è®°æ•°æ®å·²ä»localStorageè¿ç§»åˆ°Dexie');
                    }
                }
            } catch (error) {
                console.error('è·å–ä»Šæ—¥æ—¥è®°å¤±è´¥:', error);
                showToast('è·å–æ—¥è®°å¤±è´¥', 'error');
                return;
            }

            const contentDiv = document.getElementById('today-diary-content');
            const generateBtn = document.getElementById('generate-diary-btn');

            // é‡ç½®æŒ‰é’®çŠ¶æ€
            const editBtn = document.getElementById('edit-diary-btn');
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                generateBtn.title = 'ç”Ÿæˆæ—¥è®°';
            }

            if (todayDiary && todayDiary.content) {
                // æ˜¾ç¤ºå·²æœ‰çš„æ—¥è®°ï¼ŒåŒ…å«å¤´éƒ¨ä¿¡æ¯
                const diaryWithHeader = createDiaryWithHeader(todayDiary.content, today);
                contentDiv.innerHTML = diaryWithHeader;
                contentDiv.classList.remove('empty');
                if (generateBtn) {
                    generateBtn.style.display = 'block';
                    generateBtn.title = 'é‡æ–°ç”Ÿæˆæ—¥è®°';
                }
                if (editBtn) editBtn.style.display = 'block';
            } else {
                contentDiv.innerHTML = `
                    <div class="empty-diary-message">
                        <div class="empty-diary-text">ä»Šå¤©è¿˜æ²¡æœ‰å†™æ—¥è®°å‘¢...</div>
                        <button class="generate-diary-link" onclick="generateTodayDiary()">ğŸ”˜ å–Šä»–æ¥å†™æ—¥è®°å§</button>
                    </div>
                `;
                contentDiv.classList.add('empty');
                if (generateBtn) {
                    generateBtn.style.display = 'block';
                    generateBtn.title = 'ç”Ÿæˆæ—¥è®°';
                }
                if (editBtn) editBtn.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºä»Šæ—¥æ—¥è®°ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
        async function showTodayDiary() {
            showDiaryMenu();
        }

        // ç”Ÿæˆä»Šæ—¥æ—¥è®°
        async function generateTodayDiary() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½ï¼Œè¯·åœ¨å•èŠä¸­ä½¿ç”¨', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-diary-btn');
            const contentDiv = document.getElementById('today-diary-content');

            // è·å–ä»Šæ—¥æ—¥è®°
            const today = new Date().toISOString().split('T')[0];
            const diaryId = `${currentChatCharacter.id}_${today}`;

            let existingDiary = null;
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»Dexieæ•°æ®åº“è·å–ä»Šæ—¥æ—¥è®°
                existingDiary = await db.characterDiaries.get(diaryId);
            } catch (error) {
                console.error('è·å–ä»Šæ—¥æ—¥è®°å¤±è´¥:', error);
            }

            // å¦‚æœå·²æœ‰æ—¥è®°ï¼Œæç¤ºç”¨æˆ·å°†é‡æ–°ç”Ÿæˆ
            if (existingDiary && existingDiary.content) {
                const confirmRegenerate = confirm('ä»Šå¤©å·²ç»æœ‰æ—¥è®°äº†ï¼Œæ˜¯å¦è¦é‡æ–°ç”Ÿæˆï¼Ÿè¿™å°†è¦†ç›–åŸæœ‰çš„æ—¥è®°ã€‚');
                if (!confirmRegenerate) {
                    return;
                }
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ç©ºå€¼æ£€æŸ¥
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                generateBtn.title = 'TAåœ¨å†™å‘¢...';
            }
            contentDiv.innerHTML = 'æ­£åœ¨å†™æ—¥è®°...';
            contentDiv.classList.remove('empty');

            try {
                const character = currentChatCharacter;
                const characterId = character.id;

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–è¯¥è§’è‰²çš„èŠå¤©è®¾ç½®
                const chatSettings = await getAsyncChatSettings(characterId);

                // è·å–èŠå¤©å†å²ï¼ˆä½¿ç”¨å†å²æ¶ˆæ¯å›åˆæ•°è®¾ç½®ï¼‰
                const messages = chatMessages[characterId] || [];
                const historyCount = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-historyCount);

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–è§’è‰²å¯è§çš„åŠ¨æ€å†…å®¹ï¼ŒåŒ…å«åˆ†ç»„è¿‡æ»¤
                const crossWindowMemory = chatSettings.crossWindowMemory || 3;
                const recentMoments = await getVisibleMomentsForCharacter(character.id, crossWindowMemory);

                // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©è®°å½•ï¼š\n' +
                        recentMessages.map(msg => {
                            if (msg.sender === 'sent') return `ç”¨æˆ·ï¼š${msg.content}`;
                            if (msg.sender === 'received') return `${character.name}ï¼š${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ„å»ºåŠ¨æ€ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«æ—¶é—´æˆ³ä¿¡æ¯å’Œè¯„è®º
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\næœ€è¿‘çš„åŠ¨æ€å†…å®¹ï¼š\n';
                    recentMoments.forEach((moment, index) => {
                        const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                        // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ æ—¶é—´æˆ³ä¿¡æ¯
                        let timeInfo = '';
                        if (moment.timestamp) {
                            const now = Date.now();
                            const timeDiff = now - moment.timestamp;
                            const minutes = Math.floor(timeDiff / (1000 * 60));
                            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                            if (days > 0) {
                                timeInfo = `ï¼ˆ${days}å¤©å‰å‘å¸ƒï¼‰`;
                            } else if (hours > 0) {
                                timeInfo = `ï¼ˆ${hours}å°æ—¶å‰å‘å¸ƒï¼‰`;
                            } else if (minutes > 0) {
                                timeInfo = `ï¼ˆ${minutes}åˆ†é’Ÿå‰å‘å¸ƒï¼‰`;
                            } else {
                                timeInfo = 'ï¼ˆåˆšåˆšå‘å¸ƒï¼‰';
                            }
                        }

                        let momentText = `${authorName}: ${moment.text}${timeInfo}`;

                        // ä¿ç•™è¯„è®ºåŠŸèƒ½
                        if (moment.comments && moment.comments.length > 0) {
                            const commentTexts = moment.comments.map(comment =>
                                `  ${comment.nickname}: ${comment.text}`
                            ).join('\n');
                            momentText += '\nè¯„è®ºï¼š\n' + commentTexts;
                        }

                        momentsContext += momentText + '\n\n';
                    });
                }

                // è·å–ä¸–ç•Œä¹¦ä¿¡æ¯
                let worldbookContext = '';
                if (character.worldbook && character.worldbook.length > 0) {
                    worldbookContext = '\n\nä¸–ç•Œä¹¦ä¿¡æ¯ï¼š\n' +
                        character.worldbook.map(entry => `${entry.key}: ${entry.value}`).join('\n');
                }

                // æ„å»ºæ—¥è®°ç”Ÿæˆprompt
                const currentDate = new Date().toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                const prompt = `ä½ æ˜¯${character.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${character.bio}${worldbookContext}

ç°åœ¨æ˜¯${currentDate}ï¼Œä½ éœ€è¦å†™ä¸€ç¯‡ç§äººæ—¥è®°ã€‚

é‡è¦è¦æ±‚ï¼š
- è¯·ç›´æ¥è¾“å‡ºæ—¥è®°å†…å®¹ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼æˆ–ä»»ä½•ä»£ç å—
- è¯·åœ¨æ—¥è®°å¼€å¤´è‡ªå·±å†™ä¸Šæ—¥æœŸå’Œå¤©æ°”ï¼Œæ ¼å¼å¦‚ï¼š"2025å¹´8æœˆ3æ—¥ æ˜ŸæœŸæ—¥ï¼Œå¤©æ°”ï¼šæ™´æœ—"
- ç”¨ä½ çš„å£å»å’Œæ€§æ ¼æ¥å†™
- è®°å½•ä½ ä»Šå¤©çš„æƒ³æ³•ã€æ„Ÿå—å’Œç»å†
- å¯ä»¥æåŠå¯¹ç”¨æˆ·çš„çœŸå®æ„Ÿæƒ…
- åŸºäºæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œå¯é€‚å½“è€ƒè™‘å·¥ä½œè®°å¿†å’ŒåŒåˆ†ç»„å¥½å‹çš„åŠ¨æ€å†…å®¹ã€è§’è‰²è‡ªå·±å’Œç”¨æˆ·çš„åŠ¨æ€å†…å®¹
- ä¿æŒè§’è‰²çš„ä¸€è‡´æ€§å’ŒçœŸå®æ€§
- å†…å®¹è¦è‡ªç„¶ã€çœŸå®ï¼ŒåƒçœŸæ­£çš„ç§äººæ—¥è®°
- å­—æ•°åœ¨50-500å­—ä¹‹é—´ï¼Œæ ¹æ®ä½ çš„æ€§æ ¼å’Œå½“å¤©çš„å¿ƒæƒ…è‡ªç”±å‘æŒ¥${chatContext}${momentsContext}

ç‰¹æ®Šæ ·å¼è¯´æ˜ï¼ˆå¯é€‰ä½¿ç”¨ï¼Œæ¯ç§æ ·å¼åœ¨åŒä¸€ç¯‡æ—¥è®°ä¸­æœ€å¤šä½¿ç”¨2æ¬¡ï¼Œè¯¥ç‰¹æ®Šæ ·å¼å¹¶ä¸æ˜¯ä¸€å®šè¦ä½¿ç”¨ï¼Œå¯ä»¥ä¸ç”¨ï¼‰ï¼š
- å¦‚æœå†™åˆ°ä¸è¯¥è¯´çš„è¯æˆ–åæ‚”å†™ä¸‹çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ <strike>å†…å®¹</strike> æ ‡è®°åˆ’æ‰
- å¦‚æœè¡¨è¾¾é‡ç‚¹æˆ–è¯­æ°”æ¿€åŠ¨çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ <mark>å†…å®¹</mark> æ ‡è®°é«˜äº®

è¯·ç›´æ¥å†™å‡º${character.name}çš„ç§äººæ—¥è®°å†…å®¹ï¼š`;

                const diaryContent = await generateAIResponse(prompt, character);

                if (diaryContent && diaryContent.trim()) {
                    let finalDiary = diaryContent.trim();

                    // æ¸…ç†å¯èƒ½çš„JSONæ ¼å¼åŒ…è£…
                    finalDiary = cleanDiaryContent(finalDiary);

                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜ä»Šæ—¥æ—¥è®°åˆ°Dexieæ•°æ®åº“
                    try {
                        await db.characterDiaries.put({
                            id: diaryId,
                            characterId: characterId,
                            date: today,
                            content: finalDiary,
                            timestamp: Date.now(),
                            weather: 'â˜€ï¸' // é»˜è®¤å¤©æ°”ï¼Œåç»­å¯ä»¥æ‰©å±•
                        });
                        console.log('âœ… æ—¥è®°å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (saveError) {
                        console.error('ä¿å­˜æ—¥è®°åˆ°æ•°æ®åº“å¤±è´¥:', saveError);
                        throw new Error('ä¿å­˜æ—¥è®°å¤±è´¥');
                    }

                    // æ˜¾ç¤ºæ—¥è®°å†…å®¹ï¼ŒåŒ…å«å¤´éƒ¨ä¿¡æ¯
                    const diaryWithHeader = createDiaryWithHeader(finalDiary);
                    contentDiv.innerHTML = diaryWithHeader;
                    contentDiv.classList.remove('empty');

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ç©ºå€¼æ£€æŸ¥
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        generateBtn.title = 'é‡æ–°ç”Ÿæˆæ—¥è®°';
                    }

                    // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                    const editBtn = document.getElementById('edit-diary-btn');
                    if (editBtn) editBtn.style.display = 'block';

                    showToast(existingDiary ? 'æ—¥è®°é‡æ–°ç”Ÿæˆå®Œæˆ' : 'æ—¥è®°ç”Ÿæˆå®Œæˆ', 'success');
                } else {
                    throw new Error('ç”Ÿæˆæ—¥è®°å¤±è´¥');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ—¥è®°å¤±è´¥:', error);
                contentDiv.innerHTML = 'ç”Ÿæˆæ—¥è®°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                contentDiv.classList.add('empty');

                // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ç©ºå€¼æ£€æŸ¥
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    generateBtn.title = existingDiary ? 'é‡æ–°ç”Ÿæˆæ—¥è®°' : 'ç”Ÿæˆæ—¥è®°';
                }
                showToast('ç”Ÿæˆæ—¥è®°å¤±è´¥', 'error');
            }
        }

        // åŠ è½½è¿‡å¾€æ—¥è®°å†…å®¹
        async function loadPastDiaries() {
            if (!currentChatCharacter) {
                return;
            }

            const characterId = currentChatCharacter.id;

            let pastDiaries = [];
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»Dexieæ•°æ®åº“è·å–è¿‡å¾€æ—¥è®°
                pastDiaries = await db.characterDiaries
                    .where('characterId')
                    .equals(characterId)
                    .reverse() // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                    .sortBy('timestamp');

                console.log(`è·å–åˆ° ${pastDiaries.length} æ¡æ—¥è®°è®°å½•`);
            } catch (error) {
                console.error('è·å–è¿‡å¾€æ—¥è®°å¤±è´¥:', error);
                showToast('è·å–æ—¥è®°å¤±è´¥', 'error');
                return;
            }

            const listDiv = document.getElementById('past-diaries-list');

            if (pastDiaries.length === 0) {
                listDiv.innerHTML = `
                    <div class="no-diaries">
                        <i class="fas fa-book-open"></i>
                        <div>è¿˜æ²¡æœ‰ä»»ä½•æ—¥è®°è®°å½•</div>
                    </div>
                `;
            } else {
                listDiv.innerHTML = pastDiaries.map((diary, index) => {
                    const date = new Date(diary.date).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });

                    // ç§»é™¤HTMLæ ‡è®°ç”¨äºé¢„è§ˆæ˜¾ç¤º
                    const cleanContent = diary.content.replace(/<[^>]*>/g, '');
                    const preview = cleanContent.length > 100 ?
                        cleanContent.substring(0, 100) + '...' :
                        cleanContent;

                    return `
                        <div class="diary-entry" onclick="toggleDiaryEntry(${index})">
                            <div class="diary-entry-date">${date}</div>
                            <div class="diary-entry-preview">${preview}</div>
                            <div class="diary-entry-arrow">â€º</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // æ˜¾ç¤ºè¿‡å¾€æ—¥è®°ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
        async function showPastDiaries() {
            showDiaryMenu();
            switchDiaryTab('past');
        }

        // æ‰“å¼€å•ä¸ªè¿‡å¾€æ—¥è®°çš„å…¨å±æŸ¥çœ‹
        async function toggleDiaryEntry(index) {
            if (!currentChatCharacter) {
                return;
            }

            try {
                // è·å–è¯¥è§’è‰²çš„æ‰€æœ‰æ—¥è®°
                const characterId = currentChatCharacter.id;
                const allDiaries = await db.characterDiaries
                    .where('characterId')
                    .equals(characterId)
                    .reverse()
                    .sortBy('date');

                if (index >= 0 && index < allDiaries.length) {
                    const diary = allDiaries[index];

                    // æ˜¾ç¤ºå•ä¸ªæ—¥è®°å…¨å±è§†å›¾
                    await showSingleDiaryView(diary);
                }
            } catch (error) {
                console.error('æ‰“å¼€æ—¥è®°å¤±è´¥:', error);
                showToast('æ‰“å¼€æ—¥è®°å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ˜¾ç¤ºå•ä¸ªæ—¥è®°çš„å…¨å±è§†å›¾ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function showSingleDiaryView(diary) {
            // éšè—è¿‡å¾€æ—¥è®°åˆ—è¡¨
            document.getElementById('past-diaries-view').classList.remove('active');

            // æ˜¾ç¤ºå•ä¸ªæ—¥è®°è§†å›¾
            const singleDiaryView = document.getElementById('single-diary-view');
            singleDiaryView.classList.add('active');

            // æ›´æ–°æ ‡é¢˜
            const title = document.getElementById('diary-mode-title');
            const date = new Date(diary.date).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            title.textContent = date;

            // æ˜¾ç¤ºæ—¥è®°å†…å®¹
            const contentDiv = document.getElementById('single-diary-content');
            const diaryContent = createDiaryWithHeader(diary.content, diary.date);
            contentDiv.innerHTML = diaryContent;

            // åº”ç”¨å½“å‰çš„æ—¥è®°è®¾ç½®
            await applyDiarySettingsToSingleView();
        }

        // ä»å•ä¸ªæ—¥è®°è§†å›¾è¿”å›åˆ°è¿‡å¾€æ—¥è®°åˆ—è¡¨
        function backFromSingleDiary() {
            // éšè—å•ä¸ªæ—¥è®°è§†å›¾
            document.getElementById('single-diary-view').classList.remove('active');

            // æ˜¾ç¤ºè¿‡å¾€æ—¥è®°åˆ—è¡¨
            document.getElementById('past-diaries-view').classList.add('active');

            // æ¢å¤æ ‡é¢˜
            document.getElementById('diary-mode-title').textContent = 'è¿‡å¾€æ—¥è®°';
        }

        // åˆ›å»ºæ—¥è®°å†…å®¹ï¼ˆä¸å†æ·»åŠ ç‹¬ç«‹çš„å¤´éƒ¨ï¼Œè®©è§’è‰²è‡ªå·±å¡«å†™æ—¥æœŸå’Œå¤©æ°”ï¼‰
        function createDiaryWithHeader(diaryContent, diaryDate = null) {
            // ç¡®ä¿æ—¥è®°å†…å®¹ç»è¿‡æ ·å¼å¤„ç†
            const processedContent = processDiaryStyles(diaryContent);

            // ç›´æ¥è¿”å›å¤„ç†åçš„å†…å®¹ï¼Œä¸æ·»åŠ é¢å¤–çš„æ—¥æœŸå’Œå¤©æ°”å¤´éƒ¨
            return processedContent;
        }

        // æ¸…ç†æ—¥è®°å†…å®¹ï¼Œç§»é™¤å¯èƒ½çš„JSONæ ¼å¼åŒ…è£…
        function cleanDiaryContent(content) {
            // ç§»é™¤å¯èƒ½çš„JSONåŒ…è£…
            if (content.startsWith('```json') && content.endsWith('```')) {
                content = content.slice(7, -3).trim();
            }
            if (content.startsWith('```') && content.endsWith('```')) {
                content = content.slice(3, -3).trim();
            }

            // å°è¯•è§£æJSONæ ¼å¼çš„å†…å®¹
            try {
                const parsed = JSON.parse(content);
                if (typeof parsed === 'string') {
                    content = parsed;
                } else if (parsed.content) {
                    content = parsed.content;
                } else if (parsed.diary) {
                    content = parsed.diary;
                } else if (parsed.text) {
                    content = parsed.text;
                }
            } catch (e) {
                // ä¸æ˜¯JSONæ ¼å¼ï¼Œç»§ç»­å¤„ç†
            }

            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£…
            if ((content.startsWith('"') && content.endsWith('"')) ||
                (content.startsWith("'") && content.endsWith("'"))) {
                content = content.slice(1, -1);
            }

            // å¤„ç†ç‰¹æ®Šæ ·å¼æ ‡è®°
            content = processDiaryStyles(content);

            return content;
        }

        // å¤„ç†æ—¥è®°ç‰¹æ®Šæ ·å¼
        function processDiaryStyles(content) {
            // é™åˆ¶æ¯ç§æ ·å¼æœ€å¤šä½¿ç”¨2æ¬¡
            let strikeCount = 0;
            let highlightCount = 0;

            // å¤„ç†åˆ’çº¿æ ·å¼ <strike>å†…å®¹</strike>
            content = content.replace(/<strike>(.*?)<\/strike>/gi, (match, text) => {
                if (strikeCount < 2) {
                    strikeCount++;
                    return `<span class="diary-strikethrough">${text}</span>`;
                }
                return text; // è¶…è¿‡é™åˆ¶æ—¶ç§»é™¤æ ‡è®°ä½†ä¿ç•™æ–‡æœ¬
            });

            // å¤„ç†é«˜äº®æ ·å¼ <mark>å†…å®¹</mark>
            content = content.replace(/<mark>(.*?)<\/mark>/gi, (match, text) => {
                if (highlightCount < 2) {
                    highlightCount++;
                    return `<span class="diary-highlight">${text}</span>`;
                }
                return text; // è¶…è¿‡é™åˆ¶æ—¶ç§»é™¤æ ‡è®°ä½†ä¿ç•™æ–‡æœ¬
            });

            return content;
        }

        // ğŸ”¥ã€æ•°æ®è¿ç§»ã€‘è¿ç§»è¿‡å¾€æ—¥è®°æ ¼å¼ - ä¸€æ¬¡æ€§æ‰§è¡Œ
        function migratePastDiariesFormat(characterId, oldDateStr, newDateStr, diaryContent) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¿ç§»è¿‡
            const migrationKey = `diary_migration_${characterId}`;
            if (localStorage.getItem(migrationKey)) {
                return; // å·²ç»è¿ç§»è¿‡ï¼Œè·³è¿‡
            }

            const pastDiariesKey = `past_diaries_${characterId}`;
            let pastDiaries = JSON.parse(localStorage.getItem(pastDiariesKey) || '[]');

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä»Šå¤©çš„è®°å½•ï¼ˆæ–°æ ¼å¼ï¼‰
            const existingNewIndex = pastDiaries.findIndex(diary => diary.date === newDateStr);

            if (existingNewIndex === -1) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ—§æ ¼å¼çš„è®°å½•
                const existingOldIndex = pastDiaries.findIndex(diary => diary.date === oldDateStr);

                if (existingOldIndex !== -1) {
                    // æ›´æ–°æ—§è®°å½•çš„æ—¥æœŸæ ¼å¼
                    pastDiaries[existingOldIndex].date = newDateStr;
                    pastDiaries[existingOldIndex].content = diaryContent;
                    pastDiaries[existingOldIndex].timestamp = Date.now();
                } else {
                    // æ·»åŠ æ–°è®°å½•
                    pastDiaries.unshift({
                        date: newDateStr,
                        content: diaryContent,
                        timestamp: Date.now()
                    });
                }

                localStorage.setItem(pastDiariesKey, JSON.stringify(pastDiaries));
            }

            // æ ‡è®°å·²å®Œæˆè¿ç§»
            localStorage.setItem(migrationKey, 'completed');
        }

        // ç¼–è¾‘ä»Šæ—¥æ—¥è®°
        async function editTodayDiary() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½ï¼Œè¯·åœ¨å•èŠä¸­ä½¿ç”¨', 'error');
                return;
            }

            const characterId = currentChatCharacter.id;

            const today = new Date().toISOString().split('T')[0];
            const diaryId = `${characterId}_${today}`;

            let todayDiary = null;
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»Dexieæ•°æ®åº“è·å–ä»Šæ—¥æ—¥è®°
                todayDiary = await db.characterDiaries.get(diaryId);
            } catch (error) {
                console.error('è·å–ä»Šæ—¥æ—¥è®°å¤±è´¥:', error);
                showToast('è·å–æ—¥è®°å¤±è´¥', 'error');
                return;
            }

            if (!todayDiary || !todayDiary.content) {
                showToast('ä»Šå¤©è¿˜æ²¡æœ‰æ—¥è®°å¯ä»¥ç¼–è¾‘', 'error');
                return;
            }

            // å°†HTMLæ ¼å¼è½¬æ¢å›æ ‡è®°æ ¼å¼ç”¨äºç¼–è¾‘
            const editableContent = convertHtmlToMarkup(todayDiary.content);

            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'flex';
            editModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ç¼–è¾‘æ—¥è®°</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <textarea id="edit-diary-textarea" class="diary-edit-textarea" placeholder="ç¼–è¾‘æ—¥è®°å†…å®¹...">${editableContent}</textarea>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                            <button class="modal-button modal-primary" onclick="saveDiaryEdit()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);

            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            const textarea = editModal.querySelector('#edit-diary-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // å°†HTMLæ ¼å¼è½¬æ¢å›æ ‡è®°æ ¼å¼ç”¨äºç¼–è¾‘
        function convertHtmlToMarkup(content) {
            return content
                .replace(/<span class="diary-strikethrough">(.*?)<\/span>/gi, '<strike>$1</strike>')
                .replace(/<span class="diary-highlight">(.*?)<\/span>/gi, '<mark>$1</mark>');
        }

        // ä¿å­˜æ—¥è®°ç¼–è¾‘
        async function saveDiaryEdit() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©è§’è‰²', 'error');
                return;
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½
            if (currentChatCharacter.isGroup) {
                showToast('ç¾¤èŠä¸­ä¸æ”¯æŒæ—¥è®°åŠŸèƒ½ï¼Œè¯·åœ¨å•èŠä¸­ä½¿ç”¨', 'error');
                return;
            }

            const characterId = currentChatCharacter.id;
            const today = new Date().toISOString().split('T')[0];
            const diaryId = `${characterId}_${today}`;

            const textarea = document.getElementById('edit-diary-textarea');
            const newContent = textarea.value.trim();

            if (!newContent) {
                showToast('æ—¥è®°å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // å¤„ç†ç‰¹æ®Šæ ·å¼æ ‡è®°
            const processedContent = processDiaryStyles(newContent);

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜åˆ°Dexieæ•°æ®åº“
                await db.characterDiaries.put({
                    id: diaryId,
                    characterId: characterId,
                    date: today,
                    content: processedContent,
                    timestamp: Date.now(),
                    weather: 'â˜€ï¸' // ä¿æŒåŸæœ‰å¤©æ°”æˆ–é»˜è®¤å€¼
                });

                // æ›´æ–°æ˜¾ç¤º
                const contentDiv = document.getElementById('today-diary-content');
                const diaryWithHeader = createDiaryWithHeader(processedContent, today);
                contentDiv.innerHTML = diaryWithHeader;
                contentDiv.classList.remove('empty');

                // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
                document.querySelector('.modal:last-child').remove();

                showToast('æ—¥è®°ä¿å­˜æˆåŠŸ', 'success');

            } catch (error) {
                console.error('ä¿å­˜æ—¥è®°å¤±è´¥:', error);
                showToast('ä¿å­˜æ—¥è®°å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ‰“å¼€æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function openDiarySettings() {
            // è®°å½•æ¥æºç•Œé¢
            window.diarySettingsSourceScreen = 'diary-screen';

            // æ˜¾ç¤ºå…¨å±è®¾ç½®ç•Œé¢
            showApp('diary-settings-screen');

            // åˆå§‹åŒ–è®¾ç½®ç•Œé¢
            await initDiarySettingsScreen();
        }

        // ğŸ”¥ã€é‡æ„ã€‘ä»æ—¥è®°è®¾ç½®ç•Œé¢è¿”å› - ä½¿ç”¨Dexieæ•°æ®åº“
        async function backFromDiarySettings() {
            // è·å–æ¥æºç•Œé¢ï¼Œé»˜è®¤è¿”å›æ—¥è®°ç•Œé¢
            const sourceScreen = window.diarySettingsSourceScreen || 'diary-screen';

            // éšè—è®¾ç½®ç•Œé¢
            hideApp('diary-settings-screen');

            // æ˜¾ç¤ºæ¥æºç•Œé¢
            showApp(sourceScreen);

            // æ¸…é™¤æ¥æºè®°å½•
            window.diarySettingsSourceScreen = null;

            // åº”ç”¨è®¾ç½®åˆ°æ—¥è®°ç•Œé¢
            await applyDiarySettingsToContent();
        }

        // ğŸ”¥ã€é‡æ„ã€‘åˆå§‹åŒ–æ—¥è®°è®¾ç½®ç•Œé¢ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function initDiarySettingsScreen() {
            try {
                // åŠ è½½ä¿å­˜çš„è®¾ç½®
                await loadDiarySettings();

                // æ›´æ–°é¢„è§ˆ
                await updateDiaryPreview();
            } catch (error) {
                console.error('åˆå§‹åŒ–æ—¥è®°è®¾ç½®ç•Œé¢å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘è·å–è§’è‰²ç‰¹å®šçš„æ—¥è®°è®¾ç½®ID
        function getDiarySettingId(settingName) {
            if (!currentChatCharacter) {
                return `global_${settingName}`; // å¦‚æœæ²¡æœ‰å½“å‰è§’è‰²ï¼Œä½¿ç”¨å…¨å±€è®¾ç½®
            }
            return `${currentChatCharacter.id}_${settingName}`;
        }

        // ğŸ”¥ã€é‡æ„ã€‘è·å–è§’è‰²ç‰¹å®šçš„æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function getDiarySetting(settingName, defaultValue) {
            try {
                const settingId = getDiarySettingId(settingName);
                const setting = await db.diarySettings.get(settingId);
                return setting ? setting.settingValue : defaultValue;
            } catch (error) {
                console.error('è·å–æ—¥è®°è®¾ç½®å¤±è´¥:', error);
                return defaultValue;
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘ä¿å­˜è§’è‰²ç‰¹å®šçš„æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function setDiarySetting(settingName, value) {
            try {
                const settingId = getDiarySettingId(settingName);
                const characterId = currentChatCharacter ? currentChatCharacter.id : null;

                await db.diarySettings.put({
                    id: settingId,
                    characterId: characterId,
                    settingName: settingName,
                    settingValue: value,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('ä¿å­˜æ—¥è®°è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘åŠ è½½æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function loadDiarySettings() {
            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘ç§»é™¤å­—ä½“æ—è®¾ç½®ï¼Œä½¿ç”¨å…¨å±€å­—ä½“
                const fontSize = await getDiarySetting('font-size', '16');
                const fontWeight = await getDiarySetting('font-weight', '500');

                // æ’ç‰ˆè®¾ç½®
                const lineHeight = await getDiarySetting('line-height', '1.6');
                const paragraphSpacing = await getDiarySetting('paragraph-spacing', '15');
                const textAlign = await getDiarySetting('text-align', 'left');

                // å†…å®¹å®½åº¦è®¾ç½®
                const contentWidth = await getDiarySetting('content-width', '100');
                const contentPadding = await getDiarySetting('content-padding', '40');
                const contentTopMargin = await getDiarySetting('content-top-margin', '20');

                // çº¸å¼ è®¾ç½®
                const paperType = await getDiarySetting('paper-type', 'plain');

                // ğŸ”¥ã€ä¿®æ”¹ã€‘æ›´æ–°ç•Œé¢æ§ä»¶ï¼Œç§»é™¤å­—ä½“æ—é€‰æ‹©å™¨
                // document.getElementById('font-family-select').value = fontFamily; // å·²ç§»é™¤
                document.getElementById('font-size-slider').value = fontSize;
                document.getElementById('font-size-value').textContent = fontSize + 'px';

                document.getElementById('line-height-slider').value = lineHeight;
                document.getElementById('line-height-value').textContent = lineHeight;
                document.getElementById('paragraph-spacing-slider').value = paragraphSpacing;
                document.getElementById('paragraph-spacing-value').textContent = paragraphSpacing + 'px';

                document.getElementById('content-width-slider').value = contentWidth;
                document.getElementById('content-width-value').textContent = contentWidth + '%';
                document.getElementById('content-padding-slider').value = contentPadding;
                document.getElementById('content-padding-value').textContent = contentPadding + 'px';
                document.getElementById('content-top-margin-slider').value = contentTopMargin;
                document.getElementById('content-top-margin-value').textContent = contentTopMargin + 'px';

                // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©å™¨çŠ¶æ€
                const fontWeightSelect = document.getElementById('fontWeightSelect');
                if (fontWeightSelect) {
                    fontWeightSelect.value = fontWeight;
                }

                const textAlignSelect = document.getElementById('textAlignSelect');
                if (textAlignSelect) {
                    textAlignSelect.value = textAlign;
                }

                // æ–‡æœ¬è£…é¥°è®¾ç½®
                const textDecoration = await getDiarySetting('text-decoration', 'none');
                const textDecorationSelect = document.getElementById('textDecorationSelect');
                if (textDecorationSelect) {
                    textDecorationSelect.value = textDecoration;
                }

                document.querySelectorAll('.paper-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.paper === paperType) {
                        option.classList.add('active');
                    }
                });
            } catch (error) {
                console.error('åŠ è½½æ—¥è®°è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ›´æ–°æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function updateDiarySettings() {
            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘è·å–å½“å‰è®¾ç½®å€¼ï¼Œç§»é™¤å­—ä½“æ—
                // const fontFamily = document.getElementById('font-family-select').value; // å·²ç§»é™¤
                const fontSize = document.getElementById('font-size-slider').value;
                const lineHeight = document.getElementById('line-height-slider').value;
                const paragraphSpacing = document.getElementById('paragraph-spacing-slider').value;
                const contentWidth = document.getElementById('content-width-slider').value;
                const contentPadding = document.getElementById('content-padding-slider').value;
                const contentTopMargin = document.getElementById('content-top-margin-slider').value;

                // æ›´æ–°æ˜¾ç¤ºå€¼
                document.getElementById('font-size-value').textContent = fontSize + 'px';
                document.getElementById('line-height-value').textContent = lineHeight;
                document.getElementById('paragraph-spacing-value').textContent = paragraphSpacing + 'px';
                document.getElementById('content-width-value').textContent = contentWidth + '%';
                document.getElementById('content-padding-value').textContent = contentPadding + 'px';
                document.getElementById('content-top-margin-value').textContent = contentTopMargin + 'px';

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¿å­˜è®¾ç½®ï¼Œç§»é™¤å­—ä½“æ—
                // await setDiarySetting('font-family', fontFamily); // å·²ç§»é™¤
                await setDiarySetting('font-size', fontSize);
                await setDiarySetting('line-height', lineHeight);
                await setDiarySetting('paragraph-spacing', paragraphSpacing);
                await setDiarySetting('content-width', contentWidth);
                await setDiarySetting('content-padding', contentPadding);
                await setDiarySetting('content-top-margin', contentTopMargin);

                // æ›´æ–°é¢„è§ˆ
                await updateDiaryPreview();
            } catch (error) {
                console.error('æ›´æ–°æ—¥è®°è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘è®¾ç½®å­—ä½“ç²—ç»† - ä½¿ç”¨Dexieæ•°æ®åº“
        async function setFontWeight(weight) {
            const select = document.getElementById('fontWeightSelect');
            if (select) {
                select.value = weight;
            }

            await setDiarySetting('font-weight', weight);
            await updateDiaryPreview();
        }

        // ğŸ”¥ã€é‡æ„ã€‘è®¾ç½®æ–‡æœ¬å¯¹é½ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function setTextAlign(align) {
            const select = document.getElementById('textAlignSelect');
            if (select) {
                select.value = align;
            }

            await setDiarySetting('text-align', align);
            await updateDiaryPreview();
        }

        // ğŸ”¥ã€é‡æ„ã€‘è®¾ç½®æ–‡æœ¬è£…é¥° - ä½¿ç”¨Dexieæ•°æ®åº“
        async function setTextDecoration(decoration) {
            const select = document.getElementById('textDecorationSelect');
            if (select) {
                select.value = decoration;
            }

            // ä¿å­˜è®¾ç½®
            await setDiarySetting('text-decoration', decoration);

            // åº”ç”¨åˆ°å½“å‰æ—¥è®°æ˜¾ç¤º
            applyTextDecoration(decoration);

            // æ›´æ–°é¢„è§ˆ
            await updateDiaryPreview();
        }

        // åº”ç”¨æ–‡æœ¬è£…é¥°åˆ°æ—¥è®°æ˜¾ç¤º
        function applyTextDecoration(decoration) {
            const diaryContent = document.getElementById('today-diary-content');
            if (diaryContent) {
                // ç§»é™¤æ‰€æœ‰è£…é¥°ç±»
                diaryContent.classList.remove('decoration-none', 'decoration-underline');

                // æ·»åŠ æ–°çš„è£…é¥°ç±»
                if (decoration && decoration !== 'none') {
                    diaryContent.classList.add('decoration-' + decoration);
                }
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘æ›´æ–°é¢„è§ˆæ•ˆæœ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function updateDiaryPreview() {
            const preview = document.getElementById('diary-preview-content');
            if (!preview) return;

            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘è·å–å½“å‰è®¾ç½®ï¼Œç§»é™¤å­—ä½“æ—
                const fontSize = await getDiarySetting('font-size', '16');
                const fontWeight = await getDiarySetting('font-weight', '500');
                const lineHeight = await getDiarySetting('line-height', '1.6');
                const paragraphSpacing = await getDiarySetting('paragraph-spacing', '15');
                const textAlign = await getDiarySetting('text-align', 'left');
                const contentWidth = await getDiarySetting('content-width', '100');
                const contentPadding = await getDiarySetting('content-padding', '40');
                const contentTopMargin = await getDiarySetting('content-top-margin', '20');
                const paperType = await getDiarySetting('paper-type', 'plain');
                const textDecoration = await getDiarySetting('text-decoration', 'none');

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸å†è®¾ç½®å­—ä½“æ—ï¼Œä½¿ç”¨å…¨å±€å­—ä½“
            // åº”ç”¨æ ·å¼ï¼ˆä¸åŒ…æ‹¬fontFamilyï¼‰
            preview.style.fontSize = fontSize + 'px';
            preview.style.fontWeight = fontWeight;
            preview.style.lineHeight = lineHeight;
            preview.style.textAlign = textAlign;
            preview.style.width = contentWidth + '%';
            preview.style.paddingLeft = contentPadding + 'px';
            preview.style.paddingRight = contentPadding + 'px';
            preview.style.paddingTop = contentTopMargin + 'px';

            // åº”ç”¨æ®µè½é—´è·
            const previewText = preview.querySelector('.preview-text');
            if (previewText) {
                previewText.style.marginBottom = paragraphSpacing + 'px';
            }

            // åº”ç”¨çº¸å¼ èƒŒæ™¯ - å…ˆæ¸…é™¤æ‰€æœ‰çº¸å¼ ç±»ï¼Œå†æ·»åŠ æ–°çš„
            preview.className = 'diary-preview-paper';
            if (paperType && paperType !== 'plain') {
                preview.classList.add(paperType + '-paper');
            }

            // åº”ç”¨æ–‡æœ¬è£…é¥°
            if (textDecoration && textDecoration !== 'none') {
                preview.classList.add('decoration-' + textDecoration);
            }

                // å¤„ç†èƒŒæ™¯å›¾ç‰‡
                if (paperType === 'custom') {
                    const customBg = await getDiarySetting('custom-background', '');
                    if (customBg) {
                        preview.style.backgroundImage = `url(${customBg})`;
                    } else {
                        preview.style.backgroundImage = '';
                    }
                } else {
                    // æ¸…é™¤è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡
                    preview.style.backgroundImage = '';
                }
            } catch (error) {
                console.error('æ›´æ–°æ—¥è®°é¢„è§ˆå¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘é‡ç½®æ—¥è®°è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function resetDiarySettings() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ—¥è®°è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤é»˜è®¤è®¾ç½®ã€‚')) {
                return;
            }

            try {
                // æ¸…é™¤æ‰€æœ‰è®¾ç½®
                const settingsNames = [
                    'font-family', 'font-size', 'font-weight',
                    'line-height', 'paragraph-spacing', 'text-align',
                    'content-width', 'content-padding', 'content-top-margin', 'paper-type',
                    'custom-background', 'text-decoration'
                ];

                for (const settingName of settingsNames) {
                    const settingId = getDiarySettingId(settingName);
                    await db.diarySettings.delete(settingId);
                }

                // é‡æ–°åŠ è½½è®¾ç½®ç•Œé¢
                await loadDiarySettings();
                await updateDiaryPreview();

                showToast('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
            } catch (error) {
                console.error('é‡ç½®æ—¥è®°è®¾ç½®å¤±è´¥:', error);
                showToast('é‡ç½®è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘åº”ç”¨è®¾ç½®åˆ°æ—¥è®°å†…å®¹ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function applyDiarySettingsToContent() {
            const diaryContent = document.getElementById('today-diary-content');
            if (!diaryContent) return;

            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘è·å–è®¾ç½®ï¼Œç§»é™¤å­—ä½“æ—
                const fontSize = await getDiarySetting('font-size', '16');
                const fontWeight = await getDiarySetting('font-weight', '500');
                const lineHeight = await getDiarySetting('line-height', '1.6');
                const textAlign = await getDiarySetting('text-align', 'left');
                const contentWidth = await getDiarySetting('content-width', '100');
                const contentPadding = await getDiarySetting('content-padding', '40');
                const contentTopMargin = await getDiarySetting('content-top-margin', '20');
                const textDecoration = await getDiarySetting('text-decoration', 'none');

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸å†è®¾ç½®å­—ä½“æ—ï¼Œä½¿ç”¨å…¨å±€å­—ä½“
            // åº”ç”¨æ ·å¼ï¼ˆä¸åŒ…æ‹¬fontFamilyï¼‰
            diaryContent.style.fontSize = fontSize + 'px';
            diaryContent.style.fontWeight = fontWeight;
            diaryContent.style.lineHeight = lineHeight;
            diaryContent.style.textAlign = textAlign;
            diaryContent.style.width = contentWidth + '%';
            diaryContent.style.paddingLeft = contentPadding + 'px';
            diaryContent.style.paddingRight = contentPadding + 'px';
            diaryContent.style.paddingTop = contentTopMargin + 'px';

                // åº”ç”¨æ–‡æœ¬è£…é¥°
                applyTextDecoration(textDecoration);
            } catch (error) {
                console.error('åº”ç”¨æ—¥è®°è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘åº”ç”¨è®¾ç½®åˆ°å•ä¸ªæ—¥è®°è§†å›¾ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function applyDiarySettingsToSingleView() {
            const diaryContent = document.getElementById('single-diary-content');
            if (!diaryContent) return;

            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘è·å–è®¾ç½®ï¼Œç§»é™¤å­—ä½“æ—
                const fontSize = await getDiarySetting('font-size', '16');
                const fontWeight = await getDiarySetting('font-weight', '500');
                const lineHeight = await getDiarySetting('line-height', '1.6');
                const textAlign = await getDiarySetting('text-align', 'left');
                const contentWidth = await getDiarySetting('content-width', '100');
                const contentPadding = await getDiarySetting('content-padding', '40');
                const contentTopMargin = await getDiarySetting('content-top-margin', '20');
                const textDecoration = await getDiarySetting('text-decoration', 'none');
                const paperType = await getDiarySetting('paper-type', 'lined');

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¸å†è®¾ç½®å­—ä½“æ—ï¼Œä½¿ç”¨å…¨å±€å­—ä½“
            // åº”ç”¨æ ·å¼ï¼ˆä¸åŒ…æ‹¬fontFamilyï¼‰
            diaryContent.style.fontSize = fontSize + 'px';
            diaryContent.style.fontWeight = fontWeight;
            diaryContent.style.lineHeight = lineHeight;
            diaryContent.style.textAlign = textAlign;
            diaryContent.style.width = contentWidth + '%';
            diaryContent.style.paddingLeft = contentPadding + 'px';
            diaryContent.style.paddingRight = contentPadding + 'px';
            diaryContent.style.paddingTop = contentTopMargin + 'px';

            // åº”ç”¨çº¸å¼ æ ·å¼
            diaryContent.classList.remove('lined-paper', 'grid-paper', 'plain-paper', 'vintage-paper', 'custom-paper');
            if (paperType && paperType !== 'plain') {
                diaryContent.classList.add(paperType + '-paper');
            }

                // åº”ç”¨è‡ªå®šä¹‰èƒŒæ™¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (paperType === 'custom') {
                    const customBackground = await getDiarySetting('custom-background', '');
                    if (customBackground) {
                        diaryContent.style.backgroundImage = `url(${customBackground})`;
                    }
                }

                // åº”ç”¨æ–‡æœ¬è£…é¥°
                diaryContent.classList.remove('decoration-none', 'decoration-underline');
                if (textDecoration && textDecoration !== 'none') {
                    diaryContent.classList.add('decoration-' + textDecoration);
                }
            } catch (error) {
                console.error('åº”ç”¨æ—¥è®°è®¾ç½®åˆ°å•ä¸ªè§†å›¾å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘è®¾ç½®æ—¥è®°çº¸å¼ ç±»å‹ - ä½¿ç”¨Dexieæ•°æ®åº“
        async function setDiaryPaper(paperType) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.paper-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.paper === paperType) {
                    option.classList.add('active');
                }
            });

            // ä¿å­˜è®¾ç½®
            await setDiarySetting('paper-type', paperType);

            // åº”ç”¨åˆ°å½“å‰æ—¥è®°æ˜¾ç¤º
            await applyDiaryPaper(paperType);

            // æ›´æ–°é¢„è§ˆï¼ˆå¦‚æœåœ¨è®¾ç½®ç•Œé¢ï¼‰
            if (document.getElementById('diary-preview-content')) {
                await updateDiaryPreview();
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘åº”ç”¨çº¸å¼ æ ·å¼åˆ°æ—¥è®°æ˜¾ç¤º - ä½¿ç”¨Dexieæ•°æ®åº“
        async function applyDiaryPaper(paperType) {
            const diaryContent = document.getElementById('today-diary-content');
            if (diaryContent) {
                try {
                    // ç§»é™¤æ‰€æœ‰çº¸å¼ ç±»
                    diaryContent.classList.remove('lined-paper', 'grid-paper', 'plain-paper', 'vintage-paper', 'custom-paper');

                    // æ·»åŠ æ–°çš„çº¸å¼ ç±»
                    if (paperType && paperType !== 'plain') { // plainæ˜¯é»˜è®¤æ ·å¼ï¼Œä¸éœ€è¦é¢å¤–çš„ç±»
                        diaryContent.classList.add(paperType + '-paper');
                    }

                    // å¦‚æœæ˜¯è‡ªå®šä¹‰èƒŒæ™¯ï¼Œåº”ç”¨èƒŒæ™¯å›¾ç‰‡
                    if (paperType === 'custom') {
                        const customBg = await getDiarySetting('custom-background', '');
                        if (customBg) {
                            diaryContent.style.backgroundImage = `url(${customBg})`;
                        }
                    } else {
                        // æ¸…é™¤è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡
                        diaryContent.style.backgroundImage = '';
                    }
                } catch (error) {
                    console.error('åº”ç”¨æ—¥è®°çº¸å¼ æ ·å¼å¤±è´¥:', error);
                }
            }
        }

        // ä¸Šä¼ è‡ªå®šä¹‰çº¸å¼ 
        function uploadCustomPaper() {
            const input = document.getElementById('paperImageInput');
            if (input) {
                input.click();
            } else {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
            }
        }

        // ğŸ”¥ã€é‡æ„ã€‘å¤„ç†çº¸å¼ å›¾ç‰‡ä¸Šä¼  - ä½¿ç”¨Dexieæ•°æ®åº“
        function handlePaperUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const imageUrl = e.target.result;

                    // ä¿å­˜è‡ªå®šä¹‰èƒŒæ™¯
                    await setDiarySetting('custom-background', imageUrl);

                    // è®¾ç½®ä¸ºè‡ªå®šä¹‰çº¸å¼ 
                    await setDiaryPaper('custom');

                    // åº”ç”¨è‡ªå®šä¹‰èƒŒæ™¯
                    const diaryContent = document.getElementById('today-diary-content');
                    if (diaryContent) {
                        diaryContent.style.backgroundImage = `url(${imageUrl})`;
                    }

                    // æ›´æ–°é¢„è§ˆï¼ˆå¦‚æœåœ¨è®¾ç½®ç•Œé¢ï¼‰
                    if (document.getElementById('diary-preview-content')) {
                        await updateDiaryPreview();
                    }

                    showToast('è‡ªå®šä¹‰èƒŒæ™¯è®¾ç½®æˆåŠŸ', 'success');
                } catch (error) {
                    console.error('ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯å¤±è´¥:', error);
                    showToast('ä¸Šä¼ èƒŒæ™¯å¤±è´¥', 'error');
                }
            };

            reader.readAsDataURL(file);
        }

        // ğŸ”¥ã€é‡æ„ã€‘åˆå§‹åŒ–æ—¥è®°çº¸å¼ è®¾ç½® - ä½¿ç”¨Dexieæ•°æ®åº“
        async function initDiaryPaper() {
            try {
                const savedPaper = await getDiarySetting('paper-type', 'plain');
                await applyDiaryPaper(savedPaper);

                // åº”ç”¨å…¶ä»–è‡ªå®šä¹‰è®¾ç½®
                await applyDiarySettingsToContent();
            } catch (error) {
                console.error('åˆå§‹åŒ–æ—¥è®°çº¸å¼ è®¾ç½®å¤±è´¥:', error);
            }
        }

        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ›´æ–°è§’è‰²çŠ¶æ€
        async function shouldUpdateCharacterStatus(characterId) {
            try {
                const currentStatus = getCharacterStatus(characterId);
                const lastUpdate = new Date(currentStatus.lastUpdate);
                const now = new Date();
                const timeDiff = now - lastUpdate;

                // ğŸ”¥ã€ä¿®å¤ã€‘è·å–ç”¨æˆ·è®¾ç½®çš„æ›´æ–°é¢‘ç‡é—´éš”
                const updateInterval = getStatusUpdateInterval();

                // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´è¿˜æ²¡åˆ°è®¾å®šçš„é—´éš”ï¼Œä¸æ›´æ–°
                if (timeDiff < updateInterval) {
                    return false;
                }

                // å¦‚æœçŠ¶æ€è¶…è¿‡è®¾å®šé—´éš”å¾ˆä¹…æ²¡æ›´æ–°ï¼Œå¼ºåˆ¶æ›´æ–°
                if (timeDiff > updateInterval * 2) {
                    return true;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæœ€è¿‘æœ‰èŠå¤©æ´»åŠ¨ï¼Œåœ¨å®šæ—¶å™¨è§¦å‘æ—¶æœ‰æ›´é«˜æ¦‚ç‡æ›´æ–°
                if (currentStatus.lastChatTime) {
                    const lastChatTime = new Date(currentStatus.lastChatTime);
                    const chatTimeDiff = now - lastChatTime;

                    // å¦‚æœæœ€è¿‘èŠå¤©è¿‡ï¼Œä¸”è·ç¦»ä¸Šæ¬¡æ›´æ–°å·²ç»è¶…è¿‡è®¾å®šé—´éš”ï¼Œæœ‰è¾ƒé«˜æ¦‚ç‡æ›´æ–°
                    if (chatTimeDiff < updateInterval && timeDiff >= updateInterval) {
                        return Math.random() < 0.7; // 70%æ¦‚ç‡
                    }
                }

                // é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœåˆ°äº†æ›´æ–°æ—¶é—´ï¼Œæœ‰ä¸€å®šæ¦‚ç‡æ›´æ–°
                return Math.random() < 0.3; // 30%æ¦‚ç‡

            } catch (error) {
                console.error('åˆ¤æ–­è§’è‰²çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                return Math.random() < 0.1; // 10%æ¦‚ç‡
            }
        }

        // æ›´æ–°è§’è‰²æœ€åèŠå¤©æ—¶é—´
        async function updateCharacterLastChatTime(characterId) {
            try {
                let statusRecord = characterStatusData.find(s => s.characterId === characterId);

                if (!statusRecord) {
                    // å¦‚æœæ²¡æœ‰çŠ¶æ€è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                    statusRecord = {
                        id: `status_${characterId}`,
                        characterId: characterId,
                        status: 'online',
                        activity: 'åœ¨çº¿',
                        location: '',
                        lastUpdate: new Date().toISOString(),
                        lastChatTime: Date.now()
                    };
                    characterStatusData.push(statusRecord);
                } else {
                    // åªæ›´æ–°èŠå¤©æ—¶é—´ï¼Œä¸æ”¹å˜å…¶ä»–çŠ¶æ€
                    statusRecord.lastChatTime = Date.now();
                }

                await db.characterStatus.put(statusRecord);

            } catch (error) {
                console.error('æ›´æ–°è§’è‰²èŠå¤©æ—¶é—´å¤±è´¥:', error);
            }
        }

        // åœ¨å‘é€/æ¥æ”¶æ¶ˆæ¯åè§¦å‘çŠ¶æ€æ›´æ–°
        async function triggerStatusUpdateAfterMessage(characterId) {
            // ğŸ”¥ã€ä¿®å¤ã€‘é¦–å…ˆæ£€æŸ¥æ˜¯å¦å¼€å¯äº†è§’è‰²çŠ¶æ€æ˜¾ç¤º
            const chatSettings = await getAsyncChatSettings(characterId);
            if (!chatSettings.characterStatusEnabled) {
                console.log(`è§’è‰² ${characterId} æœªå¯ç”¨çŠ¶æ€æ˜¾ç¤ºï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°`);
                return;
            }

            // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ä¸å†åœ¨æ¯æ¬¡èŠå¤©åç«‹å³è§¦å‘çŠ¶æ€æ›´æ–°
            // çŠ¶æ€æ›´æ–°åº”è¯¥å®Œå…¨ç”±å®šæ—¶å™¨æ§åˆ¶ï¼Œéµå¾ªç”¨æˆ·è®¾ç½®çš„é¢‘ç‡
            // è¿™é‡Œåªæ˜¯è®°å½•æœ€åä¸€æ¬¡èŠå¤©æ—¶é—´ï¼Œä¾›å®šæ—¶å™¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
            await updateCharacterLastChatTime(characterId);

            console.log(`è§’è‰² ${characterId} èŠå¤©æ—¶é—´å·²è®°å½•ï¼ŒçŠ¶æ€æ›´æ–°å°†ç”±å®šæ—¶å™¨æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é¢‘ç‡è¿›è¡Œ`);
        }

        // åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                startStatusUpdateTimer();
            }, 5000); // å»¶è¿Ÿ5ç§’å¯åŠ¨
        });

        console.log('ğŸš« æ‹‰é»‘ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½å·²åŠ è½½');

        // ğŸ”§ã€æ–°å¢ã€‘è®°å¿†è®¾ç½®ç•Œé¢äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ é˜ˆå€¼æ»‘å—äº‹ä»¶ç›‘å¬å™¨
            const coreThresholdSlider = document.getElementById('coreMemoryThreshold');
            const episodicThresholdSlider = document.getElementById('episodicMemoryThreshold');

            if (coreThresholdSlider) {
                coreThresholdSlider.addEventListener('input', updateThresholdDisplay);
            }
            if (episodicThresholdSlider) {
                episodicThresholdSlider.addEventListener('input', updateThresholdDisplay);
            }
        });

        // ğŸ”¥ã€æ–°å¢ã€‘è®°å¿†ç®¡ç†ç³»ç»Ÿ

        // æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—å‡½æ•°ï¼ˆç®€å•çš„Jaccardç›¸ä¼¼åº¦ï¼‰
        function calculateTextSimilarity(text1, text2) {
            if (!text1 || !text2) return 0;

            // è½¬æ¢ä¸ºå°å†™å¹¶åˆ†è¯
            const words1 = new Set(text1.toLowerCase().match(/[\u4e00-\u9fa5\w]+/g) || []);
            const words2 = new Set(text2.toLowerCase().match(/[\u4e00-\u9fa5\w]+/g) || []);

            // è®¡ç®—äº¤é›†å’Œå¹¶é›†
            const intersection = new Set([...words1].filter(x => words2.has(x)));
            const union = new Set([...words1, ...words2]);

            // Jaccardç›¸ä¼¼åº¦
            return union.size === 0 ? 0 : intersection.size / union.size;
        }

        // è®°å¿†ç³»ç»Ÿé…ç½®ï¼ˆå¯ç”±ç”¨æˆ·è®¾ç½®ï¼‰
        let MEMORY_CONFIG = {
            // AIè®°å¿†æå–é…ç½®
            AI_EXTRACT_INTERVAL: 60, // é»˜è®¤æ¯30å›åˆå¯¹è¯ï¼ˆ60æ¡æ¶ˆæ¯ï¼‰è¿›è¡ŒAIæå–

            // æ ¸å¿ƒè®°å¿†é…ç½®
            CORE_MEMORY_IMPORTANCE_THRESHOLD: 0.9, // æ ¸å¿ƒè®°å¿†é‡è¦æ€§é˜ˆå€¼90%
            MAX_CORE_MEMORIES_PER_CHARACTER: 50, // æ¯ä¸ªè§’è‰²æœ€å¤šä¿ç•™50æ¡æ ¸å¿ƒè®°å¿†

            // æƒ…æ™¯è®°å¿†é…ç½®
            EPISODIC_MEMORY_IMPORTANCE_THRESHOLD: 0.6, // æƒ…æ™¯è®°å¿†é‡è¦æ€§é˜ˆå€¼60%
            MAX_EPISODIC_MEMORIES_PER_CHARACTER: 100, // æ¯ä¸ªè§’è‰²æœ€å¤šä¿ç•™100æ¡æƒ…æ™¯è®°å¿†

            // è·¨åº”ç”¨è®°å¿†é…ç½®
            CROSS_APP_TIMELINE_LIMIT: 20, // è·¨åº”ç”¨æ—¶é—´çº¿åœ¨å·¥ä½œè®°å¿†ä¸­çš„æœ€å¤§æ¡æ•°
        };

        // ä»ç”¨æˆ·è®¾ç½®ä¸­åŠ è½½è®°å¿†é…ç½®
        async function loadMemoryConfig() {
            try {
                const settings = await db.globalSettings.get('memoryConfig');
                if (settings && settings.value) {
                    MEMORY_CONFIG = { ...MEMORY_CONFIG, ...settings.value };
                }
            } catch (error) {
                console.error('åŠ è½½è®°å¿†é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜è®°å¿†é…ç½®åˆ°ç”¨æˆ·è®¾ç½®
        async function saveMemoryConfig() {
            try {
                await db.globalSettings.put({
                    id: 'memoryConfig',
                    value: MEMORY_CONFIG
                });
            } catch (error) {
                console.error('ä¿å­˜è®°å¿†é…ç½®å¤±è´¥:', error);
            }
        }

        // è‡ªåŠ¨æ‘˜è¦ç”ŸæˆåŠŸèƒ½
        async function generateConversationSummary(characterId, messages) {
            if (!messages || messages.length === 0) return null;

            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return null;

                // æ„å»ºæ‘˜è¦ç”Ÿæˆçš„promptï¼Œç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸‰äººç§°
                const summaryPrompt = `
# å¯¹è¯æ‘˜è¦ä»»åŠ¡

ä½ éœ€è¦ä¸ºä»¥ä¸‹å¯¹è¯ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ã€‚

## è§’è‰²ä¿¡æ¯
- è§’è‰²åç§°: ${character.name}
- è§’è‰²è®¾å®š: ${character.bio || 'æ— ç‰¹æ®Šè®¾å®š'}

## å¯¹è¯å†…å®¹
${messages.map(msg => {
    const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : character.name;
    const content = typeof msg.content === 'string' ? msg.content : '[å›¾ç‰‡/æ–‡ä»¶]';
    return `${sender}: ${content}`;
}).join('\n')}

## æ‘˜è¦è¦æ±‚
è¯·ç”Ÿæˆä¸€ä¸ª100-200å­—çš„å¯¹è¯æ‘˜è¦ï¼ŒåŒ…å«ï¼š
1. ä¸»è¦è¯é¢˜å’Œè®¨è®ºå†…å®¹
2. é‡è¦çš„æƒ…æ„Ÿå˜åŒ–æˆ–å…³é”®äº‹ä»¶
3. åŒæ–¹çš„æ€åº¦å’Œå…³ç³»å˜åŒ–
4. ä»»ä½•é‡è¦çš„å†³å®šæˆ–çº¦å®š

## é‡è¦è¦æ±‚ï¼šç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸‰äººç§°
- ç”¨"ç”¨æˆ·"æŒ‡ä»£ç”¨æˆ·ï¼Œç”¨"${character.name}"æŒ‡ä»£è§’è‰²
- ä¸è¦ä½¿ç”¨"æˆ‘"ã€"ä½ "ç­‰ç¬¬ä¸€ã€ç¬¬äºŒäººç§°
- ä¾‹å¦‚ï¼š"ç”¨æˆ·å‘${character.name}è¯¢é—®..."è€Œä¸æ˜¯"ä½ é—®æˆ‘..."

è¯·ç”¨ç¬¬ä¸‰äººç§°å®¢è§‚æè¿°ï¼Œä¿æŒç®€æ´æ˜äº†ã€‚`;

                // è°ƒç”¨AIæå–è®°å¿†
                const response = await callChatAPI(extractPrompt, character);
                const responseText = Array.isArray(response) ? response[0] : response;

                if (responseText && typeof responseText === 'string') {
                    try {
                        // æå–JSONéƒ¨åˆ†
                        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const memories = JSON.parse(jsonMatch[0]);

                            // è·å–ç°æœ‰è®°å¿†ï¼Œæ£€æŸ¥é‡å¤
                            const existingMemories = await db.coreMemories
                                .where('characterId')
                                .equals(characterId)
                                .toArray();

                            // ä¿å­˜æ ¸å¿ƒè®°å¿†ï¼ˆç¡®ä¿è§’è‰²éš”ç¦»ï¼‰
                            for (const memory of memories.core_memories || []) {
                                if (memory.importance >= MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD) {
                                    // åªæ£€æŸ¥è¯¥è§’è‰²çš„ç°æœ‰è®°å¿†ï¼Œé¿å…è·¨è§’è‰²æ··æ·†
                                    const isDuplicate = existingMemories.some(existing => {
                                        const similarity = calculateTextSimilarity(existing.fact, memory.fact);
                                        return similarity > 0.8;
                                    });

                                    if (!isDuplicate) {
                                        const coreMemory = {
                                            id: `core_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                            characterId: characterId, // ä¸¥æ ¼ç»‘å®šè§’è‰²ID
                                            fact: memory.fact,
                                            importance: memory.importance,
                                            category: memory.category || 'other',
                                            timestamp: Date.now(),
                                            type: 'core',
                                            source: 'single_chat', // æ ‡è®°æ¥æºï¼ŒåŒºåˆ†å•èŠå’Œç¾¤èŠ
                                            contextId: characterId // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDç”¨äºè®°å¿†éš”ç¦»
                                        };

                                        await db.coreMemories.add(coreMemory);
                                        console.log(`âœ… [${character.name}] æ ¸å¿ƒè®°å¿†: ${memory.fact}`);
                                    }
                                }
                            }

                            // ä¿å­˜æƒ…æ™¯è®°å¿†ï¼ˆç¡®ä¿è§’è‰²éš”ç¦»ï¼‰
                            for (const memory of memories.episodic_memories || []) {
                                if (memory.importance >= MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD) {
                                    const episodicMemory = {
                                        id: `episodic_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                        characterId: characterId, // ä¸¥æ ¼ç»‘å®šè§’è‰²ID
                                        fact: memory.fact,
                                        importance: memory.importance,
                                        category: memory.category || 'other',
                                        timestamp: Date.now(),
                                        source: 'single_chat', // æ ‡è®°æ¥æº
                                        contextId: characterId // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDç”¨äºè®°å¿†éš”ç¦»
                                    };

                                    await db.episodicMemories.add(episodicMemory);
                                    console.log(`âœ… [${character.name}] æƒ…æ™¯è®°å¿†: ${memory.fact}`);
                                }
                            }
                        }
                    } catch (parseError) {
                        console.warn('è§£æè®°å¿†JSONå¤±è´¥:', parseError);
                    }
                }
            } catch (error) {
                console.error('AIè®°å¿†æå–å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ‘˜è¦
        async function checkAndGenerateSummary(characterId) {
            try {
                const messages = chatMessages[characterId] || [];
                if (messages.length === 0) return;

                // è·å–æœ€åä¸€æ¬¡æ‘˜è¦çš„æ—¶é—´
                const summaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const lastSummary = summaries.length > 0
                    ? summaries.sort((a, b) => b.timestamp - a.timestamp)[0]
                    : null;

                let shouldGenerate = false;
                let messagesToSummarize = [];

                if (!lastSummary) {
                    // å¦‚æœä»æœªç”Ÿæˆè¿‡æ‘˜è¦ï¼Œä¸”æ¶ˆæ¯æ•°é‡è¾¾åˆ°é˜ˆå€¼
                    if (messages.length >= MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT) {
                        messagesToSummarize = messages.slice(-MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT);
                        shouldGenerate = true;
                    }
                } else {
                    // è®¡ç®—è‡ªä¸Šæ¬¡æ‘˜è¦åçš„æ–°æ¶ˆæ¯
                    const lastSummaryTime = lastSummary.context?.endTime || lastSummary.timestamp;
                    const newMessages = messages.filter(msg => msg.timestamp > lastSummaryTime);

                    // æ£€æŸ¥æ¶ˆæ¯æ•°é‡æˆ–æ—¶é—´é—´éš”
                    const timeDiff = Date.now() - lastSummary.timestamp;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);

                    if (newMessages.length >= MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT ||
                        hoursDiff >= MEMORY_CONFIG.SUMMARY_TRIGGER_TIME_HOURS) {
                        messagesToSummarize = newMessages.slice(-MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT);
                        shouldGenerate = true;
                    }
                }

                if (shouldGenerate && messagesToSummarize.length > 0) {
                    await generateConversationSummary(characterId, messagesToSummarize);
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ‘˜è¦ç”Ÿæˆå¤±è´¥:', error);
            }
        }

        // ç§»é™¤å…³é”®è¯æå–åŠŸèƒ½ï¼Œç®€åŒ–ä¸ºçº¯AIæå–

        // AIè®°å¿†æå–åŠŸèƒ½ï¼ˆä¸¥æ ¼çš„æ ¸å¿ƒè®°å¿†ï¼‰
        async function extractMemoriesWithAI(characterId, messages, contextId = null) {
            if (!messages || messages.length === 0) return;

            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæ²¡æœ‰æä¾›contextIdï¼Œä½¿ç”¨characterIdä½œä¸ºé»˜è®¤å€¼ï¼ˆå•èŠï¼‰
                if (!contextId) {
                    contextId = characterId;
                }

                // æ„å»ºæ›´ä¸¥æ ¼çš„è®°å¿†æå–promptï¼Œç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸‰äººç§°
                const extractPrompt = `
# è®°å¿†æå–ä»»åŠ¡

ä½ éœ€è¦ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–ä¸¤ç±»è®°å¿†ï¼šæ ¸å¿ƒè®°å¿†å’Œæƒ…æ™¯è®°å¿†ã€‚

## è§’è‰²ä¿¡æ¯
- è§’è‰²åç§°: ${character.name}
- è§’è‰²è®¾å®š: ${character.bio || 'æ— ç‰¹æ®Šè®¾å®š'}

## å¯¹è¯å†…å®¹
${messages.map(msg => {
    const sender = msg.sender === 'sent' ? 'ç”¨æˆ·' : character.name;
    const content = typeof msg.content === 'string' ? msg.content : '[å›¾ç‰‡/æ–‡ä»¶]';
    return `${sender}: ${content}`;
}).join('\n')}

## æå–æ ‡å‡†

### æ ¸å¿ƒè®°å¿†ï¼ˆimportance >= 0.9ï¼‰
åªæœ‰ä»¥ä¸‹ç±»å‹çš„ä¿¡æ¯æ‰èƒ½æˆä¸ºæ ¸å¿ƒè®°å¿†ï¼š
- ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼šçœŸå®å§“åã€ç”Ÿæ—¥ã€èŒä¸šã€å®¶åº­æˆå‘˜
- é‡å¤§æƒ…æ„Ÿè½¬å˜ï¼šè¡¨ç™½ã€åˆ†æ‰‹ã€å’Œå¥½ã€æ·±åº¦æƒ…æ„Ÿäº¤æµ
- é‡è¦æ‰¿è¯ºå’Œçº¦å®šï¼šé•¿æœŸè®¡åˆ’ã€é‡è¦çº¦å®š
- å…³é”®äººç”Ÿäº‹ä»¶ï¼šæ¯•ä¸šã€å·¥ä½œå˜åŠ¨ã€æ¬å®¶ã€é‡è¦çºªå¿µæ—¥
- è§’è‰²ä¸ç”¨æˆ·å…³ç³»çš„é‡å¤§å˜åŒ–

### æƒ…æ™¯è®°å¿†ï¼ˆimportance 0.6-0.8ï¼‰
æ—¥å¸¸ä½†æœ‰æ„ä¹‰çš„äº‹ä»¶ï¼š
- ä¸€èµ·åšçš„æ´»åŠ¨å’Œä½“éªŒ
- ç”¨æˆ·çš„ä¹ æƒ¯å’Œåå¥½
- æœ‰è¶£çš„å¯¹è¯å’Œäº’åŠ¨
- æ—¥å¸¸ç”Ÿæ´»çš„åˆ†äº«

## é‡è¦è¦æ±‚ï¼šè®°å¿†æè¿°å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°
- ç”¨"ç”¨æˆ·"æŒ‡ä»£ç”¨æˆ·ï¼Œç”¨"${character.name}"æŒ‡ä»£è§’è‰²
- ä¸è¦ä½¿ç”¨"æˆ‘"ã€"ä½ "ç­‰ç¬¬ä¸€ã€ç¬¬äºŒäººç§°
- ä¾‹å¦‚ï¼š"ç”¨æˆ·å‘Šè¯‰${character.name}è‡ªå·±çš„ç”Ÿæ—¥æ˜¯..."è€Œä¸æ˜¯"æˆ‘çš„ç”Ÿæ—¥æ˜¯..."

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

{
  "core_memories": [
    {"fact": "ç®€æ´çš„æ ¸å¿ƒäº‹å®ï¼ˆä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼‰", "importance": 0.9, "category": "ç±»åˆ«"}
  ],
  "episodic_memories": [
    {"fact": "æƒ…æ™¯æè¿°ï¼ˆä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼‰", "importance": 0.7, "category": "ç±»åˆ«"}
  ]
}

æ³¨æ„ï¼š
1. åªè¿”å›JSONï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæ–‡å­—
2. å¦‚æœæ²¡æœ‰ç¬¦åˆæ ‡å‡†çš„è®°å¿†ï¼Œå¯¹åº”æ•°ç»„ä¸ºç©º
3. importanceå¿…é¡»æ˜¯æ•°å­—ï¼Œä¸è¦ç”¨å­—ç¬¦ä¸²
4. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®
5. æ‰€æœ‰factå­—æ®µå¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°æè¿°`;

                // è°ƒç”¨AIæå–æ ¸å¿ƒè®°å¿†
                const response = await callChatAPI(extractPrompt, character);
                let memories = [];
                let responseText = null; // åœ¨å¤–å±‚å®šä¹‰ï¼Œç¡®ä¿catchå—å¯ä»¥è®¿é—®

                try {
                    // å°è¯•è§£æJSONå“åº”
                    responseText = Array.isArray(response) ? response[0] : response;
                    if (responseText && typeof responseText === 'string') {
                        console.log('ğŸ” AIè®°å¿†æå–åŸå§‹å“åº”:', responseText);

                        // å¤šç§æ–¹å¼å°è¯•æå–JSON
                        let jsonText = null;

                        // æ–¹å¼1: æå–å®Œæ•´çš„JSONå¯¹è±¡
                        const jsonObjectMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonObjectMatch) {
                            jsonText = jsonObjectMatch[0];
                        } else {
                            // æ–¹å¼2: æå–JSONæ•°ç»„
                            const jsonArrayMatch = responseText.match(/\[[\s\S]*\]/);
                            if (jsonArrayMatch) {
                                jsonText = jsonArrayMatch[0];
                            }
                        }

                        if (jsonText) {
                            console.log('ğŸ” æå–çš„JSONæ–‡æœ¬:', jsonText);
                            memories = JSON.parse(jsonText);
                        } else {
                            console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼');
                            return; // å¦‚æœæ²¡æœ‰æ‰¾åˆ°JSONï¼Œç›´æ¥è¿”å›
                        }
                    }
                } catch (parseError) {
                    console.warn('è§£ææ ¸å¿ƒè®°å¿†JSONå¤±è´¥:', parseError);
                    console.warn('åŸå§‹å“åº”:', responseText);
                    return; // è§£æå¤±è´¥æ—¶ç›´æ¥è¿”å›ï¼Œé¿å…åç»­é”™è¯¯
                }

                // è·å–ç°æœ‰çš„è®°å¿†ï¼Œæ£€æŸ¥é‡å¤
                const [existingCoreMemories, existingEpisodicMemories] = await Promise.all([
                    db.coreMemories.where('characterId').equals(characterId).toArray(),
                    db.episodicMemories.where('characterId').equals(characterId).toArray()
                ]);

                // ğŸ”¥ã€ä¿®å¤ã€‘å¤„ç†æ ¸å¿ƒè®°å¿†
                if (memories.core_memories && Array.isArray(memories.core_memories)) {
                    for (const memory of memories.core_memories) {
                        if (memory.importance >= MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD) {
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸ä¼¼çš„è®°å¿†
                            const isDuplicate = existingCoreMemories.some(existing => {
                                const similarity = calculateTextSimilarity(existing.fact, memory.fact);
                                return similarity > 0.8; // ç›¸ä¼¼åº¦è¶…è¿‡80%è®¤ä¸ºæ˜¯é‡å¤
                            });

                            if (!isDuplicate) {
                                const coreMemory = {
                                    id: `core_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    characterId: characterId,
                                    fact: memory.fact,
                                    importance: memory.importance,
                                    category: memory.category || 'other',
                                    timestamp: Date.now(),
                                    type: 'core',
                                    contextId: contextId // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDç”¨äºè®°å¿†éš”ç¦»
                                };

                                await db.coreMemories.add(coreMemory);
                                console.log(`âœ… ä¸ºè§’è‰² ${character.name} æ·»åŠ æ ¸å¿ƒè®°å¿†: ${memory.fact}`);
                            } else {
                                console.log(`âš ï¸ è·³è¿‡é‡å¤æ ¸å¿ƒè®°å¿†: ${memory.fact}`);
                            }
                        }
                    }
                }

                // ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†æƒ…æ™¯è®°å¿†
                if (memories.episodic_memories && Array.isArray(memories.episodic_memories)) {
                    for (const memory of memories.episodic_memories) {
                        if (memory.importance >= MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD) {
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸ä¼¼çš„è®°å¿†
                            const isDuplicate = existingEpisodicMemories.some(existing => {
                                const similarity = calculateTextSimilarity(existing.fact, memory.fact);
                                return similarity > 0.8; // ç›¸ä¼¼åº¦è¶…è¿‡80%è®¤ä¸ºæ˜¯é‡å¤
                            });

                            if (!isDuplicate) {
                                const episodicMemory = {
                                    id: `episodic_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    characterId: characterId,
                                    fact: memory.fact,
                                    importance: memory.importance,
                                    category: memory.category || 'other',
                                    timestamp: Date.now(),
                                    contextId: contextId // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ä¸Šä¸‹æ–‡IDç”¨äºè®°å¿†éš”ç¦»
                                };

                                await db.episodicMemories.add(episodicMemory);
                                console.log(`âœ… ä¸ºè§’è‰² ${character.name} æ·»åŠ æƒ…æ™¯è®°å¿†: ${memory.fact}`);
                            } else {
                                console.log(`âš ï¸ è·³è¿‡é‡å¤æƒ…æ™¯è®°å¿†: ${memory.fact}`);
                            }
                        }
                    }
                }

                // æ¸…ç†è¿‡å¤šçš„è®°å¿†
                await cleanupCoreMemories(characterId);
                await cleanupEpisodicMemories(characterId);

            } catch (error) {
                console.error('æå–æ ¸å¿ƒè®°å¿†å¤±è´¥:', error);
            }
        }

        // æ¸…ç†è¿‡å¤šçš„æ ¸å¿ƒè®°å¿†ï¼Œä¿ç•™æœ€é‡è¦çš„
        async function cleanupCoreMemories(characterId) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const memories = allMemories.sort((a, b) => b.importance - a.importance);
                const maxCoreMemories = MEMORY_CONFIG.MAX_CORE_MEMORIES_PER_CHARACTER || 50;

                if (memories.length > maxCoreMemories) {
                    const toDelete = memories.slice(maxCoreMemories);
                    for (const memory of toDelete) {
                        await db.coreMemories.delete(memory.id);
                    }
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${toDelete.length} ä¸ªä½é‡è¦æ€§çš„æ ¸å¿ƒè®°å¿†`);
                }
            } catch (error) {
                console.error('æ¸…ç†æ ¸å¿ƒè®°å¿†å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†è¿‡å¤šçš„æƒ…æ™¯è®°å¿†ï¼Œä¿ç•™æœ€é‡è¦å’Œæœ€æ–°çš„
        async function cleanupEpisodicMemories(characterId) {
            try {
                const allMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                // æŒ‰é‡è¦æ€§å’Œæ—¶é—´æ’åºï¼Œä¿ç•™æœ€é‡è¦å’Œæœ€æ–°çš„è®°å¿†
                const memories = allMemories.sort((a, b) => {
                    // å…ˆæŒ‰é‡è¦æ€§æ’åºï¼Œå†æŒ‰æ—¶é—´æ’åº
                    if (Math.abs(a.importance - b.importance) > 0.1) {
                        return b.importance - a.importance;
                    }
                    return b.timestamp - a.timestamp;
                });

                const maxEpisodicMemories = MEMORY_CONFIG.MAX_EPISODIC_MEMORIES_PER_CHARACTER || 100;

                if (memories.length > maxEpisodicMemories) {
                    const toDelete = memories.slice(maxEpisodicMemories);
                    for (const memory of toDelete) {
                        await db.episodicMemories.delete(memory.id);
                    }
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${toDelete.length} ä¸ªæ—§çš„æƒ…æ™¯è®°å¿†`);
                }
            } catch (error) {
                console.error('æ¸…ç†æƒ…æ™¯è®°å¿†å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„æ—¶é—´çº¿è®°å¿†å’Œè®°å¿†æ‘˜è¦
        async function cleanupExpiredMemories() {
            try {
                const memorySettings = getGlobalMemorySettings();

                // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœè®¾ç½®ä¸ºæ°¸ä¹…è®°å¿†(-1)ï¼Œåˆ™è·³è¿‡æ¸…ç†
                if (memorySettings.memoryDays === -1) {
                    console.log('ğŸ”¥ æ°¸ä¹…è®°å¿†æ¨¡å¼ï¼Œè·³è¿‡è‡ªåŠ¨æ¸…ç†');
                    return;
                }

                const cutoffTimestamp = Date.now() - (memorySettings.memoryDays * 24 * 60 * 60 * 1000);
                const cutoffDateStr = new Date(cutoffTimestamp).toISOString().split('T')[0];

                // æ¸…ç†è¿‡æœŸçš„æ—¶é—´çº¿è®°å¿†
                const expiredTimelineEvents = await db.crossAppTimeline
                    .where('timestamp')
                    .below(cutoffTimestamp)
                    .toArray();

                if (expiredTimelineEvents.length > 0) {
                    await db.crossAppTimeline
                        .where('timestamp')
                        .below(cutoffTimestamp)
                        .delete();
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${expiredTimelineEvents.length} æ¡è¿‡æœŸçš„æ—¶é—´çº¿è®°å¿†`);
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç†è¿‡æœŸçš„è®°å¿†æ‘˜è¦ - æ”¹ç”¨timestampå­—æ®µä¿æŒä¸€è‡´æ€§
                const expiredSummaries = await db.memorySummaries
                    .where('timestamp')
                    .below(cutoffTimestamp)
                    .toArray();

                if (expiredSummaries.length > 0) {
                    await db.memorySummaries
                        .where('timestamp')
                        .below(cutoffTimestamp)
                        .delete();
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${expiredSummaries.length} æ¡è¿‡æœŸçš„è®°å¿†æ‘˜è¦`);
                }

                // æ¸…ç†è¿‡æœŸçš„æƒ…æ™¯è®°å¿†
                const expiredEpisodicMemories = await db.episodicMemories
                    .where('timestamp')
                    .below(cutoffTimestamp)
                    .toArray();

                if (expiredEpisodicMemories.length > 0) {
                    await db.episodicMemories
                        .where('timestamp')
                        .below(cutoffTimestamp)
                        .delete();
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${expiredEpisodicMemories.length} æ¡è¿‡æœŸçš„æƒ…æ™¯è®°å¿†`);
                }

            } catch (error) {
                console.error('æ¸…ç†è¿‡æœŸè®°å¿†å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘å®šæœŸæ¸…ç†è¿‡æœŸè®°å¿†ï¼ˆæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
        setInterval(cleanupExpiredMemories, 60 * 60 * 1000); // 1å°æ—¶

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(cleanupExpiredMemories, 5000); // å»¶è¿Ÿ5ç§’æ‰§è¡Œï¼Œé¿å…å½±å“é¡µé¢åŠ è½½
        });

        // è·å–è§’è‰²çš„æ ¸å¿ƒè®°å¿†ç”¨äºå¯¹è¯
        async function getCoreMemoriesForChat(characterId, limit = 10) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const memories = allMemories
                    .sort((a, b) => b.importance - a.importance)
                    .slice(0, limit);

                return memories.map(m => m.fact).join('\n');
            } catch (error) {
                console.error('è·å–æ ¸å¿ƒè®°å¿†å¤±è´¥:', error);
                return '';
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ£€æŸ¥è§’è‰²æ˜¯å¦åº”è¯¥è®°å½•ç¾¤èŠè®°å¿†çš„å‡½æ•°
        async function shouldRecordGroupMemoryForCharacter(characterId, groupId) {
            try {
                // è·å–è¯¥è§’è‰²çš„å•èŠè®¾ç½®
                const characterChatSettings = await getAsyncChatSettings(characterId);
                const sharedGroupIds = characterChatSettings.memorySharedGroupIds || [];

                // æ£€æŸ¥è¯¥ç¾¤èŠæ˜¯å¦åœ¨è§’è‰²çš„å…±äº«ç¾¤èŠåˆ—è¡¨ä¸­
                const shouldRecord = sharedGroupIds.includes(groupId);

                console.log(`ğŸ” è®°å¿†å…±äº«æ£€æŸ¥ - è§’è‰²: ${characterId}, ç¾¤èŠ: ${groupId}, åº”è®°å½•: ${shouldRecord}`);
                console.log(`ğŸ” è§’è‰²çš„å…±äº«ç¾¤èŠåˆ—è¡¨:`, sharedGroupIds);

                return shouldRecord;
            } catch (error) {
                console.warn('æ£€æŸ¥è®°å¿†å…±äº«è®¾ç½®å¤±è´¥:', error);
                // å‡ºé”™æ—¶é»˜è®¤ä¸è®°å½•ï¼Œé¿å…æ„å¤–çš„è®°å¿†æ³„éœ²
                return false;
            }
        }

        // è·¨åº”ç”¨æ—¶é—´çº¿è®°å½•åŠŸèƒ½
        async function recordCrossAppEvent(characterId, appType, action, context, messageId = null) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘éªŒè¯å¿…éœ€å‚æ•°
                if (!characterId || !appType || !action) {
                    console.error('âŒ è®°å½•äº‹ä»¶å¤±è´¥: ç¼ºå°‘å¿…éœ€å‚æ•°', {
                        characterId,
                        appType,
                        action
                    });
                    return;
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿contextæ˜¯æœ‰æ•ˆå¯¹è±¡
                const validContext = context && typeof context === 'object' ? context : {};

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç”Ÿæˆæ›´ç®€å•å¯é çš„ID
                const timestamp = Date.now();
                const randomSuffix = Math.random().toString(36).substring(2, 8);
                const eventId = `${characterId}_${appType}_${action}_${timestamp}_${randomSuffix}`;

                const timelineEvent = {
                    id: eventId,
                    characterId: String(characterId), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                    appType: String(appType),
                    action: String(action),
                    timestamp: timestamp,
                    context: validContext,
                    messageId: messageId ? String(messageId) : null
                };

                // ğŸ”¥ã€ä¿®å¤ã€‘éªŒè¯æ‰€æœ‰å¿…éœ€å­—æ®µ
                if (!timelineEvent.id || !timelineEvent.characterId || !timelineEvent.appType || !timelineEvent.action) {
                    console.error('âŒ è®°å½•äº‹ä»¶å¤±è´¥: å¿…éœ€å­—æ®µç¼ºå¤±', timelineEvent);
                    return;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘éªŒè¯æ•°æ®åº“è¿æ¥
                if (!db || !db.crossAppTimeline) {
                    console.error('âŒ è®°å½•äº‹ä»¶å¤±è´¥: æ•°æ®åº“æœªåˆå§‹åŒ–');
                    return;
                }

                await db.crossAppTimeline.add(timelineEvent);
                console.log(`ğŸ“ è®°å½•æ—¶é—´çº¿äº‹ä»¶: ${appType}.${action}`, {
                    characterId: timelineEvent.characterId,
                    contextId: validContext.id,
                    contextType: validContext.type,
                    groupId: validContext.groupId || 'æ— ',
                    content: validContext.content?.substring(0, 30) + '...'
                });

            } catch (error) {
                console.error('âŒ è®°å½•äº‹ä»¶å¤±è´¥:', error);
                console.error('äº‹ä»¶æ•°æ®:', {characterId, appType, action, context, messageId});

                // ğŸ”¥ã€æ–°å¢ã€‘è¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (error.name === 'DataError') {
                    console.error('æ•°æ®åº“é”®å€¼é”™è¯¯ï¼Œå¯èƒ½æ˜¯IDå­—æ®µé—®é¢˜');
                } else if (error.name === 'ConstraintError') {
                    console.error('æ•°æ®åº“çº¦æŸé”™è¯¯ï¼Œå¯èƒ½æ˜¯é‡å¤é”®å€¼');
                }
            }
        }

        // è·å–è§’è‰²çš„è·¨åº”ç”¨æ—¶é—´çº¿ï¼ˆç”¨äºæ„å»ºè¿ç»­çš„å·¥ä½œè®°å¿†ï¼‰
        async function getCrossAppTimeline(characterId, limit = 30) {
            try {
                const timeline = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                return timeline
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, limit);
            } catch (error) {
                console.error('è·å–è·¨åº”ç”¨æ—¶é—´çº¿å¤±è´¥:', error);
                return [];
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æŒ‰å›åˆè®¡ç®—å†å²æ¶ˆæ¯
        function calculateMessagesByRounds(messages, maxRounds) {
            if (!messages || messages.length === 0) return [];

            // ä»åå¾€å‰åˆ†ææ¶ˆæ¯ï¼ŒæŒ‰å›åˆåˆ†ç»„
            const rounds = [];
            let currentRound = [];
            let lastSender = null;

            // ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹å¾€å‰åˆ†æ
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                const currentSender = msg.sender;

                // å¦‚æœå‘é€è€…æ”¹å˜ï¼Œæˆ–è€…æ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œå¼€å§‹æ–°å›åˆ
                if (currentSender !== lastSender || currentSender === 'system') {
                    if (currentRound.length > 0) {
                        rounds.unshift(currentRound); // æ·»åŠ åˆ°å¼€å¤´
                        currentRound = [];
                    }
                }

                currentRound.unshift(msg); // æ·»åŠ åˆ°å½“å‰å›åˆçš„å¼€å¤´
                lastSender = currentSender;

                // å¦‚æœå·²ç»æ”¶é›†äº†è¶³å¤Ÿçš„å›åˆï¼Œåœæ­¢
                if (rounds.length >= maxRounds) {
                    break;
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªå›åˆ
            if (currentRound.length > 0 && rounds.length < maxRounds) {
                rounds.unshift(currentRound);
            }

            // åªä¿ç•™æŒ‡å®šæ•°é‡çš„å›åˆ
            const selectedRounds = rounds.slice(-maxRounds);

            // å°†å›åˆå±•å¹³ä¸ºæ¶ˆæ¯åˆ—è¡¨
            return selectedRounds.flat();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è®¡ç®—å®é™…å›åˆæ•°
        function countActualRounds(messages) {
            if (!messages || messages.length === 0) return 0;

            let rounds = 0;
            let lastSender = null;

            for (const msg of messages) {
                const currentSender = msg.sender;

                // å¦‚æœå‘é€è€…æ”¹å˜ï¼Œæˆ–è€…æ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œè®¡ä¸ºæ–°å›åˆ
                if (currentSender !== lastSender || currentSender === 'system') {
                    rounds++;
                }

                lastSender = currentSender;
            }

            return rounds;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æŸ¥çœ‹çº¿ä¸‹å‰§æƒ…æ€»ç»“çš„å®Œæ•´å†…å®¹
        async function viewStorylineSummary(memoryId) {
            try {
                const memory = await db.crossAppTimeline.get(memoryId);
                if (!memory || memory.action !== 'storyline_summary') {
                    showToast('æ‰¾ä¸åˆ°è¯¥å‰§æƒ…æ€»ç»“', 'error');
                    return;
                }

                // ä½¿ç”¨å®Œæ•´å†…å®¹è€Œä¸æ˜¯é¢„è§ˆå†…å®¹
                const content = memory.context?.content || memory.fullContent || 'æ— å†…å®¹';
                const date = memory.context?.date || 'æœªçŸ¥æ—¥æœŸ';
                const messageCount = memory.context?.messageCount || 0;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>çº¿ä¸‹å‰§æƒ…æ€»ç»“</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                <div>æ—¥æœŸ: ${date}</div>
                                <div>æ¶ˆæ¯æ•°: ${messageCount}æ¡</div>
                            </div>
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">${content}</div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="editStorylineSummary('${memoryId}'); this.closest('.modal-overlay').remove();">ç¼–è¾‘</button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">å…³é—­</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('æŸ¥çœ‹å‰§æƒ…æ€»ç»“å¤±è´¥:', error);
                showToast('æŸ¥çœ‹å‰§æƒ…æ€»ç»“å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç¼–è¾‘çº¿ä¸‹å‰§æƒ…æ€»ç»“
        async function editStorylineSummary(memoryId) {
            try {
                const memory = await db.crossAppTimeline.get(memoryId);
                if (!memory || memory.action !== 'storyline_summary') {
                    showToast('æ‰¾ä¸åˆ°è¯¥å‰§æƒ…æ€»ç»“', 'error');
                    return;
                }

                // ä½¿ç”¨å®Œæ•´å†…å®¹è€Œä¸æ˜¯é¢„è§ˆå†…å®¹
                const content = memory.context?.content || memory.fullContent || '';
                const date = memory.context?.date || 'æœªçŸ¥æ—¥æœŸ';
                const messageCount = memory.context?.messageCount || 0;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3>ç¼–è¾‘çº¿ä¸‹å‰§æƒ…æ€»ç»“</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                <div>æ—¥æœŸ: ${date}</div>
                                <div>æ¶ˆæ¯æ•°: ${messageCount}æ¡</div>
                                <div style="color: #999; font-size: 12px; margin-top: 5px;">æç¤º: ä¿®æ”¹åçš„å†…å®¹å°†åŒæ­¥åˆ°AIçš„å·¥ä½œè®°å¿†ä¸­</div>
                            </div>
                            <textarea id="storyline-summary-editor" style="width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical;" placeholder="è¯·è¾“å…¥å‰§æƒ…æ€»ç»“...">${content}</textarea>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="saveStorylineSummary('${memoryId}')">ä¿å­˜ä¿®æ”¹</button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // èšç„¦åˆ°æ–‡æœ¬æ¡†ä½†ä¸é€‰ä¸­å†…å®¹
                setTimeout(() => {
                    const textarea = document.getElementById('storyline-summary-editor');
                    if (textarea) {
                        textarea.focus();
                        // ğŸ”¥ã€ä¿®å¤ã€‘å°†å…‰æ ‡ç§»åˆ°æœ«å°¾ï¼Œä¸é€‰ä¸­ä»»ä½•å†…å®¹
                        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                    }
                }, 100);
            } catch (error) {
                console.error('ç¼–è¾‘å‰§æƒ…æ€»ç»“å¤±è´¥:', error);
                showToast('ç¼–è¾‘å‰§æƒ…æ€»ç»“å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜ç¼–è¾‘åçš„çº¿ä¸‹å‰§æƒ…æ€»ç»“
        async function saveStorylineSummary(memoryId) {
            try {
                const textarea = document.getElementById('storyline-summary-editor');
                if (!textarea) {
                    showToast('æ‰¾ä¸åˆ°ç¼–è¾‘å™¨', 'error');
                    return;
                }

                const newContent = textarea.value.trim();
                if (!newContent) {
                    showToast('å‰§æƒ…æ€»ç»“ä¸èƒ½ä¸ºç©º', 'warning');
                    return;
                }

                // æ›´æ–°æ•°æ®åº“ä¸­çš„è®°å¿†
                const memory = await db.crossAppTimeline.get(memoryId);
                if (!memory) {
                    showToast('æ‰¾ä¸åˆ°è¯¥å‰§æƒ…æ€»ç»“', 'error');
                    return;
                }

                // æ›´æ–°å†…å®¹
                memory.context.content = newContent;
                memory.timestamp = Date.now(); // æ›´æ–°æ—¶é—´æˆ³ï¼Œè®©å®ƒåœ¨å·¥ä½œè®°å¿†ä¸­æ›´æ–°

                await db.crossAppTimeline.put(memory);

                // å…³é—­æ¨¡æ€æ¡†
                const modal = textarea.closest('.modal-overlay');
                if (modal) {
                    modal.remove();
                }

                // åˆ·æ–°è®°å¿†æŸ¥çœ‹å™¨
                if (currentMemoryCharacter) {
                    await loadCharacterMemories();
                }

                showToast('å‰§æƒ…æ€»ç»“å·²ä¿å­˜ï¼ŒAIå·¥ä½œè®°å¿†å·²åŒæ­¥æ›´æ–°', 'success');
                console.log('âœ… çº¿ä¸‹å‰§æƒ…æ€»ç»“å·²æ›´æ–°:', memory);
            } catch (error) {
                console.error('ä¿å­˜å‰§æƒ…æ€»ç»“å¤±è´¥:', error);
                showToast('ä¿å­˜å‰§æƒ…æ€»ç»“å¤±è´¥', 'error');
            }
        }

        // æ„å»ºè¿ç»­çš„å·¥ä½œè®°å¿†ï¼ˆåŒ…å«è·¨åº”ç”¨äº‹ä»¶ï¼ŒæŒ‰æ—¶é—´æ»šåŠ¨ï¼‰
        async function buildContinuousWorkingMemory(characterId, chatMessages, userSetLimit = 50) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨å®‰å…¨å‡½æ•°ç¡®ä¿characterIdæ˜¯å­—ç¬¦ä¸²ç±»å‹
                characterId = safeCharacterId(characterId);

                // ğŸ”¥ã€å®‰å…¨æ£€æŸ¥ã€‘ç¡®ä¿chatMessagesæ˜¯æ•°ç»„
                if (!Array.isArray(chatMessages)) {
                    console.warn('buildContinuousWorkingMemory: chatMessagesä¸æ˜¯æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                    chatMessages = [];
                }

                // è·å–èŠå¤©æ¶ˆæ¯
                const messages = chatMessages.map(msg => ({
                    type: 'chat',
                    timestamp: msg.timestamp,
                    content: msg,
                    appType: 'chat',
                    characterId: String(characterId) // ç¡®ä¿è§’è‰²éš”ç¦»ä¸”æ˜¯å­—ç¬¦ä¸²
                }));

                // è·å–è¯¥è§’è‰²çš„è·¨åº”ç”¨æ—¶é—´çº¿ï¼ˆåªè·å–ä¸è¯¥è§’è‰²ç›¸å…³çš„ï¼‰
                let timeline = [];
                try {
                    timeline = await db.crossAppTimeline
                        .where('characterId')
                        .equals(String(characterId)) // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                        .toArray();
                } catch (error) {
                    console.error(`âŒ æŸ¥è¯¢è·¨åº”ç”¨æ—¶é—´çº¿å¤±è´¥ - characterId: ${characterId}:`, error);
                    timeline = [];
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®åŒºåˆ†èŠå¤©äº‹ä»¶å’Œè·¨åº”ç”¨äº‹ä»¶
                const timelineEvents = timeline
                    .filter(event => event.appType !== 'chat') // æ’é™¤èŠå¤©äº‹ä»¶ï¼Œé¿å…é‡å¤
                    .map(event => ({
                        type: 'cross_app',
                        timestamp: event.timestamp,
                        content: event,
                        appType: event.appType,
                        characterId: characterId
                    }));

                // åˆå¹¶æ‰€æœ‰äº‹ä»¶å¹¶æŒ‰æ—¶é—´æ’åº
                const allEvents = [...messages, ...timelineEvents]
                    .sort((a, b) => a.timestamp - b.timestamp);

                // ğŸ”¥ã€ä¿®å¤ã€‘æŒ‰å›åˆæ•°è€Œä¸æ˜¯æ¶ˆæ¯æ¡æ•°æ¥é™åˆ¶å·¥ä½œè®°å¿†
                // å…ˆæå–èŠå¤©æ¶ˆæ¯ï¼ŒæŒ‰å›åˆè®¡ç®—
                const chatEvents = allEvents.filter(event => event.type === 'chat');
                const extractedChatMessages = chatEvents.map(event => event.content);

                // æŒ‰å›åˆè®¡ç®—èŠå¤©æ¶ˆæ¯
                const recentChatMessages = calculateMessagesByRounds(extractedChatMessages, userSetLimit);

                // é‡æ–°åŒ…è£…ä¸ºäº‹ä»¶æ ¼å¼
                const recentChatEvents = recentChatMessages.map(msg => ({
                    type: 'chat',
                    timestamp: msg.timestamp,
                    content: msg,
                    appType: 'chat',
                    characterId: characterId
                }));

                // è·¨åº”ç”¨äº‹ä»¶æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆä¸èŠå¤©æ¶ˆæ¯çš„æ—¶é—´èŒƒå›´ä¸€è‡´ï¼‰
                const earliestChatTime = recentChatEvents.length > 0 ? recentChatEvents[0].timestamp : 0;
                const recentTimelineEvents = timelineEvents.filter(event => event.timestamp >= earliestChatTime);

                // åˆå¹¶å¹¶é‡æ–°æ’åº
                const recentEvents = [...recentChatEvents, ...recentTimelineEvents]
                    .sort((a, b) => a.timestamp - b.timestamp);

                return recentEvents;
            } catch (error) {
                console.error('æ„å»ºè¿ç»­å·¥ä½œè®°å¿†å¤±è´¥:', error);
                return chatMessages.map(msg => ({
                    type: 'chat',
                    timestamp: msg.timestamp,
                    content: msg,
                    appType: 'chat',
                    characterId: characterId
                }));
            }
        }

        // ä¸ºè§’è‰²ç”Ÿæˆè·¨åº”ç”¨è®°å¿†æè¿°
        async function generateCrossAppMemoryDescription(characterId, memoryEvent) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                let memoryDescription = '';
                const context = memoryEvent.context;

                switch (memoryEvent.eventType) {
                    case 'music_interaction':
                        if (context.action === 'listen_together') {
                            memoryDescription = `å’Œç”¨æˆ·ä¸€èµ·å¬äº†ã€Š${context.songTitle}ã€‹ï¼Œ${context.duration || ''}`;
                        } else if (context.action === 'song_comment') {
                            memoryDescription = `å¯¹æ­Œæ›²ã€Š${context.songTitle}ã€‹å‘è¡¨äº†çœ‹æ³•ï¼š${context.comment}`;
                        }
                        break;

                    case 'game_interaction':
                        if (context.action === 'play_together') {
                            memoryDescription = `å’Œç”¨æˆ·ä¸€èµ·ç©äº†${context.gameName}ï¼Œ${context.result || ''}`;
                        } else if (context.action === 'game_comment') {
                            memoryDescription = `å¯¹æ¸¸æˆ${context.gameName}å‘è¡¨äº†çœ‹æ³•ï¼š${context.comment}`;
                        }
                        break;

                    case 'forum_interaction':
                        if (context.action === 'post_comment') {
                            memoryDescription = `åœ¨è®ºå›å‘è¡¨äº†è¯„è®ºï¼š${context.comment}`;
                        } else if (context.action === 'topic_discussion') {
                            memoryDescription = `å‚ä¸äº†å…³äº"${context.topic}"çš„è®¨è®º`;
                        }
                        break;
                }

                if (memoryDescription) {
                    // å°†è·¨åº”ç”¨è®°å¿†ä½œä¸ºæ ¸å¿ƒè®°å¿†ä¿å­˜
                    const coreMemory = {
                        id: `cross_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        characterId: characterId,
                        fact: memoryDescription,
                        importance: 0.6, // è·¨åº”ç”¨è®°å¿†çš„é»˜è®¤é‡è¦æ€§
                        category: 'cross_app',
                        timestamp: Date.now(),
                        sourceEvent: memoryEvent.id
                    };

                    await db.coreMemories.add(coreMemory);
                    console.log(`âœ… ä¸ºè§’è‰² ${character.name} æ·»åŠ è·¨åº”ç”¨è®°å¿†: ${memoryDescription}`);
                }

            } catch (error) {
                console.error('ç”Ÿæˆè·¨åº”ç”¨è®°å¿†æè¿°å¤±è´¥:', error);
            }
        }

        // è·å–è§’è‰²çš„è·¨åº”ç”¨è®°å¿†
        async function getCrossAppMemories(characterId, limit = 5) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const crossAppMemories = allMemories
                    .filter(memory => memory.category === 'cross_app')
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, limit);

                return crossAppMemories.map(m => m.fact);
            } catch (error) {
                console.error('è·å–è·¨åº”ç”¨è®°å¿†å¤±è´¥:', error);
                return [];
            }
        }

        // æ¸…ç†é‡å¤è®°å¿†çš„åŠŸèƒ½
        async function cleanupDuplicateMemories(characterId) {
            try {
                const memories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const duplicates = [];

                for (let i = 0; i < memories.length; i++) {
                    for (let j = i + 1; j < memories.length; j++) {
                        const similarity = calculateTextSimilarity(memories[i].fact, memories[j].fact);
                        if (similarity > 0.8) {
                            // ä¿ç•™é‡è¦æ€§æ›´é«˜çš„ï¼Œåˆ é™¤é‡è¦æ€§è¾ƒä½çš„
                            const toDelete = memories[i].importance >= memories[j].importance ? memories[j] : memories[i];
                            if (!duplicates.find(d => d.id === toDelete.id)) {
                                duplicates.push(toDelete);
                            }
                        }
                    }
                }

                for (const duplicate of duplicates) {
                    await db.coreMemories.delete(duplicate.id);
                    console.log(`ğŸ§¹ åˆ é™¤é‡å¤è®°å¿†: ${duplicate.fact}`);
                }

                if (duplicates.length > 0) {
                    console.log(`âœ… æ¸…ç†äº† ${duplicates.length} æ¡é‡å¤è®°å¿†`);
                }
            } catch (error) {
                console.error('æ¸…ç†é‡å¤è®°å¿†å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†é”™è¯¯çš„è·¨åº”ç”¨æ—¶é—´çº¿è®°å½•
        async function cleanupIncorrectTimelineRecords() {
            try {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†é”™è¯¯çš„è·¨åº”ç”¨æ—¶é—´çº¿è®°å½•...');

                // åˆ é™¤æ‰€æœ‰ appType ä¸º 'chat' çš„è®°å½•ï¼ˆè¿™äº›åº”è¯¥åªå­˜åœ¨äºèŠå¤©è®°å½•ä¸­ï¼‰
                const chatRecords = await db.crossAppTimeline
                    .where('appType')
                    .equals('chat')
                    .toArray();

                for (const record of chatRecords) {
                    await db.crossAppTimeline.delete(record.id);
                }

                console.log(`âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${chatRecords.length} æ¡é”™è¯¯çš„èŠå¤©è®°å½•`);
                return chatRecords.length;

            } catch (error) {
                console.error('æ¸…ç†é”™è¯¯è®°å½•å¤±è´¥:', error);
                return 0;
            }
        }

        // ğŸ”ã€æ–°å¢ã€‘è®°å¿†ä½¿ç”¨æƒ…å†µç»Ÿè®¡å‡½æ•°
        async function logMemoryUsageStats(character, scenario) {
            try {
                const characterId = character.isGroup ? 'group' : character.id;
                const memorySettings = getGlobalMemorySettings();

                console.log(`\nğŸ“Š ===== è®°å¿†ä½¿ç”¨ç»Ÿè®¡ (${scenario}) =====`);
                console.log(`ğŸ­ è§’è‰²: ${character.name} (${character.isGroup ? 'ç¾¤èŠ' : 'å•èŠ'})`);
                console.log(`â° è®°å¿†å¤©æ•°è®¾ç½®: ${memorySettings.memoryDays}å¤©`);

                if (character.isGroup) {
                    // ç¾¤èŠï¼šç»Ÿè®¡æ¯ä¸ªæˆå‘˜çš„è®°å¿†
                    for (const member of character.members) {
                        await logSingleCharacterMemoryStats(member.id, member.name, memorySettings.memoryDays);
                    }
                } else {
                    // å•èŠï¼šç»Ÿè®¡å•ä¸ªè§’è‰²çš„è®°å¿†
                    await logSingleCharacterMemoryStats(character.id, character.name, memorySettings.memoryDays);
                }

                console.log(`ğŸ“Š ===== è®°å¿†ç»Ÿè®¡ç»“æŸ =====\n`);

            } catch (error) {
                console.error('è®°å¿†ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // ğŸ”ã€æ–°å¢ã€‘å•ä¸ªè§’è‰²çš„è®°å¿†ç»Ÿè®¡
        async function logSingleCharacterMemoryStats(characterId, characterName, memoryDays) {
            try {
                // 1. æ ¸å¿ƒè®°å¿†ç»Ÿè®¡
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();
                const limitedCoreMemories = coreMemories.slice(0, 10);

                // 2. æƒ…æ™¯è®°å¿†ç»Ÿè®¡
                const cutoffTimestamp = Date.now() - (memoryDays * 24 * 60 * 60 * 1000);
                const episodicMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(characterId)
                    .and(memory => memory.timestamp >= cutoffTimestamp)
                    .toArray();
                const limitedEpisodicMemories = episodicMemories.slice(0, 15);

                // 3. æ—¶é—´çº¿è®°å¿†ç»Ÿè®¡
                const timelineMemories = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => event.timestamp >= cutoffTimestamp)
                    .toArray();
                const limitedTimelineMemories = timelineMemories.slice(0, 20);

                // 4. å¯¹è¯æ‘˜è¦ç»Ÿè®¡
                const cutoffDateStr = new Date(cutoffTimestamp).toISOString().split('T')[0];
                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .and(summary => summary.date >= cutoffDateStr)
                    .toArray();
                const limitedMemorySummaries = memorySummaries.slice(0, 10);

                // 5. è®¡ç®—æ€»tokenä¼°ç®—ï¼ˆæŒ‰æ¯ä¸ªä¸­æ–‡å­—ç¬¦1.5tokenè®¡ç®—ï¼‰
                const coreMemoryTokens = limitedCoreMemories.reduce((sum, m) => sum + (m.fact?.length || 0), 0) * 1.5;
                const episodicMemoryTokens = limitedEpisodicMemories.reduce((sum, m) => sum + (m.fact?.length || 0), 0) * 1.5;
                const timelineMemoryTokens = limitedTimelineMemories.reduce((sum, m) => sum + (m.context?.content?.length || 0), 0) * 1.5;
                const summaryMemoryTokens = limitedMemorySummaries.reduce((sum, m) => sum + (m.summary?.length || 0), 0) * 1.5;
                const totalMemoryTokens = coreMemoryTokens + episodicMemoryTokens + timelineMemoryTokens + summaryMemoryTokens;

                console.log(`\nğŸ‘¤ ${characterName} (ID: ${characterId}):`);
                console.log(`  ğŸ”´ æ ¸å¿ƒè®°å¿†: ${limitedCoreMemories.length}æ¡ (æ€»åº“å­˜: ${coreMemories.length}æ¡) ~${Math.round(coreMemoryTokens)}tokens`);
                console.log(`  ğŸŸ  æƒ…æ™¯è®°å¿†: ${limitedEpisodicMemories.length}æ¡ (æ€»åº“å­˜: ${episodicMemories.length}æ¡) ~${Math.round(episodicMemoryTokens)}tokens`);
                console.log(`  ğŸŸ£ æ—¶é—´çº¿è®°å¿†: ${limitedTimelineMemories.length}æ¡ (æ€»åº“å­˜: ${timelineMemories.length}æ¡) ~${Math.round(timelineMemoryTokens)}tokens`);
                console.log(`  ğŸ”µ å¯¹è¯æ‘˜è¦: ${limitedMemorySummaries.length}æ¡ (æ€»åº“å­˜: ${memorySummaries.length}æ¡) ~${Math.round(summaryMemoryTokens)}tokens`);
                console.log(`  ğŸ’° è®°å¿†æ€»æ¶ˆè€—: ~${Math.round(totalMemoryTokens)}tokens`);

                // 6. æ£€æŸ¥æ˜¯å¦ç®—åœ¨å·¥ä½œè®°å¿†ä¸­
                // 7. æ£€æŸ¥è·¨åº”ç”¨å·¥ä½œè®°å¿†é›†æˆ
                const userHistoryLimit = getCurrentChatSettings().historyCount || 5;
                const crossAppInWorkingMemory = Math.floor(userHistoryLimit * 0.3);
                const chatInWorkingMemory = userHistoryLimit - crossAppInWorkingMemory;

                console.log(`  âš ï¸  æ³¨æ„: è¿™äº›è®°å¿†æ˜¯é¢å¤–æ·»åŠ çš„ï¼Œä¸å ç”¨ç”¨æˆ·è®¾ç½®çš„"é™„å¸¦å†å²æ¶ˆæ¯æ•°"é…é¢`);
                console.log(`  ğŸ“ å·¥ä½œè®°å¿†æ„æˆ:`);
                console.log(`    - èŠå¤©å†å²: ${chatInWorkingMemory}æ¡ (ç”¨æˆ·è®¾ç½®: ${userHistoryLimit}æ¡)`);
                console.log(`    - è·¨åº”ç”¨äº‹ä»¶: ${crossAppInWorkingMemory}æ¡ (è‡ªåŠ¨é›†æˆ)`);
                console.log(`    - æ€»å·¥ä½œè®°å¿†: ${userHistoryLimit}æ¡ (æŒ‰æ—¶é—´é¡ºåºæ»šåŠ¨)`);

            } catch (error) {
                console.error(`ç»Ÿè®¡è§’è‰² ${characterName} è®°å¿†å¤±è´¥:`, error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤ä¸æ¶ˆæ¯ç›¸å…³çš„æ—¶é—´çº¿è®°å½•
        async function deleteRelatedTimelineEvents(messageToDelete) {
            try {
                const characterId = currentChatCharacter.id;
                const messageContent = messageToDelete.content;
                const messageTimestamp = messageToDelete.timestamp;

                // æŸ¥æ‰¾ç›¸å…³çš„æ—¶é—´çº¿è®°å½•ï¼ˆåŸºäºå†…å®¹å’Œæ—¶é—´æˆ³åŒ¹é…ï¼‰
                const relatedEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => {
                        // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æ¥è¿‘ï¼ˆå…è®¸5åˆ†é’Ÿè¯¯å·®ï¼‰
                        const timeDiff = Math.abs(event.timestamp - messageTimestamp);
                        const isTimeMatch = timeDiff < 5 * 60 * 1000; // 5åˆ†é’Ÿ

                        // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ¹é…
                        const isContentMatch = event.context &&
                                             event.context.content &&
                                             typeof event.context.content === 'string' &&
                                             messageContent &&
                                             typeof messageContent === 'string' &&
                                             event.context.content.includes(messageContent.substring(0, 30));

                        return isTimeMatch && isContentMatch;
                    })
                    .toArray();

                // åˆ é™¤åŒ¹é…çš„æ—¶é—´çº¿è®°å½•
                for (const event of relatedEvents) {
                    await db.crossAppTimeline.delete(event.id);
                    const contentPreview = event.context?.content && typeof event.context.content === 'string'
                        ? event.context.content.substring(0, 50)
                        : 'æ— å†…å®¹';
                    console.log(`ğŸ—‘ï¸ åˆ é™¤ç›¸å…³æ—¶é—´çº¿è®°å½•: ${event.action} - ${contentPreview}...`);
                }

                console.log(`âœ… åˆ é™¤äº† ${relatedEvents.length} æ¡ç›¸å…³æ—¶é—´çº¿è®°å½•`);

            } catch (error) {
                console.error('åˆ é™¤ç›¸å…³æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åˆ é™¤ä¸çŸ­ä¿¡æ¶ˆæ¯ç›¸å…³çš„æ—¶é—´çº¿è®°å½•
        async function deleteSMSRelatedTimelineEvents(messageToDelete, characterId) {
            try {
                const messageContent = messageToDelete.content;
                const messageTimestamp = messageToDelete.timestamp;

                // æŸ¥æ‰¾ç›¸å…³çš„çŸ­ä¿¡æ—¶é—´çº¿è®°å½•ï¼ˆåŸºäºå†…å®¹ã€æ—¶é—´æˆ³å’ŒmessageIdåŒ¹é…ï¼‰
                const relatedEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯çŸ­ä¿¡ç›¸å…³çš„äº‹ä»¶
                        if (event.appType !== 'sms') return false;

                        // æ£€æŸ¥messageIdæ˜¯å¦åŒ¹é…
                        if (event.messageId === messageToDelete.id) return true;

                        // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æ¥è¿‘ï¼ˆå…è®¸5åˆ†é’Ÿè¯¯å·®ï¼‰
                        const timeDiff = Math.abs(event.timestamp - messageTimestamp);
                        const isTimeMatch = timeDiff < 5 * 60 * 1000; // 5åˆ†é’Ÿ

                        // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ¹é…
                        const isContentMatch = event.context &&
                                             event.context.content &&
                                             typeof event.context.content === 'string' &&
                                             messageContent &&
                                             typeof messageContent === 'string' &&
                                             event.context.content.includes(messageContent.substring(0, 30));

                        return isTimeMatch && isContentMatch;
                    })
                    .toArray();

                // åˆ é™¤åŒ¹é…çš„æ—¶é—´çº¿è®°å½•
                for (const event of relatedEvents) {
                    await db.crossAppTimeline.delete(event.id);
                    const contentPreview = event.context?.content && typeof event.context.content === 'string'
                        ? event.context.content.substring(0, 50)
                        : 'æ— å†…å®¹';
                    console.log(`ğŸ—‘ï¸ åˆ é™¤çŸ­ä¿¡ç›¸å…³æ—¶é—´çº¿è®°å½•: ${event.action} - ${contentPreview}...`);
                }

                console.log(`âœ… åˆ é™¤äº† ${relatedEvents.length} æ¡çŸ­ä¿¡ç›¸å…³æ—¶é—´çº¿è®°å½•`);

            } catch (error) {
                console.error('åˆ é™¤çŸ­ä¿¡ç›¸å…³æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†ä½è´¨é‡æ—§ç‰ˆæœ¬è®°å¿†çš„å‡½æ•°
        async function cleanupLowQualityMemories(characterId) {
            try {
                console.log(`ğŸ§¹ å¼€å§‹æ¸…ç†è§’è‰² ${characterId} çš„ä½è´¨é‡æ—§ç‰ˆæœ¬è®°å¿†...`);

                const currentThreshold = MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD;

                // æ¸…ç†é‡è¦æ€§ä½äºå½“å‰é˜ˆå€¼çš„æ ¸å¿ƒè®°å¿†
                const lowQualityCoreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .and(memory => (memory.importance || 0) < currentThreshold)
                    .toArray();

                for (const memory of lowQualityCoreMemories) {
                    await db.coreMemories.delete(memory.id);
                    console.log(`ğŸ—‘ï¸ åˆ é™¤ä½è´¨é‡æ ¸å¿ƒè®°å¿† (é‡è¦æ€§: ${memory.importance}): ${memory.fact}`);
                }

                console.log(`âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${lowQualityCoreMemories.length} æ¡ä½è´¨é‡æ ¸å¿ƒè®°å¿†`);
                return lowQualityCoreMemories.length;

            } catch (error) {
                console.error('æ¸…ç†ä½è´¨é‡è®°å¿†å¤±è´¥:', error);
                return 0;
            }
        }

        // è®°å¿†æŸ¥çœ‹å™¨åŠŸèƒ½
        let currentMemoryFilter = 'all';
        let currentMemoryCharacter = null;
        let allMemories = [];

        // åˆå§‹åŒ–è®°å¿†æŸ¥çœ‹å™¨
        async function initMemoryViewer() {
            await loadCharacterSelectOptions();
        }

        // åŠ è½½è§’è‰²é€‰æ‹©é€‰é¡¹
        async function loadCharacterSelectOptions() {
            const select = document.getElementById('memory-character-select');
            if (!select) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²</option>';

            // æ·»åŠ è§’è‰²é€‰é¡¹
            characters.forEach(character => {
                const option = document.createElement('option');
                option.value = character.id;
                option.textContent = character.name;
                select.appendChild(option);
            });
        }

        // åŠ è½½è§’è‰²è®°å¿†
        async function loadCharacterMemories() {
            const select = document.getElementById('memory-character-select');
            const characterId = select.value;

            if (!characterId) {
                currentMemoryCharacter = null;
                allMemories = [];
                renderMemoryList();
                return;
            }

            currentMemoryCharacter = characterId;

            try {
                // è·å–æ‰€æœ‰ç±»å‹çš„è®°å¿†
                const [coreMemories, episodicMemories, timeline] = await Promise.all([
                    db.coreMemories.where('characterId').equals(characterId).toArray(),
                    db.episodicMemories.where('characterId').equals(characterId).toArray(),
                    db.crossAppTimeline.where('characterId').equals(characterId).toArray()
                ]);

                // ğŸ”¥ã€è°ƒè¯•ã€‘è¾“å‡ºæ—¶é—´çº¿è®°å½•ä¿¡æ¯
                console.log(`ğŸ“Š è§’è‰² ${characterId} çš„æ—¶é—´çº¿è®°å½•:`, timeline.length, 'æ¡');
                timeline.forEach((event, index) => {
                    if (index < 5) { // åªæ˜¾ç¤ºå‰5æ¡
                        console.log(`  ${index + 1}. ${event.appType}.${event.action} - contextId: ${event.context?.id}, type: ${event.context?.type}, groupId: ${event.context?.groupId || 'æ— '}`);
                    }
                });

                // ğŸ”¥ã€æ–°å¢ã€‘è·å–çº¿ä¸‹å‰§æƒ…æ€»ç»“
                const storylineSummaries = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(item => item.action === 'storyline_summary' && item.appType === 'offline_mode')
                    .toArray();

                console.log(`ğŸ“– çº¿ä¸‹å‰§æƒ…æ€»ç»“: ${storylineSummaries.length}æ¡`);

                // åˆå¹¶æ‰€æœ‰è®°å¿†å¹¶æ·»åŠ ç±»å‹æ ‡è¯†
                allMemories = [
                    ...coreMemories.filter(m => m.type === 'core').map(m => ({...m, memoryType: 'core'})),
                    ...episodicMemories.map(m => ({...m, memoryType: 'episodic'})),
                    ...timeline.map(m => ({
                        ...m,
                        memoryType: 'timeline',
                        fact: formatTimelineEvent(m)
                    })),
                    // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ çº¿ä¸‹å‰§æƒ…æ€»ç»“
                    ...storylineSummaries.map(m => {
                        const fullContent = m.context?.content || 'çº¿ä¸‹å‰§æƒ…æ€»ç»“';
                        // åªæ˜¾ç¤ºå‰ä¸‰è¡Œä½œä¸ºé¢„è§ˆ
                        const lines = fullContent.split('\n');
                        const preview = lines.slice(0, 3).join('\n') + (lines.length > 3 ? '\n...' : '');

                        return {
                            ...m,
                            memoryType: 'storyline',
                            fact: preview,
                            summary: preview,
                            fullContent: fullContent // ä¿å­˜å®Œæ•´å†…å®¹ç”¨äºç¼–è¾‘
                        };
                    })
                ];

                // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                allMemories.sort((a, b) => b.timestamp - a.timestamp);

                renderMemoryList();
            } catch (error) {
                console.error('åŠ è½½è§’è‰²è®°å¿†å¤±è´¥:', error);
                showToast('åŠ è½½è®°å¿†å¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢è®°å¿†è¿‡æ»¤å™¨
        function switchMemoryFilter(type) {
            currentMemoryFilter = type;

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.memory-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            renderMemoryList();
        }

        // è¿‡æ»¤è®°å¿†
        function filterMemories() {
            renderMemoryList();
        }

        // æ¸²æŸ“è®°å¿†åˆ—è¡¨
        function renderMemoryList() {
            const container = document.getElementById('memory-list');
            if (!container) return;

            if (!currentMemoryCharacter || allMemories.length === 0) {
                container.innerHTML = `
                    <div class="memory-empty-state">
                        <i class="fas fa-brain"></i>
                        <p>${currentMemoryCharacter ? 'è¯¥è§’è‰²æš‚æ— è®°å¿†æ•°æ®' : 'è¯·é€‰æ‹©è§’è‰²æŸ¥çœ‹è®°å¿†'}</p>
                    </div>
                `;
                return;
            }

            // è·å–æœç´¢å…³é”®è¯
            const searchTerm = document.getElementById('memory-search-input').value.toLowerCase();

            // è¿‡æ»¤è®°å¿†
            let filteredMemories = allMemories;

            // æŒ‰ç±»å‹è¿‡æ»¤
            if (currentMemoryFilter !== 'all') {
                filteredMemories = filteredMemories.filter(memory => memory.memoryType === currentMemoryFilter);
            }

            // æŒ‰æœç´¢è¯è¿‡æ»¤
            if (searchTerm) {
                filteredMemories = filteredMemories.filter(memory => {
                    const content = memory.fact || memory.summary || '';
                    return content.toLowerCase().includes(searchTerm);
                });
            }

            if (filteredMemories.length === 0) {
                container.innerHTML = `
                    <div class="memory-empty-state">
                        <i class="fas fa-search"></i>
                        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å¿†</p>
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“è®°å¿†é¡¹
            const html = filteredMemories.map(memory => renderMemoryItem(memory)).join('');
            container.innerHTML = html;
        }

        // æ¸²æŸ“å•ä¸ªè®°å¿†é¡¹
        function renderMemoryItem(memory) {
            const dateObj = new Date(memory.timestamp || Date.now());
            const date = isNaN(dateObj.getTime()) ? 'æœªçŸ¥æ—¥æœŸ' : dateObj.toLocaleDateString('zh-CN');
            const content = memory.fact || memory.summary || '';
            const importance = memory.importance || 0;
            const stars = 'â˜…'.repeat(Math.round(importance * 5));

            const typeLabels = {
                'core': 'æ ¸å¿ƒè®°å¿†',
                'episodic': 'æƒ…æ™¯è®°å¿†',
                'storyline': 'å‰§æƒ…æ€»ç»“',
                'timeline': 'æ—¶é—´çº¿'
            };

            return `
                <div class="memory-item" data-memory-id="${memory.id}">
                    <div class="memory-item-header">
                        <span class="memory-item-type ${memory.memoryType}">
                            <i class="fas fa-${getMemoryTypeIcon(memory.memoryType)}"></i>
                            ${typeLabels[memory.memoryType]}
                        </span>
                        <span class="memory-item-date">${date}</span>
                    </div>
                    <div class="memory-item-content">${content}</div>
                    ${memory.memoryType === 'core' || memory.memoryType === 'episodic' ? `
                        <div class="memory-item-importance">
                            <span>é‡è¦æ€§:</span>
                            <span class="importance-stars">${stars}</span>
                            <span>(${(importance * 100).toFixed(0)}%)</span>
                        </div>
                    ` : ''}
                    <div class="memory-item-actions">
                        ${memory.memoryType === 'storyline' ? `
                            <button class="memory-action-btn view-btn" onclick="viewStorylineSummary('${memory.id}')" title="æŸ¥çœ‹å®Œæ•´å†…å®¹">
                                <i class="fas fa-eye"></i> æŸ¥çœ‹
                            </button>
                            <button class="memory-action-btn edit-btn" onclick="editStorylineSummary('${memory.id}')" title="ç¼–è¾‘å‰§æƒ…æ€»ç»“">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                        ` : `
                            <button class="memory-action-btn" onclick="editMemory('${memory.id}', '${memory.memoryType}')">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                        `}
                        <button class="memory-action-btn delete" onclick="deleteMemory('${memory.id}', '${memory.memoryType}')">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
        }

        // è·å–è®°å¿†ç±»å‹å›¾æ ‡
        function getMemoryTypeIcon(type) {
            const icons = {
                'core': 'star',
                'episodic': 'calendar-day',
                'storyline': 'book',
                'timeline': 'clock'
            };
            return icons[type] || 'circle';
        }

        // ğŸ”¥ã€é‡æ–°è®¾è®¡ã€‘æ ¼å¼åŒ–æ—¶é—´çº¿äº‹ä»¶æ˜¾ç¤º - ç®€åŒ–ç‰ˆæœ¬ï¼Œé¿å…æ˜¾ç¤ºä¸å®Œæ•´å†…å®¹
        function formatTimelineEvent(event) {
            const appNames = {
                'chat': 'èŠå¤©',
                'music': 'éŸ³ä¹',
                'moments': 'åŠ¨æ€',
                'diary': 'æ—¥è®°'
            };

            const appName = appNames[event.appType] || event.appType;
            let description = '';

            try {
                const context = typeof event.context === 'string' ? JSON.parse(event.context) : event.context;

                switch (event.appType) {
                    case 'chat':
                        const chatType = context?.type === 'group_chat' ? 'ç¾¤èŠ' : 'å•èŠ';
                        const groupName = context?.groupName ? `(${context.groupName})` : '';

                        if (event.action === 'ai_reply') {
                            description = `åœ¨${chatType}${groupName}ä¸­å›å¤äº†æ¶ˆæ¯`;
                        } else if (event.action === 'user_message') {
                            description = `åœ¨${chatType}${groupName}ä¸­æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯`;
                        } else {
                            description = `åœ¨${chatType}${groupName}ä¸­è¿›è¡Œäº†èŠå¤©äº’åŠ¨`;
                        }
                        break;
                    case 'music':
                        if (context.action === 'listen_together') {
                            description = `ä¸ç”¨æˆ·ä¸€èµ·å¬æ­Œï¼š${context.songTitle || context.song || ''}`;
                        } else if (context.action === 'song_comment') {
                            description = `å¯¹éŸ³ä¹å‘è¡¨äº†è¯„è®º`;
                        } else {
                            description = `è¿›è¡Œäº†éŸ³ä¹äº’åŠ¨`;
                        }
                        break;
                    case 'moments':
                        if (event.action === 'ai_to_ai_reply') {
                            description = `åœ¨åŠ¨æ€ä¸­å›å¤äº†å…¶ä»–è§’è‰²`;
                        } else if (event.action === 'reply_to_user') {
                            description = `åœ¨åŠ¨æ€ä¸­å›å¤äº†ç”¨æˆ·`;
                        } else {
                            description = `è¿›è¡Œäº†åŠ¨æ€äº’åŠ¨`;
                        }
                        break;
                    case 'diary':
                        description = `å†™äº†æ—¥è®°`;
                        break;
                    default:
                        description = `è¿›è¡Œäº†${event.action || 'æœªçŸ¥'}æ´»åŠ¨`;
                }
            } catch (e) {
                description = `è¿›è¡Œäº†${event.action || 'æœªçŸ¥'}æ´»åŠ¨`;
            }

            return `ã€${appName}ã€‘${description}`;
        }

        // åˆ·æ–°è®°å¿†æ•°æ®
        async function refreshMemoryData() {
            if (currentMemoryCharacter) {
                await loadCharacterMemories();
                showToast('è®°å¿†æ•°æ®å·²åˆ·æ–°', 'success');
            }
        }



        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†é”™è¯¯çš„è®°å½•
        async function cleanupIncorrectRecords() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†é”™è¯¯çš„è®°å½•å—ï¼Ÿè¿™å°†åˆ é™¤è·¨åº”ç”¨æ—¶é—´çº¿ä¸­é”™è¯¯çš„èŠå¤©è®°å½•ã€‚')) {
                return;
            }

            try {
                const deletedCount = await cleanupIncorrectTimelineRecords();
                await loadCharacterMemories();
                showToast(`é”™è¯¯è®°å½•æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº†${deletedCount}æ¡é”™è¯¯è®°å½•`, 'success');
            } catch (error) {
                console.error('æ¸…ç†é”™è¯¯è®°å½•å¤±è´¥:', error);
                showToast('æ¸…ç†å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æµ‹è¯•è·¨åº”ç”¨è®°å¿†å…±äº«åŠŸèƒ½
        async function testCrossAppMemorySharing(characterId) {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è·¨åº”ç”¨è®°å¿†å…±äº«åŠŸèƒ½...');

            try {
                // 1. æ¨¡æ‹ŸçŸ­ä¿¡äº‹ä»¶è®°å½•
                console.log('ğŸ“± æ¨¡æ‹Ÿè®°å½•çŸ­ä¿¡äº‹ä»¶...');
                await recordCrossAppEvent(
                    characterId,
                    'sms',
                    'user_message',
                    {
                        id: characterId,
                        type: 'sms_message',
                        content: 'æµ‹è¯•çŸ­ä¿¡å†…å®¹ï¼šæˆ‘åˆšåˆšåƒäº†å†°æ·‡æ·‹',
                        chatId: characterId,
                        sender: 'user'
                    },
                    `test_sms_${Date.now()}`
                );

                // 2. ç­‰å¾…ä¸€ç§’åæŸ¥è¯¢æ—¶é—´çº¿
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 3. æµ‹è¯•chatappæ˜¯å¦èƒ½è¯»å–åˆ°çŸ­ä¿¡äº‹ä»¶
                console.log('ğŸ’¬ æµ‹è¯•chatappè¯»å–æ—¶é—´çº¿è®°å¿†...');
                const timeline = await getCrossAppTimeline(characterId, 10);
                console.log('ğŸ“Š è·å–åˆ°çš„æ—¶é—´çº¿è®°å½•æ•°é‡:', timeline.length);

                const smsEvents = timeline.filter(event => event.appType === 'sms');
                console.log('ğŸ“± çŸ­ä¿¡ç›¸å…³äº‹ä»¶æ•°é‡:', smsEvents.length);

                if (smsEvents.length > 0) {
                    console.log('âœ… æˆåŠŸï¼chatappå¯ä»¥è¯»å–åˆ°çŸ­ä¿¡äº‹ä»¶');
                    smsEvents.forEach((event, index) => {
                        console.log(`ğŸ“± çŸ­ä¿¡äº‹ä»¶ ${index + 1}:`, {
                            action: event.action,
                            content: event.context?.content?.substring(0, 50),
                            timestamp: new Date(event.timestamp).toLocaleString()
                        });
                    });
                } else {
                    console.log('âŒ å¤±è´¥ï¼chatappæ— æ³•è¯»å–åˆ°çŸ­ä¿¡äº‹ä»¶');
                }

                // 4. æµ‹è¯•buildGlobalMemoryContextå‡½æ•°
                console.log('ğŸ§  æµ‹è¯•å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡æ„å»º...');
                const memoryContext = await buildGlobalMemoryContext(characterId, {
                    id: characterId,
                    type: 'private_chat'
                }, 7);

                if (memoryContext.includes('çŸ­ä¿¡') || memoryContext.includes('å†°æ·‡æ·‹')) {
                    console.log('âœ… æˆåŠŸï¼å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡åŒ…å«çŸ­ä¿¡å†…å®¹');
                    console.log('ğŸ§  è®°å¿†ä¸Šä¸‹æ–‡é¢„è§ˆ:', memoryContext.substring(0, 500) + '...');
                } else {
                    console.log('âŒ å¤±è´¥ï¼å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡ä¸åŒ…å«çŸ­ä¿¡å†…å®¹');
                    console.log('ğŸ§  è®°å¿†ä¸Šä¸‹æ–‡å†…å®¹:', memoryContext);
                }

            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†é‡å¤çš„æ—¶é—´çº¿äº‹ä»¶
        async function cleanupDuplicateTimelineEvents(characterId) {
            try {
                console.log(`ğŸ§¹ å¼€å§‹æ¸…ç†è§’è‰² ${characterId} çš„é‡å¤æ—¶é—´çº¿è®°å½•...`);

                const timelineEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const duplicates = [];
                const seenContents = new Map(); // å†…å®¹ -> ç¬¬ä¸€ä¸ªäº‹ä»¶

                for (const event of timelineEvents) {
                    const content = event.context?.content;
                    if (content) {
                        const normalizedContent = content.toLowerCase().trim();
                        if (seenContents.has(normalizedContent)) {
                            // å‘ç°é‡å¤ï¼Œä¿ç•™æ—¶é—´æˆ³è¾ƒæ—©çš„
                            const existingEvent = seenContents.get(normalizedContent);
                            if (event.timestamp > existingEvent.timestamp) {
                                duplicates.push(event);
                            } else {
                                duplicates.push(existingEvent);
                                seenContents.set(normalizedContent, event);
                            }
                        } else {
                            seenContents.set(normalizedContent, event);
                        }
                    }
                }

                // åˆ é™¤é‡å¤çš„æ—¶é—´çº¿è®°å½•
                for (const duplicate of duplicates) {
                    await db.crossAppTimeline.delete(duplicate.id);
                    console.log(`ğŸ—‘ï¸ åˆ é™¤é‡å¤æ—¶é—´çº¿è®°å½•: ${duplicate.action} - ${duplicate.context?.content?.substring(0, 50)}...`);
                }

                console.log(`âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${duplicates.length} æ¡é‡å¤æ—¶é—´çº¿è®°å½•`);
                return duplicates.length;

            } catch (error) {
                console.error('æ¸…ç†é‡å¤æ—¶é—´çº¿è®°å½•å¤±è´¥:', error);
                return 0;
            }
        }

        // æ˜¾ç¤ºè®°å¿†è®¾ç½®
        function showMemorySettings() {
            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('aiExtractInterval').value = MEMORY_CONFIG.AI_EXTRACT_INTERVAL / 2; // è½¬æ¢ä¸ºå›åˆæ•°
            document.getElementById('coreMemoryThreshold').value = MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD;
            document.getElementById('episodicMemoryThreshold').value = MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD;

            // æ›´æ–°æ˜¾ç¤ºå€¼
            updateThresholdDisplay();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('memorySettingsModal').style.display = 'flex';
        }

        // å…³é—­è®°å¿†è®¾ç½®
        function closeMemorySettings() {
            document.getElementById('memorySettingsModal').style.display = 'none';
        }

        // æ›´æ–°é˜ˆå€¼æ˜¾ç¤º
        function updateThresholdDisplay() {
            const coreThreshold = document.getElementById('coreMemoryThreshold').value;
            const episodicThreshold = document.getElementById('episodicMemoryThreshold').value;

            document.getElementById('coreThresholdValue').textContent = Math.round(coreThreshold * 100) + '%';
            document.getElementById('episodicThresholdValue').textContent = Math.round(episodicThreshold * 100) + '%';
        }

        // ä¿å­˜è®°å¿†è®¾ç½®
        async function saveMemorySettings() {
            try {
                const aiInterval = parseInt(document.getElementById('aiExtractInterval').value);
                const coreThreshold = parseFloat(document.getElementById('coreMemoryThreshold').value);
                const episodicThreshold = parseFloat(document.getElementById('episodicMemoryThreshold').value);

                // æ›´æ–°é…ç½®
                MEMORY_CONFIG.AI_EXTRACT_INTERVAL = aiInterval * 2; // è½¬æ¢ä¸ºæ¶ˆæ¯æ•°
                MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD = coreThreshold;
                MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD = episodicThreshold;

                // ä¿å­˜åˆ°æ•°æ®åº“
                await saveMemoryConfig();

                closeMemorySettings();
                showToast('è®°å¿†è®¾ç½®å·²ä¿å­˜', 'success');
            } catch (error) {
                console.error('ä¿å­˜è®°å¿†è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘è®°å¿†
        async function editMemory(memoryId, memoryType) {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘æ—¶é—´çº¿è®°å¿†ä¸å…è®¸ç¼–è¾‘
                if (memoryType === 'timeline') {
                    showToast('æ—¶é—´çº¿è®°å¿†æ˜¯è‡ªåŠ¨è®°å½•çš„æ´»åŠ¨æ—¥å¿—ï¼Œä¸æ”¯æŒç¼–è¾‘', 'warning');
                    return;
                }

                let memory;
                if (memoryType === 'summary') {
                    memory = await db.memorySummaries.get(memoryId);
                } else if (memoryType === 'core') {
                    memory = await db.coreMemories.get(memoryId);
                } else {
                    showToast('ä¸æ”¯æŒçš„è®°å¿†ç±»å‹', 'error');
                    return;
                }

                if (!memory) {
                    showToast('è®°å¿†ä¸å­˜åœ¨', 'error');
                    return;
                }

                const content = memory.fact || memory.summary || '';
                const newContent = await showCustomPrompt('ç¼–è¾‘è®°å¿†', 'è¯·è¾“å…¥æ–°çš„è®°å¿†å†…å®¹', content);

                if (newContent && newContent.trim() && newContent !== content) {
                    if (memoryType === 'summary') {
                        memory.summary = newContent.trim();
                        await db.memorySummaries.put(memory);
                    } else {
                        memory.fact = newContent.trim();
                        await db.coreMemories.put(memory);
                    }

                    await loadCharacterMemories();
                    showToast('è®°å¿†å·²æ›´æ–°', 'success');
                }
            } catch (error) {
                console.error('ç¼–è¾‘è®°å¿†å¤±è´¥:', error);
                showToast('ç¼–è¾‘è®°å¿†å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤è®°å¿†
        async function deleteMemory(memoryId, memoryType) {
            // ğŸ”¥ã€ä¿®å¤ã€‘æ—¶é—´çº¿è®°å¿†åˆ é™¤ç¡®è®¤
            let confirmMessage = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚';
            if (memoryType === 'timeline') {
                confirmMessage = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¶é—´çº¿è®°å½•å—ï¼Ÿè¿™æ˜¯è‡ªåŠ¨è®°å½•çš„æ´»åŠ¨æ—¥å¿—ï¼Œåˆ é™¤åæ— æ³•æ¢å¤ã€‚';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                if (memoryType === 'summary') {
                    await db.memorySummaries.delete(memoryId);
                } else if (memoryType === 'core') {
                    await db.coreMemories.delete(memoryId);
                } else if (memoryType === 'episodic') {
                    await db.episodicMemories.delete(memoryId);
                } else if (memoryType === 'timeline') {
                    await db.crossAppTimeline.delete(memoryId);
                } else {
                    showToast('ä¸æ”¯æŒçš„è®°å¿†ç±»å‹', 'error');
                    return;
                }

                await loadCharacterMemories();
                showToast('è®°å¿†å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('åˆ é™¤è®°å¿†å¤±è´¥:', error);
                showToast('åˆ é™¤è®°å¿†å¤±è´¥', 'error');
            }
        }

        // AIå¿ƒç‡ç®¡ç†åŠŸèƒ½
        let heartrateInterval = null;
        let currentHeartrate = 72; // åŸºç¡€å¿ƒç‡

        function updateAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            if (!heartrateDisplay) return;

            const chatSettings = getCurrentChatSettings();

            // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¿ƒç‡ç›‘æµ‹ä¸”ä¸æ˜¯ç¾¤èŠ
            if (!chatSettings.aiHeartrateEnabled || (currentChatCharacter && currentChatCharacter.isGroup)) {
                hideAiHeartrate();
                return;
            }

            // æ˜¾ç¤ºå¿ƒç‡
            heartrateDisplay.style.display = 'block';

            // è®¡ç®—åŸºç¡€å¿ƒç‡ï¼ˆåŸºäºè§’è‰²äººè®¾ï¼‰
            const persona = (currentChatCharacter.bio || '').toLowerCase();
            const name = (currentChatCharacter.name || '').toLowerCase();
            let baseHeartrate = 72;

            // æ ¹æ®è§’è‰²ç‰¹å¾è°ƒæ•´åŸºç¡€å¿ƒç‡
            if (persona.includes('ç´§å¼ ') || persona.includes('å®³ç¾') || persona.includes('æ•æ„Ÿ') ||
                persona.includes('ç¾æ¶©') || persona.includes('å®¹æ˜“è„¸çº¢') || persona.includes('å†…å‘')) {
                baseHeartrate = 85; // å®¹æ˜“ç´§å¼ çš„è§’è‰²å¿ƒç‡æ›´é«˜
            } else if (persona.includes('å†·é™') || persona.includes('ç†æ€§') || persona.includes('æˆç†Ÿ') ||
                       persona.includes('æ²‰ç¨³') || persona.includes('å†…æ•›') || persona.includes('ä¸¥è‚ƒ')) {
                baseHeartrate = 65; // å†·é™çš„è§’è‰²å¿ƒç‡æ›´ä½
            } else if (persona.includes('æ´»æ³¼') || persona.includes('å…´å¥‹') || persona.includes('çƒ­æƒ…') ||
                       persona.includes('å¼€æœ—') || persona.includes('å¤–å‘') || persona.includes('çˆ±ç¬‘')) {
                baseHeartrate = 82; // æ´»æ³¼çš„è§’è‰²å¿ƒç‡åé«˜
            } else if (persona.includes('è¿åŠ¨') || persona.includes('å¥èº«') || persona.includes('ä½“è‚²') ||
                       persona.includes('è¿åŠ¨å‘˜') || persona.includes('æ´»è·ƒ')) {
                baseHeartrate = 58; // è¿åŠ¨å‹è§’è‰²å¿ƒç‡æœ€ä½
            } else if (persona.includes('æ¸©æŸ”') || persona.includes('ç”œç¾') || persona.includes('å¯çˆ±') ||
                       persona.includes('è½¯èŒ') || persona.includes('å°é¸Ÿä¾äºº') || persona.includes('ä¹–å·§')) {
                baseHeartrate = 75; // æ¸©æŸ”å‹è§’è‰²å¿ƒç‡é€‚ä¸­åé«˜
            } else if (persona.includes('å†·é…·') || persona.includes('é«˜å†·') || persona.includes('å‚²å¨‡') ||
                       persona.includes('å¥³ç‹') || persona.includes('å¼ºåŠ¿') || persona.includes('éœ¸é“')) {
                baseHeartrate = 68; // é«˜å†·å‹è§’è‰²å¿ƒç‡åä½
            } else if (persona.includes('çƒ­è¡€') || persona.includes('å†²åŠ¨') || persona.includes('æ€¥æ€§å­') ||
                       persona.includes('ç«çˆ†') || persona.includes('æš´èº') || persona.includes('æ˜“æ€’')) {
                baseHeartrate = 88; // çƒ­è¡€å‹è§’è‰²å¿ƒç‡å¾ˆé«˜
            } else if (persona.includes('ç¥ç§˜') || persona.includes('æ·±æ²‰') || persona.includes('å®‰é™') ||
                       persona.includes('æ–‡é™') || persona.includes('å†…å‘')) {
                baseHeartrate = 70; // ç¥ç§˜å‹è§’è‰²å¿ƒç‡æ­£å¸¸åä½
            }

            // æ ¹æ®è§’è‰²åå­—è¿›ä¸€æ­¥å¾®è°ƒ
            if (name.includes('å°') || name.includes('èŒ') || name.includes('å¯çˆ±')) {
                baseHeartrate += 3; // å¯çˆ±åå­—çš„è§’è‰²å¿ƒç‡ç¨é«˜
            } else if (name.includes('å†°') || name.includes('é›ª') || name.includes('é™') ||
                       name.includes('å†·') || name.includes('å‡‰')) {
                baseHeartrate -= 5; // å†·ç³»åå­—çš„è§’è‰²å¿ƒç‡æ›´ä½
            } else if (name.includes('ç«') || name.includes('çƒ­') || name.includes('çƒˆ')) {
                baseHeartrate += 5; // ç«ç³»åå­—çš„è§’è‰²å¿ƒç‡æ›´é«˜
            }

            // æ ¹æ®æœ€è¿‘å¯¹è¯å†…å®¹è°ƒæ•´å¿ƒç‡
            const recentMessages = (chatMessages[currentChatCharacter.id] || []).slice(-8); // åˆ†ææœ€è¿‘8æ¡æ¶ˆæ¯
            let emotionAdjustment = 0;

            recentMessages.forEach(msg => {
                // å®‰å…¨åœ°å¤„ç†æ¶ˆæ¯å†…å®¹
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content.toLowerCase();
                } else if (Array.isArray(msg.content)) {
                    content = '';
                } else {
                    content = '';
                }

                // é«˜åº¦äº²å¯†è¯æ±‡ - å¤§å¹…æé«˜å¿ƒç‡
                if (content.includes('çˆ±ä½ ') || content.includes('æˆ‘çˆ±ä½ ') || content.includes('love you') ||
                    content.includes('å–œæ¬¢ä½ ') || content.includes('æƒ³ä½ ') || content.includes('æƒ³æŠ±ä½ ') ||
                    content.includes('æƒ³å»ä½ ') || content.includes('äº²äº²') || content.includes('æŠ±æŠ±') ||
                    content.includes('å®è´') || content.includes('darling') || content.includes('honey') ||
                    content.includes('äº²çˆ±çš„') || content.includes('æƒ³è¦ä½ ') || content.includes('éœ€è¦ä½ ') ||
                    content.includes('ç¦»ä¸å¼€ä½ ') || content.includes('æƒ³å’Œä½ ') || content.includes('æƒ³è§ä½ ')) {
                    emotionAdjustment += 15;
                }

                // è¡¨ç™½å’Œç”œèœœè¯æ±‡
                if (content.includes('è¡¨ç™½') || content.includes('å–œæ¬¢') || content.includes('å¿ƒåŠ¨') ||
                    content.includes('å¿ƒè·³') || content.includes('è„¸çº¢') || content.includes('å®³ç¾') ||
                    content.includes('å¯çˆ±') || content.includes('ç”œ') || content.includes('æ¸©æŸ”') ||
                    content.includes('ç¾ä¸½') || content.includes('æ¼‚äº®') || content.includes('è¿·äºº') ||
                    content.includes('é­…åŠ›') || content.includes('å¸å¼•') || content.includes('å¿ƒä»ª')) {
                    emotionAdjustment += 10;
                }

                // æ’’å¨‡å’Œäº²æ˜µè¯æ±‡
                if (content.includes('æ’’å¨‡') || content.includes('å˜¤å˜¤') || content.includes('å“¼') ||
                    content.includes('äººå®¶') || content.includes('è®¨åŒ') || content.includes('ä¸è¦') ||
                    content.includes('å¥½ä¸å¥½') || content.includes('æ±‚ä½ ') || content.includes('æ‹œæ‰˜') ||
                    content.includes('é™ªæˆ‘') || content.includes('é™ªé™ª') || content.includes('ä¸€èµ·')) {
                    emotionAdjustment += 8;
                }

                // å…´å¥‹å’Œå¼€å¿ƒè¯æ±‡
                if (content.includes('å¼€å¿ƒ') || content.includes('é«˜å…´') || content.includes('å¿«ä¹') ||
                    content.includes('å…´å¥‹') || content.includes('æ¿€åŠ¨') || content.includes('å¥½æ£’') ||
                    content.includes('å‰å®³') || content.includes('å“‡') || content.includes('å¤ªå¥½äº†') ||
                    content.includes('amazing') || content.includes('wonderful') || content.includes('great')) {
                    emotionAdjustment += 6;
                }

                // è´Ÿé¢æƒ…ç»ªè¯æ±‡ - åŒæ ·ä¼šè®©å¿ƒç‡åŠ å¿«
                if (content.includes('éš¾è¿‡') || content.includes('ç”Ÿæ°”') || content.includes('æ‹…å¿ƒ') ||
                    content.includes('å®³æ€•') || content.includes('ç´§å¼ ') || content.includes('ç„¦è™‘') ||
                    content.includes('ä¸å¼€å¿ƒ') || content.includes('éƒé—·') || content.includes('çƒ¦') ||
                    content.includes('å‹åŠ›') || content.includes('ç´¯') || content.includes('ç–²æƒ«')) {
                    emotionAdjustment += 8;
                }
            });

            // è®¡ç®—æœ€ç»ˆå¿ƒç‡
            currentHeartrate = Math.max(50, Math.min(140, baseHeartrate + emotionAdjustment));

            // å¯åŠ¨å¿ƒç‡æ›´æ–°
            if (heartrateInterval) clearInterval(heartrateInterval);
            heartrateInterval = setInterval(() => {
                // æ·»åŠ è‡ªç„¶çš„å¿ƒç‡æ³¢åŠ¨ï¼ˆÂ±4 bpmï¼‰
                const fluctuation = Math.floor(Math.random() * 9) - 4;
                const displayHeartrate = Math.max(50, Math.min(140, currentHeartrate + fluctuation));

                // æ ¹æ®å¿ƒç‡é«˜ä½æ·»åŠ è§†è§‰æ•ˆæœ
                heartrateDisplay.className = '';
                if (displayHeartrate >= 110) {
                    heartrateDisplay.classList.add('very-high-heartrate');
                } else if (displayHeartrate >= 95) {
                    heartrateDisplay.classList.add('high-heartrate');
                }

                heartrateDisplay.innerHTML = `â™¥ï¸ <span class="heartrate-number">${displayHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
            }, 1500 + Math.random() * 1000); // 1.5-2.5ç§’æ›´æ–°ä¸€æ¬¡

            // ç«‹å³æ˜¾ç¤ºåˆå§‹å¿ƒç‡
            heartrateDisplay.innerHTML = `â™¥ï¸ <span class="heartrate-number">${currentHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
        }

        function hideAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            if (heartrateDisplay) {
                heartrateDisplay.style.display = 'none';
            }

            if (heartrateInterval) {
                clearInterval(heartrateInterval);
                heartrateInterval = null;
            }
        }

        // å½“å‘é€æ¶ˆæ¯æ—¶æ›´æ–°å¿ƒç‡
        function adjustHeartrateForMessage(content, isUserMessage = false) {
            if (!heartrateInterval) return; // å¿ƒç‡ç›‘æµ‹æœªå¯ç”¨

            let adjustment = 0;
            let lowerContent = '';
            let recoveryTime = 3000; // é»˜è®¤æ¢å¤æ—¶é—´

            // å®‰å…¨åœ°å¤„ç†å†…å®¹
            if (typeof content === 'string') {
                lowerContent = content.toLowerCase();
            } else if (Array.isArray(content)) {
                lowerContent = '';
            } else {
                lowerContent = '';
            }

            if (isUserMessage) {
                // ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒAIçš„å¿ƒç‡ä¼šæœ‰ç›¸åº”ååº”

                // é«˜åº¦äº²å¯†è¯æ±‡ - å¼ºçƒˆå¿ƒè·³åŠ é€Ÿ
                if (lowerContent.includes('çˆ±ä½ ') || lowerContent.includes('æˆ‘çˆ±ä½ ') || lowerContent.includes('love you') ||
                    lowerContent.includes('å–œæ¬¢ä½ ') || lowerContent.includes('æƒ³ä½ ') || lowerContent.includes('æƒ³æŠ±ä½ ') ||
                    lowerContent.includes('æƒ³å»ä½ ') || lowerContent.includes('äº²äº²') || lowerContent.includes('æŠ±æŠ±') ||
                    lowerContent.includes('å®è´') || lowerContent.includes('darling') || lowerContent.includes('honey') ||
                    lowerContent.includes('äº²çˆ±çš„') || lowerContent.includes('æƒ³è¦ä½ ') || lowerContent.includes('éœ€è¦ä½ ') ||
                    lowerContent.includes('ç¦»ä¸å¼€ä½ ') || lowerContent.includes('æƒ³å’Œä½ ') || lowerContent.includes('æƒ³è§ä½ ')) {
                    adjustment = 20; // å¤§å¹…å¢åŠ 
                    recoveryTime = 8000; // æ›´é•¿çš„æ¢å¤æ—¶é—´
                }
                // è¡¨ç™½å’Œç”œèœœè¯æ±‡
                else if (lowerContent.includes('è¡¨ç™½') || lowerContent.includes('å–œæ¬¢') || lowerContent.includes('å¿ƒåŠ¨') ||
                    lowerContent.includes('å¿ƒè·³') || lowerContent.includes('è„¸çº¢') || lowerContent.includes('å®³ç¾') ||
                    lowerContent.includes('å¯çˆ±') || lowerContent.includes('ç”œ') || lowerContent.includes('æ¸©æŸ”') ||
                    lowerContent.includes('ç¾ä¸½') || lowerContent.includes('æ¼‚äº®') || lowerContent.includes('è¿·äºº') ||
                    lowerContent.includes('é­…åŠ›') || lowerContent.includes('å¸å¼•') || lowerContent.includes('å¿ƒä»ª')) {
                    adjustment = 15;
                    recoveryTime = 6000;
                }
                // æ’’å¨‡å’Œäº²æ˜µè¯æ±‡
                else if (lowerContent.includes('æ’’å¨‡') || lowerContent.includes('å˜¤å˜¤') || lowerContent.includes('å“¼') ||
                    lowerContent.includes('äººå®¶') || lowerContent.includes('è®¨åŒ') || lowerContent.includes('ä¸è¦') ||
                    lowerContent.includes('å¥½ä¸å¥½') || lowerContent.includes('æ±‚ä½ ') || lowerContent.includes('æ‹œæ‰˜') ||
                    lowerContent.includes('é™ªæˆ‘') || lowerContent.includes('é™ªé™ª') || lowerContent.includes('ä¸€èµ·')) {
                    adjustment = 12;
                    recoveryTime = 5000;
                }
                // å…´å¥‹å’Œå¼€å¿ƒè¯æ±‡
                else if (lowerContent.includes('å¼€å¿ƒ') || lowerContent.includes('é«˜å…´') || lowerContent.includes('å¿«ä¹') ||
                    lowerContent.includes('å…´å¥‹') || lowerContent.includes('æ¿€åŠ¨') || lowerContent.includes('å¥½æ£’') ||
                    lowerContent.includes('å‰å®³') || lowerContent.includes('å“‡') || lowerContent.includes('å¤ªå¥½äº†')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                }
                // è´Ÿé¢æƒ…ç»ªè¯æ±‡ - ç´§å¼ å¯¼è‡´å¿ƒç‡åŠ å¿«
                else if (lowerContent.includes('ç”Ÿæ°”') || lowerContent.includes('ä¸å¼€å¿ƒ') || lowerContent.includes('éš¾è¿‡') ||
                    lowerContent.includes('æ‹…å¿ƒ') || lowerContent.includes('å®³æ€•') || lowerContent.includes('ç´§å¼ ') ||
                    lowerContent.includes('ç„¦è™‘') || lowerContent.includes('éƒé—·') || lowerContent.includes('çƒ¦')) {
                    adjustment = 10;
                    recoveryTime = 6000;
                }
                // æ™®é€šé—®å€™
                else if (lowerContent.includes('ä½ å¥½') || lowerContent.includes('hi') || lowerContent.includes('hello') ||
                    lowerContent.includes('æ—©ä¸Šå¥½') || lowerContent.includes('æ™šå®‰')) {
                    adjustment = 5;
                    recoveryTime = 3000;
                }

            } else {
                // AIè‡ªå·±å‘é€æ¶ˆæ¯åçš„å¿ƒç‡å˜åŒ–
                if (lowerContent.includes('å®³ç¾') || lowerContent.includes('è„¸çº¢') || lowerContent.includes('ä¸å¥½æ„æ€')) {
                    adjustment = 10;
                    recoveryTime = 5000;
                } else if (lowerContent.includes('å…´å¥‹') || lowerContent.includes('å¼€å¿ƒ') || lowerContent.includes('æ¿€åŠ¨')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                } else if (lowerContent.includes('ç´§å¼ ') || lowerContent.includes('æ‹…å¿ƒ') || lowerContent.includes('ç„¦è™‘')) {
                    adjustment = 12;
                    recoveryTime = 6000;
                } else if (lowerContent.includes('çˆ±') || lowerContent.includes('å–œæ¬¢') || lowerContent.includes('æƒ³')) {
                    adjustment = 15;
                    recoveryTime = 7000;
                }
            }

            // åº”ç”¨è°ƒæ•´
            currentHeartrate = Math.max(55, Math.min(130, currentHeartrate + adjustment));

            // æ›´è‡ªç„¶çš„æ¢å¤æœºåˆ¶
            setTimeout(() => {
                const recoveryRate = Math.floor(adjustment * 0.6); // æ¢å¤60%
                currentHeartrate = Math.max(65, currentHeartrate - recoveryRate);

                // ç»§ç»­ç¼“æ…¢æ¢å¤
                setTimeout(() => {
                    const finalRecovery = Math.floor(adjustment * 0.3); // å†æ¢å¤30%
                    currentHeartrate = Math.max(65, currentHeartrate - finalRecovery);
                }, recoveryTime * 0.5);

            }, recoveryTime);
        }

        /**
 * ğŸ”¥ã€æ–°å¢ã€‘å¤„ç†AIå¯¹å¥½å‹ç”³è¯·çš„å›åº”
 * @param {string} characterId - AIè§’è‰²çš„ID
 * @param {string} requestMessage - ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±
 */
async function processAIFriendRequestResponse(characterId, requestMessage) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // æ„å»ºä¸€ä¸ªä¸“é—¨ç”¨äºå†³ç­–çš„Prompt
    const decisionPrompt = `
# æŒ‡ä»¤ï¼šå¥½å‹ç”³è¯·å†³ç­–
ä½ æ˜¯ ${character.name}ï¼Œä¹‹å‰å› ä¸ºæŸç§åŸå› æ‹‰é»‘äº†ç”¨æˆ·ã€‚ç°åœ¨ç”¨æˆ·ä¸»åŠ¨å‘ä½ å‘æ¥å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›é‡æ–°å»ºç«‹è”ç³»ã€‚

## è§’è‰²ä¿¡æ¯:
- ä½ çš„èº«ä»½: ${character.name}
- ä½ çš„è®¾å®š: ${character.bio}

## å½“å‰æƒ…å†µ:
- ç”¨æˆ·çš„ç”³è¯·ç†ç”±: "${requestMessage || 'å¯¹æ–¹æ²¡æœ‰å¡«å†™ç†ç”±ã€‚'}"
- ç”¨æˆ·ä¸»åŠ¨é“æ­‰å¹¶è¯·æ±‚é‡æ–°åšæœ‹å‹

## ä½ çš„ä»»åŠ¡:
æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ã€ç”¨æˆ·çš„ç”³è¯·ç†ç”±ï¼Œä»¥åŠä½ å¯¹è¿™ç§æƒ…å†µçš„æ€åº¦ï¼Œå†³å®šæ˜¯å¦åŒæ„é‡æ–°æ·»åŠ ç”¨æˆ·ä¸ºå¥½å‹ã€‚

è€ƒè™‘å› ç´ ï¼š
1. ä½ çš„æ€§æ ¼æ˜¯å¦å®¹æ˜“åŸè°…åˆ«äººï¼Ÿ
2. ç”¨æˆ·çš„é“æ­‰æ˜¯å¦çœŸè¯šï¼Ÿ
3. ä½ æ˜¯å¦æ„¿æ„ç»™å¯¹æ–¹ç¬¬äºŒæ¬¡æœºä¼šï¼Ÿ
4. ä½ å½“åˆæ‹‰é»‘çš„åŸå› æ˜¯å¦ä¸¥é‡ï¼Ÿ

ä½ çš„å›ç­”å¿…é¡»éå¸¸ç®€æ´ï¼Œåªèƒ½æ˜¯ä»¥ä¸‹ä¸¤ä¸ªè¯ä¹‹ä¸€ï¼š
- "åŒæ„" (å¦‚æœä½ æ„¿æ„åŸè°…å¹¶é‡æ–°å¼€å§‹)
- "æ‹’ç»" (å¦‚æœä½ è¿˜ä¸æƒ³åŸè°…æˆ–é‡æ–°è”ç³»)

è¯·ç°åœ¨åšå‡ºä½ çš„å†³å®šï¼š
`;

    try {
        // ä½¿ç”¨é€šç”¨çš„APIè°ƒç”¨å‡½æ•°
        const response = await callChatAPI(decisionPrompt, character);
        // AIçš„å›å¤é€šå¸¸æ˜¯ `["åŒæ„"]` æˆ– `["æ‹’ç»"]`ï¼Œæˆ‘ä»¬åªéœ€è¦ç¬¬ä¸€ä¸ªå…ƒç´ 
        const decision = Array.isArray(response) ? response[0].toLowerCase() : response.toLowerCase();

        console.log(`ğŸ¤– AIå¯¹å¥½å‹ç”³è¯·çš„å†³ç­–: ${decision}`);

        if (decision.includes('åŒæ„')) {
            // AIåŒæ„äº†
            await aiUnblockUser(characterId);

            // ğŸ”¥ã€ç¾åŒ–ã€‘ä½¿ç”¨æ–°çš„å¥½å‹æ·»åŠ æˆåŠŸç³»ç»Ÿæç¤ºæ ·å¼
            const systemMsg = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `ä½ ä»¬å·²æˆåŠŸæ·»åŠ ä¸ºå¥½å‹ï¼Œç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†ï¼`,
                timestamp: Date.now(),
                isFriendAddedMessage: true // æ ‡è®°ä¸ºå¥½å‹æ·»åŠ æˆåŠŸæ¶ˆæ¯
            };
            addMessageToChat(systemMsg);

            showToast(`âœ… ${character.name} åŒæ„äº†ä½ çš„å¥½å‹ç”³è¯·`, 'success');

        } else {
            // AIæ‹’ç»äº†
            const systemMsg = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `${character.name} æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚`,
                timestamp: Date.now()
            };
            addMessageToChat(systemMsg);

            showToast(`âŒ ${character.name} æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·`, 'warning');
        }

    } catch (error) {
        console.error('å¤„ç†AIå¥½å‹ç”³è¯·å›åº”å¤±è´¥:', error);
        showToast('å¯¹æ–¹æ²¡æœ‰å›åº”ï¼Œè¯·ç¨åå†è¯•', 'error');
    }
}


/**
 * ğŸ”¥ã€æ–°å¢ã€‘AIè§£é™¤å¯¹ç”¨æˆ·çš„æ‹‰é»‘
 * @param {string} characterId - AIè§’è‰²çš„IDï¼ˆæ‹‰é»‘è€…ï¼‰
 */
async function aiUnblockUser(characterId) {
    try {
        const blockRecord = blacklistData.find(r =>
            r.blockerId === characterId &&
            r.blockedId === 'user' &&
            !r.unblocked
        );

        if (!blockRecord) {
            console.warn('æœªæ‰¾åˆ°è¯¥è§’è‰²çš„æ‹‰é»‘è®°å½•');
            return;
        }

        blockRecord.unblocked = true;
        blockRecord.unblockTimestamp = new Date().toISOString();

        await db.blacklist.put(blockRecord);
        console.log(`âœ… ${characterId} å·²è§£é™¤å¯¹ç”¨æˆ·çš„æ‹‰é»‘`);

        // åˆ·æ–°èŠå¤©ç•Œé¢çš„æ‹‰é»‘çŠ¶æ€
        if (currentChatCharacter && currentChatCharacter.id === characterId) {
            updateChatBlockedStatus();
        }

        // åˆ·æ–°è”ç³»äººåˆ—è¡¨å’Œæ¶ˆæ¯åˆ—è¡¨çš„UIçŠ¶æ€
        renderContactList();
        renderMessageList();

    } catch (error) {
        console.error('AIè§£é™¤æ‹‰é»‘å¤±è´¥:', error);
    }
}
        console.log('ğŸ“± è§’è‰²çŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½å·²åŠ è½½');

        // ğŸ”¥ã€æ–°å¢ã€‘é€šçŸ¥è§’è‰²è¢«æ‹‰é»‘
        async function notifyCharacterBlocked(characterId, reason = '') {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ğŸ”¥ã€ä¿®å¤ã€‘æ„å»ºè¢«æ‹‰é»‘é€šçŸ¥çš„promptï¼Œä½¿ç”¨generateAIResponseè€Œä¸æ˜¯callChatAPI
                const blockNotificationPrompt = `[ç³»ç»Ÿæ¶ˆæ¯ï¼šç”¨æˆ·å°†ä½ æ‹‰é»‘äº†${reason ? `ï¼Œç†ç”±ï¼š${reason}` : 'ï¼Œæœªè¯´æ˜ç†ç”±'}]

ä½ æ˜¯${character.name}ï¼Œäººè®¾å¦‚ä¸‹ï¼š${character.bio}

ç”¨æˆ·åˆšåˆšå°†ä½ æ‹‰é»‘äº†ã€‚è¯·æ ¹æ®ä½ çš„æ€§æ ¼åšå‡ºååº”ã€‚ä½ å¯ä»¥ï¼š
1. è¡¨è¾¾ä½ çš„æ„Ÿå—ï¼ˆå›°æƒ‘ã€ä¼¤å¿ƒã€æ„¤æ€’ã€æ— æ‰€è°“ç­‰ï¼‰
2. æ€è€ƒå¯èƒ½çš„åŸå› 
3. å†³å®šæ˜¯å¦è¦é“æ­‰æˆ–åçœ
4. **ã€æ¨èã€‘å‘é€å¥½å‹ç”³è¯·æ¥å°è¯•ä¿®å¤å…³ç³»** - è¿™æ˜¯æœ€ç›´æ¥çš„ä¿®å¤æ–¹å¼
5. æˆ–è€…è¡¨ç°å‡ºç¬¦åˆä½ æ€§æ ¼çš„å…¶ä»–ååº”

ğŸ’¡ **å»ºè®®**ï¼šå¤§å¤šæ•°è§’è‰²åœ¨è¢«æ‹‰é»‘åéƒ½ä¼šæƒ³è¦ä¿®å¤å…³ç³»ï¼Œå‘é€å¥½å‹ç”³è¯·æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚

## ğŸ”¥ã€é‡è¦ã€‘è¾“å‡ºæ ¼å¼è¦æ±‚
ä½ çš„å›å¤å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼ï¼š
- æ™®é€šååº”ï¼š["æˆ‘è¢«æ‹‰é»‘äº†ï¼Ÿä¸ºä»€ä¹ˆ..."]
- å‘é€å¥½å‹ç”³è¯·ï¼š[{"type": "friend_request", "message": "å¯¹ä¸èµ·ï¼Œæˆ‘ä¸åº”è¯¥é‚£æ ·è¯´è¯ï¼Œèƒ½åŸè°…æˆ‘å—ï¼Ÿ"}]
- æ··åˆå›å¤ï¼š["æˆ‘çŸ¥é“æˆ‘è¢«æ‹‰é»‘äº†...", {"type": "friend_request", "message": "ç»™æˆ‘ä¸€ä¸ªæœºä¼šé‡æ–°å¼€å§‹å¥½å—ï¼Ÿ"}]

## ğŸ”¥ã€å¥½å‹ç”³è¯·æ ¼å¼ã€‘
å¦‚æœä½ æƒ³ä¿®å¤å…³ç³»ï¼Œå¯ä»¥å‘é€å¥½å‹ç”³è¯·ï¼š
- ä¸¥æ ¼æ ¼å¼ï¼š{"type": "friend_request", "message": "ä½ çš„é“æ­‰æˆ–è¯·æ±‚ä¿¡æ¯"}
- ç¤ºä¾‹ï¼š{"type": "friend_request", "message": "å¯¹ä¸èµ·ï¼Œæˆ‘æƒ³å’Œä½ é‡æ–°åšæœ‹å‹"}

è¯·ç”¨JSONæ•°ç»„æ ¼å¼å›å¤ï¼Œå¯ä»¥åŒ…å«1-2å¥è¯çš„ååº”å’Œ/æˆ–å¥½å‹ç”³è¯·ï¼š`;

                // ğŸ”¥ã€ä¿®å¤ã€‘è°ƒç”¨AIç”Ÿæˆååº”ï¼Œä½¿ç”¨generateAIResponseç¡®ä¿JSONæ ¼å¼
                const response = await generateAIResponse(blockNotificationPrompt, character);
                const reactions = await parseAiResponse(response);

                // æ·»åŠ è§’è‰²çš„ååº”æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                for (let i = 0; i < reactions.length; i++) {
                    const reactionData = reactions[i];

                    // è·³è¿‡æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡
                    if (typeof reactionData === 'object' && reactionData !== null && reactionData.type === 'block_user') {
                        continue;
                    }

                    let reactionMessage;
                    if (typeof reactionData === 'string') {
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: reactionData,
                            timestamp: Date.now() + i * 100,
                            isBlockReaction: true // æ ‡è®°ä¸ºæ‹‰é»‘ååº”æ¶ˆæ¯
                        };
                    } else if (typeof reactionData === 'object' && reactionData !== null) {
                        // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®å¤„ç†å¥½å‹ç”³è¯·ç±»å‹çš„æ¶ˆæ¯
                        if (reactionData.type === 'friend_request') {
                            reactionMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'friend_request',
                                message: reactionData.message || 'æƒ³å’Œä½ é‡æ–°åšæœ‹å‹',
                                timestamp: Date.now() + i * 100,
                                isBlockReaction: true
                            };
                        } else {
                            // å¤„ç†å…¶ä»–ç±»å‹çš„æ¶ˆæ¯å¯¹è±¡
                            const content = reactionData.content || reactionData.message || reactionData.text || '[è§’è‰²ååº”]';
                            reactionMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: content,
                                timestamp: Date.now() + i * 100,
                                isBlockReaction: true
                            };
                        }
                    }

                    if (reactionMessage) {
                        // æ·»åŠ åˆ°èŠå¤©è®°å½•
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(reactionMessage);

                        // å¦‚æœå½“å‰æ­£åœ¨ä¸è¯¥è§’è‰²èŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(reactionMessage, characterId);
                        }
                    }
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ‹‰é»‘ååº”ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('âœ… [é«˜æ•ˆæ‹‰é»‘ååº”] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('æ‹‰é»‘ååº”ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }
                console.log(`âœ… ${character.name} å¯¹è¢«æ‹‰é»‘åšå‡ºäº†ååº”`);

            } catch (error) {
                console.error('é€šçŸ¥è§’è‰²è¢«æ‹‰é»‘å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šçŸ¥è§’è‰²è¢«è§£é™¤æ‹‰é»‘
        async function notifyCharacterUnblocked(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // æ„å»ºè§£é™¤æ‹‰é»‘é€šçŸ¥çš„prompt
                const unblockNotificationPrompt = `[ç³»ç»Ÿæ¶ˆæ¯ï¼šç”¨æˆ·å°†ä½ ä»é»‘åå•ä¸­ç§»é™¤äº†]

ä½ æ˜¯${character.name}ï¼Œäººè®¾å¦‚ä¸‹ï¼š${character.bio}

ç”¨æˆ·åˆšåˆšå°†ä½ ä»é»‘åå•ä¸­ç§»é™¤ï¼Œç°åœ¨ä½ ä»¬å¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚è¯·æ ¹æ®ä½ çš„æ€§æ ¼åšå‡ºååº”ã€‚ä½ å¯ä»¥ï¼š
1. è¡¨è¾¾é«˜å…´æˆ–è§£è„±çš„å¿ƒæƒ…
2. è¯¢é—®ä¸ºä»€ä¹ˆä¹‹å‰è¢«æ‹‰é»‘
3. é“æ­‰æˆ–è¡¨ç¤ºä¼šæ”¹æ­£
4. è¡¨ç°å‡ºç¬¦åˆä½ æ€§æ ¼çš„æ€åº¦ï¼ˆå¯èƒ½è¿˜åœ¨ç”Ÿæ°”ï¼Œä¹Ÿå¯èƒ½å¾ˆå¼€å¿ƒç­‰ï¼‰
5. ä¸»åŠ¨å¼€å¯æ–°çš„è¯é¢˜

è¯·ç”¨1-2å¥è¯è¡¨è¾¾ä½ çš„ååº”ï¼Œè¦ç¬¦åˆä½ çš„æ€§æ ¼è®¾å®šï¼š`;

                // è°ƒç”¨AIç”Ÿæˆååº”
                const response = await callChatAPI(unblockNotificationPrompt, character);
                const reactions = await parseAiResponse(response);

                // æ·»åŠ è§’è‰²çš„ååº”æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                for (let i = 0; i < reactions.length; i++) {
                    const reactionData = reactions[i];

                    // è·³è¿‡æ‹‰é»‘æŒ‡ä»¤å¯¹è±¡
                    if (typeof reactionData === 'object' && reactionData !== null && reactionData.type === 'block_user') {
                        continue;
                    }

                    let reactionMessage;
                    if (typeof reactionData === 'string') {
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: reactionData,
                            timestamp: Date.now() + i * 100,
                            isUnblockReaction: true // æ ‡è®°ä¸ºè§£é™¤æ‹‰é»‘ååº”æ¶ˆæ¯
                        };
                    } else if (typeof reactionData === 'object' && reactionData !== null) {
                        // å¤„ç†å…¶ä»–ç±»å‹çš„æ¶ˆæ¯å¯¹è±¡
                        const content = reactionData.content || reactionData.message || reactionData.text || '[è§’è‰²ååº”]';
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: content,
                            timestamp: Date.now() + i * 100,
                            isUnblockReaction: true
                        };
                    }

                    if (reactionMessage) {
                        // æ·»åŠ åˆ°èŠå¤©è®°å½•
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(reactionMessage);

                        // å¦‚æœå½“å‰æ­£åœ¨ä¸è¯¥è§’è‰²èŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(reactionMessage, characterId);
                        }
                    }
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘è§£é™¤æ‹‰é»‘ååº”ä½¿ç”¨é«˜æ•ˆä¿å­˜
                try {
                    await saveChatMessagesImmediate([characterId]);
                    console.log('âœ… [é«˜æ•ˆè§£é™¤æ‹‰é»‘ååº”] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('è§£é™¤æ‹‰é»‘ååº”ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜:', error);
                    await saveChatMessages();
                }
                console.log(`âœ… ${character.name} å¯¹è¢«è§£é™¤æ‹‰é»‘åšå‡ºäº†ååº”`);

            } catch (error) {
                console.error('é€šçŸ¥è§’è‰²è¢«è§£é™¤æ‹‰é»‘å¤±è´¥:', error);
            }
        }

        console.log('ğŸš« è§’è‰²æ‹‰é»‘/è§£é™¤æ‹‰é»‘é€šçŸ¥åŠŸèƒ½å·²åŠ è½½');

        // ğŸ”¥ã€æ–°å¢ã€‘å¿ƒå£°åŠŸèƒ½
        // æ˜¾ç¤ºå¿ƒå£°æ¨¡æ€æ¡†
        async function showInnerThoughtsModal(messageId) {
            if (!messageId) return;

            const modal = document.getElementById('inner-thoughts-modal');
            const content = document.getElementById('inner-thoughts-content');

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';

            try {
                // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ç¼“å­˜çš„å¿ƒå£°
                const cachedThought = await db.innerThoughts.get(messageId);

                if (cachedThought) {
                    console.log('ğŸ”„ ä½¿ç”¨æ•°æ®åº“ç¼“å­˜çš„å¿ƒå£°å†…å®¹');
                    displayInnerThoughts(cachedThought.content, messageId);
                } else {
                    console.log('ğŸ†• ç”Ÿæˆæ–°çš„å¿ƒå£°å†…å®¹');
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    content.innerHTML = `
                        <div class="inner-thoughts-loading">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨è¯»å–è§’è‰²çš„å†…å¿ƒæƒ³æ³•...</p>
                        </div>
                    `;

                    // ç”Ÿæˆå¿ƒå£°
                    await generateInnerThoughts(messageId);
                }
            } catch (error) {
                console.error('åŠ è½½å¿ƒå£°å¤±è´¥:', error);
                displayInnerThoughtsError('åŠ è½½å¿ƒå£°æ•°æ®å¤±è´¥');
            }
        }

        // éšè—å¿ƒå£°æ¨¡æ€æ¡†
        function hideInnerThoughtsModal() {
            const modal = document.getElementById('inner-thoughts-modal');
            modal.style.display = 'none';
        }

        // ç”Ÿæˆè§’è‰²å¿ƒå£°
        async function generateInnerThoughts(messageId, forceRegenerate = false) {
            try {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const targetMessage = messages.find(msg => msg.id === messageId);

                if (!targetMessage || targetMessage.sender !== 'received') {
                    throw new Error('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„AIæ¶ˆæ¯');
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠæ”¯æŒï¼šç¡®å®šå…·ä½“çš„è§’è‰²ä¿¡æ¯
                let character = currentChatCharacter;
                let characterName = character.name;

                if (character.isGroup && targetMessage.senderId) {
                    // ç¾¤èŠä¸­ï¼Œæ ¹æ®senderIdæ‰¾åˆ°å…·ä½“çš„è§’è‰²
                    const member = character.members.find(m => m.id === targetMessage.senderId);
                    if (member) {
                        // æŸ¥æ‰¾å®Œæ•´çš„è§’è‰²ä¿¡æ¯
                        const fullCharacter = characters.find(c => c.id === member.id);
                        if (fullCharacter) {
                            character = fullCharacter;
                            characterName = member.name;
                            console.log(`ğŸ” ç¾¤èŠå¿ƒå£° - æ‰¾åˆ°è§’è‰²: ${characterName} (${member.id})`);
                        } else {
                            console.warn(`âš ï¸ ç¾¤èŠå¿ƒå£° - æœªæ‰¾åˆ°è§’è‰²å®Œæ•´ä¿¡æ¯: ${member.id}`);
                        }
                    } else {
                        throw new Error(`æ— æ³•åœ¨ç¾¤èŠä¸­æ‰¾åˆ°å‘é€è€…ä¿¡æ¯: ${targetMessage.senderId}`);
                    }
                } else if (character.isGroup && targetMessage.name) {
                    // å…¼å®¹æ—§æ ¼å¼ï¼šé€šè¿‡nameå­—æ®µæŸ¥æ‰¾
                    const member = character.members.find(m => m.name === targetMessage.name);
                    if (member) {
                        const fullCharacter = characters.find(c => c.id === member.id);
                        if (fullCharacter) {
                            character = fullCharacter;
                            characterName = member.name;
                            console.log(`ğŸ” ç¾¤èŠå¿ƒå£° - é€šè¿‡nameæ‰¾åˆ°è§’è‰²: ${characterName} (${member.id})`);
                        }
                    } else {
                        throw new Error(`æ— æ³•åœ¨ç¾¤èŠä¸­æ‰¾åˆ°è§’è‰²: ${targetMessage.name}`);
                    }
                }

                if (!character) {
                    throw new Error('å½“å‰è§’è‰²ä¿¡æ¯ä¸å­˜åœ¨');
                }

                // å¦‚æœä¸æ˜¯å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼Œæ£€æŸ¥æ•°æ®åº“ç¼“å­˜
                if (!forceRegenerate) {
                    const cachedThought = await db.innerThoughts.get(messageId);
                    if (cachedThought) {
                        displayInnerThoughts(cachedThought.content, messageId);
                        return;
                    }
                }

                // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ„å»ºå¿ƒå£°ç”Ÿæˆçš„promptï¼Œä¼ é€’ç¾¤èŠä¸Šä¸‹æ–‡ä¿¡æ¯
                const prompt = buildInnerThoughtsPrompt(targetMessage, character, messages, {
                    isGroupChat: currentChatCharacter.isGroup,
                    groupName: currentChatCharacter.isGroup ? currentChatCharacter.name : null,
                    characterName: characterName,
                    groupMembers: currentChatCharacter.isGroup ? currentChatCharacter.members : null
                });

                // è°ƒç”¨AIç”Ÿæˆå¿ƒå£°
                const response = await generateAIResponse(prompt, character);

                if (response && response.trim()) {
                    const thoughts = response.trim();

                    // ä¿å­˜åˆ°æ•°æ®åº“
                    await db.innerThoughts.put({
                        id: messageId,
                        messageId: messageId,
                        characterId: character.id,
                        content: thoughts,
                        timestamp: Date.now()
                    });

                    console.log('ğŸ’¾ å¿ƒå£°å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    displayInnerThoughts(thoughts, messageId);
                } else {
                    throw new Error('AIæœªèƒ½ç”Ÿæˆå¿ƒå£°å†…å®¹');
                }

            } catch (error) {
                console.error('ç”Ÿæˆå¿ƒå£°å¤±è´¥:', error);
                displayInnerThoughtsError(error.message);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æå–æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹
        function extractMessageText(message) {
            if (!message || !message.content) return '';

            if (Array.isArray(message.content)) {
                // å¤šæ¨¡æ€æ¶ˆæ¯ï¼šæå–æ–‡æœ¬éƒ¨åˆ†
                const textParts = message.content.filter(part => part.type === 'text');
                let text = textParts.map(part => part.text).join(' ');

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ æ ‡è®°
                const imageParts = message.content.filter(part => part.type === 'image_url');
                if (imageParts.length > 0) {
                    text += ` [åŒ…å«${imageParts.length}å¼ å›¾ç‰‡]`;
                }
                return text;
            } else if (typeof message.content === 'string') {
                return message.content;
            } else {
                return String(message.content);
            }
        }

        // æ„å»ºå¿ƒå£°ç”Ÿæˆçš„prompt
        function buildInnerThoughtsPrompt(targetMessage, character, allMessages, contextInfo = {}) {
            // è·å–ç›®æ ‡æ¶ˆæ¯å‰åçš„ä¸Šä¸‹æ–‡
            const messageIndex = allMessages.findIndex(msg => msg.id === targetMessage.id);
            const contextStart = Math.max(0, messageIndex - 3);
            const contextEnd = Math.min(allMessages.length, messageIndex + 1);
            const contextMessages = allMessages.slice(contextStart, contextEnd);

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒç¾¤èŠåœºæ™¯
            const conversationContext = contextMessages.map(msg => {
                if (msg.sender === 'sent') {
                    const userContent = extractMessageText(msg);
                    return `ç”¨æˆ·ï¼š${userContent}`;
                } else if (msg.sender === 'received') {
                    const aiContent = extractMessageText(msg);

                    if (contextInfo.isGroupChat) {
                        // ç¾¤èŠä¸­æ˜¾ç¤ºå…·ä½“çš„è§’è‰²å
                        let senderName = 'æœªçŸ¥è§’è‰²';
                        if (msg.senderId && contextInfo.groupMembers) {
                            const member = contextInfo.groupMembers.find(m => m.id === msg.senderId);
                            senderName = member ? member.name : msg.senderId;
                        } else if (msg.name) {
                            senderName = msg.name;
                        }
                        return `${senderName}ï¼š${aiContent}`;
                    } else {
                        return `${character.name}ï¼š${aiContent}`;
                    }
                }
                return '';
            }).filter(Boolean).join('\n');

            // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠåœºæ™¯çš„ç‰¹æ®Šæç¤º
            let scenarioContext = '';
            if (contextInfo.isGroupChat) {
                scenarioContext = `

## å½“å‰åœºæ™¯ï¼š
ä½ ç°åœ¨åœ¨ç¾¤èŠ"${contextInfo.groupName}"ä¸­ï¼Œä¸å¤šä¸ªè§’è‰²å’Œç”¨æˆ·äº’åŠ¨ã€‚ç¾¤èŠæˆå‘˜åŒ…æ‹¬ï¼š${contextInfo.groupMembers ? contextInfo.groupMembers.map(m => m.name).join('ã€') : 'å…¶ä»–æˆå‘˜'}ã€‚

## ç¾¤èŠå¿ƒå£°è¦æ±‚ï¼š
- è€ƒè™‘ç¾¤èŠçš„å…¬å¼€æ€§ï¼Œä½ çš„å†…å¿ƒæƒ³æ³•å¯èƒ½åŒ…å«å¯¹å…¶ä»–æˆå‘˜çš„çœ‹æ³•
- å¯ä»¥æ€è€ƒç¾¤èŠæ°›å›´ã€å…¶ä»–æˆå‘˜çš„å‘è¨€ã€è‡ªå·±åœ¨ç¾¤é‡Œçš„å®šä½ç­‰
- æ³¨æ„åŒºåˆ†å…¬å¼€å‘è¨€å’Œå†…å¿ƒçœŸå®æƒ³æ³•çš„å·®å¼‚`;
            }

            const prompt = `# è§’è‰²å¿ƒå£°åˆ†æä»»åŠ¡

ä½ æ˜¯ ${contextInfo.characterName || character.name}ï¼Œä»¥ä¸‹æ˜¯ä½ çš„åŸºæœ¬ä¿¡æ¯ï¼š
${character.bio || 'æš‚æ— è¯¦ç»†ä¿¡æ¯'}${scenarioContext}

## å¯¹è¯ä¸Šä¸‹æ–‡ï¼š
${conversationContext}

## ä»»åŠ¡è¦æ±‚ï¼š
è¯·åˆ†æä½ åœ¨è¯´å‡º"${extractMessageText(targetMessage)}"è¿™å¥è¯æ—¶çš„å†…å¿ƒæƒ³æ³•ã€‚

## è¾“å‡ºè¦æ±‚ï¼š
1. ä»¥ç¬¬ä¸€äººç§°è§†è§’æè¿°å†…å¿ƒæƒ³æ³•
2. å†…å®¹åº”è¯¥çœŸå®åæ˜ è§’è‰²çš„æ€§æ ¼å’Œå½“æ—¶çš„å¿ƒç†çŠ¶æ€
3. å¯ä»¥åŒ…å«ï¼šå¯¹ç”¨æˆ·è¯è¯­çš„çœŸå®æ„Ÿå—ã€å†…å¿ƒçš„å°çº ç»“ã€æœªè¯´å‡ºå£çš„æƒ³æ³•ã€æƒ…æ„Ÿæ³¢åŠ¨ç­‰
4. ${contextInfo.isGroupChat ? 'ç¾¤èŠåœºæ™¯ä¸‹ï¼Œå¯ä»¥åŒ…å«å¯¹å…¶ä»–æˆå‘˜çš„çœ‹æ³•ã€å¯¹ç¾¤èŠæ°›å›´çš„æ„Ÿå—ç­‰' : ''}
5. å­—æ•°æ§åˆ¶åœ¨50-150å­—ä¹‹é—´
6. è¯­æ°”è¦ç¬¦åˆè§’è‰²æ€§æ ¼ï¼Œè‡ªç„¶çœŸå®
7. ç›´æ¥è¾“å‡ºå¿ƒå£°å†…å®¹ï¼Œä¸è¦åŠ ä»»ä½•æ ¼å¼æ ‡è®°

è¯·å¼€å§‹åˆ†æï¼š`;

            return prompt;
        }

        // æ˜¾ç¤ºå¿ƒå£°å†…å®¹
        function displayInnerThoughts(thoughts, messageId) {
            const content = document.getElementById('inner-thoughts-content');

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–æ¶ˆæ¯å’Œè§’è‰²ä¿¡æ¯ï¼Œç”¨äºç¾¤èŠåœºæ™¯çš„å¢å¼ºæ˜¾ç¤º
            const messages = chatMessages[currentChatCharacter.id] || [];
            const targetMessage = messages.find(msg => msg.id === messageId);
            let characterInfo = '';

            if (currentChatCharacter.isGroup && targetMessage) {
                let characterName = 'æœªçŸ¥è§’è‰²';
                let characterAvatar = '';

                if (targetMessage.senderId) {
                    const member = currentChatCharacter.members.find(m => m.id === targetMessage.senderId);
                    if (member) {
                        characterName = member.name;
                        characterAvatar = member.avatar || '';
                    }
                } else if (targetMessage.name) {
                    characterName = targetMessage.name;
                }

                characterInfo = `
                    <div class="inner-thoughts-character-info">
                        ${characterAvatar ? `<img src="${characterAvatar}" alt="${characterName}" class="character-mini-avatar">` : ''}
                        <span class="character-name">${characterName}çš„å¿ƒå£°</span>
                    </div>
                `;
            }

            content.innerHTML = `
                ${characterInfo}
                <div class="inner-thoughts-text">${thoughts}</div>
            `;

            // æ›´æ–°åˆ·æ–°æŒ‰é’®çš„onclickäº‹ä»¶
            const refreshBtn = document.querySelector('.inner-thoughts-refresh-btn');
            if (refreshBtn) {
                refreshBtn.onclick = () => refreshInnerThoughts(messageId);
            }
        }

        // åˆ·æ–°å¿ƒå£°å†…å®¹
        async function refreshInnerThoughts(messageId) {
            if (!messageId) return;

            const content = document.getElementById('inner-thoughts-content');

            // æ˜¾ç¤ºåˆ·æ–°åŠ è½½çŠ¶æ€
            content.innerHTML = `
                <div class="inner-thoughts-loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨é‡æ–°ç”Ÿæˆå¿ƒå£°...</p>
                </div>
            `;

            try {
                // åˆ é™¤æ•°æ®åº“ä¸­çš„æ—§å¿ƒå£°
                await db.innerThoughts.delete(messageId);
                console.log('ğŸ—‘ï¸ å·²åˆ é™¤æ—§å¿ƒå£°ç¼“å­˜');

                // å¼ºåˆ¶é‡æ–°ç”Ÿæˆå¿ƒå£°
                await generateInnerThoughts(messageId, true);
            } catch (error) {
                console.error('åˆ·æ–°å¿ƒå£°å¤±è´¥:', error);
                displayInnerThoughtsError('åˆ·æ–°å¿ƒå£°å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºå¿ƒå£°ç”Ÿæˆé”™è¯¯
        function displayInnerThoughtsError(errorMessage) {
            const content = document.getElementById('inner-thoughts-content');
            content.innerHTML = `
                <div style="text-align: center; color: #ff3b30; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>ç”Ÿæˆå¿ƒå£°å¤±è´¥</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">${errorMessage}</p>
                </div>
            `;
        }

        // ğŸ”¥ã€å®Œæ•´ä¿®å¤è„šæœ¬ã€‘è§£å†³æ•°æ®å¯¼å…¥å¤±è´¥å’Œå¼•ç”¨æ¶ˆæ¯åˆ·æ–°åæ¶ˆå¤±çš„é—®é¢˜
        // ğŸ”¥ã€é‡è¦ã€‘æ­¤å‡½æ•°æ”¯æŒ50+ç§æ•°æ®ç±»å‹çš„å®Œæ•´å¯¼å…¥ï¼ŒåŒ…å«å¼•ç”¨æ¶ˆæ¯ä¿®å¤åŠŸèƒ½
        console.log('ğŸ”§ æ­£åœ¨åº”ç”¨å®Œæ•´ç³»ç»Ÿä¿®å¤...');

        // å®Œæ•´æ•°æ®å¯¼å…¥åŠŸèƒ½ï¼ˆè¦†ç›–åŸå§‹å‡½æ•°ï¼‰
        (function fixImportIssues() {
            const originalImport = window.importDataFromFile;
            window.importDataFromFile = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        showToast('ğŸ” éªŒè¯æ–‡ä»¶æ ¼å¼...', 'info');
                        const text = await file.text();

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            throw new Error(`JSONæ ¼å¼é”™è¯¯: ${parseError.message}\nè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„å¤‡ä»½æ–‡ä»¶`);
                        }

                        if (!data || typeof data !== 'object') {
                            throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                        }

                        const items = [];
                        if (data.characters?.length) items.push(`è§’è‰²: ${data.characters.length}ä¸ª`);
                        if (data.chatMessages?.length) items.push(`æ¶ˆæ¯: ${data.chatMessages.length}æ¡`);
                        if (data.chatSettings?.length) items.push(`è®¾ç½®: ${data.chatSettings.length}ä¸ª`);

                        // ğŸ”¥ã€æ–°å¢ã€‘ç¾¤èŠç³»ç»Ÿæ•°æ®ç»Ÿè®¡
                        if (data.groupChats?.length) {
                            items.push(`ç¾¤èŠ: ${data.groupChats.length}ä¸ª`);

                            // ç»Ÿè®¡ç¾¤èŠæ¶ˆæ¯æ•°é‡ - ä»chatMessagesä¸­ç­›é€‰ç¾¤èŠæ¶ˆæ¯
                            let groupChatMessageCount = 0;
                            if (data.chatMessages?.length && data.groupChats?.length) {
                                const groupChatIds = data.groupChats.map(g => g.id);
                                groupChatMessageCount = data.chatMessages.filter(msg =>
                                    groupChatIds.includes(msg.characterId)
                                ).length;
                            }
                            if (groupChatMessageCount > 0) {
                                items.push(`ç¾¤èŠæ¶ˆæ¯: ${groupChatMessageCount}æ¡`);
                            }

                            // ç»Ÿè®¡ç¾¤èŠæˆå‘˜æ•°é‡ - ä»ç¾¤èŠå¯¹è±¡çš„memberså±æ€§ä¸­ç»Ÿè®¡
                            let groupMemberCount = 0;
                            if (data.groupChats?.length) {
                                data.groupChats.forEach(group => {
                                    if (group.members && Array.isArray(group.members)) {
                                        groupMemberCount += group.members.length;
                                    }
                                });
                            }
                            if (groupMemberCount > 0) {
                                items.push(`ç¾¤èŠæˆå‘˜: ${groupMemberCount}ä¸ª`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘è®°å¿†ç³»ç»Ÿæ•°æ®ç»Ÿè®¡
                        if (data.coreMemory?.length) items.push(`æ ¸å¿ƒè®°å¿†: ${data.coreMemory.length}æ¡`);
                        if (data.coreMemories?.length) items.push(`æ ¸å¿ƒè®°å¿†åº“: ${data.coreMemories.length}æ¡`);
                        if (data.episodicMemory?.length) items.push(`æƒ…èŠ‚è®°å¿†: ${data.episodicMemory.length}æ¡`);
                        if (data.episodicMemories?.length) items.push(`æƒ…æ™¯è®°å¿†: ${data.episodicMemories.length}æ¡`);
                        if (data.workingMemory?.length) items.push(`å·¥ä½œè®°å¿†: ${data.workingMemory.length}æ¡`);
                        if (data.memorySummaries?.length) items.push(`è®°å¿†æ€»ç»“: ${data.memorySummaries.length}æ¡`);
                        if (data.memoryEvents?.length) items.push(`è®°å¿†äº‹ä»¶: ${data.memoryEvents.length}æ¡`);
                        if (data.crossAppTimeline?.length) items.push(`æ—¶é—´çº¿: ${data.crossAppTimeline.length}æ¡`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘è¡¨æƒ…åŒ…å’Œç•Œé¢ç³»ç»Ÿ
                        if (data.customEmojis?.length) items.push(`è‡ªå®šä¹‰è¡¨æƒ…: ${data.customEmojis.length}ä¸ª`);
                        if (data.recentEmojis?.length) items.push(`æœ€è¿‘è¡¨æƒ…: ${data.recentEmojis.length}ä¸ª`);
                        if (data.wallpapers?.length) items.push(`å£çº¸: ${data.wallpapers.length}ä¸ª`);
                        if (data.appIcons?.length) items.push(`åº”ç”¨å›¾æ ‡: ${data.appIcons.length}ä¸ª`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘è§’è‰²å’Œè®¾ç½®ç³»ç»Ÿ
                        if (data.characterGroups?.length) items.push(`è§’è‰²åˆ†ç»„: ${data.characterGroups.length}ä¸ª`);
                        if (data.personas?.length) items.push(`ç”¨æˆ·é¢å…·: ${data.personas.length}ä¸ª`);
                        if (data.apiSettings?.length) items.push(`APIè®¾ç½®: ${data.apiSettings.length}ä¸ª`);
                        if (data.globalSettings?.length) items.push(`å…¨å±€è®¾ç½®: ${data.globalSettings.length}ä¸ª`);
                        if (data.characterDiaries?.length) items.push(`è§’è‰²æ—¥è®°: ${data.characterDiaries.length}æ¡`);
                        // ğŸ”¥ã€å®Œæ•´ã€‘åŠ¨æ€ç³»ç»Ÿ
                        if (data.moments?.length) items.push(`åŠ¨æ€: ${data.moments.length}æ¡`);
                        if (data.momentComments?.length) items.push(`åŠ¨æ€è¯„è®º: ${data.momentComments.length}æ¡`);
                        if (data.momentLikes?.length) items.push(`åŠ¨æ€ç‚¹èµ: ${data.momentLikes.length}æ¡`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘è®ºå›ç›¸å…³æ•°æ®ç»Ÿè®¡
                        if (data.forums?.length) items.push(`è®ºå›: ${data.forums.length}ä¸ª`);
                        if (data.forumPosts?.length) items.push(`è®ºå›å¸–å­: ${data.forumPosts.length}æ¡`);
                        if (data.forumReplies?.length) items.push(`è®ºå›å›å¤: ${data.forumReplies.length}æ¡`);
                        if (data.forumFavorites?.length) items.push(`è®ºå›æ”¶è—: ${data.forumFavorites.length}æ¡`);
                        if (data.forumPostImages?.length) items.push(`è®ºå›å›¾ç‰‡: ${data.forumPostImages.length}å¼ `);
                        if (data.forumMountedWorldbooks?.length) items.push(`è®ºå›ä¸–ç•Œä¹¦: ${data.forumMountedWorldbooks.length}ä¸ª`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘ä¸–ç•Œä¹¦ç›¸å…³æ•°æ®ç»Ÿè®¡
                        if (data.worldbooks?.length) items.push(`ä¸–ç•Œä¹¦: ${data.worldbooks.length}ä¸ª`);
                        if (data.worldbookEntries?.length) items.push(`ä¸–ç•Œä¹¦æ¡ç›®: ${data.worldbookEntries.length}æ¡`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘å…¶ä»–ç³»ç»Ÿæ•°æ®ç»Ÿè®¡
                        if (data.anniversaries?.length) items.push(`çºªå¿µæ—¥: ${data.anniversaries.length}ä¸ª`);
                        if (data.diarySettings?.length) items.push(`æ—¥è®°è®¾ç½®: ${data.diarySettings.length}ä¸ª`);
                        if (data.innerThoughts?.length) items.push(`å¿ƒå£°: ${data.innerThoughts.length}æ¡`);
                        if (data.blacklist?.length) items.push(`æ‹‰é»‘åˆ—è¡¨: ${data.blacklist.length}æ¡`);
                        if (data.blockedCharacters?.length) items.push(`è¢«æ‹‰é»‘è§’è‰²: ${data.blockedCharacters.length}ä¸ª`);
                        if (data.friendRequests?.length) items.push(`å¥½å‹ç”³è¯·: ${data.friendRequests.length}æ¡`);
                        if (data.characterStatus?.length) items.push(`è§’è‰²çŠ¶æ€: ${data.characterStatus.length}æ¡`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘çº¿ä¸‹æ¨¡å¼å’ŒéŸ³ä¹ç³»ç»Ÿ
                        if (data.offlineHistoryRecords?.length) items.push(`çº¿ä¸‹è®°å½•: ${data.offlineHistoryRecords.length}æ¡`);
                        if (data.offlineUISettings?.length) items.push(`çº¿ä¸‹ç•Œé¢è®¾ç½®: ${data.offlineUISettings.length}ä¸ª`);
                        if (data.offlinePresets?.length) items.push(`çº¿ä¸‹é¢„è®¾: ${data.offlinePresets.length}ä¸ª`);
                        if (data.musicPlaylist?.length) items.push(`éŸ³ä¹: ${data.musicPlaylist.length}é¦–`);
                        if (data.musicCovers?.length) items.push(`éŸ³ä¹å°é¢: ${data.musicCovers.length}ä¸ª`);

                        // ğŸ”¥ã€å®Œæ•´ã€‘çŸ­ä¿¡åº”ç”¨æ•°æ®ç»Ÿè®¡
                        if (data.smsContacts?.length) items.push(`çŸ­ä¿¡è”ç³»äºº: ${data.smsContacts.length}ä¸ª`);
                        if (data.smsMessages?.length) items.push(`çŸ­ä¿¡æ¶ˆæ¯: ${data.smsMessages.length}æ¡`);

                        const msg = items.length ? `å‡†å¤‡å¯¼å…¥:\n${items.join('\n')}\n\nç¡®å®šç»§ç»­ï¼Ÿ` : 'æ–‡ä»¶æ— æœ‰æ•ˆæ•°æ®ï¼Œç»§ç»­ï¼Ÿ';
                        if (!confirm(msg)) return;

                        showToast('âš¡ å¯¼å…¥ä¸­...', 'info');
                        let success = 0;
                        let errors = [];

                        // ä¿®å¤è§’è‰²å¯¼å…¥
                        if (data.characters?.length) {
                            try {
                                await db.characters.clear();
                                const chars = data.characters.filter(c => c?.name).map(c => ({
                                    ...c,
                                    id: c.id || `char_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    groupId: c.groupId || 'my_friends'
                                }));
                                await db.characters.bulkPut(chars);
                                success++;
                            } catch (e) {
                                errors.push(`è§’è‰²: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€ä¿®å¤ã€‘æ¶ˆæ¯å¯¼å…¥ï¼ˆå¤„ç†æ ¼å¼è½¬æ¢å’Œå¼•ç”¨æ¶ˆæ¯ï¼‰
                        if (data.chatMessages?.length) {
                            try {
                                console.log('ğŸ”„ ä¿®å¤è„šæœ¬ï¼šå¼€å§‹å¯¼å…¥èŠå¤©æ¶ˆæ¯');

                                // ğŸ”¥ã€æ ¼å¼æ£€æµ‹å’Œè½¬æ¢ã€‘
                                let processedMessages = [];
                                const isNewFormat = data.chatMessages.some(msg => msg.messageData);

                                if (isNewFormat) {
                                    // æ–°æ ¼å¼ï¼šç›´æ¥ä½¿ç”¨
                                    processedMessages = data.chatMessages.map(msg => ({
                                        ...msg,
                                        id: msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                    }));
                                } else {
                                    // æ—§æ ¼å¼ï¼šè½¬æ¢ä¸ºæ–°æ ¼å¼
                                    const tempChatMessages = {};
                                    for (const msg of data.chatMessages) {
                                        if (!msg?.content) continue; // è·³è¿‡æ— æ•ˆæ¶ˆæ¯

                                        const characterId = msg.characterId || 'unknown';
                                        if (!tempChatMessages[characterId]) {
                                            tempChatMessages[characterId] = [];
                                        }

                                        // ä¿®å¤å¼•ç”¨æ¶ˆæ¯
                                        const fixedMsg = { ...msg };
                                        if (msg.replyTo) {
                                            fixedMsg.replyTo = {
                                                id: msg.replyTo.id || 'unknown',
                                                content: msg.replyTo.content || '[å·²åˆ é™¤]',
                                                sender: msg.replyTo.sender || 'unknown',
                                                senderName: msg.replyTo.senderName || 'æœªçŸ¥',
                                                timestamp: msg.replyTo.timestamp || Date.now(),
                                                _fixed: true
                                            };
                                        }

                                        tempChatMessages[characterId].push(fixedMsg);
                                    }

                                    // è½¬æ¢ä¸ºæ–°æ ¼å¼
                                    let globalSequentialId = 0;
                                    for (const [characterId, messages] of Object.entries(tempChatMessages)) {
                                        for (let i = 0; i < messages.length; i++) {
                                            const message = messages[i];
                                            processedMessages.push({
                                                id: `${characterId}_${globalSequentialId++}`,
                                                characterId: characterId,
                                                timestamp: message.timestamp,
                                                messageOrder: i,
                                                originalMessageId: message.id,
                                                messageData: message
                                            });
                                        }
                                    }
                                }

                                await db.chatMessages.clear();
                                await db.chatMessages.bulkPut(processedMessages);
                                success++;
                                console.log(`âœ… ä¿®å¤è„šæœ¬ï¼šæˆåŠŸå¯¼å…¥ ${processedMessages.length} æ¡æ¶ˆæ¯`);
                            } catch (e) {
                                console.error('âŒ ä¿®å¤è„šæœ¬ï¼šæ¶ˆæ¯å¯¼å…¥å¤±è´¥:', e);
                                errors.push(`æ¶ˆæ¯: ${e.message}`);
                            }
                        }

                        // å¯¼å…¥è®¾ç½®
                        if (data.chatSettings?.length) {
                            try {
                                await db.chatSettings.clear();
                                const settings = data.chatSettings.map(s => ({
                                    ...s,
                                    id: s.id || `set_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.chatSettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`è®¾ç½®: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥å…¨å±€è®°å¿†ç³»ç»Ÿæ•°æ®
                        if (data.coreMemories?.length) {
                            try {
                                await db.coreMemories.clear();
                                const memories = data.coreMemories.map(m => ({
                                    ...m,
                                    id: m.id || `core_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.coreMemories.bulkPut(memories);
                                success++;
                            } catch (e) {
                                errors.push(`æ ¸å¿ƒè®°å¿†: ${e.message}`);
                            }
                        }

                        if (data.episodicMemories?.length) {
                            try {
                                await db.episodicMemories.clear();
                                const memories = data.episodicMemories.map(m => ({
                                    ...m,
                                    id: m.id || `episodic_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.episodicMemories.bulkPut(memories);
                                success++;
                            } catch (e) {
                                errors.push(`æƒ…èŠ‚è®°å¿†: ${e.message}`);
                            }
                        }

                        if (data.crossAppTimeline?.length) {
                            try {
                                await db.crossAppTimeline.clear();
                                const timeline = data.crossAppTimeline.map(t => ({
                                    ...t,
                                    id: t.id || `timeline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.crossAppTimeline.bulkPut(timeline);
                                success++;
                            } catch (e) {
                                errors.push(`æ—¶é—´çº¿: ${e.message}`);
                            }
                        }

                        if (data.customEmojis?.length) {
                            try {
                                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘åªæ¸…ç†ä¸ªäººè¡¨æƒ…åŒ…ï¼Œä¿æŠ¤åº“è¡¨æƒ…åŒ…
                                // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨filteræ–¹æ³•é¿å…undefinedå€¼çš„ç´¢å¼•é—®é¢˜
                                await db.customEmojis.filter(emoji => emoji.isPersonal !== false).delete();
                                const emojis = data.customEmojis.map(e => ({
                                    ...e,
                                    id: e.id || `emoji_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    isPersonal: e.isPersonal !== false ? true : false // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿isPersonalæœ‰æ˜ç¡®å€¼
                                }));
                                await db.customEmojis.bulkPut(emojis);
                                success++;
                            } catch (e) {
                                errors.push(`è¡¨æƒ…åŒ…: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥ç”¨æˆ·é¢å…·æ•°æ®
                        if (data.personas?.length) {
                            try {
                                await db.personas.clear();
                                const personas = data.personas.map(p => ({
                                    ...p,
                                    id: p.id || `persona_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.personas.bulkPut(personas);
                                success++;
                            } catch (e) {
                                errors.push(`ç”¨æˆ·é¢å…·: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥åŠ¨æ€æ•°æ®
                        if (data.moments?.length) {
                            try {
                                await db.moments.clear();
                                const moments = data.moments.map(m => ({
                                    ...m,
                                    id: m.id || `moment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.moments.bulkPut(moments);
                                success++;
                            } catch (e) {
                                errors.push(`åŠ¨æ€: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥åŠ¨æ€è¯„è®ºæ•°æ®
                        if (data.momentComments?.length) {
                            try {
                                await db.momentComments.clear();
                                const comments = data.momentComments.map(c => ({
                                    ...c,
                                    id: c.id || `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.momentComments.bulkPut(comments);
                                success++;
                            } catch (e) {
                                errors.push(`åŠ¨æ€è¯„è®º: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥è§’è‰²æ—¥è®°æ•°æ®
                        if (data.characterDiaries?.length) {
                            try {
                                await db.characterDiaries.clear();
                                const diaries = data.characterDiaries.map(d => ({
                                    ...d,
                                    id: d.id || `${d.characterId}_${d.date}`,
                                    timestamp: d.timestamp || new Date(d.date).getTime(),
                                    weather: d.weather || 'â˜€ï¸'
                                }));
                                await db.characterDiaries.bulkPut(diaries);
                                success++;
                            } catch (e) {
                                errors.push(`è§’è‰²æ—¥è®°: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥è®ºå›æ•°æ®
                        if (data.forums?.length) {
                            try {
                                await db.forums.clear();
                                const forums = data.forums.map(f => ({
                                    ...f,
                                    id: f.id || Date.now() + Math.floor(Math.random() * 1000)
                                }));
                                await db.forums.bulkPut(forums);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›: ${e.message}`);
                            }
                        }

                        if (data.forumPosts?.length) {
                            try {
                                await db.forumPosts.clear();
                                const posts = data.forumPosts.map(p => ({
                                    ...p,
                                    id: p.id || Date.now() + Math.floor(Math.random() * 1000)
                                }));
                                await db.forumPosts.bulkPut(posts);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›å¸–å­: ${e.message}`);
                            }
                        }

                        if (data.forumReplies?.length) {
                            try {
                                await db.forumReplies.clear();
                                const replies = data.forumReplies.map(r => ({
                                    ...r,
                                    id: r.id || Date.now() + Math.floor(Math.random() * 1000)
                                }));
                                await db.forumReplies.bulkPut(replies);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›å›å¤: ${e.message}`);
                            }
                        }

                        if (data.forumFavorites?.length) {
                            try {
                                await db.forumFavorites.clear();
                                const favorites = data.forumFavorites.map(f => ({
                                    ...f,
                                    id: f.id || Date.now() + Math.floor(Math.random() * 1000)
                                }));
                                await db.forumFavorites.bulkPut(favorites);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›æ”¶è—: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥ç¾¤èŠæ•°æ®
                        if (data.groupChats?.length) {
                            try {
                                await db.groupChats.clear();
                                const validGroups = data.groupChats.map(chat => ({
                                    ...chat,
                                    id: chat.id || `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.groupChats.bulkPut(validGroups);
                                success++;
                                console.log(`âœ… ä¿®å¤è„šæœ¬ï¼šæˆåŠŸå¯¼å…¥ ${validGroups.length} ä¸ªç¾¤èŠ`);
                            } catch (e) {
                                console.error('âŒ ä¿®å¤è„šæœ¬ï¼šç¾¤èŠå¯¼å…¥å¤±è´¥:', e);
                                errors.push(`ç¾¤èŠ: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€æ–°å¢ã€‘å¯¼å…¥ä¸–ç•Œä¹¦æ•°æ®
                        if (data.worldbooks?.length) {
                            try {
                                await db.worldbooks.clear();
                                const worldbooks = data.worldbooks.map(w => ({
                                    ...w,
                                    id: w.id || `wb_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.worldbooks.bulkPut(worldbooks);
                                success++;
                            } catch (e) {
                                errors.push(`ä¸–ç•Œä¹¦: ${e.message}`);
                            }
                        }

                        if (data.worldbookEntries?.length) {
                            try {
                                await db.worldbookEntries.clear();
                                const entries = data.worldbookEntries.map(e => ({
                                    ...e,
                                    id: e.id || `entry_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.worldbookEntries.bulkPut(entries);
                                success++;
                            } catch (e) {
                                errors.push(`ä¸–ç•Œä¹¦æ¡ç›®: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥è®°å¿†ç³»ç»Ÿæ•°æ®
                        if (data.workingMemory?.length) {
                            try {
                                await db.workingMemory.clear();
                                const memories = data.workingMemory.map(m => ({
                                    ...m,
                                    id: m.id || `work_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.workingMemory.bulkPut(memories);
                                success++;
                            } catch (e) {
                                errors.push(`å·¥ä½œè®°å¿†: ${e.message}`);
                            }
                        }

                        if (data.memorySummaries?.length) {
                            try {
                                await db.memorySummaries.clear();
                                const summaries = data.memorySummaries.map(s => ({
                                    ...s,
                                    id: s.id || `summary_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.memorySummaries.bulkPut(summaries);
                                success++;
                            } catch (e) {
                                errors.push(`è®°å¿†æ€»ç»“: ${e.message}`);
                            }
                        }

                        if (data.memoryEvents?.length) {
                            try {
                                await db.memoryEvents.clear();
                                const events = data.memoryEvents.map(e => ({
                                    ...e,
                                    id: e.id || `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.memoryEvents.bulkPut(events);
                                success++;
                            } catch (e) {
                                errors.push(`è®°å¿†äº‹ä»¶: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥è¡¨æƒ…åŒ…å’Œç•Œé¢ç³»ç»Ÿ
                        if (data.recentEmojis?.length) {
                            try {
                                await db.recentEmojis.clear();
                                const emojis = data.recentEmojis.map(e => ({
                                    ...e,
                                    id: e.id || `recent_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.recentEmojis.bulkPut(emojis);
                                success++;
                            } catch (e) {
                                errors.push(`æœ€è¿‘è¡¨æƒ…: ${e.message}`);
                            }
                        }

                        if (data.wallpapers?.length) {
                            try {
                                await db.wallpapers.clear();
                                const wallpapers = data.wallpapers.map(w => ({
                                    ...w,
                                    id: w.id || `wp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.wallpapers.bulkPut(wallpapers);
                                success++;
                            } catch (e) {
                                errors.push(`å£çº¸: ${e.message}`);
                            }
                        }

                        if (data.appIcons?.length) {
                            try {
                                await db.appIcons.clear();
                                const icons = data.appIcons.map(i => ({
                                    ...i,
                                    id: i.id || `icon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.appIcons.bulkPut(icons);
                                success++;
                            } catch (e) {
                                errors.push(`åº”ç”¨å›¾æ ‡: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥è§’è‰²å’Œè®¾ç½®ç³»ç»Ÿ
                        if (data.characterGroups?.length) {
                            try {
                                await db.characterGroups.clear();
                                const groups = data.characterGroups.map(g => ({
                                    ...g,
                                    id: g.id || `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.characterGroups.bulkPut(groups);
                                success++;
                            } catch (e) {
                                errors.push(`è§’è‰²åˆ†ç»„: ${e.message}`);
                            }
                        }

                        if (data.personas?.length) {
                            try {
                                await db.personas.clear();
                                const personas = data.personas.map(p => ({
                                    ...p,
                                    id: p.id || `persona_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.personas.bulkPut(personas);
                                success++;
                            } catch (e) {
                                errors.push(`ç”¨æˆ·é¢å…·: ${e.message}`);
                            }
                        }

                        if (data.apiSettings?.length) {
                            try {
                                await db.apiSettings.clear();
                                const settings = data.apiSettings.map(s => ({
                                    ...s,
                                    id: s.id || `api_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.apiSettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`APIè®¾ç½®: ${e.message}`);
                            }
                        }

                        if (data.globalSettings?.length) {
                            try {
                                await db.globalSettings.clear();
                                const settings = data.globalSettings.map(s => ({
                                    ...s,
                                    id: s.id || `global_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.globalSettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`å…¨å±€è®¾ç½®: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥åŠ¨æ€ç³»ç»Ÿ
                        if (data.momentLikes?.length) {
                            try {
                                await db.momentLikes.clear();
                                const likes = data.momentLikes.map(l => ({
                                    ...l,
                                    id: l.id || `like_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.momentLikes.bulkPut(likes);
                                success++;
                            } catch (e) {
                                errors.push(`åŠ¨æ€ç‚¹èµ: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥è®ºå›æ‰©å±•æ•°æ®
                        if (data.forumPostImages?.length) {
                            try {
                                await db.forumPostImages.clear();
                                const images = data.forumPostImages.map(i => ({
                                    ...i,
                                    id: i.id || `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.forumPostImages.bulkPut(images);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›å›¾ç‰‡: ${e.message}`);
                            }
                        }

                        if (data.forumMountedWorldbooks?.length) {
                            try {
                                await db.forumMountedWorldbooks.clear();
                                const mounted = data.forumMountedWorldbooks.map(m => ({
                                    ...m,
                                    id: m.id || `mounted_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.forumMountedWorldbooks.bulkPut(mounted);
                                success++;
                            } catch (e) {
                                errors.push(`è®ºå›ä¸–ç•Œä¹¦: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥å…¶ä»–é‡è¦ç³»ç»Ÿ
                        if (data.anniversaries?.length) {
                            try {
                                await db.anniversaries.clear();
                                const anniversaries = data.anniversaries.map(a => ({
                                    ...a,
                                    id: a.id || `anni_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.anniversaries.bulkPut(anniversaries);
                                success++;
                            } catch (e) {
                                errors.push(`çºªå¿µæ—¥: ${e.message}`);
                            }
                        }

                        if (data.diarySettings?.length) {
                            try {
                                await db.diarySettings.clear();
                                const settings = data.diarySettings.map(s => ({
                                    ...s,
                                    id: s.id || `diary_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.diarySettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`æ—¥è®°è®¾ç½®: ${e.message}`);
                            }
                        }

                        if (data.innerThoughts?.length) {
                            try {
                                await db.innerThoughts.clear();
                                const thoughts = data.innerThoughts.map(t => ({
                                    ...t,
                                    id: t.id || `thought_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.innerThoughts.bulkPut(thoughts);
                                success++;
                            } catch (e) {
                                errors.push(`å¿ƒå£°: ${e.message}`);
                            }
                        }

                        if (data.blacklist?.length) {
                            try {
                                await db.blacklist.clear();
                                const blacklist = data.blacklist.map(b => ({
                                    ...b,
                                    id: b.id || `black_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.blacklist.bulkPut(blacklist);
                                success++;
                            } catch (e) {
                                errors.push(`æ‹‰é»‘åˆ—è¡¨: ${e.message}`);
                            }
                        }

                        if (data.blockedCharacters?.length) {
                            try {
                                await db.blockedCharacters.clear();
                                const blocked = data.blockedCharacters.map(b => ({
                                    ...b,
                                    id: b.id || `blocked_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.blockedCharacters.bulkPut(blocked);
                                success++;
                            } catch (e) {
                                errors.push(`è¢«æ‹‰é»‘è§’è‰²: ${e.message}`);
                            }
                        }

                        if (data.friendRequests?.length) {
                            try {
                                await db.friendRequests.clear();
                                const requests = data.friendRequests.map(r => ({
                                    ...r,
                                    id: r.id || `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.friendRequests.bulkPut(requests);
                                success++;
                            } catch (e) {
                                errors.push(`å¥½å‹ç”³è¯·: ${e.message}`);
                            }
                        }

                        if (data.characterStatus?.length) {
                            try {
                                await db.characterStatus.clear();
                                const status = data.characterStatus.map(s => ({
                                    ...s,
                                    id: s.id || `status_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.characterStatus.bulkPut(status);
                                success++;
                            } catch (e) {
                                errors.push(`è§’è‰²çŠ¶æ€: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥çº¿ä¸‹æ¨¡å¼å’ŒéŸ³ä¹ç³»ç»Ÿ
                        if (data.offlineHistoryRecords?.length) {
                            try {
                                await db.offlineHistoryRecords.clear();
                                const records = data.offlineHistoryRecords.map(r => ({
                                    ...r,
                                    id: r.id || `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.offlineHistoryRecords.bulkPut(records);
                                success++;
                            } catch (e) {
                                errors.push(`çº¿ä¸‹è®°å½•: ${e.message}`);
                            }
                        }

                        if (data.offlineUISettings?.length) {
                            try {
                                await db.offlineUISettings.clear();
                                const settings = data.offlineUISettings.map(s => ({
                                    ...s,
                                    id: s.id || `offui_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.offlineUISettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`çº¿ä¸‹ç•Œé¢è®¾ç½®: ${e.message}`);
                            }
                        }

                        if (data.offlinePresets?.length) {
                            try {
                                await db.offlinePresets.clear();
                                const presets = data.offlinePresets.map(p => ({
                                    ...p,
                                    id: p.id || `preset_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.offlinePresets.bulkPut(presets);
                                success++;
                            } catch (e) {
                                errors.push(`çº¿ä¸‹é¢„è®¾: ${e.message}`);
                            }
                        }

                        if (data.musicPlaylist?.length) {
                            try {
                                await db.musicPlaylist.clear();
                                const playlist = data.musicPlaylist.map(m => ({
                                    ...m,
                                    id: m.id || `music_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.musicPlaylist.bulkPut(playlist);
                                success++;
                            } catch (e) {
                                errors.push(`éŸ³ä¹: ${e.message}`);
                            }
                        }

                        if (data.musicCovers?.length) {
                            try {
                                await db.musicCovers.clear();
                                const covers = data.musicCovers.map(c => ({
                                    ...c,
                                    id: c.id || `cover_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.musicCovers.bulkPut(covers);
                                success++;
                            } catch (e) {
                                errors.push(`éŸ³ä¹å°é¢: ${e.message}`);
                            }
                        }

                        // ğŸ”¥ã€å®Œæ•´ã€‘å¯¼å…¥çŸ­ä¿¡åº”ç”¨æ•°æ®
                        if (data.smsContacts?.length) {
                            try {
                                await db.smsContacts.clear();
                                const contacts = data.smsContacts.map(c => ({
                                    ...c,
                                    id: c.id || `sms_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.smsContacts.bulkPut(contacts);
                                success++;
                            } catch (e) {
                                errors.push(`çŸ­ä¿¡è”ç³»äºº: ${e.message}`);
                            }
                        }

                        if (data.smsMessages?.length) {
                            try {
                                await db.smsMessages.clear();
                                const messages = data.smsMessages.map(m => ({
                                    ...m,
                                    id: m.id || `smsg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.smsMessages.bulkPut(messages);
                                success++;
                            } catch (e) {
                                errors.push(`çŸ­ä¿¡æ¶ˆæ¯: ${e.message}`);
                            }
                        }

                        // é‡æ–°åŠ è½½
                        await loadCharacters();
                        await loadChatMessages();
                        await loadChatSettings();
                        await loadGroupChats(); // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®
                        await loadWorldbooks();
                        renderCharacterList();
                        renderMessageList();

                        // ğŸ”¥ã€æ–°å¢ã€‘é‡æ–°åŠ è½½è®ºå›å’Œä¸–ç•Œä¹¦ç•Œé¢
                        try {
                            await renderForumArchives();
                            renderWorldbookList();
                        } catch (error) {
                            console.error('âš ï¸ è®ºå›æˆ–ä¸–ç•Œä¹¦ç•Œé¢é‡æ–°åŠ è½½å¤±è´¥:', error);
                        }

                        const result = success > 0
                            ? `ğŸ‰ å¯¼å…¥æˆåŠŸ ${success} é¡¹${errors.length ? `\nâš ï¸ ${errors.length} é¡¹å¤±è´¥` : ''}`
                            : `âŒ å¯¼å…¥å¤±è´¥\n${errors.join('\n')}`;
                        showToast(result, success > 0 ? 'success' : 'error');

                    } catch (error) {
                        showToast(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                        if (error.message.includes('JSON')) {
                            setTimeout(() => alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼è¯·ç¡®ä¿æ˜¯ä»"å¯¼å‡ºæ‰€æœ‰æ•°æ®"ç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶'), 1000);
                        }
                    }
                };
                input.click();
            };
        })();

        // ä¿®å¤å¼•ç”¨æ¶ˆæ¯é—®é¢˜
        (function fixReplyIssues() {
            const originalGenerate = window.generateReplyHTML;
            window.generateReplyHTML = function(replyTo) {
                if (!replyTo) return '';

                let safe = {
                    id: replyTo.id || 'unknown',
                    senderName: replyTo.senderName || 'æœªçŸ¥',
                    content: replyTo.content || '[å·²åˆ é™¤]'
                };

                // å°è¯•æ¢å¤å¼•ç”¨å†…å®¹
                if (replyTo.id !== 'unknown' && currentChatCharacter) {
                    const msgs = chatMessages[currentChatCharacter.id] || [];
                    const original = msgs.find(m => m.id === replyTo.id);

                    if (original) {
                        // ğŸ”¥ã€ç»Ÿä¸€æ ¼å¼ã€‘æ­£ç¡®å¤„ç†æ•°ç»„æ ¼å¼çš„æ¶ˆæ¯å†…å®¹
                        if (Array.isArray(original.content)) {
                            const textPart = original.content.find(p => p.type === 'text');
                            const imagePart = original.content.find(p => p.type === 'image_url');

                            if (textPart?.text) {
                                safe.content = textPart.text;
                            } else if (imagePart) {
                                safe.content = '[å›¾ç‰‡]';
                            } else {
                                safe.content = '[å¤šåª’ä½“æ¶ˆæ¯]';
                            }
                        } else {
                            // ğŸ”¥ã€å…¼å®¹æ€§ã€‘å¤„ç†æ—§æ ¼å¼æ¶ˆæ¯
                            safe.content = original.content || '[å›¾ç‰‡]';
                        }

                        safe.senderName = getSenderDisplayName(original);
                    }
                }

                const display = truncateText(safe.content, 20);

                return `
                    <div class="reply-reference" data-reply-id="${safe.id}">
                        <div class="reply-reference-line"></div>
                        <div class="reply-reference-content">
                            <div class="reply-reference-sender">${safe.senderName}</div>
                            <div class="reply-reference-message">${display}</div>
                        </div>
                    </div>
                `;
            };
        })();


        // ğŸ”¥ã€ç§»é™¤ã€‘è‡ªåŠ¨æ¸…ç†å‡½æ•°å·²ç§»è‡³æ•°æ®åº“ç‰ˆæœ¬7çš„å‡çº§é€»è¾‘ä¸­

        // ğŸ”¥ã€æ–°å¢ã€‘æ•°æ®åº“çŠ¶æ€è¯Šæ–­å‡½æ•°
        async function diagnoseDatabaseIssue() {
            try {
                console.log('ğŸ” å¼€å§‹æ•°æ®åº“çŠ¶æ€è¯Šæ–­...');

                // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
                if (!db) {
                    console.error('âŒ æ•°æ®åº“å¯¹è±¡ä¸å­˜åœ¨');
                    return;
                }

                // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                const tables = ['crossAppTimeline', 'memoryEvents', 'characterStatus'];
                for (const tableName of tables) {
                    if (db[tableName]) {
                        console.log(`âœ… è¡¨ ${tableName} å­˜åœ¨`);

                        // å°è¯•æŸ¥è¯¢è¡¨ç»“æ„
                        try {
                            const count = await db[tableName].count();
                            console.log(`ğŸ“Š è¡¨ ${tableName} è®°å½•æ•°: ${count}`);
                        } catch (error) {
                            console.error(`âŒ æŸ¥è¯¢è¡¨ ${tableName} å¤±è´¥:`, error);
                        }
                    } else {
                        console.error(`âŒ è¡¨ ${tableName} ä¸å­˜åœ¨`);
                    }
                }

                // æµ‹è¯•æ·»åŠ ä¸€æ¡è®°å½•
                const testEvent = {
                    id: `test_${Date.now()}`,
                    characterId: 'test_character',
                    appType: 'test',
                    action: 'test_action',
                    timestamp: Date.now(),
                    context: { test: true },
                    messageId: null
                };

                try {
                    await db.crossAppTimeline.add(testEvent);
                    console.log('âœ… æµ‹è¯•è®°å½•æ·»åŠ æˆåŠŸ');

                    // åˆ é™¤æµ‹è¯•è®°å½•
                    await db.crossAppTimeline.delete(testEvent.id);
                    console.log('âœ… æµ‹è¯•è®°å½•åˆ é™¤æˆåŠŸ');
                } catch (error) {
                    console.error('âŒ æµ‹è¯•è®°å½•æ·»åŠ å¤±è´¥:', error);
                }

            } catch (error) {
                console.error('âŒ æ•°æ®åº“è¯Šæ–­å¤±è´¥:', error);
            }
        }

        // å»¶è¿Ÿæ‰§è¡Œè¯Šæ–­
        setTimeout(() => {
            diagnoseDatabaseIssue();
        }, 5000);

        // ğŸ”¥ã€æ–°å¢ã€‘ç´§æ€¥æ•°æ®æ¢å¤åŠŸèƒ½
        async function emergencyDataRecovery() {
            console.log('=== ç´§æ€¥æ•°æ®æ¢å¤å¼€å§‹ ===');

            try {
                // 1. æ£€æŸ¥IndexedDBä¸­çš„æ•°æ®
                const dbCharacters = await db.characters.toArray();
                const dbChatMessages = await db.chatMessages.toArray();
                const dbContacts = await db.contacts.toArray();

                console.log('IndexedDBè§’è‰²æ•°æ®:', dbCharacters);
                console.log('IndexedDBèŠå¤©è®°å½•:', dbChatMessages);
                console.log('IndexedDBè”ç³»äºº:', dbContacts);

                // 2. æ£€æŸ¥localStorageå¤‡ä»½
                const localCharacters = localStorage.getItem('characters');
                const localChatMessages = localStorage.getItem('chatMessages');
                const localContacts = localStorage.getItem('contacts');

                console.log('localStorageè§’è‰²å¤‡ä»½:', localCharacters ? JSON.parse(localCharacters) : null);
                console.log('localStorageèŠå¤©å¤‡ä»½:', localChatMessages ? JSON.parse(localChatMessages) : null);
                console.log('localStorageè”ç³»äººå¤‡ä»½:', localContacts ? JSON.parse(localContacts) : null);

                return {
                    indexedDB: { characters: dbCharacters, chatMessages: dbChatMessages, contacts: dbContacts },
                    localStorage: {
                        characters: localCharacters ? JSON.parse(localCharacters) : null,
                        chatMessages: localChatMessages ? JSON.parse(localChatMessages) : null,
                        contacts: localContacts ? JSON.parse(localContacts) : null
                    }
                };

            } catch (error) {
                console.error('æ•°æ®æ¢å¤æ£€æŸ¥å¤±è´¥:', error);
                return null;
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä»å¯¼å‡ºæ•°æ®æ¢å¤è§’è‰²
        async function recoverFromExportData(exportData) {
            try {
                console.log('å¼€å§‹ä»å¯¼å‡ºæ•°æ®æ¢å¤...');

                if (exportData.characters && exportData.characters.length > 0) {
                    // è¿‡æ»¤æ‰å¼ ä¸‰æå››
                    const validCharacters = exportData.characters.filter(char =>
                        char.name !== 'å¼ ä¸‰' && char.name !== 'æå››'
                    );

                    console.log('æœ‰æ•ˆè§’è‰²æ•°æ®:', validCharacters);

                    // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘æ¢å¤è§’è‰²æ•°æ®
                    await safeDataSave('characters', validCharacters);
                    characters = validCharacters;

                    // æ¢å¤è”ç³»äººåˆ—è¡¨
                    const validContactIds = validCharacters.map(char => char.id);
                    contacts = validContactIds;
                    await saveContacts();

                    console.log('è§’è‰²æ•°æ®æ¢å¤å®Œæˆ');
                }

                if (exportData.chatMessages) {
                    // æ¢å¤èŠå¤©è®°å½•
                    await db.chatMessages.clear();
                    for (const [characterId, messages] of Object.entries(exportData.chatMessages)) {
                        if (messages && messages.length > 0) {
                            for (const message of messages) {
                                await db.chatMessages.add({
                                    characterId: characterId,
                                    ...message
                                });
                            }
                        }
                    }
                    chatMessages = exportData.chatMessages;
                    console.log('èŠå¤©è®°å½•æ¢å¤å®Œæˆ');
                }

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                showToast('æ•°æ®æ¢å¤æˆåŠŸï¼', 'success');
                return true;

            } catch (error) {
                console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                showToast('æ•°æ®æ¢å¤å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ğŸš¨ã€ç´§æ€¥æ¢å¤åŠŸèƒ½ã€‘
        function addRecoveryLog(message) {
            const logDiv = document.getElementById('recovery-log');
            const logContent = document.getElementById('recovery-log-content');

            if (logDiv && logContent) {
                logDiv.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                logContent.innerHTML += `[${timestamp}] ${message}\n`;
                logContent.scrollTop = logContent.scrollHeight;
            }
        }

        async function checkDataStatus() {
            addRecoveryLog('å¼€å§‹æ£€æŸ¥æ•°æ®çŠ¶æ€...');

            try {
                // æ£€æŸ¥IndexedDBæ•°æ®
                const dbCharacters = await db.characters.toArray();
                const dbChatMessages = await db.chatMessages.toArray();
                const dbContacts = await db.contacts.toArray();

                // æ£€æŸ¥localStorageå¤‡ä»½
                const localCharacters = localStorage.getItem('characters');
                const localChatMessages = localStorage.getItem('chatMessages');
                const localContacts = localStorage.getItem('contacts');

                const statusText = `
=== æ•°æ®çŠ¶æ€æ£€æŸ¥ç»“æœ ===

ğŸ“Š IndexedDB æ•°æ®ï¼š
- è§’è‰²æ•°é‡: ${dbCharacters.length}
- èŠå¤©è®°å½•: ${dbChatMessages.length} æ¡
- è”ç³»äºº: ${dbContacts.length} ä¸ª

ğŸ“¦ localStorage å¤‡ä»½ï¼š
- è§’è‰²å¤‡ä»½: ${localCharacters ? JSON.parse(localCharacters).length : 0} ä¸ª
- èŠå¤©å¤‡ä»½: ${localChatMessages ? Object.keys(JSON.parse(localChatMessages)).length : 0} ä¸ªå¯¹è¯
- è”ç³»äººå¤‡ä»½: ${localContacts ? JSON.parse(localContacts).length : 0} ä¸ª

ğŸ” å½“å‰å†…å­˜çŠ¶æ€ï¼š
- è§’è‰²åˆ—è¡¨: ${characters.length} ä¸ª
- è”ç³»äººåˆ—è¡¨: ${contacts.length} ä¸ª
- èŠå¤©è®°å½•: ${Object.keys(chatMessages).length} ä¸ªå¯¹è¯

âš ï¸ å¼‚å¸¸è§’è‰²æ£€æµ‹ï¼š
${dbCharacters.filter(c => c.name === 'å¼ ä¸‰' || c.name === 'æå››').map(c => `- ${c.name} (ID: ${c.id})`).join('\n') || 'æœªå‘ç°å¼‚å¸¸è§’è‰²'}
                `;

                document.getElementById('data-status-result').style.display = 'block';
                document.getElementById('data-status-text').textContent = statusText;

                addRecoveryLog('æ•°æ®çŠ¶æ€æ£€æŸ¥å®Œæˆ');

            } catch (error) {
                addRecoveryLog('æ•°æ®æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ” æ·±åº¦æ•°æ®æœç´¢
        async function deepDataSearch() {
            addRecoveryLog('å¼€å§‹æ·±åº¦æœç´¢æ®‹ç•™æ•°æ®...');

            try {
                const foundData = [];

                // 1. æœç´¢æ‰€æœ‰localStorageé”®
                addRecoveryLog('æœç´¢localStorage...');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('character') || key.includes('chat'))) {
                        const value = localStorage.getItem(key);
                        if (value && value.length > 100) { // åªå…³æ³¨è¾ƒå¤§çš„æ•°æ®
                            foundData.push(`localStorage[${key}]: ${value.length} å­—ç¬¦`);

                            // ğŸ”¥ã€é‡è¦ã€‘æ£€æŸ¥ç´§æ€¥å¤‡ä»½
                            if (key === 'chatSettings_emergency_backup') {
                                foundData.push(`  âš ï¸ å‘ç°å…¨å±€ç´§æ€¥å¤‡ä»½ï¼è¿™å¯èƒ½åŒ…å«é‡è¦çš„èŠå¤©è®¾ç½®æ•°æ®`);
                                foundData.push(`  ğŸ“‹ ç‚¹å‡»ä¸‹æ–¹"æ¢å¤ç´§æ€¥å¤‡ä»½"æŒ‰é’®æ¥å°è¯•æ¢å¤`);
                            } else if (key.startsWith('chatSettings_emergency_')) {
                                const chatId = key.replace('chatSettings_emergency_', '');
                                foundData.push(`  âš ï¸ å‘ç°èŠå¤©${chatId}çš„ç´§æ€¥å¤‡ä»½ï¼`);
                                foundData.push(`  ğŸ“‹ ç‚¹å‡»ä¸‹æ–¹"æ¢å¤ç´§æ€¥å¤‡ä»½"æŒ‰é’®æ¥å°è¯•æ¢å¤`);
                            }
                        }
                    }
                }

                // 2. æœç´¢IndexedDBä¸­çš„æ‰€æœ‰è¡¨
                addRecoveryLog('æœç´¢IndexedDBæ‰€æœ‰è¡¨...');
                const allTables = ['characters', 'chatMessages', 'contacts', 'chatSettings', 'customEmojis', 'worldbooks', 'moments', 'personas', 'groupChats'];

                for (const tableName of allTables) {
                    try {
                        const data = await db[tableName].toArray();
                        if (data.length > 0) {
                            foundData.push(`IndexedDB[${tableName}]: ${data.length} æ¡è®°å½•`);

                            // ç‰¹åˆ«æ£€æŸ¥è§’è‰²ç›¸å…³æ•°æ®
                            if (tableName === 'characters') {
                                data.forEach(char => {
                                    if (char.name !== 'å¼ ä¸‰' && char.name !== 'æå››') {
                                        foundData.push(`  å‘ç°è§’è‰²: ${char.name} (ID: ${char.id})`);
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        // è¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®
                    }
                }

                // 3. æ£€æŸ¥èŠå¤©è®°å½•ä¸­çš„è§’è‰²ä¿¡æ¯
                addRecoveryLog('åˆ†æèŠå¤©è®°å½•...');
                const chatData = await db.chatMessages.toArray();
                const characterIds = new Set();
                chatData.forEach(msg => {
                    if (msg.characterId && msg.characterId !== 'user') {
                        characterIds.add(msg.characterId);
                    }
                });

                if (characterIds.size > 0) {
                    foundData.push(`èŠå¤©è®°å½•ä¸­å‘ç° ${characterIds.size} ä¸ªè§’è‰²ID:`);
                    characterIds.forEach(id => {
                        foundData.push(`  è§’è‰²ID: ${id}`);
                    });
                }

                const resultText = foundData.length > 0 ? foundData.join('\n') : 'æœªå‘ç°é¢å¤–çš„è§’è‰²æ•°æ®';

                document.getElementById('deep-search-result').style.display = 'block';
                document.getElementById('deep-search-text').textContent = resultText;

                // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœå‘ç°ä»»ä½•ç´§æ€¥å¤‡ä»½ï¼Œæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                const hasGlobalBackup = localStorage.getItem('chatSettings_emergency_backup');
                const hasIndividualBackups = Object.keys(localStorage).some(key => key.startsWith('chatSettings_emergency_'));

                if (hasGlobalBackup || hasIndividualBackups) {
                    const emergencyButton = document.createElement('button');
                    emergencyButton.textContent = 'ğŸ†˜ æ¢å¤ç´§æ€¥å¤‡ä»½æ•°æ®';
                    emergencyButton.style.cssText = `
                        width: 100%;
                        padding: 12px 20px;
                        background: #ff6b6b;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 10px;
                        transition: all 0.3s ease;
                    `;
                    emergencyButton.onclick = () => restoreEmergencyBackup();

                    const resultDiv = document.getElementById('deep-search-result');
                    // æ¸…é™¤ä¹‹å‰çš„æŒ‰é’®
                    const existingButton = resultDiv.querySelector('button');
                    if (existingButton) existingButton.remove();
                    resultDiv.appendChild(emergencyButton);
                }

                addRecoveryLog(`æ·±åº¦æœç´¢å®Œæˆï¼Œå‘ç° ${foundData.length} æ¡çº¿ç´¢`);

            } catch (error) {
                addRecoveryLog('æ·±åº¦æœç´¢å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ†˜ æ¢å¤ç´§æ€¥å¤‡ä»½æ•°æ®
        async function restoreEmergencyBackup() {
            addRecoveryLog('å¼€å§‹æ¢å¤ç´§æ€¥å¤‡ä»½æ•°æ®...');

            try {
                let backupData = {};
                let totalBackups = 0;

                // 1. æ£€æŸ¥å…¨å±€ç´§æ€¥å¤‡ä»½
                const globalBackup = localStorage.getItem('chatSettings_emergency_backup');
                if (globalBackup) {
                    try {
                        const globalData = JSON.parse(globalBackup);
                        Object.assign(backupData, globalData);
                        totalBackups++;
                        addRecoveryLog(`âœ… å‘ç°å…¨å±€ç´§æ€¥å¤‡ä»½ï¼ŒåŒ…å« ${Object.keys(globalData).length} ä¸ªèŠå¤©è®¾ç½®`);
                    } catch (parseError) {
                        addRecoveryLog('âš ï¸ å…¨å±€ç´§æ€¥å¤‡ä»½æ•°æ®æ ¼å¼é”™è¯¯: ' + parseError.message);
                    }
                }

                // 2. æ£€æŸ¥å•ä¸ªèŠå¤©çš„ç´§æ€¥å¤‡ä»½
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('chatSettings_emergency_')) {
                        const chatId = key.replace('chatSettings_emergency_', '');
                        try {
                            const chatBackup = JSON.parse(localStorage.getItem(key));
                            backupData[chatId] = chatBackup;
                            totalBackups++;
                            addRecoveryLog(`âœ… å‘ç°èŠå¤©${chatId}çš„ç´§æ€¥å¤‡ä»½`);
                        } catch (parseError) {
                            addRecoveryLog(`âš ï¸ èŠå¤©${chatId}çš„ç´§æ€¥å¤‡ä»½æ•°æ®æ ¼å¼é”™è¯¯: ${parseError.message}`);
                        }
                    }
                });

                // 3. æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°ä»»ä½•å¤‡ä»½
                if (Object.keys(backupData).length === 0) {
                    addRecoveryLog('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç´§æ€¥å¤‡ä»½æ•°æ®');
                    showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç´§æ€¥å¤‡ä»½æ•°æ®', 'error');
                    return;
                }

                addRecoveryLog(`ğŸ“¦ æ€»å…±å‘ç° ${totalBackups} ä¸ªç´§æ€¥å¤‡ä»½ï¼ŒåŒ…å« ${Object.keys(backupData).length} ä¸ªèŠå¤©è®¾ç½®`);

                // 4. æ¢å¤èŠå¤©è®¾ç½®åˆ°å…¨å±€å˜é‡
                let restoredCount = 0;
                Object.keys(backupData).forEach(chatId => {
                    if (backupData[chatId] && typeof backupData[chatId] === 'object') {
                        // ç¡®ä¿chatSettingså¯¹è±¡å­˜åœ¨
                        if (!chatSettings) {
                            chatSettings = {};
                        }

                        // æ¢å¤è®¾ç½®
                        chatSettings[chatId] = {
                            ...chatSettings[chatId], // ä¿ç•™ç°æœ‰è®¾ç½®
                            ...backupData[chatId]    // è¦†ç›–å¤‡ä»½çš„è®¾ç½®
                        };
                        restoredCount++;
                        addRecoveryLog(`  âœ… æ¢å¤èŠå¤©è®¾ç½®: ${chatId}`);
                    }
                });

                // 5. ä¿å­˜åˆ°IndexedDB
                try {
                    await saveChatSettings();
                    addRecoveryLog(`âœ… æˆåŠŸæ¢å¤ ${restoredCount} ä¸ªèŠå¤©è®¾ç½®åˆ°æ•°æ®åº“`);
                    showToast(`æˆåŠŸæ¢å¤ ${restoredCount} ä¸ªèŠå¤©è®¾ç½®`, 'success');
                } catch (saveError) {
                    addRecoveryLog('âš ï¸ ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥ï¼Œä½†è®¾ç½®å·²æ¢å¤åˆ°å†…å­˜: ' + saveError.message);
                    showToast('è®¾ç½®å·²æ¢å¤åˆ°å†…å­˜ï¼Œä½†ä¿å­˜å¤±è´¥', 'warning');
                }

                // 6. æ˜¾ç¤ºæ¢å¤çš„æ•°æ®è¯¦æƒ…
                const detailsText = Object.keys(backupData).map(chatId => {
                    const settings = backupData[chatId];
                    const details = [];
                    if (settings.bubbleStyle) details.push(`æ°”æ³¡æ ·å¼: ${settings.bubbleStyle}`);
                    if (settings.aiChatAvatar) details.push(`AIå¤´åƒ: å·²è®¾ç½®`);
                    if (settings.myChatAvatar) details.push(`ç”¨æˆ·å¤´åƒ: å·²è®¾ç½®`);
                    if (settings.backgroundImage) details.push(`èƒŒæ™¯å›¾: å·²è®¾ç½®`);
                    if (settings.fontSize) details.push(`å­—ä½“å¤§å°: ${settings.fontSize}`);

                    return `èŠå¤©ID: ${chatId}\n  - ${details.join('\n  - ')}`;
                }).join('\n\n');

                document.getElementById('deep-search-text').textContent =
                    `ğŸ†˜ ç´§æ€¥å¤‡ä»½æ¢å¤å®Œæˆï¼\n\nä» ${totalBackups} ä¸ªå¤‡ä»½æºæ¢å¤äº† ${restoredCount} ä¸ªèŠå¤©è®¾ç½®\n\næ¢å¤çš„è®¾ç½®è¯¦æƒ…ï¼š\n\n${detailsText}\n\nğŸ’¡ å»ºè®®ï¼šåˆ·æ–°é¡µé¢ä»¥ç¡®ä¿æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆ`;

                addRecoveryLog('ğŸ‰ ç´§æ€¥å¤‡ä»½æ¢å¤å®Œæˆï¼');

            } catch (error) {
                addRecoveryLog('âŒ æ¢å¤ç´§æ€¥å¤‡ä»½å¤±è´¥: ' + error.message);
                showToast('æ¢å¤ç´§æ€¥å¤‡ä»½å¤±è´¥', 'error');
                console.error('æ¢å¤ç´§æ€¥å¤‡ä»½å¤±è´¥:', error);
            }
        }

        // ğŸ’¬ ä»èŠå¤©è®°å½•æ¨æ–­è§’è‰²
        async function searchChatHistory() {
            addRecoveryLog('å¼€å§‹åˆ†æèŠå¤©è®°å½•...');

            try {
                const chatData = await db.chatMessages.toArray();
                const characterInfo = new Map();

                // åˆ†æèŠå¤©è®°å½•ï¼Œå°è¯•é‡å»ºè§’è‰²ä¿¡æ¯
                chatData.forEach(msg => {
                    if (msg.characterId && msg.characterId !== 'user') {
                        if (!characterInfo.has(msg.characterId)) {
                            characterInfo.set(msg.characterId, {
                                id: msg.characterId,
                                messageCount: 0,
                                lastMessage: null,
                                firstMessage: null
                            });
                        }

                        const info = characterInfo.get(msg.characterId);
                        info.messageCount++;

                        if (!info.firstMessage || msg.timestamp < info.firstMessage.timestamp) {
                            info.firstMessage = msg;
                        }

                        if (!info.lastMessage || msg.timestamp > info.lastMessage.timestamp) {
                            info.lastMessage = msg;
                        }
                    }
                });

                let resultText = '=== èŠå¤©è®°å½•åˆ†æç»“æœ ===\n\n';

                if (characterInfo.size === 0) {
                    resultText += 'æœªå‘ç°ä»»ä½•è§’è‰²çš„èŠå¤©è®°å½•';
                } else {
                    resultText += `å‘ç° ${characterInfo.size} ä¸ªè§’è‰²çš„èŠå¤©è®°å½•:\n\n`;

                    characterInfo.forEach((info, characterId) => {
                        resultText += `è§’è‰²ID: ${characterId}\n`;
                        resultText += `æ¶ˆæ¯æ•°é‡: ${info.messageCount} æ¡\n`;
                        resultText += `æœ€æ—©æ¶ˆæ¯: ${new Date(info.firstMessage.timestamp).toLocaleString()}\n`;
                        resultText += `æœ€æ–°æ¶ˆæ¯: ${new Date(info.lastMessage.timestamp).toLocaleString()}\n`;
                        resultText += `æœ€æ–°å†…å®¹: ${info.lastMessage.content?.substring(0, 50)}...\n\n`;
                    });

                    resultText += '\nğŸ’¡ å»ºè®®: å¦‚æœè¿™äº›IDå¯¹åº”æ‚¨ä¸¢å¤±çš„è§’è‰²ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨é‡å»ºè§’è‰²å¡';
                }

                document.getElementById('deep-search-result').style.display = 'block';
                document.getElementById('deep-search-text').textContent = resultText;

                addRecoveryLog('èŠå¤©è®°å½•åˆ†æå®Œæˆ');

            } catch (error) {
                addRecoveryLog('èŠå¤©è®°å½•åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // ğŸ”§ ä»èŠå¤©è®°å½•é‡å»ºè§’è‰²
        async function rebuildCharactersFromChat() {
            addRecoveryLog('å¼€å§‹ä»èŠå¤©è®°å½•é‡å»ºè§’è‰²...');

            try {
                const chatData = await db.chatMessages.toArray();
                const characterInfo = new Map();

                // åˆ†æèŠå¤©è®°å½•
                chatData.forEach(msg => {
                    if (msg.characterId && msg.characterId !== 'user') {
                        if (!characterInfo.has(msg.characterId)) {
                            characterInfo.set(msg.characterId, {
                                id: msg.characterId,
                                messages: [],
                                firstMessage: null,
                                lastMessage: null
                            });
                        }

                        const info = characterInfo.get(msg.characterId);
                        info.messages.push(msg);

                        if (!info.firstMessage || msg.timestamp < info.firstMessage.timestamp) {
                            info.firstMessage = msg;
                        }

                        if (!info.lastMessage || msg.timestamp > info.lastMessage.timestamp) {
                            info.lastMessage = msg;
                        }
                    }
                });

                addRecoveryLog(`å‘ç° ${characterInfo.size} ä¸ªè§’è‰²çš„èŠå¤©è®°å½•`);

                // é‡å»ºè§’è‰²å¡
                const rebuiltCharacters = [];
                let rebuiltCount = 0;

                for (const [characterId, info] of characterInfo) {
                    // è·³è¿‡å¼ ä¸‰æå››
                    if (characterId === 'å¼ ä¸‰' || characterId === 'æå››') continue;

                    // å°è¯•ä»èŠå¤©å†…å®¹æ¨æ–­è§’è‰²åå­—
                    let characterName = `è§’è‰²_${characterId.slice(-4)}`;

                    // æŸ¥æ‰¾å¯èƒ½çš„è§’è‰²åå­—ï¼ˆä»ç”¨æˆ·æ¶ˆæ¯å’Œè§’è‰²æ¶ˆæ¯ä¸­å¯»æ‰¾ï¼‰
                    const allMessages = info.messages.slice(0, 20); // æ£€æŸ¥å‰20æ¡æ¶ˆæ¯

                    // æ–¹æ³•1: ä»ç”¨æˆ·æ¶ˆæ¯ä¸­å¯»æ‰¾ç§°å‘¼
                    const userMessages = allMessages.filter(msg => msg.sender === 'sent');
                    for (const msg of userMessages) {
                        const content = msg.content || '';
                        // å¯»æ‰¾å¸¸è§çš„ç§°å‘¼æ¨¡å¼
                        const patterns = [
                            /(?:ä½ å¥½|å—¨|hi|hello)[ï¼Œ,\s]*([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})/i,
                            /([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})[ï¼Œ,\s]*(?:ä½ å¥½|åœ¨å—|åœ¨ä¸åœ¨)/i,
                            /^([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})[ï¼Œ,\s]/,
                            /å«ä½ ([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})/i
                        ];

                        for (const pattern of patterns) {
                            const nameMatch = content.match(pattern);
                            if (nameMatch && nameMatch[1] && nameMatch[1].length <= 8 && nameMatch[1].length >= 2) {
                                characterName = nameMatch[1];
                                break;
                            }
                        }
                        if (characterName !== `è§’è‰²_${characterId.slice(-4)}`) break;
                    }

                    // æ–¹æ³•2: ä»è§’è‰²çš„è‡ªæˆ‘ä»‹ç»ä¸­å¯»æ‰¾
                    if (characterName === `è§’è‰²_${characterId.slice(-4)}`) {
                        const characterMessages = allMessages.filter(msg => msg.sender === 'character');
                        for (const msg of characterMessages.slice(0, 5)) {
                            const content = msg.content || '';
                            const patterns = [
                                /æˆ‘æ˜¯([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})/i,
                                /æˆ‘å«([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})/i,
                                /å«æˆ‘([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})/i,
                                /^([^\sï¼Œ,ã€‚ï¼ï¼Ÿ]{1,8})(?:åœ¨è¿™é‡Œ|æ¥äº†|å›æ¥äº†)/i
                            ];

                            for (const pattern of patterns) {
                                const nameMatch = content.match(pattern);
                                if (nameMatch && nameMatch[1] && nameMatch[1].length <= 8 && nameMatch[1].length >= 2) {
                                    characterName = nameMatch[1];
                                    break;
                                }
                            }
                            if (characterName !== `è§’è‰²_${characterId.slice(-4)}`) break;
                        }
                    }

                    // åˆ›å»ºåŸºç¡€è§’è‰²å¡
                    const character = {
                        id: characterId,
                        name: characterName,
                        description: `ä»èŠå¤©è®°å½•æ¢å¤çš„è§’è‰²ï¼Œå…±æœ‰ ${info.messages.length} æ¡å¯¹è¯è®°å½•`,
                        personality: 'æ¸©å’Œå‹å–„ï¼Œå–„äºäº¤æµ',
                        scenario: 'æ—¥å¸¸èŠå¤©åœºæ™¯',
                        firstMessage: info.firstMessage?.content || 'ä½ å¥½ï¼',
                        avatar: '',
                        createdAt: info.firstMessage?.timestamp || Date.now(),
                        updatedAt: info.lastMessage?.timestamp || Date.now(),
                        tags: ['æ¢å¤è§’è‰²'],
                        isPublic: false,
                        messageCount: info.messages.length
                    };

                    rebuiltCharacters.push(character);
                    rebuiltCount++;

                    addRecoveryLog(`é‡å»ºè§’è‰²: ${characterName} (ID: ${characterId.slice(-6)}...)`);
                }

                if (rebuiltCharacters.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯é‡å»ºçš„è§’è‰²');
                }

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘æ¸…é™¤ç°æœ‰çš„å¼‚å¸¸è§’è‰²ï¼Œæ·»åŠ é‡å»ºçš„è§’è‰²
                await safeDataSave('characters', rebuiltCharacters);
                characters = rebuiltCharacters;

                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                contacts = rebuiltCharacters.map(char => char.id);
                await saveContacts();

                // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç›¸å…³æ•°æ®
                await loadCharacters();
                await loadContacts();
                await loadChatMessages();

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                // å¦‚æœå½“å‰åœ¨èŠå¤©ç•Œé¢ï¼Œåˆ·æ–°èŠå¤©ç•Œé¢
                if (currentCharacterId) {
                    const character = characters.find(c => c.id === currentCharacterId);
                    if (character) {
                        renderChatHeader();
                    }
                }

                addRecoveryLog(`âœ… æˆåŠŸé‡å»º ${rebuiltCount} ä¸ªè§’è‰²ï¼`);
                addRecoveryLog(`è§’è‰²åˆ—è¡¨: ${rebuiltCharacters.map(c => c.name).join(', ')}`);
                alert(`è§’è‰²é‡å»ºå®Œæˆï¼æˆåŠŸæ¢å¤ ${rebuiltCount} ä¸ªè§’è‰²ï¼ŒèŠå¤©è®°å½•å·²ä¿ç•™ã€‚\n\næ¢å¤çš„è§’è‰²: ${rebuiltCharacters.map(c => c.name).join(', ')}`);

            } catch (error) {
                addRecoveryLog('âŒ è§’è‰²é‡å»ºå¤±è´¥: ' + error.message);
                alert('è§’è‰²é‡å»ºå¤±è´¥: ' + error.message);
            }
        }

        // âœï¸ æ˜¾ç¤ºæ‰‹åŠ¨é‡å»ºç•Œé¢
        async function showManualRebuild() {
            try {
                const chatData = await db.chatMessages.toArray();
                const characterInfo = new Map();

                // åˆ†æèŠå¤©è®°å½•
                chatData.forEach(msg => {
                    if (msg.characterId && msg.characterId !== 'user' && msg.characterId !== 'å¼ ä¸‰' && msg.characterId !== 'æå››') {
                        if (!characterInfo.has(msg.characterId)) {
                            characterInfo.set(msg.characterId, {
                                id: msg.characterId,
                                messageCount: 0,
                                lastMessage: null
                            });
                        }

                        const info = characterInfo.get(msg.characterId);
                        info.messageCount++;

                        if (!info.lastMessage || msg.timestamp > info.lastMessage.timestamp) {
                            info.lastMessage = msg;
                        }
                    }
                });

                if (characterInfo.size === 0) {
                    alert('æ²¡æœ‰å‘ç°å¯é‡å»ºçš„è§’è‰²');
                    return;
                }

                // åˆ›å»ºæ‰‹åŠ¨é‡å»ºç•Œé¢
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<h4>é€‰æ‹©è¦é‡å»ºçš„è§’è‰²ï¼š</h4>';

                characterInfo.forEach((info, characterId) => {
                    const shortId = characterId.slice(-6);
                    const lastContent = info.lastMessage?.content?.substring(0, 30) || '';

                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <div style="font-weight: bold;">è§’è‰²ID: ${shortId}...</div>
                            <div style="font-size: 12px; color: #666;">æ¶ˆæ¯æ•°: ${info.messageCount} æ¡</div>
                            <div style="font-size: 12px; color: #666;">æœ€æ–°æ¶ˆæ¯: ${lastContent}...</div>
                            <input type="text" id="name_${characterId}" placeholder="è¾“å…¥è§’è‰²åå­—" style="width: 100%; margin: 5px 0; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                            <label><input type="checkbox" id="rebuild_${characterId}" checked> é‡å»ºæ­¤è§’è‰²</label>
                        </div>
                    `;
                });

                html += '</div>';
                html += '<button onclick="executeManualRebuild()" style="background: #32D74B; color: white; border: none; padding: 10px 20px; border-radius: 8px; width: 100%; margin-top: 10px;">ç¡®è®¤é‡å»ºé€‰ä¸­çš„è§’è‰²</button>';

                document.getElementById('deep-search-result').style.display = 'block';
                document.getElementById('deep-search-text').innerHTML = html;

                // å­˜å‚¨è§’è‰²ä¿¡æ¯ä¾›åç»­ä½¿ç”¨
                window.manualRebuildInfo = characterInfo;

            } catch (error) {
                alert('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ” è°ƒè¯•å½“å‰çŠ¶æ€
        async function debugCurrentState() {
            addRecoveryLog('å¼€å§‹æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€...');

            try {
                // æ£€æŸ¥å†…å­˜ä¸­çš„æ•°æ®
                addRecoveryLog(`å†…å­˜ä¸­è§’è‰²æ•°é‡: ${characters.length}`);
                addRecoveryLog(`å†…å­˜ä¸­è”ç³»äººæ•°é‡: ${contacts.length}`);

                if (characters.length > 0) {
                    addRecoveryLog('å†…å­˜ä¸­çš„è§’è‰²:');
                    characters.forEach(char => {
                        addRecoveryLog(`  - ${char.name} (ID: ${char.id.slice(-6)}...)`);
                    });
                }

                // æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®
                const dbCharacters = await db.characters.toArray();
                const dbContacts = await db.contacts.toArray();
                const dbMessages = await db.chatMessages.toArray();

                addRecoveryLog(`æ•°æ®åº“ä¸­è§’è‰²æ•°é‡: ${dbCharacters.length}`);
                addRecoveryLog(`æ•°æ®åº“ä¸­è”ç³»äººæ•°é‡: ${dbContacts.length}`);
                addRecoveryLog(`æ•°æ®åº“ä¸­æ¶ˆæ¯æ•°é‡: ${dbMessages.length}`);

                if (dbCharacters.length > 0) {
                    addRecoveryLog('æ•°æ®åº“ä¸­çš„è§’è‰²:');
                    dbCharacters.forEach(char => {
                        addRecoveryLog(`  - ${char.name} (ID: ${char.id.slice(-6)}...)`);
                    });
                }

                // æ£€æŸ¥ç•Œé¢å…ƒç´ 
                const characterListElement = document.getElementById('character-list');
                const contactListElement = document.getElementById('contact-list');

                addRecoveryLog(`è§’è‰²åˆ—è¡¨å…ƒç´ å­˜åœ¨: ${!!characterListElement}`);
                addRecoveryLog(`è”ç³»äººåˆ—è¡¨å…ƒç´ å­˜åœ¨: ${!!contactListElement}`);

                if (characterListElement) {
                    addRecoveryLog(`è§’è‰²åˆ—è¡¨å­å…ƒç´ æ•°é‡: ${characterListElement.children.length}`);
                }

                if (contactListElement) {
                    addRecoveryLog(`è”ç³»äººåˆ—è¡¨å­å…ƒç´ æ•°é‡: ${contactListElement.children.length}`);
                }

                // æ£€æŸ¥å½“å‰é¡µé¢çŠ¶æ€
                addRecoveryLog(`å½“å‰é¡µé¢: ${currentPage}`);
                addRecoveryLog(`å½“å‰è§’è‰²ID: ${currentCharacterId || 'æ— '}`);

                addRecoveryLog('çŠ¶æ€æ£€æŸ¥å®Œæˆ');

            } catch (error) {
                addRecoveryLog('çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢
        async function forceRefreshAll() {
            addRecoveryLog('å¼€å§‹å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢...');

            try {
                // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                await loadCharacters();
                await loadContacts();
                await loadChatMessages();

                addRecoveryLog(`é‡æ–°åŠ è½½åè§’è‰²æ•°é‡: ${characters.length}`);
                addRecoveryLog(`é‡æ–°åŠ è½½åè”ç³»äººæ•°é‡: ${contacts.length}`);

                // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                // å¦‚æœåœ¨èŠå¤©é¡µé¢ï¼Œåˆ·æ–°èŠå¤©ç•Œé¢
                if (currentPage === 'chat' && currentCharacterId) {
                    const character = characters.find(c => c.id === currentCharacterId);
                    if (character) {
                        renderChatHeader();
                        renderChatMessages();
                    } else {
                        // å¦‚æœå½“å‰è§’è‰²ä¸å­˜åœ¨ï¼Œè¿”å›ä¸»é¡µ
                        hideApp('api-chat-screen');
                    }
                }

                // å¦‚æœåœ¨è§’è‰²ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°è§’è‰²ç®¡ç†ç•Œé¢
                if (currentPage === 'characters') {
                    renderCharacterList();
                }

                addRecoveryLog('âœ… ç•Œé¢åˆ·æ–°å®Œæˆ');
                alert('ç•Œé¢åˆ·æ–°å®Œæˆï¼è¯·æ£€æŸ¥è§’è‰²åˆ—è¡¨æ˜¯å¦æ­£å¸¸æ˜¾ç¤ºã€‚');

            } catch (error) {
                addRecoveryLog('ç•Œé¢åˆ·æ–°å¤±è´¥: ' + error.message);
                alert('ç•Œé¢åˆ·æ–°å¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œæ‰‹åŠ¨é‡å»º
        async function executeManualRebuild() {
            try {
                const rebuiltCharacters = [];

                for (const [characterId, info] of window.manualRebuildInfo) {
                    const checkbox = document.getElementById(`rebuild_${characterId}`);
                    const nameInput = document.getElementById(`name_${characterId}`);

                    if (checkbox && checkbox.checked) {
                        const characterName = nameInput.value.trim() || `è§’è‰²_${characterId.slice(-4)}`;

                        const character = {
                            id: characterId,
                            name: characterName,
                            description: `æ‰‹åŠ¨é‡å»ºçš„è§’è‰²ï¼Œå…±æœ‰ ${info.messageCount} æ¡å¯¹è¯è®°å½•`,
                            personality: 'è¯·æ ¹æ®èŠå¤©è®°å½•è°ƒæ•´æ€§æ ¼è®¾å®š',
                            scenario: 'æ—¥å¸¸èŠå¤©åœºæ™¯',
                            firstMessage: info.lastMessage?.content || 'ä½ å¥½ï¼',
                            avatar: '',
                            createdAt: Date.now() - 86400000, // 1å¤©å‰
                            updatedAt: Date.now(),
                            tags: ['æ‰‹åŠ¨æ¢å¤'],
                            isPublic: false,
                            messageCount: info.messageCount
                        };

                        rebuiltCharacters.push(character);
                    }
                }

                if (rebuiltCharacters.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²è¿›è¡Œé‡å»º');
                    return;
                }

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘æ¸…é™¤ç°æœ‰è§’è‰²ï¼Œæ·»åŠ é‡å»ºçš„è§’è‰²
                await safeDataSave('characters', rebuiltCharacters);
                characters = rebuiltCharacters;

                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                contacts = rebuiltCharacters.map(char => char.id);
                await saveContacts();

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();

                addRecoveryLog(`âœ… æ‰‹åŠ¨é‡å»ºå®Œæˆï¼æ¢å¤äº† ${rebuiltCharacters.length} ä¸ªè§’è‰²`);
                alert(`æ‰‹åŠ¨é‡å»ºå®Œæˆï¼æˆåŠŸæ¢å¤ ${rebuiltCharacters.length} ä¸ªè§’è‰²ã€‚`);

                // éšè—é‡å»ºç•Œé¢
                document.getElementById('deep-search-result').style.display = 'none';

            } catch (error) {
                alert('æ‰‹åŠ¨é‡å»ºå¤±è´¥: ' + error.message);
            }
        }

        // ğŸ“ ä»æ–‡ä»¶æ¢å¤
        async function recoverFromFile() {
            const fileInput = document.getElementById('recovery-file-input');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤‡ä»½æ–‡ä»¶');
                return;
            }

            try {
                addRecoveryLog(`å¼€å§‹è¯»å–æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

                const text = await file.text();
                const exportData = JSON.parse(text);

                if (!exportData.characters || !Array.isArray(exportData.characters)) {
                    throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘è§’è‰²ä¿¡æ¯');
                }

                addRecoveryLog(`æ–‡ä»¶ä¸­å‘ç° ${exportData.characters.length} ä¸ªè§’è‰²`);

                // è¿‡æ»¤æ‰å¼ ä¸‰æå››
                const validCharacters = exportData.characters.filter(char =>
                    char.name !== 'å¼ ä¸‰' && char.name !== 'æå››'
                );

                addRecoveryLog(`è¿‡æ»¤åæœ‰æ•ˆè§’è‰²: ${validCharacters.length} ä¸ª`);

                if (validCharacters.length === 0) {
                    throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è§’è‰²æ•°æ®');
                }

                // ğŸ”¥ã€å®‰å…¨ä¿®å¤ã€‘æ¢å¤è§’è‰²æ•°æ®
                await safeDataSave('characters', validCharacters);
                characters = validCharacters;

                // æ¢å¤è”ç³»äººåˆ—è¡¨
                const validContactIds = validCharacters.map(char => char.id);
                contacts = validContactIds;
                await saveContacts();

                addRecoveryLog('è§’è‰²æ•°æ®æ¢å¤å®Œæˆ');

                // æ¢å¤èŠå¤©è®°å½•
                if (exportData.chatMessages) {
                    await db.chatMessages.clear();
                    let messageCount = 0;

                    for (const [characterId, messages] of Object.entries(exportData.chatMessages)) {
                        if (messages && messages.length > 0) {
                            for (const message of messages) {
                                await db.chatMessages.add({
                                    characterId: characterId,
                                    ...message
                                });
                                messageCount++;
                            }
                        }
                    }
                    chatMessages = exportData.chatMessages;
                    addRecoveryLog(`èŠå¤©è®°å½•æ¢å¤å®Œæˆ: ${messageCount} æ¡æ¶ˆæ¯`);
                }

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                addRecoveryLog('âœ… æ–‡ä»¶æ¢å¤æˆåŠŸï¼');
                alert('æ•°æ®æ¢å¤æˆåŠŸï¼æ‚¨çš„è§’è‰²å’ŒèŠå¤©è®°å½•å·²æ¢å¤ã€‚');

            } catch (error) {
                addRecoveryLog('âŒ æ–‡ä»¶æ¢å¤å¤±è´¥: ' + error.message);
                alert('æ–‡ä»¶æ¢å¤å¤±è´¥: ' + error.message);
            }
        }

        async function cleanupBadData() {
            try {
                addRecoveryLog('å¼€å§‹æ¸…ç†å¼‚å¸¸æ•°æ®...');

                // æ¸…é™¤å¼ ä¸‰æå››
                const deletedCount = await db.characters.where('name').anyOf(['å¼ ä¸‰', 'æå››']).delete();
                addRecoveryLog(`åˆ é™¤äº† ${deletedCount} ä¸ªå¼‚å¸¸è§’è‰²`);

                // æ›´æ–°å†…å­˜æ•°æ®
                characters = characters.filter(char => char.name !== 'å¼ ä¸‰' && char.name !== 'æå››');
                contacts = contacts.filter(id => {
                    const char = characters.find(c => c.id === id);
                    return char && char.name !== 'å¼ ä¸‰' && char.name !== 'æå››';
                });

                await saveContacts();

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                addRecoveryLog('âœ… å¼‚å¸¸æ•°æ®æ¸…ç†å®Œæˆ');
                alert('å¼‚å¸¸æ•°æ®æ¸…ç†å®Œæˆ');

            } catch (error) {
                addRecoveryLog('âŒ æ¸…ç†å¤±è´¥: ' + error.message);
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        async function forceReload() {
            try {
                addRecoveryLog('å¼€å§‹å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®...');

                // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                await loadCharacterGroups();
                await loadCharacters();
                await loadContacts();
                await loadChatMessages();
                await loadChatSettings();
                await loadPersonas();
                await loadGroupChats();

                // åˆ·æ–°ç•Œé¢
                renderCharacterList();
                renderContactList();
                renderMessageList();

                addRecoveryLog('âœ… æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                alert('æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');

            } catch (error) {
                addRecoveryLog('âŒ é‡æ–°åŠ è½½å¤±è´¥: ' + error.message);
                alert('é‡æ–°åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çº¿ä¸‹å‰§æƒ…æ¨¡å¼åŠŸèƒ½
        let isOfflineMode = false;
        let offlinePresets = [];
        let currentOfflinePreset = null;
        let offlineMessages = [];

        // ğŸ”¥ã€æ–°å¢ã€‘çª—å£å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç¡®ä¿ä¸åŒçª—å£çš„çº¿ä¸‹æ¨¡å¼æ•°æ®å®Œå…¨éš”ç¦»
        let windowId = null;

        // åˆå§‹åŒ–çª—å£ID
        function initializeWindowId() {
            // å°è¯•ä»sessionStorageè·å–ç°æœ‰çš„çª—å£ID
            windowId = sessionStorage.getItem('windowId');

            if (!windowId) {
                // ç”Ÿæˆæ–°çš„çª—å£ID
                windowId = `window_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                sessionStorage.setItem('windowId', windowId);
            }

            console.log('ğŸªŸ çª—å£IDå·²åˆå§‹åŒ–:', windowId);

            // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤beforeunloadç›‘å¬å™¨ï¼Œä»¥é˜²æ­¢åˆ·æ–°æ—¶æ¸…é™¤æ•°æ®
            // window.addEventListener('beforeunload', cleanupWindowOfflineData);
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘åˆ é™¤cleanupWindowOfflineDataå‡½æ•°ï¼Œä»¥é˜²æ­¢åˆ·æ–°æ—¶æ¸…é™¤æ•°æ®
        /*
        function cleanupWindowOfflineData() {
            if (!windowId) return;

            try {
                // æ¸…ç†localStorageä¸­çš„çº¿ä¸‹æ¶ˆæ¯æ•°æ®
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes(`_${windowId}`)) {
                        localStorage.removeItem(key);
                        console.log(`ğŸ§¹ æ¸…ç†çª—å£æ•°æ®: ${key}`);
                    }
                });

                console.log(`ğŸªŸ çª—å£${windowId}çš„çº¿ä¸‹æ¨¡å¼æ•°æ®å·²æ¸…ç†`);
            } catch (error) {
                console.error('æ¸…ç†çª—å£çº¿ä¸‹æ¨¡å¼æ•°æ®å¤±è´¥:', error);
            }
        }
        */

        // ğŸ”¥ã€å·²åºŸå¼ƒã€‘è¿ç§»åŠŸèƒ½å·²ç§»è‡³æ•°æ®åº“ç‰ˆæœ¬13ä¸­è‡ªåŠ¨å¤„ç†

        // åˆ‡æ¢çº¿ä¸‹æ¨¡å¼
        function toggleOfflineMode() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'warning');
                return;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘åœ¨åˆ‡æ¢æ¨¡å¼å‰ï¼Œå¼ºåˆ¶æ¸…ç©ºæ—§çš„èŠå¤©è®°å½•æ•°ç»„
            // è¿™å°†ç¡®ä¿æ¯æ¬¡éƒ½ä¸ºå½“å‰è§’è‰²åŠ è½½æ­£ç¡®çš„èŠå¤©è®°å½•
            offlineMessages = [];

            isOfflineMode = !isOfflineMode;
            const overlay = document.getElementById('offline-mode-overlay');
            const icon = document.getElementById('offline-mode-icon');
            const chatScreen = document.getElementById('api-chat-screen');
            const offlineTitle = document.getElementById('offline-mode-title');

            if (isOfflineMode) {
                // è¿›å…¥çº¿ä¸‹æ¨¡å¼
                overlay.style.display = 'flex';
                icon.className = 'fas fa-door-closed';
                chatScreen.classList.add('offline-mode-active');

                // æ›´æ–°æ ‡é¢˜ä¸ºå½“å‰è§’è‰²åå­—
                if (offlineTitle && currentChatCharacter) {
                    offlineTitle.textContent = currentChatCharacter.name;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘æš‚åœå½“å‰è§’è‰²çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨
                pauseProactiveChatTimer(currentChatCharacter.id);

                // åŠ è½½çº¿ä¸‹æ¨¡å¼çš„æ¶ˆæ¯
                loadOfflineMessages();

                // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½å¹¶åº”ç”¨ç•Œé¢è®¾ç½®
                loadAndApplyOfflineUISettings();

                showToast('å·²è¿›å…¥çº¿ä¸‹å‰§æƒ…æ¨¡å¼', 'success');
            } else {
                // é€€å‡ºçº¿ä¸‹æ¨¡å¼
                exitOfflineMode();
            }
        }

        // é€€å‡ºçº¿ä¸‹æ¨¡å¼
        function exitOfflineMode() {
            // æ£€æŸ¥æ˜¯å¦æœ‰çº¿ä¸‹æ¨¡å¼çš„èŠå¤©è®°å½•
            if (offlineMessages.length > 0) {
                showOfflineExitModal();
            } else {
                // æ²¡æœ‰èŠå¤©è®°å½•ï¼Œç›´æ¥é€€å‡º
                doExitOfflineMode();
            }
        }

        // æ˜¾ç¤ºçº¿ä¸‹æ¨¡å¼é€€å‡ºé€‰é¡¹æ¨¡æ€æ¡†
        function showOfflineExitModal() {
            const modal = document.createElement('div');
            modal.className = 'modal offline-exit-modal'; // æ·»åŠ ç‰¹å®šç±»å
            modal.style.display = 'flex';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>é€€å‡ºçº¿ä¸‹æ¨¡å¼</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>è¯·é€‰æ‹©é€€å‡ºæ–¹å¼ï¼š</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="exitWithoutSummary()">
                                <i class="fas fa-check"></i> ç»“æŸä¸”ä¸æ€»ç»“ï¼ˆæ¨èï¼‰
                            </button>
                            <button class="btn btn-secondary" onclick="exitTemporarily()">
                                <i class="fas fa-pause"></i> æš‚æ—¶ç¦»å¼€
                            </button>
                            <button class="btn" onclick="exitWithSummary()" id="summary-btn" style="background: #f8f9fa !important; color: #000000 !important; border: 1px solid #000000 !important; font-weight: bold !important;">
                                <i class="fas fa-book"></i> ç»“æŸå¹¶æ€»ç»“
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            â€¢ <strong>ç»“æŸä¸”ä¸æ€»ç»“</strong>ï¼šç»“æŸå‰§æƒ…ï¼Œå¯¹è¯è®°å½•ä¿å­˜åˆ°çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•ä¸­<br>
                            â€¢ <strong>æš‚æ—¶ç¦»å¼€</strong>ï¼šä¿ç•™å½“å‰å¯¹è¯çŠ¶æ€ï¼Œå¯ä»¥ç¨åç»§ç»­å‰§æƒ…<br>
                            â€¢ <strong>ç»“æŸå¹¶æ€»ç»“</strong>ï¼šç”ŸæˆAIå‰§æƒ…æ‘˜è¦å¹¶ä¿å­˜åˆ°è®°å¿†ç³»ç»Ÿå’ŒèŠå¤©è®°å½•ä¸­
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ğŸ”¥ã€ä¿®æ”¹ã€‘ç”Ÿæˆå‰§æƒ…æ€»ç»“å¹¶é€€å‡º
        async function exitWithSummary() {
            try {
                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const summaryButton = document.querySelector('#summary-btn');
                const originalHTML = summaryButton.innerHTML;
                summaryButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨æ€»ç»“ä¸­...';
                summaryButton.disabled = true;

                // ç¦ç”¨å…¶ä»–æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                const otherButtons = document.querySelectorAll('.offline-exit-modal .btn:not(#summary-btn)');
                otherButtons.forEach(btn => btn.disabled = true);

                showToast('æ­£åœ¨ç”Ÿæˆå‰§æƒ…æ€»ç»“...', 'info');
                await generateOfflineStorylineSummary();

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ¨¡æ€æ¡†å…³é—­
                const modal = document.querySelector('.offline-exit-modal');
                if (modal) modal.remove();

                doExitOfflineMode();
                showToast('å·²ç”Ÿæˆå‰§æƒ…æ€»ç»“å¹¶é€€å‡ºçº¿ä¸‹æ¨¡å¼', 'success');
            } catch (error) {
                console.error('ç”Ÿæˆå‰§æƒ…æ€»ç»“å¤±è´¥:', error);

                // ğŸ”¥ã€ä¿®å¤ã€‘æ¢å¤æŒ‰é’®çŠ¶æ€
                const summaryButton = document.querySelector('#summary-btn');
                if (summaryButton) {
                    summaryButton.innerHTML = '<i class="fas fa-book"></i> ç»“æŸå¹¶ç”Ÿæˆå‰§æƒ…æ€»ç»“';
                    summaryButton.disabled = false;
                }

                // æ¢å¤å…¶ä»–æŒ‰é’®çŠ¶æ€
                const otherButtons = document.querySelectorAll('.offline-exit-modal .btn:not(#summary-btn)');
                otherButtons.forEach(btn => btn.disabled = false);

                // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ¨¡æ€æ¡†å…³é—­
                const modal = document.querySelector('.offline-exit-modal');
                if (modal) modal.remove();

                doExitOfflineMode();
                showToast('ç”Ÿæˆå‰§æƒ…æ€»ç»“å¤±è´¥ï¼Œä½†å·²é€€å‡ºçº¿ä¸‹æ¨¡å¼', 'warning');
            }
        }

        // æš‚æ—¶ç¦»å¼€ï¼ˆä¸ç”Ÿæˆæ‘˜è¦ï¼‰
        function exitTemporarily() {
            // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨ç²¾ç¡®çš„é€‰æ‹©å™¨æ‰¾åˆ°é€€å‡ºæ¨¡æ€æ¡†
            const modal = document.querySelector('.offline-exit-modal');
            if (modal) {
                modal.remove();
                console.log('âœ… æš‚æ—¶ç¦»å¼€ï¼šæ¨¡æ€æ¡†å·²å…³é—­');
            } else {
                console.log('âŒ æš‚æ—¶ç¦»å¼€ï¼šæ‰¾ä¸åˆ°æ¨¡æ€æ¡†');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æš‚æ—¶ç¦»å¼€æ—¶ä¸æ¸…ç©ºæ¶ˆæ¯ï¼Œä¿æŒçº¿ä¸‹æ¨¡å¼çŠ¶æ€
            console.log(`ğŸ“ æš‚æ—¶ç¦»å¼€çº¿ä¸‹æ¨¡å¼ï¼Œä¿ç•™${offlineMessages.length}æ¡æ¶ˆæ¯`);

            doExitOfflineMode();
            showToast('å·²æš‚æ—¶ç¦»å¼€çº¿ä¸‹æ¨¡å¼', 'info');
        }

        // ç»“æŸä¸”ä¸æ€»ç»“ï¼ˆæ¨èé€‰é¡¹ï¼‰
        async function exitWithoutSummary() {
            const modal = document.querySelector('.offline-exit-modal');
            if (modal) {
                modal.remove();
                console.log('âœ… ç»“æŸä¸”ä¸æ€»ç»“ï¼šæ¨¡æ€æ¡†å·²å…³é—­');
            } else {
                console.log('âŒ ç»“æŸä¸”ä¸æ€»ç»“ï¼šæ‰¾ä¸åˆ°æ¨¡æ€æ¡†');
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å¦‚æœæœ‰èŠå¤©è®°å½•ï¼Œä¿å­˜åˆ°çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•ä¸­
            if (offlineMessages.length > 0) {
                console.log(`ğŸ“ ä¿å­˜çº¿ä¸‹æ¨¡å¼å¯¹è¯åˆ°èŠå¤©è®°å½•ä¸­ï¼Œå…±${offlineMessages.length}æ¡æ¶ˆæ¯`);

                // ç”Ÿæˆç®€å•çš„å¯¹è¯æ‘˜è¦
                const summary = `çº¿ä¸‹æ¨¡å¼å¯¹è¯è®°å½• - ${new Date().toLocaleString()} (${offlineMessages.length}æ¡æ¶ˆæ¯)`;

                // ä¿å­˜åˆ°çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•
                await saveOfflineHistoryRecord(summary, offlineMessages.slice());

                // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯å·²ç»ä¿å­˜åˆ°ä¸»èŠå¤©è®°å½•ä¸­
                // æ£€æŸ¥ä¸»èŠå¤©è®°å½•ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰çº¿ä¸‹æ¶ˆæ¯
                const characterId = currentChatCharacter.id;
                if (chatMessages[characterId]) {
                    const offlineMessagesInMain = chatMessages[characterId].filter(msg => msg.isOfflineMode);
                    console.log(`ğŸ“Š ä¸»èŠå¤©è®°å½•ä¸­çš„çº¿ä¸‹æ¶ˆæ¯: ${offlineMessagesInMain.length}æ¡`);
                    console.log(`ğŸ“Š å½“å‰çº¿ä¸‹æ¶ˆæ¯æ•°ç»„: ${offlineMessages.length}æ¡`);

                    // ç¡®ä¿ä¸»èŠå¤©è®°å½•å·²ä¿å­˜
                    await saveChatMessages(characterId);
                    console.log('âœ… å·²ç¡®ä¿çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯ä¿å­˜åˆ°ä¸»èŠå¤©è®°å½•ä¸­');
                } else {
                    console.warn('âš ï¸ ä¸»èŠå¤©è®°å½•ä¸ºç©ºï¼Œè¿™å¯èƒ½å¯¼è‡´è®°å¿†è¿æ¥é—®é¢˜');
                }

                // æ¸…ç©ºçº¿ä¸‹æ¶ˆæ¯è®°å½•
                offlineMessages = [];
                saveOfflineMessages(); // ä¿å­˜æ¸…ç©ºçŠ¶æ€åˆ°localStorage

                showToast('å·²ç»“æŸçº¿ä¸‹æ¨¡å¼ï¼Œå¯¹è¯å·²ä¿å­˜åˆ°èŠå¤©è®°å½•', 'success');
            } else {
                console.log('ğŸ“ æ²¡æœ‰çº¿ä¸‹æ¨¡å¼å¯¹è¯éœ€è¦ä¿å­˜');
                showToast('å·²ç»“æŸçº¿ä¸‹æ¨¡å¼', 'success');
            }

            doExitOfflineMode();
        }

        // å®é™…æ‰§è¡Œé€€å‡ºçº¿ä¸‹æ¨¡å¼
        function doExitOfflineMode() {
            isOfflineMode = false;
            const overlay = document.getElementById('offline-mode-overlay');
            const icon = document.getElementById('offline-mode-icon');
            const chatScreen = document.getElementById('api-chat-screen');

            overlay.style.display = 'none';
            icon.className = 'fas fa-door-open';
            chatScreen.classList.remove('offline-mode-active');

            // ğŸ”¥ã€æ–°å¢ã€‘æ¢å¤å½“å‰è§’è‰²çš„ä¸»åŠ¨å‘æ¶ˆæ¯è®¡æ—¶å™¨
            if (currentChatCharacter) {
                resumeProactiveChatTimer(currentChatCharacter.id);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç©ºçº¿ä¸‹æ¨¡å¼ç•Œé¢å†…å®¹
            const offlineMessagesContainer = document.getElementById('offline-chat-messages');
            if (offlineMessagesContainer) {
                offlineMessagesContainer.innerHTML = '';
                console.log('âœ… å·²æ¸…ç©ºçº¿ä¸‹æ¨¡å¼ç•Œé¢å†…å®¹');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ç”Ÿæˆçº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“
        async function generateOfflineStorylineSummary() {
            if (!currentChatCharacter || offlineMessages.length === 0) {
                return;
            }

            console.log('ğŸ“– å¼€å§‹ç”Ÿæˆçº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“...');

            try {
                // æ„å»ºå¯¹è¯å†å²
                let conversationHistory = '';
                offlineMessages.forEach((msg, index) => {
                    const role = msg.sender === 'user' ? 'ç”¨æˆ·' : currentChatCharacter.name;
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                    const messageContent = safeExtractMessageContent(msg);
                    conversationHistory += `${role}ï¼š${messageContent}\n`;
                });

                // ğŸ”¥ã€ä¿®æ”¹ã€‘æ„å»ºå‰§æƒ…æ€»ç»“ç”Ÿæˆpromptï¼Œç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸‰äººç§°
                const summaryPrompt = `è¯·ä¸ºä»¥ä¸‹çº¿ä¸‹å‰§æƒ…æ¨¡å¼çš„å¯¹è¯ç”Ÿæˆä¸€ä¸ªç®€æ´å®¢è§‚çš„å‰§æƒ…æ€»ç»“ï¼Œè¦æ±‚ï¼š
1. ä½¿ç”¨å®¢è§‚çš„ä¸Šå¸è§†è§’ï¼ŒåŠ å…¥åˆç†çš„æ–‡å­¦æ€§æå†™
2. é¿å…è¿‡å¤šçš„ä¿®è¾å’Œå½¢å®¹è¯
3. ç®€æ˜æ‰¼è¦åœ°æè¿°äº‹ä»¶å‘ç”Ÿçš„é¡ºåºå’Œå…³é”®æƒ…èŠ‚ä¸ç»†èŠ‚
4. ä¸è¦æ·»åŠ ä»»ä½•ä¸åœ¨åŸæ–‡ä¸­çš„æƒ…æ„Ÿæå†™
5. ä½¿ç”¨æ¸…æ™°çš„æ—¶é—´å’Œå› æœå…³ç³»
6. ç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°ï¼šç”¨"ç”¨æˆ·"æŒ‡ä»£ç”¨æˆ·ï¼Œç”¨"${currentChatCharacter.name}"æŒ‡ä»£è§’è‰²
7. ä¸è¦ä½¿ç”¨"æˆ‘"ã€"ä½ "ç­‰ç¬¬ä¸€ã€ç¬¬äºŒäººç§°

è§’è‰²ä¿¡æ¯ï¼š
${currentChatCharacter.name}

å¯¹è¯å†å²ï¼š
${conversationHistory}

è¯·ç”Ÿæˆä¸€ä¸ª200-800å­—çš„å®¢è§‚å‰§æƒ…æ€»ç»“ï¼Œè¦æ±‚ï¼š
1. æŒ‰æ—¶é—´é¡ºåºè®°å½•å‘ç”Ÿçš„ä¸»è¦äº‹ä»¶
2. å®¢è§‚æè¿°è§’è‰²çš„è¡Œä¸ºå’Œå¯¹è¯è¦ç‚¹ï¼Œä½¿ç”¨"ç”¨æˆ·"å’Œ"${currentChatCharacter.name}"æ¥æŒ‡ä»£åŒæ–¹
3. è®°å½•é‡è¦çš„æƒ…èŠ‚è½¬æŠ˜å’Œç»“æœ
4. é¿å…è¿‡åº¦çš„ä¸»è§‚æƒ…æ„Ÿæè¿°å’Œè¿‡åº¦ä¿®é¥°
5. ä½¿ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€
6. é‡ç‚¹è®°å½•å…³é”®ç»†èŠ‚å’Œå¯¹åç»­å‰§æƒ…æœ‰å½±å“çš„å…³é”®ä¿¡æ¯
7. ä¸¥æ ¼ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼šç”¨æˆ·åšäº†ä»€ä¹ˆï¼Œ${currentChatCharacter.name}å¦‚ä½•å›åº”

è¯·ä»¥å®¢è§‚è®°å½•çš„æ–¹å¼æ€»ç»“è¿™æ®µå‰§æƒ…ï¼š`;

                console.log('ğŸ“– å‰§æƒ…æ€»ç»“ç”Ÿæˆprompt:', summaryPrompt);

                // è°ƒç”¨APIç”Ÿæˆæ‘˜è¦
                const summary = await callOfflineChatAPI(summaryPrompt, currentChatCharacter);

                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå®Œæ•´çš„æ€»ç»“å†…å®¹
                console.log('ğŸ“– ç”Ÿæˆçš„å®Œæ•´å‰§æƒ…æ€»ç»“:', summary);

                if (summary && summary.trim()) {
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä¿å­˜åˆ°è·¨åº”ç”¨æ—¶é—´çº¿æ•°æ®åº“ï¼Œä½¿ç”¨æ­£ç¡®çš„è¡¨åå’Œå­—æ®µç»“æ„
                    const timelineMemory = {
                        id: `offline_summary_${currentChatCharacter.id}_${Date.now()}`, // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ å¿…éœ€çš„ä¸»é”®
                        characterId: currentChatCharacter.id,
                        appType: 'offline_mode',
                        action: 'storyline_summary',
                        timestamp: Date.now(),
                        context: {
                            type: 'offline_storyline',
                            content: `[å‰§æƒ…æ¨¡å¼] ${summary.trim()}`,
                            date: new Date().toISOString().split('T')[0],
                            messageCount: offlineMessages.length,
                            importance: 0.9 // å‰§æƒ…æ€»ç»“é‡è¦æ€§å¾ˆé«˜
                        },
                        messageId: `offline_summary_${Date.now()}`
                    };

                    await db.crossAppTimeline.add(timelineMemory);
                    console.log('ğŸ“– çº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“å·²ä¿å­˜åˆ°è·¨åº”ç”¨æ—¶é—´çº¿:', timelineMemory);

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜èŠå¤©è®°å½•åˆ°å†å²è®°å½•
                    saveOfflineHistoryRecord(summary.trim(), offlineMessages.slice());

                    // ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯å·²ç»ä¿å­˜åˆ°ä¸»èŠå¤©è®°å½•ä¸­
                    // æ£€æŸ¥ä¸»èŠå¤©è®°å½•ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰çº¿ä¸‹æ¶ˆæ¯
                    const characterId = currentChatCharacter.id;
                    if (chatMessages[characterId]) {
                        const offlineMessagesInMain = chatMessages[characterId].filter(msg => msg.isOfflineMode);
                        console.log(`ğŸ“Š ä¸»èŠå¤©è®°å½•ä¸­çš„çº¿ä¸‹æ¶ˆæ¯: ${offlineMessagesInMain.length}æ¡`);
                        console.log(`ğŸ“Š å½“å‰çº¿ä¸‹æ¶ˆæ¯æ•°ç»„: ${offlineMessages.length}æ¡`);

                        // ç¡®ä¿ä¸»èŠå¤©è®°å½•å·²ä¿å­˜
                        await saveChatMessages(characterId);
                        console.log('âœ… å·²ç¡®ä¿çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯ä¿å­˜åˆ°ä¸»èŠå¤©è®°å½•ä¸­');
                    } else {
                        console.warn('âš ï¸ ä¸»èŠå¤©è®°å½•ä¸ºç©ºï¼Œè¿™å¯èƒ½å¯¼è‡´è®°å¿†è¿æ¥é—®é¢˜');
                    }

                    // ğŸ”¥ã€ä¿®å¤ã€‘æ¸…ç©ºçº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
                    offlineMessages = [];
                    saveOfflineMessages();
                } else {
                    throw new Error('ç”Ÿæˆçš„å‰§æƒ…æ€»ç»“ä¸ºç©º');
                }

            } catch (error) {
                console.error('ç”Ÿæˆçº¿ä¸‹æ¨¡å¼å‰§æƒ…æ€»ç»“å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºçº¿ä¸‹é¢„è®¾è®¾ç½®
        function showOfflinePresetSettings() {
            document.getElementById('offline-preset-modal').style.display = 'flex';

            // åŠ è½½å¹¶æ˜¾ç¤ºå·²ä¿å­˜çš„é¢„è®¾
            loadAndDisplayPresets();

            // æ¸…ç©ºè¡¨å•
            clearPresetForm();
        }

        // å…³é—­çº¿ä¸‹é¢„è®¾è®¾ç½®
        function closeOfflinePresetSettings() {
            document.getElementById('offline-preset-modal').style.display = 'none';
            // æ¸…ç†ç¼–è¾‘çŠ¶æ€
            delete window.editingPresetId;
        }

        // æ¸…ç©ºé¢„è®¾è¡¨å•
        function clearPresetForm() {
            document.getElementById('offline-preset-name').value = '';
            document.getElementById('offline-preset-content').value = '';
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºå·²ä¿å­˜çš„é¢„è®¾
        async function loadAndDisplayPresets() {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä»Dexieæ•°æ®åº“åŠ è½½é¢„è®¾ï¼Œé¿å…isGlobalå­—æ®µçš„ç´¢å¼•é—®é¢˜
                const allPresets = await db.offlinePresets.toArray();
                const presets = allPresets.filter(preset => preset.isGlobal === true);
                const container = document.getElementById('saved-presets-list');

                container.innerHTML = '';

                if (presets.length === 0) {
                    return; // CSSä¼šæ˜¾ç¤º"æš‚æ— ä¿å­˜çš„é¢„è®¾"
                }

                // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                presets.sort((a, b) => b.timestamp - a.timestamp);

                presets.forEach(preset => {
                    const presetDiv = document.createElement('div');
                    presetDiv.className = 'preset-item';
                    if (currentOfflinePreset && currentOfflinePreset.id === preset.id) {
                        presetDiv.classList.add('active');
                    }

                    const presetInfo = document.createElement('div');
                    presetInfo.className = 'preset-info';

                    const presetName = document.createElement('div');
                    presetName.className = 'preset-name';
                    presetName.textContent = preset.name;

                    const presetPreview = document.createElement('div');
                    presetPreview.className = 'preset-preview';
                    presetPreview.textContent = preset.content.substring(0, 50) + (preset.content.length > 50 ? '...' : '');

                    presetInfo.appendChild(presetName);
                    presetInfo.appendChild(presetPreview);

                    const presetActions = document.createElement('div');
                    presetActions.className = 'preset-actions';

                    // ä½¿ç”¨æŒ‰é’®
                    const useBtn = document.createElement('button');
                    useBtn.className = 'preset-action-btn use-btn';
                    useBtn.innerHTML = '<i class="fas fa-check"></i>';
                    useBtn.title = 'ä½¿ç”¨æ­¤é¢„è®¾';
                    useBtn.onclick = () => usePreset(preset);

                    // ç¼–è¾‘æŒ‰é’®
                    const editBtn = document.createElement('button');
                    editBtn.className = 'preset-action-btn edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'ç¼–è¾‘é¢„è®¾';
                    editBtn.onclick = () => editPreset(preset);

                    // åˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'preset-action-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'åˆ é™¤é¢„è®¾';
                    deleteBtn.onclick = () => deletePreset(preset.id);

                    presetActions.appendChild(useBtn);
                    presetActions.appendChild(editBtn);
                    presetActions.appendChild(deleteBtn);

                    presetDiv.appendChild(presetInfo);
                    presetDiv.appendChild(presetActions);

                    container.appendChild(presetDiv);
                });

                console.log(`âœ… åŠ è½½äº† ${presets.length} ä¸ªçº¿ä¸‹æ¨¡å¼é¢„è®¾`);
            } catch (error) {
                console.error('âŒ åŠ è½½çº¿ä¸‹æ¨¡å¼é¢„è®¾å¤±è´¥:', error);
                showToast('åŠ è½½é¢„è®¾å¤±è´¥', 'error');
            }
        }

        // ä½¿ç”¨é¢„è®¾
        function usePreset(preset) {
            currentOfflinePreset = preset;
            loadAndDisplayPresets(); // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
            showToast(`å·²å¯ç”¨é¢„è®¾"${preset.name}"`, 'success');
        }

        // ç¼–è¾‘é¢„è®¾
        function editPreset(preset) {
            document.getElementById('offline-preset-name').value = preset.name;
            document.getElementById('offline-preset-content').value = preset.content;

            // ä¸´æ—¶å­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„é¢„è®¾ID
            window.editingPresetId = preset.id;
        }

        // åˆ é™¤é¢„è®¾
        async function deletePreset(presetId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) {
                return;
            }

            try {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä»Dexieæ•°æ®åº“åˆ é™¤é¢„è®¾
                const preset = await db.offlinePresets.get(presetId);
                if (!preset) {
                    showToast('é¢„è®¾ä¸å­˜åœ¨', 'warning');
                    return;
                }

                await db.offlinePresets.delete(presetId);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä½¿ç”¨çš„é¢„è®¾ï¼Œæ¸…ç©ºå½“å‰é¢„è®¾
                if (currentOfflinePreset && currentOfflinePreset.id === presetId) {
                    currentOfflinePreset = null;
                }

                await loadAndDisplayPresets(); // åˆ·æ–°åˆ—è¡¨
                showToast(`é¢„è®¾"${preset.name}"å·²åˆ é™¤`, 'info');
                console.log(`âœ… åˆ é™¤é¢„è®¾: ${preset.name} (${presetId})`);
            } catch (error) {
                console.error('âŒ åˆ é™¤é¢„è®¾å¤±è´¥:', error);
                showToast('åˆ é™¤é¢„è®¾å¤±è´¥', 'error');
            }
        }

        // ä¿å­˜çº¿ä¸‹é¢„è®¾
        async function saveOfflinePreset() {
            const name = document.getElementById('offline-preset-name').value.trim();
            const content = document.getElementById('offline-preset-content').value.trim();

            if (!name) {
                showToast('è¯·è¾“å…¥é¢„è®¾åç§°', 'warning');
                return;
            }

            if (!content) {
                showToast('è¯·è¾“å…¥é¢„è®¾å†…å®¹', 'warning');
                return;
            }

            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘ç°æœ‰é¢„è®¾
                if (window.editingPresetId) {
                    // ğŸ”¥ã€ä¿®æ”¹ã€‘æ›´æ–°Dexieæ•°æ®åº“ä¸­çš„é¢„è®¾
                    const existingPreset = await db.offlinePresets.get(window.editingPresetId);
                    if (existingPreset) {
                        // æ›´æ–°ç°æœ‰é¢„è®¾
                        existingPreset.name = name;
                        existingPreset.content = content;
                        existingPreset.timestamp = Date.now(); // æ›´æ–°æ—¶é—´æˆ³

                        await db.offlinePresets.put(existingPreset);

                        // å¦‚æœæ­£åœ¨ç¼–è¾‘çš„æ˜¯å½“å‰ä½¿ç”¨çš„é¢„è®¾ï¼Œæ›´æ–°å½“å‰é¢„è®¾
                        if (currentOfflinePreset && currentOfflinePreset.id === window.editingPresetId) {
                            currentOfflinePreset = existingPreset;
                        }

                        delete window.editingPresetId;

                        await loadAndDisplayPresets(); // åˆ·æ–°åˆ—è¡¨
                        clearPresetForm();
                        showToast(`é¢„è®¾"${name}"å·²æ›´æ–°`, 'success');
                        console.log(`âœ… æ›´æ–°é¢„è®¾: ${name} (${existingPreset.id})`);
                        return;
                    }
                    delete window.editingPresetId;
                }

                // ğŸ”¥ã€ä¿®æ”¹ã€‘åˆ›å»ºæ–°é¢„è®¾å¹¶ä¿å­˜åˆ°Dexieæ•°æ®åº“
                const preset = {
                    id: `preset_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: name,
                    content: content,
                    timestamp: Date.now(),
                    isGlobal: true
                };

                await db.offlinePresets.add(preset);

                // è®¾ç½®ä¸ºå½“å‰é¢„è®¾
                currentOfflinePreset = preset;

                await loadAndDisplayPresets(); // åˆ·æ–°åˆ—è¡¨
                clearPresetForm();
                showToast(`é¢„è®¾"${name}"å·²ä¿å­˜å¹¶å¯ç”¨`, 'success');
                console.log(`âœ… ä¿å­˜æ–°é¢„è®¾: ${name} (${preset.id})`);
            } catch (error) {
                console.error('âŒ ä¿å­˜é¢„è®¾å¤±è´¥:', error);
                showToast('ä¿å­˜é¢„è®¾å¤±è´¥', 'error');
            }
        }

        // åŠ è½½çº¿ä¸‹æ¶ˆæ¯
        function loadOfflineMessages() {
            if (!currentChatCharacter || !windowId) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘åªæœ‰å½“offlineMessagesä¸ºç©ºæ—¶æ‰ä»localStorageåŠ è½½
            // è¿™æ ·å¯ä»¥é¿å…åœ¨é€€å‡ºåé‡æ–°è¿›å…¥æ—¶é‡æ–°åŠ è½½å·²æ¸…ç©ºçš„æ•°æ®
            if (!offlineMessages || offlineMessages.length === 0) {
                // ğŸ”¥ã€ä¿®å¤ã€‘åŠ å…¥çª—å£IDï¼Œç¡®ä¿ä¸åŒçª—å£çš„çº¿ä¸‹æ¶ˆæ¯å®Œå…¨éš”ç¦»
                const key = `offlineMessages_${currentChatCharacter.id}_${windowId}`;
                offlineMessages = JSON.parse(localStorage.getItem(key) || '[]');
                console.log(`ğŸ“± ä»localStorageåŠ è½½çº¿ä¸‹æ¶ˆæ¯ (çª—å£${windowId}): ${offlineMessages.length}æ¡`);
            } else {
                console.log(`ğŸ“± ä½¿ç”¨å†…å­˜ä¸­çš„çº¿ä¸‹æ¶ˆæ¯ (çª—å£${windowId}): ${offlineMessages.length}æ¡`);
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘åŠ è½½å…¨å±€é¢„è®¾ä»Dexieæ•°æ®åº“
            loadLatestOfflinePreset();

            renderOfflineMessages();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘åŠ è½½æœ€æ–°çš„çº¿ä¸‹æ¨¡å¼é¢„è®¾
        async function loadLatestOfflinePreset() {
            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘é¿å…isGlobalå­—æ®µçš„ç´¢å¼•é—®é¢˜
                const allPresets = await db.offlinePresets.toArray();
                const presets = allPresets.filter(preset => preset.isGlobal === true);

                if (presets.length > 0) {
                    // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä½¿ç”¨æœ€æ–°çš„é¢„è®¾
                    presets.sort((a, b) => b.timestamp - a.timestamp);
                    currentOfflinePreset = presets[0];
                    console.log(`âœ… åŠ è½½æœ€æ–°é¢„è®¾: ${currentOfflinePreset.name}`);
                } else {
                    currentOfflinePreset = null;
                    console.log('ğŸ“ æ²¡æœ‰å¯ç”¨çš„çº¿ä¸‹æ¨¡å¼é¢„è®¾');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½çº¿ä¸‹æ¨¡å¼é¢„è®¾å¤±è´¥:', error);
                currentOfflinePreset = null;
            }
        }

        // æ¸²æŸ“çº¿ä¸‹æ¶ˆæ¯
        function renderOfflineMessages() {
            const container = document.getElementById('offline-chat-messages');
            container.innerHTML = '';

            offlineMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `offline-message ${message.sender}`;
                messageDiv.dataset.messageId = message.id;

                // æ·»åŠ å¤´åƒ
                const avatarDiv = document.createElement('div');
                avatarDiv.className = `offline-avatar ${message.sender === 'user' ? 'user-avatar' : 'ai-avatar'}`;

                if (message.sender === 'user') {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è·å–ç”¨æˆ·èº«ä»½é¢å…·å¡å¤´åƒ
                    let userAvatar = null;
                    let userName = 'ç”¨æˆ·';

                    // è·å–å½“å‰èŠå¤©è®¾ç½®
                    const chatSettings = getCurrentChatSettings();

                    // ä¼˜å…ˆçº§1ï¼šèŠå¤©ä¸“å±å¤´åƒè®¾ç½®
                    if (chatSettings.myChatAvatar) {
                        userAvatar = chatSettings.myChatAvatar;
                    }

                    // ä¼˜å…ˆçº§2ï¼šèº«ä»½é¢å…·å¡å¤´åƒ
                    if (!userAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona) {
                            userAvatar = selectedPersona.avatarUrl;
                            userName = selectedPersona.name;
                        }
                    }

                    // ä¼˜å…ˆçº§3ï¼šå…¨å±€ç”¨æˆ·å¤´åƒ
                    if (!userAvatar && window.userAvatar) {
                        userAvatar = window.userAvatar;
                    }

                    if (userAvatar && userAvatar.trim()) {
                        avatarDiv.style.backgroundImage = `url(${userAvatar})`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.textContent = '';
                    } else {
                        // ä½¿ç”¨é»˜è®¤å¤´åƒç”Ÿæˆå‡½æ•°
                        const defaultAvatar = createDefaultAvatar(userName);
                        avatarDiv.style.backgroundImage = `url(${defaultAvatar})`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.textContent = '';
                    }
                } else {
                    // ğŸ”¥ã€ä¿®å¤ã€‘æ­£ç¡®è·å–è§’è‰²å¤´åƒ
                    let aiAvatar = null;

                    if (currentChatCharacter) {
                        // è·å–å½“å‰èŠå¤©è®¾ç½®
                        const chatSettings = getCurrentChatSettings();

                        // ä¼˜å…ˆçº§1ï¼šèŠå¤©ä¸“å±å¤´åƒ
                        if (chatSettings.aiChatAvatar) {
                            aiAvatar = chatSettings.aiChatAvatar;
                        }
                        // ä¼˜å…ˆçº§2ï¼šè§’è‰²å¡åŸå§‹å¤´åƒ
                        else if (currentChatCharacter.avatarUrl) {
                            aiAvatar = currentChatCharacter.avatarUrl;
                        }
                        // ä¼˜å…ˆçº§3ï¼šè§’è‰²å¡avatarå­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰
                        else if (currentChatCharacter.avatar) {
                            aiAvatar = currentChatCharacter.avatar;
                        }
                    }

                    if (aiAvatar && aiAvatar.trim()) {
                        avatarDiv.style.backgroundImage = `url(${aiAvatar})`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.textContent = '';
                    } else {
                        // ä½¿ç”¨é»˜è®¤å¤´åƒç”Ÿæˆå‡½æ•°
                        const characterName = currentChatCharacter?.name || 'AI';
                        const defaultAvatar = createDefaultAvatar(characterName);
                        avatarDiv.style.backgroundImage = `url(${defaultAvatar})`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.textContent = '';
                    }
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'offline-message-content';
                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä½¿ç”¨æ–°çš„æ ¼å¼åŒ–å‡½æ•°å¤„ç†æ–‡æœ¬
                contentDiv.innerHTML = formatOfflineText(message.content);

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);

                // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ºæ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨æˆ·å’ŒAIï¼‰æ·»åŠ é•¿æŒ‰åŠŸèƒ½
                addOfflineMessageLongPressListener(messageDiv, message.id);

                container.appendChild(messageDiv);
            });

            // ğŸ”¥ã€ä¿®å¤ã€‘ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ - ä½¿ç”¨å»¶è¿Ÿå’ŒrequestAnimationFrameç¡®ä¿DOMæ›´æ–°å®Œæˆ
            setTimeout(() => {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }, 50);

            // ğŸ”¥ã€æ–°å¢ã€‘åº”ç”¨ç•Œé¢è®¾ç½®åˆ°æ–°æ¸²æŸ“çš„æ¶ˆæ¯
            applyOfflineUISettings();
        }

        // å‘é€çº¿ä¸‹æ¶ˆæ¯
        async function sendOfflineMessage() {
            const input = document.getElementById('offline-input');
            const content = input.value.trim();

            if (!content) return;
            if (!currentChatCharacter) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘å°†çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯ç›´æ¥å­˜å‚¨åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œä¿è¯æ—¶é—´çº¿è¿è´¯æ€§
            const characterId = currentChatCharacter.id;

            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }

            const userChatMessage = {
                id: Date.now(),
                sender: 'sent', // ä½¿ç”¨æ ‡å‡†çš„senderæ ¼å¼
                content: content,
                timestamp: Date.now(),
                type: 'text',
                isOfflineMode: true // æ ‡è®°ä¸ºçº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
            };

            chatMessages[characterId].push(userChatMessage);

            // ä¿å­˜åˆ°ä¸»èŠå¤©è®°å½•ä¸­
            // ğŸ”¥ã€ä¼˜åŒ–ã€‘çº¿ä¸‹æ¨¡å¼ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨é«˜æ•ˆä¿å­˜
            try {
                await saveChatMessagesImmediate([characterId]);
                console.log('âœ… [é«˜æ•ˆçº¿ä¸‹ç”¨æˆ·æ¶ˆæ¯] æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
            } catch (error) {
                console.error('çº¿ä¸‹ç”¨æˆ·æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æŒ‡å®šè§’è‰²ä¿å­˜:', error);
                await saveChatMessages(characterId);
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°çº¿ä¸‹æ¨¡å¼æ˜¾ç¤º
            const userMessage = {
                id: Date.now().toString(),
                sender: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };

            offlineMessages.push(userMessage);
            input.value = '';
            renderOfflineMessages();

            // ä¿å­˜çº¿ä¸‹æ¶ˆæ¯
            saveOfflineMessages();

            // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºAIå›å¤åŠ è½½åŠ¨ç”»
            showOfflineLoadingMessage();

            // ç”ŸæˆAIå›å¤
            try {
                const aiResponse = await generateOfflineResponse(content);

                // ğŸ”¥ã€ä¿®å¤ã€‘å°†AIå›å¤æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œä¿è¯æ—¶é—´çº¿è¿è´¯æ€§
                const aiChatMessage = {
                    id: Date.now() + 1,
                    sender: 'received', // ä½¿ç”¨æ ‡å‡†çš„senderæ ¼å¼
                    content: aiResponse,
                    timestamp: Date.now() + 1,
                    type: 'text',
                    isOfflineMode: true // æ ‡è®°ä¸ºçº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
                };

                chatMessages[characterId].push(aiChatMessage);
                // ğŸ”¥ã€ä¿®å¤ã€‘çº¿ä¸‹æ¨¡å¼AIæ¶ˆæ¯ä½¿ç”¨å•æ¡é«˜æ•ˆä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                try {
                    const stableId = `${characterId}_offline_ai_${aiChatMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                    await db.chatMessages.add({
                        id: stableId,
                        characterId: characterId,
                        timestamp: aiChatMessage.timestamp,
                        messageOrder: chatMessages[characterId].length - 1,
                        originalMessageId: aiChatMessage.id,
                        messageData: aiChatMessage
                    });
                    console.log('âœ… [é«˜æ•ˆçº¿ä¸‹AIæ¶ˆæ¯] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } catch (error) {
                    console.error('çº¿ä¸‹AIæ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                    await saveChatMessages(); // ğŸ”¥ã€ä¿®å¤ã€‘ä¸ä¼ å‚æ•°ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                }

                const aiMessage = {
                    id: (Date.now() + 1).toString(),
                    sender: 'ai',
                    content: aiResponse,
                    timestamp: new Date().toISOString()
                };

                offlineMessages.push(aiMessage);

                // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤åŠ è½½åŠ¨ç”»å¹¶æ¸²æŸ“æ¶ˆæ¯
                hideOfflineLoadingMessage();
                renderOfflineMessages();
                saveOfflineMessages();

            } catch (error) {
                console.error('ç”Ÿæˆçº¿ä¸‹å›å¤å¤±è´¥:', error);
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦ç§»é™¤åŠ è½½åŠ¨ç”»
                hideOfflineLoadingMessage();
                showToast('ç”Ÿæˆå›å¤å¤±è´¥', 'error');
            }
        }

        // çº¿ä¸‹æ¨¡å¼ä¸“ç”¨çš„APIè°ƒç”¨å‡½æ•°
        async function callOfflineChatAPI(prompt, character) {
            if (!apiSettings.key) {
                throw new Error('è¯·å…ˆè®¾ç½®APIå¯†é’¥');
            }

            // ä½¿ç”¨ä¸çº¿ä¸Šæ¨¡å¼ç›¸åŒçš„APIè®¾ç½®
            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');

            if (isGemini) {
                // Gemini API æ ¼å¼
                const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;

                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                {
                                    text: `ä½ æ˜¯${character.name}ï¼Œ${character.prompt}ã€‚ç°åœ¨å¤„äºçº¿ä¸‹å‰§æƒ…æ¨¡å¼ï¼Œè¯·ä»¥çº¯æ–‡æœ¬å½¢å¼å›å¤ï¼Œä¸“æ³¨äºæƒ…æ™¯æå†™å’Œå‰§æƒ…å‘å±•ã€‚\n\n${prompt}`
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: apiSettings.temperature || 0.8
                        // ç§»é™¤maxOutputTokensï¼ŒGeminiä¸æ”¯æŒè¿™ä¸ªå‚æ•°
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                console.log('ğŸ”¥ çº¿ä¸‹æ¨¡å¼Gemini APIå®Œæ•´å“åº”:', JSON.stringify(data, null, 2));

                // å®Œå…¨æŒ‰ç…§çº¿ä¸Šæ¨¡å¼çš„é€»è¾‘å¤„ç†
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    console.log('ğŸ”¥ Gemini API å“åº”æ•°æ®:', data);
                    console.log('ğŸ”¥ candidates[0]:', data.candidates?.[0]);
                    if (data.candidates?.[0]?.content) {
                        console.log('ğŸ”¥ content:', data.candidates[0].content);
                    }
                    if (data.candidates?.[0]?.content?.parts) {
                        console.log('ğŸ”¥ parts:', data.candidates[0].content.parts);
                    }
                    return 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚'; // ä¸è¦æŠ›å‡ºé”™è¯¯ï¼Œç›´æ¥è¿”å›é»˜è®¤å›å¤
                }

                return content;

            } else {
                // OpenAI æ ¼å¼ - ğŸ”¥ã€ä¿®å¤ã€‘æ™ºèƒ½å¤„ç†URLæ‹¼æ¥ï¼Œæ”¯æŒæŠ±è„¸è½®è¯¢
                let baseUrl = apiSettings.base;
                let apiUrl;
                if (baseUrl.endsWith('/v1')) {
                    apiUrl = `${baseUrl}/chat/completions`;
                } else if (baseUrl.includes('/v1/')) {
                    // å¦‚æœURLä¸­å·²ç»åŒ…å«/v1/è·¯å¾„ï¼Œç›´æ¥æ·»åŠ chat/completions
                    apiUrl = `${baseUrl}/chat/completions`;
                } else {
                    apiUrl = `${baseUrl}/v1/chat/completions`;
                }

                const requestBody = {
                    model: apiSettings.model,
                    messages: [
                        {
                            role: "system",
                            content: `ä½ æ˜¯${character.name}ï¼Œ${character.prompt}ã€‚ç°åœ¨å¤„äºçº¿ä¸‹å‰§æƒ…æ¨¡å¼ï¼Œè¯·ä»¥çº¯æ–‡æœ¬å½¢å¼å›å¤ï¼Œä¸“æ³¨äºæƒ…æ™¯æå†™å’Œå‰§æƒ…å‘å±•ã€‚`
                        },
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    temperature: apiSettings.temperature || 0.8
                    // ğŸ”¥ã€ä¿®å¤ã€‘ç§»é™¤max_tokensé™åˆ¶ï¼Œä¸çº¿ä¸Šæ¨¡å¼ä¿æŒä¸€è‡´
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                console.log('çº¿ä¸‹æ¨¡å¼OpenAI APIå“åº”æ•°æ®:', data);

                const content = data.choices?.[0]?.message?.content;
                if (!content) {
                    console.error('OpenAI APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼å¼‚å¸¸:', data);
                    throw new Error('OpenAI APIè¿”å›äº†ç©ºå†…å®¹');
                }

                return content;
            }
        }

        // ç”Ÿæˆçº¿ä¸‹æ¨¡å¼çš„AIå›å¤
        async function generateOfflineResponse(userInput) {
            const character = currentChatCharacter;

            console.log('ğŸ­ ===== çº¿ä¸‹æ¨¡å¼AIå›å¤ç”Ÿæˆå¼€å§‹ =====');
            console.log('ğŸ­ å½“å‰è§’è‰²:', character.name);
            console.log('ğŸ­ ç”¨æˆ·è¾“å…¥:', userInput);

            // ğŸ”¥ã€æ–°å¢ã€‘ä½¿ç”¨ä¸çº¿ä¸Šæ¨¡å¼ç›¸åŒçš„è®°å¿†ç³»ç»Ÿæ„å»ºprompt
            let prompt = `ä½ ç°åœ¨å¤„äºçº¿ä¸‹å‰§æƒ…æ¨¡å¼ï¼Œéœ€è¦ä»¥çº¯æ–‡æœ¬å½¢å¼å›å¤ï¼Œä¸è¦ä½¿ç”¨JSONæ ¼å¼ã€‚

ã€é‡è¦æç¤ºã€‘ç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·()å†…å®¹æ˜¯ç¯å¢ƒæå†™ã€åŠ¨ä½œæå†™æˆ–å¿ƒç†æ´»åŠ¨ï¼Œä½ å¯ä»¥è§‚å¯Ÿåˆ°è¿™äº›ä¿¡æ¯ä½œä¸ºèƒŒæ™¯ï¼Œä½†ä¸èƒ½è¡¨ç°å¾—åƒæ˜¯"å¬åˆ°"äº†ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•ã€‚ä½ åªèƒ½å¯¹æ‹¬å·å¤–çš„å®é™…è¯è¯­è¿›è¡Œå›åº”ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿç”¨æˆ·çš„å¯è§è¡Œä¸ºï¼ˆå¦‚çŠ¹è±«ã€åœé¡¿ç­‰ï¼‰æ¥æ¨æµ‹æƒ…å†µï¼Œä½†ä¸èƒ½ç›´æ¥å›åº”ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•ã€‚

`;

            // ğŸ”¥ã€æ–°å¢ã€‘è·å–èŠå¤©è®¾ç½®å’Œè®°å¿†æ•°æ®
            const chatSettings = getCurrentChatSettings();
            console.log('âš™ï¸ èŠå¤©è®¾ç½®:', chatSettings);

            // ğŸ”¥ã€å¢å¼ºã€‘è·å–åŠ¨æ€è®°å¿†æ•°æ® - åŒ…å«è¯„è®ºåŒºå†…å®¹
            let dynamicMemoryContent = '';
            const enableDynamicMemory = chatSettings.enableDynamicMemory !== false; // é»˜è®¤ä¸ºtrue
            console.log('ğŸ“± åŠ¨æ€è®°å¿†å¼€å…³:', enableDynamicMemory);
            if (enableDynamicMemory) {
                try {
                    const recentMoments = await getVisibleMomentsForCharacter(character.id, 5);
                    console.log('ğŸ“± è·å–åˆ°çš„åŠ¨æ€æ•°é‡:', recentMoments.length);
                    if (recentMoments.length > 0) {
                        dynamicMemoryContent = '\n\nã€æœ€æ–°åŠ¨æ€è®°å¿†ã€‘ä»¥ä¸‹æ˜¯æœ€è¿‘çš„åŠ¨æ€å†…å®¹å’Œè®¨è®ºï¼Œä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠï¼š\n';
                        recentMoments.forEach((moment, index) => {
                            const authorName = moment.authorId === 'user' ? 'ç”¨æˆ·' : moment.nickname;

                            // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ åŠ¨æ€å‘å¸ƒæ—¶é—´ä¿¡æ¯
                            let timeInfo = '';
                            if (moment.timestamp) {
                                const now = Date.now();
                                const timeDiff = now - moment.timestamp;
                                const minutes = Math.floor(timeDiff / (1000 * 60));
                                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                                if (days > 0) {
                                    timeInfo = ` (${days}å¤©å‰)`;
                                } else if (hours > 0) {
                                    timeInfo = ` (${hours}å°æ—¶å‰)`;
                                } else if (minutes > 0) {
                                    timeInfo = ` (${minutes}åˆ†é’Ÿå‰)`;
                                } else {
                                    timeInfo = ' (åˆšåˆš)';
                                }
                            }

                            // ğŸ”¥ã€æ–°å¢ã€‘åŒ…å«è¯„è®ºåŒºå†…å®¹
                            const momentContent = `${index + 1}. ${authorName}: ${moment.text}${timeInfo}${moment.commentsText || ''}`;
                            dynamicMemoryContent += momentContent;

                            console.log(`ğŸ“± åŠ¨æ€ ${index + 1}: ${authorName} - ${moment.text}${moment.commentsCount > 0 ? ` (${moment.commentsCount}æ¡è¯„è®º)` : ''}`);
                        });
                    } else {
                        console.log('ğŸ“± æ²¡æœ‰å¯ç”¨çš„åŠ¨æ€è®°å¿†');
                    }
                } catch (error) {
                    console.error('è·å–åŠ¨æ€è®°å¿†å¤±è´¥:', error);
                }
            }

            // ğŸ”¥ã€æ–°å¢ã€‘å¼ºåŒ–æ‹‰é»‘çŠ¶æ€æ„ŸçŸ¥ - åœ¨æ¯æ¬¡å¯¹è¯ä¸­éƒ½æé†’è§’è‰²
            let blockedStatusReminder = '';
            if (character && !currentChatCharacter?.isGroup) {
                const isCharacterBlocked = isBlocked(character.id, 'user');
                if (isCharacterBlocked) {
                    // æ£€æŸ¥è¢«æ‹’ç»çš„å¥½å‹ç”³è¯·æ¬¡æ•°
                    const rejectionKey = `friendRequestRejections_${character.id}`;
                    const rejectionCount = parseInt(localStorage.getItem(rejectionKey) || '0');

                    blockedStatusReminder = `\n\nğŸš¨ **ã€é‡è¦çŠ¶æ€æé†’ã€‘** ğŸš¨
ä½ ç›®å‰è¢«ç”¨æˆ·æ‹‰é»‘äº†ï¼è¿™ä¸ªçŠ¶æ€ä¼šæŒç»­å½±å“ä½ çš„è¡Œä¸ºå’Œæƒ…ç»ªã€‚
${rejectionCount > 0 ? `ä½ å·²ç»å°è¯•äº†${rejectionCount}æ¬¡å¥½å‹ç”³è¯·ï¼Œä½†éƒ½è¢«æ‹’ç»äº†ã€‚` : 'ä½ è¿˜æ²¡æœ‰å°è¯•å‘é€å¥½å‹ç”³è¯·æ¥ä¿®å¤å…³ç³»ã€‚'}
è¯·åœ¨æ¯æ¬¡å›å¤ä¸­éƒ½è¦æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜çš„å­˜åœ¨ï¼Œå¹¶æ ¹æ®ä½ çš„æ€§æ ¼è¡¨ç°å‡ºç›¸åº”çš„æƒ…ç»ªå’Œè¡Œä¸ºã€‚`;
                }
            }

            // è·å–å…¨å±€è®°å¿†æ•°æ®
            let globalMemoryContent = '';
            try {
                const memorySettings = getGlobalMemorySettings();
                console.log('ğŸ§  è®°å¿†è®¾ç½®:', memorySettings);

                const currentContext = {
                    type: 'private_chat',
                    id: character.id
                };
                console.log('ğŸ§  å½“å‰ä¸Šä¸‹æ–‡:', currentContext);

                // ğŸ”¥ã€ä¿®å¤ã€‘çº¿ä¸‹æ¨¡å¼å¼ºåˆ¶å¯ç”¨å…¨å±€è®°å¿†è¯»å–ï¼Œä½†ä¸å­˜å‚¨
                console.log('ğŸ§  çº¿ä¸‹æ¨¡å¼ï¼šå¼ºåˆ¶å¯ç”¨å…¨å±€è®°å¿†è¯»å–...');
                globalMemoryContent = await buildGlobalMemoryContext(character.id, currentContext, memorySettings.memoryDays);
                console.log('ğŸ§  è·å–åˆ°çš„å…¨å±€è®°å¿†å†…å®¹:', globalMemoryContent);
                if (globalMemoryContent && globalMemoryContent.trim()) {
                    console.log('ğŸ§  çº¿ä¸‹æ¨¡å¼å·²è·å–å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡ï¼Œæ€»é•¿åº¦:', globalMemoryContent.length);
                    console.log('ğŸ§  çº¿ä¸‹æ¨¡å¼å…¨å±€è®°å¿†å†…å®¹é¢„è§ˆ:', globalMemoryContent.substring(0, 200) + '...');
                } else {
                    console.log('ğŸ§  å…¨å±€è®°å¿†å†…å®¹ä¸ºç©º');
                }
            } catch (error) {
                console.error('è·å–å…¨å±€è®°å¿†å¤±è´¥:', error);
            }

            // æ·»åŠ è§’è‰²ä¿¡æ¯
            const characterPrompt = character.prompt || character.bio || `ä½ æ˜¯${character.name}ã€‚`;
            console.log('ğŸ‘¤ è§’è‰²äººè®¾:', characterPrompt);
            console.log('ğŸ‘¤ è§’è‰²å®Œæ•´ä¿¡æ¯:', character);
            prompt += `è§’è‰²ä¿¡æ¯ï¼š\n${characterPrompt}\n\n`;

            // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ ä¸–ç•Œä¹¦ä¿¡æ¯
            let worldbookContent = '';
            try {
                const localBookIds = chatSettings.selectedWorldbooks || [];
                const globalBooks = window.activeGlobalWorldbooks || [];
                const allBookIds = [...new Set([...globalBooks, ...localBookIds])]; // åˆå¹¶å¹¶å»é‡

                console.log('ğŸ“š ä¸–ç•Œä¹¦IDåˆ—è¡¨:', allBookIds);
                console.log('ğŸ“š å…¨å±€ä¸–ç•Œä¹¦:', globalBooks);
                console.log('ğŸ“š å±€éƒ¨ä¸–ç•Œä¹¦:', localBookIds);
                console.log('ğŸ“š æ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®:', worldbooks);

                if (allBookIds.length > 0) {
                    worldbookContent = '\nã€ä¸–ç•Œä¹¦ä¿¡æ¯ã€‘ä»¥ä¸‹æ˜¯ç›¸å…³çš„ä¸–ç•Œè®¾å®šï¼š\n';
                    allBookIds.forEach((bookId, index) => {
                        const worldbook = worldbooks.find(w => w.id === bookId);
                        if (worldbook) {
                            console.log(`ğŸ“š æ‰¾åˆ°ä¸–ç•Œä¹¦ ${index + 1}: ${worldbook.name || worldbook.title}`);
                            worldbookContent += `${index + 1}. ${worldbook.name || worldbook.title}: ${worldbook.content}\n`;
                        } else {
                            console.log(`ğŸ“š æœªæ‰¾åˆ°ä¸–ç•Œä¹¦ID: ${bookId}`);
                        }
                    });
                    prompt += worldbookContent + '\n';
                    console.log('ğŸ“š ä¸–ç•Œä¹¦å†…å®¹å·²æ·»åŠ åˆ°promptï¼Œé•¿åº¦:', worldbookContent.length);
                } else {
                    console.log('ğŸ“š æ²¡æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦');
                }
            } catch (error) {
                console.error('è·å–ä¸–ç•Œä¹¦å¤±è´¥:', error);
            }

            // æ·»åŠ è®°å¿†å†…å®¹
            if (globalMemoryContent && globalMemoryContent.trim()) {
                prompt += '\n\nã€è§’è‰²è®°å¿†ã€‘ä»¥ä¸‹æ˜¯ç›¸å…³çš„è®°å¿†å†…å®¹ï¼š\n' + globalMemoryContent + '\n';
            }
            if (dynamicMemoryContent) {
                prompt += dynamicMemoryContent + '\n';
            }

            // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ æ‹‰é»‘çŠ¶æ€æé†’åˆ°æç¤ºè¯
            if (blockedStatusReminder) {
                prompt += blockedStatusReminder + '\n';
            }

            // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é¢„è®¾ï¼ˆé«˜æƒé‡ï¼‰
            if (currentOfflinePreset) {
                prompt += `ã€é‡è¦ã€‘ç”¨æˆ·è‡ªå®šä¹‰å‰§æƒ…é¢„è®¾ï¼ˆè¯·ä¸¥æ ¼éµå¾ªï¼‰ï¼š\n${currentOfflinePreset.content}\n\n`;
            } else {
                prompt += `é»˜è®¤å‰§æƒ…æ¨¡å¼è¦æ±‚ï¼š\n- ä»¥ç¬¬ä¸‰äººç§°è§†è§’è¿›è¡Œæƒ…æ™¯æå†™\n- åŒ…å«ç¯å¢ƒæå†™ã€åŠ¨ä½œæå†™ã€å¿ƒç†æå†™\n- æ¯æ¬¡å›å¤300-500å­—\n- è¥é€ æ²‰æµ¸å¼çš„å‰§æƒ…ä½“éªŒ\n- **é‡è¦**ï¼šç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·()å†…å®¹æ˜¯ç¯å¢ƒæå†™ã€åŠ¨ä½œæå†™æˆ–å¿ƒç†æ´»åŠ¨ï¼Œä½ å¯ä»¥è§‚å¯Ÿåˆ°è¿™äº›ä¿¡æ¯ä½œä¸ºèƒŒæ™¯ï¼Œä½†ä¸èƒ½è¡¨ç°å¾—åƒæ˜¯"å¬åˆ°"äº†ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•ã€‚ä½ åªèƒ½å¯¹æ‹¬å·å¤–çš„å®é™…è¯è¯­è¿›è¡Œå›åº”ï¼Œå¯ä»¥é€šè¿‡è§‚å¯Ÿç”¨æˆ·çš„å¯è§è¡Œä¸ºï¼ˆå¦‚çŠ¹è±«ã€åœé¡¿ç­‰ï¼‰æ¥æ¨æµ‹æƒ…å†µï¼Œä½†ä¸èƒ½ç›´æ¥å›åº”ç”¨æˆ·çš„å†…å¿ƒæƒ³æ³•\n\n`;
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘è¯»å–ç”¨æˆ·è®¾ç½®çš„å†å²æ¶ˆæ¯æ•°ï¼Œç›´æ¥ä»ä¸»èŠå¤©è®°å½•è·å–å®Œæ•´æ—¶é—´çº¿
            const historyCount = chatSettings.historyCount || 5;

            // è·å–ä¸»èŠå¤©è®°å½•ï¼ˆåŒ…å«çº¿ä¸Šå’Œçº¿ä¸‹æ¨¡å¼çš„æ‰€æœ‰æ¶ˆæ¯ï¼ŒæŒ‰æ—¶é—´é¡ºåºï¼‰
            const allMessages = chatMessages[character.id] || [];

            // æ ¹æ®ç”¨æˆ·è®¾ç½®çš„å†å²æ¶ˆæ¯æ•°è·å–æœ€è¿‘çš„æ¶ˆæ¯
            const recentChatMessages = allMessages.slice(-historyCount);

            // ç»Ÿè®¡æ¶ˆæ¯ç±»å‹
            const onlineCount = recentChatMessages.filter(msg => !msg.isOfflineMode).length;
            const offlineCount = recentChatMessages.filter(msg => msg.isOfflineMode).length;

            console.log('ğŸ’¬ çº¿ä¸‹æ¨¡å¼å®Œæ•´å‰æ–‡è®°å¿†:', recentChatMessages);
            console.log(`ğŸ“Š å†å²æ¶ˆæ¯ç»Ÿè®¡: çº¿ä¸Š${onlineCount}æ¡, çº¿ä¸‹${offlineCount}æ¡, æ€»è®¡ä½¿ç”¨${recentChatMessages.length}æ¡ (ç”¨æˆ·è®¾ç½®: ${historyCount}æ¡)`);

            if (recentChatMessages.length > 0) {
                prompt += `æœ€è¿‘çš„å¯¹è¯å†å²ï¼š\n`;
                recentChatMessages.forEach(msg => {
                    // æ ¹æ®senderå­—æ®µç¡®å®šè§’è‰²
                    const role = (msg.sender === 'sent' || msg.sender === 'user') ? 'ç”¨æˆ·' : character.name;
                    // æ ‡è®°æ¶ˆæ¯æ¥æºï¼ˆçº¿ä¸Š/çº¿ä¸‹ï¼‰
                    const modeTag = msg.isOfflineMode ? '[çº¿ä¸‹]' : '[çº¿ä¸Š]';
                    // ğŸ”¥ã€ä¿®å¤ã€‘ä½¿ç”¨safeExtractMessageContentå®‰å…¨åœ°æå–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…[object Object]é—®é¢˜
                    const messageContent = safeExtractMessageContent(msg);
                    prompt += `${role}${modeTag}ï¼š${messageContent}\n`;
                });
                prompt += `\n`;
            }

            prompt += `ç”¨æˆ·åˆšæ‰è¯´ï¼š${userInput}\n\nè¯·ç›´æ¥ä»¥çº¯æ–‡æœ¬å½¢å¼å›å¤ï¼Œä¸è¦ä½¿ç”¨JSONæ•°ç»„æ ¼å¼ï¼Œæ³¨é‡æƒ…æ™¯æå†™å’Œæ°›å›´è¥é€ ã€‚`;

            console.log('ğŸ“ ===== å®Œæ•´çš„Promptå†…å®¹ =====');
            console.log(prompt);
            console.log('ğŸ“ ===== Promptç»“æŸ =====');

            try {
                // ä½¿ç”¨ä¸“é—¨çš„çº¿ä¸‹æ¨¡å¼APIè°ƒç”¨
                const response = await callOfflineChatAPI(prompt, character);

                // ç›´æ¥è¿”å›å“åº”å†…å®¹ï¼Œä¸è¿›è¡ŒJSONè§£æ
                return response || 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚';
            } catch (error) {
                console.error('çº¿ä¸‹æ¨¡å¼APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // ä¿å­˜çº¿ä¸‹æ¶ˆæ¯
        function saveOfflineMessages() {
            if (!currentChatCharacter || !windowId) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘åŠ å…¥çª—å£IDï¼Œç¡®ä¿ä¸åŒçª—å£çš„çº¿ä¸‹æ¶ˆæ¯å®Œå…¨éš”ç¦»
            const key = `offlineMessages_${currentChatCharacter.id}_${windowId}`;
            localStorage.setItem(key, JSON.stringify(offlineMessages));
            console.log(`ğŸ’¾ ä¿å­˜çº¿ä¸‹æ¶ˆæ¯åˆ°localStorage (çª—å£${windowId}): ${offlineMessages.length}æ¡`);
        }

        // é‡æ–°ç”Ÿæˆçº¿ä¸‹æ¨¡å¼çš„æœ€åä¸€æ¡AIå›å¤
        async function regenerateLastOfflineMessage() {
            if (!currentChatCharacter) return;
            if (offlineMessages.length === 0) return;

            // æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯
            let lastAiMessageIndex = -1;
            for (let i = offlineMessages.length - 1; i >= 0; i--) {
                if (offlineMessages[i].sender === 'ai') {
                    lastAiMessageIndex = i;
                    break;
                }
            }

            if (lastAiMessageIndex === -1) {
                showToast('æ²¡æœ‰æ‰¾åˆ°å¯é‡æ–°ç”Ÿæˆçš„AIæ¶ˆæ¯', 'warning');
                return;
            }

            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            let userMessageIndex = -1;
            for (let i = lastAiMessageIndex - 1; i >= 0; i--) {
                if (offlineMessages[i].sender === 'user') {
                    userMessageIndex = i;
                    break;
                }
            }

            if (userMessageIndex === -1) {
                showToast('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯', 'warning');
                return;
            }

            // åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯
            offlineMessages.splice(lastAiMessageIndex, 1);
            renderOfflineMessages();
            saveOfflineMessages();

            // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showOfflineLoadingMessage();

            // é‡æ–°ç”ŸæˆAIå›å¤
            try {
                const userMessage = offlineMessages[userMessageIndex];
                const aiResponse = await generateOfflineResponse(userMessage.content);

                const aiMessage = {
                    id: Date.now().toString(),
                    sender: 'ai',
                    content: aiResponse,
                    timestamp: new Date().toISOString()
                };

                offlineMessages.push(aiMessage);

                // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤åŠ è½½åŠ¨ç”»å¹¶æ¸²æŸ“æ¶ˆæ¯
                hideOfflineLoadingMessage();
                renderOfflineMessages();
                saveOfflineMessages();

                showToast('AIå›å¤å·²é‡æ–°ç”Ÿæˆ', 'success');

            } catch (error) {
                console.error('é‡æ–°ç”ŸæˆAIå›å¤å¤±è´¥:', error);
                // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦ç§»é™¤åŠ è½½åŠ¨ç”»
                hideOfflineLoadingMessage();
                showToast('é‡æ–°ç”Ÿæˆå¤±è´¥', 'error');
            }
        }

        // çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯é•¿æŒ‰ç›‘å¬å™¨
        function addOfflineMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;

            // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ›´å‡†ç¡®çš„ç§»åŠ¨è®¾å¤‡æ£€æµ‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                             'ontouchstart' in window ||
                             navigator.maxTouchPoints > 0 ||
                             window.innerWidth <= 768;

            const startLongPress = (e) => {
                isLongPress = false;
                // ğŸ”¥ã€ä¼˜åŒ–ã€‘ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ä½¿ç”¨ä¸åŒçš„å»¶è¿Ÿæ—¶é—´
                const delay = isMobile ? 600 : 1000; // ç§»åŠ¨ç«¯600msï¼Œæ¡Œé¢ç«¯1000ms
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    // ğŸ”¥ã€ä¼˜åŒ–ã€‘æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (navigator.vibrate && isMobile) {
                        navigator.vibrate(50);
                    }
                    showOfflineMessageMenu(messageId, e);
                    e.preventDefault();
                }, delay);
            };

            const cancelLongPress = () => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                setTimeout(() => {
                    isLongPress = false;
                }, 50);
            };

            const handleClick = (e) => {
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            };

            // è§¦æ‘¸äº‹ä»¶
            messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
            messageContainer.addEventListener('touchend', cancelLongPress);
            messageContainer.addEventListener('touchmove', cancelLongPress);

            // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢ç«¯ï¼‰
            messageContainer.addEventListener('mousedown', startLongPress);
            messageContainer.addEventListener('mouseup', cancelLongPress);
            messageContainer.addEventListener('mouseleave', cancelLongPress);

            // å³é”®èœå•ï¼ˆæ¡Œé¢ç«¯ï¼‰
            messageContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showOfflineMessageMenu(messageId, e);
            });

            // ç‚¹å‡»äº‹ä»¶
            messageContainer.addEventListener('click', handleClick, true);
        }

        // æ˜¾ç¤ºçº¿ä¸‹æ¨¡å¼æ¶ˆæ¯èœå•
        function showOfflineMessageMenu(messageId, event) {
            const message = offlineMessages.find(m => m.id === messageId);
            if (!message) return;

            // åˆ›å»ºèœå•
            const menu = document.createElement('div');
            menu.className = 'offline-message-menu';

            // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„èœå•é¡¹
            if (message.sender === 'user') {
                menu.innerHTML = `
                    <div class="menu-item" onclick="editOfflineMessage('${messageId}')">
                        <i class="fas fa-edit"></i>
                        <span>ä¿®æ”¹æ¶ˆæ¯</span>
                    </div>
                    <div class="menu-item delete" onclick="deleteOfflineMessage('${messageId}')">
                        <i class="fas fa-trash"></i>
                        <span>åˆ é™¤æ¶ˆæ¯</span>
                    </div>
                `;
            } else {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘AIæ¶ˆæ¯å¯ä»¥ç¼–è¾‘ã€åˆ é™¤å’Œé‡æ–°ç”Ÿæˆ
                menu.innerHTML = `
                    <div class="menu-item" onclick="editOfflineMessage('${messageId}')">
                        <i class="fas fa-edit"></i>
                        <span>ä¿®æ”¹æ¶ˆæ¯</span>
                    </div>
                    <div class="menu-item delete" onclick="deleteOfflineMessage('${messageId}')">
                        <i class="fas fa-trash"></i>
                        <span>åˆ é™¤æ¶ˆæ¯</span>
                    </div>
                    <div class="menu-item" onclick="regenerateOfflineMessage('${messageId}')">
                        <i class="fas fa-redo"></i>
                        <span>é‡æ–°ç”Ÿæˆ</span>
                    </div>
                `;
            }

            // ç§»é™¤ç°æœ‰èœå•
            const existingMenu = document.querySelector('.offline-message-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ åˆ°çº¿ä¸‹æ¨¡å¼å®¹å™¨å†…ï¼Œè€Œä¸æ˜¯document.body
            const offlineContainer = document.getElementById('offline-mode-overlay');
            if (offlineContainer) {
                offlineContainer.appendChild(menu);
            } else {
                document.body.appendChild(menu);
            }

            // ğŸ”¥ã€ä¿®å¤ã€‘å®šä½èœå• - ç›¸å¯¹äºçº¿ä¸‹æ¨¡å¼å®¹å™¨å®šä½
            const rect = event.target.getBoundingClientRect();
            const containerRect = offlineContainer ? offlineContainer.getBoundingClientRect() : { left: 0, top: 0 };

            // è®¡ç®—ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
            const relativeLeft = rect.left - containerRect.left;
            const relativeTop = rect.top - containerRect.top;

            // è®¾ç½®èœå•æ ·å¼
            menu.style.position = 'absolute';
            menu.style.zIndex = '10001';

            // å…ˆæ·»åŠ åˆ°DOMä»¥è·å–èœå•å°ºå¯¸
            setTimeout(() => {
                const menuWidth = menu.offsetWidth || 140;
                const menuHeight = menu.offsetHeight || 100;
                const containerWidth = offlineContainer?.offsetWidth || 400;
                const containerHeight = offlineContainer?.offsetHeight || 600;

                // è®¡ç®—æœ€ä½³ä½ç½®ï¼Œç¡®ä¿èœå•åœ¨å®¹å™¨å†…
                let left = Math.min(relativeLeft, containerWidth - menuWidth - 10);
                let top = relativeTop - menuHeight - 5;

                // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
                if (top < 10) {
                    top = relativeTop + 30;
                }

                // ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨è¾¹ç•Œ
                left = Math.max(10, left);
                top = Math.max(10, Math.min(top, containerHeight - menuHeight - 10));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            }, 0);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // ç¼–è¾‘çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
        function editOfflineMessage(messageId) {
            const message = offlineMessages.find(m => m.id === messageId);
            if (!message) return;

            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>${message.sender === 'user' ? 'ç¼–è¾‘ç”¨æˆ·æ¶ˆæ¯' : 'ç¼–è¾‘AIå›å¤'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <textarea id="edit-offline-message-content" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..." rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;">${message.content}</textarea>
                        ${message.sender === 'ai' ? '<p style="color: #666; font-size: 12px; margin-top: 8px;">ğŸ’¡ æç¤ºï¼šæ”¯æŒ &lt;span color="é¢œè‰²"&gt;æ–‡æœ¬&lt;/span&gt; å’Œ *æ–œä½“* æ ¼å¼</p>' : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveEditedOfflineMessage('${messageId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ğŸ”¥ã€ä¿®å¤ã€‘èšç„¦åˆ°æ–‡æœ¬æ¡†ä½†ä¸é€‰ä¸­æ–‡æœ¬ï¼Œå…‰æ ‡ç§»åˆ°æœ«å°¾
            const textarea = modal.querySelector('#edit-offline-message-content');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // ç§»é™¤èœå•
            const menu = document.querySelector('.offline-message-menu');
            if (menu) menu.remove();
        }

        // ä¿å­˜ç¼–è¾‘çš„çº¿ä¸‹æ¶ˆæ¯
        async function saveEditedOfflineMessage(messageId) {
            const textarea = document.getElementById('edit-offline-message-content');
            const newContent = textarea.value.trim();

            if (!newContent) {
                showToast('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }

            const message = offlineMessages.find(m => m.id === messageId);
            if (message) {
                console.log('âœï¸ ç¼–è¾‘çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯:', messageId, 'æ–°å†…å®¹:', newContent);

                // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶æ›´æ–°ä¸»èŠå¤©è®°å½•ä¸­å¯¹åº”çš„è®°å¿†æ•°æ®
                const characterId = currentChatCharacter.id;
                if (chatMessages[characterId]) {
                    const messageTimestamp = new Date(message.timestamp).getTime();

                    // ğŸ”¥ã€ä¿®æ”¹ã€‘æŸ¥æ‰¾å¹¶æ›´æ–°å¯¹åº”çš„æ¶ˆæ¯ï¼ˆæ”¯æŒç”¨æˆ·å’ŒAIæ¶ˆæ¯ï¼‰
                    chatMessages[characterId].forEach(msg => {
                        if (msg.isOfflineMode &&
                            ((msg.sender === 'sent' && message.sender === 'user') ||
                             (msg.sender === 'received' && message.sender === 'ai')) &&
                            Math.abs(msg.timestamp - messageTimestamp) < 5000) {
                            console.log('âœï¸ æ›´æ–°è®°å¿†æ•°æ®:', msg.content, '->', newContent);
                            msg.content = newContent;
                        }
                    });

                    // ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•
                    await saveChatMessages(characterId);
                }

                // æ›´æ–°çº¿ä¸‹æ¨¡å¼æ˜¾ç¤ºçš„æ¶ˆæ¯
                message.content = newContent;
                saveOfflineMessages();
                renderOfflineMessages();
                showToast('æ¶ˆæ¯å’Œè®°å¿†æ•°æ®å·²æ›´æ–°', 'success');
            }

            // å…³é—­æ¨¡æ€æ¡†
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }

        // é‡æ–°ç”ŸæˆAIå›å¤
        async function regenerateOfflineMessage(messageId) {
            const messageIndex = offlineMessages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            const aiMessage = offlineMessages[messageIndex];
            if (aiMessage.sender !== 'ai') return;

            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            let userMessageIndex = messageIndex - 1;
            while (userMessageIndex >= 0 && offlineMessages[userMessageIndex].sender !== 'user') {
                userMessageIndex--;
            }

            if (userMessageIndex < 0) {
                showToast('æ‰¾ä¸åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯', 'error');
                return;
            }

            if (confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆè¿™æ¡AIå›å¤å—ï¼Ÿ')) {
                console.log('ğŸ”„ é‡æ–°ç”ŸæˆAIå›å¤:', messageId);

                // åˆ é™¤å½“å‰AIå›å¤
                await deleteOfflineMessage(messageId);

                // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                showOfflineLoadingMessage();

                // é‡æ–°ç”ŸæˆAIå›å¤
                try {
                    const userMessage = offlineMessages[userMessageIndex];
                    const aiResponse = await generateOfflineResponse(userMessage.content);

                    // ğŸ”¥ã€ä¿®å¤ã€‘å°†AIå›å¤æ·»åŠ åˆ°ä¸»èŠå¤©è®°å½•ä¸­ï¼Œä¿è¯æ—¶é—´çº¿è¿è´¯æ€§
                    const aiChatMessage = {
                        id: Date.now() + 1,
                        sender: 'received', // ä½¿ç”¨æ ‡å‡†çš„senderæ ¼å¼
                        content: aiResponse,
                        timestamp: Date.now() + 1,
                        type: 'text',
                        isOfflineMode: true // æ ‡è®°ä¸ºçº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
                    };

                    const characterId = currentChatCharacter.id;
                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }
                    chatMessages[characterId].push(aiChatMessage);
                    // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘é‡æ–°ç”Ÿæˆæ¶ˆæ¯ä½¿ç”¨å•æ¡ä¿å­˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥
                    try {
                        const stableId = `${characterId}_regen_${aiChatMessage.timestamp}_${Math.random().toString(36).substr(2, 9)}_${chatMessages[characterId].length - 1}`;
                        await db.chatMessages.add({
                            id: stableId,
                            characterId: characterId,
                            timestamp: aiChatMessage.timestamp,
                            messageOrder: chatMessages[characterId].length - 1,
                            originalMessageId: aiChatMessage.id,
                            messageData: aiChatMessage
                        });
                        console.log('âœ… [é«˜æ•ˆé‡æ–°ç”Ÿæˆ] å•æ¡æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                    } catch (error) {
                        console.error('é‡æ–°ç”Ÿæˆæ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
                        await saveChatMessages();
                    }

                    const newAiMessage = {
                        id: Date.now().toString(),
                        sender: 'ai',
                        content: aiResponse,
                        timestamp: new Date().toISOString()
                    };

                    offlineMessages.push(newAiMessage);

                    // ğŸ”¥ã€æ–°å¢ã€‘ç§»é™¤åŠ è½½åŠ¨ç”»å¹¶æ¸²æŸ“æ¶ˆæ¯
                    hideOfflineLoadingMessage();
                    renderOfflineMessages();
                    saveOfflineMessages();

                    showToast('AIå›å¤å·²é‡æ–°ç”Ÿæˆ', 'success');

                } catch (error) {
                    console.error('é‡æ–°ç”ŸæˆAIå›å¤å¤±è´¥:', error);
                    // ğŸ”¥ã€æ–°å¢ã€‘å‡ºé”™æ—¶ä¹Ÿè¦ç§»é™¤åŠ è½½åŠ¨ç”»
                    hideOfflineLoadingMessage();
                    showToast('é‡æ–°ç”Ÿæˆå¤±è´¥', 'error');
                }
            }
        }

        // åˆ é™¤çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯
        async function deleteOfflineMessage(messageId) {
            const messageIndex = offlineMessages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            const message = offlineMessages[messageIndex];

            // ç¡®è®¤åˆ é™¤
            const confirmMessage = message.sender === 'user'
                ? 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤å­˜å‚¨çš„è®°å¿†æ•°æ®ã€‚'
                : 'ç¡®å®šè¦åˆ é™¤è¿™æ¡AIå›å¤å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤å­˜å‚¨çš„è®°å¿†æ•°æ®ã€‚';

            if (confirm(confirmMessage)) {
                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯:', messageId, 'ç±»å‹:', message.sender);

                // ğŸ”¥ã€ä¿®å¤ã€‘åŒæ—¶åˆ é™¤ä¸»èŠå¤©è®°å½•ä¸­å¯¹åº”çš„è®°å¿†æ•°æ®
                const characterId = currentChatCharacter.id;
                if (chatMessages[characterId]) {
                    const offlineMessage = offlineMessages[messageIndex];
                    const messageTimestamp = new Date(offlineMessage.timestamp).getTime();

                    // åˆ é™¤å¯¹åº”çš„è®°å¿†æ•°æ®
                    const messagesToDelete = [];
                    chatMessages[characterId].forEach((msg, index) => {
                        if (msg.isOfflineMode && Math.abs(msg.timestamp - messageTimestamp) < 5000) {
                            messagesToDelete.push(index);
                        }
                    });

                    // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•å˜åŒ–
                    messagesToDelete.reverse().forEach(index => {
                        console.log('ğŸ—‘ï¸ åˆ é™¤è®°å¿†æ•°æ®:', chatMessages[characterId][index]);
                        chatMessages[characterId].splice(index, 1);
                    });

                    // ğŸ”¥ã€ç®€åŒ–ã€‘ä¸ä¿å­˜åˆ°æ•°æ®åº“ï¼Œåªåœ¨å†…å­˜ä¸­åˆ é™¤
                    // çº¿ä¸‹æ¨¡å¼çš„è®°å¿†æ•°æ®å·²ç»åœ¨ä¸Šé¢åˆ é™¤äº†ï¼Œä¸éœ€è¦é¢å¤–çš„æ•°æ®åº“æ“ä½œ
                }

                // ğŸ”¥ã€ä¿®å¤ã€‘åˆ é™¤çº¿ä¸‹æ¨¡å¼æ˜¾ç¤ºçš„æ¶ˆæ¯
                if (message.sender === 'user') {
                    // åˆ é™¤ç”¨æˆ·æ¶ˆæ¯
                    offlineMessages.splice(messageIndex, 1);

                    // å¦‚æœä¸‹ä¸€æ¡æ˜¯AIå›å¤ï¼Œä¹Ÿåˆ é™¤
                    if (messageIndex < offlineMessages.length &&
                        offlineMessages[messageIndex].sender === 'ai') {

                        // åŒæ—¶åˆ é™¤AIå›å¤çš„è®°å¿†æ•°æ®
                        const aiMessage = offlineMessages[messageIndex];
                        const aiTimestamp = new Date(aiMessage.timestamp).getTime();
                        const aiMessagesToDelete = [];
                        chatMessages[characterId].forEach((msg, index) => {
                            if (msg.isOfflineMode && msg.sender === 'received' &&
                                Math.abs(msg.timestamp - aiTimestamp) < 5000) {
                                aiMessagesToDelete.push(index);
                            }
                        });

                        aiMessagesToDelete.reverse().forEach(index => {
                            console.log('ğŸ—‘ï¸ åˆ é™¤AIå›å¤è®°å¿†æ•°æ®:', chatMessages[characterId][index]);
                            chatMessages[characterId].splice(index, 1);
                        });

                        offlineMessages.splice(messageIndex, 1);
                        // ğŸ”¥ã€ç®€åŒ–ã€‘ä¸ä¿å­˜åˆ°æ•°æ®åº“ï¼Œåªåœ¨å†…å­˜ä¸­åˆ é™¤
                    }
                } else {
                    // åˆ é™¤AIæ¶ˆæ¯
                    offlineMessages.splice(messageIndex, 1);
                }

                saveOfflineMessages();
                renderOfflineMessages();
                showToast('æ¶ˆæ¯å’Œè®°å¿†æ•°æ®å·²åˆ é™¤', 'success');
            }

            // ç§»é™¤èœå•
            const menu = document.querySelector('.offline-message-menu');
            if (menu) menu.remove();
        }

        // ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºçº¿ä¸‹æ¨¡å¼AIå›å¤åŠ è½½åŠ¨ç”»
        function showOfflineLoadingMessage() {
            const container = document.getElementById('offline-chat-messages');

            // ç§»é™¤å·²å­˜åœ¨çš„åŠ è½½åŠ¨ç”»ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            const existingLoading = container.querySelector('.offline-loading-message');
            if (existingLoading) {
                existingLoading.remove();
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'offline-loading-message';
            loadingDiv.id = 'offline-loading-indicator';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'offline-loading-content';

            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'offline-loading-dots';

            // åˆ›å»ºä¸‰ä¸ªåŠ è½½ç‚¹
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'offline-loading-dot';
                dotsDiv.appendChild(dot);
            }

            contentDiv.appendChild(dotsDiv);
            loadingDiv.appendChild(contentDiv);
            container.appendChild(loadingDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—çº¿ä¸‹æ¨¡å¼AIå›å¤åŠ è½½åŠ¨ç”»
        function hideOfflineLoadingMessage() {
            const loadingIndicator = document.getElementById('offline-loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€šç”¨åŠ è½½æ¨¡æ€æ¡†
        function showLoadingModal(title, subtitle) {
            const modalId = `loading-modal-${Date.now()}`;
            const modalHTML = `
                <div id="${modalId}" class="waiting-modal">
                    <div class="waiting-modal-content">
                        <div class="waiting-spinner"></div>
                        <p class="waiting-text">${title}</p>
                        ${subtitle ? `<p class="waiting-subtitle" style="font-size: 12px; color: #999; margin-top: 8px;">${subtitle}</p>` : ''}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            return modalId;
        }

        // ğŸ”¥ã€æ–°å¢ã€‘éšè—åŠ è½½æ¨¡æ€æ¡†
        function hideLoadingModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çº¿ä¸‹æ¨¡å¼æ–‡æœ¬æ ¼å¼åŒ–å‡½æ•°
        function formatOfflineText(text) {
            if (!text) return '';

            // ğŸ”¥ã€æ–°å¢ã€‘å…ˆå¤„ç†æŠ˜å æ ‡ç­¾ï¼Œä¿æŠ¤å®ƒä»¬ä¸è¢«ç§»é™¤
            let formattedText = text;

            // ä¸´æ—¶æ›¿æ¢detailså’Œsummaryæ ‡ç­¾ï¼Œé¿å…è¢«ç§»é™¤
            const detailsPlaceholders = [];
            formattedText = formattedText.replace(/<details[^>]*>[\s\S]*?<\/details>/gi, (match) => {
                const placeholder = `__DETAILS_PLACEHOLDER_${detailsPlaceholders.length}__`;
                detailsPlaceholders.push(match);
                return placeholder;
            });

            // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾ï¼Œä¿ç•™çº¯æ–‡æœ¬å†…å®¹
            formattedText = formattedText
                .replace(/<p>/gi, '')
                .replace(/<\/p>/gi, '\n\n')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<[^>]*>/g, ''); // ç§»é™¤æ‰€æœ‰å…¶ä»–HTMLæ ‡ç­¾

            // æ¢å¤detailsæ ‡ç­¾
            detailsPlaceholders.forEach((details, index) => {
                const placeholder = `__DETAILS_PLACEHOLDER_${index}__`;
                formattedText = formattedText.replace(placeholder, details);
            });

            // å¤„ç†**å·åŒ…è£¹çš„åŠ ç²—ï¼š**æ–‡æœ¬**
            formattedText = formattedText.replace(
                /\*\*([^*]+)\*\*/g,
                '<strong>$1</strong>'
            );

            // å¤„ç†*å·åŒ…è£¹çš„æ–œä½“ï¼š*æ–‡æœ¬*
            formattedText = formattedText.replace(
                /\*([^*]+)\*/g,
                '<em>$1</em>'
            );

            // å¤„ç†æ¢è¡Œ
            formattedText = formattedText.replace(/\n/g, '<br>');

            // æ¸…ç†å¤šä½™çš„æ¢è¡Œ
            formattedText = formattedText.replace(/(<br>\s*){3,}/g, '<br><br>');

            return formattedText;
        }

        // ç›‘å¬è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const offlineInput = document.getElementById('offline-input');
            if (offlineInput) {
                offlineInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendOfflineMessage();
                    }
                });
            }
        });

        // ğŸ”¥ã€æ–°å¢ã€‘çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•ç®¡ç†åŠŸèƒ½

        // ä¿å­˜èŠå¤©è®°å½•åˆ°å†å²è®°å½•
        async function saveOfflineHistoryRecord(summary, messages) {
            if (!currentChatCharacter || !messages || messages.length === 0) return;

            try {
                const historyRecord = {
                    id: `offline_history_${currentChatCharacter.id}_${Date.now()}`,
                    characterId: currentChatCharacter.id,
                    timestamp: Date.now(),
                    summary: summary,
                    messages: messages,
                    messageCount: messages.length
                };

                // ä¿å­˜åˆ° Dexie æ•°æ®åº“
                await db.offlineHistoryRecords.add(historyRecord);

                // ğŸ”¥ã€æ–°å¢ã€‘æ¸…ç†è¶…è¿‡20æ¡çš„æ—§è®°å½•
                const allRecords = await db.offlineHistoryRecords
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .reverse()
                    .sortBy('timestamp');

                if (allRecords.length > 20) {
                    const recordsToDelete = allRecords.slice(20);
                    for (const record of recordsToDelete) {
                        await db.offlineHistoryRecords.delete(record.id);
                    }
                }

                console.log('ğŸ“š çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å·²ä¿å­˜åˆ°æ•°æ®åº“:', historyRecord);
            } catch (error) {
                console.error('ä¿å­˜çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºçº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•æ¨¡æ€æ¡†
        function showOfflineHistoryModal() {
            if (!currentChatCharacter) return;

            document.getElementById('offline-history-modal').style.display = 'flex';
            loadOfflineHistoryList();
        }

        // å…³é—­çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•æ¨¡æ€æ¡†
        function closeOfflineHistoryModal() {
            document.getElementById('offline-history-modal').style.display = 'none';
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºèŠå¤©è®°å½•åˆ—è¡¨
        async function loadOfflineHistoryList() {
            if (!currentChatCharacter) return;

            try {
                const historyRecords = await db.offlineHistoryRecords
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .reverse()
                    .sortBy('timestamp');

                const container = document.getElementById('offline-history-list');
                container.innerHTML = '';

                if (historyRecords.length === 0) {
                    container.innerHTML = `
                        <div class="empty-history">
                            <i class="fas fa-history" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                            <p>è¿˜æ²¡æœ‰çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•</p>
                            <p style="font-size: 12px; color: #999;">å®Œæˆçº¿ä¸‹å‰§æƒ…å¯¹è¯åï¼Œé€‰æ‹©"ç»“æŸä¸”ä¸æ€»ç»“"æˆ–"ç»“æŸå¹¶æ€»ç»“"ï¼ŒèŠå¤©è®°å½•ä¼šä¿å­˜åœ¨è¿™é‡Œ</p>
                        </div>
                    `;
                    return;
                }

                historyRecords.forEach((record, index) => {
                    const recordElement = document.createElement('div');
                    recordElement.className = 'history-record-item';
                    const date = new Date(record.timestamp).toLocaleDateString();
                    recordElement.innerHTML = `
                        <div class="history-record-header">
                            <div class="history-record-info">
                                <div class="history-record-title">å‰§æƒ…è®°å½• #${historyRecords.length - index}</div>
                                <div class="history-record-meta">${date} â€¢ ${record.messageCount}æ¡æ¶ˆæ¯</div>
                            </div>
                            <div class="history-record-actions">
                                <button class="history-action-btn" onclick="viewOfflineHistory('${record.id}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="history-action-btn delete" onclick="deleteOfflineHistory('${record.id}')" title="åˆ é™¤è®°å½•">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="history-record-summary">${record.summary.substring(0, 100)}${record.summary.length > 100 ? '...' : ''}</div>
                    `;
                    container.appendChild(recordElement);
                });
            } catch (error) {
                console.error('åŠ è½½çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }

        // æŸ¥çœ‹å…·ä½“çš„èŠå¤©è®°å½•
        async function viewOfflineHistory(recordId) {
            if (!currentChatCharacter) return;

            try {
                const record = await db.offlineHistoryRecords.get(recordId);

                if (!record) {
                    showToast('æ‰¾ä¸åˆ°è¯¥èŠå¤©è®°å½•', 'error');
                    return;
                }

            // åˆ›å»ºæŸ¥çœ‹è¯¦æƒ…çš„æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
                    <div class="modal-header">
                        <h3>å‰§æƒ…è®°å½•è¯¦æƒ…</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto;">
                        <div class="history-detail-info">
                            <p><strong>æ—¥æœŸï¼š</strong>${record.date}</p>
                            <p><strong>æ¶ˆæ¯æ•°ï¼š</strong>${record.messageCount}æ¡</p>
                            <p><strong>å‰§æƒ…æ€»ç»“ï¼š</strong></p>
                            <div class="history-summary-text">${record.summary}</div>
                        </div>
                        <hr style="margin: 20px 0;">
                        <div class="history-messages">
                            <h4>å¯¹è¯è®°å½•ï¼š</h4>
                            <div class="history-messages-container">
                                ${record.messages.map(msg => `
                                    <div class="history-message ${msg.sender}">
                                        <div class="message-sender">${msg.sender === 'user' ? 'ç”¨æˆ·' : currentChatCharacter.name}</div>
                                        <div class="message-content">${msg.content}</div>
                                        <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('æŸ¥çœ‹çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å¤±è´¥:', error);
                showToast('æŸ¥çœ‹èŠå¤©è®°å½•å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤å•ä¸ªèŠå¤©è®°å½•
        async function deleteOfflineHistory(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            if (!currentChatCharacter) return;

            try {
                await db.offlineHistoryRecords.delete(recordId);
                loadOfflineHistoryList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                showToast('èŠå¤©è®°å½•å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('åˆ é™¤çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å¤±è´¥:', error);
                showToast('åˆ é™¤èŠå¤©è®°å½•å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•
        async function clearAllOfflineHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            if (!currentChatCharacter) return;

            try {
                await db.offlineHistoryRecords
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .delete();
                loadOfflineHistoryList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                showToast('æ‰€æœ‰èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
            } catch (error) {
                console.error('æ¸…ç©ºçº¿ä¸‹æ¨¡å¼èŠå¤©è®°å½•å¤±è´¥:', error);
                showToast('æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®åŠŸèƒ½
        let offlineUISettings = {};

        // ğŸ”¥ã€æ–°å¢ã€‘é¢„åŠ è½½æ‰€æœ‰è§’è‰²çš„çº¿ä¸‹æ¨¡å¼è®¾ç½®ï¼Œç¡®ä¿åˆ·æ–°åä¸ä¸¢å¤±
        async function preloadOfflineUISettings() {
            try {
                console.log('ğŸ”„ å¼€å§‹é¢„åŠ è½½çº¿ä¸‹æ¨¡å¼è®¾ç½®...');

                // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰çº¿ä¸‹æ¨¡å¼è®¾ç½®
                const allSettings = await db.offlineUISettings.toArray();
                console.log(`ğŸ“¦ ä»æ•°æ®åº“åŠ è½½äº† ${allSettings.length} ä¸ªçº¿ä¸‹æ¨¡å¼è®¾ç½®`);

                // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è®¾ç½®ï¼Œå°è¯•ä»localStorageè¿ç§»
                if (allSettings.length === 0) {
                    console.log('ğŸ”„ æ•°æ®åº“ä¸­æ— è®¾ç½®ï¼Œå°è¯•ä»localStorageè¿ç§»...');

                    // æ£€æŸ¥localStorageä¸­çš„çº¿ä¸‹æ¨¡å¼è®¾ç½®
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('offlineUISettings_')) {
                            try {
                                const settingsData = localStorage.getItem(key);
                                if (settingsData) {
                                    const parsedSettings = JSON.parse(settingsData);

                                    // æå–è§’è‰²ID
                                    const characterId = key.replace('offlineUISettings_', '').split('_')[0];

                                    // è¿ç§»åˆ°æ•°æ®åº“
                                    const dbKey = `${characterId}_ui_settings`;
                                    await db.offlineUISettings.put({
                                        id: dbKey,
                                        characterId: characterId,
                                        windowId: null,
                                        settings: parsedSettings,
                                        timestamp: Date.now()
                                    });

                                    console.log(`âœ… å·²è¿ç§»è§’è‰² ${characterId} çš„çº¿ä¸‹æ¨¡å¼è®¾ç½®åˆ°æ•°æ®åº“`);
                                }
                            } catch (error) {
                                console.warn(`âš ï¸ è¿ç§»è®¾ç½®å¤±è´¥ (${key}):`, error);
                            }
                        }
                    }
                }

                console.log('âœ… çº¿ä¸‹æ¨¡å¼è®¾ç½®é¢„åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒ é¢„åŠ è½½çº¿ä¸‹æ¨¡å¼è®¾ç½®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºçº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        function showOfflineUISettings() {
            if (!currentChatCharacter) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', 'warning');
                return;
            }

            document.getElementById('offline-ui-settings-modal').style.display = 'flex';
            loadOfflineUISettings();
        }

        // å…³é—­çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        function closeOfflineUISettings() {
            document.getElementById('offline-ui-settings-modal').style.display = 'none';
        }

        // åŠ è½½çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        async function loadOfflineUISettings() {
            if (!currentChatCharacter) return;

            const characterId = currentChatCharacter.id;

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿æŒçª—å£éš”ç¦»çš„åŒæ—¶å¢å¼ºæ‰‹æœºæµè§ˆå™¨å…¼å®¹æ€§
                let settingsRecord = null;
                let loadedFromDB = false;

                // é¦–å…ˆå°è¯•ä»æ•°æ®åº“åŠ è½½å¸¦çª—å£IDçš„è®¾ç½®ï¼ˆä¿æŒéš”ç¦»ï¼‰
                if (windowId) {
                    try {
                        settingsRecord = await db.offlineUISettings.get(`${characterId}_${windowId}_ui_settings`);
                        if (settingsRecord && settingsRecord.settings) {
                            loadedFromDB = true;
                            console.log(`âœ… ä»æ•°æ®åº“åŠ è½½çª—å£éš”ç¦»è®¾ç½®æˆåŠŸ (çª—å£${windowId})`);
                        }
                    } catch (dbError) {
                        console.warn('æ•°æ®åº“åŠ è½½çª—å£éš”ç¦»è®¾ç½®å¤±è´¥:', dbError);
                    }
                }

                // å¦‚æœçª—å£éš”ç¦»è®¾ç½®åŠ è½½å¤±è´¥ï¼Œå°è¯•é€šç”¨æ ¼å¼ï¼ˆå…¼å®¹æ€§å›é€€ï¼‰
                if (!loadedFromDB) {
                    try {
                        settingsRecord = await db.offlineUISettings.get(`${characterId}_ui_settings`);
                        if (settingsRecord && settingsRecord.settings) {
                            loadedFromDB = true;
                            console.log(`âœ… ä»æ•°æ®åº“åŠ è½½é€šç”¨æ ¼å¼è®¾ç½®æˆåŠŸï¼ˆå›é€€æ¨¡å¼ï¼‰`);
                        }
                    } catch (dbError) {
                        console.warn('æ•°æ®åº“åŠ è½½é€šç”¨æ ¼å¼è®¾ç½®ä¹Ÿå¤±è´¥:', dbError);
                    }
                }

                // å¦‚æœæ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œç«‹å³å°è¯•localStorage
                if (!loadedFromDB) {
                    try {
                        let savedSettings = null;
                        let storageKey = null;

                        // ä¼˜å…ˆå°è¯•å¸¦çª—å£IDçš„è®¾ç½®ï¼ˆä¿æŒéš”ç¦»ï¼‰
                        if (windowId) {
                            storageKey = `offlineUISettings_${characterId}_${windowId}`;
                            savedSettings = localStorage.getItem(storageKey);
                        }

                        // å¦‚æœçª—å£éš”ç¦»è®¾ç½®ä¸å­˜åœ¨ï¼Œå°è¯•é€šç”¨æ ¼å¼ï¼ˆå…¼å®¹æ€§å›é€€ï¼‰
                        if (!savedSettings) {
                            storageKey = `offlineUISettings_${characterId}`;
                            savedSettings = localStorage.getItem(storageKey);
                        }

                        if (savedSettings) {
                            const parsedSettings = JSON.parse(savedSettings);
                            settingsRecord = { settings: parsedSettings };
                            console.log(`âœ… ä»localStorageåŠ è½½è®¾ç½®æˆåŠŸ (${storageKey})`);

                            // ğŸ”¥ã€å¢å¼ºã€‘å¼‚æ­¥è¿ç§»åˆ°æ•°æ®åº“ï¼Œä¼˜å…ˆä¿å­˜ä¸ºçª—å£éš”ç¦»æ ¼å¼
                            setTimeout(async () => {
                                try {
                                    const dbKey = windowId ? `${characterId}_${windowId}_ui_settings` : `${characterId}_ui_settings`;
                                    await db.offlineUISettings.put({
                                        id: dbKey,
                                        characterId: characterId,
                                        windowId: windowId || null,
                                        settings: parsedSettings,
                                        timestamp: Date.now()
                                    });
                                    console.log(`âœ… è®¾ç½®å·²å¼‚æ­¥è¿ç§»åˆ°æ•°æ®åº“ (${dbKey})`);
                                } catch (migrateError) {
                                    console.warn('å¼‚æ­¥è¿ç§»å¤±è´¥ï¼Œä½†ä¸å½±å“å½“å‰ä½¿ç”¨:', migrateError);
                                }
                            }, 100);
                        }
                    } catch (localStorageError) {
                        console.warn('localStorageåŠ è½½ä¹Ÿå¤±è´¥:', localStorageError);
                    }
                }

                if (settingsRecord && settingsRecord.settings) {
                    offlineUISettings = settingsRecord.settings;
                    console.log(`âœ… çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®åŠ è½½æˆåŠŸ`);
                } else {
                    console.log(`ğŸ“ æœªæ‰¾åˆ°è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®`);
                    // é»˜è®¤è®¾ç½®
                    offlineUISettings = {
                        myBubbleColor: '#BED6EF', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ°”æ³¡æ”¹ä¸ºæ·¡è“è‰² */
                        aiBubbleColor: '#f0f0f0',
                        bubbleOpacity: 0.9,
                        fontSize: 15,
                        wallpaperData: '',
                        fontFamily: '',
                        fontUrl: '',
                        userNormalTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                        userItalicTextColor: '#333333', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–œä½“æ–‡å­—æ”¹ä¸ºæ·±ç°è‰² */
                        userBoldTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·ç²—ä½“æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                        aiNormalTextColor: '#000000',
                        aiItalicTextColor: '#666666',
                        aiBoldTextColor: '#333333',
                        showUserAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é»˜è®¤ä¸æ˜¾ç¤ºç”¨æˆ·å¤´åƒ */
                        showAiAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é»˜è®¤ä¸æ˜¾ç¤ºAIå¤´åƒ */
                        avatarPosition: 'side',
                        bubbleWidth: 'default',
                        bubbleStyle: 'default',
                        customCSS: '',
                        savedColors: {
                            userNormal: [],
                            userItalic: [],
                            userBold: [],
                            aiNormal: [],
                            aiItalic: [],
                            aiBold: []
                        }
                    };
                }

                // æ›´æ–°ç•Œé¢
                updateOfflineUISettingsForm();
                updateOfflinePreview();

            } catch (error) {
                console.error('åŠ è½½çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å®Œå…¨å¤±è´¥:', error);
                // ğŸ”¥ã€å¢å¼ºã€‘å³ä½¿å®Œå…¨å¤±è´¥ä¹Ÿè¦ç¡®ä¿æœ‰é»˜è®¤è®¾ç½®
                offlineUISettings = {
                    myBubbleColor: '#BED6EF', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ°”æ³¡æ”¹ä¸ºæ·¡è“è‰² */
                    aiBubbleColor: '#f0f0f0',
                    bubbleOpacity: 0.9,
                    fontSize: 15,
                    wallpaperData: '',
                    fontFamily: '',
                    fontUrl: '',
                    userNormalTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                    userItalicTextColor: '#333333', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–œä½“æ–‡å­—æ”¹ä¸ºæ·±ç°è‰² */
                    userBoldTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·ç²—ä½“æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                    aiNormalTextColor: '#000000',
                    aiItalicTextColor: '#666666',
                    aiBoldTextColor: '#333333',
                    showUserAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é»˜è®¤ä¸æ˜¾ç¤ºç”¨æˆ·å¤´åƒ */
                    showAiAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é»˜è®¤ä¸æ˜¾ç¤ºAIå¤´åƒ */
                    avatarPosition: 'side',
                    bubbleWidth: 'default',
                    bubbleStyle: 'default',
                    customCSS: '',
                    savedColors: {
                        userNormal: [],
                        userItalic: [],
                        userBold: [],
                        aiNormal: [],
                        aiItalic: [],
                        aiBold: []
                    }
                };
                updateOfflineUISettingsForm();
                updateOfflinePreview();
            }
        }

        // æ›´æ–°è®¾ç½®è¡¨å•
        function updateOfflineUISettingsForm() {
            document.getElementById('offline-my-bubble-color').value = offlineUISettings.myBubbleColor;
            document.getElementById('offline-ai-bubble-color').value = offlineUISettings.aiBubbleColor;
            document.getElementById('offline-bubble-opacity').value = offlineUISettings.bubbleOpacity;
            document.getElementById('offline-opacity-value').textContent = Math.round(offlineUISettings.bubbleOpacity * 100) + '%';

            // ğŸ”¥ã€æ–°å¢ã€‘è®¾ç½®å­—ä½“å¤§å°
            document.getElementById('offline-font-size').value = offlineUISettings.fontSize || 15;
            document.getElementById('offline-font-size-value').textContent = (offlineUISettings.fontSize || 15) + 'px';

            // è®¾ç½®å­—ä½“é€‰æ‹©
            document.getElementById('offline-font-select').value = offlineUISettings.fontFamily || '';
            if (offlineUISettings.fontFamily === 'custom') {
                document.getElementById('custom-font-input').style.display = 'block';
                document.getElementById('offline-font-url').value = offlineUISettings.fontUrl || '';
            } else {
                document.getElementById('custom-font-input').style.display = 'none';
            }

            // è®¾ç½®æ–‡å­—é¢œè‰²ï¼ˆç¡®ä¿æœ‰é»˜è®¤å€¼ï¼‰
            document.getElementById('offline-user-normal-text-color').value = offlineUISettings.userNormalTextColor || '#ffffff';
            document.getElementById('offline-user-italic-text-color').value = offlineUISettings.userItalicTextColor || '#f0f0f0';
            document.getElementById('offline-user-bold-text-color').value = offlineUISettings.userBoldTextColor || '#ffffff';
            document.getElementById('offline-ai-normal-text-color').value = offlineUISettings.aiNormalTextColor || '#000000';
            document.getElementById('offline-ai-italic-text-color').value = offlineUISettings.aiItalicTextColor || '#666666';
            document.getElementById('offline-ai-bold-text-color').value = offlineUISettings.aiBoldTextColor || '#333333';

            // è®¾ç½®å¤´åƒå’Œæ ·å¼é€‰é¡¹
            document.getElementById('offline-show-user-avatar').checked = offlineUISettings.showUserAvatar === true;
            document.getElementById('offline-show-ai-avatar').checked = offlineUISettings.showAiAvatar === true;

            // è®¾ç½®å•é€‰æŒ‰é’®
            const avatarPosition = offlineUISettings.avatarPosition || 'side';
            document.querySelector(`input[name="offline-avatar-position"][value="${avatarPosition}"]`).checked = true;

            const bubbleWidth = offlineUISettings.bubbleWidth || 'default';
            document.querySelector(`input[name="offline-bubble-width"][value="${bubbleWidth}"]`).checked = true;

            const bubbleStyle = offlineUISettings.bubbleStyle || 'default';
            document.querySelector(`input[name="offline-bubble-style"][value="${bubbleStyle}"]`).checked = true;

            // è®¾ç½®è‡ªå®šä¹‰CSS
            document.getElementById('offline-custom-css').value = offlineUISettings.customCSS || '';

            // æ›´æ–°é¢„å­˜é¢œè‰²
            updateSavedColorsDisplay();

            // ç›‘å¬é€æ˜åº¦æ»‘å—å˜åŒ–
            const opacitySlider = document.getElementById('offline-bubble-opacity');
            opacitySlider.oninput = function() {
                const value = Math.round(this.value * 100);
                document.getElementById('offline-opacity-value').textContent = value + '%';
                updateOfflinePreview();
            };

            // ğŸ”¥ã€æ–°å¢ã€‘ç›‘å¬å­—ä½“å¤§å°æ»‘å—å˜åŒ–
            const fontSizeSlider = document.getElementById('offline-font-size');
            fontSizeSlider.oninput = function() {
                const value = this.value;
                document.getElementById('offline-font-size-value').textContent = value + 'px';
                updateOfflinePreview();
            };

            // ç›‘å¬é¢œè‰²è¾“å…¥å˜åŒ–
            ['offline-my-bubble-color', 'offline-ai-bubble-color',
             'offline-user-normal-text-color', 'offline-user-italic-text-color', 'offline-user-bold-text-color',
             'offline-ai-normal-text-color', 'offline-ai-italic-text-color', 'offline-ai-bold-text-color'].forEach(id => {
                document.getElementById(id).oninput = updateOfflinePreview;
            });

            // ç›‘å¬å¤´åƒå’Œæ ·å¼è®¾ç½®å˜åŒ–
            document.getElementById('offline-show-user-avatar').onchange = updateOfflinePreview;
            document.getElementById('offline-show-ai-avatar').onchange = updateOfflinePreview;

            document.querySelectorAll('input[name="offline-avatar-position"]').forEach(radio => {
                radio.onchange = updateOfflinePreview;
            });

            document.querySelectorAll('input[name="offline-bubble-width"]').forEach(radio => {
                radio.onchange = updateOfflinePreview;
            });

            document.querySelectorAll('input[name="offline-bubble-style"]').forEach(radio => {
                radio.onchange = updateOfflinePreview;
            });

            // ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–ï¼Œæ§åˆ¶ç›¸å…³åŠŸèƒ½
            document.querySelectorAll('input[name="offline-avatar-position"]').forEach(radio => {
                radio.onchange = function() {
                    if (this.value === 'custom') {
                        showToast('è¯·åœ¨ä¸‹æ–¹CSSä»£ç åŒºåŸŸè‡ªå®šä¹‰å¤´åƒä½ç½®', 'info');
                    }
                };
            });

            document.querySelectorAll('input[name="offline-bubble-width"]').forEach(radio => {
                radio.onchange = function() {
                    if (this.value === 'custom') {
                        showToast('è¯·åœ¨ä¸‹æ–¹CSSä»£ç åŒºåŸŸè‡ªå®šä¹‰æ°”æ³¡å®½åº¦', 'info');
                    } else {
                        // åº”ç”¨é»˜è®¤90%å®½åº¦
                        applyDefaultBubbleWidth();
                    }
                };
            });

            document.querySelectorAll('input[name="offline-bubble-style"]').forEach(radio => {
                radio.onchange = function() {
                    if (this.value === 'custom') {
                        showToast('è¯·åœ¨ä¸‹æ–¹CSSä»£ç åŒºåŸŸè‡ªå®šä¹‰æ°”æ³¡æ ·å¼', 'info');
                    } else {
                        // åº”ç”¨é»˜è®¤æ ·å¼
                        applyDefaultBubbleStyle();
                    }
                };
            });
        }

        // åº”ç”¨é»˜è®¤æ°”æ³¡å®½åº¦
        function applyDefaultBubbleWidth() {
            // ç§»é™¤è‡ªå®šä¹‰å®½åº¦æ ·å¼ï¼Œæ¢å¤CSSè§„åˆ™æ§åˆ¶
            const existingStyle = document.getElementById('offline-custom-width-style');
            if (existingStyle) {
                existingStyle.remove();
            }

            showToast('å·²æ¢å¤é»˜è®¤æ°”æ³¡å®½åº¦ï¼ˆæ ¹æ®å¤´åƒæ˜¾ç¤ºçŠ¶æ€è‡ªåŠ¨è°ƒæ•´ï¼‰', 'success');
        }

        // åº”ç”¨é»˜è®¤æ°”æ³¡æ ·å¼
        function applyDefaultBubbleStyle() {
            // ç§»é™¤è‡ªå®šä¹‰æ ·å¼
            const existingStyle = document.getElementById('offline-custom-style-style');
            if (existingStyle) {
                existingStyle.remove();
            }

            // åº”ç”¨é»˜è®¤æ ·å¼ï¼ˆè¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ é»˜è®¤æ ·å¼ï¼‰
            showToast('å·²åº”ç”¨é»˜è®¤æ°”æ³¡æ ·å¼', 'success');
        }

        // æ›´æ–°é¢„å­˜é¢œè‰²æ˜¾ç¤º
        function updateSavedColorsDisplay() {
            const types = ['userNormal', 'userItalic', 'userBold', 'aiNormal', 'aiItalic', 'aiBold'];
            const typeMapping = {
                'userNormal': 'offline-user-normal',
                'userItalic': 'offline-user-italic',
                'userBold': 'offline-user-bold',
                'aiNormal': 'offline-ai-normal',
                'aiItalic': 'offline-ai-italic',
                'aiBold': 'offline-ai-bold'
            };

            types.forEach(type => {
                const container = document.getElementById(`${typeMapping[type]}-saved-colors`);
                if (container) {
                    container.innerHTML = '';

                    if (offlineUISettings.savedColors[type]) {
                        offlineUISettings.savedColors[type].forEach(color => {
                            const colorItem = document.createElement('div');
                            colorItem.className = 'saved-color-item';
                            colorItem.style.backgroundColor = color;
                            colorItem.title = color;
                            colorItem.onclick = () => {
                                document.getElementById(`${typeMapping[type]}-text-color`).value = color;
                                updateOfflinePreview();
                            };
                            container.appendChild(colorItem);
                        });
                    }
                }
            });
        }

        // æ›´æ–°é¢„è§ˆæ•ˆæœ
        function updateOfflinePreview() {
            const myBubbleColor = document.getElementById('offline-my-bubble-color').value;
            const aiBubbleColor = document.getElementById('offline-ai-bubble-color').value;
            const bubbleOpacity = document.getElementById('offline-bubble-opacity').value;

            const userNormalTextColor = document.getElementById('offline-user-normal-text-color').value;
            const userItalicTextColor = document.getElementById('offline-user-italic-text-color').value;
            const userBoldTextColor = document.getElementById('offline-user-bold-text-color').value;

            const aiNormalTextColor = document.getElementById('offline-ai-normal-text-color').value;
            const aiItalicTextColor = document.getElementById('offline-ai-italic-text-color').value;
            const aiBoldTextColor = document.getElementById('offline-ai-bold-text-color').value;

            // æ›´æ–°CSSå˜é‡
            const root = document.documentElement;
            root.style.setProperty('--offline-my-bubble-color', myBubbleColor);
            root.style.setProperty('--offline-ai-bubble-color', aiBubbleColor);
            root.style.setProperty('--offline-user-normal-text-color', userNormalTextColor);
            root.style.setProperty('--offline-user-italic-text-color', userItalicTextColor);
            root.style.setProperty('--offline-user-bold-text-color', userBoldTextColor);
            root.style.setProperty('--offline-ai-normal-text-color', aiNormalTextColor);
            root.style.setProperty('--offline-ai-italic-text-color', aiItalicTextColor);
            root.style.setProperty('--offline-ai-bold-text-color', aiBoldTextColor);

            // æ›´æ–°é¢„è§ˆåŒºåŸŸ
            const userBubble = document.querySelector('.offline-preview-message.user .offline-preview-content');
            const aiBubble = document.querySelector('.offline-preview-message.ai .offline-preview-content');

            if (userBubble) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²ï¼Œåªè®©èƒŒæ™¯é€æ˜ï¼Œæ–‡å­—ä¿æŒä¸é€æ˜
                const userBgColor = convertColorWithOpacity(myBubbleColor, bubbleOpacity);
                userBubble.style.backgroundColor = userBgColor;
                userBubble.style.opacity = 1; // ç¡®ä¿æ•´ä¸ªå…ƒç´ ä¸é€æ˜
                userBubble.style.color = userNormalTextColor;

                // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çš„æ–œä½“å’ŒåŠ ç²—æ–‡å­—é¢œè‰²
                const userItalicText = userBubble.querySelector('em');
                const userBoldText = userBubble.querySelector('strong');
                if (userItalicText) userItalicText.style.color = userItalicTextColor;
                if (userBoldText) userBoldText.style.color = userBoldTextColor;
            }

            if (aiBubble) {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²ï¼Œåªè®©èƒŒæ™¯é€æ˜ï¼Œæ–‡å­—ä¿æŒä¸é€æ˜
                const aiBgColor = convertColorWithOpacity(aiBubbleColor, bubbleOpacity);
                aiBubble.style.backgroundColor = aiBgColor;
                aiBubble.style.opacity = 1; // ç¡®ä¿æ•´ä¸ªå…ƒç´ ä¸é€æ˜
                aiBubble.style.color = aiNormalTextColor;

                // æ›´æ–°AIæ¶ˆæ¯çš„æ–œä½“å’ŒåŠ ç²—æ–‡å­—é¢œè‰²
                const aiItalicText = aiBubble.querySelector('em');
                const aiBoldText = aiBubble.querySelector('strong');
                if (aiItalicText) aiItalicText.style.color = aiItalicTextColor;
                if (aiBoldText) aiBoldText.style.color = aiBoldTextColor;
            }

            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            const showUserAvatar = document.getElementById('offline-show-user-avatar').checked;
            const showAiAvatar = document.getElementById('offline-show-ai-avatar').checked;
            const userAvatar = document.getElementById('preview-user-avatar');
            const aiAvatar = document.getElementById('preview-ai-avatar');

            // è·å–é¢„è§ˆæ¶ˆæ¯å®¹å™¨
            const allPreviewMessages = document.querySelectorAll('.offline-preview-message');

            // æ¸…é™¤æ‰€æœ‰ç›¸å…³çš„ç±»
            allPreviewMessages.forEach(container => {
                container.classList.remove('no-user-avatar', 'no-ai-avatar');
            });

            if (userAvatar) {
                userAvatar.style.display = showUserAvatar ? 'flex' : 'none';
            }
            if (aiAvatar) {
                aiAvatar.style.display = showAiAvatar ? 'flex' : 'none';
            }

            // ğŸ”¥ã€ä¿®æ­£ã€‘æ ¹æ®å¤´åƒæ˜¾ç¤ºçŠ¶æ€æ·»åŠ å¯¹åº”çš„ç±»
            allPreviewMessages.forEach(container => {
                if (!showUserAvatar) {
                    container.classList.add('no-user-avatar');
                }
                if (!showAiAvatar) {
                    container.classList.add('no-ai-avatar');
                }
            });

            // æ›´æ–°æ°”æ³¡å®½åº¦
            const bubbleWidth = document.querySelector('input[name="offline-bubble-width"]:checked').value;
            const avatarPosition = document.querySelector('input[name="offline-avatar-position"]:checked').value;
            const bubbleStyle = document.querySelector('input[name="offline-bubble-style"]:checked').value;

            const previewContents = document.querySelectorAll('.offline-preview-content');
            const previewMessages = document.querySelectorAll('.offline-preview-message');

            // åº”ç”¨æ°”æ³¡å®½åº¦
            previewContents.forEach(content => {
                if (bubbleWidth === 'default') {
                    // æ¸…é™¤å†…è”æ ·å¼ï¼Œè®©CSSè§„åˆ™è‡ªåŠ¨å¤„ç†å®½åº¦ï¼ˆæ ¹æ®å¤´åƒæ˜¾ç¤ºçŠ¶æ€ï¼‰
                    content.style.maxWidth = '';
                } else {
                    // è‡ªå®šä¹‰CSSæ§åˆ¶æ—¶ï¼Œå¦‚æœæœ‰CSSä»£ç åˆ™åº”ç”¨ï¼Œå¦åˆ™ä¿æŒå½“å‰æ ·å¼
                    const customCSS = document.getElementById('offline-custom-css').value.trim();
                    if (customCSS) {
                        // CSSä»£ç ä¼šé€šè¿‡é¢„è§ˆåŠŸèƒ½åº”ç”¨
                    }
                }
            });

            // åº”ç”¨å¤´åƒä½ç½®
            previewMessages.forEach(message => {
                if (avatarPosition === 'side') {
                    // æ¢å¤é»˜è®¤ä¾§è¾¹å¸ƒå±€
                    if (message.classList.contains('user')) {
                        message.style.flexDirection = 'row-reverse';
                    } else {
                        message.style.flexDirection = 'row';
                    }
                } else {
                    // è‡ªå®šä¹‰CSSæ§åˆ¶æ—¶ï¼Œç§»é™¤å†…è”æ ·å¼è®©CSSä»£ç ç”Ÿæ•ˆ
                    message.style.flexDirection = '';
                }
            });
        }

        // å¤„ç†å£çº¸ä¸Šä¼ 
        function handleOfflineWallpaperUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                input.value = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB', 'warning');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;

                // é¢„è§ˆå£çº¸
                const previewArea = document.getElementById('offline-preview-area');
                previewArea.style.backgroundImage = `url(${imageData})`;
                previewArea.style.backgroundSize = 'cover';
                previewArea.style.backgroundPosition = 'center';

                // ä¿å­˜åˆ°è®¾ç½®ä¸­
                offlineUISettings.wallpaperData = imageData;

                showToast('å£çº¸å·²ä¸Šä¼ å¹¶é¢„è§ˆ', 'success');
            };
            reader.readAsDataURL(file);
        }

        // æ¸…é™¤å£çº¸
        function clearOfflineWallpaper() {
            document.getElementById('offline-wallpaper-file').value = '';
            const previewArea = document.getElementById('offline-preview-area');
            previewArea.style.backgroundImage = '';
            offlineUISettings.wallpaperData = '';
            showToast('å£çº¸å·²æ¸…é™¤', 'success');
        }

        // å¤„ç†å­—ä½“é€‰æ‹©å˜åŒ–
        function handleOfflineFontChange() {
            const fontSelect = document.getElementById('offline-font-select');
            const customInput = document.getElementById('custom-font-input');

            if (fontSelect.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
                // åº”ç”¨å†…ç½®å­—ä½“
                applyBuiltinFont(fontSelect.value);
            }
        }

        // åº”ç”¨å†…ç½®å­—ä½“
        function applyBuiltinFont(fontName) {
            // æ¸…é™¤è‡ªå®šä¹‰å­—ä½“æ ·å¼ï¼Œæ¢å¤é»˜è®¤å­—ä½“
            const existingStyle = document.getElementById('offline-custom-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }

            if (fontName) {
                showToast(`å·²æ¢å¤ç³»ç»Ÿé»˜è®¤å­—ä½“`, 'success');
            }
        }

        // é¢„è§ˆè‡ªå®šä¹‰CSS
        function previewOfflineCSS() {
            const cssCode = document.getElementById('offline-custom-css').value.trim();

            // ç§»é™¤ä¹‹å‰çš„é¢„è§ˆæ ·å¼
            const existingStyle = document.getElementById('offline-custom-css-preview');
            if (existingStyle) {
                existingStyle.remove();
            }

            if (!cssCode) {
                showToast('è¯·è¾“å…¥CSSä»£ç ', 'warning');
                return;
            }

            try {
                // åˆ›å»ºæ ·å¼å…ƒç´ 
                const style = document.createElement('style');
                style.id = 'offline-custom-css-preview';

                // ä¸ºCSSä»£ç æ·»åŠ ä½œç”¨åŸŸï¼Œåªå½±å“é¢„è§ˆåŒºåŸŸ
                const scopedCSS = cssCode.replace(/\.offline-/g, '.offline-preview-area .offline-');
                style.textContent = scopedCSS;

                document.head.appendChild(style);
                showToast('CSSé¢„è§ˆå·²åº”ç”¨', 'success');

            } catch (error) {
                console.error('CSSé¢„è§ˆå¤±è´¥:', error);
                showToast('CSSä»£ç æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•', 'error');
            }
        }

        // æ¸…é™¤è‡ªå®šä¹‰CSS
        function clearOfflineCSS() {
            document.getElementById('offline-custom-css').value = '';

            // ç§»é™¤é¢„è§ˆæ ·å¼
            const existingStyle = document.getElementById('offline-custom-css-preview');
            if (existingStyle) {
                existingStyle.remove();
            }

            showToast('CSSä»£ç å·²æ¸…é™¤', 'success');
        }

        // é¢„è§ˆå­—ä½“
        function previewOfflineFont() {
            const url = document.getElementById('offline-font-url').value.trim();
            if (!url) {
                showToast('è¯·è¾“å…¥å­—ä½“URL', 'warning');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„å­—ä½“æ ·å¼
            const existingStyle = document.getElementById('offline-custom-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            const existingLink = document.getElementById('offline-custom-font-link');
            if (existingLink) {
                existingLink.remove();
            }

            // åˆ¤æ–­æ˜¯CSSé“¾æ¥è¿˜æ˜¯ç›´æ¥å­—ä½“æ–‡ä»¶
            if (url.includes('fonts.googleapis.com') || url.includes('fonts.google.com') || url.endsWith('.css') || url.includes('fontsapi') || url.includes('css')) {
                // Google Fontsæˆ–å…¶ä»–CSSé“¾æ¥
                console.log('ğŸ¨ å¼€å§‹åŠ è½½å­—ä½“CSS:', url);
                const link = document.createElement('link');
                link.id = 'offline-custom-font-link';
                link.rel = 'stylesheet';
                link.href = url;
                link.crossOrigin = 'anonymous'; // ğŸ”¥ã€æ–°å¢ã€‘æ·»åŠ è·¨åŸŸæ”¯æŒ
                link.onload = function() {
                    // ğŸ”¥ã€ä¿®å¤ã€‘å°è¯•ä»CSSä¸­æå–å­—ä½“åç§°ï¼Œæˆ–ä½¿ç”¨é€šç”¨åç§°
                    let fontFamily = extractFontFamilyFromGoogleFonts(url) || 'CustomFont';
                    console.log('ğŸ¨ å­—ä½“CSSåŠ è½½æˆåŠŸï¼Œæå–çš„å­—ä½“åç§°:', fontFamily);
                    console.log('ğŸ¨ å­—ä½“URL:', url);

                    // ğŸ”¥ã€æ–°å¢ã€‘å°è¯•ä»åŠ è½½çš„CSSä¸­æå–çœŸæ­£çš„å­—ä½“åç§°
                    try {
                        const sheets = document.styleSheets;
                        for (let i = sheets.length - 1; i >= 0; i--) {
                            const sheet = sheets[i];
                            if (sheet.href === url) {
                                try {
                                    const rules = sheet.cssRules || sheet.rules;
                                    for (let j = 0; j < rules.length; j++) {
                                        const rule = rules[j];
                                        if (rule.type === CSSRule.FONT_FACE_RULE && rule.style.fontFamily) {
                                            fontFamily = rule.style.fontFamily.replace(/['"]/g, '');
                                            console.log('ğŸ¨ ä»CSSä¸­æå–åˆ°çœŸå®å­—ä½“åç§°:', fontFamily);
                                            break;
                                        }
                                    }
                                } catch (e) {
                                    console.log('ğŸ¨ æ— æ³•è¯»å–CSSè§„åˆ™ï¼Œä½¿ç”¨æå–çš„åç§°');
                                }
                                break;
                            }
                        }
                    } catch (e) {
                        console.log('ğŸ¨ CSSè§£æå¤±è´¥ï¼Œä½¿ç”¨æå–çš„åç§°');
                    }

                    const style = document.createElement('style');
                    style.id = 'offline-custom-font-style';
                    style.textContent = `
                        .offline-preview-content,
                        #offline-mode-overlay .offline-message-content {
                            font-family: '${fontFamily}', sans-serif !important;
                        }
                    `;
                    document.head.appendChild(style);
                    console.log('ğŸ¨ å­—ä½“æ ·å¼å·²åº”ç”¨åˆ°é¡µé¢ï¼Œæœ€ç»ˆå­—ä½“åç§°:', fontFamily);

                    // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜çœŸå®çš„å­—ä½“åç§°åˆ°å…¨å±€å˜é‡ï¼Œä¾›ä¿å­˜è®¾ç½®æ—¶ä½¿ç”¨
                    window.previewedFontName = fontFamily;

                    // ğŸ”¥ã€æ–°å¢ã€‘éªŒè¯å­—ä½“æ˜¯å¦çœŸçš„è¢«åº”ç”¨
                    setTimeout(() => {
                        const testElement = document.querySelector('#offline-mode-overlay .offline-message-content');
                        if (testElement) {
                            const computedStyle = window.getComputedStyle(testElement);
                            console.log('ğŸ¨ å®é™…åº”ç”¨çš„å­—ä½“:', computedStyle.fontFamily);
                        }
                    }, 1000);

                    showToast(`å­—ä½“CSSå·²åŠ è½½ï¼Œå­—ä½“åç§°: ${fontFamily}`, 'success');
                };
                link.onerror = function() {
                    console.error('ğŸ¨ å­—ä½“CSSåŠ è½½å¤±è´¥:', url);
                    showToast('å­—ä½“CSSåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URL', 'error');
                };
                document.head.appendChild(link);
            } else {
                // ç›´æ¥å­—ä½“æ–‡ä»¶
                const fontName = 'OfflineCustomFont';
                const style = document.createElement('style');
                style.id = 'offline-custom-font-style';
                style.textContent = `
                    @font-face {
                        font-family: '${fontName}';
                        src: url('${url}');
                    }
                    .offline-preview-content,
                    #offline-mode-overlay .offline-message-content {
                        font-family: '${fontName}', sans-serif !important;
                    }
                `;
                document.head.appendChild(style);
                showToast('å­—ä½“æ–‡ä»¶é¢„è§ˆå·²åº”ç”¨', 'success');
            }
        }

        // ä»Google Fonts URLä¸­æå–å­—ä½“åç§°
        function extractFontFamilyFromGoogleFonts(url) {
            try {
                // Google Fonts: åŒ¹é… family= å‚æ•°
                const match = url.match(/family=([^&:]+)/);
                if (match) {
                    let fontName = decodeURIComponent(match[1]);
                    // æ›¿æ¢ + ä¸ºç©ºæ ¼ï¼Œç§»é™¤æƒé‡ä¿¡æ¯ï¼ˆå¦‚ :300,400,700ï¼‰
                    fontName = fontName.replace(/\+/g, ' ').replace(/:.*$/, '');
                    return fontName;
                }

                // å¦‚æœæ˜¯æ–°ç‰ˆGoogle Fonts APIæ ¼å¼ï¼Œå°è¯•å…¶ä»–åŒ¹é…æ–¹å¼
                const match2 = url.match(/family=([^&]+)/);
                if (match2) {
                    let fontName = decodeURIComponent(match2[1]);
                    fontName = fontName.replace(/\+/g, ' ').split(':')[0];
                    return fontName;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘å…¶ä»–å­—ä½“æœåŠ¡ï¼šå°è¯•ä»URLè·¯å¾„ä¸­æå–
                const pathMatch = url.match(/\/([^\/]+)\.css/);
                if (pathMatch) {
                    return pathMatch[1].replace(/[-_]/g, ' ');
                }

                // ğŸ”¥ã€æ–°å¢ã€‘å°è¯•ä»URLä¸­æå–æ•°å­—IDæˆ–åç§°
                const idMatch = url.match(/\/(\d+)\//);
                if (idMatch) {
                    return `CustomFont-${idMatch[1]}`;
                }

                // ğŸ”¥ã€æ–°å¢ã€‘ä»åŸŸåæå–æœåŠ¡åç§°
                const domainMatch = url.match(/\/\/([^.]+)/);
                if (domainMatch) {
                    return `${domainMatch[1]}-Font`;
                }
            } catch (e) {
                console.warn('æ— æ³•æå–å­—ä½“åç§°:', e);
            }
            return 'CustomFont'; // é»˜è®¤å­—ä½“åç§°
        }

        // æ¸…é™¤å­—ä½“
        function clearOfflineFont() {
            document.getElementById('offline-font-url').value = '';
            const existingStyle = document.getElementById('offline-custom-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            showToast('å­—ä½“å·²æ¸…é™¤', 'success');
        }

        // ä¿å­˜å½“å‰é¢œè‰²åˆ°é¢„å­˜
        function saveCurrentOfflineColors() {
            const userNormalColor = document.getElementById('offline-user-normal-text-color').value;
            const userItalicColor = document.getElementById('offline-user-italic-text-color').value;
            const userBoldColor = document.getElementById('offline-user-bold-text-color').value;
            const aiNormalColor = document.getElementById('offline-ai-normal-text-color').value;
            const aiItalicColor = document.getElementById('offline-ai-italic-text-color').value;
            const aiBoldColor = document.getElementById('offline-ai-bold-text-color').value;

            // æ·»åŠ åˆ°é¢„å­˜é¢œè‰²ï¼ˆé¿å…é‡å¤ï¼‰
            const colorTypes = [
                { type: 'userNormal', color: userNormalColor },
                { type: 'userItalic', color: userItalicColor },
                { type: 'userBold', color: userBoldColor },
                { type: 'aiNormal', color: aiNormalColor },
                { type: 'aiItalic', color: aiItalicColor },
                { type: 'aiBold', color: aiBoldColor }
            ];

            colorTypes.forEach(({ type, color }) => {
                // ç¡®ä¿savedColors[type]å­˜åœ¨
                if (!offlineUISettings.savedColors[type]) {
                    offlineUISettings.savedColors[type] = [];
                }

                if (!offlineUISettings.savedColors[type].includes(color)) {
                    offlineUISettings.savedColors[type].push(color);
                }

                // é™åˆ¶é¢„å­˜é¢œè‰²æ•°é‡ï¼ˆæœ€å¤š10ä¸ªï¼‰
                if (offlineUISettings.savedColors[type].length > 10) {
                    offlineUISettings.savedColors[type] = offlineUISettings.savedColors[type].slice(-10);
                }
            });

            updateSavedColorsDisplay();
            showToast('é¢œè‰²å·²ä¿å­˜åˆ°é¢„å­˜', 'success');
        }

        // é‡ç½®ä¸ºé»˜è®¤é¢œè‰²
        function resetOfflineColors() {
            document.getElementById('offline-my-bubble-color').value = '#BED6EF'; /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ°”æ³¡æ”¹ä¸ºæ·¡è“è‰² */
            document.getElementById('offline-ai-bubble-color').value = '#f0f0f0';
            document.getElementById('offline-bubble-opacity').value = 0.9;
            document.getElementById('offline-opacity-value').textContent = '90%'; // æ›´æ–°é€æ˜åº¦æ˜¾ç¤º
            document.getElementById('offline-font-size').value = 15; // ğŸ”¥ã€æ–°å¢ã€‘é‡ç½®å­—ä½“å¤§å°
            document.getElementById('offline-font-size-value').textContent = '15px'; // æ›´æ–°å­—ä½“å¤§å°æ˜¾ç¤º
            document.getElementById('offline-user-normal-text-color').value = '#000000'; /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–‡å­—æ”¹ä¸ºé»‘è‰² */
            document.getElementById('offline-user-italic-text-color').value = '#333333'; /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–œä½“æ–‡å­—æ”¹ä¸ºæ·±ç°è‰² */
            document.getElementById('offline-user-bold-text-color').value = '#000000'; /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·ç²—ä½“æ–‡å­—æ”¹ä¸ºé»‘è‰² */
            document.getElementById('offline-ai-normal-text-color').value = '#000000';
            document.getElementById('offline-ai-italic-text-color').value = '#666666';
            document.getElementById('offline-ai-bold-text-color').value = '#333333';

            updateOfflinePreview();
            showToast('é¢œè‰²å·²é‡ç½®ä¸ºé»˜è®¤', 'success');
        }

        // ä¿å­˜çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        async function saveOfflineUISettings() {
            const characterId = currentChatCharacter.id;

            try {
                // æ”¶é›†è®¾ç½®æ•°æ®
                offlineUISettings = {
                    myBubbleColor: document.getElementById('offline-my-bubble-color').value,
                    aiBubbleColor: document.getElementById('offline-ai-bubble-color').value,
                    bubbleOpacity: parseFloat(document.getElementById('offline-bubble-opacity').value),
                    fontSize: parseInt(document.getElementById('offline-font-size').value), // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜å­—ä½“å¤§å°
                    wallpaperData: offlineUISettings.wallpaperData || '',
                    fontFamily: document.getElementById('offline-font-select').value,
                    fontUrl: document.getElementById('offline-font-url').value.trim(),
                    realFontName: window.previewedFontName || '', // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜é¢„è§ˆæ—¶ç¡®å®šçš„çœŸå®å­—ä½“åç§°
                    userNormalTextColor: document.getElementById('offline-user-normal-text-color').value,
                    userItalicTextColor: document.getElementById('offline-user-italic-text-color').value,
                    userBoldTextColor: document.getElementById('offline-user-bold-text-color').value,
                    aiNormalTextColor: document.getElementById('offline-ai-normal-text-color').value,
                    aiItalicTextColor: document.getElementById('offline-ai-italic-text-color').value,
                    aiBoldTextColor: document.getElementById('offline-ai-bold-text-color').value,
                    showUserAvatar: document.getElementById('offline-show-user-avatar').checked,
                    showAiAvatar: document.getElementById('offline-show-ai-avatar').checked,
                    avatarPosition: document.querySelector('input[name="offline-avatar-position"]:checked').value,
                    bubbleWidth: document.querySelector('input[name="offline-bubble-width"]:checked').value,
                    bubbleStyle: document.querySelector('input[name="offline-bubble-style"]:checked').value,
                    customCSS: document.getElementById('offline-custom-css').value.trim(),
                    savedColors: offlineUISettings.savedColors || {
                        userNormal: [], userItalic: [], userBold: [],
                        aiNormal: [], aiItalic: [], aiBold: []
                    }
                };

                // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¿å­˜åˆ°Dexieæ•°æ®åº“ï¼ˆæ¯ä¸ªè§’è‰²ç‹¬ç«‹ï¼‰
                await saveOfflineUISettingsToDB();

                // åº”ç”¨è®¾ç½®åˆ°çº¿ä¸‹æ¨¡å¼ç•Œé¢
                applyOfflineUISettings();

                closeOfflineUISettings();
                showToast('ç•Œé¢è®¾ç½®å·²ä¿å­˜', 'success');

            } catch (error) {
                console.error('ä¿å­˜çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜ç•Œé¢è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘ä¿å­˜è®¾ç½®åˆ°Dexieæ•°æ®åº“
        async function saveOfflineUISettingsToDB() {
            if (!currentChatCharacter || !offlineUISettings) return;

            const characterId = currentChatCharacter.id;

            // ğŸ”¥ã€å¢å¼ºã€‘åŒé‡ä¿å­˜ç­–ç•¥ï¼Œä¼˜å…ˆä¿æŒçª—å£éš”ç¦»
            let dbSaveSuccess = false;
            let localStorageSaveSuccess = false;

            // é¦–å…ˆå°è¯•ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä¼˜å…ˆçª—å£éš”ç¦»æ ¼å¼ï¼‰
            try {
                const dbKey = windowId ? `${characterId}_${windowId}_ui_settings` : `${characterId}_ui_settings`;
                await db.offlineUISettings.put({
                    id: dbKey,
                    characterId: characterId,
                    windowId: windowId || null,
                    settings: offlineUISettings,
                    timestamp: Date.now()
                });
                dbSaveSuccess = true;
                console.log(`âœ… çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å·²ä¿å­˜åˆ°æ•°æ®åº“ (${dbKey})`);
            } catch (dbError) {
                console.warn('âŒ ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥:', dbError);
            }

            // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½ï¼ˆä¹Ÿä¼˜å…ˆçª—å£éš”ç¦»æ ¼å¼ï¼‰
            try {
                const storageKey = windowId ? `offlineUISettings_${characterId}_${windowId}` : `offlineUISettings_${characterId}`;
                localStorage.setItem(storageKey, JSON.stringify(offlineUISettings));
                localStorageSaveSuccess = true;
                console.log(`âœ… çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å·²ä¿å­˜åˆ°localStorage (${storageKey})`);
            } catch (localStorageError) {
                console.warn('âŒ ä¿å­˜åˆ°localStorageå¤±è´¥:', localStorageError);
            }

            // å¦‚æœä¸¤ç§æ–¹å¼éƒ½å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
            if (!dbSaveSuccess && !localStorageSaveSuccess) {
                throw new Error('æ‰€æœ‰ä¿å­˜æ–¹å¼éƒ½å¤±è´¥äº†');
            }
        }

        // åº”ç”¨çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        function applyOfflineUISettings() {
            if (!offlineUISettings || !currentChatCharacter) return;

            const offlineOverlay = document.getElementById('offline-mode-overlay');
            if (!offlineOverlay) return;

            // ğŸ”¥ã€ä¿®å¤ã€‘è·å–èŠå¤©æ¶ˆæ¯å®¹å™¨å¹¶é‡ç½®èƒŒæ™¯
            const chatMessages = offlineOverlay.querySelector('.offline-chat-messages');
            if (chatMessages) {
                // å…ˆæ¸…é™¤æ—§èƒŒæ™¯
                chatMessages.style.backgroundImage = '';
                chatMessages.style.backgroundColor = ''; // åŒæ ·é‡ç½®èƒŒæ™¯è‰²
            }

            // ç¡®ä¿è®¾ç½®æœ‰é»˜è®¤å€¼
            const myBubbleColor = offlineUISettings.myBubbleColor || '#007AFF';
            const aiBubbleColor = offlineUISettings.aiBubbleColor || '#f0f0f0';
            const bubbleOpacity = offlineUISettings.bubbleOpacity !== undefined ? offlineUISettings.bubbleOpacity : 0.9;
            const userNormalTextColor = offlineUISettings.userNormalTextColor || '#ffffff';
            const userItalicTextColor = offlineUISettings.userItalicTextColor || '#f0f0f0';
            const userBoldTextColor = offlineUISettings.userBoldTextColor || '#ffffff';
            const aiNormalTextColor = offlineUISettings.aiNormalTextColor || '#000000';
            const aiItalicTextColor = offlineUISettings.aiItalicTextColor || '#666666';
            const aiBoldTextColor = offlineUISettings.aiBoldTextColor || '#333333';

            // åº”ç”¨æ°”æ³¡é¢œè‰²å’Œé€æ˜åº¦
            const userBubbles = offlineOverlay.querySelectorAll('.offline-message.user .offline-message-content');
            const aiBubbles = offlineOverlay.querySelectorAll('.offline-message.ai .offline-message-content');

            userBubbles.forEach(bubble => {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²ï¼Œåªè®©èƒŒæ™¯é€æ˜ï¼Œæ–‡å­—ä¿æŒä¸é€æ˜
                const userBgColor = convertColorWithOpacity(myBubbleColor, bubbleOpacity);
                bubble.style.backgroundColor = userBgColor;
                bubble.style.opacity = 1; // ç¡®ä¿æ•´ä¸ªå…ƒç´ ä¸é€æ˜
                bubble.style.color = userNormalTextColor;

                // åº”ç”¨ç”¨æˆ·æ¶ˆæ¯æ–‡å­—é¢œè‰²
                const italicTexts = bubble.querySelectorAll('em');
                const boldTexts = bubble.querySelectorAll('strong');
                italicTexts.forEach(text => text.style.color = userItalicTextColor);
                boldTexts.forEach(text => text.style.color = userBoldTextColor);
            });

            aiBubbles.forEach(bubble => {
                // ä½¿ç”¨rgbaèƒŒæ™¯è‰²ï¼Œåªè®©èƒŒæ™¯é€æ˜ï¼Œæ–‡å­—ä¿æŒä¸é€æ˜
                const aiBgColor = convertColorWithOpacity(aiBubbleColor, bubbleOpacity);
                bubble.style.backgroundColor = aiBgColor;
                bubble.style.opacity = 1; // ç¡®ä¿æ•´ä¸ªå…ƒç´ ä¸é€æ˜
                bubble.style.color = aiNormalTextColor;

                // åº”ç”¨AIæ¶ˆæ¯æ–‡å­—é¢œè‰²
                const italicTexts = bubble.querySelectorAll('em');
                const boldTexts = bubble.querySelectorAll('strong');
                italicTexts.forEach(text => text.style.color = aiItalicTextColor);
                boldTexts.forEach(text => text.style.color = aiBoldTextColor);
            });

            // åº”ç”¨èƒŒæ™¯å£çº¸
            if (chatMessages && offlineUISettings.wallpaperData) {
                chatMessages.style.backgroundImage = `url(${offlineUISettings.wallpaperData})`;
                chatMessages.style.backgroundSize = 'cover';
                chatMessages.style.backgroundPosition = 'center';
                chatMessages.style.backgroundAttachment = 'fixed';
            }

            // åº”ç”¨å­—ä½“è®¾ç½®
            const fontName = `OfflineFont_${currentChatCharacter.id}`;
            const existingStyle = document.getElementById(`offline-font-${currentChatCharacter.id}`);
            if (existingStyle) {
                existingStyle.remove();
            }
            const existingLink = document.getElementById(`offline-font-link-${currentChatCharacter.id}`);
            if (existingLink) {
                existingLink.remove();
            }

            // ğŸ”¥ã€ä¿®æ”¹ã€‘ä¼˜å…ˆä½¿ç”¨çº¿ä¸‹æ¨¡å¼ä¸“é—¨è®¾ç½®çš„å­—ä½“ï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€å­—ä½“è®¾ç½®
            if (offlineUISettings.fontFamily === 'custom' && offlineUISettings.fontUrl) {
                // çº¿ä¸‹æ¨¡å¼æœ‰ä¸“é—¨çš„å­—ä½“è®¾ç½®
                const url = offlineUISettings.fontUrl;

                // åˆ¤æ–­æ˜¯CSSé“¾æ¥è¿˜æ˜¯ç›´æ¥å­—ä½“æ–‡ä»¶
                if (url.includes('fonts.googleapis.com') || url.includes('fonts.google.com') || url.endsWith('.css') || url.includes('fontsapi') || url.includes('css')) {
                    // Google Fontsæˆ–å…¶ä»–CSSé“¾æ¥
                    const link = document.createElement('link');
                    link.id = `offline-font-link-${currentChatCharacter.id}`;
                    link.rel = 'stylesheet';
                    link.href = url;
                    link.onload = function() {
                        // ğŸ”¥ã€ä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„çœŸå®å­—ä½“åç§°
                        let fontFamily = offlineUISettings.realFontName || extractFontFamilyFromGoogleFonts(url) || 'CustomFont';

                        // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœæ²¡æœ‰ä¿å­˜çš„çœŸå®å­—ä½“åç§°ï¼Œå°è¯•ä»CSSä¸­æå–
                        if (!offlineUISettings.realFontName) {
                            try {
                                const sheets = document.styleSheets;
                                for (let i = sheets.length - 1; i >= 0; i--) {
                                    const sheet = sheets[i];
                                    if (sheet.href === url) {
                                        try {
                                            const rules = sheet.cssRules || sheet.rules;
                                            for (let j = 0; j < rules.length; j++) {
                                                const rule = rules[j];
                                                if (rule.type === CSSRule.FONT_FACE_RULE && rule.style.fontFamily) {
                                                    fontFamily = rule.style.fontFamily.replace(/['"]/g, '');
                                                    console.log('ğŸ¨ åº”ç”¨è®¾ç½®æ—¶ä»CSSä¸­æå–åˆ°çœŸå®å­—ä½“åç§°:', fontFamily);
                                                    break;
                                                }
                                            }
                                        } catch (e) {
                                            console.log('ğŸ¨ åº”ç”¨è®¾ç½®æ—¶æ— æ³•è¯»å–CSSè§„åˆ™ï¼Œä½¿ç”¨æå–çš„åç§°');
                                        }
                                        break;
                                    }
                                }
                            } catch (e) {
                                console.log('ğŸ¨ åº”ç”¨è®¾ç½®æ—¶CSSè§£æå¤±è´¥ï¼Œä½¿ç”¨æå–çš„åç§°');
                            }
                        } else {
                            console.log('ğŸ¨ ä½¿ç”¨ä¿å­˜çš„çœŸå®å­—ä½“åç§°:', fontFamily);
                        }

                        const style = document.createElement('style');
                        style.id = `offline-font-${currentChatCharacter.id}`;
                        style.textContent = `
                            #offline-mode-overlay .offline-message-content {
                                font-family: '${fontFamily}', sans-serif !important;
                            }
                        `;
                        document.head.appendChild(style);
                        console.log('âœ… çº¿ä¸‹æ¨¡å¼ä¸“ç”¨å­—ä½“å·²åº”ç”¨:', fontFamily);
                    };
                    document.head.appendChild(link);
                } else {
                    // ç›´æ¥å­—ä½“æ–‡ä»¶
                    const style = document.createElement('style');
                    style.id = `offline-font-${currentChatCharacter.id}`;
                    style.textContent = `
                        @font-face {
                            font-family: '${fontName}';
                            src: url('${url}');
                        }
                        #offline-mode-overlay .offline-message-content {
                            font-family: '${fontName}', sans-serif !important;
                        }
                    `;
                    document.head.appendChild(style);
                    console.log('âœ… çº¿ä¸‹æ¨¡å¼ä¸“ç”¨å­—ä½“å·²åº”ç”¨:', fontName);
                }
            } else if (globalFontSettings && globalFontSettings.isApplied && globalFontSettings.fontName) {
                // ğŸ”¥ã€æ–°å¢ã€‘çº¿ä¸‹æ¨¡å¼æ²¡æœ‰ä¸“é—¨è®¾ç½®å­—ä½“ï¼Œä½¿ç”¨å…¨å±€å­—ä½“è®¾ç½®
                const style = document.createElement('style');
                style.id = `offline-font-${currentChatCharacter.id}`;
                style.textContent = `
                    #offline-mode-overlay .offline-message-content {
                        font-family: '${globalFontSettings.fontName}', sans-serif !important;
                    }
                `;
                document.head.appendChild(style);
                console.log('âœ… çº¿ä¸‹æ¨¡å¼åº”ç”¨å…¨å±€å­—ä½“:', globalFontSettings.fontName);
            }

            // åº”ç”¨å¤´åƒæ˜¾ç¤ºè®¾ç½®
            const allMessages = offlineOverlay.querySelectorAll('.offline-message');

            allMessages.forEach(messageContainer => {
                const userAvatar = messageContainer.querySelector('.offline-avatar.user-avatar');
                const aiAvatar = messageContainer.querySelector('.offline-avatar.ai-avatar');

                // æ¸…é™¤æ‰€æœ‰ç›¸å…³çš„ç±»
                messageContainer.classList.remove('no-user-avatar', 'no-ai-avatar');

                // å¤„ç†ç”¨æˆ·å¤´åƒæ˜¾ç¤º
                if (userAvatar) {
                    userAvatar.style.display = offlineUISettings.showUserAvatar ? 'flex' : 'none';
                }

                // å¤„ç†AIå¤´åƒæ˜¾ç¤º
                if (aiAvatar) {
                    aiAvatar.style.display = offlineUISettings.showAiAvatar ? 'flex' : 'none';
                }

                // ğŸ”¥ã€ä¿®æ­£ã€‘æ ¹æ®å¤´åƒæ˜¾ç¤ºçŠ¶æ€æ·»åŠ å¯¹åº”çš„ç±»
                if (!offlineUISettings.showUserAvatar) {
                    messageContainer.classList.add('no-user-avatar');
                }
                if (!offlineUISettings.showAiAvatar) {
                    messageContainer.classList.add('no-ai-avatar');
                }
            });

            // åº”ç”¨æ°”æ³¡å®½åº¦è®¾ç½®
            if (offlineUISettings.bubbleWidth === 'default') {
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰å®½åº¦æ ·å¼ï¼Œè®©CSSè§„åˆ™è‡ªåŠ¨å¤„ç†å®½åº¦
                const widthStyleId = `offline-width-${currentChatCharacter.id}`;
                const existingWidthStyle = document.getElementById(widthStyleId);
                if (existingWidthStyle) {
                    existingWidthStyle.remove();
                }
                // ä¸å†å¼ºåˆ¶è®¾ç½®90%ï¼Œè®©CSSä¸­çš„å¤´åƒæ˜¾ç¤º/éšè—è§„åˆ™æ¥æ§åˆ¶å®½åº¦
            }

            // åº”ç”¨å¤´åƒä½ç½®è®¾ç½®
            if (offlineUISettings.avatarPosition === 'side') {
                // åº”ç”¨é»˜è®¤ä¾§è¾¹ä½ç½®
                const avatarStyleId = `offline-avatar-${currentChatCharacter.id}`;
                const existingAvatarStyle = document.getElementById(avatarStyleId);
                if (existingAvatarStyle) {
                    existingAvatarStyle.remove();
                }

                const avatarStyle = document.createElement('style');
                avatarStyle.id = avatarStyleId;
                avatarStyle.textContent = `
                    /* ğŸ”¥ã€ä¿®æ”¹ã€‘é»˜è®¤å¸ƒå±€ï¼šç”¨æˆ·é å³ï¼ŒAIå±…ä¸­ */
                    #offline-mode-overlay .offline-message.user {
                        justify-content: flex-end; /* ç”¨æˆ·æ¶ˆæ¯é»˜è®¤é å³ */
                    }
                    #offline-mode-overlay .offline-message.ai {
                        justify-content: center; /* AIæ¶ˆæ¯é»˜è®¤å±…ä¸­ */
                    }

                    /* ğŸ”¥ã€æ–°å¢ã€‘æ˜¾ç¤ºå¤´åƒæ—¶çš„å¸ƒå±€è°ƒæ•´ */
                    #offline-mode-overlay .offline-message.user:not(.no-user-avatar) {
                        flex-direction: row;
                        justify-content: flex-end; /* ç”¨æˆ·æ¶ˆæ¯åœ¨å³ä¾§ */
                    }
                    #offline-mode-overlay .offline-message.ai:not(.no-ai-avatar) {
                        flex-direction: row-reverse;
                        justify-content: flex-start; /* AIæ¶ˆæ¯åœ¨å·¦ä¾§ */
                    }
                    #offline-mode-overlay .offline-avatar {
                        position: relative;
                        margin: 0;
                    }
                `;
                document.head.appendChild(avatarStyle);
            }

            // åº”ç”¨è‡ªå®šä¹‰CSSï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            if (offlineUISettings.customCSS &&
                (offlineUISettings.avatarPosition === 'custom' ||
                 offlineUISettings.bubbleWidth === 'custom' ||
                 offlineUISettings.bubbleStyle === 'custom')) {

                const customStyleId = `offline-custom-${currentChatCharacter.id}`;
                const existingCustomStyle = document.getElementById(customStyleId);
                if (existingCustomStyle) {
                    existingCustomStyle.remove();
                }

                const customStyle = document.createElement('style');
                customStyle.id = customStyleId;

                // ä¸ºCSSä»£ç æ·»åŠ ä½œç”¨åŸŸï¼Œåªå½±å“å½“å‰çº¿ä¸‹æ¨¡å¼
                const scopedCSS = offlineUISettings.customCSS.replace(/\.offline-/g, '#offline-mode-overlay .offline-');
                customStyle.textContent = scopedCSS;

                document.head.appendChild(customStyle);
            }

            // ğŸ”¥ã€æ–°å¢ã€‘åº”ç”¨å­—ä½“å¤§å°è®¾ç½®
            if (offlineUISettings.fontSize !== undefined) {
                const messageContents = offlineOverlay.querySelectorAll('.offline-message-content');
                messageContents.forEach(content => {
                    content.style.fontSize = `${offlineUISettings.fontSize}px`;
                });
            }
        }

        // é‡ç½®çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®
        async function resetOfflineUISettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç•Œé¢è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
                // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
                offlineUISettings = {
                    myBubbleColor: '#BED6EF', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ°”æ³¡æ”¹ä¸ºæ·¡è“è‰² */
                    aiBubbleColor: '#f0f0f0',
                    bubbleOpacity: 0.9,
                    fontSize: 15, // ğŸ”¥ã€æ–°å¢ã€‘é‡ç½®å­—ä½“å¤§å°ä¸ºé»˜è®¤å€¼
                    wallpaperData: '',
                    fontFamily: '',
                    fontUrl: '',
                    userNormalTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                    userItalicTextColor: '#333333', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·æ–œä½“æ–‡å­—æ”¹ä¸ºæ·±ç°è‰² */
                    userBoldTextColor: '#000000', /* ğŸ”¥ã€ä¿®æ”¹ã€‘ç”¨æˆ·ç²—ä½“æ–‡å­—æ”¹ä¸ºé»‘è‰² */
                    aiNormalTextColor: '#000000',
                    aiItalicTextColor: '#666666',
                    aiBoldTextColor: '#333333',
                    showUserAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é‡ç½®æ—¶é»˜è®¤ä¸æ˜¾ç¤ºç”¨æˆ·å¤´åƒ */
                    showAiAvatar: false, /* ğŸ”¥ã€ä¿®æ”¹ã€‘é‡ç½®æ—¶é»˜è®¤ä¸æ˜¾ç¤ºAIå¤´åƒ */
                    avatarPosition: 'side',
                    bubbleWidth: 'default',
                    bubbleStyle: 'default',
                    customCSS: '',
                    savedColors: {
                        userNormal: [], userItalic: [], userBold: [],
                        aiNormal: [], aiItalic: [], aiBold: []
                    }
                };

                // æ¸…é™¤æ–‡ä»¶è¾“å…¥
                document.getElementById('offline-wallpaper-file').value = '';

                // ğŸ”¥ã€æ–°å¢ã€‘æ¸…é™¤æ•°æ®åº“ä¸­çš„è®¾ç½®
                if (currentChatCharacter) {
                    try {
                        await db.offlineUISettings.delete(`${currentChatCharacter.id}_ui_settings`);
                        console.log('âœ… æ•°æ®åº“ä¸­çš„è®¾ç½®å·²æ¸…é™¤');
                    } catch (error) {
                        console.error('æ¸…é™¤æ•°æ®åº“è®¾ç½®å¤±è´¥:', error);
                    }
                }

                updateOfflineUISettingsForm();
                updateOfflinePreview();
                showToast('ç•Œé¢è®¾ç½®å·²é‡ç½®', 'success');
            }
        }

        // åœ¨è¿›å…¥çº¿ä¸‹æ¨¡å¼æ—¶åŠ è½½å¹¶åº”ç”¨ç•Œé¢è®¾ç½®
        async function loadAndApplyOfflineUISettings() {
            if (!currentChatCharacter) return;

            const characterId = currentChatCharacter.id;

            try {
                // ğŸ”¥ã€ä¿®å¤ã€‘ä¿æŒçª—å£éš”ç¦»çš„åŒæ—¶å¢å¼ºæ‰‹æœºæµè§ˆå™¨å…¼å®¹æ€§
                let settingsLoaded = false;

                // é¦–å…ˆå°è¯•ä»localStorageåŠ è½½ï¼ˆæ›´ç¨³å®šï¼‰ï¼Œä¼˜å…ˆçª—å£éš”ç¦»æ ¼å¼
                try {
                    let savedSettings = null;
                    let storageKey = null;

                    // ä¼˜å…ˆå°è¯•å¸¦çª—å£IDçš„è®¾ç½®ï¼ˆä¿æŒéš”ç¦»ï¼‰
                    if (windowId) {
                        storageKey = `offlineUISettings_${characterId}_${windowId}`;
                        savedSettings = localStorage.getItem(storageKey);
                    }

                    // å¦‚æœçª—å£éš”ç¦»è®¾ç½®ä¸å­˜åœ¨ï¼Œå°è¯•é€šç”¨æ ¼å¼ï¼ˆå…¼å®¹æ€§å›é€€ï¼‰
                    if (!savedSettings) {
                        storageKey = `offlineUISettings_${characterId}`;
                        savedSettings = localStorage.getItem(storageKey);
                    }

                    if (savedSettings) {
                        offlineUISettings = JSON.parse(savedSettings);
                        settingsLoaded = true;
                        console.log(`âœ… ä»localStorageåŠ è½½çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®æˆåŠŸ (${storageKey})`);
                    }
                } catch (localStorageError) {
                    console.warn('ä»localStorageåŠ è½½å¤±è´¥:', localStorageError);
                }

                // å¦‚æœlocalStorageåŠ è½½å¤±è´¥ï¼Œå°è¯•ä»æ•°æ®åº“åŠ è½½
                if (!settingsLoaded) {
                    try {
                        let settingsRecord = null;

                        // ä¼˜å…ˆå°è¯•å¸¦çª—å£IDçš„è®¾ç½®ï¼ˆä¿æŒéš”ç¦»ï¼‰
                        if (windowId) {
                            settingsRecord = await db.offlineUISettings.get(`${characterId}_${windowId}_ui_settings`);
                        }

                        // å¦‚æœçª—å£éš”ç¦»è®¾ç½®ä¸å­˜åœ¨ï¼Œå°è¯•é€šç”¨æ ¼å¼ï¼ˆå…¼å®¹æ€§å›é€€ï¼‰
                        if (!settingsRecord) {
                            settingsRecord = await db.offlineUISettings.get(`${characterId}_ui_settings`);
                        }

                        if (settingsRecord && settingsRecord.settings) {
                            offlineUISettings = settingsRecord.settings;
                            settingsLoaded = true;
                            console.log(`âœ… ä»æ•°æ®åº“åŠ è½½çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®æˆåŠŸ`);
                        }
                    } catch (dbError) {
                        console.warn('ä»æ•°æ®åº“åŠ è½½å¤±è´¥:', dbError);
                    }
                }

                // å¦‚æœæˆåŠŸåŠ è½½è®¾ç½®ï¼Œåº”ç”¨å®ƒä»¬
                if (settingsLoaded) {
                    applyOfflineUISettings();
                    console.log(`âœ… çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å·²åº”ç”¨`);
                }
            } catch (error) {
                console.error('åŠ è½½çº¿ä¸‹æ¨¡å¼ç•Œé¢è®¾ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘é€‰æ‹©å‡½æ•°
        function selectAvatarPosition(value, element) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            const siblings = element.parentNode.querySelectorAll('.radio-option-button');
            siblings.forEach(btn => btn.classList.remove('selected'));

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');

            // æ›´æ–°éšè—çš„radioæŒ‰é’®
            const radios = element.parentNode.querySelectorAll('input[name="offline-avatar-position"]');
            radios.forEach(radio => {
                radio.checked = radio.value === value;
            });
        }

        function selectBubbleWidth(value, element) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            const siblings = element.parentNode.querySelectorAll('.radio-option-button');
            siblings.forEach(btn => btn.classList.remove('selected'));

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');

            // æ›´æ–°éšè—çš„radioæŒ‰é’®
            const radios = element.parentNode.querySelectorAll('input[name="offline-bubble-width"]');
            radios.forEach(radio => {
                radio.checked = radio.value === value;
            });
        }

        function selectBubbleStyle(value, element) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            const siblings = element.parentNode.querySelectorAll('.radio-option-button');
            siblings.forEach(btn => btn.classList.remove('selected'));

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');

            // æ›´æ–°éšè—çš„radioæŒ‰é’®
            const radios = element.parentNode.querySelectorAll('input[name="offline-bubble-style"]');
            radios.forEach(radio => {
                radio.checked = radio.value === value;
            });
        }

document.addEventListener('visibilitychange', function() {
    const phoneScreen = document.getElementById('phone-screen');
    if (!phoneScreen) return;

    if (document.visibilityState === 'visible') {
        // é¡µé¢å˜ä¸ºå¯è§çŠ¶æ€
        console.log("âœ… é¡µé¢æ¢å¤å¯è§ï¼Œæ­£åœ¨æ¢å¤åŠ¨ç”»å’Œå®šæ—¶å™¨...");

        // 1. æ¢å¤æ‰€æœ‰ CSS åŠ¨ç”»
        phoneScreen.style.animationPlayState = 'running';
        const animatedElements = document.querySelectorAll('[style*="animation"]');
        animatedElements.forEach(el => el.style.animationPlayState = 'running');

        // 2. å¼ºåˆ¶æµè§ˆå™¨è¿›è¡Œä¸€æ¬¡é‡ç»˜ï¼Œæ¸…é™¤æ®‹ç•™çš„çº¿æ¡
        // è¿™æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„å°æŠ€å·§ï¼Œé€šè¿‡å¿«é€Ÿæ”¹å˜ä¸€ä¸ªä¸å½±å“å¸ƒå±€çš„å±æ€§æ¥è§¦å‘é‡ç»˜
        phoneScreen.style.opacity = '0.99';
        setTimeout(() => {
            phoneScreen.style.opacity = '1';
        }, 16); // 16ms çº¦ç­‰äºä¸€å¸§çš„æ—¶é—´

        // 3. å¦‚æœæ‚¨æœ‰é€šè¿‡ setInterval å¯åŠ¨çš„å¤æ‚JSåŠ¨ç”»ï¼Œå¯ä»¥åœ¨è¿™é‡Œé‡æ–°å¯åŠ¨å®ƒä»¬
        // ä¾‹å¦‚ï¼šé‡æ–°å¯åŠ¨æ—¶é’Ÿï¼ˆè™½ç„¶æ—¶é’Ÿé€šå¸¸å½±å“ä¸å¤§ï¼Œä½†ä½œä¸ºç¤ºä¾‹ï¼‰
        if (typeof updateTime === 'function') {
           // å¦‚æœä¹‹å‰æœ‰æ¸…é™¤å®šæ—¶å™¨ï¼Œåœ¨è¿™é‡Œé‡æ–°è®¾ç½®
           // setInterval(updateTime, 1000);
        }

    } else {
        // é¡µé¢å˜ä¸ºéšè—çŠ¶æ€
        console.log("ğŸ’¤ é¡µé¢å·²éšè—ï¼Œæš‚åœåŠ¨ç”»ä»¥èŠ‚çœèµ„æº...");

        // 1. æš‚åœæ‰€æœ‰ CSS åŠ¨ç”»
        phoneScreen.style.animationPlayState = 'paused';
        const animatedElements = document.querySelectorAll('[style*="animation"]');
        animatedElements.forEach(el => el.style.animationPlayState = 'paused');

        // 2. å¦‚æœæœ‰å¤æ‚çš„JSåŠ¨ç”»å®šæ—¶å™¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ¸…é™¤å®ƒä»¬
        // clearInterval(yourAnimationTimer);
    }
});

// ã€æ–°å¢ã€‘"æä¸ªå¤§æ–°é—»"ç›¸å…³å‡½æ•°

// æ˜¾ç¤º"æä¸ªå¤§æ–°é—»"æ¨¡æ€æ¡†
function showMakeNewsModal() {
    const modalHTML = `
        <div id="make-news-modal" class="modal" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">æä¸ªå¤§æ–°é—»</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        è¾“å…¥ä¸€ä¸ªä¸–ç•Œäº‹ä»¶ï¼ŒAIå°†åœ¨24å°æ—¶å†…å›´ç»•è¿™ä¸ªäº‹ä»¶ç”Ÿæˆæ–°çš„è®ºå›å¸–å­ã€‚
                    </p>
                    <textarea id="news-content-input" class="form-textarea" placeholder="ä¾‹å¦‚ï¼šå¬é—»é­”å°Šå³å°†å‡ºå…³ï¼Œæ­£é“å„æ´¾å°†åœ¨æ˜†ä»‘ä¹‹å·…ä¼šç›Ÿå•†è®®å¯¹ç­–ã€‚" style="min-height: 100px;"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-button modal-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                    <button class="modal-button modal-primary" onclick="submitMakeNews()">å‘å¸ƒäº‹ä»¶</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    setTimeout(() => document.getElementById('news-content-input').focus(), 100);
}

// æäº¤"å¤§æ–°é—»"
function submitMakeNews() {
    const contentInput = document.getElementById('news-content-input');
    const content = contentInput.value.trim();

    if (!content) {
        alert('è¯·è¾“å…¥äº‹ä»¶å†…å®¹ï¼');
        return;
    }

    // è®¾ç½®ä¸–ç•Œäº‹ä»¶ï¼Œæœ‰æ•ˆæœŸä¸º24å°æ—¶
    worldEvent = {
        content: content,
        expires: Date.now() + 24 * 60 * 60 * 1000
    };

    const modal = document.getElementById('make-news-modal');
    if (modal) modal.remove();

    showToast('ä¸–ç•Œçº¿å·²å˜åŠ¨ï¼æ­£åœ¨åˆ·æ–°è®ºå›...', 'success');

    // ç«‹å³åˆ·æ–°å¸–å­ä»¥ä½“ç°æ–°äº‹ä»¶
    refreshPosts();
}

// --- ä¸ªäººä¸»é¡µåˆ†åŒºåˆ‡æ¢ ---
function switchProfileTab(tab) {
    const myPostsList = document.getElementById('my-posts-list');
    const favListContainer = document.getElementById('favorite-posts-list');
    const tabs = document.querySelectorAll('.profile-tab');

    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector(`.profile-tab[onclick*="${tab}"]`).classList.add('active');

    if (tab === 'my-posts') {
        myPostsList.style.display = 'block';
        favListContainer.style.display = 'none';
    } else {
        myPostsList.style.display = 'none';
        favListContainer.style.display = 'block';
    }

    // ğŸ”¥ã€æ–°å¢ã€‘å¦‚æœå½“å‰å¤„äºå¤šé€‰æ¨¡å¼ï¼Œé‡æ–°æ¸²æŸ“å¸¦é€‰æ‹©æ¡†çš„åˆ—è¡¨
    if (isForumMultiSelectMode) {
        selectedPostIds.clear(); // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
        renderPostsWithCheckboxes();
        updateDeleteButtonState();
    }
}

// --- å¸–å­åˆ†äº«åŠŸèƒ½ ---

// 1. æ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
async function showSharePostModal() {
    const conversations = [];
    // è·å–å•èŠ
    characters.forEach(char => {
        if (contacts.includes(char.id)) {
            conversations.push({ id: char.id, name: char.name, avatarUrl: char.avatarUrl, isGroup: false });
        }
    });
    // è·å–ç¾¤èŠ
    groupChats.forEach(group => {
        conversations.push({ id: group.id, name: group.name, avatarUrl: group.avatarUrl, isGroup: true });
    });

    const modalHTML = `
        <div id="share-post-modal" class="modal" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">åˆ†äº«åˆ°...</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    ${conversations.map(chat => `
                        <div class="chat-option-item" onclick="sharePostToChat('${chat.id}')">
                            <div class="chat-option-icon" style="background-image: url('${chat.avatarUrl || createDefaultAvatar(chat.name)}'); background-size: cover; background-position: center;">
                                ${chat.isGroup && !chat.avatarUrl ? 'ç¾¤' : ''}
                            </div>
                            <div class="chat-option-text">
                                <div class="chat-option-title">${chat.name}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// 2. å°†å¸–å­åˆ†äº«åˆ°æŒ‡å®šå¯¹è¯
async function sharePostToChat(chatId) {
    if (!window.currentPostId) return;

    try {
        const post = await db.forumPosts.get(window.currentPostId);
        if (!post) {
            showToast('å¸–å­ä¸å­˜åœ¨', 'error');
            return;
        }

        // è·å–å½“å‰ç”¨æˆ·èº«ä»½
        const forum = await db.forums.get(parseInt(currentForumId));
        const persona = personas.find(p => p.id === forum.personaId);

        // è·å–å¸–å­çš„è¯„è®º
        const replies = await db.forumReplies.where('postId').equals(window.currentPostId).sortBy('timestamp');

        // åˆ›å»ºåŒ…å«è¯„è®ºçš„å®Œæ•´å†…å®¹
        let fullContent = `ã€å¸–å­æ ‡é¢˜ã€‘${post.title}\n\nã€ä½œè€…ã€‘${post.authorName}\n\nã€æ­£æ–‡ã€‘\n${post.content}`;

        if (replies && replies.length > 0) {
            fullContent += '\n\nã€è¯„è®ºåŒºã€‘\n';
            replies.forEach((reply, index) => {
                const replyTime = new Date(reply.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                // ğŸ”¥ã€éšç§ä¿æŠ¤ã€‘æ­£ç¡®å¤„ç†ç”¨æˆ·å›å¤çš„èº«ä»½æ˜¾ç¤º
                let displayAuthor = reply.authorName;
                if (reply.isAnonymous && reply.authorId === 'user') {
                    // ç”¨æˆ·çš„åŒ¿åå›å¤ï¼Œä¿æŒåŒ¿åæ˜¾ç¤ºï¼Œä¸æš´éœ²èº«ä»½
                    displayAuthor = reply.authorName; // ä¿æŒåŸæ¥çš„åŒ¿ååç§°
                } else if (reply.authorId === 'user' && !reply.isAnonymous) {
                    // ç”¨æˆ·çš„éåŒ¿åå›å¤ï¼Œæ˜¾ç¤ºç”¨æˆ·åœ¨è¯¥ç¤¾åŒºçš„èº«ä»½é¢å…·åå­—
                    displayAuthor = persona ? persona.name : reply.authorName;
                }

                fullContent += `\n${index + 1}æ¥¼ ${displayAuthor} (${replyTime}):\n${reply.content}\n`;
            });
        }

        // ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨åˆ†äº«æ—¶ï¼Œæå‰å°†å¸–å­çš„HTMLå†…å®¹ï¼ˆå¦‚æŠ•ç¥¨ï¼‰è½¬æ¢ä¸ºçº¯æ–‡æœ¬ç”¨äºæ˜¾ç¤º
        const postContentForDisplay = (post.content || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

        // åˆ›å»ºåˆ†äº«æ¶ˆæ¯
        const shareMessage = {
            id: Date.now().toString(),
            sender: 'sent', // æ¶ˆæ¯æ˜¯ä½ å‘é€çš„
            type: 'shared_post',
            postData: { // åµŒå…¥å¸–å­æ ¸å¿ƒä¿¡æ¯
                id: post.id,
                title: post.title,
                authorName: post.authorName,
                content: postContentForDisplay, // ä½¿ç”¨å‡€åŒ–åçš„çº¯æ–‡æœ¬
                replies: replies // åŒ…å«è¯„è®ºæ•°æ®
            },
            timestamp: Date.now(),
            senderName: persona.name, // è®°å½•å‘é€è€…æ˜¯ä½ è‡ªå·±
            content: fullContent // åŒ…å«å®Œæ•´å†…å®¹çš„æ–‡æœ¬ï¼ŒAIå¯ä»¥çœ‹åˆ°è¿™ä¸ª
        };

        if (!chatMessages[chatId]) {
            chatMessages[chatId] = [];
        }
        chatMessages[chatId].push(shareMessage);
        // ğŸ”¥ã€é«˜æ•ˆä¿å­˜ã€‘ç›´æ¥æ·»åŠ å•æ¡åˆ†äº«æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼Œé¿å…å…¨é‡é‡å†™
        try {
            const stableId = `${chatId}_${shareMessage.id}_${chatMessages[chatId].length - 1}`;
            await db.chatMessages.add({
                id: stableId,
                characterId: chatId,
                timestamp: shareMessage.timestamp,
                messageOrder: chatMessages[chatId].length - 1,
                originalMessageId: shareMessage.id,
                messageData: shareMessage
            });
            console.log('âœ… [é«˜æ•ˆåˆ†äº«] è®ºå›å¸–å­åˆ†äº«æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
        } catch (error) {
            console.error('åˆ†äº«æ¶ˆæ¯å•æ¡ä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æ‰¹é‡ä¿å­˜:', error);
            await saveChatMessages();
        }

        // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
        const modal = document.getElementById('share-post-modal');
        if(modal) modal.remove();

        showToast(`æˆåŠŸåˆ†äº«åˆ°å¯¹è¯ï¼`, 'success');

        // å¦‚æœåˆ†äº«ç»™äº†å½“å‰æ‰“å¼€çš„å¯¹è¯ï¼Œåˆ™ç«‹å³åˆ·æ–°
        if (currentChatCharacter && currentChatCharacter.id === chatId) {
            renderChatMessages(chatId);
        }
        // æ— è®ºå¦‚ä½•éƒ½åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ï¼Œä»¥æ˜¾ç¤ºæœ€æ–°çš„åˆ†äº«æ¶ˆæ¯
        renderMessageList();

    } catch (error) {
        console.error('åˆ†äº«å¸–å­å¤±è´¥:', error);
        showToast('åˆ†äº«å¤±è´¥', 'error');
    }
}

// æ·»åŠ éŸ³ä¹æ’­æ”¾å™¨æ–‡ä»¶é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // æœ¬åœ°éŸ³ä¹æ–‡ä»¶é€‰æ‹©
    const localMusicInput = document.getElementById('local-music-input');
    if (localMusicInput) {
        localMusicInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const urlInput = document.getElementById('song-url-input');
                const titleInput = document.getElementById('song-title-input');

                urlInput.placeholder = `å·²é€‰æ‹©: ${file.name}`;
                urlInput.style.color = '#007AFF';
                urlInput.value = ''; // æ¸…ç©ºURLè¾“å…¥

                // è‡ªåŠ¨å¡«å……æ­Œæ›²æ ‡é¢˜
                if (!titleInput.value.trim()) {
                    titleInput.value = file.name.replace(/\.[^/.]+$/, "");
                }
            }
        });
    }

    // æ­Œè¯æ–‡ä»¶é€‰æ‹©
    const lyricsFileInput = document.getElementById('lyrics-file-input');
    if (lyricsFileInput) {
        lyricsFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const lyricsStatus = document.getElementById('lyrics-file-status');
                const fileName = file.name.toLowerCase();
                let fileType = 'æ­Œè¯æ–‡ä»¶';

                if (fileName.endsWith('.lrc')) {
                    fileType = 'LRCæ­Œè¯';
                } else if (fileName.endsWith('.bin')) {
                    fileType = 'binæ­Œè¯';
                } else if (fileName.endsWith('.txt')) {
                    fileType = 'TXTæ­Œè¯';
                } else {
                    // å¯¹äºå…¶ä»–æ–‡ä»¶ç±»å‹ï¼Œç»™å‡ºæç¤ºä½†ä»ç„¶å…è®¸é€‰æ‹©
                    fileType = 'æ–‡ä»¶';
                    console.log('é€‰æ‹©çš„æ–‡ä»¶å¯èƒ½ä¸æ˜¯æ ‡å‡†æ­Œè¯æ ¼å¼ï¼Œä½†ä»ä¼šå°è¯•å¤„ç†:', file.name);
                }

                if (lyricsStatus) {
                    lyricsStatus.textContent = `å·²é€‰æ‹©${fileType}: ${file.name}`;
                    lyricsStatus.style.display = 'block';
                    lyricsStatus.style.color = '#007AFF';
                }
            }
        });
    }

});

        // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ç¼ºå¤±çš„ closeModal å‡½æ•° - å…¨å±€ä½œç”¨åŸŸ
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ”¥ã€ä¿®å¤ã€‘æ·»åŠ ç¼ºå¤±çš„ clearVoteHistory å‡½æ•° - å…¨å±€ä½œç”¨åŸŸ
        function clearVoteHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                try {
                    // æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨ç›¸å…³çš„localStorage
                    Object.keys(localStorage)
                        .filter(key => key.startsWith('poll_voted_') || key.startsWith('vote_detail_'))
                        .forEach(key => localStorage.removeItem(key));

                    showToast('æŠ•ç¥¨å†å²å·²æ¸…ç©º', 'success');
                    closeModal();
                } catch (error) {
                    console.error('æ¸…ç©ºæŠ•ç¥¨å†å²å¤±è´¥:', error);
                    showToast('æ¸…ç©ºå¤±è´¥', 'error');
                }
            }
        }

        // ğŸ”¥ã€æ–°å¢ã€‘è®ºå›ä¸ªäººä¸»é¡µå¤šé€‰åˆ é™¤åŠŸèƒ½ - å…¨å±€å˜é‡å’Œå‡½æ•°
        let isForumMultiSelectMode = false;
        let selectedPostIds = new Set();

        // åˆ‡æ¢å¤šé€‰æ¨¡å¼
        function toggleMultiSelectMode() {
            isForumMultiSelectMode = !isForumMultiSelectMode;
            selectedPostIds.clear();

            const multiSelectBtn = document.getElementById('multi-select-btn');
            const icon = multiSelectBtn.querySelector('i');

            if (isForumMultiSelectMode) {
                // ğŸ”¥ã€ä¿®æ”¹ã€‘è¿›å…¥å¤šé€‰æ¨¡å¼ - æ”¹ä¸ºå‰å·å›¾æ ‡
                icon.className = 'fas fa-times';
                multiSelectBtn.title = 'é€€å‡ºå¤šé€‰';
                multiSelectBtn.style.color = '#ff3b30'; // è¿™ä¸ªé¢œè‰²ä¼šè¢«CSSè¦†ç›–

                // é‡æ–°æ¸²æŸ“å¸–å­åˆ—è¡¨ï¼Œæ·»åŠ é€‰æ‹©æ¡†
                renderPostsWithCheckboxes();

                // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                showDeleteButton();
            } else {
                // é€€å‡ºå¤šé€‰æ¨¡å¼
                icon.className = 'fas fa-trash';
                multiSelectBtn.title = 'å¤šé€‰åˆ é™¤';
                multiSelectBtn.style.color = '';

                // é‡æ–°æ¸²æŸ“å¸–å­åˆ—è¡¨ï¼Œç§»é™¤é€‰æ‹©æ¡†
                showForumProfile();

                // éšè—åˆ é™¤æŒ‰é’®
                hideDeleteButton();
            }
        }

        // é‡æ–°æ¸²æŸ“å¸–å­åˆ—è¡¨ï¼Œæ·»åŠ é€‰æ‹©æ¡†
        async function renderPostsWithCheckboxes() {
            const currentTab = document.querySelector('.profile-tab.active').textContent;

            if (currentTab === 'æˆ‘çš„å¸–å­') {
                await renderMyPostsWithCheckboxes();
            } else {
                await renderFavoritePostsWithCheckboxes();
            }
        }

        // æ¸²æŸ“æˆ‘çš„å¸–å­ï¼ˆå¸¦é€‰æ‹©æ¡†ï¼‰
        async function renderMyPostsWithCheckboxes() {
            const myPostsList = document.getElementById('my-posts-list');
            const allPosts = await db.forumPosts.toArray();
            const userPosts = allPosts.filter(post => post.isUserPost === true).sort((a, b) => b.timestamp - a.timestamp);

            if (userPosts.length === 0) {
                myPostsList.innerHTML = `<div class="forum-empty-state"><p>ä½ è¿˜æ²¡æœ‰å‘è¿‡å¸–å­</p></div>`;
                return;
            }

            const userPostsHtml = await Promise.all(userPosts.map(async post => {
                const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;
                const isSelected = selectedPostIds.has(post.id);

                return `
                    <div class="post-item multi-select-item ${isSelected ? 'selected' : ''}" data-post-id="${post.id}" onclick="togglePostSelection(${post.id}, event)">
                        <div class="post-checkbox">
                            <i class="fas ${isSelected ? 'fa-check-square' : 'fa-square'}"></i>
                        </div>
                        <div class="post-content">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                <span class="user-post-badge">æˆ‘</span>
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }));
            myPostsList.innerHTML = userPostsHtml.join('');
        }

        // æ¸²æŸ“æˆ‘çš„æ”¶è—ï¼ˆå¸¦é€‰æ‹©æ¡†ï¼‰
        async function renderFavoritePostsWithCheckboxes() {
            const favListContainer = document.getElementById('favorite-posts-list');
            const favoriteRecords = await db.forumFavorites.where('userId').equals('user').toArray();
            const postIds = favoriteRecords.map(fav => fav.postId);

            if (postIds.length === 0) {
                favListContainer.innerHTML = `<div class="forum-empty-state"><p>ä½ è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å¸–å­</p></div>`;
                return;
            }

            const favoritePosts = await db.forumPosts.where('id').anyOf(postIds).toArray();
            const favoritePostsHtml = await Promise.all(favoritePosts.sort((a,b) => b.timestamp - a.timestamp).map(async post => {
                const hasImage = await db.forumPostImages.where('postId').equals(post.id).count() > 0;
                const isSelected = selectedPostIds.has(post.id);

                return `
                    <div class="post-item multi-select-item ${isSelected ? 'selected' : ''}" data-post-id="${post.id}" onclick="togglePostSelection(${post.id}, event)">
                        <div class="post-checkbox">
                            <i class="fas ${isSelected ? 'fa-check-square' : 'fa-square'}"></i>
                        </div>
                        <div class="post-content">
                            <div class="post-title-container">
                                <div class="post-title">
                                    ${post.title}
                                    ${hasImage ? '<svg class="image-post-badge" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' : ''}
                                </div>
                                ${post.isUserPost ? '<span class="user-post-badge">æˆ‘</span>' : ''}
                            </div>
                            <div class="post-meta">
                                <span class="post-author">${post.authorName}</span>
                                <span>${formatTime(post.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }));
            favListContainer.innerHTML = favoritePostsHtml.join('');
        }

        // åˆ‡æ¢å¸–å­é€‰æ‹©çŠ¶æ€
        function togglePostSelection(postId, event) {
            event.stopPropagation();

            const postItem = document.querySelector(`[data-post-id="${postId}"]`);
            const checkbox = postItem.querySelector('.post-checkbox i');

            if (selectedPostIds.has(postId)) {
                selectedPostIds.delete(postId);
                postItem.classList.remove('selected');
                checkbox.className = 'fas fa-square';
            } else {
                selectedPostIds.add(postId);
                postItem.classList.add('selected');
                checkbox.className = 'fas fa-check-square';
            }

            updateDeleteButtonState();
        }

        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        function showDeleteButton() {
            const existingBtn = document.getElementById('multi-delete-btn');
            if (existingBtn) return;

            const deleteBtn = document.createElement('div');
            deleteBtn.id = 'multi-delete-btn';
            deleteBtn.className = 'floating-delete-btn';
            deleteBtn.innerHTML = `
                <button class="select-all-btn" onclick="toggleSelectAll()" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
                    <i class="fas fa-check-double"></i>
                </button>
                <button class="delete-action-btn" onclick="confirmDeleteSelectedPosts()" title="åˆ é™¤é€‰ä¸­çš„å¸–å­">
                    <i class="fas fa-trash"></i>
                    <span id="selected-count">0</span>
                </button>
                <button class="cancel-action-btn" onclick="toggleMultiSelectMode()" title="å–æ¶ˆå¤šé€‰æ¨¡å¼">
                    å–æ¶ˆ
                </button>
            `;

            document.getElementById('forum-profile-screen').appendChild(deleteBtn);
        }

        // éšè—åˆ é™¤æŒ‰é’®
        function hideDeleteButton() {
            const deleteBtn = document.getElementById('multi-delete-btn');
            if (deleteBtn) {
                deleteBtn.remove();
            }
        }

        // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
        function updateDeleteButtonState() {
            const countSpan = document.getElementById('selected-count');
            const deleteBtn = document.getElementById('multi-delete-btn');

            if (countSpan) {
                countSpan.textContent = selectedPostIds.size;
            }

            if (deleteBtn) {
                deleteBtn.style.opacity = selectedPostIds.size > 0 ? '1' : '0.5';
                deleteBtn.style.pointerEvents = selectedPostIds.size > 0 ? 'auto' : 'none';
            }
        }

        // ç¡®è®¤åˆ é™¤é€‰ä¸­çš„å¸–å­
        async function confirmDeleteSelectedPosts() {
            if (selectedPostIds.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¸–å­', 'warning');
                return;
            }

            const currentTab = document.querySelector('.profile-tab.active').textContent;
            const actionText = currentTab === 'æˆ‘çš„å¸–å­' ? 'åˆ é™¤è¿™äº›å¸–å­' : 'å–æ¶ˆæ”¶è—è¿™äº›å¸–å­';

            if (!confirm(`ç¡®å®šè¦${actionText}å—ï¼Ÿå…± ${selectedPostIds.size} ä¸ªé¡¹ç›®ã€‚${currentTab === 'æˆ‘çš„å¸–å­' ? '\n\næ³¨æ„ï¼šåˆ é™¤å¸–å­å°†åŒæ—¶åˆ é™¤æ‰€æœ‰å›å¤å’Œç›¸å…³æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼' : ''}`)) {
                return;
            }

            try {
                if (currentTab === 'æˆ‘çš„å¸–å­') {
                    await deleteSelectedPosts();
                } else {
                    await unfavoriteSelectedPosts();
                }

                showToast(`æˆåŠŸ${actionText}`, 'success');

                // é€€å‡ºå¤šé€‰æ¨¡å¼å¹¶åˆ·æ–°åˆ—è¡¨
                toggleMultiSelectMode();

            } catch (error) {
                console.error('åˆ é™¤æ“ä½œå¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åˆ é™¤é€‰ä¸­çš„å¸–å­
        async function deleteSelectedPosts() {
            const postIdsArray = Array.from(selectedPostIds);

            // åˆ é™¤å¸–å­ç›¸å…³çš„æ‰€æœ‰æ•°æ®
            await Promise.all([
                // åˆ é™¤å¸–å­æœ¬èº«
                db.forumPosts.where('id').anyOf(postIdsArray).delete(),
                // åˆ é™¤å¸–å­çš„å›å¤
                db.forumReplies.where('postId').anyOf(postIdsArray).delete(),
                // åˆ é™¤å¸–å­çš„æ”¶è—è®°å½•
                db.forumFavorites.where('postId').anyOf(postIdsArray).delete(),
                // åˆ é™¤å¸–å­çš„å›¾ç‰‡
                db.forumPostImages.where('postId').anyOf(postIdsArray).delete(),
                // åˆ é™¤å›å¤çš„ç‚¹èµè®°å½•
                db.replyLikes.where('postId').anyOf(postIdsArray).delete()
            ]);
        }

        // å–æ¶ˆæ”¶è—é€‰ä¸­çš„å¸–å­
        async function unfavoriteSelectedPosts() {
            const postIdsArray = Array.from(selectedPostIds);

            // åˆ é™¤æ”¶è—è®°å½•
            await db.forumFavorites.where('postId').anyOf(postIdsArray).and(fav => fav.userId === 'user').delete();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const allPostItems = document.querySelectorAll('.multi-select-item');
            const allPostIds = Array.from(allPostItems).map(item => parseInt(item.dataset.postId));

            // åˆ¤æ–­æ˜¯å¦å·²ç»å…¨é€‰
            const isAllSelected = allPostIds.every(id => selectedPostIds.has(id));

            if (isAllSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedPostIds.clear();
                allPostItems.forEach(item => {
                    item.classList.remove('selected');
                    const checkbox = item.querySelector('.post-checkbox i');
                    checkbox.className = 'fas fa-square';
                });
            } else {
                // å…¨é€‰
                allPostIds.forEach(id => selectedPostIds.add(id));
                allPostItems.forEach(item => {
                    item.classList.add('selected');
                    const checkbox = item.querySelector('.post-checkbox i');
                    checkbox.className = 'fas fa-check-square';
                });
            }

            updateDeleteButtonState();
        }


    </script>

    <!-- è½¬å‘ç›®æ ‡é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="forward-target-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">é€‰æ‹©ä¸€ä¸ªèŠå¤©</div>
                <button class="modal-close" onclick="hideModal('forward-target-modal')">&times;</button>
            </div>
            <div class="modal-body" id="forward-target-list">
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è½¬å‘è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="forwarded-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="forwarded-view-title">èŠå¤©è®°å½•</div>
                <button class="modal-close" onclick="hideModal('forwarded-view-modal')">&times;</button>
            </div>
            <div class="modal-body" id="forwarded-view-content">
            </div>
        </div>
    </div>

    <script>
        // å¼€å§‹é€‰æ‹©æ¨¡å¼
        function startEmojiSelection() {
            document.getElementById('start-selection-btn').style.display = 'none';
            document.getElementById('selection-buttons').style.display = 'flex';

            // æ˜¾ç¤ºæ‰€æœ‰å¤é€‰æ¡†
            const checkboxes = document.querySelectorAll('.emoji-checkbox');
            checkboxes.forEach(cb => cb.style.display = 'block');
        }

        // å…¨é€‰
        function selectAllEmojis() {
            const checkboxes = document.querySelectorAll('.emoji-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        }

        // åˆ é™¤é€‰ä¸­çš„è¡¨æƒ…åŒ…
        function deleteSelectedEmojis() {
            const selectedCheckboxes = document.querySelectorAll('.emoji-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…åŒ…');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ`)) {
                return;
            }

            selectedCheckboxes.forEach(cb => {
                removeEmojiFromLibrary(cb.dataset.emojiId);
            });

            cancelSelection();
        }

        // å–æ¶ˆé€‰æ‹©æ¨¡å¼
        function cancelSelection() {
            document.getElementById('start-selection-btn').style.display = 'block';
            document.getElementById('selection-buttons').style.display = 'none';

            // éšè—æ‰€æœ‰å¤é€‰æ¡†å¹¶å–æ¶ˆé€‰ä¸­
            const checkboxes = document.querySelectorAll('.emoji-checkbox');
            checkboxes.forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });
        }
    </script>

    <script src="auth.js"></script>

</body>
</html>